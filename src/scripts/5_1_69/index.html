<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ระบบจัดการเช่ารถ KPCRM V.3</title>
  <!-- Tailwind CSS ผ่าน CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine JS สำหรับทำ Interactive UI -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
  <!-- Font Awesome สำหรับไอคอน -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- SweetAlert2 สำหรับแจ้งเตือน -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>


  <!-- Animation (AOS) -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

  <!-- ApexCharts สำหรับสร้างกราฟ -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');

    * {
      font-family: 'Prompt', sans-serif;
    }

    [x-cloak] {
      display: none !important;
    }

    .loader {
      border-top-color: #3498db;
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }

    @-webkit-keyframes spinner {
      0% {
        -webkit-transform: rotate(0deg);
      }

      100% {
        -webkit-transform: rotate(360deg);
      }
    }

    @keyframes spinner {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* เพิ่ม CSS นี้ในส่วน <style> ของไฟล์ HTML */
    .small-loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .swal-custom-title {
      font-family: 'Prompt', sans-serif;
      font-size: 1.5rem;
      color: #e53e3e;
      /* สีแดง */
    }

    /* จัดข้อความเนื้อหา SweetAlert ให้ชิดซ้าย */
    .swal-custom-left {
      text-align: left !important;
      font-family: 'Prompt', sans-serif;
    }




    .signature-canvas {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      background-color: #f9fafb;
      cursor: crosshair;
      touch-action: none;
    }

    .signature-canvas.signed {
      border-color: #10b981;
      background-color: #ecfdf5;
      border-style: solid;
    }

    .signature-section {
      background-color: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .terms-link {
      color: #3b82f6;
      text-decoration: underline;
      cursor: pointer;
    }

    .terms-link:hover {
      color: #1d4ed8;
    }







    /* เพิ่ม animation สำหรับ datepicker */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.2s ease-out;
    }

    /* ⭐ AI Chatbot Animations */
    @keyframes slide-in-left {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slide-in-right {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .animate-slide-in-left {
      animation: slide-in-left 0.3s ease-out;
    }

    .animate-slide-in-right {
      animation: slide-in-right 0.3s ease-out;
    }

    /* Chatbot Button Pulse Animation - ทุกๆ 3 วินาที */
    @keyframes chatbot-pulse {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }

      10% {
        transform: scale(1.05);
        box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
      }

      20% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }

    .chatbot-button-pulse {
      animation: chatbot-pulse 3s ease-in-out infinite;
    }

    /* Alpine.js x-cloak - hide until Alpine is ready */
    [x-cloak] {
      display: none !important;
    }

    @keyframes bounce-slow {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }
    }

    .animate-bounce-slow {
      animation: bounce-slow 2s infinite ease-in-out;
    }




    @keyframes highlight {
      0% {
        background-color: rgba(59, 130, 246, 0.1);
      }

      50% {
        background-color: rgba(59, 130, 246, 0.3);
      }

      100% {
        background-color: rgba(59, 130, 246, 0.1);
      }
    }

    .highlight-animation {
      animation: highlight 2s ease;
      border: 2px solid #3b82f6;
    }




    .notification {
      font-size: 14px;
      transition: all 0.3s ease;
      opacity: 0.9;
    }

    .notification-info {
      background-color: #EBF8FF;
      color: #2B6CB0;
      border-left: 4px solid #4299E1;
    }

    .notification-success {
      background-color: #F0FFF4;
      color: #276749;
      border-left: 4px solid #48BB78;
    }

    .notification-warning {
      background-color: #FFFAF0;
      color: #C05621;
      border-left: 4px solid #ED8936;
    }

    .notification-error {
      background-color: #FFF5F5;
      color: #C53030;
      border-left: 4px solid #F56565;
    }

    .hidden {
      display: none;
    }




    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border-left-color: #fff;
      animation: spin 1s ease infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* เพิ่มสไตล์สำหรับ Date/Time input placeholder */
    input[type="date"]:required:invalid::-webkit-datetime-edit,
    input[type="time"]:required:invalid::-webkit-datetime-edit {
      color: transparent;
    }

    input[type="date"]:focus::-webkit-datetime-edit,
    input[type="time"]:focus::-webkit-datetime-edit {
      color: black !important;
    }


    /* ไทม์ไลน์ */
    .timeline-container {
      margin-top: 1rem;
    }

    .timeline {
      position: relative;
      padding: 1rem 0;
    }

    .timeline-header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .timeline-header-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .timeline-date {
      font-weight: 600;
      color: #4b5563;
    }

    .timeline-current-time {
      display: flex;
      align-items: center;
      margin: 1rem 0;
      position: relative;
    }

    .timeline-current-time:before {
      content: '';
      position: absolute;
      left: 12px;
      top: -16px;
      bottom: -16px;
      width: 2px;
      background-color: #d1d5db;
      z-index: 0;
    }

    .timeline-current-time-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #3b82f6;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      z-index: 1;
      flex-shrink: 0;
    }

    .timeline-item {
      display: flex;
      margin-bottom: 1.5rem;
      position: relative;
      cursor: pointer;
    }

    .timeline-item:before {
      content: '';
      position: absolute;
      left: 12px;
      top: -12px;
      bottom: -12px;
      width: 2px;
      background-color: #d1d5db;
      z-index: 0;
    }

    .timeline-item:first-child:before {
      top: 0;
    }

    .timeline-item:last-child:before {
      bottom: 0;
    }

    .timeline-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      z-index: 1;
      flex-shrink: 0;
    }

    .timeline-content-wrapper {
      flex-grow: 1;
    }



    .timeline-content:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .timeline-time {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #4b5563;
    }

    .timeline-info {
      color: #6b7280;
    }

    /* Loader animation */
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loader {
      border-top-color: #6366f1;
      animation: spin 1s linear infinite;
    }



    .announcement-card {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .announcement-card:hover {
      transform: translateY(-5px);
    }

    .announcement-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      transition: all 0.3s ease;
    }

    .announcement-card.important::before {
      background: linear-gradient(to bottom, #ef4444, #f87171);
    }

    .announcement-card.general::before {
      background: linear-gradient(to bottom, #3b82f6, #60a5fa);
    }

    .announcement-card:hover::before {
      width: 6px;
    }

    /* Badge ประกาศใหม่ */
    .new-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: #ef4444;
      /* สีแดง */
      color: white;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 9999px;
      z-index: 10;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      transform: translate(50%, -50%);
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    /* สไตล์การเลื่อน */
    .announcements-container {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .announcements-container::-webkit-scrollbar {
      width: 6px;
    }

    .announcements-container::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .announcements-container::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 20px;
    }


    /* CSS สำหรับคอลัมน์ชื่อรถแบบหุบเข้าขยายออก */
    .car-name-cell {
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .car-name-cell.collapsed {
      max-width: 40px;
      width: 40px;
      text-align: center;
      padding: 0.75rem 0.25rem;
    }

    #toggleCarNames {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #e5e7eb;
      transition: all 0.2s ease;
    }

    #toggleCarNames:hover {
      background-color: #d1d5db;
    }

    /* Animation สำหรับการเปลี่ยนสถานะ */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .car-name-cell i {
      animation: fadeIn 0.3s ease;
    }

    /* ตกแต่งเพิ่มเติมสำหรับตาราง */
    #bookingTable {
      table-layout: fixed;
    }

    #bookingTable th,
    #bookingTable td {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* จัดการ tooltip สำหรับชื่อรถที่ถูกย่อ */
    .car-name-cell.collapsed:hover::after {
      content: attr(title);
      position: absolute;
      left: 45px;
      background: white;
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      white-space: nowrap;
      animation: fadeIn 0.2s ease;
    }



    /* สไตล์สำหรับตารางการจองในรูปแบบ PDF */
    .booking-list-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 15px;
    }

    .booking-list-table th,
    .booking-list-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .booking-list-table th {
      background-color: #f2f7ff;
      font-weight: bold;
      color: #1a56db;
    }

    /* สไตล์สำหรับ PDF */
    .pdf-container {
      padding: 20px;
      max-width: 210mm;
      /* A4 width */
      margin: 0 auto;
      background-color: white;
      font-family: 'Sarabun', sans-serif;
    }

    .pdf-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }

    .pdf-footer {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #e2e8f0;
      font-size: 10px;
      text-align: center;
      color: #718096;
    }

    /* ซ่อนองค์ประกอบที่ใช้ในการสร้าง PDF */
    .hidden-pdf-element {
      position: absolute;
      left: -9999px;
      top: 0;
    }




    /* Custom animations */
    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes slideInFromLeft {
      0% {
        transform: translateX(-100%);
        opacity: 0;
      }

      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideInFromRight {
      0% {
        transform: translateX(100%);
        opacity: 0;
      }

      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeInUp {
      0% {
        transform: translateY(30px);
        opacity: 0;
      }

      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .float-animation {
      animation: float 3s ease-in-out infinite;
    }

    .slide-in-left {
      animation: slideInFromLeft 0.8s ease-out;
    }

    .slide-in-right {
      animation: slideInFromRight 0.8s ease-out;
    }

    .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

    /* Custom gradient backgrounds */
    .gradient-bg-1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gradient-bg-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .gradient-bg-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .gradient-bg-4 {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .gradient-bg-5 {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .gradient-bg-6 {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    .gradient-bg-7 {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    }

    /* Glass morphism effect */
    .glass {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Enhanced form styles */
    .form-section {
      transition: all 0.3s ease;
    }

    .form-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* Step indicator styles */
    .step-indicator {
      transition: all 0.3s ease;
    }

    .step-completed {
      background: linear-gradient(45deg, #10B981, #059669);
      color: white;
    }

    .step-active {
      background: linear-gradient(45deg, #3B82F6, #1D4ED8);
      color: white;
      animation: pulse 2s infinite;
    }

    .step-inactive {
      background: #E5E7EB;
      color: #9CA3AF;
    }

    /* Custom toggle switch */
    .toggle-switch {
      appearance: none;
      width: 3rem;
      height: 1.5rem;
      border-radius: 9999px;
      background-color: #d1d5db;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .toggle-switch:checked {
      background-color: #3b82f6;
    }

    .toggle-switch::before {
      content: '';
      position: absolute;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      background-color: white;
      top: 0.125rem;
      left: 0.125rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch:checked::before {
      transform: translateX(1.5rem);
    }



    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }




    /* ส่วนที่ 5: CSS สำหรับระบบบันทึกการรับส่งรถ */
    /* เพิ่มใน <style> ของ index.html หรือไฟล์ CSS แยก */

    /* ปรับปรุงการ์ด timeline ให้มีพื้นที่สำหรับปุ่ม */
    .timeline-content {
      position: relative;
      min-height: 130px;
      /* เพิ่มความสูงขั้นต่ำเพื่อให้มีที่สำหรับปุ่ม */
      padding-bottom: 45px;
      /* เพิ่ม padding ล่างสำหรับปุ่ม */
    }

    .timeline-content button {
      font-size: 11px;
      white-space: nowrap;
      z-index: 10;
      border: none;
      outline: none;
    }

    .timeline-content button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* ปรับปรุง responsive สำหรับปุ่ม */
    @media (max-width: 768px) {
      .timeline-content {
        min-height: 110px;
        padding-bottom: 35px;
      }

      .timeline-content button {
        font-size: 10px;
        padding: 0.25rem 0.5rem;
      }

      .timeline-content button i {
        margin-right: 0.25rem;
      }

      .timeline-content button span {
        display: none;
        /* ซ่อนข้อความในมือถือ แสดงแค่ไอคอน */
      }
    }

    /* โมดัลบันทึกการรับส่งรถ */
    .handover-modal {
      backdrop-filter: blur(4px);
    }

    .handover-modal .modal-content {
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Grid สำหรับถ่ายรูป */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .photo-item {
      text-align: center;
      padding: 1rem;
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      background-color: #f9fafb;
    }

    .photo-item:hover {
      border-color: #6366f1;
      background-color: #f8fafc;
      transform: translateY(-2px);
    }

    .photo-item.captured {
      border-color: #10b981;
      background-color: #ecfdf5;
      border-style: solid;
    }

    .photo-item.captured::after {
      content: '✓';
      position: absolute;
      top: 5px;
      right: 5px;
      background: #10b981;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    /* Animation สำหรับการถ่ายรูป */
    @keyframes flash {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }

      100% {
        opacity: 1;
      }
    }

    .photo-flash {
      animation: flash 0.3s ease-in-out;
    }

    /* Loading indicator สำหรับการอัปโหลดรูป */
    .upload-loading {
      display: inline-flex;
      align-items: center;
      color: #6366f1;
    }

    .upload-loading::after {
      content: '';
      width: 12px;
      height: 12px;
      margin-left: 8px;
      border: 2px solid #6366f1;
      border-radius: 50%;
      border-top: 2px solid transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* GPS status indicator */
    .gps-status {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .gps-status.available {
      background-color: #dcfce7;
      color: #166534;
    }

    .gps-status.unavailable {
      background-color: #fef2f2;
      color: #991b1b;
    }

    /* Photo preview styles */
    .photo-preview {
      max-width: 100px;
      max-height: 100px;
      border-radius: 0.375rem;
      border: 2px solid #e5e7eb;
      margin-top: 0.5rem;
      object-fit: cover;
    }

    .photo-preview.captured {
      border-color: #10b981;
    }

    /* Success/Error states */
    .form-success {
      border-color: #10b981 !important;
      background-color: #ecfdf5 !important;
    }

    .form-error {
      border-color: #ef4444 !important;
      background-color: #fef2f2 !important;
    }

    /* Enhanced button states */
    .btn-disabled {
      opacity: 0.6 !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
    }

    .btn-loading {
      position: relative;
      color: transparent !important;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top: 2px solid transparent;
      animation: spin 1s linear infinite;
    }

    /* ปรับปรุงสีสำหรับประเภทการรับส่งรถ */
    .pickup-theme {
      --primary-color: #059669;
      --primary-light: #ecfdf5;
      --primary-dark: #047857;
    }

    .return-theme {
      --primary-color: #ea580c;
      --primary-light: #fff7ed;
      --primary-dark: #c2410c;
    }

    /* Responsive design สำหรับโมดัล */
    @media (max-width: 768px) {
      .handover-modal .modal-content {
        margin: 1rem;
        width: calc(100% - 2rem);
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
      }

      .photo-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }

      .photo-item {
        padding: 0.5rem;
      }
    }

    /* เพิ่มสไตล์สำหรับการแสดงสถานะ */
    .handover-status {
      position: relative;
    }

    .handover-status::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #10b981;
      display: none;
    }

    .handover-status.completed::after {
      display: block;
    }

    /* ปรับปรุงการแสดงข้อความสถานะ */
    .status-text {
      font-size: 0.75rem;
      font-weight: 500;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
    }

    .status-text.success {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-text.warning {
      background-color: #fef3c7;
      color: #92400e;
    }

    .status-text.error {
      background-color: #fecaca;
      color: #991b1b;
    }

    /* เอฟเฟกต์การโฟกัส */
    .focus-ring:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }

    /* Animation สำหรับการเปิด/ปิดโมดัล */
    .modal-enter {
      opacity: 0;
      transform: scale(0.95);
    }

    .modal-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: opacity 300ms, transform 300ms;
    }

    .modal-leave {
      opacity: 1;
      transform: scale(1);
    }

    .modal-leave-active {
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 200ms, transform 200ms;
    }



    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }




    #rental-duration-display {
      transition: all 0.3s ease;
    }

    #rental-duration-note {
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #rental-duration-display {
        font-size: 1rem;
      }
    }



    /* =============================================
   CSS Styles สำหรับระบบจัดการวันปิดให้เช่า
   เพิ่มใน <head> หรือไฟล์ CSS หลัก
   ============================================= */

    /* Calendar Header Gradient */
    .calendar-header-gradient {
      background: linear-gradient(135deg, #dc2626, #ef4444, #f87171);
      background-size: 300% 300%;
      animation: gradientShift 6s ease infinite;
    }

    @keyframes gradientShift {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    /* Calendar Navigation */
    .calendar-nav-button:hover {
      transform: scale(1.05);
    }

    .calendar-nav-button:active {
      transform: scale(0.95);
    }

    /* Calendar Selects */
    .calendar-select:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .calendar-select:focus {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.7);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
    }

    /* Calendar Title Animation */
    .calendar-main-title {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Calendar Day Cells */
    .calendar-day-cell {
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .calendar-day-cell:hover {
      background-color: #fef2f2;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }

    .calendar-day-cell.other-month {
      background-color: #f9fafb;
      color: #9ca3af;
    }

    .calendar-day-cell.selected {
      background: linear-gradient(135deg, #dc2626, #ef4444) !important;
      color: white !important;
      font-weight: 700;
      border: 2px solid #b91c1c !important;
      transform: scale(1.02);
      z-index: 20;
      box-shadow: 0 8px 25px -5px rgba(220, 38, 38, 0.4);
    }

    .calendar-day-cell.in-range {
      background: linear-gradient(135deg, #fecaca, #fee2e2) !important;
      color: #991b1b !important;
      border-color: #f87171 !important;
    }

    /* Blocking Status Bars */
    .blocking-status-bar {
      transition: opacity 0.2s ease;
    }

    .calendar-day-cell:hover .blocking-status-bar {
      opacity: 1;
    }

    /* Status Colors */
    .status-maintenance {
      background: linear-gradient(90deg, #f97316, #ea580c);
    }

    .status-repair {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .status-personal {
      background: linear-gradient(90deg, #a855f7, #9333ea);
    }

    .status-other {
      background: linear-gradient(90deg, #6b7280, #4b5563);
    }

    /* Buttons */
    .btn-blocking-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #b91c1c, #991b1b);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }

    /* Badge */
    .badge-blocking-count {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 24px;
      text-align: center;
    }

    /* Status Indicator */
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Color Legend */
    .color-legend-item {
      transition: all 0.2s ease;
      border-radius: 6px;
      padding: 8px;
    }

    .color-legend-item:hover {
      background-color: rgba(59, 130, 246, 0.05);
      transform: translateX(2px);
    }

    .color-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    /* Vehicle Blocking Item */
    .vehicle-blocking-item {
      transition: all 0.2s ease;
      border-left: 4px solid transparent;
    }

    .vehicle-blocking-item:hover {
      border-left-color: #dc2626;
      background-color: #fef2f2;
      transform: translateX(2px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .calendar-header-gradient {
        padding: 1rem;
      }

      .calendar-main-title {
        font-size: 1.5rem;
      }

      .calendar-day-cell {
        height: 80px;
        font-size: 0.875rem;
      }
    }


    [x-cloak] {
      display: none !important;
    }

    .prose {
      max-width: 100%;
    }

    .prose h1,
    .prose h2,
    .prose h3 {
      margin-bottom: 0.5em;
    }

    .prose p {
      margin-top: 0;
      margin-bottom: 1em;
    }

    .prose ul,
    .prose ol {
      margin-top: 0;
      margin-bottom: 1em;
      padding-left: 1.5em;
    }

    /* ===== Fix Layout Structure ===== */
    /* แก้ไขปัญหา layout ที่แสดงผลไม่ถูกต้อง */

    /* 1. Reset และจัด main container ใหม่ */
    body>div[x-show="isLoggedIn"].flex.min-h-screen {
      display: flex !important;
      min-height: 100vh;
      margin-top: 0;
      padding-top: 0;
      /* ลบ padding-top ออก */
    }

    /* 2. Fix sidebar position และขนาด */
    body>div[x-show="isLoggedIn"].flex.min-h-screen>.bg-white.shadow-lg.w-64 {
      width: 256px !important;
      position: fixed !important;
      left: 0;
      top: 64px;
      /* ต่อจาก navbar */
      bottom: 0;
      overflow-y: auto;
      z-index: 30;
    }

    /* 3. Fix main content area */
    body>div[x-show="isLoggedIn"].flex.min-h-screen>div[x-show="isLoggedIn"].flex-1 {
      margin-left: 256px !important;
      /* เว้นที่สำหรับ sidebar */
      width: calc(100% - 256px) !important;
      min-height: 100vh;
      padding: 1.5rem;
      padding-top: 5.5rem;
      /* เว้นที่สำหรับ navbar (64px + 24px) */
    }

    /* 4. Mobile responsive - ซ่อน sidebar และ content เต็มจอ */
    @media (max-width: 768px) {
      body>div[x-show="isLoggedIn"].flex.min-h-screen>.bg-white.shadow-lg.w-64 {
        display: none !important;
      }

      body>div[x-show="isLoggedIn"].flex.min-h-screen>div[x-show="isLoggedIn"].flex-1 {
        margin-left: 0 !important;
        width: 100% !important;
        padding: 0.5rem;
        padding-bottom: 80px;
        /* เว้นที่สำหรับ bottom nav */
      }
    }

    /* 5. Fix navbar position */
    nav.fixed.top-0 {
      z-index: 50;
      width: 100%;
    }

    /* 6. Fix content pages to use full width */
    div[x-show*="currentPage"] {
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    /* 6.1 Fix excessive top spacing for summary and bookings pages - desktop only */
    @media (min-width: 769px) {

      div[x-show="currentPage === 'summary'"],
      div[x-show="currentPage === 'bookings'"] {
        margin-top: -5.5rem !important;
      }

      /* Fix excessive left spacing for other pages - desktop only */
      div[x-show="currentPage === 'schedule'"],
      div[x-show="currentPage === 'customers'"],
      div[x-show="currentPage === 'newRental'"],
      div[x-show="currentPage === 'onlinebooking'"],
      div[x-show="currentPage === 'cars'"],
      div[x-show="currentPage === 'finance'"],
      div[x-show="currentPage === 'documents'"],
      div[x-show="currentPage === 'manual'"],
      div[x-show="currentPage === 'config'"] {
        margin-left: -1.5rem !important;
      }
    }

    /* 7. Remove duplicate x-show interference */
    div[x-show="isLoggedIn"].flex-1[x-show="isLoggedIn"] {
      display: block !important;
    }

    /* 8. Fix bottom navigation on mobile */
    .md\:hidden.fixed.bottom-0 {
      z-index: 40;
      bottom: 0;
      left: 0;
      right: 0;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans antialiased" x-data="app()" x-init="init()">

  <!-- หน้าโหลดข้อมูล -->
  <div x-show="isLoading" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
  </div>



  <!-- สปินเนอร์เฉพาะสำหรับการสร้างสัญญาเช่า -->
  <div x-show="isContractGenerating" x-transition.opacity.duration.300ms
    class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50" x-cloak>
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center animate-fade-in-up">

      <!-- ลอยเบาๆ + เงา + hover scale -->
      <div class="flex justify-center items-center mb-6">
        <lottie-player src="https://assets9.lottiefiles.com/packages/lf20_usmfx6bp.json" background="transparent"
          speed="1" style="width: 90px; height: 90px;" loop autoplay
          class="animate-bounce-slow drop-shadow-xl hover:scale-105 transition-transform duration-300">
        </lottie-player>
      </div>

      <!-- ข้อความระบุสถานะ -->
      <p class="text-xl font-semibold text-gray-800" x-text="contractLoadingStep"></p>
      <p class="text-sm text-gray-600 mb-4">กรุณารอสักครู่ ระบบกำลังดำเนินการ...</p>

      <!-- Progress bar -->
      <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden shadow-inner">
        <div class="bg-gradient-to-r from-blue-500 to-blue-700 h-full transition-all duration-500 ease-out"
          :style="`width: ${contractLoadingProgress}%`"></div>
      </div>
    </div>
  </div>

  <!-- Modal สำหรับการบันทึกข้อมูลรถ -->
  <div x-show="isCarSaving" x-transition.opacity.duration.300ms
    class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-[9999]" x-cloak>
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center animate-fade-in-up">

      <!-- ไอคอนรถ -->
      <div class="relative mx-auto w-20 h-20 mb-6">
        <div class="absolute inset-0 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full animate-pulse"></div>
        <div class="absolute inset-2 bg-white rounded-full flex items-center justify-center">
          <i class="fas fa-car text-3xl text-orange-500"></i>
        </div>
      </div>

      <!-- ข้อความระบุสถานะ -->
      <p class="text-xl font-semibold text-gray-800" x-text="carSavingStep"></p>
      <p class="text-sm text-gray-600 mb-4">กรุณารอสักครู่ ระบบกำลังดำเนินการ...</p>

      <!-- Progress bar -->
      <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden shadow-inner">
        <div class="bg-gradient-to-r from-orange-400 to-orange-600 h-full transition-all duration-500 ease-out"
          :style="`width: ${carSavingProgress}%`"></div>
      </div>
    </div>
  </div>

  <!-- หน้า Login -->
  <div x-show="!isLoggedIn && !showLicenseRenewalModal" x-cloak
    class="fixed inset-0 bg-gray-50 flex items-center justify-center" style="background-image: 
     linear-gradient(to right, rgba(243, 244, 246, 0.8) 1px, transparent 1px),
     linear-gradient(to bottom, rgba(243, 244, 246, 0.8) 1px, transparent 1px);
     background-size: 20px 20px;">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-8 mx-4 border border-gray-100 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-600"></div>

      <div class="text-center mb-8">
        <div class="mb-4 flex justify-center">
          <div class="bg-blue-100 p-4 rounded-full inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-600" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
        </div>

        <h2 class="text-2xl font-bold text-gray-800">ระบบจัดการเช่ารถ</h2>
        <p x-show="config.ชื่อบริษัท" class="text-lg text-gray-600 mt-1" x-text="config.ชื่อบริษัท"></p>
        <p class="text-sm text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
      </div>

      <form @submit.prevent="login">
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-medium mb-2">
            <i class="fas fa-user mr-2 text-gray-500"></i>ชื่อผู้ใช้
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
            </div>
            <input type="text" x-model="loginForm.username" placeholder="กรอกชื่อผู้ใช้" required
              class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-gray-700 text-sm font-medium mb-2">
            <i class="fas fa-lock mr-2 text-gray-500"></i>รหัสผ่าน
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                  clip-rule="evenodd" />
              </svg>
            </div>
            <input type="password" x-model="loginForm.password" placeholder="กรอกรหัสผ่าน" required
              class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>

        <div class="flex justify-center">
          <button type="submit"
            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 px-4 rounded-md hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
            <svg x-show="!isLoginProcessing" class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z"
                clip-rule="evenodd" />
            </svg>
            <span x-show="!isLoginProcessing">เข้าสู่ระบบ</span>
            <span x-show="isLoginProcessing" class="flex items-center justify-center">
              <div class="small-loader mr-2"></div> กำลังเข้าสู่ระบบ...
            </span>
          </button>
        </div>

        <div class="text-center">
          <p class="text-sm text-gray-500 mt-2">© KP Carrental Management V.3.0</p>

        </div>


      </form>
    </div>
  </div>





  <!-- Modal ต่ออายุ License -->
  <div x-show="showLicenseRenewalModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;" x-cloak>
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>

      <div
        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-gradient-to-r from-green-600 to-green-800 px-6 py-4">
          <h3 class="text-lg leading-6 font-bold text-white flex items-center">
            <i class="fas fa-exclamation-circle mr-3 text-white"></i>
            แจ้งต่ออายุการใช้งาน
          </h3>
        </div>

        <div class="bg-white px-6 pt-5 pb-6">
          <div class="space-y-6">
            <template x-if="licenseExpired">
              <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-500"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-red-700">
                      ใบอนุญาตการใช้งานของคุณหมดอายุแล้ว กรุณาต่ออายุเพื่อใช้งานต่อ
                    </p>
                  </div>
                </div>
              </div>
            </template>

            <template x-if="!licenseExpired && licenseDaysRemaining <= 10">
              <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-yellow-500"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                      ใบอนุญาตการใช้งานของคุณจะหมดอายุในอีก <span x-text="licenseDaysRemaining"></span> วัน
                    </p>
                  </div>
                </div>
              </div>
            </template>

            <!-- แท็บสลับการแสดงผล -->
            <div class="border-b border-gray-200">
              <nav class="-mb-px flex">
                <button @click="activeTab = 'plans'"
                  :class="{'border-blue-500 text-blue-600': activeTab === 'plans', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'plans'}"
                  class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                  เลือกแผนการต่ออายุ
                </button>
                <button @click="activeTab = 'compare'"
                  :class="{'border-blue-500 text-blue-600': activeTab === 'compare', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'compare'}"
                  class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                  เปรียบเทียบแผนการต่ออายุ
                </button>
              </nav>
            </div>

            <!-- เนื้อหาแท็บ "เลือกแผนการต่ออายุ" -->
            <div x-show="activeTab === 'plans'">
              <div class="text-center mb-4">
                <h4 class="text-lg font-medium text-gray-900">เลือกแผนการต่ออายุ</h4>
              </div>

              <!-- แผนการต่ออายุ -->
              <div class="space-y-4">
                <!-- แผนรายเดือน -->
                <div @click="selectedRenewalPlan = 'monthly'"
                  :class="{'border-blue-500 bg-blue-50': selectedRenewalPlan === 'monthly', 'border-gray-200': selectedRenewalPlan !== 'monthly'}"
                  class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md">
                  <div class="flex justify-between items-center">
                    <div>
                      <h5 class="font-semibold text-gray-900">รายเดือน</h5>
                      <p class="text-sm text-gray-600">ต่ออายุสำหรับ 1 เดือน</p>
                    </div>
                    <div class="text-blue-600 font-bold text-xl">
                      300 บาท
                    </div>
                  </div>
                </div>

                <!-- แผนรายปี -->
                <div @click="selectedRenewalPlan = 'yearly'"
                  :class="{'border-blue-500 bg-blue-50': selectedRenewalPlan === 'yearly', 'border-gray-200': selectedRenewalPlan !== 'yearly'}"
                  class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md">
                  <div class="flex justify-between items-center">
                    <div>
                      <h5 class="font-semibold text-gray-900">รายปี</h5>
                      <p class="text-sm text-gray-600">ต่ออายุสำหรับ 1 ปี</p>
                    </div>
                    <div class="text-blue-600 font-bold text-xl">
                      3,000 บาท
                    </div>
                  </div>
                </div>

                <!-- แผนตลอดชีพ -->
                <div @click="selectedRenewalPlan = 'lifetime'"
                  :class="{'border-blue-500 bg-blue-50': selectedRenewalPlan === 'lifetime', 'border-gray-200': selectedRenewalPlan !== 'lifetime'}"
                  class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md">
                  <div class="flex justify-between items-center">
                    <div>
                      <h5 class="font-semibold text-gray-900">ซื้อครั้งเดียว</h5>
                      <p class="text-sm text-gray-600">ใช้งานได้ตลอดไป</p>
                    </div>
                    <div class="text-blue-600 font-bold text-xl">
                      25,000 บาท
                    </div>
                  </div>
                </div>
              </div>

              <!-- ปุ่มดำเนินการต่อ -->
              <div class="mt-6 flex justify-center">
                <button @click="showPaymentInfo = true" :disabled="!selectedRenewalPlan"
                  :class="{'bg-blue-600 hover:bg-blue-700': selectedRenewalPlan, 'bg-gray-400 cursor-not-allowed': !selectedRenewalPlan}"
                  class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-3 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <i class="fas fa-credit-card mr-2"></i>
                  ดำเนินการชำระเงิน
                </button>
              </div>
            </div>

            <!-- เนื้อหาแท็บ "เปรียบเทียบแผนการต่ออายุ" -->
            <div x-show="activeTab === 'compare'" class="overflow-x-auto">
              <div class="text-center mb-4">
                <h4 class="text-lg font-medium text-gray-900">เปรียบเทียบแผนการต่ออายุ</h4>
              </div>

              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col"
                      class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      คุณสมบัติ
                    </th>
                    <th scope="col"
                      class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      รายเดือน<br>
                      <span class="text-blue-600 font-bold">300 บาท</span>
                    </th>
                    <th scope="col"
                      class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      รายปี<br>
                      <span class="text-blue-600 font-bold">3,000 บาท</span>
                    </th>
                    <th scope="col"
                      class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ซื้อครั้งเดียว<br>
                      <span class="text-blue-600 font-bold">25,000 บาท</span>
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <!-- คุณสมบัติ: สร้างรายการเช่า -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      สร้างรายการเช่าได้ไม่จำกัด
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: เพิ่มรถ -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      เพิ่มรถได้ไม่จำกัด
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: เก็บข้อมูลใน Google Drive -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      เก็บข้อมูลใน Google Drive
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: ใช้ subdomain -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      ใช้ sub domain เป็นชื่อร้านของท่าน
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>


                  <!-- คุณสมบัติ: เก็บข้อมูลใน Google Drive ส่วนตัว -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      เก็บข้อมูลใน Google Drive ส่วนตัว
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>


                  <!-- คุณสมบัติ: ฟังก์ชั่นส่ง SMS -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      ฟังก์ชั่นส่ง SMS หาลูกค้า<br>
                      <span class="text-xs text-gray-500">(ฟรีเครดิตSMS 1000SMS มูลค่า550บาท)</span>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>


                </tbody>
              </table>

              <!-- ปุ่มกลับไปเลือกแผน -->
              <div class="mt-6 flex justify-center">
                <button @click="activeTab = 'plans'"
                  class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-3 text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <i class="fas fa-arrow-left mr-2"></i>
                  กลับไปเลือกแผน
                </button>
              </div>
            </div>

            <!-- ข้อมูลการชำระเงิน -->
            <div x-show="showPaymentInfo && activeTab === 'plans'" x-transition class="mt-6 border-t pt-6">
              <h4 class="text-lg font-medium text-gray-900 mb-4">ข้อมูลการชำระเงิน</h4>

              <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                  <h5 class="font-medium text-gray-700 mb-2">หมายเลขบัญชี</h5>
                  <div class="flex items-center">
                    <input type="text" value="0271813236" id="accountNumber" readonly
                      class="bg-white px-3 py-2 border border-gray-300 rounded-md shadow-sm flex-1">
                    <button @click="copyToClipboard('accountNumber')"
                      class="ml-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                  <h5 class="font-medium text-gray-700 mb-2">ชื่อบัญชี</h5>
                  <div class="flex items-center">
                    <input type="text" value="นายคฑาวุธ มีกุญชร" id="accountName" readonly
                      class="bg-white px-3 py-2 border border-gray-300 rounded-md shadow-sm flex-1">
                    <button @click="copyToClipboard('accountName')"
                      class="ml-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                  <h5 class="font-medium text-gray-700 mb-2">ธนาคาร</h5>
                  <div class="flex items-center">
                    <input type="text" value="กสิกรไทย" id="bankName" readonly
                      class="bg-white px-3 py-2 border border-gray-300 rounded-md shadow-sm flex-1">
                    <button @click="copyToClipboard('bankName')"
                      class="ml-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                      <i class="fas fa-copy"></i>
                    </button>
                  </div>
                </div>

                <!-- อัพโหลดสลิป -->
                <div class="mt-4 border-t pt-4">
                  <h5 class="font-medium text-gray-700 mb-2">อัพโหลดสลิปการโอนเงิน</h5>
                  <div
                    class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                      <i class="fas fa-upload text-gray-400 text-3xl mb-2"></i>
                      <div class="flex text-sm text-gray-600">
                        <label for="file-upload"
                          class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                          <span>อัพโหลดไฟล์</span>
                          <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/*"
                            @change="handleSlipUpload">
                        </label>
                        <p class="pl-1">หรือลากไฟล์มาวาง</p>
                      </div>
                      <p class="text-xs text-gray-500">
                        PNG, JPG, GIF ขนาดไม่เกิน 10MB
                      </p>
                    </div>
                  </div>

                  <!-- แสดงตัวอย่างรูปภาพที่อัพโหลด -->
                  <div x-show="slipPreviewUrl" class="mt-4">
                    <div class="relative">
                      <img :src="slipPreviewUrl" class="max-h-40 object-contain mx-auto border rounded-md">
                      <button @click="slipPreviewUrl = null; slipFile = null"
                        class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- ปุ่มแจ้งชำระเงิน -->
                <div class="mt-6 flex justify-center">
                  <button @click="submitRenewalPayment" :disabled="!slipFile"
                    :class="{'bg-green-600 hover:bg-green-700': slipFile, 'bg-gray-400 cursor-not-allowed': !slipFile}"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-3 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <i class="fas fa-paper-plane mr-2"></i>
                    แจ้งชำระเงิน
                  </button>
                </div>
              </div>
            </div>


          </div>
        </div>

        <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse">
          <button @click="closeLicenseRenewalModal()" type="button"
            class="w-full sm:w-auto mt-3 sm:mt-0 inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-times mr-2"></i>
            ปิด
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal แสดงรายละเอียด -->
  <div x-show="scheduleDetailModal.show" x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"
    @click.self="scheduleDetailModal.show = false">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
      <div class="p-4 border-b flex justify-between items-center" :class="{
           'bg-green-50': scheduleDetailModal.item?.ประเภท === 'รับรถ',
           'bg-orange-50': scheduleDetailModal.item?.ประเภท === 'ส่งคืนรถ'
         }">
        <h3 class="text-lg font-medium" :class="{
            'text-green-700': scheduleDetailModal.item?.ประเภท === 'รับรถ',
            'text-orange-700': scheduleDetailModal.item?.ประเภท === 'ส่งคืนรถ'
          }" x-text="scheduleDetailModal.item?.ประเภท === 'รับรถ' ? 'รายละเอียดการรับรถ' : 'รายละเอียดการส่งคืนรถ'">
        </h3>
        <button @click="scheduleDetailModal.show = false" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-4 space-y-3">
        <!-- รายละเอียดที่สำคัญ -->
        <div class="space-y-2">
          <div class="font-medium text-lg" x-text="scheduleDetailModal.item?.ชื่อลูกค้า"></div>

          <div class="flex justify-between items-center">
            <div class="text-sm text-gray-600" x-text="'#' + scheduleDetailModal.item?.หมายเลขการจอง"></div>
            <div class="text-sm text-gray-800 font-medium">
              <i :class="{
              'fas mr-1': true,
              'fa-arrow-up text-green-600': scheduleDetailModal.item?.ประเภท === 'รับรถ',
              'fa-arrow-down text-orange-600': scheduleDetailModal.item?.ประเภท === 'ส่งคืนรถ'
            }"></i>
              <span x-text="formatTime(scheduleDetailModal.item?.เวลา)"></span>
            </div>
          </div>

          <div class="text-gray-600 flex items-center">
            <i class="fas fa-car mr-2 text-gray-500"></i>
            <span x-text="scheduleDetailModal.item?.รถ"></span>
          </div>

          <!-- สถานที่รับรถ/ส่งคืนรถ -->
          <div
            x-show="scheduleDetailModal.item?.ประเภท === 'รับรถ' ? scheduleDetailModal.item?.สถานที่รับรถ : scheduleDetailModal.item?.สถานที่คืนรถ"
            class="text-gray-600 flex items-center mt-2">
            <i class="fas fa-map-marker-alt mr-2" :class="{
            'text-green-600': scheduleDetailModal.item?.ประเภท === 'รับรถ',
            'text-orange-600': scheduleDetailModal.item?.ประเภท === 'ส่งคืนรถ'
          }"></i>
            <a x-show="scheduleDetailModal.item?.ประเภท === 'รับรถ'"
              :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(scheduleDetailModal.item?.สถานที่รับรถ)}`"
              target="_blank" class="hover:underline" x-text="scheduleDetailModal.item?.สถานที่รับรถ"></a>
            <a x-show="scheduleDetailModal.item?.ประเภท === 'ส่งคืนรถ'"
              :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(scheduleDetailModal.item?.สถานที่คืนรถ)}`"
              target="_blank" class="hover:underline" x-text="scheduleDetailModal.item?.สถานที่คืนรถ"></a>
          </div>

          <!-- เบอร์โทรศัพท์ -->
          <div x-show="scheduleDetailModal.item?.เบอร์โทรศัพท์" class="text-gray-600 flex items-center mt-2">
            <i class="fas fa-phone mr-2" :class="{
            'text-green-600': scheduleDetailModal.item?.ประเภท === 'รับรถ',
            'text-orange-600': scheduleDetailModal.item?.ประเภท === 'ส่งคืนรถ'
          }"></i>
            <a :href="`tel:${scheduleDetailModal.item?.เบอร์โทรศัพท์}`" class="hover:underline"
              x-text="scheduleDetailModal.item?.เบอร์โทรศัพท์"></a>
          </div>
        </div>

        <!-- ปุ่มเพิ่มเติม -->
        <div class="flex justify-between mt-4 pt-2 border-t">
          <!-- โทรหาลูกค้า -->
          <a x-show="scheduleDetailModal.item?.เบอร์โทรศัพท์" :href="`tel:${scheduleDetailModal.item?.เบอร์โทรศัพท์}`"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md mr-2 text-center flex items-center justify-center">
            <i class="fas fa-phone mr-2"></i>
            โทรหาลูกค้า
          </a>

          <!-- เปิดแผนที่ -->
          <a x-show="scheduleDetailModal.item?.ประเภท === 'รับรถ' ? scheduleDetailModal.item?.สถานที่รับรถ : scheduleDetailModal.item?.สถานที่คืนรถ"
            :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(scheduleDetailModal.item?.ประเภท === 'รับรถ' ? scheduleDetailModal.item?.สถานที่รับรถ : scheduleDetailModal.item?.สถานที่คืนรถ)}`"
            target="_blank"
            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md ml-2 text-center flex items-center justify-center">
            <i class="fas fa-map-marker-alt mr-2"></i>
            เปิดแผนที่
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal แสดงรายละเอียดกลุ่มเวลา (Timeline Group) -->
  <div x-show="showTimeGroupModal" x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"
    @click.self="showTimeGroupModal = false">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
      <div class="p-4 border-b flex justify-between items-center" :class="{
           'bg-blue-50': selectedTimeGroup?.type === 'รับรถ',
           'bg-amber-50': selectedTimeGroup?.type === 'ส่งคืนรถ'
         }">
        <h3 class="text-lg font-medium" :class="{
            'text-blue-700': selectedTimeGroup?.type === 'รับรถ',
            'text-amber-700': selectedTimeGroup?.type === 'ส่งคืนรถ'
          }">
          <i class="fas mr-2" :class="{
          'fa-arrow-up': selectedTimeGroup?.type === 'รับรถ',
          'fa-arrow-down': selectedTimeGroup?.type === 'ส่งคืนรถ'
        }"></i>
          <span x-text="selectedTimeGroup?.type + ' เวลา ' + selectedTimeGroup?.time + ' น.'"></span>
          <span class="ml-2 text-sm" x-text="'(' + selectedTimeGroup?.count + ' รายการ)'"></span>
        </h3>
        <button @click="showTimeGroupModal = false" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-4 space-y-3 overflow-y-auto flex-1">
        <template x-for="(item, index) in selectedTimeGroup?.items" :key="item.หมายเลขการจอง">
          <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
            @click="openScheduleDetailsModal(item); showTimeGroupModal = false">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="font-semibold text-gray-800" x-text="item.ชื่อลูกค้า"></div>
                <div class="text-sm text-gray-600 mt-1">
                  <i class="fas fa-car mr-1"></i>
                  <span x-text="item.รถ"></span>
                </div>
                <div class="text-xs text-gray-500 mt-1" x-text="'#' + item.หมายเลขการจอง"></div>
                <div class="text-sm text-gray-600 mt-2 flex items-center"
                  x-show="item.สถานที่รับรถ || item.สถานที่คืนรถ">
                  <i class="fas fa-map-marker-alt mr-1" :class="{
                  'text-blue-500': selectedTimeGroup?.type === 'รับรถ',
                  'text-amber-500': selectedTimeGroup?.type === 'ส่งคืนรถ'
                }"></i>
                  <span x-text="selectedTimeGroup?.type === 'รับรถ' ? item.สถานที่รับรถ : item.สถานที่คืนรถ"></span>
                </div>
              </div>
              <div>
                <i class="fas fa-chevron-right text-gray-400"></i>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>




  <!-- Modal สมัครใช้บริการ -->
  <div x-show="showRegisterServiceModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;" x-cloak>
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>

      <div
        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-4">
          <h3 class="text-lg leading-6 font-bold text-white flex items-center">
            <i class="fas fa-user-plus mr-3 text-white"></i>
            สมัครใช้งานระบบจัดการร้านเช่ารถ
          </h3>
        </div>

        <div class="bg-white px-6 pt-5 pb-6">
          <div class="space-y-6">
            <!-- แท็บสลับการแสดงผล -->
            <div class="border-b border-gray-200">
              <nav class="-mb-px flex">
                <button @click="activeTab = 'plans'"
                  :class="{'border-blue-500 text-blue-600': activeTab === 'plans', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'plans'}"
                  class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                  เลือกแผนสมาชิก
                </button>
                <button @click="activeTab = 'details'"
                  :class="{'border-blue-500 text-blue-600': activeTab === 'details', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'details'}"
                  class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                  รายละเอียดแต่ละแพลน
                </button>
              </nav>
            </div>

            <!-- เนื้อหาแท็บ "เลือกแผนสมาชิก" -->
            <div x-show="activeTab === 'plans'">
              <div class="text-center mb-4">
                <h4 class="text-lg font-medium text-gray-900">เลือกแผนสมาชิก</h4>
              </div>

              <!-- แผนสมาชิก -->
              <div class="space-y-4">
                <!-- แผนรายเดือน -->
                <div @click="selectedServicePlan = 'monthly'"
                  :class="{'border-blue-500 bg-blue-50': selectedServicePlan === 'monthly', 'border-gray-200': selectedServicePlan !== 'monthly'}"
                  class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md">
                  <div class="flex justify-between items-center">
                    <div>
                      <h5 class="font-semibold text-gray-900">รายเดือน</h5>
                      <p class="text-sm text-gray-600">ใช้งานสำหรับ 1 เดือน</p>
                      <p class="text-xs text-red-600 font-semibold">โปรโมชั่นลูกค้าใหม่ เดือนแรกเพียง 199 บาท</p>
                    </div>
                    <div class="text-right">
                      <span class="text-gray-500 line-through text-sm">300 บาท</span>
                      <div class="text-blue-600 font-bold text-xl">
                        199 บาท
                      </div>
                    </div>
                  </div>
                </div>

                <!-- แผนรายปี -->
                <div @click="selectedServicePlan = 'yearly'"
                  :class="{'border-blue-500 bg-blue-50': selectedServicePlan === 'yearly', 'border-gray-200': selectedServicePlan !== 'yearly'}"
                  class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md">
                  <div class="flex justify-between items-center">
                    <div>
                      <h5 class="font-semibold text-gray-900">รายปี</h5>
                      <p class="text-sm text-gray-600">ใช้งานสำหรับ 1 ปี</p>
                    </div>
                    <div class="text-blue-600 font-bold text-xl">
                      3,000 บาท
                    </div>
                  </div>
                </div>

                <!-- แผนตลอดชีพ -->
                <div @click="selectedServicePlan = 'lifetime'"
                  :class="{'border-blue-500 bg-blue-50': selectedServicePlan === 'lifetime', 'border-gray-200': selectedServicePlan !== 'lifetime'}"
                  class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md">
                  <div class="flex justify-between items-center">
                    <div>
                      <h5 class="font-semibold text-gray-900">ซื้อครั้งเดียว</h5>
                      <p class="text-sm text-gray-600">ใช้งานได้ตลอดไป</p>
                    </div>
                    <div class="text-blue-600 font-bold text-xl">
                      25,000 บาท
                    </div>
                  </div>
                </div>
              </div>

              <!-- ปุ่มดำเนินการต่อ -->
              <div class="mt-6 flex justify-center">
                <button @click="showPaymentFormInfo = true" :disabled="!selectedServicePlan"
                  :class="{'bg-blue-600 hover:bg-blue-700': selectedServicePlan, 'bg-gray-400 cursor-not-allowed': !selectedServicePlan}"
                  class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-3 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <i class="fas fa-credit-card mr-2"></i>
                  ดำเนินการชำระเงิน
                </button>
              </div>
            </div>

            <!-- เนื้อหาแท็บ "รายละเอียดแต่ละแพลน" -->
            <div x-show="activeTab === 'details'" class="overflow-x-auto">
              <div class="text-center mb-4">
                <h4 class="text-lg font-medium text-gray-900">รายละเอียดแต่ละแพลน</h4>
              </div>

              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col"
                      class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      คุณสมบัติ
                    </th>
                    <th scope="col"
                      class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      รายเดือน<br>
                      <span class="text-blue-600 font-bold">300 บาท</span>
                    </th>
                    <th scope="col"
                      class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      รายปี<br>
                      <span class="text-blue-600 font-bold">3,000 บาท</span>
                    </th>
                    <th scope="col"
                      class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ซื้อครั้งเดียว<br>
                      <span class="text-blue-600 font-bold">25,000 บาท</span>
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <!-- คุณสมบัติ: สร้างรายการเช่า -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      สร้างรายการเช่าได้ไม่จำกัด
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: เพิ่มรถ -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      เพิ่มรถได้ไม่จำกัด
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: เก็บข้อมูลใน Google Drive -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      เก็บข้อมูลใน Google Drive
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: ใช้ subdomain -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      ใช้ sub domain เป็นชื่อร้านของท่าน<br>
                      <span class="text-xs text-gray-500">(เช่น mycarrent.kpcrm.net)</span>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: เก็บข้อมูลใน Google Drive ส่วนตัว -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      เก็บข้อมูลใน Google Drive ส่วนตัว
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>

                  <!-- คุณสมบัติ: ฟังก์ชั่นส่ง SMS -->
                  <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800">
                      ฟังก์ชั่นส่ง SMS หาลูกค้า<br>
                      <span class="text-xs text-gray-500">(ฟรีเครดิตSMS 1000SMS มูลค่า550บาท)</span>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-red-600">
                      <i class="fas fa-times"></i>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center text-green-600">
                      <i class="fas fa-check"></i>
                    </td>
                  </tr>


                </tbody>
              </table>

              <!-- ปุ่มกลับไปเลือกแผน -->
              <div class="mt-6 flex justify-center">
                <button @click="activeTab = 'plans'"
                  class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-3 text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <i class="fas fa-arrow-left mr-2"></i>
                  กลับไปเลือกแผน
                </button>
              </div>
            </div>

            <!-- ข้อมูลการชำระเงินและลงทะเบียน -->
            <div x-show="showPaymentFormInfo && activeTab === 'plans'" x-transition class="mt-6 border-t pt-6">
              <h4 class="text-lg font-medium text-gray-900 mb-4">ข้อมูลการลงทะเบียนและชำระเงิน</h4>

              <!-- ฟอร์มลงทะเบียน -->
              <div class="mb-4 border-b pb-4">
                <h5 class="font-medium text-gray-700 mb-3">ข้อมูลลงทะเบียน</h5>

                <div class="space-y-3">
                  <!-- อีเมล Gmail -->
                  <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">อีเมลสำหรับเข้าสู่ระบบ
                      (Gmail เท่านั้น)<span class="text-red-500">*</span></label>
                    <div class="mt-1">
                      <input type="email" id="register-email" x-model="newUserInfo.email"
                        placeholder="example@gmail.com"
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                        @input="validateEmail">
                      <p x-show="!isValidEmail && newUserInfo.email.length > 0" class="mt-1 text-sm text-red-600">
                        กรุณาใช้อีเมล Gmail เท่านั้น</p>
                    </div>
                  </div>

                  <!-- รหัสผ่าน -->
                  <div>
                    <label for="register-password"
                      class="block text-sm font-medium text-gray-700">รหัสผ่านสำหรับเข้าสู่ระบบ<span
                        class="text-red-500">*</span></label>
                    <div class="mt-1">
                      <input type="text" id="register-password" x-model="newUserInfo.password"
                        placeholder="รหัสผ่านอย่างน้อย 6 ตัวอักษร"
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    </div>
                  </div>

                  <!-- เบอร์โทรศัพท์ -->
                  <div>
                    <label for="register-phone" class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์<span
                        class="text-red-500">*</span></label>
                    <div class="mt-1">
                      <input type="text" id="register-phone" x-model="newUserInfo.phoneNumber" placeholder="0xxxxxxxxx"
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    </div>
                  </div>

                  <!-- ชื่อร้าน -->
                  <div>
                    <label for="register-store"
                      class="block text-sm font-medium text-gray-700">ชื่อร้านที่ต้องการลงทะเบียน<span
                        class="text-red-500">*</span></label>
                    <div class="mt-1">
                      <input type="text" id="register-store" x-model="newUserInfo.storeName"
                        placeholder="ชื่อร้านของคุณ"
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    </div>
                  </div>
                </div>
              </div>

              <!-- ข้อมูลการชำระเงิน -->


              <!-- ข้อมูลการชำระเงิน -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 mb-2">ข้อมูลการชำระเงิน</h5>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div class="bg-gray-50 p-3 rounded-lg">
                    <h5 class="font-medium text-gray-700 mb-1 text-sm">หมายเลขบัญชี</h5>
                    <div class="flex items-center">
                      <input type="text" value="0271813236" id="accountNumber2" readonly
                        class="bg-white px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm flex-1">
                      <button @click="copyToClipboard('accountNumber2')"
                        class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </div>

                  <div class="bg-gray-50 p-3 rounded-lg">
                    <h5 class="font-medium text-gray-700 mb-1 text-sm">ชื่อบัญชี</h5>
                    <div class="flex items-center">
                      <input type="text" value="นายคฑาวุธ มีกุญชร" id="accountName2" readonly
                        class="bg-white px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm flex-1">
                      <button @click="copyToClipboard('accountName2')"
                        class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </div>

                  <div class="bg-gray-50 p-3 rounded-lg">
                    <h5 class="font-medium text-gray-700 mb-1 text-sm">ธนาคาร</h5>
                    <div class="flex items-center">
                      <input type="text" value="กสิกรไทย" id="bankName2" readonly
                        class="bg-white px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm flex-1">
                      <button @click="copyToClipboard('bankName2')"
                        class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- อัพโหลดสลิป -->
                <div class="mt-3">
                  <h5 class="font-medium text-gray-700 mb-1">อัพโหลดสลิปการโอนเงิน</h5>
                  <div
                    class="mt-1 flex justify-center px-4 pt-3 pb-4 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                      <i class="fas fa-upload text-gray-400 text-2xl mb-1"></i>
                      <div class="flex text-sm text-gray-600">
                        <label for="file-upload"
                          class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                          <span>อัพโหลดไฟล์</span>
                          <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/*"
                            @change="handleRegisterSlipUpload">
                        </label>
                        <p class="pl-1">หรือลากไฟล์มาวาง</p>
                      </div>
                      <p class="text-xs text-gray-500">
                        PNG, JPG, GIF ขนาดไม่เกิน 10MB
                      </p>
                    </div>
                  </div>

                  <!-- แสดงตัวอย่างรูปภาพที่อัพโหลด -->
                  <div x-show="slipPreviewUrl" class="mt-3">
                    <div class="relative">
                      <img :src="slipPreviewUrl" class="max-h-32 object-contain mx-auto border rounded-md">
                      <button @click="slipPreviewUrl = null; slipFile = null"
                        class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- ปุ่มลงทะเบียน -->
                <div class="mt-5 flex justify-center">
                  <button @click="submitRegistration" :disabled="!canSubmitRegistration || isSubmitting"
                    :class="{'bg-green-600 hover:bg-green-700': canSubmitRegistration && !isSubmitting, 'bg-gray-400 cursor-not-allowed': !canSubmitRegistration || isSubmitting}"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-3 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <template x-if="!isSubmitting">
                      <span class="flex items-center">
                        <i class="fas fa-user-plus mr-2"></i>
                        ลงทะเบียน
                      </span>
                    </template>
                    <template x-if="isSubmitting">
                      <span class="flex items-center">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i>
                        กำลังลงทะเบียน...
                      </span>
                    </template>
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse">
          <button @click="closeRegisterServiceModal()" type="button"
            class="w-full sm:w-auto mt-3 sm:mt-0 inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-times mr-2"></i>
            ปิด
          </button>
        </div>
      </div>
    </div>
  </div>



  <!-- Modal แสดงรายละเอียดการจอง -->
  <!-- ปรับปรุง Modal แสดงรายละเอียดการจอง -->
  <div class="fixed inset-0 z-50 overflow-y-auto" x-show="showBookingDetailsModal" x-cloak style="display: none;">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-black opacity-60"></div>
      </div>

      <div
        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 px-4 py-3">
          <h3 class="text-lg leading-6 font-semibold text-white flex items-center">
            <i class="fas fa-bookmark mr-2"></i>
            รายละเอียดการจอง <span x-text="currentBookingDetails?.bookingNo || ''" class="ml-2"></span>
          </h3>
        </div>

        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <!-- ข้อมูลลูกค้า -->
              <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200">
                <h4 class="text-sm font-medium text-gray-600 mb-2">ข้อมูลลูกค้า</h4>
                <p class="text-base font-medium text-gray-900" x-text="currentBookingDetails?.customerName || '-'"></p>
                <a x-show="currentBookingDetails?.customerPhone"
                  :href="currentBookingDetails?.customerPhone ? `tel:${currentBookingDetails.customerPhone}` : '#'"
                  class="text-blue-600 hover:underline flex items-center mt-1">
                  <i class="fas fa-phone text-xs mr-1"></i>
                  <span x-text="currentBookingDetails?.customerPhone || '-'"></span>
                </a>
              </div>

              <!-- ข้อมูลการเช่า -->
              <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-600 mb-2">ระยะเวลาเช่า</h4>
                <div class="flex justify-between space-x-2">
                  <div class="text-center p-4 bg-green-50 rounded-lg flex-1 shadow-md">
                    <div class="text-xs text-gray-500">วันที่รับรถ</div>
                    <div class="font-medium text-gray-900" x-text="currentBookingDetails?.startDate || '-'"></div>
                    <div class="text-sm text-gray-600" x-text="currentBookingDetails?.startTime || '-'"></div>
                    <a x-show="currentBookingDetails?.pickupLocation"
                      :href="currentBookingDetails?.pickupLocation ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentBookingDetails.pickupLocation)}` : '#'"
                      target="_blank" class="text-blue-600 hover:underline flex items-center mt-1 text-xs">
                      <i class="fas fa-map-marker-alt mr-1"></i>
                      <span x-text="currentBookingDetails?.pickupLocation || '-'"></span>
                    </a>
                  </div>
                  <div class="text-center p-4 bg-red-50 rounded-lg flex-1 shadow-md">
                    <div class="text-xs text-gray-500">วันที่คืนรถ</div>
                    <div class="font-medium text-gray-900" x-text="currentBookingDetails?.endDate || '-'"></div>
                    <div class="text-sm text-gray-600" x-text="currentBookingDetails?.endTime || '-'"></div>
                    <a x-show="currentBookingDetails?.returnLocation"
                      :href="currentBookingDetails?.returnLocation ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentBookingDetails.returnLocation)}` : '#'"
                      target="_blank" class="text-blue-600 hover:underline flex items-center mt-1 text-xs">
                      <i class="fas fa-map-marker-alt mr-1"></i>
                      <span x-text="currentBookingDetails?.returnLocation || '-'"></span>
                    </a>
                  </div>
                </div>

                <div class="text-center mt-4 font-semibold text-xl text-indigo-700">
                  <span class="block text-lg font-medium text-gray-600">รวมระยะเวลาเช่า</span>
                  <div class="flex items-center justify-center">
                    <template x-if="calculateRentalDays() > 0">
                      <div class="flex items-center space-x-2">
                        <span class="text-4xl font-bold text-indigo-700" x-text="calculateRentalDays() || '0'"></span>
                        <span class="text-2xl text-gray-500">วัน</span>

                        <!-- แสดงชั่วโมงที่เหลือ -->
                        <template x-if="calculateRemainingHours() > 0">
                          <div class="flex items-center space-x-2 ml-2">
                            <span class="text-2xl font-bold text-blue-600" x-text="calculateRemainingHours()"></span>
                            <span class="text-xl text-gray-500">ชั่วโมง</span>
                          </div>
                        </template>
                      </div>
                    </template>
                    <template x-if="calculateRentalDays() === 0">
                      <div class="text-xl text-gray-500">ไม่มีข้อมูล</div>
                    </template>
                  </div>
                  <div class="text-xs text-gray-500 mt-2" x-show="config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน > 0">
                    (หากเกิน <span x-text="config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน || '4'"></span> ชั่วโมง คิดเพิ่มเป็น
                    1 วัน)
                  </div>
                </div>


              </div>

              <!-- ข้อมูลค่าบริการ -->
              <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-600 mb-2">ค่าบริการ</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <div class="text-xs text-gray-500">ค่าเช่าต่อวัน</div>
                    <div class="font-medium text-gray-900"
                      x-text="formatCurrency(currentBookingDetails?.dailyRate || 0)"></div>
                  </div>
                  <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <div class="text-xs text-gray-500">ค่าเช่ารวม</div>
                    <div class="font-medium text-gray-900"
                      x-text="formatCurrency(currentBookingDetails?.totalRent || 0)"></div>
                  </div>
                  <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <div class="text-xs text-gray-500">ค่ามัดจำคิวรถ</div>
                    <div class="font-medium text-gray-900"
                      x-text="formatCurrency(currentBookingDetails?.bookingDeposit || 0)"></div>
                  </div>
                  <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <div class="text-xs text-gray-500">เงินประกัน</div>
                    <div class="font-medium text-gray-900" x-text="formatCurrency(currentBookingDetails?.deposit || 0)">
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4 mb-4 p-4 bg-green-50 rounded-lg shadow-md border-2 border-green-200">
                <div class="flex justify-between items-center">
                  <div class="text-sm font-medium text-green-700">รวมยอดชำระวันรับรถ</div>
                  <div class="font-bold text-lg text-green-700"
                    x-text="formatCurrency((currentBookingDetails?.totalRent || 0) - (currentBookingDetails?.bookingDeposit || 0) + (currentBookingDetails?.deposit || 0))">
                  </div>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  (ค่าเช่า + เงินประกัน - ค่ามัดจำคิวรถ)
                </div>
              </div>


              <!-- สัญญาเช่า -->
              <div x-show="currentBookingDetails?.pdfId" class="text-center">
                <a :href="currentBookingDetails?.pdfId ? `https://drive.google.com/file/d/${currentBookingDetails.pdfId}/view` : '#'"
                  target="_blank"
                  class="inline-flex items-center px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                  <i class="fas fa-file-pdf mr-2"></i>
                  ดูสัญญาเช่า
                </a>
              </div>



            </div>
          </div>
        </div>

        <div class="bg-gray-50 px-6 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button @click="showBookingDetailsModal = false" type="button"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            ปิด
          </button>
        </div>
      </div>
    </div>
  </div>






  <!-- Modal สำหรับการเพิ่มและแก้ไขการแจ้งเตือนบำรุงรักษา -->
  <div x-show="showMaintenanceModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>

      <div
        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <!-- ส่วนหัวของ Modal -->
        <div :class="maintenanceEditMode ? 'bg-yellow-600' : 'bg-blue-600'" class="px-4 py-4">
          <h3 class="text-lg leading-6 font-medium text-white flex items-center">
            <i :class="maintenanceEditMode ? 'fas fa-edit' : 'fas fa-bell'" class="mr-2"></i>
            <span x-text="maintenanceModalTitle"></span>
          </h3>
        </div>

        <!-- ส่วนเนื้อหาของฟอร์ม -->
        <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">

            <div class="mt-4 space-y-4">
              <!-- เลือกรถ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">รถ <span
                    class="text-red-600">*</span></label>
                <select x-model="currentMaintenance.รถ"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- เลือกรถ --</option>
                  <template x-for="car in cars" :key="car.id">
                    <option :value="car.ยี่ห้อ + ' ' + car.รุ่น + ' (' + car.ทะเบียน + ')'"
                      x-text="car.ยี่ห้อ + ' ' + car.รุ่น + ' (' + car.ทะเบียน + ')'"></option>
                  </template>
                </select>
              </div>

              <!-- ประเภทการแจ้งเตือน -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ประเภทการแจ้งเตือน <span
                    class="text-red-600">*</span></label>
                <div class="relative">
                  <select x-model="currentMaintenance.ประเภทการแจ้งเตือน" x-show="!isCustomMaintenanceType"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">-- เลือกประเภทการแจ้งเตือน --</option>
                    <option value="จ่ายค่างวด">จ่ายค่างวด</option>
                    <option value="ต่อ พ.ร.บ.และภาษี">ต่อ พ.ร.บ.และภาษี</option>
                    <option value="ต่อประกัน">ต่อประกัน</option>
                    <option value="เข้าศูนย์">เข้าศูนย์</option>
                    <option value="สลับยาง">สลับยาง</option>
                    <option value="เปลี่ยนน้ำมันเครื่อง">เปลี่ยนน้ำมันเครื่อง</option>
                    <option value="อื่นๆ (ระบุเอง)">อื่นๆ (ระบุเอง)</option>
                  </select>
                  <input type="text" x-model="currentMaintenance.ประเภทการแจ้งเตือน" x-show="isCustomMaintenanceType"
                    placeholder="ระบุประเภทการแจ้งเตือน"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <button
                    @click="isCustomMaintenanceType = !isCustomMaintenanceType; currentMaintenance.ประเภทการแจ้งเตือน = ''"
                    class="absolute right-2 top-2 text-gray-500 hover:text-gray-700">
                    <i :class="isCustomMaintenanceType ? 'fas fa-list' : 'fas fa-edit'"></i>
                  </button>
                </div>
              </div>

              <!-- รูปแบบการแจ้งเตือน -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">รูปแบบการแจ้งเตือน <span
                    class="text-red-600">*</span></label>
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="radio" id="oneTime" x-model="currentMaintenance.รูปแบบการแจ้งเตือน" value="ครั้งเดียว"
                      class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                    <label for="oneTime" class="ml-2 block text-sm text-gray-700">ครั้งเดียว</label>
                  </div>
                  <div class="flex items-center">
                    <input type="radio" id="monthly" x-model="currentMaintenance.รูปแบบการแจ้งเตือน" value="ทุกเดือน"
                      class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                    <label for="monthly" class="ml-2 block text-sm text-gray-700">ทุกเดือน</label>
                  </div>
                  <div class="flex items-center">
                    <input type="radio" id="mileage" x-model="currentMaintenance.รูปแบบการแจ้งเตือน"
                      value="ตามระยะทางที่กำหนด" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                    <label for="mileage" class="ml-2 block text-sm text-gray-700">ตามระยะทางที่กำหนด</label>
                  </div>
                </div>
              </div>

              <!-- ข้อมูลเพิ่มเติมตามรูปแบบการแจ้งเตือน -->

              <!-- ครั้งเดียว: เลือกวันที่ -->
              <div x-show="currentMaintenance.รูปแบบการแจ้งเตือน === 'ครั้งเดียว'" class="space-y-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่แจ้งเตือน <span
                    class="text-red-600">*</span></label>
                <input type="date" x-model="currentMaintenance.วันที่แจ้งเตือน"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>

              <!-- ทุกเดือน: เลือกวันที่ในเดือน (1-28) -->
              <div x-show="currentMaintenance.รูปแบบการแจ้งเตือน === 'ทุกเดือน'" class="space-y-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่ในเดือน (1-28) <span
                    class="text-red-600">*</span></label>
                <input type="number" x-model="currentMaintenance.วันที่ในเดือน" min="1" max="28"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-500">กรุณาระบุเฉพาะวันที่ 1-28 เท่านั้น</p>
              </div>

              <!-- ทุกระยะทาง: กรอกระยะทางเป้าหมายและปัจจุบัน -->
              <div x-show="currentMaintenance.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด'" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ระยะทางเป้าหมาย (กม.) <span
                      class="text-red-600">*</span></label>
                  <input type="number" x-model="currentMaintenance.ระยะทางเป้าหมาย" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ระยะทางปัจจุบัน (กม.) <span
                      class="text-red-600">*</span></label>
                  <input type="number" x-model="currentMaintenance.ระยะทางปัจจุบัน" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
              </div>

              <!-- หมายเหตุ: สำหรับทุกรูปแบบการแจ้งเตือน -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                <textarea x-model="currentMaintenance.หมายเหตุ" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- ปุ่มบันทึกและยกเลิก -->
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button @click="saveMaintenance()" type="button"
            :class="maintenanceEditMode ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-blue-600 hover:bg-blue-700'"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm">
            <i :class="maintenanceEditMode ? 'fas fa-save' : 'fas fa-plus'" class="mr-2"></i>
            <span x-text="maintenanceEditMode ? 'บันทึกการแก้ไข' : 'สร้างการแจ้งเตือน'"></span>
          </button>
          <button @click="closeMaintenanceModal()" type="button"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            <i class="fas fa-times mr-2"></i>
            ยกเลิก
          </button>
        </div>
      </div>
    </div>
  </div>




  <div x-show="notification.show" x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform translate-y-2"
    x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100 transform translate-y-0"
    x-transition:leave-end="opacity-0 transform translate-y-2" @click="notification.show = false"
    class="fixed top-5 right-5 z-[100] w-full max-w-sm cursor-pointer" x-cloak>
    <div class="p-4 rounded-lg shadow-lg flex items-start" :class="{
           'bg-green-100 border-green-500 text-green-800': notification.type === 'success',
           'bg-red-100 border-red-500 text-red-800': notification.type === 'error',
           'bg-blue-100 border-blue-500 text-blue-800': notification.type === 'info',
           'bg-yellow-100 border-yellow-500 text-yellow-800': notification.type === 'warning'
         }">
      <div class="flex-shrink-0">
        <i class="fas" :class="{
            'fa-check-circle': notification.type === 'success',
            'fa-times-circle': notification.type === 'error',
            'fa-info-circle': notification.type === 'info',
            'fa-exclamation-triangle': notification.type === 'warning'
        }"></i>
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium" x-text="notification.message"></p>
      </div>
    </div>
  </div>



  <!-- Tutorial Modal -->

  <div x-show="showTutorial" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center p-2 sm:p-4 z-50"
    @click.self="closeTutorial()">

    <!-- Modal Container -->
    <div
      class="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-sm sm:max-w-md md:max-w-lg lg:max-w-2xl max-h-[95vh] sm:max-h-[90vh] flex flex-col">

      <!-- Header - Fixed -->
      <div
        class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 sm:p-4 md:p-6 rounded-t-xl sm:rounded-t-2xl flex-shrink-0">
        <div class="flex items-center justify-between mb-3 sm:mb-4">
          <div class="flex items-center space-x-2 sm:space-x-3">
            <div
              class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-white/20 rounded-full flex items-center justify-center">
              <i class="fas fa-magic text-sm sm:text-lg md:text-2xl"></i>
            </div>
            <div>
              <h3 class="text-sm sm:text-lg md:text-xl font-bold">ฟีเจอร์ใหม่!</h3>
              <p class="text-blue-100 text-xs sm:text-sm hidden sm:block">โหมดจองแบบไม่ระบุชื่อรถ</p>
            </div>
          </div>
          <button @click="closeTutorial()"
            class="text-white/80 hover:text-white transition-colors p-1 sm:p-2 rounded-full hover:bg-white/10">
            <i class="fas fa-times text-lg sm:text-xl"></i>
          </button>
        </div>

        <!-- Progress Bar -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">ขั้นตอนที่ <span x-text="tutorialStep"></span> จาก 7</span>
            <span class="text-sm" x-text="`${Math.round((tutorialStep/7)*100)}%`"></span>
          </div>
          <div class="w-full bg-white/20 rounded-full h-2">
            <div class="bg-white rounded-full h-2 transition-all duration-300"
              :style="`width: ${(tutorialStep/7)*100}%`"></div>
          </div>
        </div>
      </div>

      <!-- Content - Scrollable -->
      <div class="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6">

        <!-- Step 1: Hi กำลังมา -->
        <div x-show="tutorialStep === 1" x-transition class="text-center space-y-4 sm:space-y-6">
          <div
            class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto animate-pulse">
            <i class="fas fa-arrow-up-right-dots text-2xl sm:text-3xl text-white"></i>

          </div>
          <h4 class="text-xl sm:text-2xl font-bold text-gray-800">Hi Season! กำลังมา</h4>
          <div class="bg-blue-50 p-4 sm:p-6 rounded-xl border border-blue-100">
            <!-- Image Upload Section -->
            <div class="mb-4">
              <div
                class="w-full h-32 sm:h-40 md:h-48 bg-gradient-to-br from-blue-200 to-purple-200 rounded-lg flex items-center justify-center relative overflow-hidden border-2 border-dashed border-blue-300">
                <div x-show="!stepImages[1]" class="text-center">
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 animate-[shimmer_2s_infinite]">
                  </div>
                  <div class="relative z-10">
                    <i class="fas fa-car text-2xl sm:text-3xl md:text-4xl text-blue-600 mb-2"></i>
                    <i class="fas fa-question-circle text-lg sm:text-xl md:text-2xl text-purple-600"></i>
                    <p class="text-xs sm:text-sm text-gray-600 mt-2">ไม่ระบุป้ายทะเบียน</p>
                  </div>
                </div>
                <img x-show="stepImages[1]" :src="stepImages[1]" class="w-full h-full object-cover rounded-lg"
                  alt="Step 1 Image">
              </div>


            </div>

            <p class="text-sm sm:text-base text-gray-700 leading-relaxed">
              แนะนำฟีเจอร์ใหม่ <strong class="text-blue-600">"โหมดจองแบบไม่ระบุชื่อรท"</strong>
              เพื่อเพิ่มยอดขายให้กับร้าน
            </p>
          </div>
          <div class="bg-blue-100 p-3 sm:p-4 rounded-lg">
            <p class="text-xs sm:text-sm text-blue-800">
              <i class="fas fa-info-circle mr-2"></i>
              คุณสามารถเปิดโหมด <strong>"โหมดจองแบบไม่ระบุชื่อรถ"</strong> ได้ในหน้า สร้างรายการเช่าใหม่
            </p>
          </div>
        </div>

        <!-- Step 2: เปิดสวิตช์ -->
        <div x-show="tutorialStep === 2" x-transition class="text-center space-y-4 sm:space-y-6">
          <div
            class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-toggle-on text-2xl sm:text-3xl text-white"></i>
          </div>
          <h4 class="text-xl sm:text-2xl font-bold text-gray-800">เปิดโหมดจองแบบไม่ระบุชื่อรถ</h4>
          <div class="bg-green-50 p-4 sm:p-6 rounded-xl border border-green-100">
            <!-- Image Upload Section -->
            <div class="mb-4">
              <div
                class="w-full h-32 sm:h-40 md:h-48 bg-gradient-to-br from-green-200 to-blue-200 rounded-lg flex items-center justify-center border-2 border-dashed border-green-300 relative">
                <div x-show="!stepImages[2]" class="text-center">
                  <div class="mb-2 sm:mb-4">
                    <div class="inline-flex items-center bg-white p-2 sm:p-3 rounded-lg shadow-md">
                      <span class="text-xs sm:text-sm text-gray-600 mr-2 sm:mr-3">โหมดไม่ระบุรถ</span>
                      <i class="fas fa-toggle-on text-2xl sm:text-3xl text-green-500"></i>
                    </div>
                  </div>
                  <p class="text-xs sm:text-sm text-gray-600">เปิดใช้งาน</p>
                </div>
                <img x-show="stepImages[2]" :src="stepImages[2]" class="w-full h-full object-cover rounded-lg"
                  alt="Step 2 Image">
              </div>


            </div>

            <p class="text-sm sm:text-base text-gray-700 leading-relaxed">
              เมื่อเปิดโหมดนี้ คุณสามารถพิมพ์เฉพาะชื่อรถลงไป
              <strong class="text-green-600">โดยไม่ต้องระบุป้ายทะเบียน</strong>
            </p>
          </div>
        </div>

        <!-- Step 3: การ์ดแจ้งเตือน -->
        <div x-show="tutorialStep === 3" x-transition class="text-center space-y-4 sm:space-y-6">
          <div
            class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-bell text-2xl sm:text-3xl text-white"></i>
          </div>
          <h4 class="text-xl sm:text-2xl font-bold text-gray-800">การ์ดแจ้งเตือน</h4>
          <div class="bg-orange-50 p-4 sm:p-6 rounded-xl border border-orange-100">
            <!-- Image Upload Section -->
            <div class="mb-4">
              <div
                class="w-full h-32 sm:h-40 md:h-48 bg-gradient-to-br from-orange-200 to-red-200 rounded-lg flex items-center justify-center border-2 border-dashed border-orange-300">
                <div x-show="!stepImages[3]" class="text-center">
                  <div class="bg-white p-3 sm:p-4 rounded-lg shadow-lg border-l-4 border-orange-500 max-w-xs">
                    <div class="flex items-center space-x-2 sm:space-x-3">
                      <div class="w-8 h-8 sm:w-10 sm:h-10 bg-orange-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-orange-600 text-sm sm:text-base"></i>
                      </div>
                      <div class="text-left">
                        <h5 class="font-semibold text-gray-800 text-sm sm:text-base">รอหารถ</h5>
                        <p class="text-xs sm:text-sm text-gray-600">5 รายการ</p>
                      </div>
                    </div>
                  </div>
                </div>
                <img x-show="stepImages[3]" :src="stepImages[3]" class="w-full h-full object-cover rounded-lg"
                  alt="Step 3 Image">
              </div>


            </div>

            <p class="text-sm sm:text-base text-gray-700 leading-relaxed">
              ในหน้าสรุปข้อมูล จะมี<strong class="text-orange-600">การ์ดแจ้งเตือน "รอหารถ"</strong>
              แสดงจำนวนรายการที่ยังไม่ได้ระบุรถ
            </p>
          </div>
        </div>

        <!-- Step 4: ปุ่มระบุรถ -->
        <div x-show="tutorialStep === 4" x-transition class="text-center space-y-4 sm:space-y-6">
          <div
            class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-mouse-pointer text-2xl sm:text-3xl text-white"></i>
          </div>
          <h4 class="text-xl sm:text-2xl font-bold text-gray-800">ระบุรถ</h4>
          <div class="bg-purple-50 p-4 sm:p-6 rounded-xl border border-purple-100">
            <!-- Image Upload Section -->
            <div class="mb-4">
              <div
                class="w-full h-32 sm:h-40 md:h-48 bg-gradient-to-br from-purple-200 to-pink-200 rounded-lg flex items-center justify-center border-2 border-dashed border-purple-300">
                <div x-show="!stepImages[4]" class="text-center">
                  <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md w-full max-w-xs">
                    <div
                      class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0">
                      <div class="text-left">
                        <p class="font-semibold text-gray-800 text-sm sm:text-base">#KP00123</p>
                        <p class="text-xs sm:text-sm text-gray-600">Honda Civic</p>
                        <p class="text-xs text-orange-600 mt-1">
                          <i class="fas fa-clock mr-1"></i>รอหารถ
                        </p>
                      </div>
                      <button
                        class="bg-blue-500 hover:bg-blue-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded text-xs sm:text-sm transition-colors w-full sm:w-auto">
                        <i class="fas fa-car mr-1"></i>ระบุรถ
                      </button>
                    </div>
                  </div>
                </div>
                <img x-show="stepImages[4]" :src="stepImages[4]" class="w-full h-full object-cover rounded-lg"
                  alt="Step 4 Image">
              </div>


            </div>

            <p class="text-sm sm:text-base text-gray-700 leading-relaxed">
              เมื่อเปิดเข้ามาจะเจอรายการจองที่รอหารถอยู่
              ให้คลิกที่ปุ่ม <strong class="text-purple-600">"ระบุรถ"</strong>
              ของหมายเลขการจองที่ต้องการระบุรถ
            </p>
          </div>
        </div>

        <!-- Step 5: กรอกข้อมูลรถ -->
        <div x-show="tutorialStep === 5" x-transition class="text-center space-y-4 sm:space-y-6">
          <div
            class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-edit text-2xl sm:text-3xl text-white"></i>
          </div>
          <h4 class="text-xl sm:text-2xl font-bold text-gray-800">กรอกข้อมูลรถ</h4>
          <div class="bg-indigo-50 p-4 sm:p-6 rounded-xl border border-indigo-100">
            <!-- Image Upload Section -->
            <div class="mb-4">
              <div
                class="w-full h-40 sm:h-48 md:h-56 bg-gradient-to-br from-indigo-200 to-blue-200 rounded-lg flex items-center justify-center border-2 border-dashed border-indigo-300">
                <div x-show="!stepImages[5]" class="text-center">
                  <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md w-full max-w-sm">
                    <div class="space-y-2 sm:space-y-3">
                      <div>
                        <label class="text-xs text-gray-500 font-medium">ชื่อรถเต็ม</label>
                        <div
                          class="border border-gray-200 rounded px-2 sm:px-3 py-1 sm:py-2 text-xs sm:text-sm bg-gray-50">
                          Toyota Vios สีขาว 2023</div>
                      </div>
                      <div>
                        <label class="text-xs text-gray-500 font-medium">ทะเบียนรถ</label>
                        <div
                          class="border border-gray-200 rounded px-2 sm:px-3 py-1 sm:py-2 text-xs sm:text-sm bg-gray-50">
                          กข 1234 กรุงเทพฯ</div>
                      </div>
                      <div>
                        <label class="text-xs text-gray-500 font-medium">รายได้สุทธิ</label>
                        <div
                          class="border border-gray-200 rounded px-2 sm:px-3 py-1 sm:py-2 text-xs sm:text-sm bg-gray-50">
                          2,000 บาท</div>
                      </div>
                    </div>
                  </div>
                </div>
                <img x-show="stepImages[5]" :src="stepImages[5]" class="w-full h-full object-cover rounded-lg"
                  alt="Step 5 Image">
              </div>


            </div>

            <div
              class="text-left space-y-2 sm:space-y-3 text-xs sm:text-sm text-gray-700 bg-white p-3 sm:p-4 rounded-lg">
              <div class="flex items-start space-x-2">
                <i class="fas fa-car text-indigo-600 mt-1 text-xs sm:text-sm"></i>
                <div>
                  <strong class="text-indigo-600">ชื่อรถเต็ม:</strong> ระบุชื่อรถคันใหม่ที่จะนำมาแทนที่
                </div>
              </div>
              <div class="flex items-start space-x-2">
                <i class="fas fa-id-card text-indigo-600 mt-1 text-xs sm:text-sm"></i>
                <div>
                  <strong class="text-indigo-600">ทะเบียนรถ:</strong> ระบุหมายเลขทะเบียนและจังหวัด
                </div>
              </div>
              <div class="flex items-start space-x-2">
                <i class="fas fa-money-bill text-indigo-600 mt-1 text-xs sm:text-sm"></i>
                <div>
                  <strong class="text-indigo-600">รายได้สุทธิ:</strong> ระบุรายได้จริงหลังหักให้พาร์ทเนอร์แล้ว
                  (ระบบจะบันทึกเป็นรายรับให้อัตโนมัติ)
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6: การส่งและรับคืนรถ -->
        <div x-show="tutorialStep === 6" x-transition class="text-center space-y-4 sm:space-y-6">
          <div
            class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-teal-500 to-green-500 rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-truck text-2xl sm:text-3xl text-white"></i>
          </div>
          <h4 class="text-xl sm:text-2xl font-bold text-gray-800">การส่งและรับคืนรถ</h4>
          <div class="bg-teal-50 p-4 sm:p-6 rounded-xl border border-teal-100">
            <!-- Image Upload Section -->
            <div class="mb-4">
              <div
                class="w-full h-40 sm:h-48 md:h-56 bg-gradient-to-br from-teal-200 to-green-200 rounded-lg flex items-center justify-center border-2 border-dashed border-teal-300">
                <div x-show="!stepImages[6]" class="text-center">
                  <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md w-full max-w-lg">
                    <h5 class="font-semibold text-gray-800 mb-2 sm:mb-3 text-center text-sm sm:text-base">
                      ตั้งค่าการส่งและรับคืนรถ</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 text-xs">
                      <div>
                        <label class="text-gray-500 font-medium">การส่งรถ</label>
                        <div class="border border-gray-200 rounded px-2 py-1 sm:py-2 mt-1 bg-gray-50">ส่งเอง</div>
                      </div>
                      <div>
                        <label class="text-gray-500 font-medium">การรับคืน</label>
                        <div class="border border-gray-200 rounded px-2 py-1 sm:py-2 mt-1 bg-gray-50">รับคืนเอง</div>
                      </div>
                      <div>
                        <label class="text-gray-500 font-medium">สถานที่รับรถ</label>
                        <div class="border border-gray-200 rounded px-2 py-1 sm:py-2 mt-1 bg-blue-50">สนามบิน</div>
                      </div>
                      <div>
                        <label class="text-gray-500 font-medium">สถานที่คืนรถ</label>
                        <div class="border border-gray-200 rounded px-2 py-1 sm:py-2 mt-1 bg-blue-50">หน้าร้าน</div>
                      </div>
                    </div>
                  </div>
                </div>
                <img x-show="stepImages[6]" :src="stepImages[6]" class="w-full h-full object-cover rounded-lg"
                  alt="Step 6 Image">
              </div>


            </div>

            <p class="text-sm sm:text-base text-gray-700 leading-relaxed">
              หน้า <strong class="text-teal-600">"การส่งและรับคืนรถ"</strong>
              เลือกวิธีการส่งรถ/รับคืนรถ และ<strong
                class="text-teal-600">สามารถแก้ไขสถานที่ส่งรถรับคืนรถได้ที่นี่</strong>
            </p>
          </div>
        </div>

        <!-- Step 7: สร้างสัญญาใหม่ -->
        <div x-show="tutorialStep === 7" x-transition class="text-center space-y-4 sm:space-y-6">
          <div
            class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-file-contract text-2xl sm:text-3xl text-white"></i>
          </div>
          <h4 class="text-xl sm:text-2xl font-bold text-gray-800">สร้างสัญญาเช่าใหม่</h4>
          <div class="bg-emerald-50 p-4 sm:p-6 rounded-xl border border-emerald-100">
            <!-- Image Upload Section -->
            <div class="mb-4">
              <div
                class="w-full h-32 sm:h-40 md:h-48 bg-gradient-to-br from-emerald-200 to-teal-200 rounded-lg flex items-center justify-center border-2 border-dashed border-emerald-300">
                <div x-show="!stepImages[7]" class="text-center">
                  <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md text-center">
                    <i class="fas fa-file-pdf text-3xl sm:text-4xl text-red-500 mb-2 sm:mb-3"></i>
                    <p class="text-xs sm:text-sm font-medium text-gray-800 mb-2 sm:mb-3">สัญญาเช่า_KP00123.pdf</p>
                    <button
                      class="bg-green-500 hover:bg-green-600 text-white px-3 sm:px-4 py-1 sm:py-2 rounded-lg text-xs sm:text-sm transition-colors inline-flex items-center">
                      <i class="fas fa-plus mr-1 sm:mr-2"></i>
                      สร้างสัญญาใหม่
                    </button>
                  </div>
                </div>
                <img x-show="stepImages[7]" :src="stepImages[7]" class="w-full h-full object-cover rounded-lg"
                  alt="Step 7 Image">
              </div>


            </div>

            <div class="bg-white p-3 sm:p-4 rounded-lg mb-4">
              <h5 class="font-semibold text-emerald-700 mb-2 sm:mb-3 text-sm sm:text-base">
                <i class="fas fa-info-circle mr-2"></i>เมื่อกดปุ่ม "สร้างสัญญา"
              </h5>
              <div class="text-left space-y-1 sm:space-y-2 text-xs sm:text-sm text-gray-700">
                <div class="flex items-start space-x-2">
                  <i class="fas fa-check text-green-500 mt-1 text-xs"></i>
                  <span>สัญญาเช่าจะถูกอัพเดทชื่อรถและป้ายทะเบียนที่จะส่งให้ลูกค้าในวันรับรถ</span>
                </div>
                <div class="flex items-start space-x-2">
                  <i class="fas fa-check text-green-500 mt-1 text-xs"></i>
                  <span>รายการรอหารถจะถูกอัพเดทโดยอัตโนมัติ</span>
                </div>
              </div>
            </div>

            <!-- Completion Message -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white p-4 sm:p-6 rounded-xl">
              <div class="flex items-center justify-center space-x-2 sm:space-x-3 mb-1 sm:mb-2">
                <i class="fas fa-check-circle text-xl sm:text-2xl"></i>
                <span class="text-base sm:text-lg font-semibold">พร้อมใช้งานแล้ว!</span>
              </div>
              <p class="text-xs sm:text-sm text-green-100">ตอนนี้คุณสามารถใช้ฟีเจอร์ใหม่นี้เพื่อเพิ่มยอดขายได้แล้ว</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer - Fixed -->
      <div
        class="bg-gray-50 px-3 sm:px-4 md:px-6 py-3 sm:py-4 border-t border-gray-200 flex-shrink-0 rounded-b-xl sm:rounded-b-2xl">
        <div class="flex justify-between items-center">
          <button x-show="tutorialStep > 1" @click="tutorialStep--"
            class="px-3 sm:px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors flex items-center text-sm">
            <i class="fas fa-arrow-left mr-1 sm:mr-2"></i>
            <span class="hidden sm:inline">ย้อนกลับ</span>
          </button>

          <div x-show="tutorialStep === 1" class="w-12 sm:w-20"></div>

          <div class="flex items-center space-x-1 sm:space-x-2">
            <!-- Step Indicators -->
            <template x-for="step in 7" :key="step">
              <div class="w-2 h-2 sm:w-3 sm:h-3 rounded-full transition-colors duration-200"
                :class="step <= tutorialStep ? 'bg-blue-500' : 'bg-gray-300'"></div>
            </template>
          </div>

          <div class="flex space-x-2 sm:space-x-3">
            <button x-show="tutorialStep < 7" @click="tutorialStep++"
              class="px-3 sm:px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center text-sm">
              <span class="hidden sm:inline mr-1 sm:mr-2">ถัดไป</span>
              <i class="fas fa-arrow-right"></i>
            </button>

            <button x-show="tutorialStep === 7" @click="completeTutorial()"
              class="px-4 sm:px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center font-medium text-sm">
              <i class="fas fa-check mr-1 sm:mr-2"></i>
              <span class="hidden xs:inline">เริ่มใช้งาน</span>
              <span class="xs:hidden">เริ่ม</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div x-show="showNewFeatures" x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center p-4 z-50"
    @click.self="closeNewFeaturesTutorial()" style="display: none;">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md md:max-w-lg max-h-[90vh] flex flex-col">

      <div class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white p-5 md:p-6 rounded-t-2xl flex-shrink-0">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 md:w-12 md:h-12 bg-white/20 rounded-full flex items-center justify-center">
              <i class="fas fa-star text-lg md:text-2xl"></i>
            </div>
            <div>
              <h3 class="text-lg md:text-xl font-bold">มีอะไรใหม่!</h3>
              <p class="text-cyan-100 text-sm">อัปเดตเพื่อการทำงานที่ง่ายขึ้น</p>
            </div>
          </div>
          <button @click="closeNewFeaturesTutorial()"
            class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">ขั้นตอนที่ <span x-text="newFeaturesStep"></span> จาก <span
                x-text="totalNewFeaturesSteps"></span></span>
            <span class="text-sm" x-text="`${Math.round((newFeaturesStep/totalNewFeaturesSteps)*100)}%`"></span>
          </div>
          <div class="w-full bg-white/20 rounded-full h-2">
            <div class="bg-white rounded-full h-2 transition-all duration-300"
              :style="`width: ${(newFeaturesStep/totalNewFeaturesSteps)*100}%`"></div>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-5 md:p-6">

        <div x-show="newFeaturesStep === 1" x-transition class="text-center space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-search-plus text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800">วิเคราะห์คิวรถได้ลึกขึ้น</h4>
          <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <div
              class="w-full h-80 bg-gradient-to-br from-blue-200 to-indigo-200 rounded-lg flex flex-col items-center justify-center p-4 border-2 border-dashed border-blue-300 relative overflow-hidden">
              <template x-if="newFeaturesImages[1]">
                <img :src="newFeaturesImages[1]" class="w-full h-full object-cover rounded-lg" alt="ฟีเจอร์เช็คคิวรถ">
              </template>
              <div x-show="!newFeaturesImages[1]" class="space-y-3 w-full max-w-xs">
                <div class="bg-white p-3 rounded-lg shadow text-left">
                  <h5 class="font-semibold text-gray-800 text-sm">รถว่างตลอดช่วง</h5>
                  <p class="text-xs text-gray-500">Vios, Yaris, ...</p>
                </div>
                <div class="bg-white p-3 rounded-lg shadow text-left border-l-4 border-amber-500">
                  <h5 class="font-semibold text-gray-800 text-sm">รถที่จอง 1-2 วัน (สลับได้)</h5>
                  <p class="text-xs text-gray-500">Civic, Altis, ...</p>
                </div>
              </div>
            </div>
          </div>
          <p class="text-base text-gray-700 leading-relaxed">
            ในหน้า **เช็คคิวรถ**, ระบบจะแสดง <strong class="text-blue-600">"รถที่ถูกจองระยะสั้น"</strong>
            ในช่วงวันที่คุณเลือก เพื่อให้คุณพิจารณาสลับรถมาให้ลูกค้ารายอื่นได้ง่ายขึ้น
          </p>
        </div>

        <div x-show="newFeaturesStep === 2" x-transition class="text-center space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-green-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-users text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800">จัดการลูกค้าง่ายกว่าเดิม</h4>
          <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
            <div
              class="w-full h-80 bg-gradient-to-br from-emerald-200 to-green-200 rounded-lg flex items-center justify-center p-4 border-2 border-dashed border-emerald-300 relative overflow-hidden">
              <template x-if="newFeaturesImages[2]">
                <img :src="newFeaturesImages[2]" class="w-full h-full object-cover rounded-lg"
                  alt="ฟีเจอร์จัดการลูกค้า">
              </template>
              <div x-show="!newFeaturesImages[2]" class="bg-white p-4 rounded-lg shadow-md w-full max-w-xs text-left">
                <p class="font-bold text-gray-800">CUS-0123</p>
                <p class="text-sm text-gray-600">คุณสมชาย ใจดี</p>
                <p class="text-xs text-green-600 mt-1 bg-green-100 px-2 py-1 rounded-full inline-block">ลูกค้าใหม่</p>
              </div>
            </div>
          </div>
          <p class="text-base text-gray-700 leading-relaxed">
            ที่หน้า **จัดการลูกค้า** คุณสามารถค้นหาและวิเคราะห์ข้อมูลลูกค้าได้ หากสร้างสัญญาเช่าให้ลูกค้าใหม่ ระบบจะ
            <strong class="text-emerald-600">สร้างรหัสลูกค้าให้อัตโนมัติ</strong>
          </p>
        </div>

        <div x-show="newFeaturesStep === 3" x-transition class="text-center space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-file-magnifying-glass text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800">รวมการค้นหาไว้ในหน้าเดียว</h4>
          <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
            <div
              class="w-full h-80 bg-gradient-to-br from-purple-200 to-pink-200 rounded-lg flex items-center justify-center p-4 border-2 border-dashed border-purple-300 relative overflow-hidden">
              <template x-if="newFeaturesImages[3]">
                <img :src="newFeaturesImages[3]" class="w-full h-full object-cover rounded-lg"
                  alt="ฟีเจอร์จัดการการจอง">
              </template>
              <div x-show="!newFeaturesImages[3]"
                class="bg-white p-4 rounded-lg shadow-md w-full max-w-xs text-center space-y-2">
                <div class="relative"><i class="fas fa-search text-gray-400 absolute left-2 top-2.5"></i><input
                    type="text" value="KP-12345" class="border rounded-md w-full pl-8 py-1.5 text-sm" disabled></div>
                <button class="bg-blue-500 text-white px-4 py-1.5 rounded-md text-sm w-full">ใช้ข้อมูล</button>
              </div>
            </div>
          </div>
          <p class="text-base text-gray-700 leading-relaxed">
            หน้า **จัดการการจอง** ได้รวมการค้นหาเข้ามาไว้ด้วยกัน <strong class="text-purple-600">ค้นหาแล้วกด
              "ใช้ข้อมูลนี้"</strong> เพื่อกรอกข้อมูลเดิมลูกค้าได้ทันที
          </p>
        </div>

      </div>

      <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex-shrink-0 rounded-b-2xl">
        <div class="flex justify-between items-center">
          <button x-show="newFeaturesStep > 1" @click="newFeaturesStep--"
            class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors flex items-center text-sm">
            <i class="fas fa-arrow-left mr-2"></i>
            ย้อนกลับ
          </button>

          <div x-show="newFeaturesStep === 1" class="w-20"></div> <button
            x-show="newFeaturesStep < totalNewFeaturesSteps" @click="newFeaturesStep++"
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center text-sm">
            ถัดไป
            <i class="fas fa-arrow-right ml-2"></i>
          </button>

          <button x-show="newFeaturesStep === totalNewFeaturesSteps" @click="completeNewFeaturesTutorial()"
            class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center font-medium text-sm">
            <i class="fas fa-check mr-2"></i>
            เริ่มใช้งาน
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- New Features 2025 Tutorial Modal -->
  <div x-show="showNewFeatures2025Tutorial" x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center p-4 z-50"
    @click.self="closeNewFeatures2025Tutorial()" style="display: none;">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md md:max-w-2xl max-h-[90vh] flex flex-col">

      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-5 md:p-6 rounded-t-2xl flex-shrink-0">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 md:w-12 md:h-12 bg-white/20 rounded-full flex items-center justify-center">
              <i class="fas fa-sparkles text-lg md:text-2xl"></i>
            </div>
            <div>
              <h3 class="text-lg md:text-xl font-bold">อัพเดทครั้งใหญ่ ส่งท้ายปี 2025</h3>
              <p class="text-purple-100 text-sm">ปรับปรุงระบบจัดการค่าเช่าแบบครบวงจร</p>
            </div>
          </div>
          <button @click="closeNewFeatures2025Tutorial()"
            class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">หัวข้อที่ <span x-text="newFeatures2025Step"></span> จาก 5</span>
            <span class="text-sm" x-text="`${Math.round((newFeatures2025Step/5)*100)}%`"></span>
          </div>
          <div class="w-full bg-white/20 rounded-full h-2">
            <div class="bg-white rounded-full h-2 transition-all duration-300"
              :style="`width: ${(newFeatures2025Step/5)*100}%`"></div>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-5 md:p-6">

        <!-- Step 1: จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน -->
        <div x-show="newFeatures2025Step === 1" x-transition class="space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-clock text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800 text-center">จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน</h4>
          <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <p class="text-gray-700 leading-relaxed">
                ตอนนี้คุณสามารถกำหนดชั่วโมงฟรีสำหรับการคืนรถช้า เช่น หากตั้งเป็น <span class="font-bold text-blue-600">2
                  ชั่วโมง</span>
                ลูกค้าคืนรถช้า 1.5 ชม. จะไม่ถูกคิดค่าล่วงเวลา แต่หากช้า 3 ชม. จะคิดเฉพาะ 1 ชม. (3 - 2 = 1)
              </p>
              <div class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-4 rounded-lg">
                <p class="text-sm font-medium mb-2">ตัวอย่าง:</p>
                <div class="space-y-1 text-sm">
                  <p>• เวลารับรถ: 10:00</p>
                  <p>• เวลาคืนรถ: 13:30 (เช่า 3 วัน + 3.5 ชม.)</p>
                  <p>• ชั่วโมงฟรี: 2 ชม.</p>
                  <p class="font-bold">→ คิดค่าล่วงเวลา 1.5 ชม. (3.5 - 2)</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-cog text-amber-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="font-medium text-amber-800 mb-1">ตั้งค่าที่:</p>
                <p class="text-sm text-amber-700">
                  <strong>ตั้งค่าระบบ</strong> → การ์ด <strong>"การจอง"</strong> → ช่อง
                  <strong>"จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน"</strong>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: ค่าล่วงเวลาเริ่มต้น -->
        <div x-show="newFeatures2025Step === 2" x-transition class="space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-money-bill-wave text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800 text-center">ค่าล่วงเวลาเริ่มต้น</h4>
          <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <p class="text-gray-700 leading-relaxed">
                กำหนดอัตราค่าล่วงเวลาเริ่มต้นของระบบ เมื่อสร้างรายการเช่าใหม่
                ระบบจะใช้ค่านี้หากรถยังไม่ได้ตั้งค่าล่วงเวลาเฉพาะรถ
              </p>
              <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 rounded-lg">
                <p class="text-sm font-medium mb-2">ความแตกต่าง:</p>
                <div class="space-y-2 text-sm">
                  <div class="bg-white/20 p-3 rounded">
                    <p class="font-bold mb-1">🔹 ค่าเริ่มต้นของระบบ</p>
                    <p>ใช้เมื่อรถยังไม่ได้ตั้งค่าเฉพาะ</p>
                  </div>
                  <div class="bg-white/20 p-3 rounded">
                    <p class="font-bold mb-1">🚗 ค่าเฉพาะรถ</p>
                    <p>ตั้งค่าในหน้าจัดการรถ มีความสำคัญสูงกว่า</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-cog text-amber-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="font-medium text-amber-800 mb-1">ตั้งค่าที่:</p>
                <p class="text-sm text-amber-700 mb-2">
                  <strong>ตั้งค่าระบบ</strong> → การ์ด <strong>"การจอง"</strong> → ช่อง
                  <strong>"ค่าล่วงเวลาเริ่มต้น"</strong>
                </p>
                <p class="text-sm text-amber-700">
                  <strong>ค่าเฉพาะรถ:</strong> <strong>จัดการรถ</strong> → เลือกรถ → แก้ไข → ช่อง
                  <strong>"ค่าล่วงเวลาต่อชั่วโมง"</strong>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: ประกันเสริม -->
        <div x-show="newFeatures2025Step === 3" x-transition class="space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-shield-alt text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800 text-center">ประกันเสริม</h4>
          <div class="bg-teal-50 p-4 rounded-xl border border-teal-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <p class="text-gray-700 leading-relaxed">
                เพิ่มตัวเลือกประกันเสริมให้กับลูกค้า โดยคิดค่าบริการรายวัน สามารถกำหนดราคาต่อวันได้ในหน้าตั้งค่าระบบ
              </p>
              <div class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white p-4 rounded-lg">
                <p class="text-sm font-medium mb-2">วิธีใช้งาน:</p>
                <div class="space-y-2 text-sm">
                  <p>1️⃣ ตั้งค่าราคาต่อวันในหน้าตั้งค่าระบบ</p>
                  <p>2️⃣ เมื่อสร้างรายการเช่า เลือก "ประกันเสริม"</p>
                  <p>3️⃣ ระบบจะคำนวณราคารวมอัตโนมัติ</p>
                </div>
              </div>
              <div class="bg-teal-100 p-3 rounded-lg">
                <p class="text-sm text-teal-800">
                  <i class="fas fa-calculator mr-2"></i>
                  <strong>สูตร:</strong> จำนวนวันเช่า × ราคาประกันต่อวัน
                </p>
              </div>
            </div>
          </div>
          <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-cog text-amber-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="font-medium text-amber-800 mb-1">ตั้งค่าที่:</p>
                <p class="text-sm text-amber-700">
                  <strong>ตั้งค่าระบบ</strong> → การ์ด <strong>"การจอง"</strong> → ช่อง
                  <strong>"ค่าประกันเสริมต่อวัน"</strong>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: คาร์ซีท -->
        <div x-show="newFeatures2025Step === 4" x-transition class="space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-baby text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800 text-center">คาร์ซีท</h4>
          <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <p class="text-gray-700 leading-relaxed">
                เพิ่มตัวเลือกคาร์ซีทสำหรับลูกค้า สามารถเลือกให้บริการฟรีหรือคิดค่าบริการได้
              </p>
              <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-lg">
                <p class="text-sm font-medium mb-2">ตัวเลือกการให้บริการ:</p>
                <div class="space-y-3 text-sm">
                  <div class="bg-white/20 p-3 rounded">
                    <p class="font-bold mb-1">🎁 ไม่มีค่าบริการ</p>
                    <p>ให้บริการคาร์ซีทฟรี</p>
                  </div>
                  <div class="bg-white/20 p-3 rounded">
                    <p class="font-bold mb-1">💵 มีค่าบริการ</p>
                    <p>กำหนดราคาคาร์ซีทตามต้องการ</p>
                  </div>
                </div>
              </div>
              <div class="bg-purple-100 p-3 rounded-lg">
                <p class="text-sm text-purple-800">
                  <i class="fas fa-info-circle mr-2"></i>
                  คาร์ซีทจะแสดง badge ในไทม์ไลน์รับส่งรถเพื่อให้ง่ายต่อการจัดเตรียม
                </p>
              </div>
            </div>
          </div>
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-location-arrow text-blue-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="font-medium text-blue-800 mb-1">ใช้งานที่:</p>
                <p class="text-sm text-blue-700">
                  <strong>จัดการการจอง</strong> → สร้าง/แก้ไขรายการเช่า → การ์ด <strong>"ตัวเลือกเพิ่มเติม"</strong>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: ระบบคำนวณใหม่ -->
        <div x-show="newFeatures2025Step === 5" x-transition class="space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-calculator text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800 text-center">ระบบคำนวณใหม่ 2025</h4>

          <!-- VAT และหัก ณ ที่จ่าย -->
          <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <h5 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-file-invoice text-blue-600 mr-2"></i>
                รองรับ VAT และหัก ณ ที่จ่าย สำหรับบริษัท
              </h5>
              <div class="space-y-3 text-sm text-gray-700">
                <div class="flex items-start">
                  <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                  <p><strong class="text-blue-700">ใบกำกับภาษี (VAT 7%):</strong> คำนวณอัตโนมัติจากค่าเช่าพื้นฐาน +
                    ค่าล่วงเวลา - ส่วนลด</p>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                  <p><strong class="text-indigo-700">หัก ณ ที่จ่าย:</strong> เลือกรายการที่ต้องการหักภาษี
                    และคำนวณตามเปอร์เซ็นต์ที่กำหนด</p>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                  <p><strong class="text-purple-700">เลือกรายการได้:</strong>
                    ติ๊กเลือกว่าค่าบริการเพิ่มเติม/คาร์ซีท/ประกันเสริม ต้องการคิด VAT/WHT หรือไม่</p>
                </div>
              </div>
            </div>
          </div>

          <!-- การคำนวณแบบละเอียด -->
          <div class="bg-green-50 p-4 rounded-xl border border-green-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <h5 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-list-ul text-green-600 mr-2"></i>
                การคำนวณแบบละเอียดทุกช่อง
              </h5>
              <div class="bg-gray-50 p-3 rounded-lg text-sm space-y-1 font-mono">
                <p>= (จำนวนวัน × ค่าเช่าต่อวัน)</p>
                <p>+ ค่าล่วงเวลา (หลังหักชั่วโมงฟรี)</p>
                <p>+ ค่าบริการเพิ่มเติม</p>
                <p class="text-purple-700">+ ค่าคาร์ซีท</p>
                <p class="text-teal-700">+ ค่าประกันเสริม</p>
                <p class="text-red-700">- ส่วนลด</p>
                <p class="text-blue-700">+ VAT (ถ้ามี)</p>
                <p class="text-indigo-700">- หัก ณ ที่จ่าย (ถ้ามี)</p>
              </div>
              <div class="bg-yellow-50 p-3 rounded-lg">
                <p class="text-sm text-gray-700">
                  <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                  <strong>รวมยอดชำระวันรับรถ</strong> = ค่าเช่ารวมทั้งหมด - มัดจำคิวรถ + เงินประกัน
                </p>
              </div>
            </div>
          </div>

          <!-- การแสดงข้อมูลละเอียด -->
          <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-3">
              <h5 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-eye text-purple-600 mr-2"></i>
                แสดงข้อมูลแบบละเอียด
              </h5>
              <div class="space-y-2 text-sm text-gray-700">
                <div class="flex items-center">
                  <i class="fas fa-clipboard-list text-purple-500 mr-2"></i>
                  <p><strong>สรุปข้อมูลการเช่า:</strong> แสดงรายละเอียดการคำนวณทุกรายการ</p>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-file-contract text-purple-500 mr-2"></i>
                  <p><strong>สัญญาเช่า:</strong> พิมพ์ข้อมูลครบถ้วน พร้อม VAT และ WHT</p>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-icons text-purple-500 mr-2"></i>
                  <p><strong>ไทม์ไลน์กิจกรรม:</strong> แสดงไอคอน
                    <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs mx-1">
                      <i class="fas fa-baby mr-1"></i>คาร์ซีท
                    </span>
                    <span class="inline-flex items-center px-2 py-1 bg-teal-100 text-teal-700 rounded text-xs">
                      <i class="fas fa-shield-alt mr-1"></i>ประกัน
                    </span>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-rocket text-green-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="font-medium text-green-800 mb-1">พร้อมใช้งานทันที!</p>
                <p class="text-sm text-green-700">
                  ระบบคำนวณใหม่ทำงานอัตโนมัติ แสดงผลแบบเรียลไทม์ และรองรับทุกรูปแบบการให้บริการ
                </p>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex-shrink-0 rounded-b-2xl">
        <div class="flex justify-between items-center">
          <button x-show="newFeatures2025Step > 1" @click="newFeatures2025Step--"
            class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors flex items-center text-sm">
            <i class="fas fa-arrow-left mr-2"></i>
            ย้อนกลับ
          </button>

          <div x-show="newFeatures2025Step === 1" class="w-20"></div>

          <button x-show="newFeatures2025Step < 5" @click="newFeatures2025Step++"
            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors flex items-center text-sm">
            ถัดไป
            <i class="fas fa-arrow-right ml-2"></i>
          </button>

          <button x-show="newFeatures2025Step === 5" @click="completeNewFeatures2025Tutorial()"
            class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-colors flex items-center font-medium text-sm shadow-lg">
            <i class="fas fa-check mr-2"></i>
            เข้าใจแล้ว
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- LINE Bot Tutorial Modal -->
  <div x-show="showLineBotTutorial" x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center p-4 z-50"
    @click.self="closeLineBotTutorial()" style="display: none;">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md md:max-w-lg max-h-[90vh] flex flex-col">

      <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-5 md:p-6 rounded-t-2xl flex-shrink-0">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 md:w-12 md:h-12 bg-white/20 rounded-full flex items-center justify-center">
              <i class="fab fa-line text-lg md:text-2xl"></i>
            </div>
            <div>
              <h3 class="text-lg md:text-xl font-bold">ฟีเจอร์ใหม่: LINE Bot</h3>
              <p class="text-green-100 text-sm">ตรวจสอบคิวรถผ่าน LINE ได้แล้ว!</p>
            </div>
          </div>
          <button @click="closeLineBotTutorial()"
            class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">ขั้นตอนที่ <span x-text="linebotTutorialStep"></span> จาก <span
                x-text="totalLinebotTutorialSteps"></span></span>
            <span class="text-sm" x-text="`${Math.round((linebotTutorialStep/totalLinebotTutorialSteps)*100)}%`"></span>
          </div>
          <div class="w-full bg-white/20 rounded-full h-2">
            <div class="bg-white rounded-full h-2 transition-all duration-300"
              :style="`width: ${(linebotTutorialStep/totalLinebotTutorialSteps)*100}%`"></div>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-5 md:p-6">

        <!-- Step 1: ตั้งค่า Secret ID -->
        <div x-show="linebotTutorialStep === 1" x-transition class="text-center space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-key text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800">ตั้งค่า Secret ID</h4>
          <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <div class="flex items-center justify-between">
                <label class="text-sm font-medium text-gray-700">Secret ID</label>
                <span class="font-mono text-lg font-bold text-blue-600">AB12CD</span>
              </div>
              <button
                class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors flex items-center justify-center">
                <i class="fas fa-random mr-2"></i>
                สุ่ม Secret ID
              </button>
            </div>
          </div>
          <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-lightbulb text-amber-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="font-medium text-amber-800 mb-1">ขั้นตอนแรก:</p>
                <p class="text-sm text-amber-700">
                  ไปที่เมนู <strong>"ตั้งค่าระบบ"</strong> → <strong>"ตั้งค่า LINE Bot"</strong> แล้วคลิก <strong>"สุ่ม
                    Secret ID"</strong> เพื่อสร้างรหัสสำหรับใช้ลงทะเบียน
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: เพิ่ม Bot เป็นเพื่อน -->
        <div x-show="linebotTutorialStep === 2" x-transition class="text-center space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fab fa-line text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800">เพิ่ม Bot เป็นเพื่อน</h4>
          <div class="bg-green-50 p-4 rounded-xl border border-green-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
              <p class="text-sm text-gray-600 mb-3">สแกน QR Code เพื่อเพิ่ม Bot</p>
              <div class="flex justify-center">
                <img src="https://qr-official.line.me/gs/M_678onfuf_GW.png?oat_content=qr" alt="LINE Bot QR Code"
                  class="w-48 h-48 rounded-lg shadow-lg border-2 border-green-200">
              </div>
              <div class="text-sm text-gray-500">หรือ</div>
              <a href="https://lin.ee/P6kLQ9a" target="_blank"
                class="inline-block w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                <i class="fas fa-external-link-alt mr-2"></i>
                คลิกที่นี่เพื่อเพิ่มเพื่อน
              </a>
            </div>
          </div>
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="text-sm text-blue-700">
                  หลังจากเพิ่มเพื่อนแล้ว Bot จะขอ <strong>Secret ID</strong> เพื่อลงทะเบียน จากนั้นให้กรอก Secret ID
                  ที่สุ่มได้จากขั้นตอนแรก
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: วิธีใช้งาน -->
        <div x-show="linebotTutorialStep === 3" x-transition class="text-center space-y-6">
          <div
            class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <i class="fas fa-car text-3xl text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-gray-800">วิธีเช็คคิวรถ</h4>
          <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4 text-left">
              <div class="border-b pb-3">
                <h5 class="font-bold text-gray-800 mb-2 flex items-center">
                  <span
                    class="bg-purple-100 text-purple-700 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                  ดูเมนูช่วยเหลือ
                </h5>
                <div class="ml-8 space-y-1">
                  <p class="text-sm text-gray-600">พิมพ์: <code
                      class="bg-gray-100 px-2 py-1 rounded text-purple-600 font-mono">"เช็คคิว"</code></p>
                  <p class="text-sm text-gray-600">หรือ: <code
                      class="bg-gray-100 px-2 py-1 rounded text-purple-600 font-mono">"ตารางส่งรถ"</code></p>
                </div>
              </div>

              <div class="border-b pb-3">
                <h5 class="font-bold text-gray-800 mb-2 flex items-center">
                  <span
                    class="bg-purple-100 text-purple-700 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                  ค้นหารถว่าง
                </h5>
                <div class="ml-8 space-y-1">
                  <p class="text-sm text-gray-600">รูปแบบ: <code
                      class="bg-gray-100 px-2 py-1 rounded text-purple-600 font-mono">Q27/10-1/11</code></p>
                  <p class="text-xs text-gray-500">ค้นหารถว่างตั้งแต่ 27 ต.ค. - 1 พ.ย.</p>
                </div>
              </div>

              <div>
                <h5 class="font-bold text-gray-800 mb-2 flex items-center">
                  <span
                    class="bg-purple-100 text-purple-700 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                  ดูตารางรับส่งรถ
                </h5>
                <div class="ml-8 space-y-1">
                  <p class="text-sm text-gray-600">รูปแบบ: <code
                      class="bg-gray-100 px-2 py-1 rounded text-purple-600 font-mono">S27/10</code></p>
                  <p class="text-xs text-gray-500">ดูตารางรับ-คืนรถวันที่ 27 ต.ค.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-check-circle text-green-600 mt-1 mr-3"></i>
              <div class="text-left">
                <p class="font-medium text-green-800 mb-1">พร้อมใช้งานแล้ว!</p>
                <p class="text-sm text-green-700">
                  พนักงานสามารถเช็คคิวรถว่างและตารางรับส่งรถได้ผ่าน LINE ตลอด 24 ชั่วโมง
                </p>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex-shrink-0 rounded-b-2xl">
        <div class="flex justify-between items-center">
          <button x-show="linebotTutorialStep > 1" @click="linebotTutorialStep--"
            class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors flex items-center text-sm">
            <i class="fas fa-arrow-left mr-2"></i>
            ย้อนกลับ
          </button>

          <div x-show="linebotTutorialStep === 1" class="w-20"></div>

          <button x-show="linebotTutorialStep < totalLinebotTutorialSteps" @click="linebotTutorialStep++"
            class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center text-sm">
            ถัดไป
            <i class="fas fa-arrow-right ml-2"></i>
          </button>

          <button x-show="linebotTutorialStep === totalLinebotTutorialSteps" @click="completeLineBotTutorial()"
            class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg transition-colors flex items-center font-medium text-sm shadow-lg">
            <i class="fas fa-check mr-2"></i>
            เริ่มใช้งาน
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-show="isAllAnnouncementsModalOpen"
    class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50"
    @click.self="closeAllAnnouncementsModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] flex flex-col" @click.stop>
      <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-4 text-white rounded-t-lg">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold flex items-center"><i class="fas fa-bullhorn mr-2"></i>ประกาศทั้งหมด</h3>
          <button @click="closeAllAnnouncementsModal()" class="text-white hover:text-gray-200 transition-colors"><i
              class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="p-5 overflow-y-auto">
        <div x-show="announcements.length === 0" class="text-center text-gray-500 py-8">
          <i class="fas fa-inbox text-4xl mb-3"></i>
          <p>ยังไม่มีประกาศในขณะนี้</p>
        </div>
        <div x-show="announcements.length > 0" class="space-y-4">
          <template x-for="announcement in announcements" :key="announcement.id">
            <div @click="openModal(announcement)"
              class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow border-l-4"
              :class="{ 'border-teal-500': announcement.type === 'feature', 'border-blue-500': announcement.type === 'general' }">
              <h3 class="font-bold text-gray-800" x-text="announcement.title"></h3>
              <p class="text-xs text-gray-500 mt-1" x-show="announcement.endDate">
                แสดงถึง: <span x-text="formatDateForDisplay(announcement.endDate)"></span>
              </p>
            </div>
          </template>
        </div>
      </div>
      <div class="p-4 bg-gray-50 border-t text-right flex-shrink-0">
        <button @click="closeAllAnnouncementsModal()"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded text-white transition">ปิด</button>
      </div>
    </div>
  </div>

  <div x-show="isModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"
    @click.self="closeModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col" @click.stop>
      <div
        :class="selectedAnnouncement?.type === 'feature' ? 'bg-gradient-to-r from-teal-500 to-cyan-600' : 'bg-gradient-to-r from-blue-600 to-blue-500'"
        class="p-4 text-white rounded-t-lg">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold" x-text="selectedAnnouncement?.title"></h3>
          <button @click="closeModal()" class="text-white hover:text-gray-200 transition-colors"><i
              class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="p-5 overflow-y-auto prose" x-html="selectedAnnouncement?.detail"></div>
      <div class="p-4 bg-gray-50 border-t flex justify-end">
        <button @click="closeModal()"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded text-white transition text-sm">ปิด</button>
      </div>
    </div>
  </div>

  <div x-show="showReportProblemModal || isSystemLocked">
    <div x-show="isSystemLocked"
      class="fixed inset-0 bg-gray-900 bg-opacity-80 flex flex-col justify-center items-center z-[100] p-4">
      <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-lg w-full">
        <img src="https://img5.pic.in.th/file/secure-sv1/pngkit_website-under-construction-png_667719.png"
          alt="Under Construction" class="mx-auto mb-6 w-48">
        <h2 class="text-2xl font-bold text-red-600 mb-4">
          <i class="fas fa-exclamation-triangle animate-pulse mr-2"></i>ขณะนี้ระบบมีปัญหาร้ายแรง
        </h2>
        <p class="text-gray-700">แอดมินกำลังเร่งตรวจสอบและแก้ไขอยู่นะครับ ขออภัยในความไม่สะดวกครับ</p>
      </div>
    </div>
    <div x-show="showReportProblemModal && !isSystemLocked"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      @click.self="closeReportModal()">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md" @click.stop>
        <div class="p-4 border-b">
          <h3 class="text-lg font-medium flex items-center"><i class="fas fa-bug mr-2"></i>แจ้งปัญหาการใช้งาน</h3>
        </div>
        <div class="p-6">
          <div x-show="!reportStep">
            <p class="mb-4">กรุณาเลือกประเภทปัญหาที่พบ:</p>
            <div class="space-y-3">
              <button @click="reportProblemType = 'ทั่วไป'; reportStep = 'form'"
                class="w-full text-left p-4 border rounded-lg hover:bg-red-300 transition">
                <h4 class="font-semibold"><i class="fas fa-tools mr-2 text-gray-500"></i>ปัญหาทั่วไป</h4>
                <p class="text-sm text-gray-600">เช่น ข้อความผิด, ปุ่มไม่ทำงาน, แสดงผลเพี้ยน</p>
              </button>
              <button @click="reportProblemType = 'ร้ายแรง'; reportStep = 'form'"
                class="w-full text-left p-4 border rounded-lg hover:bg-red-500 transition">
                <h4 class="font-semibold"><i class="fas fa-bomb mr-2 text-red-500"></i>ปัญหาร้ายแรง</h4>
                <p class="text-sm text-gray-600">เช่น ไม่สามารถบันทึกข้อมูลได้, ระบบค้าง, เข้าใช้งานไม่ได้</p>
              </button>
            </div>
          </div>
          <div x-show="reportStep === 'form'">
            <h4 class="font-semibold mb-3">ประเภท: <span
                :class="reportProblemType === 'ร้ายแรง' ? 'text-red-600' : 'text-gray-800'"
                x-text="reportProblemType"></span></h4>
            <label class="block text-sm font-medium text-gray-700 mb-1">รายละเอียดปัญหา</label>
            <textarea x-model="reportDetails" rows="4"
              class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
              placeholder="กรุณาอธิบายปัญหาที่พบโดยละเอียด..."></textarea>
          </div>
        </div>
        <div class="p-4 bg-gray-50 flex justify-end space-x-2">
          <button @click="closeReportModal()"
            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ยกเลิก</button>
          <button x-show="reportStep === 'form'" @click="submitProblemReport()" :disabled="!reportDetails.trim()"
            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-red-300">ส่งเรื่อง</button>
        </div>
      </div>
    </div>
  </div>


  <!-- แถบเมนูด้านบน -->
  <nav class="bg-gradient-to-r from-blue-700 to-blue-500 shadow-md p-3 sticky top-0 z-40">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-sm font-bold text-white tracking-wider" x-text="config.ชื่อบริษัท || 'KPCRM V.3'"></h1>

      <div class="flex items-center space-x-1 md:space-x-2">

        <div class="relative">
          <button @click="showAllAnnouncements()"
            class="text-white h-10 px-3 rounded-full hover:bg-white/20 transition flex items-center space-x-2">
            <i class="fas fa-bullhorn"></i>
            <span class="hidden md:inline text-sm">ประกาศ</span>
          </button>
          <span x-show="hasNewAnnouncements"
            class="absolute top-0 right-0 w-3 h-3 bg-yellow-400 rounded-full animate-pulse border-2 border-blue-600"></span>
        </div>

        <!-- AI Chatbot Button + Modal - HIDDEN -->
        <template x-if="false">
          <div x-data="aiChatbot()" x-init="initChatbot()">
            <div class="relative">
              <button @click="toggleChat()"
                class="text-white h-10 px-3 rounded-full hover:bg-white/20 transition-all flex items-center space-x-2 bg-gradient-to-r from-green-500/20 to-emerald-600/20 chatbot-button-pulse">
                <i class="fas fa-robot"></i>
                <span class="hidden md:inline text-sm">ผู้ช่วย AI</span>
              </button>
              <span x-show="hasNotification"
                class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full animate-pulse border-2 border-blue-600"></span>
            </div>

            <!-- Modal (แสดงเต็มจอ) -->
            <!-- Backdrop/Overlay -->
            <div x-show="isChatOpen" x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
              x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
              x-transition:leave-end="opacity-0" @click="closeChat()" class="fixed inset-0 bg-black bg-opacity-50"
              style="z-index: 998;">
            </div>

            <!-- Modal Content -->
            <div x-show="isChatOpen" x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0 transform scale-90"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-200"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-90"
              class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden"
              style="width: min(500px, calc(100vw - 2rem)); height: min(700px, calc(100vh - 4rem)); z-index: 999;">

              <!-- Header -->
              <div
                class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div class="bg-white bg-opacity-20 rounded-full p-2">
                    <i class="fas fa-robot text-xl"></i>
                  </div>
                  <div>
                    <h3 class="font-bold text-lg">ผู้ช่วย AI</h3>
                    <p class="text-xs opacity-90">พร้อมช่วยเหลือคุณ</p>
                  </div>
                </div>
                <div>
                  <button @click="closeChat()"
                    class="hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors" title="ปิด">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
              </div>

              <!-- Messages Area -->
              <div x-ref="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-yellow-50"
                style="scroll-behavior: smooth;">

                <!-- Welcome Message (แสดงตอนเริ่มต้น) -->
                <template x-if="messages.length === 0">
                  <div>
                    <!-- Bot Avatar + Message -->
                    <div class="flex items-start space-x-2">
                      <div
                        class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                      </div>
                      <div class="flex-1">
                        <div class="bg-white rounded-2xl rounded-tl-none shadow-sm p-4 max-w-xs">
                          <p class="text-gray-800 text-sm mb-3">
                            👋 สวัสดีครับ!<br>
                            ผมคือผู้ช่วย AI ของระบบจัดการรถเช่า<br><br>
                            ผมช่วยอะไรคุณได้บ้าง?
                          </p>
                        </div>

                        <!-- Quick Reply Buttons -->
                        <div class="mt-3 space-y-2">
                          <button @click="startNewRental()"
                            class="w-full bg-white hover:bg-green-50 border-2 border-green-500 text-green-600 font-medium py-3 px-4 rounded-xl transition-all duration-200 hover:shadow-md flex items-center justify-center space-x-2">
                            <i class="fas fa-file-alt"></i>
                            <span>📝 สร้างรายการเช่าใหม่</span>
                          </button>

                          <button @click="showHelp()"
                            class="w-full bg-white hover:bg-blue-50 border-2 border-blue-500 text-blue-600 font-medium py-2 px-4 rounded-xl transition-all duration-200 hover:shadow-md flex items-center justify-center space-x-2">
                            <i class="fas fa-question-circle"></i>
                            <span>❓ วิธีใช้งาน</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- Chat Messages -->
                <template x-for="(msg, index) in messages" :key="index">
                  <div>
                    <!-- Bot Message -->
                    <template x-if="msg.sender === 'bot'">
                      <div class="flex items-start space-x-2 animate-slide-in-left">
                        <div
                          class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
                          <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="flex-1">
                          <!-- Text Message -->
                          <template x-if="msg.type === 'text'">
                            <div class="bg-white rounded-2xl rounded-tl-none shadow-sm p-3 max-w-xs">
                              <p class="text-gray-800 text-sm whitespace-pre-line" x-html="msg.content"></p>
                            </div>
                          </template>

                          <!-- Help Message -->
                          <template x-if="msg.type === 'help'">
                            <div class="bg-white rounded-xl shadow-sm p-4 max-w-sm border border-blue-200">
                              <p class="text-gray-800 text-sm whitespace-pre-line mb-4" x-html="msg.content"></p>
                              <button @click="goBackToMain()"
                                class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                <i class="fas fa-arrow-left"></i>
                                <span>กลับหน้าหลัก</span>
                              </button>
                            </div>
                          </template>

                          <!-- Confirmation Card -->
                          <template x-if="msg.type === 'confirmation'">
                            <div class="bg-white rounded-xl shadow-lg p-4 max-w-sm border border-green-200">
                              <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-gray-800 flex items-center">
                                  <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                  ข้อมูลที่ได้รับ:
                                </h4>
                                <button @click="goBackToMain()"
                                  class="text-gray-400 hover:text-gray-600 transition-colors" title="กลับหน้าหลัก">
                                  <i class="fas fa-home text-lg"></i>
                                </button>
                              </div>

                              <div class="space-y-2 text-sm">
                                <div class="flex items-start">
                                  <span class="text-gray-500 w-20">👤 ลูกค้า:</span>
                                  <span class="text-gray-800 font-medium"
                                    x-text="msg.data.ชื่อลูกค้า || msg.data.customerName || '-'"></span>
                                </div>
                                <div class="flex items-start">
                                  <span class="text-gray-500 w-20">📱 เบอร์:</span>
                                  <span class="text-gray-800 font-medium"
                                    x-text="msg.data.เบอร์โทร || msg.data.phone || '-'"></span>
                                </div>
                                <div class="flex items-start" x-show="msg.data.เลขบัตรประชาชน || msg.data.idCard">
                                  <span class="text-gray-500 w-20">🆔 บัตร:</span>
                                  <span class="text-gray-800 font-medium text-xs"
                                    x-text="msg.data.เลขบัตรประชาชน || msg.data.idCard"></span>
                                </div>
                                <div class="flex items-start">
                                  <span class="text-gray-500 w-20">🚗 รถ:</span>
                                  <span class="text-gray-800 font-bold"
                                    x-text="msg.data.รถ || msg.data.carName || '-'"></span>
                                </div>
                                <div class="flex items-start">
                                  <span class="text-gray-500 w-20">📅 รับ:</span>
                                  <span class="text-gray-800 font-medium"
                                    x-text="((msg.data.วันเช่า || msg.data.startDate || '-') + ' ' + (msg.data.เวลารับรถ || msg.data.startTime || '')).trim()"></span>
                                </div>
                                <div class="flex items-start">
                                  <span class="text-gray-500 w-20">📅 คืน:</span>
                                  <span class="text-gray-800 font-medium"
                                    x-text="((msg.data.วันคืน || msg.data.endDate || '-') + ' ' + (msg.data.เวลาคืนรถ || msg.data.endTime || '')).trim()"></span>
                                </div>
                                <div class="border-t pt-2 mt-2"></div>
                                <div class="flex items-start">
                                  <span class="text-gray-500 w-20">💰 ราคา/วัน:</span>
                                  <span class="text-gray-800 font-bold"
                                    x-text="((msg.data.ราคาต่อวัน || msg.data.dailyRate || 0)).toLocaleString() + ' ฿'"></span>
                                </div>
                                <div class="flex items-start">
                                  <span class="text-gray-500 w-20">💵 ค่าเช่ารวม:</span>
                                  <span class="text-green-600 font-bold text-lg"
                                    x-text="((msg.data.ค่าเช่ารวมทั้งหมด || msg.data.totalAmount || 0)).toLocaleString() + ' ฿'"></span>
                                </div>
                                <div class="flex items-start" x-show="msg.data.เงินมัดจำ || msg.data.deposit">
                                  <span class="text-gray-500 w-20">💵 มัดจำ:</span>
                                  <span class="text-gray-800 font-bold"
                                    x-text="((msg.data.เงินมัดจำ || msg.data.deposit || 0)).toLocaleString() + ' ฿'"></span>
                                </div>
                                <div class="flex items-start" x-show="msg.data.เงินประกัน || msg.data.insurance">
                                  <span class="text-gray-500 w-20">🛡️ ประกัน:</span>
                                  <span class="text-gray-800 font-bold"
                                    x-text="((msg.data.เงินประกัน || msg.data.insurance || 0)).toLocaleString() + ' ฿'"></span>
                                </div>
                                <div class="flex items-start" x-show="msg.data.ที่อยู่ || msg.data.address">
                                  <span class="text-gray-500 w-20">📍 ที่อยู่:</span>
                                  <span class="text-gray-600 text-xs"
                                    x-text="msg.data.ที่อยู่ || msg.data.address"></span>
                                </div>
                                <div class="flex items-start" x-show="msg.data.หมายเหตุ || msg.data.notes">
                                  <span class="text-gray-500 w-20">📝 หมายเหตุ:</span>
                                  <span class="text-gray-600 text-xs"
                                    x-text="msg.data.หมายเหตุ || msg.data.notes"></span>
                                </div>
                              </div>

                              <p class="text-sm text-gray-700 mt-4 mb-3 font-medium">✅ ข้อมูลถูกต้องไหม?</p>

                              <div class="flex space-x-2">
                                <button @click="confirmData()"
                                  class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-3 rounded-lg transition-colors flex items-center justify-center space-x-1">
                                  <i class="fas fa-check text-sm"></i>
                                  <span>ถูกต้อง</span>
                                </button>
                                <button @click="resetChat()"
                                  class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-medium py-2 px-3 rounded-lg transition-colors flex items-center justify-center space-x-1">
                                  <i class="fas fa-times text-sm"></i>
                                  <span>ยกเลิก</span>
                                </button>
                              </div>
                            </div>
                          </template>

                          <!-- Contract Selection Card -->
                          <template x-if="msg.type === 'contract'">
                            <div class="bg-white rounded-xl shadow-lg p-4 max-w-sm border border-blue-200">
                              <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-gray-800 flex items-center">
                                  <i class="fas fa-file-contract text-blue-500 mr-2"></i>
                                  ต้องการสัญญาเช่าหรือไม่?
                                </h4>
                                <button @click="goBackToMain()"
                                  class="text-gray-400 hover:text-gray-600 transition-colors" title="กลับหน้าหลัก">
                                  <i class="fas fa-home text-lg"></i>
                                </button>
                              </div>

                              <div class="space-y-2">
                                <button @click="selectContract('thai')"
                                  class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                  <span>🇹🇭</span>
                                  <span>สัญญาภาษาไทย</span>
                                </button>
                                <button @click="selectContract('english')"
                                  class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                  <span>🇬🇧</span>
                                  <span>สัญญาภาษาอังกฤษ</span>
                                </button>
                                <button @click="selectContract('none')"
                                  class="w-full bg-gray-400 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                  <i class="fas fa-times text-sm"></i>
                                  <span>ไม่ต้องสัญญา</span>
                                </button>
                              </div>
                            </div>
                          </template>

                          <!-- Action Buttons Card (ปุ่มคัดลอกและดูสัญญา) -->
                          <template x-if="msg.type === 'actions'">
                            <div class="bg-white rounded-xl shadow-lg p-4 max-w-sm border border-gray-200">
                              <div class="space-y-2">
                                <!-- ปุ่มคัดลอกข้อความสรุป -->
                                <template x-if="msg.data.summaryText">
                                  <button @click="copySummary(msg.data.summaryText, msg.data.bookingNumber)"
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                    <i class="fas fa-copy"></i>
                                    <span>คัดลอกข้อความสรุป</span>
                                  </button>
                                </template>

                                <!-- ปุ่มดูสัญญาเช่า -->
                                <template x-if="msg.data.contractUrl">
                                  <a :href="msg.data.contractUrl" target="_blank"
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2 block">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>ดูสัญญาเช่า</span>
                                  </a>
                                </template>

                                <!-- ปุ่มสร้างใหม่ -->
                                <button @click="resetChat()"
                                  class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                  <i class="fas fa-plus"></i>
                                  <span>สร้างรายการใหม่</span>
                                </button>
                              </div>
                            </div>
                          </template>

                          <!-- Success Card (Legacy - ไม่ใช้แล้ว) -->
                          <template x-if="msg.type === 'success'">
                            <div
                              class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-lg p-4 max-w-sm border-2 border-green-300">
                              <div class="text-center">
                                <div class="text-4xl mb-2">✅</div>
                                <h4 class="font-bold text-green-800 text-lg mb-2">สร้างสำเร็จ!</h4>
                                <p class="text-sm text-gray-600 mb-3">รหัสการจอง</p>
                                <p class="text-xl font-bold text-green-600 mb-4" x-text="msg.data.rentalId"></p>

                                <button @click="resetChat()"
                                  class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                  สร้างใหม่อีก
                                </button>
                              </div>
                            </div>
                          </template>

                          <!-- Timestamp -->
                          <p class="text-xs text-gray-400 mt-1 ml-1" x-text="formatTime(msg.timestamp)"></p>
                        </div>
                      </div>
                    </template>

                    <!-- User Message -->
                    <template x-if="msg.sender === 'user'">
                      <div class="flex items-start justify-end space-x-2 animate-slide-in-right">
                        <div class="flex-1 flex flex-col items-end">
                          <div
                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl rounded-tr-none shadow-sm p-3 max-w-xs">
                            <p class="text-sm whitespace-pre-line" x-text="msg.content"></p>
                          </div>
                          <p class="text-xs text-gray-400 mt-1 mr-1" x-text="formatTime(msg.timestamp)"></p>
                        </div>
                        <div
                          class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                          <i class="fas fa-user text-white text-sm"></i>
                        </div>
                      </div>
                    </template>

                    <!-- Typing Indicator -->
                    <template x-if="msg.type === 'typing'">
                      <div class="flex items-start space-x-2">
                        <div
                          class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center">
                          <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-none shadow-sm p-4 max-w-xs">
                          <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms;">
                            </div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                              style="animation-delay: 150ms;">
                            </div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                              style="animation-delay: 300ms;">
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>

                    <!-- Loading Progress -->
                    <template x-if="msg.type === 'loading'">
                      <div class="flex items-start space-x-2">
                        <div
                          class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
                          <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-none shadow-lg p-4 max-w-sm">
                          <p class="text-sm font-medium text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-spinner fa-spin mr-2 text-green-500"></i>
                            <span x-text="msg.content"></span>
                          </p>
                          <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div
                              class="bg-gradient-to-r from-green-500 to-emerald-600 h-2 rounded-full transition-all duration-500"
                              :style="`width: ${msg.progress || 0}%`"></div>
                          </div>
                          <p class="text-xs text-gray-500 mt-2 text-right" x-text="`${msg.progress || 0}%`"></p>
                        </div>
                      </div>
                    </template>

                  </div>
                </template>

              </div>

              <!-- Input Area -->
              <div class="border-t bg-white p-3">
                <template x-if="currentStep === 'waiting_input'">
                  <div class="flex space-x-2">
                    <button @click="pasteFromClipboard()"
                      class="flex-shrink-0 bg-gray-100 hover:bg-gray-200 text-gray-600 p-3 rounded-lg transition-colors"
                      title="วางจาก Clipboard">
                      <i class="fas fa-paste"></i>
                    </button>
                    <textarea x-ref="messageInput" x-model="userInput"
                      @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
                      placeholder="วางรายละเอียดการเช่าที่นี่..." rows="2"
                      class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"></textarea>
                    <button @click="sendMessage()" :disabled="!userInput.trim()"
                      :class="userInput.trim() ? 'bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700' : 'bg-gray-300 cursor-not-allowed'"
                      class="flex-shrink-0 text-white p-3 rounded-lg transition-colors">
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </div>
                </template>

                <template x-if="currentStep !== 'waiting_input'">
                  <p class="text-center text-sm text-gray-500 py-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    กรุณาเลือกจากตัวเลือกด้านบน
                  </p>
                </template>
              </div>

            </div>
          </div>
        </template>

        <button @click="showReportProblemModal = true"
          class="text-white h-10 px-3 rounded-full hover:bg-white/20 transition flex items-center space-x-2">
          <i class="fas fa-bug"></i>
          <span class="hidden md:inline text-sm">แจ้งปัญหา</span>
        </button>

        <div class="h-6 w-px bg-white/30 mx-2"></div>

        <div x-data="{ open: false }" class="relative">
          <button @click="open = !open"
            class="flex items-center space-x-2 text-white p-2 rounded-full hover:bg-white/20">
            <i class="fas fa-user-circle text-2xl"></i>
            <div class="hidden lg:flex flex-col items-start leading-tight">
              <span class="text-sm font-semibold" x-text="displayName || 'User'"></span>
            </div>
            <i :class="{'rotate-180': open}"
              class="fas fa-chevron-down text-xs transition-transform hidden lg:inline"></i>
          </button>

          <div x-show="open" @click.away="open = false" x-transition
            class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 origin-top-right">
            <div class="px-4 py-2 text-sm text-gray-500 border-b">
              <p>ผู้ใช้: <strong class="text-gray-800" x-text="displayName || 'User'"></strong></p>
            </div>
            <a href="#" @click.prevent="logout()"
              class="flex items-center w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
              <i class="fas fa-sign-out-alt w-5 mr-1"></i>
              ออกจากระบบ
            </a>
          </div>
        </div>

      </div>
    </div>
  </nav>


  <!-- โครงสร้างหน้าเว็บ -->
  <div x-show="isLoggedIn" class="flex min-h-screen">


    <div class="bg-white shadow-lg w-64 hidden md:block border-r border-gray-100">
      <div class="h-full">
        <div class="py-6 px-4">
          <ul class="space-y-2">
            <li x-show="hasPermission('page-summary')">
              <a @click.prevent="setActivePage('summary')"
                :class="currentPage === 'summary' ? 'bg-[#57daf7] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#57daf7] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-chart-pie w-5 h-5 mr-3" style="color: #57daf7;"></i>
                <span>สรุปข้อมูลประจำวัน</span>
              </a>
            </li>

            <li x-show="hasPermission('page-bookings')">
              <a @click.prevent="setActivePage('bookings')"
                :class="currentPage === 'bookings' ? 'bg-[#A1B4FF] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#A1B4FF] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-search w-5 h-5 mr-3" style="color: #A1B4FF;"></i>
                <span>เช็คคิวรถ</span>
              </a>
            </li>

            <li x-show="hasPermission('page-schedule')">
              <a @click.prevent="setActivePage('schedule')"
                :class="currentPage === 'schedule' ? 'bg-[#B0F0A5] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#B0F0A5] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-calendar-alt w-5 h-5 mr-3" style="color: #B0F0A5;"></i>
                <span>ตารางรับส่งรถ</span>
              </a>
            </li>


            <li x-show="hasPermission('page-customers')">
              <a @click.prevent="setActivePage('customers')"
                :class="currentPage === 'customers' ? 'bg-[#ffc107] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#ffc107] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-users w-5 h-5 mr-3" style="color: #ffc107;"></i>
                <span>จัดการลูกค้า</span>
              </a>
            </li>


            <li x-show="hasPermission('page-newRental')">
              <a @click.prevent="setActivePage('newRental')"
                :class="currentPage === 'newRental' ? 'bg-[#FB9F9E] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#FB9F9E] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-plus-circle w-5 h-5 mr-3" style="color: #FB9F9E;"></i>
                <span>จัดการการจอง</span>
              </a>
            </li>


            <li x-show="hasPermission('page-finance')">
              <a @click.prevent="setActivePage('finance')"
                :class="currentPage === 'finance' ? 'bg-[#D2B4DE] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#D2B4DE] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-wallet w-5 h-5 mr-3" style="color: #D2B4DE;"></i>
                <span>รายรับ-รายจ่าย</span>
              </a>
            </li>

            <li x-show="hasPermission('page-documents')">
              <a @click.prevent="setActivePage('documents')"
                :class="currentPage === 'documents' ? 'bg-teal-100 text-teal-800 font-semibold' : 'text-gray-700 hover:bg-teal-100 hover:text-teal-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-file-alt w-5 h-5 mr-3 text-teal-500"></i>
                <span>จัดการเอกสาร</span>
              </a>
            </li>

            <li x-show="hasPermission('page-cars')">
              <a @click.prevent="setActivePage('cars')"
                :class="currentPage === 'cars' ? 'bg-[#FFD09E] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#FFD09E] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-car w-5 h-5 mr-3" style="color: #FFD09E;"></i>
                <span>จัดการรถ</span>
              </a>
            </li>



            <!-- <li x-show="hasPermission('page-onlinebooking')">
  <a @click.prevent="setActivePage('onlinebooking')"
     :class="currentPage === 'onlinebooking' ? 'bg-[#4F46E5] text-white font-semibold' : 'text-gray-700 hover:bg-[#4F46E5] hover:text-white'"
     class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
    <i class="fas fa-globe w-5 h-5 mr-3" style="color: #4F46E5;"></i>
    <span>จัดการการจองออนไลน์</span>
  </a>
</li> -->



            <!-- <li x-show="hasPermission('page-manual')">
          <a @click.prevent="setActivePage('manual')"
             :class="currentPage === 'manual' ? 'bg-[#F9F871] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#F9F871] hover:text-gray-800'"
             class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
            <i class="fas fa-book mr-3" style="color: #F9F871;"></i>
            <span>คู่มือการใช้งาน</span>
          </a>
        </li> -->



            <li x-show="hasPermission('page-config')">
              <a @click.prevent="setActivePage('config')"
                :class="currentPage === 'config' ? 'bg-[#B4C1C7] text-gray-800 font-semibold' : 'text-gray-700 hover:bg-[#B4C1C7] hover:text-gray-800'"
                class="flex items-center p-3 text-sm rounded-xl transition duration-200 cursor-pointer">
                <i class="fas fa-cog w-5 h-5 mr-3" style="color: #B4C1C7;"></i>
                <span>ตั้งค่าระบบ</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>



    <div x-show="isLoggedIn" class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg z-10">
      <div class="grid" :class="getGridColumns()">
        <button x-show="hasPermission('page-summary')" @click="setActivePage('summary')"
          :class="{'text-[#57daf7] font-medium': currentPage === 'summary', 'text-gray-700': currentPage !== 'summary'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#57daf7]': currentPage === 'summary'}" class="fas fa-chart-pie"></i>
          <span class="text-xs mt-1">สรุป</span>
        </button>

        <button x-show="hasPermission('page-bookings')" @click="setActivePage('bookings')"
          :class="{'text-[#A1B4FF] font-medium': currentPage === 'bookings', 'text-gray-700': currentPage !== 'bookings'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#A1B4FF]': currentPage === 'bookings'}" class="fas fa-search"></i>
          <span class="text-xs mt-1">เช็คคิว</span>
        </button>

        <button x-show="hasPermission('page-schedule')" @click="setActivePage('schedule')"
          :class="{'text-[#B0F0A5] font-medium': currentPage === 'schedule', 'text-gray-700': currentPage !== 'schedule'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#B0F0A5]': currentPage === 'schedule'}" class="fas fa-calendar-alt"></i>
          <span class="text-xs mt-1">ตาราง</span>
        </button>

        <button x-show="hasPermission('page-customers')" @click="setActivePage('customers')"
          :class="{'text-[#ffc107] font-medium': currentPage === 'customers', 'text-gray-700': currentPage !== 'customers'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#ffc107]': currentPage === 'customers'}" class="fas fa-users"></i>
          <span class="text-xs mt-1">ลูกค้า</span>
        </button>

        <button x-show="hasPermission('page-newRental')" @click="setActivePage('newRental')"
          :class="{'text-[#FB9F9E] font-medium': currentPage === 'newRental', 'text-gray-700': currentPage !== 'newRental'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#FB9F9E]': currentPage === 'newRental'}" class="fas fa-plus-circle"></i>
          <span class="text-xs mt-1">การจอง</span>
        </button>


        <button x-show="hasPermission('page-finance')" @click="setActivePage('finance')"
          :class="{'text-[#D2B4DE] font-medium': currentPage === 'finance', 'text-gray-700': currentPage !== 'finance'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#D2B4DE]': currentPage === 'finance'}" class="fas fa-wallet"></i>
          <span class="text-xs mt-1">รับ-จ่าย</span>
        </button>


        <button x-show="hasPermission('page-documents')" @click="setActivePage('documents')"
          :class="{'text-teal-500 font-medium': currentPage === 'documents', 'text-gray-700': currentPage !== 'documents'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-teal-500': currentPage === 'documents'}" class="fas fa-file-alt"></i>
          <span class="text-xs mt-1">เอกสาร</span>
        </button>


        <button x-show="hasPermission('page-cars')" @click="setActivePage('cars')"
          :class="{'text-[#FFD09E] font-medium': currentPage === 'cars', 'text-gray-700': currentPage !== 'cars'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#FFD09E]': currentPage === 'cars'}" class="fas fa-car"></i>
          <span class="text-xs mt-1">รถ</span>
        </button>



        <!-- <button x-show="hasPermission('page-onlinebooking')" @click="setActivePage('onlinebooking')"
        :class="{'text-[#4F46E5] font-medium': currentPage === 'onlinebooking', 'text-gray-700': currentPage !== 'onlinebooking'}"
        class="p-2 text-center flex flex-col items-center">
  <i :class="{'text-[#4F46E5]': currentPage === 'onlinebooking'}" class="fas fa-globe"></i>
  <span class="text-xs mt-1">จองออนไลน์</span>
</button> -->

        <!-- <button x-show="hasPermission('page-manual')" @click="setActivePage('manual')"
 
                :class="currentPage === 'manual' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
                class="px-4 py-2 rounded-lg transition-colors flex items-center">
          <i class="fas fa-book mr-2"></i>
          คู่มือ
        </button> -->

        <button x-show="hasPermission('page-config')" @click="setActivePage('config')"
          :class="{'text-[#B4C1C7] font-medium': currentPage === 'config', 'text-gray-700': currentPage !== 'config'}"
          class="p-2 text-center flex flex-col items-center">
          <i :class="{'text-[#B4C1C7]': currentPage === 'config'}" class="fas fa-cog"></i>
          <span class="text-xs mt-1">ตั้งค่า</span>
        </button>
      </div>
    </div>




    <!-- เนื้อหาหลัก -->

    <div x-show="isLoggedIn" class="flex-1 p-2 md:p-6 pb-20 md:pb-6 overflow-x-hidden">

      <!-- แสดงคำเตือน License ใกล้หมดอายุ -->
      <template x-if="!licenseExpired && licenseDaysRemaining <= 10">
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
              </div>
              <div class="ml-3">
                <p class="text-yellow-700">
                  License ของท่านกำลังจะหมดอายุในวันที่ <span class="font-semibold" x-text="licenseExpireDate"></span>
                  (อีก <span class="font-semibold" x-text="licenseDaysRemaining"></span> วัน)
                </p>
              </div>
            </div>
            <div>
              <button @click="openLicenseRenewalModal()"
                class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition duration-200 flex items-center">
                <i class="fas fa-sync-alt mr-2"></i> ต่ออายุเลย
              </button>
            </div>
          </div>
        </div>
      </template>


      <!-- Template แสดงการเชิญชวนให้สมัครใช้งาน -->
      <template x-if="!isRegistered && !dismissedPromotion">
        <div
          class="bg-white border-2 border-yellow-300 rounded-lg p-4 mb-6 shadow-md transition-all duration-300 hover:shadow-lg">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <!-- Left side with content -->
            <div class="flex items-center space-x-4">
              <!-- Icon container with solid color on mobile, gradient on desktop -->
              <div class="flex-shrink-0 bg-blue-600 md:bg-blue-600 p-3 rounded-full">
                <i class="fas fa-car text-white text-xl"></i>
              </div>

              <!-- Text content - simplified on mobile -->
              <div>
                <div class="flex items-center space-x-2">
                  <p class="text-gray-800 font-bold text-base md:text-lg">
                    ระบบจัดการเช่ารถ
                    <span class="hidden md:inline">ออนไลน์</span>
                  </p>
                  <span class="bg-yellow-300 text-xs font-bold px-2 py-1 rounded-full text-blue-800">
                    ส่วนลด 33%
                  </span>
                </div>
                <p class="text-blue-700 font-semibold mt-1">
                  ราคาพิเศษ <span class="text-lg">199</span> บาท
                  <span class="hidden md:inline">สำหรับผู้ใช้ใหม่</span>
                </p>
                <p class="text-gray-600 text-xs md:text-sm mt-1 md:block">
                  <span class="inline md:hidden">จัดการการจอง จัดทำสัญญา</span>
                  <span class="hidden md:inline">จัดการการจอง ดูรายงานรายได้ และออกเอกสารสัญญาเช่าได้ครบวงจร</span>
                </p>
              </div>
            </div>

            <!-- Right side with buttons -->
            <div class="flex justify-end mt-3 md:mt-0 md:flex-col md:space-y-2">
              <button @click="openRegisterServiceModal()"
                class="px-3 py-1 md:px-4 md:py-2 bg-green-600 text-white font-bold text-sm md:text-base rounded-md hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                <i class="fas fa-user-plus mr-2"></i> สมัครใช้งาน
              </button>
              <button @click="dismissPromotion()"
                class="ml-2 md:ml-0 text-gray-500 hover:text-gray-700 text-xs md:text-sm text-center"
                title="ไม่แสดงอีก">
                ไม่สนใจ
              </button>
            </div>
          </div>
        </div>
      </template>




      <!-- หน้าสรุปรายการเช่า (Summary) - แบบปรับปรุงแล้ว -->
      <div x-show="currentPage === 'summary'" x-cloak class="-mt-6">
        <div class="mb-6">
          <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4" style="border-color: #57daf7;">
            <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5"
              style="background-color: #57daf7;">
              <i class="fas fa-chart-line text-white text-2xl"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">แดชบอร์ดสรุปข้อมูล</h2>
              <p class="mt-1 text-gray-600">
                <i class="fas fa-plus-circle mr-2" style="color: #57daf7;"></i>สรุปรายละเอียดสำคัญประจำวัน
              </p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

          <div class="lg:col-span-2 space-y-6">



            <!-- การ์ดรอหารถที่แก้ไข Event Handling แล้ว -->
            <div x-show="pendingVehicleStats && pendingVehicleStats.total > 0"
              x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0 transform scale-95"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-200"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-95"
              class="bg-gradient-to-r from-orange-100 to-yellow-100 p-4 rounded-lg shadow border-l-4 border-orange-500 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1"
              @click.prevent.stop="loadPendingVehicleBookings()">
              <!-- ↑ เพิ่ม .prevent.stop เพื่อป้องกัน default behavior และ event bubbling -->

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="bg-orange-500 text-white p-3 rounded-full shadow-lg">
                    <i class="fas fa-search text-xl"></i>
                  </div>
                  <div>
                    <p class="text-sm text-orange-700 font-medium">รอหารถ</p>
                    <p class="text-2xl font-bold text-orange-900" x-text="pendingVehicleStats.total || 0"></p>
                    <p class="text-xs text-orange-600">รายการที่ยังไม่ระบุรถ</p>
                  </div>
                </div>
                <div class="text-orange-500">
                  <i class="fas fa-chevron-right text-lg"></i>
                </div>
              </div>

              <!-- สถิติเพิ่มเติม -->
              <div class="mt-3 pt-3 border-t border-orange-200 transition-all duration-300">
                <div class="grid grid-cols-2 gap-2 text-xs text-orange-700">
                  <!-- แสดงรายการวันนี้ -->
                  <div x-show="pendingVehicleStats.todayPickup > 0" class="flex items-center animate-pulse">
                    <i class="fas fa-exclamation-triangle mr-1 text-red-500"></i>
                    <span class="font-semibold">วันนี้: <span x-text="pendingVehicleStats.todayPickup"></span>
                      รายการ</span>
                  </div>

                  <!-- แสดงรายการพรุ่งนี้ -->
                  <div x-show="pendingVehicleStats.tomorrowPickup > 0" class="flex items-center">
                    <i class="fas fa-clock mr-1 text-yellow-500"></i>
                    <span>พรุ่งนี้: <span x-text="pendingVehicleStats.tomorrowPickup"></span> รายการ</span>
                  </div>

                  <!-- แสดงรายการเร่งด่วน -->
                  <div x-show="pendingVehicleStats.urgent > 0" class="flex items-center col-span-2">
                    <i class="fas fa-fire mr-1 text-red-500"></i>
                    <span class="font-medium">เร่งด่วน (ภายใน 2 วัน): <span x-text="pendingVehicleStats.urgent"></span>
                      รายการ</span>
                  </div>

                  <!-- แสดงข้อความเมื่อไม่มีรายการเร่งด่วน -->
                  <div x-show="pendingVehicleStats.total > 0 && pendingVehicleStats.urgent === 0"
                    class="flex items-center text-xs text-green-600 col-span-2">
                    <i class="fas fa-check-circle mr-1"></i>
                    <span>ไม่มีรายการเร่งด่วน</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div
                class="bg-white p-4 rounded-lg shadow flex items-center gap-4 cursor-pointer hover:bg-gray-50 transition-colors"
                @click="showTodayRentalsModal = true">
                <div class="bg-green-100 text-green-600 p-3 rounded-full"><i class="fas fa-clock text-xl"></i></div>
                <div>
                  <p class="text-sm text-gray-500">รายการเช่าวันนี้</p>
                  <p class="text-lg font-bold" x-text="rentalStats.inProgress || 0"></p>
                </div>
                <div class="flex-shrink-0 flex items-center gap-1 ml-auto">
                  <button @click.stop="shareTodayRentalsSummary()"
                    class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50" title="แชร์ข้อมูล"><i
                      class="fas fa-share-alt"></i></button>
                  <button @click.stop="copyTodayRentalsSummary()"
                    class="text-emerald-500 hover:text-emerald-700 p-2 rounded-full hover:bg-emerald-50"
                    title="คัดลอกข้อมูล"><i class="fas fa-copy"></i></button>
                </div>
              </div>

              <div
                class="bg-white p-4 rounded-lg shadow flex items-center gap-4 cursor-pointer hover:bg-gray-50 transition-colors"
                @click="showAvailableCarsModal = true">
                <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full"><i class="fas fa-car-side text-xl"></i>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-500 mb-1">จำนวนรถว่างวันนี้</p>
                  <div class="flex gap-3 items-center">
                    <div class="flex items-center gap-1"><span
                        class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">ว่าง</span><span
                        class="text-base font-semibold text-gray-800" x-text="rentalStats.availableCars || 0"></span>
                    </div>
                    <div class="flex items-center gap-1"><span
                        class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700">ทั้งหมด</span><span
                        class="text-base font-semibold text-gray-800" x-text="rentalStats.totalCars || 0"></span></div>
                  </div>
                </div>
                <div class="flex-shrink-0 flex items-center gap-1">
                  <button @click.stop="shareAvailableCarsSummary()"
                    class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50" title="แชร์ข้อมูล"><i
                      class="fas fa-share-alt"></i></button>
                  <button @click.stop="copyAvailableCarsSummary()"
                    class="text-emerald-500 hover:text-emerald-700 p-2 rounded-full hover:bg-emerald-50"
                    title="คัดลอกข้อมูล"><i class="fas fa-copy"></i></button>
                </div>
              </div>

              <div
                class="bg-white p-4 rounded-lg shadow flex items-center gap-4 cursor-pointer hover:bg-gray-50 transition-colors"
                @click="showTodayScheduleModal = true">
                <div class="bg-amber-100 text-amber-600 p-3 rounded-full"><i class="fas fa-exchange-alt text-xl"></i>
                </div>
                <div class="flex-grow">
                  <p class="text-sm text-gray-500 mb-1">รับรถ-คืนรถวันนี้</p>
                  <div class="flex gap-3"><span class="text-indigo-600 text-sm">รับรถ: <strong
                        x-text="rentalStats.todayPickups || 0"></strong></span><span
                      class="text-rose-600 text-sm">คืนรถ: <strong
                        x-text="rentalStats.todayReturns || 0"></strong></span></div>
                </div>
                <div class="flex-shrink-0 flex items-center gap-1">
                  <button @click.stop="shareTodayScheduleSummary()"
                    class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50" title="แชร์ข้อมูล"><i
                      class="fas fa-share-alt"></i></button>
                  <button @click.stop="copyTodayScheduleSummary()"
                    class="text-emerald-500 hover:text-emerald-700 p-2 rounded-full hover:bg-emerald-50"
                    title="คัดลอกข้อมูล"><i class="fas fa-copy"></i></button>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg shadow flex items-center gap-4">
                <div class="bg-rose-100 text-rose-600 p-3 rounded-full"><i class="fas fa-bell text-xl"></i></div>
                <div>
                  <p class="text-sm text-gray-500">การแจ้งเตือนบำรุงรักษา</p>
                  <p class="text-lg font-bold" x-text="upcomingMaintenance.length"></p>
                  <p class="text-xs text-gray-500">รายการที่ใกล้ถึงกำหนด</p>
                </div>
              </div>



            </div>

            <!-- ใส่ส่วนนี้ในกลุ่มการ์ดของหน้า Dashboard -->





            <!-- Modal รายการรอหารถ (แก้ไขปุ่มระบุรถ) -->
            <div x-show="showPendingVehicleModal" x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
              x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
              x-transition:leave-end="opacity-0"
              class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
              @click.self="closePendingVehicleModal()">

              <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto mx-4"
                @click.stop>

                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                  <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-search text-orange-500 mr-2"></i>
                    รายการรอหารถ
                    <span class="ml-2 bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-sm font-medium"
                      x-text="pendingVehicleBookings.length"></span>
                  </h3>
                  <button @click="closePendingVehicleModal()"
                    class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>

                <!-- Loading State -->
                <div x-show="isLoading" class="text-center py-8">
                  <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mr-2"></div>
                  <span class="text-gray-600">กำลังโหลด...</span>
                </div>

                <!-- Empty State -->
                <div x-show="!isLoading && pendingVehicleBookings.length === 0" class="text-center py-12">
                  <div class="text-6xl text-gray-300 mb-4">🎉</div>
                  <h4 class="text-lg font-medium text-gray-600 mb-2">ไม่มีรายการรอหารถ</h4>
                  <p class="text-gray-500">รายการจองทั้งหมดได้ระบุรถเรียบร้อยแล้ว</p>
                </div>

                <!-- รายการข้อมูล -->
                <div x-show="!isLoading && pendingVehicleBookings.length > 0" class="space-y-4">

                  <template x-for="booking in pendingVehicleBookings" :key="booking.หมายเลขการจอง">
                    <div
                      class="bg-gradient-to-r from-orange-50 to-yellow-50 border-l-4 border-orange-400 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">

                      <!-- Header ของแต่ละรายการ -->
                      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3">
                        <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                          <span class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-medium"
                            x-text="booking.หมายเลขการจอง"></span>

                          <!-- Badge แสดงความเร่งด่วน -->
                          <template x-if="booking.จำนวนวันที่เหลือ <= 1">
                            <span
                              class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium flex items-center">
                              <i class="fas fa-fire mr-1"></i>เร่งด่วน!
                            </span>
                          </template>
                          <template x-if="booking.จำนวนวันที่เหลือ === 2">
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">
                              <i class="fas fa-clock mr-1"></i>พรุ่งนี้
                            </span>
                          </template>
                        </div>

                        <!-- ✅ ปุ่มระบุรถ (แก้ไขแล้ว) -->
                        <button @click="openAssignVehicleModal(booking)"
                          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center text-sm font-medium">
                          <i class="fas fa-car mr-2"></i>ระบุรถ
                        </button>
                      </div>

                      <!-- รายละเอียดการจอง -->
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- คอลัมน์ซ้าย -->
                        <div class="space-y-2">
                          <div class="flex items-center text-sm">
                            <i class="fas fa-user w-4 text-gray-500 mr-2"></i>
                            <span class="font-medium" x-text="booking.ชื่อลูกค้า"></span>
                          </div>
                          <div class="flex items-center text-sm">
                            <i class="fas fa-phone w-4 text-gray-500 mr-2"></i>
                            <span x-text="booking.เบอร์โทรศัพท์"></span>
                          </div>
                          <div class="flex items-center text-sm">
                            <i class="fas fa-car w-4 text-gray-500 mr-2"></i>
                            <span x-text="booking.รถ"></span>
                          </div>
                        </div>

                        <!-- คอลัมน์ขวา -->
                        <div class="space-y-2">
                          <div class="flex items-center text-sm">
                            <i class="fas fa-calendar w-4 text-gray-500 mr-2"></i>
                            <span
                              x-text="`${formatThaiDate(booking.วันที่เช่า)} - ${formatThaiDate(booking.วันที่คืน)}`"></span>
                          </div>
                          <div class="flex items-center text-sm">
                            <i class="fas fa-clock w-4 text-gray-500 mr-2"></i>
                            <span x-text="`${booking.เวลารับรถ} - ${booking.เวลาคืนรถ}`"></span>
                          </div>
                          <div class="flex items-center text-sm">
                            <i class="fas fa-money-bill-wave w-4 text-gray-500 mr-2"></i>
                            <span class="font-medium text-green-600"
                              x-text="`${(booking.ค่าเช่ารวมทั้งหมด || 0).toLocaleString()} บาท`"></span>
                          </div>
                        </div>
                      </div>

                      <!-- สถานที่ -->
                      <div class="mt-3 pt-3 border-t border-orange-200">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-600">
                          <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-green-500 mr-1"></i>
                            รับ: <span x-text="booking.สถานที่รับรถ"></span>
                          </div>
                          <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                            คืน: <span x-text="booking.สถานที่คืนรถ"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>


            <!-- Modal สำหรับระบุรถ (แบบ Multi-Step) -->
            <div x-show="showAssignVehicleModal" x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
              x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
              x-transition:leave-end="opacity-0"
              class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center p-4 z-50"
              @click.self="closeAssignVehicleModal()" x-cloak>

              <!-- Modal Container with fixed height -->
              <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">

                <!-- Header - Fixed -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 rounded-t-xl flex-shrink-0">
                  <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                      <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-car text-xl"></i>
                      </div>
                      <div class="min-w-0">
                        <h3 class="text-lg font-bold">อัพเดทรายละเอียดการเช่า</h3>

                        <p class="inline-block bg-green-600 text-white font-semibold text-base px-3 py-1 rounded-full shadow-md ring-1 ring-green-700 uppercase tracking-wide transform transition duration-200 hover:scale-105 hover:shadow-lg"
                          x-text="`หมายเลขจอง: ${currentAssignBooking?.หมายเลขการจอง || 'N/A'}`"></p>



                      </div>
                    </div>
                    <button @click="closeAssignVehicleModal()"
                      class="text-white/80 hover:text-white transition-colors p-2 rounded-full flex-shrink-0">
                      <i class="fas fa-times text-xl"></i>
                    </button>
                  </div>

                  <!-- Progress Bar -->
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium">ขั้นตอนที่ <span x-text="assignmentStep"></span> จาก 3</span>
                      <span class="text-sm" x-text="`${Math.round((assignmentStep/3)*100)}%`"></span>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-2">
                      <div class="bg-white rounded-full h-2 transition-all duration-300"
                        :style="`width: ${(assignmentStep/3)*100}%`"></div>
                    </div>
                  </div>
                </div>

                <!-- Content - Scrollable -->
                <div class="flex-1 overflow-y-auto p-4 sm:p-6">

                  <!-- Step 1: Car Information -->
                  <div x-show="assignmentStep === 1" x-transition class="space-y-6">

                    <div class="text-center mb-6">
                      <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-car text-2xl text-blue-600"></i>
                      </div>
                      <h4 class="text-lg font-semibold text-gray-800">ระบุข้อมูลรถ</h4>
                      <p class="text-gray-600 text-sm">กรุณากรอกข้อมูลรถที่จะให้เช่าแทนรายการนี้</p>
                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-car mr-2 text-blue-500"></i>ชื่อรถเต็ม (ยี่ห้อ/รุ่น/สี/ปี)
                          <span class="text-red-500">*</span>
                        </label>
                        <input type="text" x-model="partnerCarData.fullCarName"
                          placeholder="เช่น Toyota Vios สีขาว 2023"
                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                        <p class="text-xs text-gray-500 mt-1">รถเดิมที่เสนอลูกค้า: <span
                            x-text="currentAssignBooking?.รถ || 'ไม่ระบุ'" class="font-medium"></span></p>
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-hashtag mr-2 text-green-500"></i>ทะเบียนรถ
                          <span class="text-red-500">*</span>
                        </label>
                        <input type="text" x-model="partnerCarData.licensePlate" placeholder="เช่น กข 1234 กรุงเทพฯ"
                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>รายได้สุทธิ (หลังหักค่าคอมมิชชั่น)
                          <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                          <input type="number" x-model="partnerCarData.actualRevenue" placeholder="0" min="0"
                            class="w-full px-4 py-3 pr-12 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                          <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500">บาท</span>
                        </div>
                        <!-- <div class="mt-2 p-3 bg-gray-100 rounded-lg">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">ราคาเช่าต้นฉบับ:</span>
                                <span class="font-medium" x-text="`${(currentAssignBooking?.ค่าเช่ารวมทั้งหมด || 0).toLocaleString()} บาท`"></span>
                            </div>
                            <p class="text-xs text-blue-600 mt-1">💡 กรอกจำนวนเงินที่ได้รับจริงหลังหักค่าคอมมิชชั่นแล้ว</p>
                        </div> -->
                      </div>
                    </div>
                  </div>


                  <!-- Step 2: Delivery & Return Methods -->
                  <div x-show="assignmentStep === 2" x-transition class="space-y-6">
                    <div class="flex items-center justify-center mb-6 space-x-4">
                      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-truck text-2xl text-green-600"></i>
                      </div>
                      <div class="text-left">
                        <h4 class="text-lg font-semibold text-gray-800">การส่งและรับคืนรถ</h4>
                        <p class="text-gray-600 text-sm">เลือกวิธีการส่งรถให้ลูกค้าและรับคืนรถ</p>
                      </div>
                    </div>

                    <!-- ส่วนเลือกวิธีการส่ง-รับรถ - แบบกระชับ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <!-- การส่งรถให้ลูกค้า -->
                      <div class="p-4 border-2 border-blue-200 rounded-xl bg-blue-50">
                        <label class="block text-sm font-medium text-blue-800 mb-3">
                          <i class="fas fa-shipping-fast mr-1"></i>การส่งรถให้ลูกค้า
                        </label>
                        <div class="space-y-2">
                          <label
                            class="flex items-center cursor-pointer p-2 bg-white rounded-lg hover:bg-blue-100 transition-colors">
                            <input type="radio" x-model="partnerCarData.deliveryMethod" value="ส่งเอง"
                              class="text-blue-500 focus:ring-blue-500 mr-3">
                            <span class="text-sm font-medium">ส่งเอง</span>
                          </label>
                          <label
                            class="flex items-center cursor-pointer p-2 bg-white rounded-lg hover:bg-blue-100 transition-colors">
                            <input type="radio" x-model="partnerCarData.deliveryMethod" value="พาร์ทเนอร์ส่งให้"
                              class="text-blue-500 focus:ring-blue-500 mr-3">
                            <span class="text-sm font-medium">พาร์ทเนอร์ส่งให้</span>
                          </label>
                        </div>
                      </div>

                      <!-- การรับคืนรถ -->
                      <div class="p-4 border-2 border-green-200 rounded-xl bg-green-50">
                        <label class="block text-sm font-medium text-green-800 mb-3">
                          <i class="fas fa-undo mr-1"></i>การรับคืนรถ
                        </label>
                        <div class="space-y-2">
                          <label
                            class="flex items-center cursor-pointer p-2 bg-white rounded-lg hover:bg-green-100 transition-colors">
                            <input type="radio" x-model="partnerCarData.returnMethod" value="รับคืนเอง"
                              class="text-green-500 focus:ring-green-500 mr-3">
                            <span class="text-sm font-medium">รับคืนเอง</span>
                          </label>
                          <label
                            class="flex items-center cursor-pointer p-2 bg-white rounded-lg hover:bg-green-100 transition-colors">
                            <input type="radio" x-model="partnerCarData.returnMethod" value="พาร์ทเนอร์รับคืนให้"
                              class="text-green-500 focus:ring-green-500 mr-3">
                            <span class="text-sm font-medium">พาร์ทเนอร์รับคืน</span>
                          </label>
                        </div>
                      </div>
                    </div>

                    <!-- ส่วนแก้ไขสถานที่ - ใหม่! -->
                    <div class="bg-blue-50 p-6 rounded-xl">
                      <h5 class="font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        สถานที่ในการจอง
                        <span class="ml-2 text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full">แก้ไขได้</span>
                      </h5>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- สถานที่รับรถ -->
                        <div>
                          <label class="block text-sm font-semibold text-blue-700 mb-2">
                            <i class="fas fa-map-pin mr-1"></i>สถานที่ส่งรถ
                          </label>
                          <input type="text" x-model="partnerCarData.pickupLocation"
                            :placeholder="currentAssignBooking?.สถานที่รับรถ || 'ระบุสถานที่ส่งรถให้ลูกค้า'"
                            class="w-full px-4 py-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">

                          <!-- แสดงค่าเดิม -->
                          <div class="mt-2 text-xs text-gray-600" x-show="currentAssignBooking?.สถานที่รับรถ">
                            <span class="font-medium">ค่าเดิม:</span>
                            <span x-text="currentAssignBooking?.สถานที่รับรถ"></span>
                          </div>

                          <!-- ปุ่มใช้ค่าเดิม -->
                          <button type="button"
                            x-show="currentAssignBooking?.สถานที่รับรถ && partnerCarData.pickupLocation !== currentAssignBooking?.สถานที่รับรถ"
                            @click="partnerCarData.pickupLocation = currentAssignBooking?.สถานที่รับรถ"
                            class="mt-2 text-xs text-blue-600 hover:text-blue-800 underline">
                            ใช้ค่าเดิม
                          </button>

                          <!-- ปุ่มเร็วสำหรับสถานที่รับรถ -->
                          <div class="mt-4">
                            <p class="text-sm font-medium text-blue-700 mb-2">📍 สถานที่ส่งรถที่บันทึกไว้:</p>
                            <!-- Debug: แสดงข้อมูล pickupLocations -->
                            <div x-show="!pickupLocations || pickupLocations.length === 0"
                              class="text-xs text-gray-500 mb-2">
                              ไม่มีข้อมูลสถานที่รับรถ (config: <span x-text="config?.สถานที่รับรถ || 'ไม่มี'"></span>)
                            </div>
                            <div class="flex flex-wrap gap-2" x-show="pickupLocations && pickupLocations.length > 0">
                              <template x-for="location in (pickupLocations || []).slice(0, 6)"
                                :key="'pickup-' + location">
                                <button type="button" @click="partnerCarData.pickupLocation = location"
                                  class="px-3 py-1 text-xs bg-white border border-blue-200 text-blue-700 rounded-full hover:bg-blue-100 transition-colors"
                                  x-text="location">
                                </button>
                              </template>
                            </div>

                          </div>

                        </div>

                        <!-- สถานที่คืนรถ -->
                        <div>
                          <label class="block text-sm font-semibold text-blue-700 mb-2">
                            <i class="fas fa-map-pin mr-1"></i>สถานที่คืนรถ
                          </label>
                          <input type="text" x-model="partnerCarData.returnLocation"
                            :placeholder="currentAssignBooking?.สถานที่คืนรถ || 'ระบุสถานที่คืนรถ'"
                            class="w-full px-4 py-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">

                          <!-- แสดงค่าเดิม -->
                          <div class="mt-2 text-xs text-gray-600" x-show="currentAssignBooking?.สถานที่คืนรถ">
                            <span class="font-medium">ค่าเดิม:</span>
                            <span x-text="currentAssignBooking?.สถานที่คืนรถ"></span>
                          </div>

                          <!-- ปุ่มใช้ค่าเดิม -->
                          <button type="button"
                            x-show="currentAssignBooking?.สถานที่คืนรถ && partnerCarData.returnLocation !== currentAssignBooking?.สถานที่คืนรถ"
                            @click="partnerCarData.returnLocation = currentAssignBooking?.สถานที่คืนรถ"
                            class="mt-2 text-xs text-blue-600 hover:text-blue-800 underline">
                            ใช้ค่าเดิม
                          </button>

                          <div class="mt-3">
                            <p class="text-sm font-medium text-green-700 mb-2">📍 สถานที่คืนรถที่บันทึกไว้:</p>
                            <!-- Debug: แสดงข้อมูล returnLocations -->
                            <div x-show="!returnLocations || returnLocations.length === 0"
                              class="text-xs text-gray-500 mb-2">
                              ไม่มีข้อมูลสถานที่คืนรถ (config: <span x-text="config?.สถานที่คืนรถ || 'ไม่มี'"></span>)
                            </div>
                            <div class="flex flex-wrap gap-2" x-show="returnLocations && returnLocations.length > 0">
                              <template x-for="location in (returnLocations || []).slice(0, 6)"
                                :key="'return-' + location">
                                <button type="button" @click="partnerCarData.returnLocation = location"
                                  class="px-3 py-1 text-xs bg-white border border-green-200 text-green-700 rounded-full hover:bg-green-100 transition-colors"
                                  x-text="location">
                                </button>
                              </template>
                            </div>
                          </div>

                        </div>



                      </div>



                      <!-- ปุ่มเร็วสำหรับสถานที่คืนรถ -->

                    </div>


                  </div>

                  <!-- Step 3: Contract Summary -->
                  <div x-show="assignmentStep === 3" x-transition class="space-y-6">
                    <div class="flex items-center justify-center mb-6 space-x-4">
                      <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-file-contract text-2xl text-purple-600"></i>
                      </div>
                      <div class="text-left">
                        <h4 class="text-lg font-semibold text-gray-800">สร้างสัญญาเช่าใหม่</h4>
                        <p class="text-gray-600 text-sm">ตรวจสอบข้อมูลและสร้างสัญญาเช่าฉบับใหม่</p>
                      </div>
                    </div>


                    <div class="bg-white border-2 border-gray-200 rounded-xl overflow-hidden">
                      <div class="bg-gray-100 px-6 py-3 border-b">
                        <h5 class="font-semibold text-gray-800">📋 สรุปข้อมูลการจอง</h5>
                      </div>
                      <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div class="space-y-3">
                            <h6 class="font-medium text-gray-700 border-b pb-1">👤 ข้อมูลลูกค้า</h6>
                            <div class="space-y-2 text-sm">
                              <div class="flex justify-between">
                                <span class="text-gray-600">ชื่อ:</span>
                                <span x-text="currentAssignBooking?.ชื่อลูกค้า || 'ไม่ระบุ'"></span>
                              </div>
                              <div class="flex justify-between">
                                <span class="text-gray-600">เบอร์โทร:</span>
                                <span x-text="currentAssignBooking?.เบอร์โทรศัพท์ || 'ไม่ระบุ'"></span>
                              </div>
                            </div>
                          </div>
                          <div class="space-y-3">
                            <h6 class="font-medium text-gray-700 border-b pb-1">🚗 ข้อมูลรถ</h6>
                            <div class="space-y-2 text-sm">
                              <div class="flex justify-between">
                                <span class="text-gray-600">รถ:</span>
                                <span x-text="partnerCarData.fullCarName || 'ไม่ระบุ'"></span>
                              </div>
                              <div class="flex justify-between">
                                <span class="text-gray-600">ทะเบียน:</span>
                                <span x-text="partnerCarData.licensePlate || 'ไม่ระบุ'"></span>
                              </div>
                            </div>
                          </div>
                          <div class="space-y-3">
                            <h6 class="font-medium text-gray-700 border-b pb-1">📅 ข้อมูลการเช่า</h6>
                            <div class="space-y-2 text-sm">
                              <div class="flex justify-between">
                                <span class="text-gray-600">วันที่เช่า:</span>
                                <span x-text="formatThaiDate(currentAssignBooking?.วันที่เช่า)"></span>
                              </div>
                              <div class="flex justify-between">
                                <span class="text-gray-600">วันที่คืน:</span>
                                <span x-text="formatThaiDate(currentAssignBooking?.วันที่คืน)"></span>
                              </div>
                            </div>
                          </div>
                          <div class="space-y-3">
                            <h6 class="font-medium text-gray-700 border-b pb-1">💰 ข้อมูลค่าใช้จ่าย</h6>
                            <div class="space-y-2 text-sm">
                              <div class="flex justify-between">
                                <span class="text-gray-600">ราคาเช่าต้นฉบับ:</span>
                                <span
                                  x-text="`${(currentAssignBooking?.ค่าเช่ารวมทั้งหมด || 0).toLocaleString()} บาท`"></span>
                              </div>
                              <div class="flex justify-between text-green-600">
                                <span class="font-medium">รายได้สุทธิ:</span>
                                <span class="font-bold"
                                  x-text="`${(partnerCarData.actualRevenue || 0).toLocaleString()} บาท`"></span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg">
                          <h6 class="font-medium text-blue-800 mb-3">🚚 การส่งและรับคืนรถ</h6>

                          <!-- ข้อมูลการส่ง-รับรถ -->
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                            <div>
                              <span class="text-blue-600 font-medium">การส่งรถ:</span>
                              <span x-text="partnerCarData.deliveryMethod"
                                class="ml-2 px-2 py-1 bg-blue-100 rounded text-blue-800 font-medium"></span>
                            </div>
                            <div>
                              <span class="text-blue-600 font-medium">การรับคืน:</span>
                              <span x-text="partnerCarData.returnMethod"
                                class="ml-2 px-2 py-1 bg-blue-100 rounded text-blue-800 font-medium"></span>
                            </div>
                          </div>

                          <!-- ข้อมูลสถานที่ -->
                          <div class="border-t border-blue-200 pt-3">
                            <h6 class="font-medium text-blue-700 mb-2">📍 สถานที่ในการจอง</h6>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                              <div>
                                <span class="text-blue-600 font-medium">สถานที่ส่งรถ:</span>
                                <p class="mt-1 text-gray-700"
                                  x-text="partnerCarData.pickupLocation || currentAssignBooking?.สถานที่รับรถ || 'ไม่ระบุ'">
                                </p>
                                <!-- แสดงค่าเดิมถ้ามีการแก้ไข -->
                                <p class="text-xs text-gray-500 mt-1"
                                  x-show="partnerCarData.pickupLocation && partnerCarData.pickupLocation !== currentAssignBooking?.สถานที่รับรถ">
                                  <span class="line-through">เดิม: <span
                                      x-text="currentAssignBooking?.สถานที่รับรถ"></span></span>
                                </p>
                              </div>
                              <div>
                                <span class="text-blue-600 font-medium">สถานที่รับคืน:</span>
                                <p class="mt-1 text-gray-700"
                                  x-text="partnerCarData.returnLocation || currentAssignBooking?.สถานที่คืนรถ || 'ไม่ระบุ'">
                                </p>
                                <!-- แสดงค่าเดิมถ้ามีการแก้ไข -->
                                <p class="text-xs text-gray-500 mt-1"
                                  x-show="partnerCarData.returnLocation && partnerCarData.returnLocation !== currentAssignBooking?.สถานที่คืนรถ">
                                  <span class="line-through">เดิม: <span
                                      x-text="currentAssignBooking?.สถานที่คืนรถ"></span></span>
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>




                      </div>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl">
                      <label class="block text-sm font-semibold text-purple-800 mb-2">
                        <i class="fas fa-language mr-2"></i>ภาษาสัญญาเช่า
                      </label>
                      <select x-model="contractLanguage"
                        class="w-full p-3 border-2 border-purple-200 rounded-lg focus:border-purple-500 focus:ring-4 focus:ring-purple-100">
                        <option value="th">🇹🇭 ภาษาไทย</option>
                        <option value="en">🇬🇧 ภาษาอังกฤษ</option>
                        <option value="zh-CN">🇨🇳 ภาษาจีน (ย่อ)</option>
                        <option value="zh-TW">🇹🇼 ภาษาจีน (ตัวเต็ม)</option>
                        <option value="ko">🇰🇷 ภาษาเกาหลี</option>
                        <option value="lo">🇱🇦 ภาษาลาว</option>
                        <option value="my">🇲🇲 ภาษาพม่า</option>
                        <option value="vi">🇻🇳 ภาษาเวียดนาม</option>
                        <option value="ru">🇷🇺 ภาษารัสเซีย</option>
                        <option value="ms">🇲🇾 ภาษามาเลย์</option>
                        <option value="id">🇮🇩 ภาษาอินโดนีเซีย</option>
                        <option value="ja">🇯🇵 ภาษาญี่ปุ่น</option>
                        <option value="he">🇮🇱 ภาษาฮิบรู</option>
                        <option value="fr">🇫🇷 ภาษาฝรั่งเศส</option>
                        <option value="tr">🇹🇷 ภาษาตุรกี</option>
                        <option value="es">🇪🇸 ภาษาสเปน</option>
                        <option value="it">🇮🇹 ภาษาอิตาลี</option>
                        <option value="de">🇩🇪 ภาษาเยอรมัน</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Footer - Fixed -->
                <div class="bg-white px-4 sm:px-6 py-4 border-t border-gray-200 flex-shrink-0 rounded-b-xl">
                  <div class="flex justify-between items-center gap-3">
                    <button x-show="assignmentStep > 1" @click="prevAssignmentStep()"
                      class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors flex items-center">
                      <i class="fas fa-arrow-left mr-2"></i>
                      <span class="hidden sm:inline">ย้อนกลับ</span>
                    </button>

                    <div x-show="assignmentStep === 1" class="w-20"></div>

                    <div class="flex space-x-3">
                      <button x-show="assignmentStep < 3" @click="nextAssignmentStep()"
                        :disabled="!canProceedToNextStep()"
                        :class="canProceedToNextStep() ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                        class="px-4 py-2 rounded-lg transition-all duration-200 font-medium flex items-center">
                        <span class="hidden sm:inline mr-2">ถัดไป</span>
                        <i class="fas fa-arrow-right"></i>
                      </button>

                      <button x-show="assignmentStep === 3" @click="createAssignedVehicleContract()"
                        :disabled="isProcessingAssignment"
                        class="px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white rounded-lg transition-all duration-200 flex items-center font-medium">
                        <i x-show="!isProcessingAssignment" class="fas fa-file-contract mr-2"></i>
                        <i x-show="isProcessingAssignment" class="fas fa-spinner fa-spin mr-2"></i>
                        <span x-text="isProcessingAssignment ? 'กำลังสร้าง...' : 'สร้างสัญญา'"></span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>



            <!-- <div class="bg-white p-6 rounded-lg shadow-lg mb-6 border-2 border-dashed border-indigo-300">
  <h3 class="text-xl font-bold text-indigo-700 mb-4 flex items-center">
    <i class="fas fa-tachometer-alt mr-2"></i>
    เครื่องมือวัดประสิทธิภาพ (Benchmark)
  </h3>
  <p class="text-sm text-gray-600 mb-4">
    คลิกเพื่อทดสอบการเรียกใช้ฟังก์ชัน 3 ครั้งติดต่อกัน และดูเวลาที่ใช้ในการตอบกลับ (Round-trip Time)
  </p>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h4 class="font-semibold text-gray-800 mb-2">โค้ดเวอร์ชันดั้งเดิม</h4>
      <button 
        @click="runBenchmark('original')" 
        :disabled="isBenchmarking_original"
        class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center disabled:bg-red-300">
        <div x-show="isBenchmarking_original" class="small-loader mr-2"></div>
        <span x-text="isBenchmarking_original ? 'กำลังทดสอบ...' : 'ทดสอบโค้ดดั้งเดิม'"></span>
      </button>
      <div x-show="benchmarkResults_original.length > 0" class="mt-4 bg-red-50 p-3 rounded">
        <ul class="text-sm space-y-1">
          <template x-for="result in benchmarkResults_original" :key="result.run">
            <li class="flex justify-between">
              <span>ครั้งที่ <span x-text="result.run"></span>:</span>
              <span class="font-mono" x-text="result.duration.toFixed(2) + ' ms'"></span>
            </li>
          </template>
        </ul>
      </div>
    </div>

    <div>
      <h4 class="font-semibold text-gray-800 mb-2">โค้ดเวอร์ชันปรับปรุง (Optimized)</h4>
      <button 
        @click="runBenchmark('optimized')" 
        :disabled="isBenchmarking_optimized"
        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center disabled:bg-green-300">
        <div x-show="isBenchmarking_optimized" class="small-loader mr-2"></div>
        <span x-text="isBenchmarking_optimized ? 'กำลังทดสอบ...' : 'ทดสอบโค้ดใหม่'"></span>
      </button>
      <div x-show="benchmarkResults_optimized.length > 0" class="mt-4 bg-green-50 p-3 rounded">
        <ul class="text-sm space-y-1">
          <template x-for="result in benchmarkResults_optimized" :key="result.run">
            <li class="flex justify-between">
              <span>ครั้งที่ <span x-text="result.run"></span>:</span>
              <span class="font-mono" x-text="result.duration.toFixed(2) + ' ms'"></span>
            </li>
          </template>
        </ul>
      </div>
    </div>
  </div>
</div> -->








            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                  <i class="fas fa-tasks mr-2 text-indigo-500"></i>
                  ไทม์ไลน์กิจกรรมวันนี้
                </h3>
                <!-- ปุ่มสลับมุมมอง -->
                <div class="flex gap-2">
                  <button @click="timelineViewMode = 'list'; localStorage.setItem('timelineViewMode', 'list')"
                    :class="timelineViewMode === 'list' ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600'"
                    class="px-3 py-1 rounded-lg text-sm font-medium hover:bg-indigo-50 transition-colors"
                    title="มุมมองรายการ">
                    <i class="fas fa-list"></i>
                  </button>
                  <button @click="timelineViewMode = 'compact'; localStorage.setItem('timelineViewMode', 'compact')"
                    :class="timelineViewMode === 'compact' ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600'"
                    class="px-3 py-1 rounded-lg text-sm font-medium hover:bg-indigo-50 transition-colors"
                    title="มุมมองกระชับ">
                    <i class="fas fa-grip-horizontal"></i>
                  </button>
                </div>
              </div>
              <div x-show="isLoading" class="flex justify-center items-center py-8">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
              </div>
              <div x-show="!isLoading">
                <div x-show="todayTimelineItems.length === 0" class="text-center py-8 text-gray-500">
                  <i class="fas fa-calendar-check text-5xl text-gray-300 mb-4"></i>
                  <p>ไม่มีกิจกรรมในวันนี้</p>
                </div>
                <!-- มุมมองรายการ (List View) -->
                <div x-show="todayTimelineItems.length > 0 && timelineViewMode === 'list'"
                  class="relative border-l-2 border-gray-200 ml-4 pb-1">
                  <template x-for="item in todayTimelineItems" :key="item.หมายเลขการจอง + '-' + item.ประเภท">
                    <div class="mb-8 ml-8 cursor-pointer group" @click="openScheduleDetailsModal(item)">
                      <div
                        class="absolute -left-[11px] mt-1.5 flex items-center justify-center w-6 h-6 rounded-full ring-4 ring-white"
                        :class="{
              'bg-blue-100 text-blue-600': item.ประเภท === 'รับรถ',
              'bg-amber-100 text-amber-600': item.ประเภท === 'ส่งคืนรถ'
            }">
                        <i class="fas" :class="{
                'fa-arrow-up': item.ประเภท === 'รับรถ',
                'fa-arrow-down': item.ประเภท === 'ส่งคืนรถ'
              }"></i>
                      </div>
                      <div
                        class="bg-gray-50 group-hover:bg-gray-100 p-4 rounded-lg border border-gray-200 shadow-sm transition">
                        <div class="flex justify-between items-center">
                          <time class="text-sm font-semibold text-gray-800"
                            x-text="formatTime(item.เวลา) + ' น.'"></time>
                          <span class="text-xs font-semibold px-2 py-1 rounded-full" :class="{
                  'bg-blue-100 text-blue-800': item.ประเภท === 'รับรถ',
                  'bg-amber-100 text-amber-800': item.ประเภท === 'ส่งคืนรถ'
                }" x-text="item.ประเภท"></span>
                        </div>
                        <p class="mt-2 text-base font-bold text-gray-700" x-text="item.รถ"></p>
                        <p class="text-sm text-gray-600" x-text="'ลูกค้า: ' + item.ชื่อลูกค้า"></p>
                        <p class="text-xs text-gray-500 mt-1" x-text="'หมายเลขการจอง: #' + item.หมายเลขการจอง"></p>
                        <p class="mt-2 text-sm text-gray-500 flex items-center"
                          x-show="item.สถานที่รับรถ || item.สถานที่คืนรถ">
                          <i class="fas fa-map-marker-alt mr-2" :class="{
                  'text-blue-500': item.ประเภท === 'รับรถ',
                  'text-amber-500': item.ประเภท === 'ส่งคืนรถ'
                }"></i>
                          <span x-text="item.ประเภท === 'รับรถ' ? item.สถานที่รับรถ : item.สถานที่คืนรถ"></span>
                        </p>

                        <div
                          x-show="item.ต้องการคาร์ซีท || item.ต้องการประกันเสริม || (item.ReceiptInfo && (JSON.parse(item.ReceiptInfo).wantsCashBill || JSON.parse(item.ReceiptInfo).wantsTaxInvoice || JSON.parse(item.ReceiptInfo).wantsWHT))"
                          class="mt-3 pt-3 border-t border-gray-200 flex flex-wrap gap-2">

                          <template x-if="item.ต้องการคาร์ซีท">
                            <span
                              class="flex items-center text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-baby mr-1"></i>
                              คาร์ซีท
                            </span>
                          </template>
                          <template x-if="item.ต้องการประกันเสริม">
                            <span class="flex items-center text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-shield-alt mr-1"></i>
                              ประกันเสริม
                            </span>
                          </template>
                          <template x-if="item.ReceiptInfo && JSON.parse(item.ReceiptInfo).wantsCashBill">
                            <span
                              class="flex items-center text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-money-bill-wave mr-1"></i>
                              บิลเงินสด
                            </span>
                          </template>
                          <template x-if="item.ReceiptInfo && JSON.parse(item.ReceiptInfo).wantsTaxInvoice">
                            <span class="flex items-center text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-file-invoice-dollar mr-1"></i>
                              ใบกำกับภาษี
                            </span>
                          </template>
                          <template x-if="item.ReceiptInfo && JSON.parse(item.ReceiptInfo).wantsWHT">
                            <span
                              class="flex items-center text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-receipt mr-1"></i>
                              หัก ณ ที่จ่าย
                            </span>
                          </template>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- มุมมองกระชับ (Compact View) -->
                <div x-show="todayTimelineItems.length > 0 && timelineViewMode === 'compact'">
                  <!-- คำอธิบาย -->
                  <div class="flex items-center justify-center gap-4 mb-6 text-sm">
                    <div class="flex items-center gap-2">
                      <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                      <span class="text-gray-600">รับรถ</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                      <span class="text-gray-600">ส่งคืนรถ</span>
                    </div>
                  </div>

                  <!-- แท่งแนวนอน -->
                  <div class="flex flex-wrap gap-4 justify-start">
                    <template x-for="group in groupedTimelineItems" :key="group.time + '-' + group.type">
                      <div class="flex flex-col items-center cursor-pointer hover:opacity-80 transition-opacity"
                        @click="selectedTimeGroup = group; showTimeGroupModal = true">
                        <!-- แท่งกลม -->
                        <div
                          class="flex items-center justify-center w-16 h-16 rounded-full shadow-lg font-bold text-white text-xl"
                          :class="{
                   'bg-blue-500': group.type === 'รับรถ',
                   'bg-amber-500': group.type === 'ส่งคืนรถ'
                 }">
                          <span x-text="group.count"></span>
                        </div>
                        <!-- เวลา -->
                        <div class="mt-2 text-sm font-semibold text-gray-700" x-text="group.time + ' น.'"></div>
                      </div>
                    </template>
                  </div>

                  <!-- สรุปยอดรวม -->
                  <div class="mt-6 pt-4 border-t border-gray-200 grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-3 rounded-lg text-center">
                      <div class="text-2xl font-bold text-blue-600"
                        x-text="groupedTimelineItems.filter(g => g.type === 'รับรถ').reduce((sum, g) => sum + g.count, 0)">
                      </div>
                      <div class="text-xs text-blue-700">รับรถทั้งหมด</div>
                    </div>
                    <div class="bg-amber-50 p-3 rounded-lg text-center">
                      <div class="text-2xl font-bold text-amber-600"
                        x-text="groupedTimelineItems.filter(g => g.type === 'ส่งคืนรถ').reduce((sum, g) => sum + g.count, 0)">
                      </div>
                      <div class="text-xs text-amber-700">ส่งคืนรถทั้งหมด</div>
                    </div>
                  </div>
                </div>

              </div>
            </div>







            <div x-show="upcomingMaintenance.length > 0" class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4">การแจ้งเตือนที่ใกล้จะถึง</h3>
              <div class="space-y-4">
                <template x-for="alert in upcomingMaintenance.slice(0, 3)" :key="alert.id">
                  <div class="p-4 hover:bg-rose-50 transition-colors duration-200 rounded-lg border border-gray-200">
                    <div class="flex items-start">
                      <div class="mr-4">
                        <span
                          :class="{'bg-rose-100 text-rose-700': isUrgent(alert), 'bg-amber-100 text-amber-700': !isUrgent(alert)}"
                          class="flex items-center justify-center w-10 h-10 rounded-full">
                          <i :class="getMaintenanceIcon(alert.ประเภทการแจ้งเตือน)"></i>
                        </span>
                      </div>
                      <div class="flex-1">
                        <div class="flex justify-between">
                          <h3 class="font-semibold text-gray-800" x-text="alert.ประเภทการแจ้งเตือน"></h3>
                          <span
                            :class="{'bg-rose-100 text-rose-700': isUrgent(alert), 'bg-amber-100 text-amber-700': !isUrgent(alert)}"
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                            x-text="formatAlertTime(alert)"></span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1" x-text="alert.รถ"></p>
                      </div>
                    </div>
                  </div>
                </template>
                <div x-show="upcomingMaintenance.length > 3" class="text-center">
                  <a href="#" @click.prevent="setActivePage('cars')"
                    class="text-sm text-blue-600 hover:underline">และอีก <span
                      x-text="upcomingMaintenance.length - 3"></span> รายการ...</a>
                </div>
              </div>
            </div>

          </div>

          <div class="lg:col-span-1 space-y-6">


            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                ภาพรวมการจอง 7 วันข้างหน้า
              </h3>
              <div x-show="isLoading" class="flex justify-center items-center h-64">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
              </div>
              <div x-show="!isLoading" id="bookingForecastChart" class="w-full h-64"></div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-car mr-2 text-teal-500"></i>
                สถานะรถทั้งหมด
              </h3>
              <div x-show="isLoading" class="flex justify-center items-center h-64">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
              </div>
              <div x-show="!isLoading" x-data="{ showAllCars: false, sortCarUsageDesc: true }">
                <!-- สรุปสถานะด้านบน -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                  <!-- กำลังให้เช่า (ย้ายมาหน้าสุด) -->
                  <div class="bg-amber-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-amber-600" x-text="rentalStats.inProgress || 0"></div>
                    <div class="text-xs text-amber-700">กำลังให้เช่า</div>
                  </div>
                  <!-- ว่าง (ย้ายมาตรงกลาง) -->
                  <div class="bg-green-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-600" x-text="rentalStats.availableCars || 0"></div>
                    <div class="text-xs text-green-700">ว่าง</div>
                  </div>
                  <!-- ไม่พร้อมใช้งาน (ย้ายไปท้ายสุด) -->
                  <div class="bg-gray-100 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-gray-600"
                      x-text="(rentalStats.totalCars || 0) - (rentalStats.inProgress || 0) - (rentalStats.availableCars || 0)">
                    </div>
                    <div class="text-xs text-gray-700">ไม่พร้อมใช้งาน</div>
                  </div>
                </div>

                <!-- รายชื่อรถและวันเช่า -->
                <div class="border-t pt-4">
                  <div class="flex justify-between items-center mb-3">
                    <h4 class="text-sm font-semibold text-gray-700">
                      <i class="fas fa-list mr-1"></i>
                      สรุปการใช้งานเดือนนี้
                    </h4>
                    <div class="flex items-center space-x-2">
                      <span class="text-xs text-gray-500">เช่า/ว่าง (วัน)</span>
                      <button @click="sortCarUsageDesc = !sortCarUsageDesc"
                        class="flex items-center justify-center w-7 h-7 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors"
                        :title="sortCarUsageDesc ? 'เรียงจากมากไปน้อย' : 'เรียงจากน้อยไปมาก'">
                        <i class="fas text-blue-600 text-xs"
                          :class="sortCarUsageDesc ? 'fa-sort-amount-down' : 'fa-sort-amount-up'"></i>
                      </button>
                    </div>
                  </div>

                  <!-- แสดงข้อความกำลังโหลด -->
                  <div x-show="!carUsageStats || carUsageStats.length === 0"
                    class="text-center py-4 text-gray-500 text-sm">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    กำลังโหลดข้อมูล...
                  </div>

                  <div x-show="carUsageStats && carUsageStats.length > 0" class="space-y-2 max-h-80 overflow-y-auto"
                    id="carUsageList">
                    <template
                      x-for="(car, index) in (showAllCars ? (sortCarUsageDesc ? carUsageStats : [...carUsageStats].reverse()) : (sortCarUsageDesc ? carUsageStats : [...carUsageStats].reverse()).slice(0, 10))"
                      :key="'car-usage-' + index">
                      <div class="flex justify-between items-center py-2 px-3 bg-gray-50 rounded hover:bg-gray-100">
                        <div class="flex items-center flex-1 min-w-0">
                          <i class="fas fa-car text-blue-500 mr-2 flex-shrink-0"></i>
                          <span class="text-sm text-gray-800 truncate" x-text="car.name"></span>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                          <span class="text-xs font-semibold text-amber-600 bg-amber-100 px-2 py-1 rounded"
                            x-text="car.rentalDays"></span>
                          <span class="text-gray-400">/</span>
                          <span class="text-xs font-semibold text-green-600 bg-green-100 px-2 py-1 rounded"
                            x-text="car.availableDays"></span>
                        </div>
                      </div>
                    </template>
                  </div>

                  <!-- ปุ่มขยาย/ย่อ -->
                  <template x-if="carUsageStats && carUsageStats.length > 10">
                    <button @click="showAllCars = !showAllCars"
                      class="w-full mt-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                      <i class="fas" :class="showAllCars ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                      <span
                        x-text="showAllCars ? 'แสดงน้อยลง' : 'แสดงทั้งหมด (' + carUsageStats.length + ' คัน)'"></span>
                    </button>
                  </template>
                </div>
              </div>
            </div>


          </div>

        </div>






        <!-- แก้ไข Modal รายการเช่ารถประจำวันนี้ - เปลี่ยนสีตามสถานะ -->
        <div x-show="showTodayRentalsModal" x-cloak
          class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"
          @click.self="showTodayRentalsModal = false">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden">

            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
              <h3 class="text-lg font-medium">รายการเช่ารถประจำวันนี้</h3>
              <button @click="showTodayRentalsModal = false" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="p-4 max-h-[70vh] overflow-y-auto">

              <div class="mb-3 p-3 bg-green-50 rounded-lg border border-green-100 flex items-center">
                <div class="p-2 bg-green-100 rounded-full mr-3">
                  <i class="fas fa-info-circle text-green-600"></i>
                </div>
                <div>
                  <p class="font-medium">รายการเช่าที่กำลังดำเนินการวันนี้</p>
                  <p class="text-sm text-gray-600" x-show="todayActiveRentals && todayActiveRentals.length > 0">
                    รถที่กำลังเช่าทั้งหมด: <span class="font-medium text-green-600"
                      x-text="todayActiveRentals.length"></span> คัน
                  </p>
                </div>
              </div>

              <div x-show="!todayActiveRentals || todayActiveRentals.length === 0"
                class="text-center py-6 bg-gray-50 rounded text-gray-500">
                <i class="fas fa-car-side text-gray-300 text-4xl mb-2"></i>
                <p>ไม่มีรายการเช่าที่กำลังดำเนินการวันนี้</p>
              </div>

              <div x-show="todayActiveRentals && todayActiveRentals.length > 0" class="space-y-3 mt-3">
                <template x-for="(item, index) in todayActiveRentals" :key="index">
                  <div x-bind:class="getRentalItemClass(item)" class="p-3 rounded-lg border">
                    <div class="flex justify-between">
                      <div>
                        <div class="font-medium" x-text="item ? item.รถ : ''"></div>
                        <div class="text-sm text-gray-600" x-text="item ? item.ชื่อลูกค้า : ''"></div>
                        <div class="text-xs mt-1 text-gray-500" x-text="item ? '#' + item.หมายเลขการจอง : ''"></div>

                        <div class="flex justify-between items-center mt-2">
                          <div class="text-xs flex items-center">
                            <i x-bind:class="getDateIconClass(item)" class="mr-1"></i>
                            <span
                              x-text="item ? formatDate(item.วันที่เช่า) + ' - ' + formatDate(item.วันที่คืน) : ''"></span>
                          </div>
                        </div>

                      </div>
                      <div class="text-right flex flex-col justify-between">
                        <div>
                          <div x-bind:class="getDurationTextClass(item)" class="text-sm font-medium"
                            x-text="item ? getRentalDays(item) + ' วัน' : ''"></div>

                          <div x-show="item && item.สถานะ" x-bind:class="getStatusBadgeClass(item)"
                            class="mt-1 inline-block px-2 py-0.5 rounded text-xs"
                            x-text="item ? (item.สถานะ || 'กำลังดำเนินการ') : ''"></div>
                        </div>

                        <div x-show="item.ReceiptInfo" class="flex justify-end flex-wrap gap-2 mt-2">
                          <template x-if="JSON.parse(item.ReceiptInfo).wantsCashBill">
                            <span
                              class="flex items-center text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-money-bill-wave mr-1"></i>
                              บิลเงินสด
                            </span>
                          </template>
                          <template x-if="JSON.parse(item.ReceiptInfo).wantsTaxInvoice">
                            <span class="flex items-center text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-file-invoice-dollar mr-1"></i>
                              ใบกำกับภาษี
                            </span>
                          </template>
                          <template x-if="JSON.parse(item.ReceiptInfo).wantsWHT">
                            <span
                              class="flex items-center text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                              <i class="fa-solid fa-receipt mr-1"></i>
                              หัก ณ ที่จ่าย
                            </span>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
              <button @click="showTodayRentalsModal = false"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200">
                ปิด
              </button>
              <div class="flex items-center gap-2">
                <button @click="shareTodayRentalsSummary()"
                  class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200 flex items-center"
                  title="แชร์ข้อมูล">
                  <i class="fas fa-share-alt mr-2"></i>แชร์
                </button>
                <button @click="copyTodayRentalsSummary()"
                  class="px-4 py-2 bg-emerald-500 text-white rounded hover:bg-emerald-600 transition duration-200 flex items-center"
                  title="คัดลอกข้อมูล">
                  <i class="fas fa-copy mr-2"></i>คัดลอก
                </button>
              </div>
            </div>
          </div>
        </div>







        <div x-show="showAvailableCarsModal" x-cloak
          class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"
          @click.self="showAvailableCarsModal = false">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
              <h3 class="text-lg font-medium">รายการรถว่างวันนี้</h3>
              <button @click="showAvailableCarsModal = false" class="text-gray-500 hover:text-gray-700"><i
                  class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
              <div class="mb-3 p-3 bg-indigo-50 rounded-lg border border-indigo-100 flex items-center">
                <div class="p-2 bg-indigo-100 rounded-full mr-3"><i class="fas fa-info-circle text-indigo-600"></i>
                </div>
                <div>
                  <p class="font-medium">รถที่ว่างให้เช่าในวันนี้</p>
                  <p class="text-sm text-gray-600">จำนวนรถว่าง <span class="font-medium text-indigo-600"
                      x-text="rentalStats.availableCars"></span> จากทั้งหมด <span class="font-medium"
                      x-text="rentalStats.totalCars"></span> คัน</p>
                </div>
              </div>
              <div x-show="!availableCarsToday || availableCarsToday.length === 0"
                class="text-center py-6 bg-gray-50 rounded text-gray-500"><i
                  class="fas fa-car-side text-gray-300 text-4xl mb-2"></i>
                <p>ไม่พบข้อมูลรถว่างในวันนี้</p>
              </div>
              <div x-show="availableCarsToday && availableCarsToday.length > 0" class="space-y-3 mt-3">
                <template x-for="(car, index) in availableCarsToday" :key="index">
                  <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                    <div class="flex justify-between">
                      <div>
                        <div class="font-medium flex items-center">
                          <span class="mr-2 relative"
                            :class="{'text-blue-600': car.ประเภท === 'รถยนต์(น้ำมัน)', 'text-orange-600': car.ประเภท === 'รถจักรยานยนต์(น้ำมัน)', 'text-green-600': car.ประเภท === 'รถยนต์(รถไฟฟ้า)', 'text-purple-600': car.ประเภท === 'รถจักรยานยนต์(รถไฟฟ้า)'}">
                            <i class="fas"
                              :class="{'fa-car-side': car.ประเภท === 'รถยนต์(น้ำมัน)' || car.ประเภท === 'รถยนต์(รถไฟฟ้า)', 'fa-motorcycle': car.ประเภท === 'รถจักรยานยนต์(น้ำมัน)' || car.ประเภท === 'รถจักรยานยนต์(รถไฟฟ้า)'}"></i>
                            <i x-show="car.ประเภท === 'รถยนต์(รถไฟฟ้า)' || car.ประเภท === 'รถจักรยานยนต์(รถไฟฟ้า)'"
                              class="fas fa-bolt absolute -top-1 -right-2 text-xs text-yellow-500"></i>
                          </span>
                          <span x-text="car ? car.ยี่ห้อ + ' ' + car.รุ่น : ''"></span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1" x-text="car ? 'ทะเบียน: ' + car.ทะเบียน : ''"></div>
                        <div class="text-sm text-gray-600 mt-1" x-text="car ? 'สี: ' + car.สี : ''"></div>
                        <div class="mt-1"><span class="inline-block px-2 py-0.5 rounded text-xs"
                            :class="{'bg-green-100 text-green-800': car.ประเภท === 'รถยนต์(รถไฟฟ้า)', 'bg-blue-100 text-blue-800': car.ประเภท === 'รถยนต์(น้ำมัน)', 'bg-orange-100 text-orange-800': car.ประเภท === 'รถจักรยานยนต์(น้ำมัน)', 'bg-purple-100 text-purple-800': car.ประเภท === 'รถจักรยานยนต์(รถไฟฟ้า)'}"
                            x-text="car.ประเภท"></span></div>
                      </div>
                      <div class="text-right">
                        <div class="text-sm font-medium text-indigo-600"
                          x-text="car ? formatCurrency(car.ราคาเช่าต่อวัน) + '/วัน' : ''"></div>
                        <div class="mt-1 inline-block px-2 py-0.5 rounded text-xs bg-indigo-100 text-indigo-800">
                          พร้อมให้เช่า</div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
              <button @click="showAvailableCarsModal = false"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200">ปิด</button>
              <div class="flex items-center gap-2">
                <button @click="shareAvailableCarsSummary()"
                  class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200 flex items-center"
                  title="แชร์ข้อมูล"><i class="fas fa-share-alt mr-2"></i>แชร์</button>
                <button @click="copyAvailableCarsSummary()"
                  class="px-4 py-2 bg-emerald-500 text-white rounded hover:bg-emerald-600 transition duration-200 flex items-center"
                  title="คัดลอกข้อมูล"><i class="fas fa-copy mr-2"></i>คัดลอก</button>
              </div>
            </div>
          </div>
        </div>

        <div x-show="showTodayScheduleModal" x-cloak
          class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"
          @click.self="showTodayScheduleModal = false">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
              <h3 class="text-lg font-medium">รายการรับส่งรถประจำวันนี้</h3>
              <button @click="showTodayScheduleModal = false" class="text-gray-500 hover:text-gray-700"><i
                  class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
              <div class="mb-5">
                <div class="flex items-center mb-3">
                  <div class="bg-indigo-100 p-2 rounded-full mr-2"><i class="fas fa-arrow-up text-indigo-600"></i></div>
                  <h4 class="font-medium">รับรถวันนี้ (<span x-text="todayPickups.length"></span> คัน)</h4>
                </div>
                <div x-show="todayPickups.length === 0" class="text-center py-4 bg-gray-50 rounded text-gray-500">
                  ไม่มีรายการรับรถวันนี้</div>
                <div x-show="todayPickups.length > 0" class="space-y-2">
                  <template x-for="(item, index) in todayPickups" :key="index">
                    <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                      <div class="flex justify-between">
                        <div>
                          <div class="font-medium" x-text="item.รถ"></div>
                          <div class="text-sm text-gray-600" x-text="item.ชื่อลูกค้า"></div>
                          <div class="text-xs mt-1 text-gray-500" x-text="'#' + item.หมายเลขการจอง"></div>
                        </div>
                        <div class="font-medium" x-text="formatTime(item.เวลา)"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
              <div>
                <div class="flex items-center mb-3">
                  <div class="bg-rose-100 p-2 rounded-full mr-2"><i class="fas fa-arrow-down text-rose-600"></i></div>
                  <h4 class="font-medium">คืนรถวันนี้ (<span x-text="todayReturns.length"></span> คัน)</h4>
                </div>
                <div x-show="todayReturns.length === 0" class="text-center py-4 bg-gray-50 rounded text-gray-500">
                  ไม่มีรายการคืนรถวันนี้</div>
                <div x-show="todayReturns.length > 0" class="space-y-2">
                  <template x-for="(item, index) in todayReturns" :key="index">
                    <div class="p-3 bg-rose-50 rounded-lg border border-rose-100">
                      <div class="flex justify-between">
                        <div>
                          <div class="font-medium" x-text="item.รถ"></div>
                          <div class="text-sm text-gray-600" x-text="item.ชื่อลูกค้า"></div>
                          <div class="text-xs mt-1 text-gray-500" x-text="'#' + item.หมายเลขการจอง"></div>
                        </div>
                        <div class="font-medium" x-text="formatTime(item.เวลา)"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
              <button @click="showTodayScheduleModal = false"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200">ปิด</button>
              <div class="flex items-center gap-2">
                <button @click="shareTodayScheduleSummary()"
                  class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200 flex items-center"
                  title="แชร์ข้อมูล"><i class="fas fa-share-alt mr-2"></i>แชร์</button>
                <button @click="copyTodayScheduleSummary()"
                  class="px-4 py-2 bg-emerald-500 text-white rounded hover:bg-emerald-600 transition duration-200 flex items-center"
                  title="คัดลอกข้อมูล"><i class="fas fa-copy mr-2"></i>คัดลอก</button>
              </div>
            </div>
          </div>
        </div>


      </div>




      <!-- หน้าจัดการการจอง (Bookings) -->
      <div x-show="currentPage === 'bookings'" x-cloak class="-mt-6">
        <div class="mb-6">
          <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4 border-purple-500">

            <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5"
              style="background-color: #A1B4FF;">
              <i class="fas fa-clipboard-list text-white text-2xl"></i>
            </div>



            <!-- Title and Subtitle -->
            <div>
              <h2 class="text-2xl font-bold text-gray-800">ตรวจสอบคิวรถ</h2>
              <p class="mt-1 text-gray-600">
                <i class="fas fa-search mr-2" style="color: #A1B4FF;"></i>ค้นหารถที่ว่างและเช่าระยะสั้น
              </p>


            </div>

          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md mb-6">
          <!-- Tab Headers -->
          <div class="flex border-b border-gray-200">
            <button @click="bookingsTab = 'search'" :class="bookingsTab === 'search' ?
                'border-b-2 border-blue-500 text-blue-600 bg-blue-50' :
                'text-gray-500 hover:text-gray-700 hover:bg-gray-50'"
              class="px-6 py-4 font-medium transition-all duration-200 flex items-center space-x-2">
              <i class="fas fa-search"></i>
              <span>ค้นหารถพร้อมให้บริการ</span>
            </button>

            <button
              @click="bookingsTab = 'timeline'; if (!timeline.carList || timeline.carList.length === 0) initTimelineData();"
              :class="bookingsTab === 'timeline' ?
                'border-b-2 border-blue-500 text-blue-600 bg-blue-50' :
                'text-gray-500 hover:text-gray-700 hover:bg-gray-50'"
              class="px-6 py-4 font-medium transition-all duration-200 flex items-center space-x-2">
              <i class="fas fa-calendar-alt"></i>
              <span>ดูตารางรถที่เลือก</span>
            </button>
          </div>

          <!-- Tab 1: ค้นหารถพร้อมให้บริการ -->
          <div x-show="bookingsTab === 'search'" x-transition>
            <!-- ฟอร์มค้นหา -->
            <div class="pt-8 pb-5 px-6 mt-4">
              <div class="flex items-center">
                <div class="flex items-center justify-center w-14 h-14 bg-blue-100 rounded-full shadow-sm mr-5">
                  <i class="fa-solid fa-car-on text-blue-600 text-2xl"></i>
                </div>
                <div>
                  <p class="text-gray-500 mt-1 flex items-center text-lg">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                    ค้นหารถที่ว่างตามช่วงเวลาที่ต้องการ
                  </p>
                  <div class="mt-2 flex space-x-2">
                    <span class="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded-full">ระบุวันที่</span>
                    <span class="text-xs px-2 py-1 bg-gray-50 text-gray-600 rounded-full">กรองรถที่ต้องการ</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="p-6 border-t border-gray-100">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label for="pickupDate" class="block text-sm font-medium text-gray-700 mb-2">วันที่รับรถ</label>
                  <input id="pickupDate" type="date" x-model="pickupDate"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500"
                    required>
                </div>
                <div>
                  <label for="pickupTime" class="block text-sm font-medium text-gray-700 mb-2">เวลารับรถ</label>
                  <input id="pickupTime" type="time" x-model="pickupTime"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500"
                    required>
                </div>
                <div>
                  <label for="returnDate" class="block text-sm font-medium text-gray-700 mb-2">วันที่คืนรถ</label>
                  <input id="returnDate" type="date" x-model="returnDate"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500"
                    required>
                </div>
                <div>
                  <label for="returnTime" class="block text-sm font-medium text-gray-700 mb-2">เวลาคืนรถ</label>
                  <input id="returnTime" type="time" x-model="returnTime"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500"
                    required>
                </div>
                <div>
                  <label for="prepTime" class="block text-sm font-medium text-gray-700 mb-2">ระยะเวลาเตรียมรถ</label>
                  <select id="prepTime" x-model="prepTime"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="0">ส่งต่อได้ทันที</option>
                    <option value="30">30 นาที</option>
                    <option value="60">1 ชั่วโมง</option>
                    <option value="120">2 ชั่วโมง</option>
                  </select>
                </div>
              </div>

              <div class="mt-6 text-center">
                <button @click.prevent="
            availabilitySummary=null;
            availableCars=[];
            brands=[];
            modelFilter='';
            brandFilter='';
            typeFilter='';
            searchPerformed=false;
            searchAvailabilitySummary();
            scrollToResultsAfterSearch();
          " class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 w-full sm:w-auto"
                  :disabled="isLoading || !pickupDate || !pickupTime || !returnDate || !returnTime"
                  :class="{'opacity-50 cursor-not-allowed': isLoading || !pickupDate || !pickupTime || !returnDate || !returnTime}">
                  <template x-if="!isLoading">
                    <span><i class="fas fa-search mr-2"></i>ค้นหารถว่าง</span>
                  </template>
                  <template x-if="isLoading">
                    <div class="flex items-center justify-center">
                      <div class="loading-spinner mr-2"></div>
                      <span>กำลังค้นหา...</span>
                    </div>
                  </template>
                </button>
              </div>
            </div>

            <!-- ผลการค้นหา -->
            <div id="searchResults" x-show="searchPerformed" class="p-6 border-t border-gray-100" x-cloak>
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-xl font-semibold flex items-center text-blue-700">
                  <i class="fas fa-car mr-3"></i>ผลการค้นหา
                </h2>

                <div class="flex gap-2 w-full sm:w-auto">
                  <button @click="copySummary()"
                    class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-500 flex items-center justify-center"
                    :disabled="!availabilitySummary" :class="{'opacity-50 cursor-not-allowed': !availabilitySummary}">
                    <i class="fas fa-copy mr-2"></i>คัดลอกข้อความสรุป
                  </button>

                  <button @click="shareSummary()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center justify-center"
                    :disabled="!availabilitySummary" :class="{'opacity-50 cursor-not-allowed': !availabilitySummary}">
                    <i class="fas fa-share-alt mr-2"></i>แชร์
                  </button>
                </div>
              </div>

              <!-- ตัวเลขสรุป -->
              <div x-show="availabilitySummary" x-cloak class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div class="text-sm text-green-600">รถว่างตลอดช่วง</div>
                  <div class="text-3xl font-semibold text-green-700"
                    x-text="availabilitySummary?.totals?.freeAllPeriod ?? 0"></div>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                  <div class="text-sm text-amber-700">รถที่จอง 1-2 วัน</div>
                  <!-- แก้ไขจาก shortBookedCars เป็น shortBookedCount -->
                  <div class="text-3xl font-semibold text-amber-800"
                    x-text="availabilitySummary?.totals?.shortBookedCount ?? 0"></div>
                </div>
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <div class="text-sm text-slate-600">รถพร้อมให้เช่าทั้งหมด</div>
                  <div class="text-3xl font-semibold text-slate-800"
                    x-text="availabilitySummary?.totals?.totalReadyCars ?? 0"></div>
                </div>
              </div>

              <!-- รถว่างตลอดช่วง -->
              <div x-show="availabilitySummary" x-cloak class="rounded-lg border border-emerald-200 mb-6">
                <div class="px-4 py-3 bg-emerald-600 text-white rounded-t-lg font-semibold flex items-center">
                  <i class="fas fa-check-circle mr-2"></i> รถว่างตลอดช่วง
                </div>
                <div class="p-4 grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                  <template x-for="item in (availabilitySummary?.freeByModel || [])" :key="item.model">
                    <div
                      class="flex justify-between border-b border-emerald-100 py-1 cursor-pointer hover:text-blue-700"
                      @click="openModelDetail('free', item.model)">
                      <div class="font-medium" x-text="item.model"></div>
                      <div class="text-emerald-700" x-text="item.count + ' คัน'"></div>
                    </div>
                  </template>
                  <template x-if="(availabilitySummary?.freeByModel || []).length === 0">
                    <div class="text-slate-500">ไม่พบรถว่างตามเงื่อนไข</div>
                  </template>
                </div>
                <!-- สรุปตามรุ่น -->
                <div class="mt-3 text-sm text-emerald-900 bg-emerald-50 border border-emerald-200 rounded px-3 py-2">
                  <span class="font-semibold">สรุปตามรุ่น:</span>
                  <span
                    x-text="(availabilitySummary?.freeByModel || []).map(x => `${x.model} ${x.count} คัน`).join(' | ')"></span>
                </div>
              </div>

              <!-- รถที่จอง 1–2 วัน -->
              <div x-show="availabilitySummary" x-cloak class="rounded-lg border border-amber-200 mb-10">
                <div class="px-4 py-3 bg-amber-500 text-white rounded-t-lg font-semibold flex items-center">
                  <i class="fas fa-clock mr-2"></i> รถที่จอง 1-2 วัน
                </div>
                <div class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                  <template x-for="item in (availabilitySummary?.shortBookedByModel || [])" :key="item.model">
                    <div class="flex justify-between border-b border-amber-100 py-1 cursor-pointer hover:text-blue-700"
                      @click="openModelDetail('short', item.model)">
                      <div class="font-medium" x-text="item.model"></div>
                      <div class="text-amber-800" x-text="item.count + ' คัน'"></div>
                    </div>
                  </template>
                  <template x-if="(availabilitySummary?.shortBookedByModel || []).length === 0">
                    <div class="text-slate-500">ไม่มีรายการเช่าระยะสั้นภายในช่วงค้นหา</div>
                  </template>
                </div>
                <!-- สรุปตามรุ่น -->
                <div class="mt-3 text-sm text-amber-900 bg-amber-50 border border-amber-200 rounded px-3 py-2">
                  <span class="font-semibold">สรุปตามรุ่น:</span>
                  <span
                    x-text="(availabilitySummary?.shortBookedByModel || []).map(x => `${x.model} ${x.count} คัน`).join(' | ')"></span>
                </div>
              </div>


              <div x-show="availabilitySummary" x-cloak class="rounded-lg border border-blue-200 mb-10">
                <div class="px-4 py-3 bg-blue-700 text-white rounded-t-lg font-semibold flex items-center">
                  <i class="fas fa-table mr-2"></i> ตารางรถว่างทั้งหมด
                </div>
                <!-- ตัวกรองและตารางเดิมด้านล่าง -->
                <div x-show="availableCars.length > 0" class="mb-6 mt-6 px-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label for="brandFilter" class="block text-sm font-medium text-gray-700 mb-2">กรองตามยี่ห้อ</label>
                    <select id="brandFilter" x-model="brandFilter" @change="modelFilter = ''"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 bg-white">
                      <option value="">ทั้งหมด</option>
                      <template x-for="brand in brands" :key="brand">
                        <option :value="brand" x-text="brand"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label for="modelFilter" class="block text-sm font-medium text-gray-700 mb-2">กรองตามรุ่น</label>
                    <select id="modelFilter" x-model="modelFilter"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 bg-white"
                      :disabled="!brandFilter">
                      <option value="">ทั้งหมด</option>
                      <template x-for="model in filteredModels" :key="model">
                        <option :value="model" x-text="model"></option>
                      </template>
                    </select>
                  </div>
                  <div>
                    <label for="typeFilter" class="block text-sm font-medium text-gray-700 mb-2">กรองตามประเภท</label>
                    <select id="typeFilter" x-model="typeFilter"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 bg-white">
                      <option value="">ทั้งหมด</option>
                      <template x-for="type in carTypes" :key="type">
                        <option :value="type" x-text="type"></option>
                      </template>
                    </select>
                  </div>
                </div>

                <div id="resultsTable" class="overflow-x-auto rounded-lg border border-gray-200">
                  <template x-if="filteredCars.length > 0">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-blue-50">
                        <tr>
                          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">
                            ยี่ห้อ</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">
                            รุ่น
                          </th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">
                            ทะเบียน</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">สี
                          </th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">
                            ค่าประกันความเสียหาย</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">
                            ราคาเช่าต่อวัน</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">
                            ประเภท</th>
                          <th class="px-6 py-3 text-center text-xs font-medium text-blue-700 uppercase tracking-wider">
                            เสนอราคา</th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="(car, index) in filteredCars"
                          :key="`${car?.ทะเบียน||car?.รุ่น||'k'}-${index}`">
                          <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                              x-text="car.ยี่ห้อ">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="car.รุ่น"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="car.ทะเบียน"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="car.สี"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                              x-text="car.ค่าประกันความเสียหาย"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                              <span class="text-green-600 font-semibold"
                                x-text="formatCurrency(car.ราคาเช่าต่อวัน)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" :class="{
                        'bg-green-100 text-green-800': car.ประเภท === 'รถยนต์(รถไฟฟ้า)',
                        'bg-blue-100 text-blue-800': car.ประเภท === 'รถยนต์(น้ำมัน)',
                        'bg-orange-100 text-orange-800': car.ประเภท === 'รถจักรยานยนต์(น้ำมัน)',
                        'bg-purple-100 text-purple-800': car.ประเภท === 'รถจักรยานยนต์(รถไฟฟ้า)'
                      }" x-text="car.ประเภท"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                              <button @click="openQuoteModal(car)"
                                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center mx-auto">
                                <i class="fas fa-file-invoice-dollar mr-2"></i>
                                เสนอราคา
                              </button>
                            </td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </template>

                  <template x-if="searchPerformed && filteredCars.length === 0">
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                      <i class="fas fa-car-side text-blue-300 text-5xl mb-4"></i>
                      <p class="text-lg text-gray-500">ไม่พบรถว่างตามเงื่อนไขที่กำหนด</p>
                      <p class="text-sm text-gray-400 mt-2" x-show="brandFilter || modelFilter">
                        ลองปรับเปลี่ยนตัวกรองยี่ห้อหรือรุ่น</p>
                    </div>
                  </template>
                </div>
              </div>


            </div>
          </div>
          <!-- สิ้นสุด Tab 1 -->

          <!-- Tab 2: ดูตารางรถที่เลือก -->
          <div x-show="bookingsTab === 'timeline'" x-transition>
            <div class="p-6">
              <!-- ส่วนเลือกรถและเดือน -->
              <div class="mb-6">
                <div class="flex items-center mb-4">
                  <div class="flex items-center justify-center w-14 h-14 bg-green-100 rounded-full shadow-sm mr-5">
                    <i class="fas fa-calendar-check text-green-600 text-2xl"></i>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-800">ดูตารางคิวรถ</h3>
                    <p class="text-gray-500 mt-1 flex items-center text-sm">
                      <i class="fas fa-info-circle mr-2 text-green-500"></i>
                      เลือกรถและเดือนเพื่อดูตารางการจอง
                    </p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                  <!-- Dropdown เลือกรถ -->
                  <div class="md:col-span-2">
                    <label for="timelineCarSelect" class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-car mr-2 text-blue-500"></i>เลือกรถ
                    </label>
                    <select id="timelineCarSelect" x-model="timeline.selectedCar"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 bg-white"
                      :disabled="timeline.isLoadingCarList">
                      <option value=""
                        x-text="timeline.isLoadingCarList ? 'กำลังโหลดรายชื่อรถทั้งหมด...' : '-- เลือกรถ --'"></option>
                      <template x-for="(car, index) in (timeline.carList || [])" :key="index">
                        <option :value="car.fullName" x-text="car.fullName"></option>
                      </template>
                    </select>
                  </div>

                  <!-- Dropdown เลือกเดือน -->
                  <div>
                    <label for="timelineMonthSelect" class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-calendar mr-2 text-blue-500"></i>เดือน/ปี
                    </label>
                    <select id="timelineMonthSelect" x-model="timeline.selectedMonth"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 bg-white">
                      <template x-for="month in timeline.monthOptions" :key="month.value">
                        <option :value="month.value" x-text="month.label"></option>
                      </template>
                    </select>
                  </div>
                </div>

                <!-- ปุ่มค้นหา -->
                <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-center">
                  <button @click="searchCarTimeline()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center justify-center space-x-2 transition-colors w-full sm:w-auto"
                    :disabled="!timeline.selectedCar || timeline.isLoading"
                    :class="{'opacity-50 cursor-not-allowed': !timeline.selectedCar || timeline.isLoading}">
                    <i class="fas fa-search"></i>
                    <span x-text="timeline.isLoading ? 'กำลังค้นหา...' : 'แสดงตาราง'"></span>
                  </button>

                  <button @click="timeline.showAlternativeSearch = !timeline.showAlternativeSearch"
                    x-show="timeline.searchPerformed && timeline.viewMode === 'single'"
                    class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:ring-2 focus:ring-green-500 flex items-center justify-center space-x-2 transition-colors w-full sm:w-auto">
                    <i class="fas" :class="timeline.showAlternativeSearch ? 'fa-eye-slash' : 'fa-search'"></i>
                    <span x-text="timeline.showAlternativeSearch ? 'ซ่อนการค้นหา' : 'ดูรถรุ่นเดียวกันที่ว่าง'"></span>
                  </button>
                </div>
              </div>

              <!-- ฟีเจอร์ค้นหารถทดแทน -->
              <div x-show="timeline.searchPerformed && timeline.viewMode === 'single' && timeline.showAlternativeSearch"
                x-cloak
                class="mt-6 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border border-blue-200 shadow-sm">
                <div class="flex items-center mb-4">
                  <div class="flex items-center justify-center w-12 h-12 bg-blue-100 rounded-full mr-4">
                    <i class="fas fa-search-plus text-blue-600 text-xl"></i>
                  </div>
                  <div>
                    <h4 class="text-lg font-semibold text-gray-800">ค้นหารถรุ่นเดียวกันที่ว่าง</h4>
                    <p class="text-sm text-gray-600">กรอกวันเวลาที่ลูกค้าต้องการเช่า เพื่อหารถทดแทน</p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <!-- วันรับรถ -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-calendar-plus mr-2 text-green-500"></i>วันรับรถ
                    </label>
                    <div class="flex space-x-2">
                      <input type="date" x-model="timeline.alternativeSearch.pickupDate"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                      <input type="time" x-model="timeline.alternativeSearch.pickupTime"
                        class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                  </div>

                  <!-- วันคืนรถ -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-calendar-minus mr-2 text-red-500"></i>วันคืนรถ
                    </label>
                    <div class="flex space-x-2">
                      <input type="date" x-model="timeline.alternativeSearch.returnDate"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                      <input type="time" x-model="timeline.alternativeSearch.returnTime"
                        class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                  </div>
                </div>

                <!-- ปุ่มลัดสำหรับช่วงเวลา -->
                <div class="flex flex-wrap gap-2 mb-4">
                  <button @click="setQuickDateRange('today')"
                    class="px-3 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">
                    <i class="fas fa-clock mr-1"></i>วันนี้-พรุ่งนี้
                  </button>
                  <button @click="setQuickDateRange('weekend')"
                    class="px-3 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">
                    <i class="fas fa-calendar-week mr-1"></i>สุดสัปดาห์นี้
                  </button>
                  <button @click="setQuickDateRange('week')"
                    class="px-3 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm">
                    <i class="fas fa-calendar mr-1"></i>7 วันข้างหน้า
                  </button>
                </div>

                <!-- ปุ่มค้นหา -->
                <div class="flex justify-center">
                  <button @click="searchAlternativeCars()"
                    :disabled="!timeline.alternativeSearch.pickupDate || !timeline.alternativeSearch.returnDate || timeline.alternativeSearch.isSearching"
                    :class="{'opacity-50 cursor-not-allowed': !timeline.alternativeSearch.pickupDate || !timeline.alternativeSearch.returnDate || timeline.alternativeSearch.isSearching}"
                    class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center justify-center space-x-2 transition-colors">
                    <i class="fas"
                      :class="timeline.alternativeSearch.isSearching ? 'fa-spinner fa-spin' : 'fa-search'"></i>
                    <span x-text="timeline.alternativeSearch.isSearching ? 'กำลังค้นหา...' : 'ค้นหารถที่ว่าง'"></span>
                  </button>
                </div>

                <!-- ผลการค้นหารถทดแทน -->
                <div x-show="timeline.alternativeSearch.results.length > 0" x-cloak class="mt-4">
                  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-600 to-green-700 px-4 py-3">
                      <h5 class="text-white font-semibold flex items-center">
                        <i class="fas fa-car mr-2"></i>
                        ผลการค้นหา (<span x-text="timeline.alternativeSearch.results.length"></span> คัน)
                      </h5>
                    </div>
                    <div class="p-4 space-y-3">
                      <template x-for="(car, index) in timeline.alternativeSearch.results"
                        :key="`alt-car-${index}-${car.fullName}`">
                        <div class="flex items-center justify-between p-4 rounded-lg border transition-colors"
                          :class="car.available ? 'bg-green-50 border-green-200 hover:bg-green-100' : 'bg-red-50 border-red-200'">
                          <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center"
                              :class="car.available ? 'bg-green-100' : 'bg-red-100'">
                              <i class="fas"
                                :class="car.available ? 'fa-check text-green-600' : 'fa-times text-red-600'"></i>
                            </div>
                            <div>
                              <p class="font-semibold text-gray-800" x-text="car.fullName"></p>
                              <p class="text-sm" :class="car.available ? 'text-green-600' : 'text-red-600'"
                                x-text="car.available ? '✅ ว่าง พร้อมให้เช่า' : '❌ ไม่ว่าง'"></p>
                            </div>
                          </div>
                          <div x-show="!car.available && car.conflicts && car.conflicts.length > 0" class="text-right">
                            <p class="text-xs text-gray-500">ทับซ้อนกับ:</p>
                            <template x-for="conflict in car.conflicts" :key="conflict.bookingNumber">
                              <p class="text-xs text-red-600" x-text="conflict.bookingNumber"></p>
                            </template>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- ข้อความเมื่อไม่มีผลการค้นหา -->
                <div x-show="timeline.alternativeSearch.searched && timeline.alternativeSearch.results.length === 0"
                  x-cloak class="mt-4 text-center py-8 bg-gray-50 rounded-lg border border-gray-200">
                  <i class="fas fa-car-side text-gray-300 text-4xl mb-3"></i>
                  <p class="text-gray-500">ไม่พบรถรุ่นเดียวกันในระบบ</p>
                </div>
              </div>

              <!-- ผลการค้นหา: Timeline -->
              <div
                x-show="timeline.searchPerformed && !timeline.isLoading && timeline.viewMode === 'single' && !timeline.showAlternativeSearch"
                x-cloak class="mt-6">
                <template x-if="timeline.bookings.length === 0">
                  <div class="text-center py-12 bg-gray-50 rounded-lg border border-gray-200">
                    <i class="fas fa-calendar-times text-gray-300 text-5xl mb-4"></i>
                    <p class="text-lg text-gray-500">ไม่พบข้อมูลการจองในเดือนนี้</p>
                    <p class="text-sm text-gray-400 mt-2">รถคันนี้ว่างตลอดทั้งเดือน</p>
                  </div>
                </template>

                <!-- Timeline View แบบเต็ม -->
                <template x-if="timeline.bookings.length > 0">
                  <div>
                    <!-- Card สรุปสถิติ -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                      <h5 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                        สรุปข้อมูลการใช้รถ
                      </h5>

                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                          <div class="flex items-center justify-between">
                            <div>
                              <p class="text-sm text-blue-600 font-medium">จำนวนวันทั้งหมด</p>
                              <p class="text-3xl font-bold text-blue-700" x-text="timeline.summary?.totalDays || 0"></p>
                              <p class="text-xs text-blue-500 mt-1">ในเดือนที่เลือก</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center">
                              <i class="fas fa-calendar text-blue-600 text-xl"></i>
                            </div>
                          </div>
                        </div>

                        <div
                          class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                          <div class="flex items-center justify-between">
                            <div>
                              <p class="text-sm text-green-600 font-medium">วันที่มีการเช่า</p>
                              <p class="text-3xl font-bold text-green-700" x-text="timeline.summary?.rentedDays || 0">
                              </p>
                              <p class="text-xs text-green-600 mt-1"
                                x-text="'อัตราการใช้งาน ' + Math.round((timeline.summary?.rentedDays || 0) / (timeline.summary?.totalDays || 1) * 100) + '%'">
                              </p>
                            </div>
                            <div class="w-12 h-12 bg-green-200 rounded-full flex items-center justify-center">
                              <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                          </div>
                        </div>

                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200">
                          <div class="flex items-center justify-between">
                            <div>
                              <p class="text-sm text-gray-600 font-medium">วันว่าง</p>
                              <p class="text-3xl font-bold text-gray-700" x-text="timeline.summary?.freeDays || 0"></p>
                              <p class="text-xs text-gray-500 mt-1"
                                x-text="'ว่าง ' + Math.round((timeline.summary?.freeDays || 0) / (timeline.summary?.totalDays || 1) * 100) + '%'">
                              </p>
                            </div>
                            <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                              <i class="fas fa-calendar-check text-gray-600 text-xl"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Timeline Calendar View -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                      <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                        <h4 class="text-lg font-semibold text-white flex items-center">
                          <i class="fas fa-calendar-alt mr-2"></i>
                          <span x-text="'ตารางการจอง - ' + timeline.selectedCar"></span>
                        </h4>
                      </div>

                      <div class="p-6">
                        <!-- Timeline Grid -->
                        <div class="overflow-x-auto">
                          <div class="inline-block min-w-full">
                            <!-- วันที่ Header -->
                            <div class="grid gap-1 mb-2"
                              :style="`grid-template-columns: repeat(${timeline.summary?.totalDays || 30}, minmax(40px, 1fr));`">
                              <template x-for="day in (timeline.summary?.totalDays || 30)" :key="day">
                                <div class="text-center">
                                  <div class="text-xs font-medium text-gray-500" x-text="day"></div>
                                  <div class="text-xs text-gray-400" x-text="getDayName(day, timeline.selectedMonth)">
                                  </div>
                                </div>
                              </template>
                            </div>

                            <!-- Timeline Bars -->
                            <div class="relative h-auto"
                              :style="`min-height: ${timeline.bookings.length * 48 + 10}px;`">
                              <!-- Background Grid -->
                              <div class="absolute inset-0 grid gap-1"
                                :style="`grid-template-columns: repeat(${timeline.summary?.totalDays || 30}, minmax(40px, 1fr));`">
                                <template x-for="day in (timeline.summary?.totalDays || 30)" :key="'bg-' + day">
                                  <div class="bg-gray-50 border-r border-gray-200 h-full"></div>
                                </template>
                              </div>

                              <!-- Booking Bars -->
                              <div class="relative">
                                <template x-for="(booking, index) in timeline.bookings" :key="booking.bookingNumber">
                                  <div
                                    class="absolute rounded-lg shadow-md cursor-pointer transition-all hover:shadow-lg hover:z-10"
                                    :style="getBookingStyle(booking, index, timeline.selectedMonth, timeline.summary?.totalDays)"
                                    @click="showBookingDetail(booking)"
                                    :title="`${booking.bookingNumber} - ${booking.customerName}`">
                                    <div class="h-full flex items-center justify-center px-2">
                                      <div class="text-center overflow-hidden">
                                        <p class="text-xs font-bold text-white truncate" x-text="booking.bookingNumber">
                                        </p>
                                        <p class="text-xs text-white/90 truncate" x-text="booking.customerName"></p>
                                      </div>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Legend -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                          <p class="text-sm font-medium text-gray-700 mb-2">คำอธิบาย:</p>
                          <div class="flex flex-wrap gap-4">
                            <div class="flex items-center">
                              <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                              <span class="text-sm text-gray-600">การจองปกติ</span>
                            </div>
                            <div class="flex items-center">
                              <div class="w-4 h-4 bg-orange-500 rounded mr-2"></div>
                              <span class="text-sm text-gray-600">กำลังเช่าอยู่</span>
                            </div>
                            <div class="flex items-center">
                              <div class="w-4 h-4 bg-gray-200 rounded mr-2"></div>
                              <span class="text-sm text-gray-600">วันว่าง</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- รายการจองทั้งหมด -->
                    <div class="mt-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
                      <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                        <h5 class="font-semibold text-gray-800">รายการจองทั้งหมด (<span
                            x-text="timeline.bookings.length"></span> รายการ)</h5>
                      </div>
                      <div class="p-4">
                        <div class="space-y-3">
                          <template x-for="booking in timeline.bookings" :key="booking.bookingNumber">
                            <div
                              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer"
                              @click="showBookingDetail(booking)">
                              <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                  <i class="fas fa-calendar-check text-blue-600"></i>
                                </div>
                                <div>
                                  <p class="font-semibold text-gray-800" x-text="booking.bookingNumber"></p>
                                  <p class="text-sm text-gray-600" x-text="booking.customerName"></p>
                                </div>
                              </div>
                              <div class="text-right">
                                <p class="text-sm font-medium text-gray-700"
                                  x-text="`${formatThaiDateShort(booking.startDate)} - ${formatThaiDateShort(booking.endDate)}`">
                                </p>
                                <p class="text-xs text-gray-500"
                                  x-text="calculateDays(booking.startDate, booking.endDate) + ' วัน'"></p>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>

              <!-- ผลการค้นหา: Comparison View -->
              <div x-show="timeline.viewMode === 'comparison' && !timeline.isLoading" x-cloak class="mt-6">
                <!-- ปุ่มกลับ -->
                <div class="mb-4">
                  <button @click="backToSingleView()"
                    class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 flex items-center space-x-2 transition-colors">
                    <i class="fas fa-arrow-left"></i>
                    <span>กลับไปดูรถคันเดียว</span>
                  </button>
                </div>

                <template x-if="timeline.similarCars.length === 0">
                  <div class="text-center py-12 bg-gray-50 rounded-lg border border-gray-200">
                    <i class="fas fa-car text-gray-300 text-5xl mb-4"></i>
                    <p class="text-lg text-gray-500">ไม่พบรถรุ่นเดียวกัน</p>
                  </div>
                </template>

                <template x-if="timeline.similarCars.length > 0">
                  <div>
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4 rounded-t-lg">
                      <h4 class="text-lg font-semibold text-white flex items-center">
                        <i class="fas fa-cars mr-2"></i>
                        <span
                          x-text="'เปรียบเทียบรถรุ่นเดียวกัน - ' + timeline.selectedCar.split('(')[0].trim() + ' (' + getFilteredSimilarCars().length + '/' + timeline.similarCars.length + ' คัน)'"></span>
                      </h4>
                    </div>

                    <!-- Filter Section -->
                    <div class="bg-white border-x border-gray-200 px-6 py-4 border-b">
                      <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                          <i class="fas fa-filter text-green-600"></i>
                          <label class="text-sm font-medium text-gray-700">กรองตามวันที่ว่าง:</label>
                        </div>
                        <select x-model="timeline.comparisonFilterDate"
                          @change="console.log('Filter changed:', timeline.comparisonFilterDate)"
                          class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                          <option value="">ทุกคัน (ไม่กรอง)</option>
                          <template x-for="day in (timeline.summary?.totalDays || 30)" :key="'filter-day-' + day">
                            <option :value="day"
                              x-text="'วันที่ ' + day + ' ' + getMonthNameThai(timeline.selectedMonth)"></option>
                          </template>
                        </select>
                        <div x-show="timeline.comparisonFilterDate !== ''" class="text-sm text-gray-600">
                          <i class="fas fa-info-circle text-blue-500"></i>
                          <span>แสดงเฉพาะรถที่ว่างในวันที่เลือก</span>
                        </div>
                      </div>
                    </div>

                    <!-- Comparison Chart -->
                    <div class="bg-white border-x border-gray-200 p-6">
                      <h5 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                        กราฟเปรียบเทียบการเช่า
                      </h5>
                      <div class="space-y-4">
                        <template x-for="carData in getFilteredSimilarCars()" :key="carData.car.plate">
                          <div class="flex items-center space-x-4">
                            <!-- Car Name -->
                            <div class="w-48 flex-shrink-0">
                              <p class="text-sm font-semibold text-gray-800 truncate"
                                x-text="carData.car.fullName.split('(')[0].trim()"></p>
                              <p class="text-xs text-gray-500" x-text="carData.car.plate"></p>
                            </div>

                            <!-- Bar Chart -->
                            <div class="flex-1 flex items-center space-x-2">
                              <!-- Rented Days Bar -->
                              <div class="flex items-center flex-1">
                                <div class="relative w-full h-10 bg-gray-100 rounded-lg overflow-hidden">
                                  <div
                                    class="absolute left-0 top-0 h-full bg-gradient-to-r from-green-400 to-green-500 flex items-center justify-center transition-all duration-500"
                                    :style="`width: ${(carData.summary.rentedDays / carData.summary.totalDays * 100)}%;`">
                                    <span class="text-white text-xs font-bold" x-show="carData.summary.rentedDays > 0"
                                      x-text="carData.summary.rentedDays + ' วัน'"></span>
                                  </div>
                                  <div class="absolute right-0 top-0 h-full flex items-center justify-center"
                                    :style="`width: ${(carData.summary.freeDays / carData.summary.totalDays * 100)}%;`">
                                    <span class="text-gray-500 text-xs font-medium"
                                      x-show="carData.summary.freeDays > 0"
                                      x-text="carData.summary.freeDays + ' วัน'"></span>
                                  </div>
                                </div>
                              </div>

                              <!-- Percentage -->
                              <div class="w-20 flex-shrink-0 text-right">
                                <p class="text-sm font-bold text-green-600"
                                  x-text="Math.round((carData.summary.rentedDays / carData.summary.totalDays) * 100) + '%'">
                                </p>
                                <p class="text-xs text-gray-500">อัตราการเช่า</p>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Legend -->
                      <div class="mt-6 flex items-center justify-center space-x-6 text-sm">
                        <div class="flex items-center space-x-2">
                          <div class="w-4 h-4 bg-gradient-to-r from-green-400 to-green-500 rounded"></div>
                          <span class="text-gray-600">วันที่เช่า</span>
                        </div>
                        <div class="flex items-center space-x-2">
                          <div class="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                          <span class="text-gray-600">วันว่าง</span>
                        </div>
                      </div>
                    </div>

                    <!-- Comparison Grid -->
                    <div class="bg-white border border-gray-200 rounded-b-lg overflow-x-auto">
                      <div class="p-6">
                        <div class="space-y-6">
                          <template x-for="(carData, carIndex) in getFilteredSimilarCars()" :key="carData.car.plate">
                            <div class="border border-gray-300 rounded-lg overflow-hidden">
                              <!-- Car Header -->
                              <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-3 border-b border-gray-300">
                                <div class="flex items-center justify-between">
                                  <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center">
                                      <i class="fas fa-car text-blue-600"></i>
                                    </div>
                                    <div>
                                      <h5 class="font-semibold text-gray-800" x-text="carData.car.fullName"></h5>
                                      <p class="text-xs text-gray-600" x-text="'ทะเบียน: ' + carData.car.plate"></p>
                                    </div>
                                  </div>
                                  <div class="text-right">
                                    <span class="text-sm font-medium"
                                      :class="carData.summary.rentedDays === 0 ? 'text-green-600' : 'text-blue-600'"
                                      x-text="carData.summary.rentedDays === 0 ? 'ว่างทั้งเดือน' : 'มีการจอง'">
                                    </span>
                                  </div>
                                </div>
                              </div>

                              <!-- Statistics Cards -->
                              <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                <div class="grid grid-cols-3 gap-3">
                                  <div class="text-center">
                                    <p class="text-xs text-gray-600 mb-1">วันทั้งหมด</p>
                                    <p class="text-lg font-bold text-blue-600" x-text="carData.summary.totalDays"></p>
                                  </div>
                                  <div class="text-center">
                                    <p class="text-xs text-gray-600 mb-1">วันที่เช่า</p>
                                    <p class="text-lg font-bold text-green-600" x-text="carData.summary.rentedDays"></p>
                                    <p class="text-xs text-gray-500"
                                      x-text="Math.round((carData.summary.rentedDays / carData.summary.totalDays) * 100) + '%'">
                                    </p>
                                  </div>
                                  <div class="text-center">
                                    <p class="text-xs text-gray-600 mb-1">วันว่าง</p>
                                    <p class="text-lg font-bold text-gray-600" x-text="carData.summary.freeDays"></p>
                                  </div>
                                </div>
                              </div>

                              <!-- Timeline -->
                              <div class="p-4">
                                <template x-if="carData.bookings.length === 0">
                                  <div class="text-center py-6 text-gray-500">
                                    <i class="fas fa-check-circle text-green-400 text-3xl mb-2"></i>
                                    <p class="text-sm">ไม่มีการจองในเดือนนี้</p>
                                  </div>
                                </template>

                                <template x-if="carData.bookings.length > 0">
                                  <div>
                                    <!-- Mini Timeline Grid -->
                                    <div class="overflow-x-auto">
                                      <div class="inline-block min-w-full">
                                        <!-- Day Numbers Header -->
                                        <div class="grid gap-1 mb-2"
                                          :style="`grid-template-columns: repeat(${carData.summary.totalDays}, minmax(30px, 1fr));`">
                                          <template x-for="day in carData.summary.totalDays"
                                            :key="'day-' + carIndex + '-' + day">
                                            <div class="text-center">
                                              <div class="text-xs text-gray-500" x-text="day"></div>
                                            </div>
                                          </template>
                                        </div>

                                        <!-- Timeline Bars -->
                                        <div class="relative h-auto"
                                          :style="`min-height: ${carData.bookings.length * 50 + 30}px;`">
                                          <!-- Background Grid -->
                                          <div class="absolute inset-0 grid gap-1"
                                            :style="`grid-template-columns: repeat(${carData.summary.totalDays}, minmax(30px, 1fr));`">
                                            <template x-for="day in carData.summary.totalDays"
                                              :key="'bg-' + carIndex + '-' + day">
                                              <div class="bg-gray-100 border-r border-gray-200 h-full"></div>
                                            </template>
                                          </div>

                                          <!-- Booking Bars -->
                                          <div class="relative">
                                            <template x-for="(booking, bookingIndex) in carData.bookings"
                                              :key="booking.bookingNumber">
                                              <div
                                                class="absolute h-12 rounded shadow cursor-pointer transition-all hover:shadow-lg hover:z-10"
                                                :style="getBookingStyle(booking, bookingIndex, timeline.selectedMonth, carData.summary.totalDays)"
                                                @click="showBookingDetail(booking)"
                                                :title="`${booking.bookingNumber} - ${booking.customerName}`">
                                                <div class="h-full flex items-center justify-center px-1">
                                                  <div class="text-center overflow-hidden">
                                                    <p class="text-xs font-bold text-white truncate"
                                                      x-text="booking.bookingNumber"></p>
                                                  </div>
                                                </div>
                                              </div>
                                            </template>
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                                    <!-- Booking List for this car -->
                                    <div class="mt-4 pt-4 border-t border-gray-200">
                                      <p class="text-sm font-medium text-gray-700 mb-2">รายการจอง (<span
                                          x-text="carData.bookings.length"></span> รายการ):</p>
                                      <div class="space-y-2">
                                        <template x-for="booking in carData.bookings"
                                          :key="booking.bookingNumber + '-list'">
                                          <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                                            <div>
                                              <span class="font-medium text-gray-800"
                                                x-text="booking.bookingNumber"></span>
                                              <span class="text-gray-600 ml-2"
                                                x-text="'- ' + booking.customerName"></span>
                                            </div>
                                            <div class="text-gray-600 text-xs"
                                              x-text="`${formatThaiDateShort(booking.startDate)} - ${formatThaiDateShort(booking.endDate)}`">
                                            </div>
                                          </div>
                                        </template>
                                      </div>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </template>
                        </div>

                        <!-- Legend -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                          <p class="text-sm font-medium text-gray-700 mb-2">คำอธิบาย:</p>
                          <div class="flex flex-wrap gap-4">
                            <div class="flex items-center">
                              <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                              <span class="text-sm text-gray-600">การจองปกติ</span>
                            </div>
                            <div class="flex items-center">
                              <div class="w-4 h-4 bg-orange-500 rounded mr-2"></div>
                              <span class="text-sm text-gray-600">กำลังเช่าอยู่</span>
                            </div>
                            <div class="flex items-center">
                              <div class="w-4 h-4 bg-gray-200 rounded mr-2"></div>
                              <span class="text-sm text-gray-600">วันว่าง</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
          <!-- สิ้นสุด Tab 2 -->

        </div>

        <!-- Modal รายละเอียด: 2 การ์ด -->
        <div x-show="showModelModal" x-cloak
          class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
          @click.self="closeModelDetail()">
          <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold text-blue-700">
                รายละเอียดรุ่น: <span x-text="selectedModel"></span>
              </h3>
              <button @click="closeModelDetail()" class="text-gray-500 hover:text-gray-800">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="space-y-6 overflow-y-auto max-h-[32rem]">
              <!-- การ์ด: ตารางรถว่างตลอดช่วง -->
              <div class="border border-emerald-200 rounded-lg shadow-sm">
                <div class="px-4 py-2 bg-emerald-600 text-white font-semibold rounded-t-lg">
                  ตารางรถว่างตลอดช่วง
                </div>
                <div class="p-4 overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ยี่ห้อ</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">รุ่น</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ทะเบียน</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">สี</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <template x-for="(car,i) in modelCarsFree" :key="`${car?.ทะเบียน||car?.รุ่น||'k'}-${i}`">
                        <tr>
                          <td class="px-4 py-2 text-sm" x-text="car.ยี่ห้อ"></td>
                          <td class="px-4 py-2 text-sm" x-text="car.รุ่น"></td>
                          <td class="px-4 py-2 text-sm" x-text="car.ทะเบียน"></td>
                          <td class="px-4 py-2 text-sm" x-text="car.สี"></td>
                        </tr>
                      </template>
                      <template x-if="modelCarsFree.length === 0">
                        <tr>
                          <td colspan="4" class="px-4 py-6 text-center text-gray-500">ไม่มีข้อมูล</td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- การ์ด: รถที่จอง 1–2 วัน -->
              <div class="border border-amber-200 rounded-lg shadow-sm"
                x-show="modelCarsShort.length > 0 || modalType==='short'">
                <div class="px-4 py-2 bg-amber-500 text-white font-semibold rounded-t-lg">
                  รถที่จอง 1-2 วัน
                </div>
                <div class="p-4 overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ยี่ห้อ</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">รุ่น</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">ทะเบียน</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">สี</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">รับรถ</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">คืนรถ</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <template x-for="(car,i) in modelCarsShort"
                        :key="`${car?.ทะเบียน||car?.รุ่น||'k'}-${car?.pickup||''}-${car?.return||''}-${i}`">
                        <tr>
                          <td class="px-4 py-2 text-sm" x-text="car.ยี่ห้อ"></td>
                          <td class="px-4 py-2 text-sm" x-text="car.รุ่น"></td>
                          <td class="px-4 py-2 text-sm" x-text="car.ทะเบียน"></td>
                          <td class="px-4 py-2 text-sm" x-text="car.สี"></td>
                          <td class="px-4 py-2 text-sm" x-text="(car.pickup||'') + ' ' + (car.pickupTime||'')"></td>
                          <td class="px-4 py-2 text-sm" x-text="(car.return||'') + ' ' + (car.returnTime||'')"></td>
                        </tr>
                      </template>
                      <template x-if="modelCarsShort.length === 0">
                        <tr>
                          <td colspan="6" class="px-4 py-6 text-center text-gray-500">ไม่มีข้อมูล</td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Toast -->
        <div x-show="showToast" x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 transform translate-y-2"
          x-transition:enter-end="opacity-100 transform translate-y-0"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 transform translate-y-0"
          x-transition:leave-end="opacity-0 transform translate-y-2" @click="showToast = false"
          class="fixed bottom-4 right-4 z-50 bg-green-600 text-white px-6 py-3 rounded-md shadow-lg cursor-pointer"
          x-cloak>
          <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span x-text="toastMessage"></span>
          </div>
        </div>

        <!-- Modal เสนอราคาเช่ารถ -->
        <div x-show="showQuoteModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto"
          @click.self="closeQuoteModal()">
          <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl my-8" @click.stop>
              <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-4 rounded-t-lg">
                <div class="flex justify-between items-center">
                  <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-file-invoice-dollar mr-3"></i>
                    เสนอราคาเช่ารถ
                  </h3>
                  <button @click="closeQuoteModal()" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-2xl"></i>
                  </button>
                </div>
              </div>

              <div class="p-6 space-y-4">
                <!-- ข้อมูลรถ -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <label class="block text-sm font-semibold text-blue-800 mb-2">รถ</label>
                  <input type="text" x-model="quoteData.รถ" readonly
                    class="w-full px-4 py-2 border border-blue-300 rounded-md bg-white text-gray-700 font-medium">
                </div>

                <!-- วันที่รับรถและเวลา -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">วันที่รับรถ</label>
                    <input type="text" x-model="quoteData.วันที่รับรถ" readonly
                      class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เวลารับรถ</label>
                    <input type="text" x-model="quoteData.เวลารับรถ" readonly
                      class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50">
                  </div>
                </div>

                <!-- วันที่คืนรถและเวลา -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">วันที่คืนรถ</label>
                    <input type="text" x-model="quoteData.วันที่คืนรถ" readonly
                      class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เวลาคืนรถ</label>
                    <input type="text" x-model="quoteData.เวลาคืนรถ" readonly
                      class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50">
                  </div>
                </div>

                <!-- จำนวนวัน -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนวัน</label>
                  <input type="text" x-model="quoteData.จำนวนวัน" readonly
                    class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 font-semibold">
                </div>

                <!-- ราคาเช่าต่อวัน และ ค่าเช่ารวมทั้งหมด (แถวเดียวกัน) -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ราคาเช่าต่อวัน</label>
                    <input type="number" x-model.number="rawQuoteData.dailyRate" @input="recalculateQuote()"
                      class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white text-green-600 font-semibold focus:ring-2 focus:ring-green-500 focus:border-green-500"
                      placeholder="0">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ค่าเช่ารวมทั้งหมด</label>
                    <input type="text" :value="formatCurrency(rawQuoteData.totalRent)" readonly
                      class="w-full px-4 py-2 border border-blue-400 rounded-md bg-blue-50 text-blue-700 font-bold text-lg">
                  </div>
                </div>

                <!-- ค่ามัดจำคิวรถ และ ค่าประกันความเสียหาย (แถวเดียวกัน) -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ค่ามัดจำคิวรถ</label>
                    <input type="number" x-model.number="rawQuoteData.bookingDeposit" @input="recalculateQuote()"
                      class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white text-purple-600 font-semibold focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      placeholder="0">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ค่าประกันความเสียหาย</label>
                    <input type="number" x-model.number="rawQuoteData.depositAmount" @input="recalculateQuote()"
                      class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white text-orange-600 font-semibold focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      placeholder="0">
                  </div>
                </div>

                <!-- ส่วนลด -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">ส่วนลด</label>
                  <input type="number" x-model.number="rawQuoteData.discount" @input="recalculateQuote()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white text-red-600 font-semibold focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    placeholder="0">
                </div>

                <!-- รวมชำระวันรับรถ -->
                <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                  <label class="block text-sm font-semibold text-green-800 mb-2">รวมชำระวันรับรถ</label>
                  <div class="text-2xl font-bold text-green-700" x-text="formatCurrency(rawQuoteData.totalPayOnPickup)">
                  </div>
                  <p class="text-xs text-gray-600 mt-1">ค่าเช่ารวม + ค่าประกัน - ส่วนลด - ค่ามัดจำคิวรถ</p>
                </div>

                <!-- ปุ่มสร้างข้อความเสนอราคา -->
                <div class="pt-4">
                  <button @click="generateQuoteMessage()"
                    class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-6 rounded-md font-semibold shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                    <i class="fas fa-magic mr-2"></i>
                    สร้างข้อความเสนอราคา
                  </button>
                </div>

                <!-- พื้นที่แสดงข้อความเสนอราคา -->
                <div x-show="quoteMessageGenerated" x-transition class="pt-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">ข้อความเสนอราคา</label>
                  <textarea x-model="generatedQuoteMessage" rows="12"
                    class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>

                  <!-- ปุ่มคัดลอก -->
                  <button @click="copyQuoteMessage()"
                    class="mt-3 w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 px-6 rounded-md font-semibold shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                    <i class="fas mr-2" :class="quoteCopied ? 'fa-check' : 'fa-copy'"></i>
                    <span x-text="quoteCopied ? 'คัดลอกแล้ว!' : 'คัดลอกข้อความ'"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>




    <!-- หน้าตารางรับส่งรถ -->
    <div x-show="currentPage === 'schedule'" x-cloak class="mt-0">
      <div class="mb-6">
        <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4" style="border-color: #B0F0A5;">
          <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5"
            style="background-color: #B0F0A5;">
            <i class="fas fa-calendar-days text-white text-2xl"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800">ข้อมูลตารางการเช่ารถ</h2>
            <p class="mt-1 text-gray-600">
              <i class="fas fa-map-location-dot mr-2" style="color: #B0F0A5;"></i>ตารางการเช่า และรับส่งรถประจำวัน
            </p>
          </div>
        </div>
      </div>






      <div class="bg-white rounded-xl shadow-md relative p-4 mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
          <i class="fas fa-search mr-2 text-blue-500"></i>
          ค้นหารายการจากหมายเลขการจอง
        </h3>
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="text" x-model="scheduleSearchQuery" @keyup.enter="searchScheduleByBookingNumber()"
            @input="scheduleSearchQuery = $event.target.value.toUpperCase()" placeholder="กรอกหมายเลขการจอง..."
            class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">

          <button @click="searchScheduleByBookingNumber()" :disabled="isSearchingSchedule"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center justify-center transition-colors shadow-sm disabled:bg-blue-300">
            <i class="fas" :class="isSearchingSchedule ? 'fa-spinner fa-spin' : 'fa-search'"></i>
            <span class="ml-2" x-text="isSearchingSchedule ? 'กำลังค้นหา...' : 'ค้นหา'"></span>
          </button>

          <button @click="clearScheduleSearch()" x-show="scheduleSearchResults.bookingNumber"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md flex items-center justify-center transition-colors shadow-sm">
            <i class="fas fa-times mr-2"></i>ล้างการค้นหา
          </button>
        </div>
      </div>

      <div x-show="scheduleSearchResults.bookingNumber" x-cloak>
        <div class="bg-white rounded-lg shadow-md relative mt-6 p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">
            ผลการค้นหาสำหรับ: <span class="text-blue-600" x-text="scheduleSearchResults.bookingNumber"></span>
          </h3>
          <div class="relative border-l-2 border-blue-200 ml-4 pb-8">
            <template
              x-for="item in [...scheduleSearchResults.pickups, ...scheduleSearchResults.returns].sort((a,b) => new Date(a.วันที่) - new Date(b.วันที่))"
              :key="item.id">
              <div class="timeline-item" @click="openScheduleDetailsModal(item)">
                <div class="timeline-dot"
                  :class="{ 'bg-green-600': item.ประเภท === 'รับรถ', 'bg-orange-600': item.ประเภท === 'ส่งคืนรถ' }">
                  <i
                    :class="{ 'fas text-white text-xs': true, 'fa-arrow-up': item.ประเภท === 'รับรถ', 'fa-arrow-down': item.ประเภท === 'ส่งคืนรถ' }"></i>
                </div>
                <div class="timeline-content-wrapper">
                  <div class="timeline-content relative"
                    :class="{ 'bg-green-50 border-green-200': item.ประเภท === 'รับรถ', 'bg-orange-50 border-orange-200': item.ประเภท === 'ส่งคืนรถ' }">
                    <div class="flex justify-between items-center">
                      <div class="timeline-time" x-text="formatDate(item.วันที่) + ' ' + formatTime(item.เวลา) + ' น.'">
                      </div>
                      <div class="text-xs font-medium"
                        :class="{'text-green-600': item.ประเภท === 'รับรถ', 'text-orange-600': item.ประเภท === 'ส่งคืนรถ'}"
                        x-text="item.ประเภท"></div>
                    </div>
                    <div class="timeline-info mt-2">
                      <div class="font-medium" x-text="item.รถ"></div>
                      <div class="text-sm text-gray-600" x-text="item.ชื่อลูกค้า"></div>
                    </div>
                    <button @click.stop="openHandoverModal(item)"
                      class="absolute bottom-2 right-2 px-3 py-1.5 text-xs rounded-md shadow-sm transition-all hover:shadow-md"
                      :class="{ 'bg-green-600 hover:bg-green-700 text-white': item.ประเภท === 'รับรถ', 'bg-orange-600 hover:bg-orange-700 text-white': item.ประเภท === 'ส่งคืนรถ' }">
                      <i class="fas fa-camera mr-1"></i>
                      <span x-text="item.ประเภท === 'รับรถ' ? 'บันทึกการส่งรถ' : 'บันทึกการคืนรถ'"></span>
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div x-show="!scheduleSearchResults.bookingNumber" x-cloak>
        <div class="bg-white rounded-xl shadow-md relative p-4">
          <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3">
            <div>
              <label for="schedule-date-picker" class="block text-sm font-medium text-gray-700 mb-1">เลือกวันที่</label>
              <input type="date" id="schedule-date-picker" x-model="selectedScheduleDateString"
                @change="fetchScheduleForDate()"
                class="px-3 py-2 bg-white border border-gray-300 shadow-sm rounded-md text-gray-700 hover:bg-blue-50 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
            </div>
            <div class="flex space-x-2">
              <button @click="copyScheduleSummaryToClipboard"
                class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-md flex items-center text-sm transition-colors shadow-sm"><i
                  class="fas fa-copy mr-2"></i>คัดลอก</button>
              <button @click="generateDailySchedulePDF"
                class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md flex items-center text-sm transition-colors shadow-sm"><i
                  class="fas fa-file-pdf mr-2"></i>สร้างPDF</button>
              <button @click="shareScheduleSummary"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md flex items-center text-sm transition-colors shadow-sm"><i
                  class="fas fa-share-alt mr-2"></i>แชร์</button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div class="bg-green-50 rounded-lg p-3 border border-green-200 shadow-sm flex items-center">
              <div class="bg-green-100 p-3 rounded-full mr-3"><i class="fas fa-arrow-up text-green-600 text-xl"></i>
              </div>
              <div>
                <div class="text-sm text-gray-600">รับรถวันนี้</div>
                <div class="text-2xl font-bold text-green-600" x-text="pickupsForSelectedDate.length"></div>
              </div>
            </div>
            <div class="bg-orange-50 rounded-lg p-3 border border-orange-200 shadow-sm flex items-center">
              <div class="bg-orange-100 p-3 rounded-full mr-3"><i class="fas fa-arrow-down text-orange-600 text-xl"></i>
              </div>
              <div>
                <div class="text-sm text-gray-600">ส่งคืนรถวันนี้</div>
                <div class="text-2xl font-bold text-orange-600" x-text="returnsForSelectedDate.length"></div>
              </div>
            </div>
          </div>
        </div>



        <div class="bg-white rounded-lg shadow-md relative mt-6 p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ไทม์ไลน์รายการรับส่งรถ</h3>
          <div x-show="isLoading" class="flex justify-center items-center py-8">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
          </div>
          <div x-show="!isLoading">
            <div x-show="!sortedScheduleForTimeline || sortedScheduleForTimeline.length === 0"
              class="text-center py-8 text-gray-500">
              <i class="fas fa-calendar-times text-4xl mb-3 text-gray-300"></i>
              <p>ไม่พบรายการในวันที่เลือก</p>
            </div>
            <div x-show="sortedScheduleForTimeline && sortedScheduleForTimeline.length > 0"
              class="relative border-l-2 border-blue-200 ml-4 pb-8">
              <template x-for="item in sortedScheduleForTimeline" :key="item.id">
                <div class="timeline-item" @click="openScheduleDetailsModal(item)">
                  <div class="timeline-dot"
                    :class="{ 'bg-green-600': item.ประเภท === 'รับรถ', 'bg-orange-600': item.ประเภท === 'ส่งคืนรถ' }">
                    <i
                      :class="{ 'fas text-white text-xs': true, 'fa-arrow-up': item.ประเภท === 'รับรถ', 'fa-arrow-down': item.ประเภท === 'ส่งคืนรถ' }"></i>
                  </div>
                  <div class="timeline-content-wrapper">
                    <div class="timeline-content relative"
                      :class="{ 'bg-green-50 border-green-200': item.ประเภท === 'รับรถ', 'bg-orange-50 border-orange-200': item.ประเภท === 'ส่งคืนรถ' }">

                      <div class="flex justify-between items-center">
                        <div class="timeline-time" x-text="formatTime(item.เวลา)"></div>
                        <div class="flex items-center space-x-2">
                          <div class="text-xs font-medium"
                            :class="{'text-green-600': item.ประเภท === 'รับรถ', 'text-orange-600': item.ประเภท === 'ส่งคืนรถ'}"
                            x-text="item.ประเภท"></div>
                        </div>
                      </div>

                      <div class="timeline-info mt-2">
                        <div class="font-medium" x-text="item.รถ"></div>
                        <div class="text-sm text-gray-600" x-text="item.ชื่อลูกค้า"></div>
                        <div class="text-xs mt-1 text-gray-500" x-text="'#' + item.หมายเลขการจอง"></div>
                        <div x-show="item.ประเภท === 'รับรถ'" class="text-sm text-gray-600 mt-1 flex items-center">
                          <i class="fas fa-map-marker-alt mr-2 text-green-600"></i><span
                            x-text="item.สถานที่รับรถ || 'ไม่มีข้อมูล'"></span>
                        </div>
                        <div x-show="item.ประเภท === 'ส่งคืนรถ'" class="text-sm text-gray-600 mt-1 flex items-center">
                          <i class="fas fa-map-marker-alt mr-2 text-orange-600"></i><span
                            x-text="item.สถานที่คืนรถ || 'ไม่มีข้อมูล'"></span>
                        </div>

                        <div class="mt-2 flex flex-wrap gap-2">
                          <template x-if="item.ต้องการคาร์ซีท">
                            <span
                              class="inline-flex items-center bg-purple-100 text-purple-800 text-xs font-bold px-2.5 py-1 rounded-full">
                              <i class="fas fa-baby mr-2"></i>
                              <span>คาร์ซีท</span>
                            </span>
                          </template>
                          <template x-if="item.ต้องการประกันเสริม">
                            <span
                              class="inline-flex items-center bg-teal-100 text-teal-800 text-xs font-bold px-2.5 py-1 rounded-full">
                              <i class="fas fa-shield-alt mr-2"></i>
                              <span>ประกันเสริม</span>
                            </span>
                          </template>
                          <template x-if="item.ReceiptInfo && JSON.parse(item.ReceiptInfo).wantsCashBill">
                            <span
                              class="inline-flex items-center bg-orange-100 text-orange-800 text-xs font-bold px-2.5 py-1 rounded-full">
                              <i class="fas fa-money-bill-wave mr-2"></i>
                              <span>บิลเงินสด</span>
                            </span>
                          </template>
                          <template x-if="item.ReceiptInfo && JSON.parse(item.ReceiptInfo).wantsTaxInvoice">
                            <span
                              class="inline-flex items-center bg-green-100 text-green-800 text-xs font-bold px-2.5 py-1 rounded-full">
                              <i class="fas fa-file-invoice-dollar mr-2"></i>
                              <span>ใบกำกับภาษี</span>
                            </span>
                          </template>
                          <template x-if="item.ReceiptInfo && JSON.parse(item.ReceiptInfo).wantsWHT">
                            <span
                              class="inline-flex items-center bg-indigo-100 text-indigo-800 text-xs font-bold px-2.5 py-1 rounded-full">
                              <i class="fas fa-receipt mr-2"></i>
                              <span>หัก ณ ที่จ่าย</span>
                            </span>
                          </template>
                        </div>
                      </div>
                      <button @click.stop="openHandoverModal(item)"
                        class="absolute bottom-2 right-2 px-3 py-1.5 text-xs rounded-md shadow-sm transition-all hover:shadow-md"
                        :class="{ 'bg-green-600 hover:bg-green-700 text-white': item.ประเภท === 'รับรถ', 'bg-orange-600 hover:bg-orange-700 text-white': item.ประเภท === 'ส่งคืนรถ' }">
                        <i class="fas fa-camera mr-1"></i>
                        <span x-text="item.ประเภท === 'รับรถ' ? 'บันทึกการส่งรถ' : 'บันทึกการคืนรถ'"></span>
                      </button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>



      </div>








      <!-- ส่วนที่ 2: โมดัลบันทึกการรับส่งรถ -->
      <!-- เพิ่มในส่วนท้ายของ index.html ก่อน </body> -->

      <!-- โมดัลบันทึกการรับส่งรถ -->
      <div x-show="showHandoverModal" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0" x-transition:leave-end="resetHandoverData()"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;"
        x-cloak>
        <div class="relative top-0 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white mt-10 mb-10">

          <div class="flex justify-between items-center border-b pb-4 mb-6">
            <h3 class="text-xl font-bold" :class="{
        'text-green-600': handoverData.ประเภท === 'รับรถ',
        'text-orange-600': handoverData.ประเภท === 'ส่งคืนรถ'
      }">
              <i :class="{
          'fas fa-arrow-up mr-2': handoverData.ประเภท === 'รับรถ',
          'fas fa-arrow-down mr-2': handoverData.ประเภท === 'ส่งคืนรถ'
        }"></i>
              <span x-text="handoverData.ประเภท === 'รับรถ' ? 'บันทึกการส่งรถ' : 'บันทึกการคืนรถ'"></span>
            </h3>
            <button @click="closeHandoverModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">หมายเลขการจอง</label>
              <input type="text" x-model="handoverData.หมายเลขการจอง" readonly
                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-700">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อรถ</label>
              <input type="text" x-model="handoverData.รถ" readonly
                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-700">
            </div>

          </div>

          <div x-show="handoverData.recordedBy"
            class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg flex items-center space-x-3">

            <div class="flex-shrink-0 bg-blue-100 p-2 rounded-full">
              <i class="fas fa-user-edit text-blue-600"></i>
            </div>

            <div class="flex flex-col">
              <span class="text-xs text-gray-500">ข้อมูลล่าสุดบันทึกโดย:</span>
              <strong class="text-sm font-semibold text-gray-800" x-text="handoverData.recordedBy"></strong>
            </div>

          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">เลขไมล์รถ (กิโลเมตร)</label>
            <input type="number" x-model="handoverData.เลขไมล์" placeholder="กรอกเลขไมล์รถ"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="mb-6">
            <h4 class="text-lg font-semibold mb-4 text-gray-800">การถ่ายรูปเพื่อบันทึกหลักฐาน</h4>

            <div x-show="handoverData.ประเภท === 'รับรถ'" class="mb-4 p-3 border rounded-lg">
              <label class="block text-sm font-medium text-gray-700 mb-2">รูปลูกค้าคู่กับรถ</label>
              <div class="flex items-center space-x-3">
                <button @click="takePhoto('customer')"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                  <i class="fas fa-camera mr-2"></i>ถ่ายรูปลูกค้า
                </button>
                <a x-show="handoverData.existingPhotos.customer" :href="handoverData.existingPhotos.customer"
                  target="_blank"
                  class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-xs transition-colors">
                  <i class="fas fa-eye mr-1"></i>ดูรูปเดิม
                </a>
                <span x-show="handoverData.photos.customer" class="text-green-600 text-xs flex items-center">
                  <i class="fas fa-check-circle mr-1"></i>ถ่ายรูปใหม่แล้ว
                </span>
              </div>
            </div>

            <div class="mb-4 p-3 border rounded-lg">
              <label class="block text-sm font-medium text-gray-700 mb-2">รูปเรือนไมล์</label>
              <div class="flex items-center space-x-3">
                <button @click="takePhoto('speedometer')"
                  class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors">
                  <i class="fas fa-camera mr-2"></i>ถ่ายรูปเรือนไมล์
                </button>
                <a x-show="handoverData.existingPhotos.speedometer" :href="handoverData.existingPhotos.speedometer"
                  target="_blank"
                  class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-xs transition-colors">
                  <i class="fas fa-eye mr-1"></i>ดูรูปเดิม
                </a>
                <span x-show="handoverData.photos.speedometer" class="text-green-600 text-xs flex items-center">
                  <i class="fas fa-check-circle mr-1"></i>ถ่ายรูปใหม่แล้ว
                </span>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div class="p-3 border rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2">รูปรถด้านหน้า</label>
                <div class="flex flex-col items-start space-y-2">
                  <button @click="takePhoto('front')"
                    class="w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors text-sm">
                    <i class="fas fa-camera mr-1"></i>ถ่ายรูป
                  </button>
                  <a x-show="handoverData.existingPhotos.front" :href="handoverData.existingPhotos.front"
                    target="_blank"
                    class="w-full text-center px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-xs transition-colors">
                    <i class="fas fa-eye mr-1"></i>ดูรูปเดิม
                  </a>
                  <span x-show="handoverData.photos.front" class="text-green-600 text-xs flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>ถ่ายใหม่แล้ว
                  </span>
                </div>
              </div>

              <div class="p-3 border rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2">รูปรถด้านหลัง</label>
                <div class="flex flex-col items-start space-y-2">
                  <button @click="takePhoto('back')"
                    class="w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors text-sm">
                    <i class="fas fa-camera mr-1"></i>ถ่ายรูป
                  </button>
                  <a x-show="handoverData.existingPhotos.back" :href="handoverData.existingPhotos.back" target="_blank"
                    class="w-full text-center px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-xs transition-colors">
                    <i class="fas fa-eye mr-1"></i>ดูรูปเดิม
                  </a>
                  <span x-show="handoverData.photos.back" class="text-green-600 text-xs flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>ถ่ายใหม่แล้ว
                  </span>
                </div>
              </div>

              <div class="p-3 border rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2">รูปรถด้านซ้าย</label>
                <div class="flex flex-col items-start space-y-2">
                  <button @click="takePhoto('left')"
                    class="w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors text-sm">
                    <i class="fas fa-camera mr-1"></i>ถ่ายรูป
                  </button>
                  <a x-show="handoverData.existingPhotos.left" :href="handoverData.existingPhotos.left" target="_blank"
                    class="w-full text-center px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-xs transition-colors">
                    <i class="fas fa-eye mr-1"></i>ดูรูปเดิม
                  </a>
                  <span x-show="handoverData.photos.left" class="text-green-600 text-xs flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>ถ่ายใหม่แล้ว
                  </span>
                </div>
              </div>

              <div class="p-3 border rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2">รูปรถด้านขวา</label>
                <div class="flex flex-col items-start space-y-2">
                  <button @click="takePhoto('right')"
                    class="w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors text-sm">
                    <i class="fas fa-camera mr-1"></i>ถ่ายรูป
                  </button>
                  <a x-show="handoverData.existingPhotos.right" :href="handoverData.existingPhotos.right"
                    target="_blank"
                    class="w-full text-center px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-xs transition-colors">
                    <i class="fas fa-eye mr-1"></i>ดูรูปเดิม
                  </a>
                  <span x-show="handoverData.photos.right" class="text-green-600 text-xs flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>ถ่ายใหม่แล้ว
                  </span>
                </div>
              </div>
            </div>
          </div>



          <div class="signature-section" x-show="handoverData.ประเภท === 'รับรถ'">
            <h4 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
              <i class="fas fa-signature mr-2 text-blue-600"></i>
              การยืนยันและลงลายเซ็น
            </h4>

            <!-- Checkbox และปุ่มเงื่อนไขการเช่า -->



            <!-- Checkbox และปุ่มเงื่อนไขการเช่า พร้อมข้อความแจ้งเตือนสีแดง -->
            <div class="mb-4 p-3 border rounded-lg bg-blue-50">
              <label class="flex items-start space-x-3 cursor-pointer">
                <input type="checkbox" x-model="handoverData.termsAccepted"
                  class="mt-1 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                <div class="flex-1">
                  <span class="text-sm text-gray-700">
                    ฉันได้อ่านและเข้าใจเงื่อนไขสัญญาเช่าและได้เซ็นชื่อกำกับไว้แล้ว
                  </span>
                  <button type="button" @click="openRentalContract()"
                    class="ml-2 px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                    <i class="fas fa-file-pdf mr-1"></i>
                    ไฟล์สัญญาเช่า
                  </button>

                  <!-- ข้อความแจ้งเตือนสีแดง -->
                  <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded-md">
                    <p class="text-xs text-red-600 font-medium flex items-start">
                      <i class="fas fa-exclamation-triangle mr-2 mt-0.5 text-red-500"></i>
                      <span>
                        <strong>คำเตือน:</strong> ลายเซ็นนี้มีผลผูกพันทางกฎหมายเสมือนการเซ็นในสัญญาจริง
                      </span>
                    </p>
                  </div>
                </div>
              </label>
            </div>


            <!-- Canvas สำหรับลายเซ็น -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">ลายเซ็นผู้เช่า</label>
              <div class="border rounded-lg p-3 bg-white">
                <canvas id="signatureCanvas" width="400" height="150" class="signature-canvas w-full"
                  x-bind:class="{'signed': handoverData.signatureData}">
                </canvas>

                <div class="flex justify-between mt-3">
                  <button type="button" @click="clearSignature()"
                    class="px-3 py-1 text-sm bg-gray-500 hover:bg-gray-600 text-white rounded-md transition-colors">
                    <i class="fas fa-eraser mr-1"></i>ลบลายเซ็น
                  </button>

                  <div x-show="handoverData.existingSignature" class="text-xs text-green-600 flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>มีลายเซ็นเดิมอยู่แล้ว
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-end space-x-3 border-t pt-4">
            <button @click="closeHandoverModal()"
              class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
              ยกเลิก
            </button>
            <button @click="saveHandoverData()" x-bind:disabled="!isHandoverDataComplete()" x-bind:class="{
                'bg-green-600 hover:bg-green-700': handoverData.ประเภท === 'รับรถ' && isHandoverDataComplete(),
                'bg-orange-600 hover:bg-orange-700': handoverData.ประเภท === 'ส่งคืนรถ' && isHandoverDataComplete(),
                'bg-gray-400 cursor-not-allowed': !isHandoverDataComplete()
              }" class="px-6 py-2 text-white rounded-md transition-colors">
              <i class="fas fa-save mr-2"></i>บันทึกข้อมูล
            </button>
          </div>

          <input type="file" id="photoCapture" accept="image/*" capture="environment" style="display: none;"
            @change="handlePhotoCapture($event)">
        </div>
      </div>









      <!-- การ์ดตารางการเช่ารถ -->
      <div class="bg-white rounded-lg shadow-md relative mt-14 mx-4 mb-10">
        <!-- หัวข้อที่ยื่นออกมา -->
        <div class="absolute -top-4 left-8 bg-blue-700 text-white px-6 py-2 rounded-t-lg font-bold shadow-md">
          ตารางการเช่ารถ
        </div>

        <div class="pt-8 pb-5 px-6 mt-4">
          <div class="flex items-center">
            <div class="flex items-center justify-center w-14 h-14 bg-blue-100 rounded-full shadow-sm mr-5">
              <i class="fas fa-car-side text-blue-600 text-2xl"></i>
            </div>
            <div>
              <p class="text-gray-500 mt-1 flex items-center text-lg">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                เลือกเดือนและปีที่ต้องการดูรายละเอียดการเช่า
              </p>
              <div class="mt-2 flex space-x-2">
                <span class="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded-full">ตาราง</span>
                <span class="text-xs px-2 py-1 bg-gray-50 text-gray-600 rounded-full">ปฏิทิน</span>
              </div>
            </div>
          </div>
        </div>

        <div class="p-6 border-t border-gray-100">
          <!-- ส่วนควบคุม -->
          <!-- ปรับปรุงส่วนควบคุม -->
          <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex flex-col md:flex-row md:items-end space-y-4 md:space-y-0 md:space-x-4">
              <!-- เดือน และปี ด้วยปุ่มเลื่อนซ้าย-ขวา (เดิม) -->
              <div class="md:flex-1 flex items-center justify-between">
                <button @click="changeMonth(-1)"
                  class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition-colors">
                  <i class="fas fa-chevron-left"></i>
                </button>

                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                  <div class="text-2xl font-extrabold">
                    <span x-text="getMonthName(selectedScheduleMonth)"></span>
                    <span x-text="selectedScheduleYear"></span>
                  </div>
                </div>

                <button @click="changeMonth(1)"
                  class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition-colors">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>

              <!-- แถวปุ่ม -->
              <div class="md:flex-1 flex space-x-2">
                <button @click="toggleViewMode()"
                  class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center justify-center transition-colors">
                  <i class="fas" :class="viewMode === 'table' ? 'fa-calendar-alt' : 'fa-table'"></i>
                  <span class="ml-2" x-text="viewMode === 'table' ? 'มุมมองปฏิทิน' : 'มุมมองตาราง'"></span>
                </button>

                <!-- ปุ่มพิมพ์/ส่งออก PDF เปลี่ยนเป็นเปิด modal แทน -->
                <button @click="showPdfOptionsModal()"
                  class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center justify-center transition-colors">
                  <i class="fas fa-file-pdf mr-2"></i>
                  <span>สร้างรายการจองPDF</span>
                </button>
              </div>
            </div>
          </div>

          <!-- ส่วนแสดงสถานะและข้อมูล -->
          <div
            class="bg-gray-50 p-4 rounded-lg mb-4 flex justify-between items-center flex-wrap space-y-2 sm:space-y-0">
            <div>
              <h4 class="font-semibold">
                <span class="badge bg-blue-100 text-blue-800 py-1 px-2 rounded">
                  กำลังแสดง: <span x-text="getMonthName(selectedScheduleMonth) + ' ' + selectedScheduleYear"></span>
                  <span x-text="viewMode === 'table' ? ' (มุมมองตาราง)' : ' (มุมมองปฏิทิน)'"></span>
                </span>
              </h4>
            </div>
            <div class="flex space-x-4">
              <div class="flex items-center">
                <div class="w-4 h-4 bg-blue-400 rounded mr-2"></div>
                <span class="text-sm">จองแล้ว</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 bg-green-200 rounded mr-2"></div>
                <span class="text-sm">วันนี้</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 bg-orange-100 rounded mr-2"></div>
                <span class="text-sm">วันหยุด</span>
              </div>
            </div>
          </div>

          <!-- ตารางการจอง (มุมมองตาราง) -->
          <div x-show="viewMode === 'table'">
            <div x-show="isLoadingBookingTable" class="p-4 flex justify-center">
              <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
            </div>

            <!-- Desktop: Timeline View -->
            <div id="timelineView" x-show="!isLoadingBookingTable" class="hidden lg:block">
              <!-- จะถูกเติมด้วย JavaScript -->
            </div>

            <!-- Mobile/Tablet: Card Stack View -->
            <div id="cardStackView" x-show="!isLoadingBookingTable" class="lg:hidden space-y-4">
              <!-- จะถูกเติมด้วย JavaScript -->
            </div>
          </div>

          <!-- มุมมองปฏิทิน -->
          <div x-show="viewMode === 'calendar'">
            <div x-show="isLoadingBookingTable" class="p-4 flex justify-center">
              <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
            </div>

            <!-- Desktop: Split View (Calendar + Details) -->
            <div id="splitCalendarView" x-show="!isLoadingBookingTable" class="hidden lg:grid lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2">
                <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                  <!-- จะถูกเติมด้วย JavaScript -->
                </div>
              </div>
              <div id="dayDetailsPanel" class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                <h4 class="text-lg font-bold text-gray-800 mb-4">
                  <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                  รายละเอียดการเช่า
                </h4>
                <div id="dayDetailContent" class="space-y-3">
                  <p class="text-gray-500 text-center py-8">คลิกที่วันในปฏิทินเพื่อดูรายละเอียด</p>
                </div>
              </div>
            </div>

            <!-- Mobile/Tablet: Agenda View -->
            <div id="agendaView" x-show="!isLoadingBookingTable" class="lg:hidden space-y-4">
              <!-- จะถูกเติมด้วย JavaScript -->
            </div>
          </div>
        </div>
      </div>




      <!-- Modal for column selection and results -->
      <div x-show="showColumnSelectionModal" x-transition.opacity.duration.300ms
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50 p-4" x-cloak
        @click.self="closeColumnSelectionModal()">

        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full animate-fade-in-up transform transition-all"
          x-show="!isPdfGenerating && !isPdfGenerated">

          <div class="flex justify-between items-center pb-4 border-b">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center">
              <i class="fas fa-file-pdf text-blue-500 mr-3"></i>
              สร้าง PDF ตารางประจำวัน
            </h3>
            <button @click="closeColumnSelectionModal()" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="py-4">
            <p class="text-center text-gray-700 mb-4">
              กรองข้อมูลที่ต้องการพิมพ์สำหรับวันที่ <strong x-text="formatDate(selectedScheduleDateString)"
                class="text-blue-600"></strong>
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border">
              <div>
                <label for="pdf-location-filter" class="block text-sm font-medium text-gray-700 mb-1">สถานที่</label>
                <select id="pdf-location-filter" x-model="pdfFilter.location"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                  <option value="">แสดงทุกสถานที่</option>
                  <template x-for="loc in allLocations" :key="loc">
                    <option :value="loc" x-text="loc"></option>
                  </template>
                </select>
              </div>
              <div>
                <label for="pdf-car-filter" class="block text-sm font-medium text-gray-700 mb-1">รุ่นรถ</label>
                <select id="pdf-car-filter" x-model="pdfFilter.carModel"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                  <option value="">แสดงทุกรุ่น</option>
                  <template x-for="car in allCarModels" :key="car">
                    <option :value="car" x-text="car"></option>
                  </template>
                </select>
              </div>
            </div>

            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
              <p class="font-medium text-blue-800">สรุปรายการที่จะพิมพ์</p>
              <p class="text-sm text-gray-700">
                รับรถ: <span class="font-bold" x-text="filteredForPdf.pickups.length"></span> คัน,
                คืนรถ: <span class="font-bold" x-text="filteredForPdf.returns.length"></span> คัน
              </p>
            </div>
          </div>

          <div class="flex justify-end space-x-3 pt-4 border-t">
            <button @click="closeColumnSelectionModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
              ยกเลิก
            </button>
            <button @click="confirmDailyReportPDF()"
              class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 flex items-center">
              <i class="fas fa-file-pdf mr-2"></i>สร้าง PDF
            </button>
          </div>
        </div>

      </div>

      <!-- Loading overlay -->
      <div x-show="isPdfGenerating" x-transition.opacity.duration.300ms
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50" x-cloak>
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center animate-fade-in-up">
          <div class="flex justify-center items-center mb-6">
            <lottie-player src="https://assets9.lottiefiles.com/packages/lf20_usmfx6bp.json" background="transparent"
              speed="1" style="width: 90px; height: 90px;" loop autoplay
              class="animate-bounce-slow drop-shadow-xl hover:scale-105 transition-transform duration-300">
            </lottie-player>
          </div>

          <p class="text-xl font-semibold text-gray-800" x-text="pdfLoadingStep"></p>
          <p class="text-sm text-gray-600 mb-4">กรุณารอสักครู่ ระบบกำลังดำเนินการ...</p>

          <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden shadow-inner">
            <div class="bg-gradient-to-r from-blue-500 to-blue-700 h-full transition-all duration-500 ease-out"
              :style="`width: ${pdfLoadingProgress}%`"></div>
          </div>
        </div>
      </div>








    </div>



    <div x-show="currentPage === 'customers'" x-cloak>

      <div class="mb-6">
        <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4" style="border-color: #ffc107;">
          <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5"
            style="background-color: #ffc107;">
            <i class="fas fa-users-cog text-white text-2xl"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800">จัดการข้อมูลลูกค้า</h2>
            <p class="mt-1 text-gray-600">
              <i class="fas fa-database mr-2" style="color: #ffc107;"></i>ฐานข้อมูลลูกค้าทั้งหมดในระบบ
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">

          <div class="relative w-full md:w-1/2">
            <input type="text" x-model="customerSearchQuery" @input.debounce.500ms="filterCustomers()"
              placeholder="ค้นหาด้วยชื่อ, เบอร์โทร, เลขบัตร..." class="w-full pl-10 pr-4 py-2 border rounded-lg">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>

          <div class="w-full md:w-auto flex flex-col md:flex-row gap-2">

            <button @click="runCustomerOverviewAnalysis()" :disabled="isLoading"
              class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center">
              <span x-show="!isLoading"><i class="fas fa-chart-pie mr-2"></i>วิเคราะห์ภาพรวมลูกค้า</span>
              <span x-show="isLoading"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังวิเคราะห์...</span>
            </button>


            <button @click="openDbMaintenanceModal()"
              class="w-full md:w-auto bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
              <i class="fas fa-magic mr-2"></i>ปรับปรุงฐานข้อมูล
            </button>
            <button @click="openCustomerModal(null)"
              class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
              <i class="fas fa-user-plus mr-2"></i>เพิ่มลูกค้าใหม่
            </button>
          </div>

        </div>
      </div>




      <div x-show="customerOverviewData" x-transition
        class="mb-6 bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">

        <div>
          <h3 class="text-xl font-bold text-blue-600"><i class="fas fa-chart-pie mr-2"></i>ภาพรวมลูกค้า</h3>
          <p class="mt-1 mb-4 text-sm text-gray-600">วิเคราะห์ข้อมูลลูกค้าทั้งหมดเพื่อดูแนวโน้มและสถิติที่สำคัญ</p>
        </div>

        <template x-if="customerOverviewData">
          <div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <p class="text-2xl font-bold text-blue-600" x-text="customerOverviewData.keyMetrics.repeatCustomerRate">
                </p>
                <p class="text-sm text-gray-500">กลับมาใช้บริการซ้ำ</p>
              </div>
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <p class="text-2xl font-bold text-blue-600" x-text="customerOverviewData.keyMetrics.totalCustomers">
                </p>
                <p class="text-sm text-gray-500">ลูกค้าทั้งหมด</p>
              </div>
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <p class="text-2xl font-bold text-green-600"
                  x-text="customerOverviewData.keyMetrics.newCustomersThisMonth"></p>
                <p class="text-sm text-gray-500">ลูกค้าใหม่ (เดือนนี้)</p>
              </div>
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <p class="text-2xl font-bold text-red-600"
                  x-text="customerOverviewData.keyMetrics.blacklistedCustomers"></p>
                <p class="text-sm text-gray-500">ลูกค้า Blacklist</p>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="bg-white p-4 rounded-lg shadow-sm">
                <h4 class="font-semibold mb-3"><i class="fas fa-crown text-yellow-500"></i> ลูกค้าที่ใช้จ่ายสูงสุด
                  (Top 5)</h4>
                <ul class="space-y-2 text-sm">
                  <template x-for="(customer, i) in customerOverviewData.topCustomers.topSpenders"
                    :key="customer.customerId">
                    <li class="flex justify-between items-center">
                      <div>
                        <span x-text="`${i+1}. `" class="mr-1 text-gray-500"></span>
                        <button @click="openCustomerDetails(customer.customerId)"
                          class="text-blue-600 hover:text-blue-800 hover:underline text-left focus:outline-none">
                          <span x-text="customer.name"></span>
                          <span class="font-mono text-xs text-gray-400" x-text="`(${customer.customerId})`"></span>
                        </button>
                      </div>
                      <span class="font-mono text-green-600" x-text="formatCurrency(customer.total)"></span>
                    </li>
                  </template>
                </ul>
              </div>

              <div class="bg-white p-4 rounded-lg shadow-sm">
                <h4 class="font-semibold mb-3"><i class="fas fa-star text-blue-500"></i> ลูกค้าที่ใช้บริการบ่อยสุด
                  (Top 5)</h4>
                <ul class="space-y-2 text-sm">
                  <template x-for="(customer, i) in customerOverviewData.topCustomers.topFrequentRenters"
                    :key="customer.customerId">
                    <li class="flex justify-between items-center">
                      <div>
                        <span x-text="`${i+1}. `" class="mr-1 text-gray-500"></span>
                        <button @click="openCustomerDetails(customer.customerId)"
                          class="text-blue-600 hover:text-blue-800 hover:underline text-left focus:outline-none">
                          <span x-text="customer.name"></span>
                          <span class="font-mono text-xs text-gray-400" x-text="`(${customer.customerId})`"></span>
                        </button>
                      </div>
                      <span class="font-semibold" x-text="`${customer.count} ครั้ง`"></span>
                    </li>
                  </template>
                </ul>
              </div>

              <div class="bg-white p-4 rounded-lg shadow-sm space-y-4">
                <div>
                  <h4 class="font-semibold mb-2"><i class="fas fa-car text-purple-500"></i> รถยอดนิยม (Top 3)</h4>
                  <ul class="space-y-1 text-sm">
                    <template x-for="(car, i) in customerOverviewData.behavioralInsights.topCars" :key="i">
                      <li x-text="`${i+1}. ${car.name} (${car.count} ครั้ง)`"></li>
                    </template>
                  </ul>
                </div>
                <div>
                  <h4 class="font-semibold mb-2"><i class="fas fa-satellite-dish text-indigo-500"></i> ช่องทางยอดนิยม
                  </h4>
                  <ul class="space-y-1 text-sm">
                    <template x-for="(channel, i) in customerOverviewData.behavioralInsights.topChannels" :key="i">
                      <li x-text="`${i+1}. ${channel.name} (${channel.count} ครั้ง)`"></li>
                    </template>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>




























      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">รหัสลูกค้า</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ชื่อ-นามสกุล</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">เบอร์โทรศัพท์</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">จัดการ</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-if="isLoading">
                <tr>
                  <td colspan="5" class="text-center p-4">กำลังโหลดข้อมูล...</td>
                </tr>
              </template>
              <template x-if="!isLoading && filteredCustomers.length === 0">
                <tr>
                  <td colspan="5" class="text-center p-4">ไม่พบข้อมูลลูกค้า</td>
                </tr>
              </template>
              <template x-for="customer in filteredCustomers" :key="customer.รหัสลูกค้า">
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                    x-text="customer.รหัสลูกค้า"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800" x-text="customer['ชื่อ-นามสกุล']">
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                    x-text="customer.เบอร์โทรศัพท์.replace(/'/g, '')"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span
                      :class="{'bg-green-100 text-green-800': customer.สถานะ === 'ปกติ', 'bg-red-100 text-red-800': customer.สถานะ === 'Blacklist'}"
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                      x-text="customer.สถานะ || 'ปกติ'"></span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button @click="openCustomerDetails(customer.รหัสลูกค้า)"
                      class="text-indigo-600 hover:text-indigo-900" title="ดูรายละเอียด"><i
                        class="fas fa-eye"></i></button>
                    <button @click="openCustomerModal(customer)" class="text-blue-600 hover:text-blue-900"
                      title="แก้ไข"><i class="fas fa-edit"></i></button>
                    <button @click="confirmDeleteCustomer(customer.รหัสลูกค้า)" class="text-red-600 hover:text-red-900"
                      title="ลบ"><i class="fas fa-trash"></i></button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div x-show="showCustomerDetailsModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div @click.away="closeCustomerDetailsModal()"
          class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform transition-all"
          x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95"
          x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">

          <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
              <i class="fas fa-user-circle text-blue-500 mr-2"></i>
              <span
                x-text="`ข้อมูลลูกค้า: ${customerDetails.data ? customerDetails.data['ชื่อ-นามสกุล'] : '...'}`"></span>
            </h3>
            <button @click="closeCustomerDetailsModal()"
              class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-200 transition-colors">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="p-6 space-y-6 overflow-y-auto">
            <div x-show="isLoading" class="text-center py-8">
              <i class="fas fa-spinner fa-spin text-blue-500 text-3xl"></i>
              <p class="mt-2 text-gray-600">กำลังโหลดข้อมูล...</p>
            </div>

            <template x-if="!isLoading && customerDetails.data">
              <div class="space-y-6">

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                    <div><strong>รหัสลูกค้า:</strong> <span class="font-mono"
                        x-text="customerDetails.data.รหัสลูกค้า"></span></div>
                    <div><strong>เบอร์โทรศัพท์:</strong> <span
                        x-text="customerDetails.data.เบอร์โทรศัพท์.replace(/'/g, '')"></span></div>
                    <div><strong>เลขบัตรประชาชน:</strong> <span
                        x-text="customerDetails.data.เลขบัตรประชาชน || '-'"></span></div>
                    <div><strong>ใบขับขี่:</strong> <span x-text="customerDetails.data.หมายเลขใบขับขี่ || '-'"></span>
                    </div>
                    <div class="md:col-span-2"><strong>ที่อยู่:</strong> <span
                        x-text="customerDetails.data.ที่อยู่ || '-'"></span></div>
                    <div class="md:col-span-2"><strong>หมายเหตุ:</strong> <span
                        x-text="customerDetails.data.หมายเหตุ || '-'"></span></div>
                  </div>
                </div>

                <div>
                  <h4 class="text-md font-semibold text-gray-700 mb-2">ภาพรวมการเช่า</h4>
                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg text-center">
                      <i class="fas fa-receipt text-green-500 text-2xl mb-2"></i>
                      <p class="text-sm text-gray-600">จำนวนครั้งที่เช่า</p>
                      <p class="text-xl font-bold text-gray-800" x-text="customerStats.totalRentals || 0"></p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
                      <i class="fas fa-coins text-yellow-500 text-2xl mb-2"></i>
                      <p class="text-sm text-gray-600">ยอดใช้จ่ายทั้งหมด</p>
                      <p class="text-xl font-bold text-gray-800" x-text="customerStats.totalSpent || '฿0'"></p>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg text-center">
                      <i class="fas fa-car text-indigo-500 text-2xl mb-2"></i>
                      <p class="text-sm text-gray-600">รถที่เช่าบ่อยสุด</p>
                      <p class="text-xl font-bold text-gray-800 truncate" x-text="customerStats.favoriteCar || '-'">
                      </p>
                    </div>
                  </div>
                </div>

                <div class="space-y-6">
                  <div>
                    <h4 class="text-md font-semibold text-gray-700 mb-2">สถิติรุ่นรถที่เช่า 📊</h4>
                    <div class="bg-gray-50 p-3 rounded-lg border min-h-[280px]">
                      <template x-if="customerDetails.rentalHistory.length > 0">
                        <div id="customerCarChartContainer"></div>
                      </template>
                      <template x-if="customerDetails.rentalHistory.length === 0">
                        <div class="flex items-center justify-center h-full text-gray-500">
                          <p>ไม่มีข้อมูลสำหรับสร้างกราฟ</p>
                        </div>
                      </template>
                    </div>
                  </div>

                  <div>
                    <h4 class="text-md font-semibold text-gray-700 mb-2">ประวัติการเช่า (<span
                        x-text="customerDetails.rentalHistory.length"></span> รายการ)</h4>
                    <div class="border rounded-lg overflow-hidden">
                      <div class="max-h-[280px] overflow-y-auto">
                        <template x-if="customerDetails.rentalHistory.length === 0">
                          <p class="p-4 text-center text-gray-500">ไม่พบประวัติการเช่า</p>
                        </template>
                        <template x-for="item in customerDetails.rentalHistory" :key="item.หมายเลขการจอง">
                          <div class="border-b last:border-b-0">
                            <button
                              @click="expandedHistoryItem = (expandedHistoryItem === item.หมายเลขการจอง ? null : item.หมายเลขการจอง)"
                              class="w-full text-left p-3 hover:bg-gray-100 transition-colors flex justify-between items-center">
                              <div class="font-medium">
                                <span class="text-blue-600" x-text="item.หมายเลขการจอง"></span>
                                - <span x-text="item.รถ"></span>
                              </div>
                              <i class="fas fa-chevron-down transition-transform"
                                :class="{'rotate-180': expandedHistoryItem === item.หมายเลขการจอง}"></i>
                            </button>
                            <div x-show="expandedHistoryItem === item.หมายเลขการจอง" x-transition
                              class="p-4 bg-gray-50 text-sm">
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <div><strong>ช่องทางการจอง:</strong> <span x-text="item.ช่องทางการจอง || '-'"></span>
                                </div>
                                <div><strong>ราคาต่อวัน:</strong> <span
                                    x-text="formatCurrency(item.ราคา) || '-'"></span></div>
                                <div><strong>วันที่รับรถ:</strong> <span
                                    x-text="formatAndCombineDateTime(item.วันที่เช่า, item.เวลารับรถ)"></span></div>
                                <div><strong>สถานที่รับรถ:</strong> <span x-text="item.สถานที่รับรถ || '-'"></span>
                                </div>
                                <div><strong>วันที่คืนรถ:</strong> <span
                                    x-text="formatAndCombineDateTime(item.วันที่คืน, item.เวลาคืนรถ)"></span></div>
                                <div><strong>สถานที่คืนรถ:</strong> <span x-text="item.สถานที่คืนรถ || '-'"></span>
                                </div>
                                <div class="md:col-span-2"><strong>ค่าเช่ารวมทั้งหมด:</strong> <span class="font-bold"
                                    x-text="formatCurrency(item.ค่าเช่ารวมทั้งหมด) || '-'"></span></div>
                                <div class="md:col-span-2 mt-2" x-show="item.ลิงก์สัญญาเช่า">
                                  <a :href="item.ลิงก์สัญญาเช่า" target="_blank"
                                    class="inline-flex items-center px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded-md transition-colors">
                                    <i class="fas fa-file-pdf mr-1"></i> ดูสัญญาเช่า
                                  </a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </template>
          </div>

          <div class="p-4 border-t bg-gray-50 flex justify-end gap-2 rounded-b-xl">
            <button @click="closeCustomerDetailsModal()"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ปิด</button>
          </div>
        </div>
      </div>


      <div x-show="showDbMaintenanceModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div @click.away="closeDbMaintenanceModal()"
          class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all">
          <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
              <i class="fas fa-magic text-purple-500 mr-2"></i> ปรับปรุงฐานข้อมูลลูกค้า
            </h3>
            <button @click="closeDbMaintenanceModal()"
              class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-200 transition-colors">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="p-6 space-y-6 overflow-y-auto">
            <div x-show="!analysisResult" class="text-center py-8">
              <p class="text-gray-600 mb-4">คลิกเพื่อเริ่มการวิเคราะห์ข้อมูลลูกค้าที่ซ้ำซ้อนและตกหล่น</p>
              <button @click="runDatabaseAnalysis()" :disabled="isLoading"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors disabled:opacity-50">
                <span x-show="!isLoading"><i class="fas fa-search mr-2"></i>เริ่มการวิเคราะห์</span>
                <span x-show="isLoading"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังวิเคราะห์...</span>
              </button>
            </div>

            <template x-if="analysisResult">
              <div class="space-y-6">
                <div>
                  <h4 class="text-md font-semibold text-gray-700 mb-2">
                    <i class="fas fa-copy text-red-500"></i> พบข้อมูลที่อาจซ้ำกัน <span
                      x-text="analysisResult.duplicates.length"></span> รายการ
                  </h4>
                  <div class="border rounded-lg max-h-60 overflow-y-auto">
                    <template x-if="analysisResult.duplicates.length === 0">
                      <p class="p-4 text-center text-gray-500">ไม่พบข้อมูลลูกค้าที่ซ้ำซ้อน</p>
                    </template>
                    <template x-for="group in analysisResult.duplicates" :key="group.value">
                      <div class="p-3 border-b last:border-b-0">
                        <p class="font-mono text-sm">
                          ซ้ำจาก <b x-text="group.type"></b>:
                          <span class="font-semibold" x-text="group.value"></span>
                        </p>
                        <ul class="list-disc list-inside text-sm mt-2">
                          <template x-for="customer in group.duplicates" :key="customer.rowIndex">
                            <li
                              x-text="`${customer['รหัสลูกค้า']} - ${customer['ชื่อ-นามสกุล']} (เลขบัตร: ${customer['เลขบัตรประชาชน'] || 'ไม่มี'})`">
                            </li>
                          </template>
                        </ul>
                        <button @click="confirmMergeCustomers(group.duplicates)"
                          class="mt-2 text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">
                          <i class="fas fa-link"></i> รวมข้อมูล
                        </button>
                      </div>
                    </template>
                  </div>
                </div>

                <div>
                  <h4 class="text-md font-semibold text-gray-700 mb-2">
                    <i class="fas fa-user-plus text-orange-500"></i> พบลูกค้าที่ตกหล่น <span
                      x-text="analysisResult.missing.length"></span> รายการ
                  </h4>
                  <div class="border rounded-lg max-h-60 overflow-y-auto">
                    <template x-if="analysisResult.missing.length === 0">
                      <p class="p-4 text-center text-gray-500">ไม่พบลูกค้าที่ตกหล่น</p>
                    </template>
                    <table class="min-w-full text-sm">
                      <template x-for="customer in analysisResult.missing" :key="customer.หมายเลขการจอง">
                        <tr>
                          <td class="p-2 border-b" x-text="customer.ชื่อลูกค้า"></td>
                          <td class="p-2 border-b" x-text="customer.เบอร์โทรศัพท์"></td>
                          <td class="p-2 border-b font-mono" x-text="customer.เลขบัตรประชาชน"></td>
                        </tr>
                      </template>
                    </table>
                  </div>
                  <button x-show="analysisResult.missing.length > 0" @click="addMissingCustomers()"
                    class="mt-2 text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                    <i class="fas fa-plus-circle"></i> เพิ่มลูกค้าที่ตกหล่นทั้งหมด
                  </button>
                </div>
              </div>
            </template>
          </div>

          <div class="p-4 border-t bg-gray-50 flex justify-between items-center rounded-b-xl">
            <button x-show="analysisResult" @click="runDatabaseAnalysis()"
              class="text-sm text-blue-600 hover:underline">
              <i class="fas fa-redo"></i> วิเคราะห์อีกครั้ง
            </button>
            <button @click="closeDbMaintenanceModal()"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ปิด</button>
          </div>
        </div>
      </div>




      <div x-show="showCustomerModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
          <div class="p-4 border-b bg-gray-50">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-medium" x-text="isEditingCustomer ? 'แก้ไขข้อมูลลูกค้า' : 'เพิ่มลูกค้าใหม่'">
              </h3>
              <button @click="closeCustomerModal()" class="text-gray-500 hover:text-gray-700"><i
                  class="fas fa-times"></i></button>
            </div>
            <p x-show="!isEditingCustomer" class="text-xs text-blue-700 mt-1">
              <i class="fas fa-info-circle"></i> เคล็ดลับ: เมื่อสร้างรายการเช่าใหม่
              ข้อมูลลูกค้าจะถูกสร้างขึ้นอัตโนมัติ
            </p>
          </div>

          <div class="p-4 space-y-4 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล *</label>
                <input type="text" x-model="currentCustomer['ชื่อ-นามสกุล']"
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ *</label>
                <input type="text" x-model="currentCustomer.เบอร์โทรศัพท์"
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">เลขบัตรประชาชน</label>
                <input type="text" x-model="currentCustomer.เลขบัตรประชาชน"
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">หมายเลขใบขับขี่</label>
                <input type="text" x-model="currentCustomer.หมายเลขใบขับขี่"
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="col-span-1 md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">ที่อยู่</label>
                <textarea x-model="currentCustomer.ที่อยู่" rows="2"
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
              </div>
              <div class="col-span-1 md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">หมายเหตุ</label>
                <textarea x-model="currentCustomer.หมายเหตุ" rows="2"
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">สถานะ</label>
                <select x-model="currentCustomer.สถานะ"
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option>ปกติ</option>
                  <option>Blacklist</option>
                </select>
              </div>
            </div>
          </div>

          <div class="p-4 border-t bg-gray-50 flex justify-end gap-2">
            <button @click="closeCustomerModal()"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ยกเลิก</button>
            <button @click="saveCustomer()" :disabled="isLoading"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 w-32 text-center disabled:opacity-50">
              <span x-show="!isLoading" x-text="isEditingCustomer ? 'บันทึกการแก้ไข' : 'เพิ่มลูกค้า'"></span>
              <span x-show="isLoading"><i class="fas fa-spinner fa-spin"></i> กำลังบันทึก</span>
            </button>
          </div>
        </div>
      </div>








    </div>























    <!-- หน้าสร้างรายการเช่าใหม่ -->

    <div x-show="currentPage === 'newRental'" x-cloak id="newRentalForm">

      <div
        class="mb-6 flex items-center justify-between bg-white p-4 rounded-xl shadow-md border-l-4 border-green-500 w-full">
        <div class="flex items-center">
          <div
            class="flex items-center justify-center w-16 h-16 bg-green-500 rounded-full shadow-md mr-5 flex-shrink-0">
            <i class="fas fa-address-book text-white text-2xl"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800">จัดการข้อมูลการจอง</h2>
            <p class="mt-1 text-gray-600">
              <i class="fas fa-search mr-2 text-green-500"></i>ค้นหาข้อมูลลูกค้าเดิม
              หรือกรอกข้อมูลเพื่อสร้างการจองใหม่
            </p>
          </div>
        </div>

        <div>
          <button @click="openBlankContractModal()" type="button"
            class="flex items-center bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
            <i class="fas fa-file-alt mr-2"></i>
            <span>สร้างสัญญาเปล่า</span>
          </button>
        </div>
      </div>
      <div class="mb-8">
        <div class="bg-white rounded-xl shadow-md border border-gray-100">
          <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <div class="flex items-center">
              <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-search text-blue-600 text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-gray-800">ค้นหาในฐานข้อมูล</h3>
              </div>
            </div>
          </div>

          <div class="p-6">
            <div class="flex items-center">
              <div class="flex items-center justify-center w-14 h-14 bg-blue-100 rounded-full shadow-sm mr-5">
                <i class="fas fa-bookmark text-blue-600 text-2xl"></i>
              </div>
              <div>
                <p class="text-gray-500 mt-1 flex items-center text-lg">
                  <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                  ค้นหาข้อมูลการจอง และข้อมูลลูกค้า
                </p>
              </div>
            </div>

            <div class="p-6 border-t border-gray-100 mb-6">
              <h3 class="text-lg font-semibold text-blue-600 mb-4 flex items-center">
                <i class="fas fa-search mr-2"></i>ค้นหา แก้ไข ลบข้อมูล
                <button @click="showAdvancedSearch = !showAdvancedSearch"
                  class="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200 transition-colors">
                  <i class="fas" :class="showAdvancedSearch ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                  <span x-text="showAdvancedSearch ? 'ค้นหาทั่วไป' : 'ค้นหาขั้นสูง'"></span>
                </button>
              </h3>

              <div class="mb-2">
                <p class="text-sm text-gray-600 mb-2">
                  <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                  สามารถค้นหาด้วยข้อมูลต่อไปนี้: <span class="font-medium">หมายเลขการจอง, ชื่อลูกค้า, เบอร์โทรศัพท์,
                    ทะเบียนรถ, เลขบัตรประชาชน, หมายเลขใบขับขี่</span>
                </p>
              </div>

              <div x-show="!showAdvancedSearch">
                <div class="flex items-center space-x-2">
                  <div class="flex-1 relative">
                    <input type="text" x-model="advancedSearchQuery" placeholder="พิมพ์คำค้นหา..."
                      class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 ease-in-out uppercase"
                      @keyup.enter="performAdvancedSearch(); saveSearchToHistory()"
                      @input="convertToUppercase(); getSuggestions()" @keydown="handleKeyNavigation"
                      @focus="showSuggestions = searchSuggestions.length > 0"
                      @blur="setTimeout(() => showSuggestions = false, 200)" style="text-transform: uppercase;">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>

                    <div x-show="showSuggestions"
                      class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                      <template x-if="searchSuggestions.length > 0">
                        <div>
                          <template x-for="(suggestion, index) in searchSuggestions" :key="index">
                            <div @click="selectSuggestion(suggestion)" @mouseenter="activeSuggestionIndex = index"
                              :class="{ 'bg-blue-100': activeSuggestionIndex === index }"
                              class="px-4 py-2 cursor-pointer hover:bg-blue-50 text-sm">
                              <span x-text="suggestion"></span>
                            </div>
                          </template>
                        </div>
                      </template>

                      <template x-if="searchSuggestions.length === 0 && searchHistory.length > 0">
                        <div>
                          <div class="px-4 py-2 text-xs text-gray-500 border-b">ประวัติการค้นหาล่าสุด</div>
                          <template x-for="(item, index) in searchHistory.slice(0, 5)" :key="index">
                            <div @click="selectSuggestion(item)"
                              class="px-4 py-2 cursor-pointer hover:bg-blue-50 text-sm flex items-center">
                              <i class="fas fa-history mr-2 text-gray-400"></i>
                              <span x-text="item"></span>
                            </div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>

                  <button @click="performAdvancedSearch(); saveSearchToHistory()"
                    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg flex items-center transition duration-300 relative"
                    :disabled="isSearching">
                    <template x-if="!isSearching">
                      <i class="fas fa-search mr-2"></i>
                    </template>
                    <template x-if="isSearching">
                      <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                      </svg>
                    </template>
                    <span x-text="isSearching ? 'กำลังค้นหา...' : 'ค้นหา'"></span>
                  </button>

                  <button @click="clearAdvancedSearch()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg flex items-center transition duration-300"
                    x-show="isAdvancedSearchActive">
                    <i class="fas fa-times mr-2"></i>ล้าง
                  </button>
                </div>
              </div>

              <div x-show="showAdvancedSearch" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      ข้อมูลลูกค้า
                    </label>
                    <input type="text" x-model="advancedFilters.customerInfo" placeholder="ชื่อลูกค้า หรือ เบอร์โทร..."
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      ข้อมูลรถ
                    </label>
                    <input type="text" x-model="advancedFilters.carInfo" placeholder="รุ่นรถ หรือ ทะเบียน..."
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      วันที่เช่า (เริ่มต้น)
                    </label>
                    <input type="date" x-model="advancedFilters.startDate"
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      วันที่เช่า (สิ้นสุด)
                    </label>
                    <input type="date" x-model="advancedFilters.endDate"
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      สถานะการจอง
                    </label>
                    <select x-model="advancedFilters.status"
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                      <option value="">ทั้งหมด</option>
                      <option value="active">กำลังใช้งาน</option>
                      <option value="completed">เสร็จสิ้นแล้ว</option>
                      <option value="cancelled">ยกเลิกแล้ว</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      เรียงลำดับตาม
                    </label>
                    <select x-model="advancedFilters.sortBy"
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                      <option value="date_desc">วันที่เช่า (ล่าสุด)</option>
                      <option value="date_asc">วันที่เช่า (เก่าสุด)</option>
                      <option value="name_asc">ชื่อลูกค้า (ก-ฮ)</option>
                      <option value="name_desc">ชื่อลูกค้า (ฮ-ก)</option>
                    </select>
                  </div>
                </div>
                <div class="flex justify-end space-x-2">
                  <button @click="performAdvancedFilterSearch()"
                    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg flex items-center transition duration-300">
                    <i class="fas fa-filter mr-2"></i>ค้นหาแบบละเอียด
                  </button>
                  <button @click="resetAdvancedFilters()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg flex items-center transition duration-300">
                    <i class="fas fa-redo mr-2"></i>รีเซ็ต
                  </button>
                </div>
              </div>

              <div x-show="isSearching && !advancedSearchResults.length" class="mt-4 animate-pulse">
                <div class="h-6 bg-gray-200 rounded w-1/4 mb-4"></div>

                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <template x-for="i in 8">
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <div class="h-4 bg-gray-200 rounded w-20"></div>
                          </th>
                        </template>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <template x-for="i in 5">
                        <tr class="cursor-pointer">
                          <template x-for="j in 8">
                            <td class="px-6 py-4 whitespace-nowrap">
                              <div class="h-4 bg-gray-200 rounded" :class="j === 1 ? 'w-24' : 'w-32'"></div>
                            </td>
                          </template>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="search-notification"
                class="notification hidden fixed bottom-4 right-4 p-3 rounded-lg shadow-lg z-50"></div>

              <!-- รายการเช่าล่าสุด -->
              <div x-show="!isSearching && recentRentals.length > 0" x-transition class="mt-4">
                <h3 class="text-base font-semibold text-gray-700 mb-3 flex items-center">
                  <i class="fas fa-clock mr-2 text-purple-500 text-sm"></i>
                  รายการเช่าล่าสุด
                </h3>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <template x-for="rental in recentRentals" :key="rental.rowIndex">
                    <div @click="loadRecentRentalForEdit(rental)"
                      class="bg-white rounded-lg p-3 cursor-pointer hover:shadow-md transition-all duration-200 border border-gray-200 hover:border-purple-300 group">

                      <!-- หมายเลขการจอง -->
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold text-purple-600"
                          x-text="(rental['หมายเลขการจอง'] || '').substring(0, 10) + '...'"></span>
                        <i class="fas fa-edit text-gray-300 group-hover:text-purple-500 text-xs transition-colors"></i>
                      </div>

                      <!-- ชื่อลูกค้า -->
                      <div class="mb-1">
                        <p class="text-sm font-medium text-gray-800 truncate"
                          x-text="rental['ชื่อลูกค้า'] || 'ไม่ระบุชื่อ'"></p>
                      </div>

                      <!-- รุ่นรถ -->
                      <div class="flex items-center text-xs text-gray-500">
                        <i class="fas fa-car mr-1 text-gray-400"></i>
                        <span class="truncate" x-text="rental['รถที่เช่า'] || rental['รถ'] || 'ไม่ระบุ'"></span>
                      </div>

                      <!-- ปุ่มดู/แก้ไข (hover effect) -->
                      <div class="mt-2 pt-2 border-t border-gray-100">
                        <span class="text-xs text-gray-400 group-hover:text-purple-600 transition-colors">
                          ดูข้อมูล →
                        </span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <!-- Loading state สำหรับรายการเช่าล่าสุด -->
              <div x-show="isLoadingRecentRentals" x-transition class="mt-4">
                <h3 class="text-base font-semibold text-gray-700 mb-3 flex items-center">
                  <i class="fas fa-clock mr-2 text-purple-500 text-sm"></i>
                  กำลังโหลดรายการเช่าล่าสุด...
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <template x-for="i in 4">
                    <div class="bg-white rounded-lg p-3 border border-gray-200 animate-pulse">
                      <div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div>
                      <div class="h-3 bg-gray-200 rounded mb-1"></div>
                      <div class="h-3 bg-gray-200 rounded w-3/4"></div>
                    </div>
                  </template>
                </div>
              </div>

              <div x-show="isAdvancedSearchActive && !isSearching" x-transition:enter="transition-opacity duration-300"
                x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="mt-4">

                <template x-if="advancedSearchResults.length > 0">
                  <div>
                    <div class="flex justify-between items-center mb-4">
                      <div>
                        <ul class="flex border-b border-gray-200">
                          <li class="mr-2">
                            <button @click="currentView = 'all'"
                              :class="{ 'border-blue-500 text-blue-600': currentView === 'all', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': currentView !== 'all' }"
                              class="inline-block py-2 px-4 border-b-2 font-medium text-sm focus:outline-none transition-colors">
                              <i class="fas fa-list mr-1"></i> ทั้งหมด <span
                                class="ml-1 bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs"
                                x-text="advancedSearchResults.length"></span>
                            </button>
                          </li>
                          <li class="mr-2">
                            <button @click="currentView = 'active'"
                              :class="{ 'border-blue-500 text-blue-600': currentView === 'active', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': currentView !== 'active' }"
                              class="inline-block py-2 px-4 border-b-2 font-medium text-sm focus:outline-none transition-colors">
                              <i class="fas fa-car mr-1"></i> กำลังใช้งาน <span
                                class="ml-1 bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs"
                                x-text="getActiveRentals().length"></span>
                            </button>
                          </li>
                          <li class="mr-2">
                            <button @click="currentView = 'upcoming'"
                              :class="{ 'border-blue-500 text-blue-600': currentView === 'upcoming', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': currentView !== 'upcoming' }"
                              class="inline-block py-2 px-4 border-b-2 font-medium text-sm focus:outline-none transition-colors">
                              <i class="fas fa-clock mr-1"></i> กำลังจะมาถึง <span
                                class="ml-1 bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs"
                                x-text="getUpcomingRentals().length"></span>
                            </button>
                          </li>
                          <li>
                            <button @click="currentView = 'completed'"
                              :class="{ 'border-blue-500 text-blue-600': currentView === 'completed', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': currentView !== 'completed' }"
                              class="inline-block py-2 px-4 border-b-2 font-medium text-sm focus:outline-none transition-colors">
                              <i class="fas fa-check-circle mr-1"></i> เสร็จสิ้นแล้ว <span
                                class="ml-1 bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs"
                                x-text="getCompletedRentals().length"></span>
                            </button>
                          </li>
                        </ul>
                      </div>

                      <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <button @click="viewMode = 'table'"
                          :class="{ 'bg-blue-500 text-white': viewMode === 'table', 'bg-gray-200 text-gray-700 hover:bg-gray-300': viewMode !== 'table' }"
                          class="px-3 py-1 rounded-md text-sm flex items-center transition-colors">
                          <i class="fas fa-table mr-1"></i> ตาราง
                        </button>
                        <button @click="viewMode = 'timeline'"
                          :class="{ 'bg-blue-500 text-white': viewMode === 'timeline', 'bg-gray-200 text-gray-700 hover:bg-gray-300': viewMode !== 'timeline' }"
                          class="px-3 py-1 rounded-md text-sm flex items-center transition-colors">
                          <i class="fas fa-stream mr-1"></i> ไทม์ไลน์
                        </button>
                        <button @click="viewMode = 'calendar'"
                          :class="{ 'bg-blue-500 text-white': viewMode === 'calendar', 'bg-gray-200 text-gray-700 hover:bg-gray-300': viewMode !== 'calendar' }"
                          class="px-3 py-1 rounded-md text-sm flex items-center transition-colors">
                          <i class="fas fa-calendar-alt mr-1"></i> ปฏิทิน
                        </button>
                      </div>

                    </div>

                    <div
                      class="inline-flex items-center bg-blue-50 border-l-4 border-blue-400 text-blue-700 text-xs px-2 py-1 rounded mb-4 space-x-1">
                      💡 เคล็ดลับ: คลิกที่
                      <i class="fas fa-edit text-blue-500 mx-1"></i> เพื่อแก้ไข
                      <i class="fas fa-trash text-red-500 mx-1"></i> เพื่อลบรายการจอง
                      <i class="fas fa-check-circle text-green-500 mx-1"></i> เพื่อใช้ข้อมูลเดิมของลูกค้า
                    </div>

                    <p class="text-sm text-gray-600 mb-2">
                      <i class="fas fa-check-circle text-green-500 mr-1"></i>
                      พบ <span class="font-semibold" x-text="advancedSearchResults.length"></span> รายการ
                    </p>

                    <div x-show="viewMode === 'table'" class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                          <tr>
                            <th @click="sortResults('หมายเลขการจอง')"
                              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                              <div class="flex items-center">
                                หมายเลขการจอง
                                <span x-show="sortField === 'หมายเลขการจอง'" class="ml-1">
                                  <i class="fas" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </span>
                              </div>
                            </th>
                            <th @click="sortResults('ชื่อลูกค้า')"
                              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                              <div class="flex items-center">
                                ชื่อลูกค้า
                                <span x-show="sortField === 'ชื่อลูกค้า'" class="ml-1">
                                  <i class="fas" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </span>
                              </div>
                            </th>
                            <th @click="sortResults('เบอร์โทรศัพท์')"
                              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                              <div class="flex items-center">
                                เบอร์โทรศัพท์
                                <span x-show="sortField === 'เบอร์โทรศัพท์'" class="ml-1">
                                  <i class="fas" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </span>
                              </div>
                            </th>
                            <th @click="sortResults('รถ')"
                              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                              <div class="flex items-center">
                                รถ
                                <span x-show="sortField === 'รถ'" class="ml-1">
                                  <i class="fas" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </span>
                              </div>
                            </th>
                            <th @click="sortResults('วันที่เช่า')"
                              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                              <div class="flex items-center">
                                วันที่เช่า
                                <span x-show="sortField === 'วันที่เช่า'" class="ml-1">
                                  <i class="fas" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </span>
                              </div>
                            </th>
                            <th @click="sortResults('เลขบัตรประชาชน')"
                              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                              <div class="flex items-center">
                                เลขบัตรประชาชน
                                <span x-show="sortField === 'เลขบัตรประชาชน'" class="ml-1">
                                  <i class="fas" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </span>
                              </div>
                            </th>
                            <th @click="sortResults('หมายเลขใบขับขี่')"
                              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                              <div class="flex items-center">
                                หมายเลขใบขับขี่
                                <span x-show="sortField === 'หมายเลขใบขับขี่'" class="ml-1">
                                  <i class="fas" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                </span>
                              </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              จัดการ</th>
                          </tr>

                          <tr class="bg-gray-100 animate-fadeIn">
                            <th class="px-6 py-2">
                              <input type="text" x-model="quickFilters.หมายเลขการจอง"
                                @input="handleFilterInput('หมายเลขการจอง', $event)" placeholder="กรอง..."
                                class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-2">
                              <input type="text" x-model="quickFilters.ชื่อลูกค้า"
                                @input="handleFilterInput('ชื่อลูกค้า', $event)" placeholder="กรอง..."
                                class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-2">
                              <input type="text" x-model="quickFilters.เบอร์โทรศัพท์"
                                @input="handleFilterInput('เบอร์โทรศัพท์', $event)" placeholder="กรอง..."
                                class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-2">
                              <input type="text" x-model="quickFilters.รถ" @input="handleFilterInput('รถ', $event)"
                                placeholder="กรอง..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-2">
                              <input type="date" x-model="quickFilters.วันที่เช่า" @change="applyQuickFilters()"
                                class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-2">
                              <input type="text" x-model="quickFilters.เลขบัตรประชาชน"
                                @input="handleFilterInput('เลขบัตรประชาชน', $event)" placeholder="กรอง..."
                                class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-2">
                              <input type="text" x-model="quickFilters.หมายเลขใบขับขี่"
                                @input="handleFilterInput('หมายเลขใบขับขี่', $event)" placeholder="กรอง..."
                                class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-2">
                              <button @click="clearQuickFilters()"
                                class="px-2 py-1 bg-gray-200 text-xs rounded hover:bg-gray-300"
                                x-show="isQuickFilterActive">
                                <i class="fas fa-times"></i> ล้าง
                              </button>
                            </th>
                          </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                          <template x-for="rental in advancedSearchResults" :key="rental.rowIndex">
                            <tr @click="openNewBookingDetailsModal(rental)"
                              class="cursor-pointer hover:bg-gray-100 transition-colors duration-200"
                              :class="{ 'bg-blue-50': rental.isHighlighted }">
                              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                x-html="highlightMatch(rental.หมายเลขการจอง, advancedSearchQuery)"></td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                x-html="highlightMatch(rental.ชื่อลูกค้า, advancedSearchQuery)"></td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                x-html="highlightMatch(rental.เบอร์โทรศัพท์, advancedSearchQuery)"></td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                x-html="highlightMatch(rental.รถ, advancedSearchQuery)"></td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                x-text="formatDate(rental.วันที่เช่า)"></td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                x-html="highlightMatch(rental.เลขบัตรประชาชน, advancedSearchQuery)"></td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                x-html="highlightMatch(rental.หมายเลขใบขับขี่, advancedSearchQuery)"></td>

                              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3" @click.stop>
                                <div class="group relative inline-block">
                                  <button @click="viewRental(rental)" class="text-gray-600 hover:text-gray-900">
                                    <i class="fas fa-eye"></i>
                                  </button>
                                  <div
                                    class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap">
                                    ดูข้อมูล
                                  </div>
                                </div>

                                <div class="group relative inline-block">
                                  <button @click="editRental(rental)" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-edit"></i>
                                  </button>
                                  <div
                                    class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap">
                                    แก้ไขข้อมูล
                                  </div>
                                </div>

                                <div class="group relative inline-block">
                                  <button @click="useSearchedData(rental)" class="text-green-600 hover:text-green-900">
                                    <i class="fas fa-check-circle"></i>
                                  </button>
                                  <div
                                    class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap">
                                    ใช้ข้อมูลนี้
                                  </div>
                                </div>

                                <div class="group relative inline-block">
                                  <button @click="deleteRentalItem(rental)" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                  </button>
                                  <div
                                    class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap">
                                    ลบรายการ
                                  </div>
                                </div>

                                <div class="group relative inline-block"
                                  x-show="rental.ลิงก์สัญญาเช่า && rental.ลิงก์สัญญาเช่า.length > 0">
                                  <a :href="rental.ลิงก์สัญญาเช่า" target="_blank"
                                    class="text-blue-600 hover:text-blue-900 inline-block">
                                    <i class="fas fa-file-pdf"></i>
                                  </a>
                                  <div
                                    class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                                    ดูสัญญาเช่า
                                  </div>
                                </div>

                                <div class="group relative inline-block">
                                  <button @click="copySummaryForRental(rental)"
                                    class="text-green-600 hover:text-green-900">
                                    <i class="fas fa-copy"></i>
                                  </button>
                                  <div
                                    class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                                    คัดลอกข้อความสรุป
                                  </div>
                                </div>
                              </td>

                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>

                    <div x-show="viewMode === 'timeline'" class="mt-4">
                      <div class="relative border-l-2 border-blue-200 ml-4 pb-8">
                        <div
                          class="absolute left-0 transform -translate-x-1/2 flex items-center justify-center w-6 h-6 bg-red-500 rounded-full">
                          <i class="fas fa-star text-white text-xs"></i>
                        </div>
                        <div class="ml-8 mb-8 text-sm text-red-500 font-semibold">
                          วันนี้: <span x-text="formatDate(new Date())"></span>
                        </div>

                        <template x-for="(rental, index) in getSortedRentalsByDate()" :key="rental.rowIndex">
                          <div
                            class="ml-8 mb-10 p-4 border rounded-lg shadow-sm transition-transform duration-200 transform hover:-translate-y-1 hover:shadow-md cursor-pointer"
                            :class="{
                                                    'border-green-200 bg-green-50': isActiveRental(rental),
                                                    'border-blue-200 bg-blue-50': isUpcomingRental(rental),
                                                    'border-gray-200 bg-gray-50': isCompletedRental(rental)
                                                }" @click="openNewBookingDetailsModal(rental)">
                            <div
                              class="absolute left-0 transform -translate-x-1/2 flex items-center justify-center w-4 h-4 rounded-full"
                              :class="{
                                                        'bg-green-500': isActiveRental(rental),
                                                        'bg-blue-500': isUpcomingRental(rental),
                                                        'bg-gray-500': isCompletedRental(rental)
                                                    }"></div>

                            <div class="absolute left-0 w-8 h-0.5 bg-gray-200 transform -translate-y-2"></div>

                            <div class="flex items-center justify-between mb-2">
                              <h4 class="font-semibold text-gray-800" x-text="rental.รถ || 'ไม่ระบุรถ'"></h4>
                              <span class="text-sm" :class="{
                                                            'text-green-600': isActiveRental(rental),
                                                            'text-blue-600': isUpcomingRental(rental),
                                                            'text-gray-600': isCompletedRental(rental)
                                                        }" x-text="getRentalStatusText(rental)"></span>
                            </div>

                            <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                              <div class="flex items-center">
                                <i class="fas fa-user text-gray-400 mr-2"></i>
                                <span x-text="rental.ชื่อลูกค้า || 'ไม่ระบุชื่อ'"></span>
                              </div>
                              <div class="flex items-center">
                                <i class="fas fa-phone text-gray-400 mr-2"></i>
                                <span x-text="rental.เบอร์โทรศัพท์ || '-'"></span>
                              </div>
                              <div class="flex items-center">
                                <i class="fas fa-calendar-day text-gray-400 mr-2"></i>
                                <span x-text="formatDate(rental.วันที่เช่า) || '-'"></span>
                              </div>
                              <div class="flex items-center">
                                <i class="fas fa-calendar-check text-gray-400 mr-2"></i>
                                <span x-text="formatDate(rental.วันที่คืน) || '-'"></span>
                              </div>
                            </div>

                            <div class="text-xs text-gray-500 mt-2">
                              ระยะเวลาเช่า: <span class="font-medium"
                                x-text="calculateRentalDaysForDisplay(rental)"></span>
                            </div>

                            <div class="flex justify-end space-x-2 mt-3">
                              <button @click.stop="viewRental(rental)"
                                class="text-gray-600 hover:text-gray-800 p-1.5 rounded-full hover:bg-gray-100">
                                <i class="fas fa-eye"></i>
                              </button>
                              <button @click.stop="editRental(rental)"
                                class="text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-100">
                                <i class="fas fa-edit"></i>
                              </button>

                              <a x-show="rental.ลิงก์สัญญาเช่า && rental.ลิงก์สัญญาเช่า.length > 0"
                                :href="rental.ลิงก์สัญญาเช่า" target="_blank"
                                class="text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-100 inline-flex items-center justify-center"
                                @click.stop>
                                <i class="fas fa-file-pdf"></i>
                              </a>

                              <button @click.stop="copySummaryForRental(rental)"
                                class="text-green-600 hover:text-green-800 p-1.5 rounded-full hover:bg-green-100">
                                <i class="fas fa-copy"></i>
                              </button>

                              <button @click.stop="deleteRentalItem(rental)"
                                class="text-red-600 hover:text-red-800 p-1.5 rounded-full hover:bg-red-100">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>

                    <div x-show="viewMode === 'calendar'" class="mt-4">
                      <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex justify-between items-center mb-4">
                          <button @click="prevMonth()" class="p-2 rounded-full hover:bg-gray-100">
                            <i class="fas fa-chevron-left"></i>
                          </button>
                          <h3 class="text-lg font-semibold" x-text="formatMonthYear(currentCalendarDate)"></h3>
                          <button @click="nextMonth()" class="p-2 rounded-full hover:bg-gray-100">
                            <i class="fas fa-chevron-right"></i>
                          </button>
                        </div>

                        <div class="grid grid-cols-7 gap-1 mb-2">
                          <template x-for="day in ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส']" :key="day">
                            <div class="text-center text-gray-500 text-sm font-medium py-1" x-text="day"></div>
                          </template>
                        </div>

                        <div class="grid grid-cols-7 gap-1">
                          <template x-for="(day, index) in getCalendarDays()" :key="index">
                            <div class="p-1 min-h-20 border rounded-md relative"
                              :class="{'bg-gray-100': !day.isCurrentMonth, 'bg-blue-50': isToday(day.date)}">
                              <div class="text-xs text-gray-500 absolute top-1 right-1" x-text="day.date.getDate()">
                              </div>

                              <div class="mt-5 space-y-1">
                                <template x-for="rental in getRentalsOnDate(day.date)" :key="rental.rowIndex">
                                  <div @click="openNewBookingDetailsModal(rental)"
                                    class="text-xs p-1 rounded truncate cursor-pointer"
                                    :class="getRentalCalendarClass(rental)"
                                    :title="rental.ชื่อลูกค้า + ' - ' + rental.รถ">
                                    <span x-text="getRentalTimeOrStatus(rental, day.date)"></span>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>

                <template x-if="advancedSearchResults.length === 0 && searchStatus === 'success'">
                  <div class="text-center py-8">
                    <div
                      class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-500 mb-4">
                      <i class="fas fa-search-minus text-2xl"></i>
                    </div>
                    <p class="text-gray-500 text-lg">ไม่พบรายการที่ตรงกับคำค้นหา</p>
                    <p class="text-gray-400 text-sm mt-2">ลองค้นหาด้วยคำค้นหาอื่น หรือลองตัวกรองที่แตกต่าง</p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-md border border-gray-100">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
          <div class="flex items-center">
            <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
              <i class="fas fa-plus text-green-600 text-xl"></i>
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-800">กรอกข้อมูลเพื่อสร้างการจองใหม่</h3>
            </div>
          </div>
        </div>

        <div class="p-6">
          <form
            @submit.prevent="unspecifiedVehicleMode ? confirmRentalSubmissionUnspecifiedVehicle() : confirmRentalSubmission()"
            class="space-y-8">

            <div data-tutorial="booking-info" class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up">
              <div class="flex items-center mb-6">
                <div class="w-12 h-12 gradient-bg-2 rounded-full flex items-center justify-center mr-4">
                  <i class="fas fa-bookmark text-white text-xl"></i>
                </div>
                <div>
                  <h2 class="text-2xl font-bold text-gray-800">ข้อมูลการจอง</h2>
                  <p class="text-gray-600">ระบุช่องทางการจองและหมายเลขการจอง</p>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-globe mr-2 text-blue-500"></i>ช่องทางการจอง
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <select x-model="newRental.ช่องทางการจอง" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                    <option value="">เลือกช่องทางการจอง</option>
                    <template x-for="channel in bookingChannels" :key="channel">
                      <option :value="channel" x-text="channel"></option>
                    </template>
                  </select>
                </div>

                <div class="space-y-2">
                  <label class="flex items-center justify-between text-sm font-semibold text-gray-700">
                    <span>
                      <i class="fas fa-hashtag mr-2 text-green-500"></i>หมายเลขการจอง
                      <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                    </span>
                    <button type="button" @click.prevent="showBookingNumberInfo = true"
                      class="w-5 h-5 bg-green-200 hover:bg-green-300 text-gray-600 rounded-full flex items-center justify-center transition-colors duration-200"
                      title="ดูข้อมูลเพิ่มเติม">
                      <i class="fas fa-question text-xs"></i>
                    </button>
                  </label>
                  <div class="relative">
                    <input type="text" x-model="newRental.หมายเลขการจอง" :disabled="autoGenerateBookingNumber"
                      placeholder="B2024001"
                      class="w-full px-4 py-3 pr-32 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
                      <span class="text-xs text-gray-600">สร้างอัตโนมัติ</span>
                      <input type="checkbox" x-model="autoGenerateBookingNumber" @change="handleAutoGenerateChange"
                        class="toggle-switch">
                    </div>
                  </div>

                </div>
              </div>




            </div>

            <div data-tutorial="rental-info" class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up"
              style="animation-delay: 0.4s;">
              <div class="flex items-center mb-6">
                <div class="w-12 h-12 gradient-bg-4 rounded-full flex items-center justify-center mr-4">
                  <i class="fas fa-car text-white text-xl"></i>
                </div>
                <div>
                  <h2 class="text-2xl font-bold text-gray-800">ข้อมูลการเช่า</h2>
                  <p class="text-gray-600">เลือกรถและกำหนดระยะเวลาการเช่า</p>
                </div>
              </div>

              <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                <div class="flex items-center justify-between">



                  <div class="flex items-center justify-between  space-x-3">
                    <div class="flex-1">
                      <label class="text-2xl font-semibold text-blue-800 flex items-center">
                        <i class="fa-solid fa-car-tunnel mr-2 text-blue-600"></i>
                        โหมดจองแบบไม่ระบุชื่อรถ
                      </label>
                      <p class="text-sm text-blue-600 mt-1">ใช้ในกรณีต้องการสรุปรายละเอียดรถให้ลูกค้า
                        แต่รอหารถจากพาร์ทเนอร์ภายหลัง</p>
                    </div>

                    <button type="button" @click="showUnspecifiedModeInfo = true"
                      class="flex-shrink-0 w-8 h-8 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full flex items-center justify-center transition-colors duration-200 ml-2"
                      title="ดูข้อมูลเพิ่มเติม">
                      <i class="fas fa-question text-sm"></i>
                    </button>
                  </div>

                  <button type="button" @click="toggleUnspecifiedMode()"
                    class="w-12 h-6 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all duration-300 shadow-inner"
                    :class="unspecifiedVehicleMode ? 'bg-blue-500' : 'bg-gray-300'">
                    <span
                      class="block w-6 h-6 bg-white rounded-full shadow-lg absolute transform transition-transform duration-300 border"
                      :class="unspecifiedVehicleMode ? 'translate-x-6' : 'translate-x-0'">
                      <i class="fas text-xs absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 transition-colors duration-300"
                        :class="unspecifiedVehicleMode ? 'fa-check text-blue-500' : 'fa-times text-gray-400'"></i>
                    </span>
                  </button>
                </div>
              </div>





              <div class="flex flex-col lg:flex-row lg:space-x-6 space-y-4 lg:space-y-0 mb-6">
                <div class="flex-1 space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-car mr-2 text-blue-500"></i>รถที่เช่า
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>

                  <div x-show="!unspecifiedVehicleMode"
                    class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                    <select x-model="newRental.รถ" @change="populateCarDetails()" :required="!unspecifiedVehicleMode"
                      class="flex-1 w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                      <option value="">เลือกรถ</option>

                      <template x-for="(car, index) in carOptions" :key="index">
                        <option :value="car.value" x-text="car.text"></option>
                      </template>
                    </select>

                    <div x-data="{ open: false }" class="relative">
                      <button type="button" @click.prevent="open = !open"
                        class="w-full sm:w-auto px-4 py-3 border-2 border-gray-200 rounded-xl bg-white hover:bg-gray-50 focus:outline-none hover:border-blue-300 transition-all duration-300">
                        <i class="fas fa-search text-gray-600"></i>
                      </button>
                      <div x-show="open" @click.away="open = false" x-transition
                        class="absolute right-0 mt-2 w-64 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-64 overflow-y-auto z-20">

                        <div class="sticky top-0 bg-white px-4 py-2 border-b border-gray-100">
                          <input type="text" x-model="newBookingcarSearchQuery" @input="searchCars()"
                            placeholder="ค้นหาด้วยทะเบียนหรือชื่อรถ..."
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-100 transition-all">
                        </div>

                        <template x-if="filteredCarOptions.length">
                          <template x-for="car in filteredCarOptions" :key="car">
                            <div @click="selectCarFromSearch(car); open = false"
                              class="px-4 py-2 hover:bg-blue-50 cursor-pointer transition-colors">
                              <span x-text="car" class="block text-gray-800"></span>
                            </div>
                          </template>
                        </template>
                        <div x-show="!filteredCarOptions.length && newBookingcarSearchQuery"
                          class="p-4 text-center text-gray-500">
                          <i class="fas fa-exclamation-circle mr-1"></i>ไม่พบรถที่ค้นหา
                        </div>
                      </div>
                    </div>
                  </div>

                  <div x-show="unspecifiedVehicleMode" x-transition>
                    <input x-model="unspecifiedVehicleName" type="text" :required="unspecifiedVehicleMode"
                      placeholder="พิมพ์ชื่อรถที่ต้องการ เช่น Honda City, Toyota Vios"
                      class="w-full px-4 py-3 border-2 border-orange-200 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-100 transition-all duration-300 bg-orange-50">
                  </div>
                </div>

                <div x-show="!unspecifiedVehicleMode" class="flex-1 space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-hashtag mr-2 text-purple-500"></i>ทะเบียนรถ
                  </label>
                  <input type="text" x-model="newRental.ทะเบียนรถ" readonly placeholder="จะถูกกรอกอัตโนมัติ"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-600">
                </div>

                <div x-show="unspecifiedVehicleMode" class="flex-1 space-y-2" x-transition>
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-info-circle mr-2 text-orange-500"></i>สถานะ
                  </label>
                  <div
                    class="w-full px-4 py-3 border-2 border-orange-200 rounded-xl bg-orange-50 text-orange-700 flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    <span class="font-medium">รอการจัดหารถ</span>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-6">
                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-calendar-plus mr-2 text-green-500"></i>วันที่เริ่มเช่า
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <input type="date" x-model="newRental.วันที่เช่า"
                    @change="calculateTotalRental(); updateRentalDurationDisplay()" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all duration-300">
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-calendar-minus mr-2 text-red-500"></i>วันที่สิ้นสุด
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <input type="date" x-model="newRental.วันที่คืน"
                    @change="calculateTotalRental(); updateRentalDurationDisplay()" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all duration-300">
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-clock mr-2 text-blue-500"></i>เวลารับรถ
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <input type="time" x-model="newRental.เวลารับรถ"
                    @change="calculateTotalRental(); updateRentalDurationDisplay()" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-clock mr-2 text-purple-500"></i>เวลาคืนรถ
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <input type="time" x-model="newRental.เวลาคืนรถ"
                    @change="calculateTotalRental(); updateRentalDurationDisplay()" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-300">
                </div>
              </div>

              <div
                class="flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 mb-6 shadow-sm hover:shadow-md transition-shadow duration-300">
                <div class="flex items-center">
                  <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center mr-3 shadow-sm">
                    <i class="fas fa-calculator text-blue-600"></i>
                  </div>
                  <div>
                    <span class="text-blue-900 font-semibold text-sm md:text-base">ระยะเวลาเช่ารวม</span>
                    <p class="text-xs text-gray-600 hidden md:block">คำนวณอัตโนมัติจากวันที่และเวลา</p>
                  </div>
                </div>
                <div class="text-right">
                  <p id="rental-duration-display" class="text-green-600 font-bold text-lg md:text-xl">
                  </p>
                  <div id="rental-duration-note" style="display: none;"
                    class="text-xs text-orange-600 mt-1 bg-green-100 px-2 py-1 rounded-full">
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-map-marker-alt mr-2 text-green-500"></i>สถานที่รับรถ
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <div class="flex space-x-2">
                    <div class="relative w-full">
                      <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-map-marker-alt text-green-500"></i>
                      </div>
                      <input type="text" x-model="newRental.สถานที่รับรถ" list="pickup-locations"
                        placeholder="เลือกหรือพิมพ์สถานที่รับรถ"
                        class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all duration-300">
                      <datalist id="pickup-locations">
                        <template x-for="location in pickupLocations" :key="location">
                          <option :value="location"></option>
                        </template>
                      </datalist>
                    </div>
                    <button @click="openPickupEditor" type="button"
                      class="px-4 py-3 border-2 border-green-300 rounded-xl text-green-700 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-4 focus:ring-green-100 transition-all duration-300"
                      title="แก้ไขรายการสถานที่รับรถ">
                      <i class="fas fa-cog"></i>
                    </button>
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>สถานที่คืนรถ
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <div class="flex space-x-2">
                    <div class="relative w-full">
                      <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-map-marker-alt text-red-500"></i>
                      </div>
                      <input type="text" x-model="newRental.สถานที่คืนรถ" list="return-locations"
                        placeholder="เลือกหรือพิมพ์สถานที่คืนรถ"
                        class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all duration-300">
                      <datalist id="return-locations">
                        <template x-for="location in returnLocations" :key="location">
                          <option :value="location"></option>
                        </template>
                      </datalist>
                    </div>
                    <button @click="openReturnEditor" type="button"
                      class="px-4 py-3 border-2 border-red-300 rounded-xl text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-4 focus:ring-red-100 transition-all duration-300"
                      title="แก้ไขรายการสถานที่คืนรถ">
                      <i class="fas fa-cog"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div data-tutorial="customer-info" class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up"
              style="animation-delay: 0.2s;">
              <div class="flex items-center mb-6">
                <div class="w-12 h-12 gradient-bg-3 rounded-full flex items-center justify-center mr-4">
                  <i class="fas fa-user text-white text-xl"></i>
                </div>
                <div>
                  <h2 class="text-2xl font-bold text-gray-800">ข้อมูลลูกค้า</h2>
                  <p class="text-gray-600">กรอกรายละเอียดของผู้เช่ารถ</p>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-user-circle mr-2 text-purple-500"></i>ชื่อ-นามสกุล
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <input type="text" x-model="newRental.ชื่อลูกค้า" required placeholder="นายสมชาย ใจดี"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-300">
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-phone mr-2 text-green-500"></i>เบอร์โทรศัพท์
                    <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                  </label>
                  <div class="relative">
                    <input type="tel" x-model="newRental.เบอร์โทรศัพท์" @input="searchCustomer($event)" required
                      placeholder="081-234-5678"
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all duration-300">
                    <div x-show="isCustomerSearching" class="absolute right-4 top-1/2 transform -translate-y-1/2">
                      <div class="animate-spin rounded-full h-5 w-5 border-2 border-red-500 border-t-transparent">
                      </div>
                    </div>

                    <div x-show="customerSearchResults.length > 0" x-transition
                      @click.away="clearCustomerSearchResults()"
                      class="absolute z-40 mt-2 w-full bg-white shadow-lg rounded-xl border-2 border-gray-200 max-h-60 overflow-y-auto">
                      <div
                        class="p-3 bg-blue-50 border-b text-sm font-medium text-blue-700 flex justify-between items-center">
                        <div>
                          <i class="fas fa-users mr-2"></i>พบข้อมูลลูกค้าเดิม กดเลือกเพื่อใช้ข้อมูล
                        </div>
                        <button @click.prevent="clearCustomerSearchResults()"
                          class="ml-2 p-1 hover:bg-blue-200 rounded-full transition-colors duration-200 text-blue-600 hover:text-blue-800">
                          <i class="fas fa-times text-sm"></i>
                        </button>
                      </div>
                      <ul>
                        <template x-for="(customer, index) in customerSearchResults" :key="index">
                          <li @click="selectCustomer(customer)"
                            class="p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0 transition-colors duration-200">
                            <div class="font-semibold text-gray-800" x-text="customer.ชื่อลูกค้า"></div>
                            <div class="text-sm text-gray-600 flex items-center mt-1">
                              <i class="fas fa-phone mr-1"></i>
                              <span x-text="customer.เบอร์โทรศัพท์"></span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1" x-text="'ID: ' + customer.เลขบัตรประชาชน"></div>
                          </li>
                        </template>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-id-card mr-2 text-red-500"></i>เลขบัตรประชาชน/Passport
                    <span id="idCardVerifyResult" class="ml-2"></span>
                  </label>
                  <div class="relative">
                    <input type="text" x-model="newRental.เลขบัตรประชาชน"
                      @input="validateIdPassport($event); searchCustomer($event)" @blur="checkIdCardHistory($event)"
                      placeholder="เลขบัตรประชาชน 13 หลัก หรือ Passport"
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all duration-300">

                    <div x-show="isCustomerSearching" class="absolute right-4 top-1/2 transform -translate-y-1/2">
                      <div class="animate-spin rounded-full h-5 w-5 border-2 border-red-500 border-t-transparent">
                      </div>
                    </div>

                    <div x-show="customerSearchResults.length > 0" x-transition
                      class="absolute z-40 mt-2 w-full bg-white shadow-lg rounded-xl border-2 border-gray-200 max-h-60 overflow-y-auto">
                      <div class="p-3 bg-blue-50 border-b text-sm font-medium text-blue-700">
                        <i class="fas fa-users mr-2"></i>พบข้อมูลลูกค้าเดิม กดเลือกเพื่อใช้ข้อมูล
                      </div>
                      <ul>
                        <template x-for="(customer, index) in customerSearchResults" :key="index">
                          <li @click="selectCustomer(customer)"
                            class="p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0 transition-colors duration-200">
                            <div class="font-semibold text-gray-800" x-text="customer.ชื่อลูกค้า"></div>
                            <div class="text-sm text-gray-600 flex items-center mt-1">
                              <i class="fas fa-phone mr-1"></i>
                              <span x-text="customer.เบอร์โทรศัพท์"></span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1" x-text="'ID: ' + customer.เลขบัตรประชาชน"></div>
                          </li>
                        </template>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-id-card-alt mr-2 text-blue-500"></i>หมายเลขใบขับขี่
                  </label>
                  <input type="text" x-model="newRental.หมายเลขใบขับขี่" placeholder="12345678"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                </div>
              </div>

              <div class="mt-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt mr-2 text-orange-500"></i>ที่อยู่
                </label>
                <textarea x-model="newRental.ที่อยู่ลูกค้า" rows="3"
                  placeholder="123/45 หมู่ 1 ตำบล... อำเภอ... จังหวัด..."
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-100 transition-all duration-300 resize-none"></textarea>
              </div>

              <div class="mt-6 border-t pt-6"
                x-data="{ dragging: null, showDocuments: false, isLargeScreen: window.innerWidth >= 640, buttonAnimated: false }"
                x-init="
                            window.addEventListener('resize', () => { isLargeScreen = window.innerWidth >= 640 });
                            // Intersection Observer เพื่อเริ่ม animation เมื่อเลื่อนมาถึง
                            const observer = new IntersectionObserver((entries) => {
                                entries.forEach(entry => {
                                    if (entry.isIntersecting && !showDocuments) {
                                        buttonAnimated = true;
                                    }
                                });
                            }, { threshold: 0.5 });
                            observer.observe($el);
                        ">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-camera mr-2 text-gray-400"></i>
                    อัปโหลดเอกสาร
                  </h3>
                  <!-- ปุ่มยุบ/ขยาย สำหรับจอเล็ก -->
                  <button type="button" @click="showDocuments = !showDocuments; buttonAnimated = false"
                    class="sm:hidden flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 shadow-lg transition-all"
                    :class="{ 'animate-bounce': buttonAnimated && !showDocuments }"
                    style="animation-iteration-count: 3;">
                    <i class="fas text-white text-sm" :class="showDocuments ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                  </button>
                </div>

                <!-- Content: จอเล็กใช้ x-show, จอใหญ่แสดงตลอด -->
                <div x-show="showDocuments || isLargeScreen" x-transition>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="p-4 border rounded-lg bg-gray-50 space-y-3 flex flex-col"
                      @dragover.prevent="dragging = 'idCard'" @dragleave.prevent="dragging = null"
                      @drop.prevent="handleFileUpload($event, 'idCard'); dragging = null">

                      <label class="font-medium text-gray-700">รูปบัตรประชาชน</label>
                      <input type="file" @change="handleFileUpload($event, 'idCard')" accept="image/*" class="hidden"
                        x-ref="idCardInput">

                      <template x-if="!newRental.idCardPreviewUrl">
                        <div @click="$refs.idCardInput.click()"
                          class="flex-grow w-full text-center py-6 border-2 border-dashed rounded-lg text-gray-500 hover:border-blue-500 hover:bg-gray-100 cursor-pointer transition-colors duration-200 flex flex-col justify-center items-center"
                          :class="{ 'border-blue-500 bg-blue-50': dragging === 'idCard' }">
                          <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-gray-400"></i>
                          <span>คลิกเพื่อเลือกไฟล์</span>
                        </div>
                      </template>

                      <template x-if="newRental.idCardPreviewUrl">
                        <div class="space-y-2" x-transition>
                          <div class="relative group">
                            <img :src="newRental.idCardPreviewUrl"
                              @click="openLargeImagePreview(newRental.idCardPreviewUrl)"
                              class="w-full h-40 rounded-md object-cover cursor-pointer group-hover:opacity-80 transition-opacity">
                            <button @click="removeFile('idCard')" type="button"
                              class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-md hover:bg-red-600 transition-transform transform hover:scale-110">
                              <i class="fas fa-times text-sm"></i>
                            </button>
                          </div>
                          <div x-show="newRental.idCardFile"
                            class="text-xs text-center text-gray-600 bg-gray-100 px-2 py-1 rounded truncate"
                            x-text="newRental.idCardFile?.name"></div>
                        </div>
                      </template>

                      <button @click="extractIdCardData()" x-show="newRental.idCardFile" type="button"
                        :disabled="isIdCardProcessing"
                        class="w-full mt-2 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center transition-colors">
                        <i :class="isIdCardProcessing ? 'fas fa-spinner fa-spin' : 'fas fa-cogs'" class="mr-2"></i>
                        <span x-text="isIdCardProcessing ? 'กำลังประมวลผล...' : 'ดึงข้อมูลจากรูป'"></span>
                      </button>
                      <p x-text="idCardProcessStatus" class="text-xs text-center h-4"
                        :class="{ 'text-green-600': idCardProcessStatus.includes('สำเร็จ'), 'text-red-600': idCardProcessStatus.includes('ไม่สำเร็จ') }">
                      </p>
                    </div>

                    <div class="p-4 border rounded-lg bg-gray-50 space-y-3 flex flex-col"
                      @dragover.prevent="dragging = 'drivingLicense'" @dragleave.prevent="dragging = null"
                      @drop.prevent="handleFileUpload($event, 'drivingLicense'); dragging = null">

                      <label class="font-medium text-gray-700">รูปใบขับขี่</label>
                      <input type="file" @change="handleFileUpload($event, 'drivingLicense')" accept="image/*"
                        class="hidden" x-ref="drivingLicenseInput">

                      <template x-if="!newRental.drivingLicensePreviewUrl">
                        <div @click="$refs.drivingLicenseInput.click()"
                          class="flex-grow w-full text-center py-6 border-2 border-dashed rounded-lg text-gray-500 hover:border-blue-500 hover:bg-gray-100 cursor-pointer transition-colors duration-200 flex flex-col justify-center items-center"
                          :class="{ 'border-blue-500 bg-blue-50': dragging === 'drivingLicense' }">
                          <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-gray-400"></i>
                          <span>คลิกเพื่อเลือกไฟล์</span>
                        </div>
                      </template>

                      <template x-if="newRental.drivingLicensePreviewUrl">
                        <div class="space-y-2" x-transition>
                          <div class="relative group">
                            <img :src="newRental.drivingLicensePreviewUrl"
                              @click="openLargeImagePreview(newRental.drivingLicensePreviewUrl)"
                              class="w-full h-40 rounded-md object-cover cursor-pointer group-hover:opacity-80 transition-opacity">
                            <button @click="removeFile('drivingLicense')" type="button"
                              class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-md hover:bg-red-600 transition-transform transform hover:scale-110">
                              <i class="fas fa-times text-sm"></i>
                            </button>
                          </div>
                          <div x-show="newRental.drivingLicenseFile"
                            class="text-xs text-center text-gray-600 bg-gray-100 px-2 py-1 rounded truncate"
                            x-text="newRental.drivingLicenseFile?.name"></div>
                        </div>
                      </template>

                      <button @click="extractDrivingLicenseData()" x-show="newRental.drivingLicenseFile" type="button"
                        :disabled="isDrivingLicenseProcessing"
                        class="w-full mt-2 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center transition-colors">
                        <i :class="isDrivingLicenseProcessing ? 'fas fa-spinner fa-spin' : 'fas fa-cogs'"
                          class="mr-2"></i>
                        <span x-text="isDrivingLicenseProcessing ? 'กำลังประมวลผล...' : 'ดึงข้อมูลจากรูป'"></span>
                      </button>
                      <p x-text="drivingLicenseProcessStatus" class="text-xs text-center h-4"
                        :class="{ 'text-green-600': drivingLicenseProcessStatus.includes('สำเร็จ'), 'text-red-600': drivingLicenseProcessStatus.includes('ไม่สำเร็จ') }">
                      </p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <template x-for="i in 3">
                      <div class="p-4 border rounded-lg bg-gray-50 space-y-3 flex flex-col"
                        @dragover.prevent="dragging = 'doc' + i" @dragleave.prevent="dragging = null"
                        @drop.prevent="handleFileUpload($event, 'doc' + i); dragging = null">

                        <label class="font-medium text-gray-700" x-text="'รูปเอกสารเพิ่มเติม ' + i"></label>
                        <input type="file" @change="handleFileUpload($event, 'doc' + i)" accept="image/*" class="hidden"
                          :id="'docInput' + i">

                        <template x-if="!newRental['doc' + i + 'PreviewUrl']">
                          <div @click="document.getElementById('docInput' + i).click()"
                            class="flex-grow w-full text-center py-6 border-2 border-dashed rounded-lg text-gray-500 hover:border-blue-500 hover:bg-gray-100 cursor-pointer transition-colors duration-200 flex flex-col justify-center items-center"
                            :class="{ 'border-blue-500 bg-blue-50': dragging === 'doc' + i }">
                            <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-gray-400"></i>
                            <span>คลิกเพื่อเลือกไฟล์</span>
                          </div>
                        </template>

                        <template x-if="newRental['doc' + i + 'PreviewUrl']">
                          <div class="space-y-2" x-transition>
                            <div class="relative group">
                              <img :src="newRental['doc' + i + 'PreviewUrl']"
                                @click="openLargeImagePreview(newRental['doc' + i + 'PreviewUrl'])"
                                class="w-full h-40 rounded-md object-cover cursor-pointer group-hover:opacity-80 transition-opacity">
                              <button @click="removeFile('doc' + i)" type="button"
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-md hover:bg-red-600 transition-transform transform hover:scale-110">
                                <i class="fas fa-times text-sm"></i>
                              </button>
                            </div>
                            <div x-show="newRental['doc' + i + 'File']"
                              class="text-xs text-center text-gray-600 bg-gray-100 px-2 py-1 rounded truncate"
                              x-text="newRental['doc' + i + 'File']?.name"></div>
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                </div> <!-- ปิด wrapper สำหรับ x-show collapse/expand -->
              </div>
            </div>

            <!-- ตัวเลือกเพิ่มเติม -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up"
              style="animation-delay: 0.55s;">
              <div class="flex items-center mb-6">
                <div class="w-12 h-12 gradient-bg-1 rounded-full flex items-center justify-center mr-4">
                  <i class="fas fa-plus-circle text-white text-xl"></i>
                </div>
                <div>
                  <h2 class="text-2xl font-bold text-gray-800">ตัวเลือกเพิ่มเติม</h2>
                  <p class="text-gray-600">คาร์ซีทและประกันเสริม</p>
                </div>
              </div>

              <div class="space-y-6">
                <!-- คาร์ซีท -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex items-center">
                      <i class="fas fa-baby mr-2 text-purple-500"></i>
                      <label class="font-semibold text-gray-700">ต้องการคาร์ซีท</label>
                    </div>
                    <input type="checkbox" x-model="newRental.ต้องการคาร์ซีท"
                      @change="if (!newRental.ต้องการคาร์ซีท) { newRental.คาร์ซีทมีค่าบริการ = false; newRental.ค่าคาร์ซีท = 0; } calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount();"
                      class="toggle-switch">
                  </div>

                  <div x-show="newRental.ต้องการคาร์ซีท" x-transition class="pl-4 space-y-3">
                    <div class="flex items-center space-x-4">
                      <label class="flex items-center cursor-pointer">
                        <input type="radio" x-model="newRental.คาร์ซีทมีค่าบริการ" value="false"
                          @change="newRental.ค่าคาร์ซีท = 0; calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount();"
                          class="mr-2">
                        <span class="text-sm text-gray-700">ไม่มีค่าบริการ</span>
                      </label>
                      <label class="flex items-center cursor-pointer">
                        <input type="radio" x-model="newRental.คาร์ซีทมีค่าบริการ" value="true" class="mr-2">
                        <span class="text-sm text-gray-700">มีค่าบริการ</span>
                      </label>
                    </div>

                    <div x-show="newRental.คาร์ซีทมีค่าบริการ === true || newRental.คาร์ซีทมีค่าบริการ === 'true'"
                      x-transition>
                      <label class="block text-sm font-medium text-gray-700 mb-2">ค่าบริการคาร์ซีท</label>
                      <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-purple-600">฿</span>
                        <input type="number" x-model="newRental.ค่าคาร์ซีท"
                          @input="calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount();"
                          placeholder="ระบุค่าบริการ"
                          class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all">
                      </div>
                      <template
                        x-if="newRental.ค่าคาร์ซีท && parseFloat(newRental.ค่าคาร์ซีท) > 0 && (newRental.wantsTaxInvoice || newRental.wantsWHT)">
                        <div class="mt-3 flex items-center space-x-4 bg-white p-3 rounded-lg border border-purple-200">
                          <span class="text-sm font-medium text-gray-700">นำไปคำนวณ:</span>
                          <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="checkbox" x-model="newRental.carSeatIncludeVAT"
                              @change="recalculateVATBase(); calculateWHT(); calculateFinalAmount()"
                              class="form-checkbox h-4 w-4 text-green-600">
                            <span class="text-sm text-gray-700">VAT</span>
                          </label>
                          <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="checkbox" x-model="newRental.carSeatIncludeWHT"
                              @change="calculateWHT(); calculateFinalAmount()"
                              class="form-checkbox h-4 w-4 text-orange-600">
                            <span class="text-sm text-gray-700">หัก ณ ที่จ่าย</span>
                          </label>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- ประกันเสริม -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between p-3 bg-teal-50 rounded-lg border border-teal-200">
                    <div class="flex items-center">
                      <i class="fas fa-shield-alt mr-2 text-teal-500"></i>
                      <label class="font-semibold text-gray-700">ประกันเสริม</label>
                    </div>
                    <input type="checkbox" x-model="newRental.ต้องการประกันเสริม"
                      @change="if (!newRental.ต้องการประกันเสริม) { newRental.จำนวนวันประกันเสริม = 0; newRental.ราคาประกันเสริมต่อวัน = 0; newRental.ค่าประกันเสริมรวม = 0; } else { const rentalInfo = calculateRentalDaysWithHours(newRental.วันที่เช่า, newRental.วันที่คืน, newRental.เวลารับรถ, newRental.เวลาคืนรถ); newRental.จำนวนวันประกันเสริม = rentalInfo.days || 1; newRental.ราคาประกันเสริมต่อวัน = parseFloat(config.ค่าประกันเสริมต่อวัน) || 0; newRental.ค่าประกันเสริมรวม = newRental.จำนวนวันประกันเสริม * newRental.ราคาประกันเสริมต่อวัน; } calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount();"
                      class="toggle-switch">
                  </div>

                  <div x-show="newRental.ต้องการประกันเสริม" x-transition class="pl-4 space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนวันที่ซื้อ</label>
                        <input type="number" x-model="newRental.จำนวนวันประกันเสริม"
                          @input="newRental.ค่าประกันเสริมรวม = (parseFloat(newRental.จำนวนวันประกันเสริม) || 0) * (parseFloat(newRental.ราคาประกันเสริมต่อวัน) || 0); calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount();"
                          min="1"
                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all">
                      </div>

                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          ราคาประกันเสริมต่อวัน
                          <span x-show="!config.ค่าประกันเสริมต่อวัน || config.ค่าประกันเสริมต่อวัน == 0"
                            class="text-xs text-orange-600">(ยังไม่ตั้งค่า)</span>
                        </label>
                        <div class="relative">
                          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-teal-600">฿</span>
                          <input type="number" x-model="newRental.ราคาประกันเสริมต่อวัน"
                            @input="newRental.ค่าประกันเสริมรวม = (parseFloat(newRental.จำนวนวันประกันเสริม) || 0) * (parseFloat(newRental.ราคาประกันเสริมต่อวัน) || 0); calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount();"
                            placeholder="0"
                            class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all">
                        </div>
                        <p x-show="!config.ค่าประกันเสริมต่อวัน || config.ค่าประกันเสริมต่อวัน == 0"
                          class="text-xs text-orange-600 mt-1">
                          <i class="fas fa-info-circle mr-1"></i>ตั้งค่าได้ที่หน้าตั้งค่าระบบ
                        </p>
                      </div>

                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ราคาประกันเสริมรวม</label>
                        <div class="relative">
                          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-teal-600">฿</span>
                          <input type="number" x-model="newRental.ค่าประกันเสริมรวม" readonly
                            class="w-full pl-8 px-4 py-3 border-2 border-teal-400 rounded-xl bg-teal-50 text-teal-700 font-bold">
                        </div>
                      </div>
                    </div>
                    <template
                      x-if="newRental.ค่าประกันเสริมรวม && parseFloat(newRental.ค่าประกันเสริมรวม) > 0 && (newRental.wantsTaxInvoice || newRental.wantsWHT)">
                      <div class="mt-3 flex items-center space-x-4 bg-white p-3 rounded-lg border border-teal-200">
                        <span class="text-sm font-medium text-gray-700">นำไปคำนวณ:</span>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="newRental.insuranceIncludeVAT"
                            @change="recalculateVATBase(); calculateWHT(); calculateFinalAmount()"
                            class="form-checkbox h-4 w-4 text-green-600">
                          <span class="text-sm text-gray-700">VAT</span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="newRental.insuranceIncludeWHT"
                            @change="calculateWHT(); calculateFinalAmount()"
                            class="form-checkbox h-4 w-4 text-orange-600">
                          <span class="text-sm text-gray-700">หัก ณ ที่จ่าย</span>
                        </label>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <div data-tutorial="pricing-info" class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up"
              style="animation-delay: 0.6s;">
              <div class="flex items-center mb-6">
                <div class="w-12 h-12 gradient-bg-5 rounded-full flex items-center justify-center mr-4">
                  <i class="fas fa-money-bill-wave text-white text-xl"></i>
                </div>
                <div>
                  <h2 class="text-2xl font-bold text-gray-800">ข้อมูลการชำระเงิน</h2>
                  <p class="text-gray-600">กำหนดราคาและค่าใช้จ่ายต่างๆ</p>
                </div>
              </div>

              <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
                <h3 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                  <i class="fas fa-calculator mr-2"></i>ค่าเช่าหลัก
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      ค่าเช่าต่อวัน
                      <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                      <input type="number" x-model="newRental.ราคา" @input="calculateTotalRental()" required
                        placeholder="1000"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      ค่าบริการเพิ่มเติม
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                      <input type="number" x-model="newRental.ค่าบริการเพิ่มเติม"
                        @input="calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount();"
                        placeholder="หากไม่มีให้เว้นว่างไว้"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                    </div>
                    <template
                      x-if="newRental.ค่าบริการเพิ่มเติม && parseFloat(newRental.ค่าบริการเพิ่มเติม) > 0 && (newRental.wantsTaxInvoice || newRental.wantsWHT)">
                      <div class="mt-2 flex items-center space-x-4 bg-white p-3 rounded-lg border border-blue-200">
                        <span class="text-sm font-medium text-gray-700">นำไปคำนวณ:</span>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="newRental.additionalServiceIncludeVAT"
                            @change="recalculateVATBase(); calculateWHT(); calculateFinalAmount()"
                            class="form-checkbox h-4 w-4 text-green-600">
                          <span class="text-sm text-gray-700">VAT</span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="newRental.additionalServiceIncludeWHT"
                            @change="calculateWHT(); calculateFinalAmount()"
                            class="form-checkbox h-4 w-4 text-orange-600">
                          <span class="text-sm text-gray-700">หัก ณ ที่จ่าย</span>
                        </label>
                      </div>
                    </template>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      <i class="fas fa-tags mr-2 text-red-500"></i>ส่วนลด
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-red-600">฿</span>
                      <input type="number" x-model="newRental.ส่วนลด"
                        @input="calculateTotalRental(); recalculateVATBase(); calculateWHT(); calculateFinalAmount()"
                        placeholder="จำนวนเงินส่วนลด"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all">
                    </div>
                  </div>

                  <!-- ค่าล่วงเวลา (ถ้ามี) -->
                  <div class="space-y-2" x-show="newRental.ค่าล่วงเวลา > 0">
                    <label class="block text-sm font-semibold text-orange-700">
                      <i class="fas fa-clock mr-1"></i>
                      ค่าล่วงเวลา
                      <span class="text-xs text-gray-500">
                        <template
                          x-if="(config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0) > 0 && (newRental.ชั่วโมงล่วงเวลา || 0) > 0">
                          <span
                            x-text="'(' + ((newRental.ชั่วโมงล่วงเวลา - (config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0)) > 0 ? (newRental.ชั่วโมงล่วงเวลา - (config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0)).toFixed(2) : '0.00') + ' ชม. หลังหักชั่วโมงฟรี ' + (config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0) + ' ชั่วโมง)'"></span>
                        </template>
                        <template
                          x-if="!((config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0) > 0 && (newRental.ชั่วโมงล่วงเวลา || 0) > 0)">
                          <span x-text="'(' + (newRental.ชั่วโมงล่วงเวลา || 0).toFixed(2) + ' ชม.)'"></span>
                        </template>
                      </span>
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-orange-600">฿</span>
                      <input type="number" x-model="newRental.ค่าล่วงเวลา"
                        @input="calculateAllTaxes(); calculateCommission(); calculateFinalAmount()"
                        placeholder="ค่าล่วงเวลา"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-100 transition-all">
                    </div>
                    <!-- แสดงคำเตือนเมื่อใช้ค่าเริ่มต้น -->
                    <div x-show="newRental.usingDefaultOvertimeRate"
                      class="flex items-start gap-2 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
                      <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                      <p class="text-xs text-yellow-800">
                        <strong>รถคันนี้ยังไม่ได้ตั้งค่าค่าล่วงเวลาต่อชั่วโมง</strong><br>
                        ใช้ค่าเริ่มต้น (<span x-text="config.ค่าล่วงเวลาเริ่มต้น || 100"></span> บาท/ชั่วโมง)
                        โปรดไปตั้งค่าที่หน้า <strong>จัดการรถ</strong>
                      </p>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-blue-700">
                      ค่าเช่ารวมทั้งหมด
                      <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                      <input type="number" step="0.01" x-model="newRental.ค่าเช่ารวมทั้งหมด"
                        @input="calculateFinalAmount(); calculateCommission()"
                        placeholder="ค่าเช่าทั้งหมด รวมค่าบริการเพิ่มเติมแล้ว" readonly
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 cursor-not-allowed transition-all">
                    </div>
                  </div>

                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4 mt-4">
                  <h5 class="text-md font-medium text-blue-800 mb-2">💡 วิธีการคำนวณ</h5>
                  <div class="text-sm text-blue-700 space-y-1">
                    <div><strong>ค่าเช่ารวมทั้งหมด</strong> = (ราคาต่อวัน × จำนวนวัน) + ค่าล่วงเวลา +
                      ค่าบริการเพิ่มเติม + ค่าคาร์ซีท + ค่าประกันเสริม - ส่วนลด</div>
                    <div><strong>ค่าล่วงเวลา</strong> = (ชั่วโมงเกิน - ชั่วโมงฟรี) × ค่าล่วงเวลาต่อชั่วโมง</div>
                    <div><strong>ค่าประกันเสริม</strong> = จำนวนวันที่ซื้อ × ราคาประกันเสริมต่อวัน</div>
                    <div class="text-xs italic text-blue-600 mt-2">
                      <i class="fas fa-info-circle mr-1"></i>
                      หากชั่วโมงเกิน >= <span x-text="config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน || 4"></span> ชม.
                      จะคิดเพิ่มเป็นอีก 1 วันทันที (ไม่คิดค่าล่วงเวลา)
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up"
                style="animation-delay: 0.9s;">
                <div class="flex items-center mb-6">
                  <div class="w-12 h-12 gradient-bg-3 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-receipt text-white text-xl"></i>
                  </div>
                  <div>
                    <h2 class="text-2xl font-bold text-gray-800">ข้อมูลใบเสร็จ</h2>
                    <p class="text-gray-600">เลือกประเภทเอกสารที่ลูกค้าต้องการ</p>
                  </div>
                </div>

                <div class="space-y-4">
                  <!-- 3 Toggles ในแนวนอน -->
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <label @click="newRental.wantsTaxInvoice = false"
                      class="flex items-center justify-between p-4 border rounded-xl cursor-pointer transition-all"
                      :class="{'bg-blue-100 border-blue-500 ring-2 ring-blue-300': newRental.wantsCashBill}">
                      <div class="flex items-center">
                        <i class="fas fa-money-bill-wave mr-3 text-blue-500 text-xl"></i>
                        <div>
                          <div class="font-semibold text-gray-800">ต้องการบิลเงินสด</div>
                        </div>
                      </div>
                      <input type="checkbox" x-model="newRental.wantsCashBill" class="toggle-switch">
                    </label>

                    <label @click="newRental.wantsCashBill = false"
                      class="flex items-center justify-between p-4 border rounded-xl cursor-pointer transition-all"
                      :class="{'bg-green-100 border-green-500 ring-2 ring-green-300': newRental.wantsTaxInvoice}">
                      <div class="flex items-center">
                        <i class="fas fa-file-invoice-dollar mr-3 text-green-500 text-xl"></i>
                        <div>
                          <div class="font-semibold text-gray-800">ต้องการใบกำกับภาษี</div>
                        </div>
                      </div>
                      <input type="checkbox" x-model="newRental.wantsTaxInvoice" @change="toggleTaxInvoice()"
                        class="toggle-switch">
                    </label>

                    <label class="flex items-center justify-between p-4 border rounded-xl cursor-pointer transition-all"
                      :class="{'bg-orange-100 border-orange-500 ring-2 ring-orange-300': newRental.wantsWHT}">
                      <div class="flex items-center">
                        <i class="fas fa-file-invoice mr-3 text-orange-500 text-xl"></i>
                        <div>
                          <div class="font-semibold text-gray-800">ต้องการหัก ณ ที่จ่าย</div>
                        </div>
                      </div>
                      <input type="checkbox" x-model="newRental.wantsWHT" @change="toggleWHT()" class="toggle-switch">
                    </label>
                  </div>

                  <!-- ฟิลด์ VAT สำหรับใบกำกับภาษี (กระชับ) -->
                  <div x-show="newRental.wantsTaxInvoice" x-transition
                    class="p-4 bg-green-50 rounded-xl border border-green-200 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div class="space-y-1">
                        <label class="block text-xs font-semibold text-green-700">
                          ฐานคำนวณ VAT
                        </label>
                        <div class="relative">
                          <span class="absolute inset-y-0 left-0 flex items-center pl-2 text-green-600 text-sm">฿</span>
                          <input type="number" step="0.01" x-model="newRental.taxInvoiceAmountExVAT"
                            @input="calculateTaxInvoiceVAT()"
                            class="w-full pl-6 px-3 py-2 border border-green-300 rounded-lg text-sm focus:border-green-500 focus:ring-2 focus:ring-green-100">
                        </div>
                      </div>
                      <div class="space-y-1">
                        <label class="block text-xs font-semibold text-green-700">VAT 7%</label>
                        <div
                          class="bg-white px-3 py-2 border border-green-200 rounded-lg text-sm font-semibold text-green-800">
                          ฿<span x-text="formatNumber(newRental.taxInvoiceVATAmount)"></span>
                        </div>
                      </div>
                      <div class="space-y-1">
                        <label class="block text-xs font-semibold text-green-700">ยอดรวม VAT</label>
                        <div
                          class="bg-green-100 px-3 py-2 border border-green-300 rounded-lg text-sm font-bold text-green-900">
                          ฿<span x-text="formatNumber(newRental.taxInvoiceTotal)"></span>
                        </div>
                      </div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-green-200">
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">ยอดรวมค่าเช่าก่อน VAT:</span>
                        <span class="font-semibold"
                          x-text="(parseFloat(newRental.taxInvoiceAmountExVAT) || 0).toLocaleString('th-TH') + ' บาท'"></span>
                      </div>
                    </div>

                    <div class="text-xs text-green-700 bg-white p-3 rounded-lg">
                      <i class="fas fa-info-circle mr-1"></i>
                      <strong>หมายเหตุ:</strong> VAT 7% คำนวณจากยอดค่าเช่าที่รวมในใบกำกับภาษี
                    </div>
                  </div>
                  <div x-show="newRental.wantsWHT" x-transition
                    class="mt-4 p-4 bg-orange-50 rounded-xl border border-orange-200 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          <i class="fas fa-percent mr-1 text-orange-500"></i>
                          เปอร์เซ็นต์หัก ณ ที่จ่าย
                        </label>
                        <div class="relative">
                          <input type="number" x-model="newRental.whtPercentage"
                            @input="calculateWHT(); calculateFinalAmount()" min="0" max="15" step="0.5"
                            class="w-full px-4 py-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white">
                          <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">%</span>
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          <i class="fas fa-calculator mr-1 text-orange-500"></i>
                          จำนวนเงินหัก ณ ที่จ่าย
                        </label>
                        <div class="relative">
                          <input type="text"
                            :value="newRental.whtAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
                            readonly
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 font-semibold text-orange-700">
                          <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">บาท</span>
                        </div>
                      </div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-orange-200">
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">ฐานคำนวณ (ก่อน VAT):</span>
                        <span class="font-semibold"
                          x-text="(parseFloat(newRental.whtBaseAmount) || 0).toLocaleString('th-TH') + ' บาท'"></span>
                      </div>
                    </div>

                    <div class="text-xs text-orange-700 bg-white p-3 rounded-lg">
                      <i class="fas fa-info-circle mr-1"></i>
                      <strong>หมายเหตุ:</strong> หัก ณ ที่จ่าย คำนวณจากยอดก่อน VAT
                    </div>
                  </div>
                </div>
              </div>

              <div class="bg-green-50 p-6 rounded-xl border border-green-200 mb-6 mt-6">
                <h3 class="text-lg font-semibold text-green-700 mb-4 flex items-center">
                  <i class="fas fa-shield-alt mr-2"></i>เงินมัดจำและประกัน
                </h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      ค่ามัดจำคิวรถ
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-green-600">฿</span>
                      <input type="number" x-model="newRental.ค่ามัดจำคิวรถ" @input="calculateFinalAmount()"
                        class="w-full pl-8 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      เงินประกันความเสียหาย
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-green-600">฿</span>
                      <input type="number" x-model="newRental.เงินประกันความเสียหาย" @input="calculateFinalAmount()"
                        class="w-full pl-8 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Wrapper: สรุปภาพรวมค่าใช้จ่าย -->
              <div
                class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl shadow-xl p-6 border-2 border-indigo-200 mb-6">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-2xl font-extrabold text-indigo-900 flex items-center">
                    <div
                      class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                      <i class="fas fa-chart-pie text-white text-xl"></i>
                    </div>
                    สรุปภาพรวมค่าใช้จ่าย
                  </h3>
                </div>

                <!-- กรอบที่ 1: รายละเอียดค่าเช่า (สีเขียว) -->
                <div class="bg-green-50 p-4 rounded-xl border border-green-200 mb-4">
                  <h3 class="text-base font-semibold text-green-700 flex items-center mb-3">
                    <i class="fas fa-receipt mr-2"></i>รายละเอียดค่าเช่า
                  </h3>
                  <div class="text-sm space-y-1 text-green-800">
                    <div class="flex justify-between">
                      <span>ค่าเช่าพื้นฐาน (<span x-text="newRental.จำนวนวันเช่า || 0"></span> วัน × <span
                          x-text="formatCurrency(newRental.ราคา)"></span>)</span>
                      <span x-text="formatCurrency(newRental.ค่าเช่าพื้นฐาน || 0)"></span>
                    </div>
                    <template x-if="(parseFloat(newRental.ค่าล่วงเวลา) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าล่วงเวลา</span>
                        <span x-text="formatCurrency(newRental.ค่าล่วงเวลา)"></span>
                      </div>
                    </template>
                    <template x-if="(parseFloat(newRental.ค่าบริการเพิ่มเติม) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าบริการเพิ่มเติม</span>
                        <span x-text="formatCurrency(newRental.ค่าบริการเพิ่มเติม)"></span>
                      </div>
                    </template>
                    <template
                      x-if="newRental.ต้องการคาร์ซีท && (newRental.คาร์ซีทมีค่าบริการ === 'true' || newRental.คาร์ซีทมีค่าบริการ === true) && (parseFloat(newRental.ค่าคาร์ซีท) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าคาร์ซีท</span>
                        <span x-text="formatCurrency(newRental.ค่าคาร์ซีท)"></span>
                      </div>
                    </template>
                    <template x-if="newRental.ต้องการประกันเสริม && (parseFloat(newRental.ค่าประกันเสริมรวม) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าประกันเสริม</span>
                        <span x-text="formatCurrency(newRental.ค่าประกันเสริมรวม)"></span>
                      </div>
                    </template>

                    <!-- ส่วนลด -->
                    <template x-if="(parseFloat(newRental.ส่วนลด) || 0) > 0">
                      <div class="flex justify-between text-red-600 pt-2 border-t border-green-300">
                        <span>- ส่วนลด</span>
                        <span x-text="formatCurrency(newRental.ส่วนลด)"></span>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- กรอบที่ 2: ใบกำกับภาษี (สีฟ้า) -->
                <template x-if="newRental.wantsTaxInvoice && (parseFloat(newRental.taxInvoiceVATAmount) || 0) > 0">
                  <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-4">
                    <h3 class="text-base font-semibold text-blue-700 flex items-center mb-3">
                      <i class="fas fa-file-invoice mr-2"></i>ใบกำกับภาษี
                    </h3>
                    <div class="text-sm space-y-1 text-blue-800">
                      <div class="flex justify-between">
                        <span>จำนวนเงินที่นำมาคำนวณ VAT</span>
                        <span x-text="formatCurrencyOptional(newRental.taxInvoiceAmountExVAT)"></span>
                      </div>
                      <div class="flex justify-between">
                        <span>VAT 7%</span>
                        <span x-text="formatCurrencyOptional(newRental.taxInvoiceVATAmount)"></span>
                      </div>
                      <div class="flex justify-between font-bold pt-2 border-t border-blue-300 text-blue-900">
                        <span>= ยอดรวม VAT</span>
                        <span x-text="formatCurrencyOptional(newRental.taxInvoiceTotal)"></span>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- กรอบที่ 3: หัก ณ ที่จ่าย (สีส้ม) -->
                <template x-if="newRental.wantsWHT && (parseFloat(newRental.whtAmount) || 0) > 0">
                  <div class="bg-orange-50 p-4 rounded-xl border border-orange-200 mb-4">
                    <h3 class="text-base font-semibold text-orange-700 flex items-center mb-3">
                      <i class="fas fa-file-contract mr-2"></i>หัก ณ ที่จ่าย
                    </h3>
                    <div class="text-sm space-y-1 text-orange-800">
                      <div class="flex justify-between">
                        <span>ฐานคำนวณ (ก่อน VAT)</span>
                        <span x-text="formatCurrencyOptional(parseFloat(newRental.whtBaseAmount) || 0)"></span>
                      </div>
                      <div class="flex justify-between font-bold pt-2 border-t border-orange-300 text-orange-900">
                        <span>= หัก <span x-text="newRental.whtPercentage || 5"></span>%</span>
                        <span x-text="'-' + formatCurrencyOptional(newRental.whtAmount)"></span>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- กรอบที่ 4: สรุปค่าเช่ารวมทั้งหมด (สีเทา) -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-300 mb-4">
                  <h3 class="text-base font-semibold text-gray-700 flex items-center mb-3">
                    <i class="fas fa-calculator mr-2"></i>สรุปค่าเช่ารวมทั้งหมด
                  </h3>
                  <div class="text-sm space-y-1 text-gray-800">
                    <!-- กรณีมี VAT/WHT -->
                    <template x-if="newRental.wantsTaxInvoice || newRental.wantsWHT">
                      <div class="space-y-1">
                        <div class="flex justify-between">
                          <span>ยอดคิด VAT/WHT (ค่าเช่า + VAT - WHT)</span>
                          <span
                            x-text="((parseFloat(newRental.taxInvoiceTotal) || parseFloat(newRental.taxInvoiceAmountExVAT) || 0) - (parseFloat(newRental.whtAmount) || 0)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                        </div>

                        <!-- แจกแจงค่าใช้จ่ายที่ไม่คิด VAT/WHT -->
                        <!-- ค่าบริการเพิ่มเติม (ถ้าไม่คิด VAT) -->
                        <template
                          x-if="newRental.additionalServiceIncludeVAT !== true && (parseFloat(newRental.ค่าบริการเพิ่มเติม) || 0) > 0">
                          <div class="flex justify-between">
                            <span>+ ค่าบริการเพิ่มเติม</span>
                            <span
                              x-text="parseFloat(newRental.ค่าบริการเพิ่มเติม).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                          </div>
                        </template>

                        <!-- ค่าคาร์ซีท (ถ้าไม่คิด VAT) -->
                        <template
                          x-if="newRental.carSeatIncludeVAT !== true && (parseFloat(newRental.ค่าคาร์ซีท) || 0) > 0">
                          <div class="flex justify-between">
                            <span>+ ค่าคาร์ซีท</span>
                            <span
                              x-text="parseFloat(newRental.ค่าคาร์ซีท).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                          </div>
                        </template>

                        <!-- ค่าประกันเสริม (ถ้าไม่คิด VAT) -->
                        <template
                          x-if="newRental.insuranceIncludeVAT !== true && (parseFloat(newRental.ค่าประกันเสริมรวม) || 0) > 0">
                          <div class="flex justify-between">
                            <span>+ ค่าประกันเสริม</span>
                            <span
                              x-text="parseFloat(newRental.ค่าประกันเสริมรวม).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                          </div>
                        </template>
                      </div>
                    </template>

                    <!-- กรณีไม่มี VAT/WHT - แสดงยอดรวมตรงๆ (หลังหักส่วนลดแล้ว) -->
                    <template x-if="!newRental.wantsTaxInvoice && !newRental.wantsWHT">
                      <div class="flex justify-between">
                        <span>รวมค่าใช้จ่ายทั้งหมด (หลังหักส่วนลด)</span>
                        <span
                          x-text="((parseFloat(newRental.ค่าเช่าพื้นฐาน) || 0) + (parseFloat(newRental.ค่าล่วงเวลา) || 0) + (parseFloat(newRental.ค่าบริการเพิ่มเติม) || 0) + (parseFloat(newRental.ค่าคาร์ซีท) || 0) + (parseFloat(newRental.ค่าประกันเสริมรวม) || 0) - (parseFloat(newRental.ส่วนลด) || 0)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                      </div>
                    </template>

                    <!-- ยอดสุทธิ -->
                    <div class="flex justify-between font-bold pt-2 border-t border-gray-400 text-gray-900">
                      <span>= ค่าเช่ารวมทั้งหมด</span>
                      <span x-text="(
                          (newRental.wantsTaxInvoice || newRental.wantsWHT)
                          ? (
                              ((parseFloat(newRental.taxInvoiceTotal) || parseFloat(newRental.taxInvoiceAmountExVAT) || 0) - (parseFloat(newRental.whtAmount) || 0))
                              + (newRental.additionalServiceIncludeVAT !== true ? (parseFloat(newRental.ค่าบริการเพิ่มเติม) || 0) : 0)
                              + (newRental.carSeatIncludeVAT !== true ? (parseFloat(newRental.ค่าคาร์ซีท) || 0) : 0)
                              + (newRental.insuranceIncludeVAT !== true ? (parseFloat(newRental.ค่าประกันเสริมรวม) || 0) : 0)
                            )
                          : (
                              (parseFloat(newRental.ค่าเช่าพื้นฐาน) || 0)
                              + (parseFloat(newRental.ค่าล่วงเวลา) || 0)
                              + (parseFloat(newRental.ค่าบริการเพิ่มเติม) || 0)
                              + (parseFloat(newRental.ค่าคาร์ซีท) || 0)
                              + (parseFloat(newRental.ค่าประกันเสริมรวม) || 0)
                              - (parseFloat(newRental.ส่วนลด) || 0)
                            )
                        ).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                    </div>
                  </div>
                </div>

                <!-- กรอบที่ 5: ยอดชำระวันรับรถ (สีม่วง) -->
                <div class="bg-purple-50 p-6 rounded-xl border border-purple-200">
                  <!-- จอเล็ก: กึ่งกลาง 2 บรรทัด -->
                  <div class="sm:hidden text-center mb-4">
                    <h3 class="text-lg font-semibold text-purple-700 flex items-center justify-center mb-2">
                      <i class="fas fa-calculator mr-2"></i>รวมยอดชำระวันรับรถ
                    </h3>
                    <div class="text-3xl font-bold text-purple-700"
                      x-text="parseFloat(newRental.รวมยอดชำระวันรับรถ || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})">
                    </div>
                  </div>

                  <!-- จอใหญ่: ซ้าย-ขวา บรรทัดเดียว -->
                  <div class="hidden sm:flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-purple-700 flex items-center">
                      <i class="fas fa-calculator mr-2"></i>รวมยอดชำระวันรับรถ
                    </h3>
                    <div class="text-3xl font-bold text-purple-700"
                      x-text="parseFloat(newRental.รวมยอดชำระวันรับรถ || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})">
                    </div>
                  </div>

                  <div class="border-t border-purple-300 pt-3">
                    <div class="text-sm space-y-1 text-purple-800">
                      <!-- ยอดสุทธิค่าเช่ารวมทั้งหมด -->
                      <div class="flex justify-between font-semibold">
                        <span>ค่าเช่ารวมทั้งหมด</span>
                        <span x-text="(
                            (newRental.wantsTaxInvoice || newRental.wantsWHT)
                            ? (
                                ((parseFloat(newRental.taxInvoiceTotal) || parseFloat(newRental.taxInvoiceAmountExVAT) || 0) - (parseFloat(newRental.whtAmount) || 0))
                                + (newRental.additionalServiceIncludeVAT !== true ? (parseFloat(newRental.ค่าบริการเพิ่มเติม) || 0) : 0)
                                + (newRental.carSeatIncludeVAT !== true ? (parseFloat(newRental.ค่าคาร์ซีท) || 0) : 0)
                                + (newRental.insuranceIncludeVAT !== true ? (parseFloat(newRental.ค่าประกันเสริมรวม) || 0) : 0)
                              )
                            : (
                                (parseFloat(newRental.ค่าเช่าพื้นฐาน) || 0)
                                + (parseFloat(newRental.ค่าล่วงเวลา) || 0)
                                + (parseFloat(newRental.ค่าบริการเพิ่มเติม) || 0)
                                + (parseFloat(newRental.ค่าคาร์ซีท) || 0)
                                + (parseFloat(newRental.ค่าประกันเสริมรวม) || 0)
                                - (parseFloat(newRental.ส่วนลด) || 0)
                              )
                          ).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                      </div>

                      <!-- มัดจำและประกัน -->
                      <template x-if="(parseFloat(newRental.ค่ามัดจำคิวรถ) || 0) > 0">
                        <div class="flex justify-between text-red-600">
                          <span>- ค่ามัดจำคิวรถ</span>
                          <span
                            x-text="'-' + parseFloat(newRental.ค่ามัดจำคิวรถ).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                        </div>
                      </template>
                      <template x-if="(parseFloat(newRental.เงินประกันความเสียหาย) || 0) > 0">
                        <div class="flex justify-between text-green-600">
                          <span>+ เงินประกันความเสียหาย</span>
                          <span
                            x-text="'+' + parseFloat(newRental.เงินประกันความเสียหาย).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>

              <div data-tutorial="commission-info"
                class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up mb-6"
                style="animation-delay: 0.8s;">
                <div class="flex items-center mb-6">
                  <div class="w-12 h-12 gradient-bg-6 rounded-full flex items-center justify-center mr-4">
                    <i class="fa-solid fa-percent text-white text-xl"></i>
                  </div>
                  <div>
                    <h2 class="text-2xl font-bold text-gray-800">ข้อมูลค่าคอมมิชชั่น</h2>
                    <p class="text-gray-600">กำหนดค่าคอมมิชชั่น จะถูกบันทึกเป็นรายจ่ายให้อัตโนมัติ</p>
                  </div>
                </div>

                <div class="space-y-6">
                  <div class="flex items-center justify-between p-4 bg-purple-50 rounded-xl border border-purple-200">
                    <div class="flex items-center">
                      <i class="fas fa-percentage mr-3 text-purple-500 text-xl"></i>
                      <div>
                        <div class="font-semibold text-gray-800">มีค่าคอมมิชชั่น</div>
                        <div class="text-sm text-gray-600">เปิดใช้งานระบบคำนวณค่าคอมมิชชั่น</div>
                      </div>
                    </div>
                    <input type="checkbox" x-model="newRental.มีค่าคอมมิชชั่น" @change="commissionToggle()"
                      class="toggle-switch">
                  </div>

                  <div x-show="newRental.มีค่าคอมมิชชั่น" x-transition class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                      <label class="block text-sm font-semibold text-gray-700">
                        <i class="fas fa-list mr-2 text-blue-500"></i>เลือกประเภทคอมมิชชั่น
                      </label>
                      <select x-model="newRental.ค่าคอมมิชชั่นที่เลือก" @change="calculateCommission()"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                        <option value="">กำหนดเอง</option>
                        <template x-for="commission in commissionList" :key="commission.ชื่อ">
                          <option :value="commission.ชื่อ" x-text="commission.ชื่อ"></option>
                        </template>
                      </select>
                    </div>

                    <div class="space-y-2">
                      <label class="block text-sm font-semibold text-blue-700">
                        ค่าคอมมิชชั่น
                        <span x-show="newRental.ค่าคอมมิชชั่นที่เลือก"
                          class="text-xs text-gray-500">(คำนวณอัตโนมัติ)</span>
                        <span x-show="!newRental.ค่าคอมมิชชั่นที่เลือก" class="text-xs text-orange-600">(กำหนดเอง -
                          แก้ไขได้)</span>
                      </label>
                      <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                        <input type="number" x-model="newRental.ค่าคอมมิชชั่น"
                          :readonly="newRental.ค่าคอมมิชชั่นที่เลือก !== ''"
                          :class="newRental.ค่าคอมมิชชั่นที่เลือก ? 'bg-blue-50 border-blue-400' : 'bg-white border-orange-400'"
                          class="w-full pl-8 px-4 py-3 border-2 rounded-xl font-semibold text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                      </div>
                    </div>
                  </div>
                </div>
              </div>


              <div class="form-section bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up"
                style="animation-delay: 1s;">
                <div class="flex items-center mb-6">
                  <div class="w-12 h-12 gradient-bg-7 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-file-contract text-white text-xl"></i>
                  </div>
                  <div>
                    <h2 class="text-2xl font-bold text-gray-800">ข้อมูลสัญญาและหมายเหตุ</h2>
                    <p class="text-gray-600">ตั้งค่าการสร้างสัญญาและบันทึกเพิ่มเติม</p>
                  </div>
                </div>

                <div class="space-y-6">
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl border border-blue-200">
                      <div class="flex items-center">
                        <i class="fas fa-file-pdf mr-3 text-blue-500 text-xl"></i>
                        <div>
                          <div class="font-semibold text-gray-800">สร้างสัญญาเช่า</div>
                          <div class="text-sm text-gray-600">สร้างไฟล์ PDF สัญญาเช่าอัตโนมัติ</div>
                        </div>
                      </div>
                      <input type="checkbox" x-model="newRental.สร้างสัญญาเช่า" class="toggle-switch">
                    </div>

                    <div x-show="newRental.สร้างสัญญาเช่า" x-transition class="space-y-2">
                      <label class="block text-sm font-semibold text-gray-700">
                        <i class="fas fa-language mr-2 text-purple-500"></i>ภาษาสัญญาเช่า
                      </label>
                      <select x-model="newRental.ภาษาสัญญาเช่า"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-300">
                        <option value="th">🇹🇭 ภาษาไทย</option>
                        <option value="en">🇬🇧 ภาษาอังกฤษ</option>
                        <option value="zh-CN">🇨🇳 ภาษาจีน (ย่อ)</option>
                        <option value="zh-TW">🇹🇼 ภาษาจีน (ตัวเต็ม)</option>
                        <option value="ko">🇰🇷 ภาษาเกาหลี</option>
                        <option value="lo">🇱🇦 ภาษาลาว</option>
                        <option value="my">🇲🇲 ภาษาพม่า</option>
                        <option value="vi">🇻🇳 ภาษาเวียดนาม</option>
                        <option value="ru">🇷🇺 ภาษารัสเซีย</option>
                        <option value="ms">🇲🇾 ภาษามาเลย์</option>
                        <option value="id">🇮🇩 ภาษาอินโดนีเซีย</option>
                        <option value="ja">🇯🇵 ภาษาญี่ปุ่น</option>
                        <option value="he">🇮🇱 ภาษาฮิบรู</option>
                        <option value="fr">🇫🇷 ภาษาฝรั่งเศส</option>
                        <option value="tr">🇹🇷 ภาษาตุรกี</option>
                        <option value="es">🇪🇸 ภาษาสเปน</option>
                        <option value="it">🇮🇹 ภาษาอิตาลี</option>
                        <option value="de">🇩🇪 ภาษาเยอรมัน</option>
                      </select>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      <i class="fas fa-sticky-note mr-2 text-yellow-500"></i>หมายเหตุ
                    </label>
                    <textarea x-model="newRental.หมายเหตุ" rows="4"
                      placeholder="บันทึกเพิ่มเติม เงื่อนไขพิเศษ หรือข้อมูลสำคัญอื่นๆ..."
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-100 transition-all duration-300 resize-none"></textarea>
                  </div>
                </div>
              </div>

              <div data-tutorial="submit-buttons" class="flex flex-col sm:flex-row gap-4 justify-center fade-in-up"
                style="animation-delay: 1.2s;">

                <button type="submit" :disabled="isSubmitting"
                  :class="isSubmitting ? 'opacity-70 cursor-not-allowed' : ''"
                  class="gradient-bg-1 text-white py-4 px-8 rounded-2xl hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center group">
                  <i
                    :class="isSubmitting ? 'fas fa-spinner fa-spin mr-3' : 'fas fa-save mr-3 group-hover:rotate-12 transition-transform duration-300'"></i>
                  <span class="font-semibold"
                    x-text="isSubmitting ? 'กำลังตรวจสอบข้อมูล...' : 'บันทึกรายการเช่า'"></span>
                </button>

                <button type="button" @click="resetNewRentalForm()"
                  class="bg-gray-500 text-white py-4 px-8 rounded-2xl hover:bg-gray-600 hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center group">
                  <i class="fas fa-undo mr-3 group-hover:-rotate-180 transition-transform duration-300"></i>
                  <span class="font-semibold">รีเซ็ตฟอร์ม</span>
                </button>
              </div>
          </form>


          <div x-show="showUnspecifiedModeInfo" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
            @click.prevent="showUnspecifiedModeInfo = false">
            <div class="bg-white rounded-xl shadow-xl max-w-lg w-full transform transition-all duration-300"
              x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="transform scale-95 opacity-0"
              x-transition:enter-end="transform scale-100 opacity-100"
              x-transition:leave="transition ease-in duration-200"
              x-transition:leave-start="transform scale-100 opacity-100"
              x-transition:leave-end="transform scale-95 opacity-0">

              <!-- Header -->
              <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-t-xl">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <i class="fas fa-info-circle text-2xl mr-3"></i>
                    <h3 class="text-xl font-bold">โหมดจองแบบไม่ระบุชื่อรถ</h3>
                  </div>
                  <button @click="showUnspecifiedModeInfo = false"
                    class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
              </div>

              <!-- Content -->
              <div class="p-6">
                <div class="space-y-4">
                  <!-- คำอธิบายหลัก -->
                  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                    <p class="text-blue-800 font-medium">โหมดนี้เหมาะสำหรับร้านที่ต้องการรับจองล่วงหน้า
                      แต่ยังไม่ได้กำหนดรถคันเฉพาะ</p>
                  </div>

                  <!-- รายการประโยชน์ -->
                  <div class="space-y-3">
                    <div class="flex items-start space-x-3">
                      <div
                        class="flex-shrink-0 w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-green-600 text-xs"></i>
                      </div>
                      <div>
                        <h4 class="font-semibold text-gray-800">ใช้ในกรณีที่ต้องการหารถให้ลูกค้าในภายหลัง</h4>
                      </div>
                    </div>

                    <div class="flex items-start space-x-3">
                      <div
                        class="flex-shrink-0 w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-bell text-orange-600 text-xs"></i>
                      </div>
                      <div>
                        <h4 class="font-semibold text-gray-800">รายการจองนี้จะแจ้งเตือนในหน้าสรุปข้อมูล</h4>
                        <p class="text-sm text-gray-600">ระบบจะแสดงสถานะ "รอหารถ" เพื่อเตือนให้จัดหารถ</p>
                      </div>
                    </div>

                    <div class="flex items-start space-x-3">
                      <div
                        class="flex-shrink-0 w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-edit text-purple-600 text-xs"></i>
                      </div>
                      <div>
                        <h4 class="font-semibold text-gray-800">เมื่อหารถได้แล้ว สามารถแก้ไขรายการจองได้</h4>
                        <p class="text-sm text-gray-600">เพียงเข้าไปแก้ไขรายการจอง และเปลี่ยนชื่อรถ</p>
                      </div>
                    </div>
                  </div>

                  <!-- หมายเหตุเพิ่มเติม -->
                  <!-- <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="flex items-start space-x-2">
            <i class="fas fa-lightbulb text-yellow-600 mt-0.5"></i>
            <div>
              <h4 class="font-semibold text-yellow-800">เคล็ดลับ</h4>
              <p class="text-sm text-yellow-700 mt-1">สามารถสร้างสัญญาเช่าได้ปกติ โดยระบุประเภทรถที่ต้องการแทนชื่อรถเฉพาะ</p>
            </div>
          </div>
        </div> -->
                </div>
              </div>

              <!-- Footer -->
              <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-end">
                <button @click.prevent="showUnspecifiedModeInfo = false"
                  class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200">
                  <i class="fas fa-check mr-2"></i>เข้าใจแล้ว
                </button>
              </div>
            </div>
          </div>

          <div x-show="showBookingNumberInfo" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
            @click.prevent="showBookingNumberInfo = false">
            <div class="bg-white rounded-xl shadow-xl max-w-lg w-full transform transition-all duration-300"
              x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="transform scale-95 opacity-0"
              x-transition:enter-end="transform scale-100 opacity-100"
              x-transition:leave="transition ease-in duration-200"
              x-transition:leave-start="transform scale-100 opacity-100"
              x-transition:leave-end="transform scale-95 opacity-0">

              <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-6 rounded-t-xl">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <i class="fas fa-hashtag text-2xl mr-3"></i>
                    <h3 class="text-xl font-bold">เกี่ยวกับหมายเลขการจอง</h3>
                  </div>
                  <button @click="showBookingNumberInfo = false"
                    class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
              </div>



              <div class="flex items-start space-x-3 mt-4 p-6">
                <div class="flex-shrink-0 w-6 h-6 bg-red-100 rounded-full flex items-center justify-center mt-0.5">
                  <i class="fa-regular fa-circle-xmark text-red-600 text-xs"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800">ปิด สร้างอัตโนมัติ</h4>
                  <p class="text-sm text-gray-600">ระบุหมายเลขการจองหากเป็นช่องทางที่มีหมายเลขการจองตายตัว</p>
                </div>
              </div>

              <div class="flex items-start space-x-3 mt-4 p-6">
                <div class="flex-shrink-0 w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mt-0.5">
                  <i class="fas fa-check text-green-600 text-xs"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800">เปิด สร้างอัตโนมัติ</h4>
                  <p class="text-sm text-gray-600">เพื่อให้ระบบสร้างหมายเลขการจองให้อัตโนมัติ</p>
                </div>
              </div>



              <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-end">
                <button @click.prevent="showBookingNumberInfo = false"
                  class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200">
                  <i class="fas fa-check mr-2"></i>เข้าใจแล้ว
                </button>
              </div>
            </div>
          </div>

          <div class="mt-12 bg-white rounded-2xl shadow-lg p-6 lg:p-8 fade-in-up" style="animation-delay: 1.4s;"
            x-show="showSummarySection">
            <div class="flex items-center mb-6">
              <div class="w-12 h-12 gradient-bg-5 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-file-alt text-white text-xl"></i>
              </div>
              <div>
                <h2 class="text-2xl font-bold text-gray-800">ข้อมูลสรุปรายการเช่า</h2>
                <p class="text-gray-600">ตรวจสอบความถูกต้องก่อนส่งข้อมูล</p>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row flex-wrap gap-4 mb-6">
              <button x-show="successRentalData && successRentalData.ลิงก์สัญญาเช่า"
                @click="openContractPdf($event, successRentalData.ลิงก์สัญญาเช่า)"
                class="bg-green-600 text-white py-3 px-6 rounded-xl hover:bg-green-700 transition-all duration-300 flex items-center group justify-center">
                <i class="fas fa-file-pdf mr-2 group-hover:scale-110 transition-transform"></i>
                ดูไฟล์สัญญาเช่า
              </button>

              <button @click="copySummaryToClipboard($event)"
                class="bg-yellow-500 text-white py-3 px-6 rounded-xl hover:bg-yellow-600 transition-all duration-300 flex items-center group justify-center">
                <i class="fas fa-copy mr-2 group-hover:scale-110 transition-transform"></i>
                คัดลอกข้อความสรุป
              </button>

              <button @click="shareSummary($event)"
                class="bg-blue-600 text-white py-3 px-6 rounded-xl hover:bg-blue-700 transition-all duration-300 flex items-center group justify-center">
                <i class="fas fa-share-alt mr-2 group-hover:scale-110 transition-transform"></i>
                แชร์ข้อความสรุป
              </button>
            </div>

            <textarea id="rentalSummaryText" x-ref="rentalSummary" rows="8"
              placeholder="ข้อมูลสรุปรายการเช่าจะปรากฏที่นี่หลังจากบันทึกข้อมูล..."
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl font-mono text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 resize-none"></textarea>
          </div>
        </div>


      </div>
      <div class="fixed inset-0 z-50 overflow-y-auto" x-show="showNewBookingDetailsModal" x-cloak>
        <div class="flex items-center justify-center min-h-screen p-4 text-center sm:block sm:p-0">
          <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-black opacity-75"></div>
          </div>

          <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
            <div class="bg-blue-600 py-4 px-6 sm:px-8">
              <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                รายละเอียดการจอง
              </h3>

              <div class="bg-blue-100 rounded-md shadow px-4 py-2 mt-4 inline-block mx-auto">
                <p class="text-blue-700 text-lg font-bold">
                  หมายเลขการจอง: <span x-text="currentBookingDetailsForNewModal?.หมายเลขการจอง || '-'"></span>
                </p>
              </div>
            </div>

            <div class="px-6 py-6 sm:px-8">
              <div class="mb-4">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">ข้อมูลลูกค้า</h4>
                <div class="bg-gray-50 rounded-md p-3">
                  <p class="text-gray-700"><i class="fas fa-user mr-2 text-gray-400"></i> ชื่อ: <span
                      class="font-medium" x-text="currentBookingDetailsForNewModal?.ชื่อลูกค้า || '-'"></span></p>
                  <p class="text-gray-700"><i class="fas fa-phone mr-2 text-gray-400"></i> โทรศัพท์:
                    <a :href="'tel:' + currentBookingDetailsForNewModal?.เบอร์โทรศัพท์"
                      class="text-blue-600 hover:underline">
                      <span x-text="currentBookingDetailsForNewModal?.เบอร์โทรศัพท์ || '-'"></span>
                    </a>
                  </p>
                </div>
              </div>

              <div class="mb-4">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">รายละเอียดการเช่า</h4>
                <div class="bg-gray-50 rounded-md p-3">
                  <p class="text-gray-700"><i class="fas fa-car mr-2 text-gray-400"></i> รถ: <span class="font-medium"
                      x-text="currentBookingDetailsForNewModal?.รถ || '-'"></span></p>
                  <p class="text-gray-700"><i class="fas fa-calendar-alt mr-2 text-gray-400"></i> วันที่เช่า: <span
                      class="font-medium"
                      x-text="formatDate(currentBookingDetailsForNewModal?.วันที่เช่า) || '-'"></span> เวลา: <span
                      class="font-medium" x-text="currentBookingDetailsForNewModal?.เวลารับรถ || '-'"></span></p>
                  <p class="text-gray-700"><i class="fas fa-calendar-check mr-2 text-gray-400"></i> วันที่คืน: <span
                      class="font-medium"
                      x-text="formatDate(currentBookingDetailsForNewModal?.วันที่คืน) || '-'"></span> เวลา: <span
                      class="font-medium" x-text="currentBookingDetailsForNewModal?.เวลาคืนรถ || '-'"></span></p>
                  <p class="text-gray-700"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> สถานที่รับรถ:
                    <a x-show="currentBookingDetailsForNewModal?.สถานที่รับรถ"
                      :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(currentBookingDetailsForNewModal?.สถานที่รับรถ)"
                      target="_blank" class="text-blue-600 hover:underline">
                      <span x-text="currentBookingDetailsForNewModal?.สถานที่รับรถ || '-'"></span>
                    </a>
                    <span x-show="!currentBookingDetailsForNewModal?.สถานที่รับรถ">-</span>
                  </p>
                  <p class="text-gray-700"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> สถานที่คืนรถ:
                    <a x-show="currentBookingDetailsForNewModal?.สถานที่คืนรถ"
                      :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(currentBookingDetailsForNewModal?.สถานที่คืนรถ)"
                      target="_blank" class="text-blue-600 hover:underline">
                      <span x-text="currentBookingDetailsForNewModal?.สถานที่คืนรถ || '-'"></span>
                    </a>
                    <span x-show="!currentBookingDetailsForNewModal?.สถานที่คืนรถ">-</span>
                  </p>
                </div>
              </div>

              <div class="mb-4">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">ค่าใช้จ่าย</h4>
                <div class="bg-gray-50 rounded-md p-3">
                  <p class="text-gray-700"><i class="fas fa-coins mr-2 text-gray-400"></i> ค่าเช่ารวม: <span
                      class="font-medium"
                      x-text="formatCurrency(currentBookingDetailsForNewModal?.ค่าเช่ารวมทั้งหมด) || '-'"></span></p>
                  <p class="text-gray-700"><i class="fas fa-hand-holding-usd mr-2 text-gray-400"></i> ค่ามัดจำ: <span
                      class="font-medium"
                      x-text="formatCurrency(currentBookingDetailsForNewModal?.ค่ามัดจำคิวรถ) || '-'"></span></p>
                  <p class="text-gray-700"><i class="fas fa-shield-alt mr-2 text-gray-400"></i> เงินประกัน: <span
                      class="font-medium"
                      x-text="formatCurrency(currentBookingDetailsForNewModal?.เงินประกันความเสียหาย) || '-'"></span>
                  </p>
                  <p class="text-green-700 font-semibold"><i class="fas fa-check-circle mr-2 text-green-400"></i>
                    รวมชำระวันรับรถ: <span class="font-medium"
                      x-text="formatCurrency(currentBookingDetailsForNewModal?.รวมยอดชำระวันรับรถ) || '-'"></span></p>
                </div>
              </div>
            </div>

            <div class="bg-gray-100 py-3 px-6 sm:px-8 flex justify-end">
              <button @click="closeNewBookingDetailsModal()" type="button"
                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-times mr-2"></i> ปิด
              </button>
            </div>
          </div>
        </div>
      </div>

      <div x-show="showRentalSuccessModal" x-transition.opacity.duration.300ms
        class="fixed inset-0 z-50 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center" x-cloak>

        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl mx-auto transform transition-all p-6 sm:p-8">
          <div class="flex flex-col items-center">
            <lottie-player src="https://assets6.lottiefiles.com/packages/lf20_jbrw3hcz.json" background="transparent"
              speed="1" style="width: 100px; height: 100px;" loop autoplay
              class="animate-bounce-slow drop-shadow-xl mb-4">
            </lottie-player>

            <h3 class="text-2xl font-bold text-green-700 text-center">
              บันทึกรายการเช่าสำเร็จ!
            </h3>
          </div>
          <div class="mt-4 text-center">
            <p class="text-gray-700 text-sm">
              ระบบได้บันทึกรายการเช่าและตารางรับส่งรถเรียบร้อยแล้ว
            </p>
            <p class="text-gray-500 text-sm mt-1">
              สามารถคัดลอกข้อมูลสรุปไปใช้งาน หรือรีเซ็ตฟอร์มเพื่อสร้างรายการใหม่ได้
            </p>
          </div>
          <div class="mt-4 space-y-2">
            <div x-show="successRentalData && successRentalData.ลิงก์สัญญาเช่า"
              class="p-3 bg-blue-50 rounded-lg border border-blue-200">
              <div class="font-medium text-blue-700 mb-2">สัญญาเช่า</div>
              <a :href="successRentalData.ลิงก์สัญญาเช่า" target="_blank"
                class="flex items-center text-blue-600 hover:text-blue-800 hover:underline">
                <i class="fas fa-file-pdf mr-2"></i>
                <span>ดูสัญญาเช่า</span>
                <i class="fas fa-external-link-alt ml-1 text-xs"></i>
              </a>
            </div>

            <div x-show="successRentalData && successRentalData.ลิงก์ปฏิทิน"
              class="p-3 bg-green-50 rounded-lg border border-green-200">
              <div class="font-medium text-green-700 mb-2">ปฏิทินการเช่า</div>
              <a :href="successRentalData.ลิงก์ปฏิทิน" target="_blank"
                class="flex items-center text-green-600 hover:text-green-800 hover:underline">
                <i class="fas fa-calendar-alt mr-2"></i>
                <span>ดูรายการในปฏิทิน</span>
                <i class="fas fa-external-link-alt ml-1 text-xs"></i>
              </a>
            </div>

            <!-- ส่วนสรุปค่าใช้จ่าย -->
            <div x-show="successRentalData" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
              <div class="font-medium text-gray-700 mb-3 flex items-center">
                <i class="fas fa-calculator mr-2 text-blue-500"></i>
                สรุปค่าใช้จ่าย
              </div>
              <div class="space-y-2 text-sm">
                <!-- ค่าเช่าพื้นฐาน -->
                <div class="flex justify-between text-gray-600">
                  <span>ค่าเช่าพื้นฐาน:</span>
                  <span class="font-medium" x-text="formatCurrency(successRentalData.ค่าเช่ารวมทั้งหมด)"></span>
                </div>

                <!-- VAT (ถ้ามี) -->
                <div x-show="successRentalData.wantsTaxInvoice" class="flex justify-between text-gray-600">
                  <span>ภาษีมูลค่าเพิ่ม 7%:</span>
                  <span class="font-medium text-green-600"
                    x-text="'+ ' + formatCurrency(successRentalData.taxInvoiceVATAmount)"></span>
                </div>

                <!-- WHT (ถ้ามี) -->
                <div x-show="successRentalData.wantsWHT" class="flex justify-between text-gray-600">
                  <span x-text="'หัก ณ ที่จ่าย ' + (successRentalData.whtPercentage || 3) + '%:'"></span>
                  <span class="font-medium text-red-600"
                    x-text="'- ' + formatCurrency(successRentalData.whtAmount)"></span>
                </div>

                <!-- เส้นแบ่ง -->
                <div x-show="successRentalData.wantsTaxInvoice || successRentalData.wantsWHT"
                  class="border-t border-gray-300 pt-2"></div>

                <!-- Net Total -->
                <div class="flex justify-between text-gray-800 font-semibold">
                  <span>ค่าเช่ารวมทั้งหมด (รวมภาษี):</span>
                  <span
                    x-text="formatCurrency(successRentalData.netTotal || successRentalData.ค่าเช่ารวมทั้งหมด)"></span>
                </div>

                <!-- ค่ามัดจำและประกัน -->
                <div class="border-t border-gray-300 pt-2 mt-2 space-y-1 text-gray-600">
                  <div class="flex justify-between">
                    <span>ค่ามัดจำคิวรถ:</span>
                    <span x-text="formatCurrency(successRentalData.ค่ามัดจำคิวรถ)"></span>
                  </div>
                  <div class="flex justify-between">
                    <span>เงินประกันความเสียหาย:</span>
                    <span x-text="formatCurrency(successRentalData.เงินประกันความเสียหาย)"></span>
                  </div>
                </div>

                <!-- รวมยอดชำระวันรับรถ -->
                <div class="flex justify-between text-green-700 font-bold text-base bg-green-50 p-2 rounded">
                  <span>รวมยอดชำระวันรับรถ:</span>
                  <span x-text="formatCurrency(successRentalData.รวมยอดชำระวันรับรถ)"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-6 flex flex-col sm:flex-row justify-center gap-3 sm:gap-4">
            <button @click.prevent="closeSuccessModal()"
              class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-xl shadow transition">
              <i class="fas fa-check mr-2"></i> ดูข้อมูลสรุป
            </button>

            <button @click="resetFormAfterSuccess()"
              class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 bg-white hover:bg-gray-100 text-gray-700 border border-gray-300 text-sm font-medium rounded-xl shadow transition">
              <i class="fas fa-redo mr-2"></i> สร้างรายการใหม่
            </button>
          </div>
        </div>
      </div>

      <div x-show="isPdfGenerating" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50"
        style="display: none;">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center">
          <div class="flex justify-center items-center mb-6">
            <div class="w-16 h-16 gradient-bg-1 rounded-full flex items-center justify-center animate-spin">
              <i class="fas fa-cog text-white text-2xl"></i>
            </div>
          </div>
          <p class="text-xl font-bold text-gray-800 mb-2" x-text="pdfLoadingStep"></p>
          <p class="text-gray-600 mb-4">กรุณารอสักครู่ ระบบกำลังดำเนินการ...</p>
          <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div class="gradient-bg-1 h-full transition-all duration-500 ease-out"
              :style="`width: ${pdfLoadingProgress}%`"></div>
          </div>
        </div>
      </div>

      <div x-show="showBlankContractModal" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4"
        @click.self="showBlankContractModal = false" x-cloak>

        <div @click.stop
          class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto transform transition-all p-6 sm:p-8">

          <div x-show="!isGeneratingBlankContract && !blankContractSuccessState"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-file-contract text-yellow-500 mr-2"></i>
                สร้างสัญญาเช่าเปล่า
              </h3>
              <button @click="showBlankContractModal = false" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">เลือกประเภทสัญญา</label>
                <select x-model="blankContract.templateName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="Template_สัญญาเช่า_รถยนต์">สัญญาเช่ารถยนต์ (น้ำมัน)</option>
                  <option value="Template_สัญญาเช่า_รถยนต์ไฟฟ้า">สัญญาเช่ารถยนต์ (ไฟฟ้า)</option>
                  <option value="Template_สัญญาเช่า_รถจักรยานยนต์">สัญญาเช่ารถจักรยานยนต์ (น้ำมัน)</option>
                  <option value="Template_สัญญาเช่า_รถจักรยานยนต์ไฟฟ้า">สัญญาเช่ารถจักรยานยนต์ (ไฟฟ้า)</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">เลือกภาษา</label>
                <select x-model="blankContract.language"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="th">🇹🇭 ภาษาไทย</option>
                  <option value="en">🇬🇧 ภาษาอังกฤษ</option>
                  <option value="zh-CN">🇨🇳 ภาษาจีน (ย่อ)</option>
                  <option value="zh-TW">🇹🇼 ภาษาจีน (ตัวเต็ม)</option>
                  <option value="ko">🇰🇷 ภาษาเกาหลี</option>
                  <option value="lo">🇱🇦 ภาษาลาว</option>
                  <option value="my">🇲🇲 ภาษาพม่า</option>
                  <option value="vi">🇻🇳 ภาษาเวียดนาม</option>
                  <option value="ru">🇷🇺 ภาษารัสเซีย</option>
                  <option value="ms">🇲🇾 ภาษามาเลย์</option>
                  <option value="id">🇮🇩 ภาษาอินโดนีเซีย</option>
                  <option value="ja">🇯🇵 ภาษาญี่ปุ่น</option>
                  <option value="he">🇮🇱 ภาษาฮิบรู</option>
                  <option value="fr">🇫🇷 ภาษาฝรั่งเศส</option>
                  <option value="tr">🇹🇷 ภาษาตุรกี</option>
                  <option value="es">🇪🇸 ภาษาสเปน</option>
                  <option value="it">🇮🇹 ภาษาอิตาลี</option>
                  <option value="de">🇩🇪 ภาษาเยอรมัน</option>
                </select>
              </div>
              <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-md">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-yellow-500"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                      ระบบจะสร้างสัญญาเปล่าโดยเว้นข้อมูลลูกค้าและรถไว้ สำหรับนำไปกรอกข้อมูลเอง
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
              <button @click="showBlankContractModal = false"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">
                ยกเลิก
              </button>
              <button @click="generateBlankContract()"
                class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 flex items-center">
                <i class="fas fa-file-download mr-2"></i>สร้างสัญญา
              </button>
            </div>
          </div>

          <div x-show="isGeneratingBlankContract" x-transition class="text-center py-8">
            <lottie-player src="https://assets9.lottiefiles.com/packages/lf20_usmfx6bp.json" background="transparent"
              speed="1" style="width: 120px; height: 120px; margin: auto;" loop autoplay>
            </lottie-player>
            <p class="text-xl font-semibold text-gray-700 mt-4">กำลังสร้างสัญญาเปล่า...</p>
            <p class="text-sm text-gray-500">กรุณารอสักครู่</p>
          </div>

          <div x-show="!isGeneratingBlankContract && blankContractSuccessState"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0">
            <div class="text-center">
              <template x-if="blankContractSuccessState && blankContractSuccessState.success">
                <div>
                  <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check text-green-600 text-2xl"></i>
                  </div>
                  <h3 class="text-xl font-bold text-gray-800">สร้างไฟล์สำเร็จ!</h3>
                  <p class="text-gray-600 mt-2" x-text="blankContractSuccessState.message"></p>
                  <a :href="blankContractSuccessState.pdfUrl" target="_blank"
                    class="mt-6 inline-flex items-center justify-center w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    <i class="fas fa-file-pdf mr-2"></i> เปิดไฟล์ PDF ที่สร้างเสร็จ
                  </a>
                </div>
              </template>
              <template x-if="blankContractSuccessState && !blankContractSuccessState.success">
                <div>
                  <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-times text-red-600 text-2xl"></i>
                  </div>
                  <h3 class="text-xl font-bold text-gray-800">เกิดข้อผิดพลาด</h3>
                  <p class="text-red-600 mt-2" x-text="blankContractSuccessState.message"></p>
                </div>
              </template>

              <div class="mt-6 flex flex-col sm:flex-row gap-3">
                <button @click="resetBlankContractForm()"
                  class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md">
                  <i class="fas fa-plus mr-2"></i>สร้างใหม่อีกครั้ง
                </button>
                <button @click="showBlankContractModal = false"
                  class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md">
                  ปิดหน้าต่าง
                </button>
              </div>
            </div>
          </div>


        </div>
      </div>
    </div>
  </div>









  <!-- หน้าจัดการการจองออนไลน์ -->
  <div x-show="currentPage === 'onlinebooking'" x-cloak>

    <!-- Header Section -->
    <div class="mb-6">
      <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4 w-full" style="border-color: #4F46E5;">

        <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5 flex-shrink-0"
          style="background-color: #4F46E5;">
          <i class="fas fa-globe text-white text-2xl"></i>
        </div>

        <div class="grow">
          <h2 class="text-2xl font-bold text-gray-800">จัดการการจองออนไลน์</h2>
          <p class="mt-1 text-gray-600">
            <i class="fas fa-cogs mr-2" style="color: #4F46E5;"></i>จัดการรถที่เปิดให้จองออนไลน์และตั้งค่ากฎราคา
          </p>
        </div>

        <button @click="loadCompleteOnlineBookingData()" :disabled="isLoadingCompleteData"
          class="ml-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center flex-shrink-0">
          <i :class="isLoadingCompleteData ? 'fas fa-spinner animate-spin' : 'fas fa-sync-alt'" class="mr-2"></i>
          <span x-text="isLoadingCompleteData ? 'กำลังโหลด...' : 'รีเฟรชข้อมูล'"></span>
        </button>

      </div>
    </div>



    <!-- สถานะระบบจองออนไลน์ -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 mb-6">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-4">
              <i class="fas fa-globe text-white text-xl"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800">สถานะระบบจองออนไลน์</h3>
              <p class="text-sm text-gray-600">เปิด/ปิดการรับจองผ่านช่องทางออนไลน์</p>
            </div>
          </div>

          <!-- สวิตช์เปิด/ปิดระบบ -->
          <div class="flex items-center">
            <span class="mr-3 text-sm font-medium text-gray-700"
              x-text="onlineBookingSystemEnabled ? 'เปิดใช้งาน' : 'ปิดใช้งาน'"></span>
            <button @click="toggleOnlineBookingSystem()"
              :class="onlineBookingSystemEnabled ? 'bg-green-500' : 'bg-gray-300'"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50"
              disabled> <span :class="onlineBookingSystemEnabled ? 'translate-x-6' : 'translate-x-1'"
                class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform">
              </span>
            </button>
          </div>
        </div>

        <!-- แสดงข้อความสถานะ -->
        <div class="mt-4 p-4 rounded-lg"
          :class="onlineBookingSystemEnabled ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-red-200'">
          <div class="flex items-center">
            <i :class="onlineBookingSystemEnabled ? 'fas fa-check-circle text-green-500' : 'fas fa-times-circle text-red-500'"
              class="mr-2"></i>
            <span class="text-lg font-medium" :class="onlineBookingSystemEnabled ? 'text-green-700' : 'text-red-700'"
              x-text="onlineBookingSystemEnabled ? 'ระบบเปิดรับการจองออนไลน์' : 'อยู่ระหว่างการพัฒนา'">
            </span>
          </div>
          <p class="text-sm mt-1" :class="onlineBookingSystemEnabled ? 'text-green-600' : 'text-red-600'"
            x-text="onlineBookingSystemEnabled ? 'ลูกค้าสามารถจองรถผ่านช่องทางออนไลน์ได้' : 'กรุณาติดต่อแอดมินเพื่อขอข้อมูลเพิ่มเติม'">
          </p>
        </div>


        <!-- <div class="mt-4 p-4 rounded-lg" 
           :class="onlineBookingSystemEnabled ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'">
        <div class="flex items-center">
          <i :class="onlineBookingSystemEnabled ? 'fas fa-check-circle text-green-500' : 'fas fa-times-circle text-gray-500'" class="mr-2"></i>
          <span class="text-sm font-medium" 
                :class="onlineBookingSystemEnabled ? 'text-green-700' : 'text-gray-700'"
                x-text="onlineBookingSystemEnabled ? 'ระบบเปิดรับการจองออนไลน์' : 'ระบบปิดการจองออนไลน์'">
          </span>
        </div>
        <p class="text-xs mt-1" 
           :class="onlineBookingSystemEnabled ? 'text-green-600' : 'text-gray-600'"
           x-text="onlineBookingSystemEnabled ? 'ลูกค้าสามารถจองรถผ่านช่องทางออนไลน์ได้' : 'ลูกค้าไม่สามารถจองรถผ่านช่องทางออนไลน์ได้'">
        </p>
      </div> -->








      </div>
    </div>

    <!-- ส่วนที่ 1: รายชื่อรถที่เปิดให้จองออนไลน์ -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 mb-6">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-4">
              <i class="fas fa-car text-white text-xl"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800">รายชื่อรถที่เปิดให้จองออนไลน์</h3>
              <p class="text-sm text-gray-600">จัดการรถที่ต้องการเปิดให้ลูกค้าจองผ่านออนไลน์</p>
            </div>
          </div>

          <!-- ปุ่มรีเฟรชเฉพาะส่วนนี้ -->
          <button @click="loadAllVehiclesWithOnlineStatus()" :disabled="isLoadingVehiclesOnlineList"
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center">
            <i :class="isLoadingVehiclesOnlineList ? 'fas fa-spinner animate-spin' : 'fas fa-sync-alt'"
              class="mr-2"></i>
            <span x-text="isLoadingVehiclesOnlineList ? 'กำลังโหลด...' : 'รีเฟรช'"></span>
          </button>
        </div>

        <!-- ตารางรายชื่อรถทั้งหมด -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสรถ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อรถ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ทะเบียน
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะรถ
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  เปิดจองออนไลน์</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="vehicle in vehiclesOnlineBookingList" :key="vehicle.รหัสรถ">
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="vehicle.รหัสรถ">
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="vehicle.ชื่อรถเต็ม"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="vehicle.ทะเบียน"></td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      :class="vehicle.สถานะ === 'พร้อมให้เช่า' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                      class="px-2 py-1 text-xs font-semibold rounded-full" x-text="vehicle.สถานะ"></span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button @click="toggleVehicleOnlineBookingStatus(vehicle.รหัสรถ, vehicle.เปิดจองออนไลน์)"
                      :disabled="vehicleOnlineStatusUpdating === vehicle.รหัสรถ"
                      :class="vehicle.เปิดจองออนไลน์ ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 hover:bg-gray-400'"
                      class="px-3 py-1 text-xs text-white rounded-full transition-colors disabled:opacity-50 flex items-center mx-auto">
                      <i :class="vehicleOnlineStatusUpdating === vehicle.รหัสรถ ? 'fas fa-spinner animate-spin' : (vehicle.เปิดจองออนไลน์ ? 'fas fa-check' : 'fas fa-times')"
                        class="mr-1"></i>
                      <span x-text="vehicle.เปิดจองออนไลน์ ? 'เปิด' : 'ปิด'"></span>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>

          <!-- แสดงเมื่อไม่มีข้อมูล -->
          <div x-show="vehiclesOnlineBookingList.length === 0 && !isLoadingVehiclesOnlineList"
            class="text-center py-8 text-gray-500">
            <i class="fas fa-car text-4xl mb-4"></i>
            <p>ไม่พบข้อมูลรถ</p>
          </div>

          <!-- แสดงเมื่อกำลังโหลด -->
          <div x-show="isLoadingVehiclesOnlineList" class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner animate-spin text-4xl mb-4"></i>
            <p>กำลังโหลดข้อมูลรถ...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ส่วนที่ 3: รายการเช่าออนไลน์ -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 mb-6">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mr-4">
              <i class="fas fa-list-alt text-white text-xl"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800">รายการเช่าออนไลน์</h3>
              <p class="text-sm text-gray-600">รายการจองที่เข้ามาผ่านช่องทางออนไลน์</p>
            </div>
          </div>

          <!-- ปุ่มรีเฟรชรายการเช่า -->
          <button @click="loadOnlineRentalsData()" :disabled="isLoadingRentals"
            class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center">
            <i :class="isLoadingRentals ? 'fas fa-spinner animate-spin' : 'fas fa-sync-alt'" class="mr-2"></i>
            <span x-text="isLoadingRentals ? 'กำลังโหลด...' : 'รีเฟรช'"></span>
          </button>
        </div>

        <!-- ตารางรายการเช่าออนไลน์ -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  หมายเลขการจอง</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อลูกค้า
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รถที่จอง
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่เช่า
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่คืน
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ยอดเงิน
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="rental in onlineRentals" :key="rental.หมายเลขการจอง">
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600"
                    x-text="rental.หมายเลขการจอง"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="rental.ชื่อลูกค้า"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="rental.รถ"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="rental.วันที่เช่า"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="rental.วันที่คืน"></td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      :class="rental.สถานะ === 'เสร็จสิ้น' ? 'bg-green-100 text-green-800' : rental.สถานะ === 'จอง' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'"
                      class="px-2 py-1 text-xs font-semibold rounded-full" x-text="rental.สถานะ"></span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right"
                    x-text="rental.ยอดเงินรวม ? (parseInt(rental.ยอดเงินรวม).toLocaleString() + ' บาท') : '-'"></td>
                </tr>
              </template>
            </tbody>
          </table>

          <!-- แสดงเมื่อไม่มีข้อมูล -->
          <div x-show="onlineRentals.length === 0 && !isLoadingRentals" class="text-center py-8 text-gray-500">
            <i class="fas fa-inbox text-4xl mb-4"></i>
            <p>ไม่พบรายการเช่าออนไลน์</p>
          </div>

          <!-- แสดงเมื่อกำลังโหลด -->
          <div x-show="isLoadingRentals" class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner animate-spin text-4xl mb-4"></i>
            <p>กำลังโหลดรายการเช่าออนไลน์...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ส่วนที่ 4: ตั้งค่ากฎราคา (Price Rules) -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 mb-6">
      <div class="p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center mr-4">
              <i class="fas fa-cogs text-white text-xl"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-gray-800">ตั้งค่ากฎราคา (Price Rules)</h1>
              <p class="text-sm text-gray-600">เลือกช่วงวันที่ในปฏิทินเพื่อกำหนดราคาพิเศษ (เฉพาะรถที่เปิดจองออนไลน์)
              </p>
            </div>
          </div>

          <!-- เลือกปี -->
          <div class="flex items-center gap-4">
            <button @click="loadActiveVehiclesForPricing()" :disabled="isLoadingPricingVehicles"
              class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center">
              <i :class="isLoadingPricingVehicles ? 'fas fa-spinner animate-spin' : 'fas fa-sync-alt'" class="mr-2"></i>
              <span x-text="isLoadingPricingVehicles ? 'กำลังโหลด...' : 'รีเฟรช'"></span>
            </button>

            <select x-model.number="currentYear" @change="fetchHolidays()"
              class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
              <template x-for="year in availableYears" :key="year">
                <option :value="year" x-text="year + 543"></option>
              </template>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- ปฏิทินและการควบคุม -->
          <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">

            <!-- สวิตช์เลือกโหมด: รายคัน หรือ กลุ่มรถ -->
            <div class="flex items-center justify-between mb-4 bg-gray-50 p-3 rounded-lg">
              <div class="flex bg-gray-200 rounded-lg p-1">
                <button @click="switchPricingMode('single')"
                  :class="pricingMode === 'single' ? 'bg-white shadow' : 'text-gray-600'"
                  class="px-3 py-1 text-sm rounded-md transition-colors">
                  รายคัน
                  <span x-text="`(${getVehicleFilterStats().individual})`" class="text-xs ml-1"></span>
                </button>
                <button @click="switchPricingMode('group')"
                  :class="pricingMode === 'group' ? 'bg-white shadow' : 'text-gray-600'"
                  class="px-3 py-1 text-sm rounded-md transition-colors">
                  กลุ่มรถ
                  <span x-text="`(${vehicleGroupsForPricing.length})`" class="text-xs ml-1"></span>
                </button>
              </div>

              <!-- ปุ่มจัดการกลุ่มรถ และสถิติ -->
              <div class="flex items-center justify-between">
                <div class="text-xs text-gray-600 mr-4">
                  <span>รถทั้งหมด: </span>
                  <span x-text="getVehicleFilterStats().total" class="font-medium"></span>
                  <span> | ในกลุ่ม: </span>
                  <span x-text="getVehicleFilterStats().inGroups" class="font-medium text-blue-600"></span>
                  <span> | รายคัน: </span>
                  <span x-text="getVehicleFilterStats().individual" class="font-medium text-green-600"></span>
                </div>

                <button @click="openVehicleGroupManagementModal()"
                  class="px-3 py-1 bg-indigo-500 hover:bg-indigo-600 text-white text-sm rounded-md transition-colors flex items-center">
                  <i class="fas fa-plus mr-1"></i>
                  จัดการกลุ่มรถ
                </button>
              </div>
            </div>

            <!-- เลือกรถ (รายคัน) - แสดงเฉพาะรถที่ยังไม่อยู่ในกลุ่ม -->
            <div x-show="pricingMode === 'single'" class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">เลือกรถ
                (เฉพาะรถที่ยังไม่อยู่ในกลุ่ม):</label>
              <select x-model="selectedCarId"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <option value="">-- เลือกรถ --</option>
                <template x-for="vehicle in availableIndividualVehicles" :key="vehicle.รหัสรถ">
                  <option :value="vehicle.รหัสรถ"
                    x-text="`${vehicle.รหัสรถ} - ${vehicle.ชื่อรถเต็ม} ${vehicle.ทะเบียน}`"></option>
                </template>
              </select>

              <!-- แสดงข้อความเมื่อไม่มีรถให้เลือก -->
              <div x-show="availableIndividualVehicles.length === 0"
                class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                  <span class="text-sm text-yellow-700">ไม่มีรถที่ยังไม่อยู่ในกลุ่มให้เลือก</span>
                </div>
                <p class="text-xs text-yellow-600 mt-1">รถทั้งหมดถูกจัดเข้ากลุ่มแล้ว หรือยังไม่มีรถที่เปิดจองออนไลน์
                </p>
              </div>
            </div>

            <!-- เลือกกลุ่มรถ -->
            <div x-show="pricingMode === 'group'" class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">เลือกกลุ่มรถ:</label>
              <select x-model="selectedGroupId"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <option value="">-- เลือกกลุ่มรถ --</option>
                <template x-for="group in vehicleGroupsForPricing" :key="group.id">
                  <option :value="group.id" x-text="`${group.name} (${group.vehicleCodes.length} คัน)`"></option>
                </template>
              </select>

              <!-- แสดงข้อความเมื่อไม่มีกลุ่มรถ -->
              <div x-show="vehicleGroupsForPricing.length === 0"
                class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                  <span class="text-sm text-yellow-700">ยังไม่มีกลุ่มรถให้เลือก</span>
                </div>
                <p class="text-xs text-yellow-600 mt-1">กดปุ่ม "จัดการกลุ่มรถ" เพื่อสร้างกลุ่มรถใหม่</p>
              </div>
            </div>

            <!-- แสดงข้อมูลรถที่เลือก -->
            <div x-show="(pricingMode === 'single' && selectedCarId) || (pricingMode === 'group' && selectedGroupId)"
              class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">

              <!-- สำหรับรายคัน -->
              <template x-if="pricingMode === 'single' && selectedCarId">
                <div>
                  <h4 class="font-medium text-blue-800">รถที่เลือก:</h4>
                  <template x-for="vehicle in availableIndividualVehicles" :key="vehicle.รหัสรถ">
                    <div x-show="vehicle.รหัสรถ === selectedCarId">
                      <div class="text-sm text-blue-700">
                        <div x-text="`${vehicle.รหัสรถ} - ${vehicle.ชื่อรถเต็ม} ${vehicle.ทะเบียน}`"></div>
                        <div x-text="`ราคาปกติ: ${vehicle.ราคาเริ่มต้น} บาท/วัน`"></div>
                      </div>


                      <p class="text-xs text-blue-600">🟢 รถนี้ไม่อยู่ในกลุ่มใด</p>
                    </div>
                  </template>
                </div>
              </template>

              <!-- สำหรับกลุ่มรถ -->
              <template x-if="pricingMode === 'group' && selectedGroupId">
                <div>
                  <h4 class="font-medium text-blue-800">กลุ่มรถที่เลือก:</h4>
                  <template x-for="group in vehicleGroupsForPricing" :key="group.id">
                    <div x-show="group.id === selectedGroupId">
                      <p class="text-sm text-blue-700" x-text="`${group.name} - ${group.description}`"></p>
                      <p class="text-xs text-blue-600" x-text="`จำนวนรถ: ${group.vehicleCodes.length} คัน`"></p>

                      <!-- แสดงรายชื่อรถในกลุ่ม -->
                      <div class="mt-2 flex flex-wrap gap-1">
                        <template x-for="vehicleCode in group.vehicleCodes" :key="vehicleCode">
                          <span class="inline-block px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded border">
                            <span x-text="getVehicleDisplayName(vehicleCode)"></span>
                          </span>
                        </template>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
            </div>



            <!-- ปฏิทิน -->
            <div class="calendar-container"
              x-show="(pricingMode === 'single' && selectedCarId) || (pricingMode === 'group' && selectedGroupId)">

              <!-- หัวข้อปฏิทิน -->
              <div
                class="bg-gradient-to-br from-green-50 to-blue-50 border border-green-200 rounded-xl p-4 mb-6 backdrop-blur-sm">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-gray-800">เลือกช่วงวันที่เพื่อตั้งราคาพิเศษ</h4>
                  <div class="flex items-center gap-2">
                    <button @click="onlineBookingMonth = (onlineBookingMonth - 1 + 12) % 12"
                      class="p-2 text-gray-600 hover:text-gray-800 rounded-lg hover:bg-white/50 transition-all duration-200">
                      <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="text-sm font-medium text-gray-700 min-w-[120px] text-center"
                      x-text="new Date(onlineBookingYear, onlineBookingMonth).toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })"></span>
                    <button @click="onlineBookingMonth = (onlineBookingMonth + 1) % 12"
                      class="p-2 text-gray-600 hover:text-gray-800 rounded-lg hover:bg-white/50 transition-all duration-200">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </div>
                </div>

                <!-- Toggle Switch แบบ Glassmorphism -->
                <div
                  class="flex items-center justify-between bg-white/60 backdrop-blur-md rounded-xl p-4 shadow-xl border border-white/20">
                  <div class="flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-r from-red-400 to-pink-500 rounded-lg shadow-lg">
                      <i class="fas fa-calendar-star text-white text-sm"></i>
                    </div>
                    <div>
                      <span class="text-sm font-semibold text-gray-800">แสดงชื่อวันหยุด</span>
                      <p class="text-xs text-gray-500">เพื่อแสดงรายละเอียดวันสำคัญ</p>
                    </div>
                  </div>
                  <div class="relative">
                    <button @click="showHolidayNames = !showHolidayNames"
                      :class="showHolidayNames ? 'bg-gradient-to-r from-emerald-400 via-teal-500 to-cyan-500' : 'bg-gradient-to-r from-gray-300 to-gray-400'"
                      class="relative inline-flex h-9 w-16 items-center rounded-2xl transition-all duration-500 ease-in-out shadow-xl hover:shadow-2xl transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-emerald-300/50">

                      <!-- Background glow effect -->
                      <div :class="showHolidayNames ? 'opacity-100' : 'opacity-0'"
                        class="absolute inset-0 rounded-2xl bg-gradient-to-r from-emerald-400 to-cyan-500 blur-sm transition-opacity duration-500">
                      </div>

                      <!-- Switch circle -->
                      <span
                        :class="showHolidayNames ? 'translate-x-8 bg-white shadow-emerald-200' : 'translate-x-1 bg-white shadow-gray-300'"
                        class="relative inline-block h-7 w-7 transform rounded-full transition-all duration-500 ease-in-out shadow-lg">
                        <div class="flex items-center justify-center w-full h-full">
                          <i :class="showHolidayNames ? 'fas fa-sparkles text-emerald-500' : 'fas fa-moon text-gray-400'"
                            class="text-xs transition-all duration-300"></i>
                        </div>
                      </span>

                      <!-- Status text -->
                      <span :class="showHolidayNames ? 'left-2 opacity-100' : 'left-2 opacity-0'"
                        class="absolute text-[8px] font-bold text-white transition-all duration-300">
                        ON
                      </span>
                      <span :class="!showHolidayNames ? 'right-2 opacity-100' : 'right-2 opacity-0'"
                        class="absolute text-[8px] font-bold text-gray-600 transition-all duration-300">
                        OFF
                      </span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- วันในสัปดาห์ -->
              <div class="grid grid-cols-7 gap-1 mb-2">
                <template x-for="day in weekDays" :key="day">
                  <div class="p-2 text-center text-xs font-medium text-gray-500" x-text="day"></div>
                </template>
              </div>

              <!-- ปฏิทิน -->
              <div class="grid grid-cols-7 gap-1 mb-4">
                <template x-for="day in calendarDays" :key="day.id">
                  <div :class="getDayClasses(day)" @click="handleDateClick(day.date)"
                    :title="day.isHoliday && day.isCurrentMonth ? getHolidayName(day.date) : ''">

                    <!-- วันที่ -->
                    <div class="text-sm font-medium" x-text="day.date.getDate()"></div>

                    <!-- ราคาที่ตั้งไว้ -->
                    <div x-show="day.price" class="text-xs font-semibold mt-1"
                      :class="day.isHoliday ? 'text-red-700' : 'text-green-600'" x-text="day.price + ' บ.'"></div>

                    <!-- ไอคอนและชื่อวันหยุด -->
                    <div x-show="day.isHoliday && day.isCurrentMonth && showHolidayNames"
                      class="text-xs text-red-700 font-medium mt-1 leading-tight">
                      <div class="flex items-center justify-center">
                        <span class="text-base">🎌</span>
                      </div>
                      <div class="truncate" x-text="getHolidayName(day.date)" :title="getHolidayName(day.date)"></div>
                    </div>

                    <!-- แสดงเฉพาะไอคอนถ้าไม่แสดงชื่อ -->
                    <div x-show="day.isHoliday && day.isCurrentMonth && !showHolidayNames" class="text-base mt-1">
                      🎌
                    </div>
                  </div>
                </template>
              </div>

              <!-- ตัวเลือกการจัดการวันหยุด -->
              <!-- <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
              <h5 class="font-semibold text-red-800 mb-3 flex items-center">
                <i class="fas fa-calendar-day mr-2"></i>
                การจัดการวันหยุดนักขัตฤกษ์
              </h5>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div class="flex items-center justify-between">
                  <span class="text-sm text-red-700">แสดงชื่อวันหยุด</span>
                  <button @click="showHolidayNames = !showHolidayNames"
                          :class="showHolidayNames ? 'bg-red-500' : 'bg-gray-300'"
                          class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                    <span :class="showHolidayNames ? 'translate-x-6' : 'translate-x-1'"
                          class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                  </button>
                </div>

              
                <div class="flex items-center justify-between">
                  <span class="text-sm text-red-700">ตั้งราคาวันหยุดอัตโนมัติ</span>
                  <button @click="setHolidayPricingMode(!autoHolidayPricing)"
                          :class="autoHolidayPricing ? 'bg-red-500' : 'bg-gray-300'"
                          class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                    <span :class="autoHolidayPricing ? 'translate-x-6' : 'translate-x-1'"
                          class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                  </button>
                </div>
              </div>

              
              <div x-show="autoHolidayPricing" x-transition class="mt-4">
                <label class="block text-sm font-medium text-red-700 mb-2">
                  ตัวคูณราคาวันหยุด (เช่น 1.5 = เพิ่ม 50%)
                </label>
                <input type="number" x-model.number="holidayPriceMultiplier" 
                       min="1" max="3" step="0.1"
                       class="w-full max-w-xs px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500"
                       placeholder="1.5">
                <p class="text-xs text-red-600 mt-1">
                  ราคาวันหยุด = ราคาปกติ × <span x-text="holidayPriceMultiplier"></span>
                </p>
              </div>
            </div> -->

              <!-- คำอธิบายสีในปฏิทิน -->
              <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <h6 class="font-medium text-gray-700 mb-3">คำอธิบายสี</h6>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                  <div class="flex items-center">
                    <div class="w-4 h-4 bg-indigo-600 rounded mr-2"></div>
                    <span class="text-gray-600">วันที่เลือก</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></div>
                    <span class="text-gray-600">วันหยุดนักขัตฤกษ์</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"></div>
                    <span class="text-gray-600">มีราคาตั้งไว้</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 border border-gray-300 rounded mr-2"></div>
                    <span class="text-gray-600">วันปกติ</span>
                  </div>
                </div>
              </div>

              <!-- ฟอร์มกรอกราคา -->
              <div x-show="isFormEnabled" class="bg-gray-50 p-4 rounded-lg">
                <h5 class="font-semibold text-gray-800 mb-3">ตั้งกฎราคา</h5>

                <!-- แสดงช่วงวันที่ที่เลือก -->
                <div x-show="onlineBookingDateRange.start"
                  class="mb-3 p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700">
                  <span
                    x-text="onlineBookingDateRange.start ? formatDate(formatDateISO(onlineBookingDateRange.start)) : ''"></span>
                  <template
                    x-if="onlineBookingDateRange.end && onlineBookingDateRange.end !== onlineBookingDateRange.start">
                    <span x-text="' ถึง ' + formatDate(formatDateISO(onlineBookingDateRange.end))"></span>
                  </template>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ราคาต่อวัน (บาท)</label>
                    <input type="number" x-model="ruleForm.price"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      placeholder="0">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">คำอธิบาย</label>
                    <input type="text" x-model="ruleForm.description"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      placeholder="เช่น วันหยุดยาว, ไฮซีซัน">
                  </div>
                </div>

                <div class="flex justify-end gap-2 mt-4">
                  <button @click="clearDateSelection()"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">ล้าง</button>

                  <!-- ปุ่มตั้งราคาวันหยุดอัตโนมัติ -->
                  <template x-if="autoHolidayPricing && onlineBookingDateRange.start">
                    <button @click="applyHolidayPricingToSelection()"
                      class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center">
                      <i class="fas fa-magic mr-2"></i>
                      ตั้งราคาวันหยุดอัตโนมัติ
                    </button>
                  </template>

                  <button @click="saveNewPricingRules()" :disabled="!ruleForm.price"
                    class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors disabled:opacity-50">
                    บันทึกกฎราคา
                  </button>
                </div>
              </div>
            </div>

            <!-- ข้อความเมื่อยังไม่เลือกรถ/กลุ่ม -->
            <div x-show="!((pricingMode === 'single' && selectedCarId) || (pricingMode === 'group' && selectedGroupId))"
              class="text-center text-gray-500 py-8">
              <i class="fas fa-calendar-alt text-4xl mb-2"></i>
              <p>เลือกรถหรือกลุ่มรถก่อนเพื่อตั้งกฎราคา</p>
            </div>
          </div>

          <!-- แสดงกฎราคาที่มี -->
          <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-list mr-2"></i>
                กฎราคาที่ตั้งไว้
              </h3>

              <!-- แสดงรายการกฎราคา -->
              <div class="space-y-2 max-h-96 overflow-y-auto">
                <template x-for="rule in priceRulesConfiguration" :key="rule.ruleId">
                  <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <p class="font-medium text-sm text-gray-800" x-text="rule.description || 'ไม่มีคำอธิบาย'"></p>
                        <p class="text-xs text-gray-600" x-text="`${rule.startDate} ถึง ${rule.endDate}`"></p>
                        <p class="text-xs text-blue-600" x-text="`ราคา: ${rule.pricePerDay} บาท/วัน`"></p>
                        <p class="text-xs text-gray-500"
                          x-text="rule.vehicleCode ? `รถ: ${rule.vehicleCode}` : `กลุ่ม: ${rule.groupId}`"></p>
                      </div>
                      <button @click="deletePricingRule(rule.ruleId)" class="text-red-500 hover:text-red-700 text-xs">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </template>

                <!-- เมื่อไม่มีกฎราคา -->
                <div x-show="priceRulesConfiguration.length === 0" class="text-center text-gray-500 py-4">
                  <i class="fas fa-inbox text-2xl mb-2"></i>
                  <p class="text-sm">ยังไม่มีกฎราคาที่ตั้งไว้</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- ส่วนที่ 5: จัดการวันปิดให้เช่า -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 mb-6">
      <div class="p-6">
        <!-- หัวข้อหลักและปุ่มรีเฟรช -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-600 rounded-lg flex items-center justify-center mr-4">
              <i class="fas fa-calendar-times text-white text-xl"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-gray-800">จัดการวันปิดให้เช่า</h1>
              <p class="text-sm text-gray-600">กำหนดวันที่ไม่ต้องการให้เช่ารถแต่ละคัน</p>
            </div>
          </div>

          <!-- ปุ่มรีเฟรช -->
          <button @click="loadVehicleBlockingData()" :disabled="isLoadingVehicleBlocking"
            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center shadow-md hover:shadow-lg">
            <i :class="isLoadingVehicleBlocking ? 'fas fa-spinner animate-spin' : 'fas fa-sync-alt'" class="mr-2"></i>
            <span x-text="isLoadingVehicleBlocking ? 'กำลังโหลด...' : 'รีเฟรช'"></span>
          </button>
        </div>

        <!-- เลือกรถ -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-3 flex items-center">
            <i class="fas fa-car mr-2 text-red-500"></i>
            เลือกรถที่ต้องการจัดการ
          </label>
          <select x-model="selectedVehicleForBlocking" @change="updateVehicleBlockingFormStatus()"
            class="w-full max-w-md px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all">
            <option value="">-- เลือกรถ --</option>
            <template x-for="vehicle in availableVehiclesForBlocking">
              <option :value="vehicle.รหัสรถ" x-text="`${vehicle.ชื่อรถเต็ม} (${vehicle.ทะเบียน})`"></option>
            </template>
          </select>
        </div>

        <!-- ปฏิทินและฟอร์ม -->
        <div class="grid lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">

            <!-- หัวปฏิทินใหม่ - สวยกว่าเดิม (แก้ไขแล้ว) -->
            <!-- หัวปฏิทินใหม่ - แก้ไขแล้ว ✅ -->
            <div class="calendar-header-gradient rounded-t-xl p-6 text-white shadow-lg">
              <div class="flex items-center justify-between">
                <!-- ปุ่มเดือนก่อน -->
                <button @click="previousVehicleBlockingMonth()"
                  class="calendar-nav-button p-3 hover:bg-white hover:bg-opacity-20 rounded-lg transition-all duration-200 group">
                  <i class="fas fa-chevron-left text-xl group-hover:scale-110 transition-transform"></i>
                </button>

                <!-- ตัวเลือกเดือนและปี -->
                <!-- ตัวเลือกเดือนและปี - โค้ดแบบเต็ม -->
                <div class="flex items-center space-x-4">
                  <!-- เลือกเดือน -->
                  <div class="relative">
                    <select x-model.number="vehicleBlockingMonth"
                      x-init="$nextTick(() => { $el.value = vehicleBlockingMonth; })"
                      @change="console.log('Month changed to:', vehicleBlockingMonth)"
                      class="calendar-select appearance-none bg-white bg-opacity-20 text-white placeholder-white border border-white border-opacity-30 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:bg-opacity-30 backdrop-blur-sm transition-all">
                      <template x-for="(month, index) in thaiMonthsForBlocking" :key="index">
                        <option :value="index" x-text="month" :selected="index === vehicleBlockingMonth"
                          class="text-gray-800"></option>
                      </template>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                      <i class="fas fa-chevron-down text-white text-sm"></i>
                    </div>
                  </div>

                  <!-- เลือกปี -->
                  <div class="relative">
                    <select x-model.number="vehicleBlockingYear"
                      x-init="$nextTick(() => { $el.value = vehicleBlockingYear; })"
                      @change="console.log('Year changed to:', vehicleBlockingYear)"
                      class="calendar-select appearance-none bg-white bg-opacity-20 text-white placeholder-white border border-white border-opacity-30 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:bg-opacity-30 backdrop-blur-sm transition-all">
                      <template x-for="year in availableYearsForBlocking" :key="year">
                        <option :value="year" x-text="formatYearDisplay(year)" :selected="year === vehicleBlockingYear"
                          class="text-gray-800"></option>
                      </template>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                      <i class="fas fa-chevron-down text-white text-sm"></i>
                    </div>
                  </div>
                </div>

                <!-- ปุ่มเดือนถัดไป -->
                <button @click="nextVehicleBlockingMonth()"
                  class="calendar-nav-button p-3 hover:bg-white hover:bg-opacity-20 rounded-lg transition-all duration-200 group">
                  <i class="fas fa-chevron-right text-xl group-hover:scale-110 transition-transform"></i>
                </button>
              </div>

              <!-- แสดงชื่อเดือนปีใหญ่ -->
              <div class="text-center mt-4">
                <!-- ✅ ใช้ expression โดยตรง แทนการเรียกฟังก์ชัน -->
                <h2 x-text="thaiMonthsForBlocking[vehicleBlockingMonth] + ' ' + (vehicleBlockingYear + 543)"></h2>
                <p class="text-white text-opacity-80 text-sm mt-1">
                  <i class="fas fa-hand-pointer mr-1"></i>
                  คลิกวันที่เพื่อปิดการให้เช่า
                </p>

                <!-- ✅ เพิ่มปุ่มกลับไปวันนี้ (Optional) -->
                <div class="mt-3">
                  <button @click="goToCurrentMonth()"
                    class="inline-flex items-center px-3 py-1 text-xs bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all">
                    <i class="fas fa-home mr-1"></i>
                    วันนี้
                  </button>
                </div>
              </div>
            </div>

            <!-- 🐛 Debug Info (ลบออกได้เมื่อทำงานแล้ว) -->
            <div class="p-2 bg-gray-100 text-xs text-gray-600" x-data="{showDebug: false}">
              <button @click="showDebug = !showDebug" class="underline">Debug Info</button>
              <div x-show="showDebug" class="mt-2">
                <div>vehicleBlockingMonth: <span x-text="vehicleBlockingMonth"></span></div>
                <div>vehicleBlockingYear: <span x-text="vehicleBlockingYear"></span></div>
                <div>Current Display: <span
                    x-text="thaiMonthsForBlocking[vehicleBlockingMonth] + ' ' + (vehicleBlockingYear + 543)"></span>
                </div>
              </div>
            </div>

            <!-- คำอธิบายสี -->
            <div class="color-legend bg-gray-50 border-x border-gray-200 p-4">
              <h6 class="font-medium text-gray-700 mb-3 flex items-center">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                คำอธิบายสี
              </h6>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                <div class="color-legend-item">
                  <div class="color-dot bg-red-600"></div>
                  <span class="text-gray-600">วันที่เลือกจะปิด</span>
                </div>
                <div class="color-legend-item">
                  <div class="color-dot bg-orange-100 border border-orange-300"></div>
                  <span class="text-gray-600">ปิดซ่อมบำรุง</span>
                </div>
                <div class="color-legend-item">
                  <div class="color-dot bg-purple-100 border border-purple-300"></div>
                  <span class="text-gray-600">ปิดใช้ส่วนตัว</span>
                </div>
                <div class="color-legend-item">
                  <div class="color-dot bg-grey-800 border border-grey-800"></div>
                  <span class="text-gray-600">อื่นๆ</span>
                </div>
              </div>
            </div>

            <!-- ตารางปฏิทิน -->
            <div class="main-calendar bg-white border border-gray-200 rounded-b-xl overflow-hidden">
              <!-- หัวตาราง (วันในสัปดาห์) -->
              <div class="calendar-day-header grid grid-cols-7 bg-gray-50 border-b border-gray-200">
                <template x-for="day in dayNamesForBlocking">
                  <div
                    class="p-4 text-center text-sm font-semibold text-gray-700 border-r border-gray-200 last:border-r-0"
                    x-text="day"></div>
                </template>
              </div>

              <!-- วันที่ในปฏิทิน -->
              <div class="grid grid-cols-7" :key="`calendar-${vehicleBlockingYear}-${vehicleBlockingMonth}`">
                <template x-for="day in vehicleBlockingCalendarDays" :key="day.id">
                  <div class="calendar-day-cell border-r border-b border-gray-200 last:border-r-0 h-28 relative" :class="[
           getVehicleBlockingDayClasses(day),
           !day.isCurrentMonth ? 'other-month' : '',
           isDateSelected(day.date) ? 'selected' : '',
           isDateInRange(day.date) ? 'in-range' : ''
         ]" @click="selectVehicleBlockingDate(day.date)">

                    <!-- วันที่ -->
                    <div class="p-3">
                      <span class="text-sm font-medium" x-text="day.date.getDate()"></span>
                    </div>

                    <!-- แสดงสถานะการปิด -->
                    <div x-show="day.isCurrentMonth && selectedVehicleForBlocking"
                      class="absolute bottom-2 left-2 right-2 space-y-1">
                      <template x-for="block in getVehicleBlockingStatusForDay(day.date)">
                        <div class="blocking-status-bar h-1 rounded-full"
                          :class="getBlockingReasonStatusClass(block.reasonCode)"
                          :title="getBlockingReasonName(block.reasonCode) + ': ' + (block.reasonDescription || 'ไม่มีหมายเหตุ')">
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

            </div>
          </div>

          <!-- ฟอร์มและรายการ -->
          <div class="space-y-6">
            <!-- ฟอร์มบันทึกการปิด -->
            <div x-show="isVehicleBlockingFormEnabled"
              class="vehicle-blocking-form bg-gradient-to-br from-red-50 to-pink-50 p-6 rounded-xl border border-red-200 shadow-sm">
              <h5 class="font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-ban mr-2 text-red-500"></i>
                ตั้งการปิดรถ
              </h5>

              <!-- แสดงช่วงวันที่ที่เลือก -->
              <div x-show="vehicleBlockingDateRange.start"
                class="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg text-sm text-red-800">
                <div class="flex items-center mb-2">
                  <i class="fas fa-calendar-alt mr-2 text-red-600"></i>
                  <span class="font-semibold">ช่วงวันที่ปิด:</span>
                </div>
                <div class="font-medium">
                  <span x-text="vehicleBlockingDateRange.start ? 
                formatDateForDisplay(vehicleBlockingDateRange.start) : ''"></span>
                  <span x-show="vehicleBlockingDateRange.end" x-text="' ถึง ' + (vehicleBlockingDateRange.end ? 
                    formatDateForDisplay(vehicleBlockingDateRange.end) : '')"></span>
                </div>
              </div>

              <!-- เหตุผลการปิด -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                  เหตุผลการปิด
                </label>
                <select x-model="vehicleBlockingForm.reasonCode"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all">
                  <option value="">-- เลือกเหตุผล --</option>
                  <template x-for="reason in blockingReasonsData">
                    <option :value="reason.reasonCode" x-text="reason.reasonName"></option>
                  </template>
                </select>
              </div>

              <!-- หมายเหตุ -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-edit mr-2 text-green-500"></i>
                  หมายเหตุเพิ่มเติม (ไม่บังคับ)
                </label>
                <textarea x-model="vehicleBlockingForm.description" rows="3"
                  placeholder="เช่น เปลี่ยนถ่ายน้ำมันเครื่อง, ซ่อมเครื่องปรับอากาศ"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all resize-none"></textarea>
              </div>

              <!-- ปุ่มบันทึก -->
              <div class="flex gap-3">
                <button @click="saveVehicleBlockingRules()" :disabled="!isVehicleBlockingFormValid"
                  class="btn-blocking-primary flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-md hover:shadow-lg">
                  <i class="fas fa-save mr-2"></i>
                  บันทึกการปิด
                </button>

                <button @click="clearVehicleBlockingSelection()"
                  class="btn-blocking-secondary px-4 py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-all font-medium">
                  <i class="fas fa-times mr-2"></i>
                  ยกเลิก
                </button>
              </div>
            </div>

            <!-- ข้อความเมื่อไม่ได้เลือกรถ -->
            <div x-show="!selectedVehicleForBlocking"
              class="text-center text-gray-500 py-12 bg-gray-50 rounded-xl border border-gray-200">
              <div class="mb-4">
                <i class="fas fa-car text-6xl text-gray-300"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-700 mb-2">เลือกรถก่อนเพื่อจัดการวันปิด</h3>
              <p class="text-sm text-gray-500">กรุณาเลือกรถจากรายการด้านบนเพื่อเริ่มต้นการตั้งค่าวันปิด</p>
            </div>

            <!-- รายการวันปิดของรถที่เลือก -->
            <div x-show="selectedVehicleForBlocking" class="bg-gray-50 p-6 rounded-xl border border-gray-200">
              <h5 class="font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-list mr-2 text-gray-600"></i>
                วันปิดของรถที่เลือก
                <span x-show="selectedVehicleBlockingRules.length > 0" class="badge-blocking-count ml-3"
                  x-text="selectedVehicleBlockingRules.length"></span>
              </h5>

              <!-- รายการ -->
              <div class="vehicle-blocking-list space-y-3 max-h-96 overflow-y-auto">
                <template x-for="rule in selectedVehicleBlockingRules" :key="rule.blockingId">
                  <div
                    class="vehicle-blocking-item bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-all">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <div class="flex items-center mb-2">
                          <div class="status-indicator mr-2" :class="getBlockingReasonStatusClass(rule.reasonCode)">
                          </div>
                          <span class="text-sm font-semibold text-gray-800"
                            x-text="getBlockingReasonName(rule.reasonCode)"></span>
                        </div>
                        <p class="text-xs text-gray-600 mb-2 flex items-center"
                          x-text="`📅 ${rule.startDate} ถึง ${rule.endDate}`"></p>
                        <p class="text-xs text-gray-500" x-text="rule.reasonDescription || 'ไม่มีหมายเหตุ'"></p>
                      </div>
                      <div class="flex gap-2 ml-4">
                        <button @click="editVehicleBlockingRule(rule)"
                          class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 transition-all"
                          title="แก้ไข">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button @click="deleteVehicleBlockingRule(rule.blockingId)"
                          class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-all"
                          title="ลบ">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- เมื่อไม่มีการปิด -->
                <div x-show="selectedVehicleBlockingRules.length === 0" class="text-center text-gray-500 py-8">
                  <i class="fas fa-check-circle text-4xl mb-3 text-green-500"></i>
                  <h3 class="text-lg font-medium text-gray-700 mb-1">รถคันนี้ไม่มีวันปิด</h3>
                  <p class="text-sm text-gray-500">สามารถให้เช่าได้ทุกวัน</p>
                </div>
              </div>
            </div>
          </div>
        </div>



      </div>
    </div>

    <!-- Modal: แก้ไขการปิดรถ -->
    <div x-show="editVehicleBlockingModal"
      class="vehicle-blocking-modal fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full z-50" x-cloak>
      <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-xl rounded-xl bg-white">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900 flex items-center">
              <i class="fas fa-edit mr-3 text-blue-500"></i>
              แก้ไขการปิดรถ
            </h3>
            <button @click="editVehicleBlockingModal = false"
              class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-all">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- ฟอร์มแก้ไข -->
          <div class="space-y-5">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label>
              <input type="date" x-model="editingVehicleBlockingRule.startDate"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label>
              <input type="date" x-model="editingVehicleBlockingRule.endDate"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">เหตุผลการปิด</label>
              <select x-model="editingVehicleBlockingRule.reasonCode"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                <template x-for="reason in blockingReasonsData">
                  <option :value="reason.reasonCode" x-text="reason.reasonName"></option>
                </template>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุ</label>
              <textarea x-model="editingVehicleBlockingRule.reasonDescription" rows="3"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"></textarea>
            </div>

            <div class="flex gap-3 pt-4">
              <button @click="updateVehicleBlockingRule()"
                class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all font-medium shadow-md hover:shadow-lg">
                <i class="fas fa-save mr-2"></i>
                บันทึกการแก้ไข
              </button>
              <button @click="editVehicleBlockingModal = false"
                class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-all font-medium">
                ยกเลิก
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: ยืนยันการลบ -->
    <div x-show="deleteVehicleBlockingModal"
      class="vehicle-blocking-modal fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full z-50" x-cloak>
      <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-xl rounded-xl bg-white">
        <div class="mt-3 text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-6">
            <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">ยืนยันการลบ</h3>
          <p class="text-gray-500 mb-6">
            คุณต้องการลบการปิดรถในช่วงวันที่นี้หรือไม่?<br>
            <strong class="text-red-600">การดำเนินการนี้ไม่สามารถย้อนกลับได้</strong>
          </p>

          <div class="flex gap-3 justify-center">
            <button @click="confirmDeleteVehicleBlocking()"
              class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all font-medium shadow-md hover:shadow-lg">
              <i class="fas fa-trash mr-2"></i>
              ลบ
            </button>
            <button @click="deleteVehicleBlockingModal = false"
              class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-all font-medium">
              ยกเลิก
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: แสดงความขัดแย้ง -->
    <div x-show="vehicleBlockingConflictModal"
      class="vehicle-blocking-modal fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full z-50" x-cloak>
      <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 shadow-xl rounded-xl bg-white">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900 flex items-center">
              <i class="fas fa-exclamation-triangle mr-3 text-yellow-500"></i>
              พบความขัดแย้งในการปิดรถ
            </h3>
            <button @click="vehicleBlockingConflictModal = false"
              class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-all">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- แสดงรายการขัดแย้ง -->
          <div class="space-y-4 mb-6 max-h-96 overflow-y-auto">
            <template x-for="conflict in vehicleBlockingConflicts">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h4 class="font-medium text-gray-800 mb-3" x-text="conflict.message"></h4>

                <!-- รายการจองที่ขัดแย้ง -->
                <div x-show="conflict.conflictingBookings && conflict.conflictingBookings.length > 0">
                  <p class="text-sm text-gray-600 mb-2 font-medium">การจองที่ขัดแย้ง:</p>
                  <div class="space-y-2">
                    <template x-for="booking in conflict.conflictingBookings">
                      <div class="bg-white p-3 rounded border text-sm">
                        <div class="font-medium" x-text="`${booking.bookingId} - ${booking.customerName}`"></div>
                        <div class="text-gray-500" x-text="`📅 ${booking.startDate} ถึง ${booking.endDate}`"></div>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- การปิดที่ซ้ำทับ -->
                <div x-show="conflict.overlappingBlocks && conflict.overlappingBlocks.length > 0">
                  <p class="text-sm text-gray-600 mb-2 font-medium">การปิดที่ซ้ำทับ:</p>
                  <div class="space-y-2">
                    <template x-for="block in conflict.overlappingBlocks">
                      <div class="bg-white p-3 rounded border text-sm">
                        <div class="font-medium"
                          x-text="block.reasonCode + ' - ' + (block.reasonDescription || 'ไม่มีหมายเหตุ')"></div>
                        <div class="text-gray-500" x-text="`📅 ${block.startDate} ถึง ${block.endDate}`"></div>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- ปุ่มดำเนินการ -->
          <div class="flex gap-3 justify-end">
            <button @click="vehicleBlockingConflictModal = false"
              class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-all font-medium">
              ปิด
            </button>
          </div>
        </div>
      </div>
    </div>








    <!-- Modal: จัดการกลุ่มรถ -->
    <div x-show="vehicleGroupManagementModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
      <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">จัดการกลุ่มรถ</h3>
            <button @click="vehicleGroupManagementModal = false" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- ฟอร์มสร้างกลุ่มใหม่ -->
          <div class="mb-6">
            <h4 class="font-medium text-gray-800 mb-3">สร้างกลุ่มรถใหม่</h4>

            <div class="grid grid-cols-1 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อกลุ่ม</label>
                <input type="text" x-model="vehicleGroupFormData.name"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="เช่น: รถกะบะ, รถเซดาน">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">คำอธิบาย</label>
                <textarea x-model="vehicleGroupFormData.description"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="2"
                  placeholder="คำอธิบายเพิ่มเติม (ไม่บังคับ)"></textarea>
              </div>
            </div>

            <!-- เลือกรถสำหรับกลุ่ม -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">เลือกรถสำหรับกลุ่มนี้</label>
              <div class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg">
                <template x-for="vehicle in ungroupedVehiclesForSelection" :key="vehicle.รหัสรถ">
                  <label class="flex items-center p-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer">
                    <input type="checkbox" :value="vehicle.รหัสรถ" x-model="vehicleGroupFormData.selectedVehicleCodes"
                      class="mr-3 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <div class="flex-1">
                      <p class="text-sm font-medium text-gray-900" x-text="`${vehicle.รหัสรถ} - ${vehicle.ชื่อรถเต็ม}`">
                      </p>
                      <p class="text-xs text-gray-500" x-text="`ราคา: ${vehicle.ราคาเริ่มต้น} บาท/วัน`"></p>
                    </div>
                  </label>
                </template>
              </div>

              <!-- เมื่อไม่มีรถให้เลือก -->
              <div x-show="ungroupedVehiclesForSelection.length === 0" class="text-center py-4 text-gray-500">
                <p class="text-sm">ไม่มีรถที่สามารถเพิ่มเข้ากลุ่มได้ (รถทั้งหมดอยู่ในกลุ่มแล้ว)</p>
              </div>
            </div>

            <!-- ปุ่มสร้างกลุ่ม -->
            <div class="flex justify-end gap-2">
              <button @click="vehicleGroupManagementModal = false"
                class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">ยกเลิก</button>
              <button @click="createVehicleGroup()" :disabled="isUpdatingVehicleGroup"
                class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors disabled:opacity-50">
                <span x-text="isUpdatingVehicleGroup ? 'กำลังสร้าง...' : 'สร้างกลุ่ม'"></span>
              </button>
            </div>
          </div>

          <!-- รายการกลุ่มที่มีอยู่ -->
          <div>
            <h4 class="font-medium text-gray-800 mb-3">กลุ่มรถที่มีอยู่</h4>
            <div class="space-y-2 max-h-64 overflow-y-auto">
              <template x-for="group in vehicleGroupsForPricing" :key="group.id">
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <p class="font-medium text-gray-800" x-text="group.name"></p>
                      <p class="text-sm text-gray-600" x-text="group.description"></p>
                      <p class="text-xs text-gray-500" x-text="`จำนวนรถ: ${group.vehicleCodes.length} คัน`"></p>
                    </div>
                    <div class="flex gap-2">
                      <button @click="openVehicleGroupEditModal(group)"
                        class="text-blue-500 hover:text-blue-700 text-sm">
                        <i class="fas fa-edit mr-1"></i>แก้ไข
                      </button>
                      <button @click="deleteVehicleGroup(group.id)" class="text-red-500 hover:text-red-700 text-sm">
                        <i class="fas fa-trash mr-1"></i>ลบ
                      </button>
                    </div>
                  </div>
                </div>
              </template>

              <!-- เมื่อไม่มีกลุ่ม -->
              <div x-show="vehicleGroupsForPricing.length === 0" class="text-center py-4 text-gray-500">
                <p class="text-sm">ยังไม่มีกลุ่มรถ</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: แก้ไขกลุ่มรถ -->
    <div x-show="vehicleGroupEditingModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
      <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">แก้ไขกลุ่มรถ</h3>
            <button @click="vehicleGroupEditingModal = false" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- รายชื่อรถในกลุ่ม -->
          <template x-if="currentEditingVehicleGroup">
            <div>
              <h4 class="font-medium text-gray-800 mb-3"
                x-text="`รายชื่อรถในกลุ่ม: ${currentEditingVehicleGroup.name}`"></h4>

              <div class="space-y-2 mb-4 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-2">
                <template x-for="vehicleCode in currentEditingVehicleGroup.vehicleCodes" :key="vehicleCode">
                  <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                    <!-- หาข้อมูลรถจาก vehicleCode -->
                    <template x-for="vehicle in availableVehiclesForPricing" :key="vehicle.รหัสรถ">
                      <div x-show="vehicle.รหัสรถ === vehicleCode" class="flex-1">
                        <p class="text-sm font-medium text-gray-900"
                          x-text="`${vehicle.รหัสรถ} - ${vehicle.ชื่อรถเต็ม}`"></p>
                        <p class="text-xs text-gray-500" x-text="`ราคา: ${vehicle.ราคาเริ่มต้น} บาท/วัน`"></p>
                      </div>
                    </template>

                    <button @click="removeVehicleFromCurrentGroup(vehicleCode)"
                      class="text-red-500 hover:text-red-700 text-sm ml-2">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </template>

                <!-- เมื่อไม่มีรถในกลุ่ม -->
                <div x-show="currentEditingVehicleGroup.vehicleCodes.length === 0"
                  class="text-center py-4 text-gray-500">
                  <p class="text-sm">ไม่มีรถในกลุ่มนี้</p>
                </div>
              </div>

              <!-- ปุ่มอัพเดท -->
              <div class="flex justify-end gap-2">
                <button @click="vehicleGroupEditingModal = false"
                  class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">ยกเลิก</button>
                <button @click="updateVehicleGroupData()" :disabled="isUpdatingVehicleGroup"
                  class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors disabled:opacity-50">
                  <span x-text="isUpdatingVehicleGroup ? 'กำลังอัพเดท...' : 'อัพเดทข้อมูล'"></span>
                </button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

  </div>


  <!-- หน้าจัดการรถ -->
  <div x-show="currentPage === 'cars'" x-cloak>


    <div class="mb-6">
      <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4" style="border-color: #FFD09E;">
        <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5"
          style="background-color: #FFD09E;">
          <i class="fas fa-car text-white text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-800">จัดการรถ</h2>
          <p class="mt-1 text-gray-600">
            <i class="fas fa-cogs mr-2" style="color: #FFD09E;"></i>เพิ่ม ลบ หรือแก้ไขข้อมูลรถในระบบ
          </p>
        </div>
      </div>
    </div>



    <!-- ปุ่มเพิ่มรถใหม่ -->
    <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
      <!-- สรุปข้อมูลจำนวนรถ (เต็มแถวบนจอเล็ก, ชิดซ้ายบนจอใหญ่) -->
      <div class="bg-blue-50 rounded-lg shadow-sm p-3 w-full md:w-auto">
        <!-- Container สำหรับจอเล็ก ที่แยกแถว -->
        <div class="flex flex-col sm:hidden space-y-3">
          <!-- แถวบน: จำนวนรถทั้งหมด -->
          <div class="flex items-center justify-center">
            <i class="fas fa-car text-blue-500 mr-2"></i>
            <span class="text-blue-700">จำนวนรถทั้งหมด: </span>
            <span class="font-semibold text-blue-900 ml-1" x-text="cars.length"></span>
          </div>

          <!-- แถวกลาง: ประเภทรถ -->
          <div x-show="carCategorySummary.length > 0" class="border-t border-blue-200 pt-2">
            <div class="text-center text-blue-600 text-sm mb-2 font-medium">ประเภทรถ:</div>
            <div class="flex flex-wrap justify-center gap-2">
              <template x-for="category in carCategorySummary" :key="category.name">
                <div class="flex items-center bg-white rounded-full px-2 py-1 text-xs border border-blue-200">
                  <i class="fas fa-circle text-blue-500 mr-1"></i>
                  <span class="text-gray-700" x-text="category.name"></span>
                  <span class="font-semibold text-purple-700 ml-1" x-text="category.count + 'คัน'"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- แถวล่าง: สถานะรถ -->
          <div class="border-t border-blue-200 pt-2">
            <div class="flex justify-center gap-6">
              <div class="flex items-center">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                <span class="text-green-700">พร้อมให้เช่า: </span>
                <span class="font-semibold text-green-900 ml-1"
                  x-text="cars.filter(car => car.สถานะ === 'พร้อมให้เช่า').length"></span>
              </div>

              <div class="flex items-center">
                <i class="fas fa-times-circle text-red-500 mr-2"></i>
                <span class="text-red-700">ไม่พร้อมให้เช่า: </span>
                <span class="font-semibold text-red-900 ml-1"
                  x-text="cars.filter(car => car.สถานะ === 'ไม่พร้อมให้เช่า').length"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Container สำหรับจอขนาดกลาง-ใหญ่ -->
        <div class="hidden sm:block">
          <!-- แถวแรก: จำนวนรถทั้งหมด -->
          <div class="flex items-center mb-2">
            <i class="fas fa-car text-blue-500 mr-2"></i>
            <span class="text-blue-700">จำนวนรถทั้งหมด: </span>
            <span class="font-semibold text-blue-900 ml-1" x-text="cars.length"></span>
          </div>

          <!-- แถวที่สอง: ประเภทรถ -->
          <div x-show="carCategorySummary.length > 0" class="mb-2">
            <div class="flex items-center flex-wrap gap-2">
              <span class="text-purple-600 text-sm font-medium mr-2">ประเภทรถ:</span>
              <template x-for="category in carCategorySummary" :key="category.name">
                <div
                  class="flex items-center bg-white rounded-full px-3 py-1 text-sm border border-purple-200 hover:bg-purple-50 transition-colors">
                  <i class="fas fa-circle text-blue-500 mr-1"></i>
                  <span class="text-gray-700" x-text="category.name"></span>
                  <span class="font-semibold text-purple-700 ml-1" x-text="category.count + 'คัน'"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- แถวที่สาม: สถานะรถ -->
          <div class="flex flex-wrap gap-4">
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-500 mr-2"></i>
              <span class="text-green-700">พร้อมให้เช่า: </span>
              <span class="font-semibold text-green-900 ml-1"
                x-text="cars.filter(car => car.สถานะ === 'พร้อมให้เช่า').length"></span>
            </div>

            <div class="flex items-center">
              <i class="fas fa-times-circle text-red-500 mr-2"></i>
              <span class="text-red-700">ไม่พร้อมให้เช่า: </span>
              <span class="font-semibold text-red-900 ml-1"
                x-text="cars.filter(car => car.สถานะ === 'ไม่พร้อมให้เช่า').length"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 mb-4">
      <div class="inline-block bg-amber-50 border-l-4 border-amber-400 p-3 rounded-md">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="fas fa-info-circle text-red-500 mt-0.5"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-grey-500">
              หากตั้งสถานะเป็น ไม่พร้อมให้เช่า จะไม่สามารถเลือกรถคันนั้นได้ในหน้าสร้างรายการเช่าใหม่
            </p>
          </div>
        </div>
      </div>
    </div>


    <!-- ปุ่มเพิ่มรถใหม่ -->
    <div class="mt-4 mb-6 flex justify-center md:justify-end">
      <button @click="openNewCarForm()"
        class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 flex items-center justify-center w-full md:w-auto">
        <i class="fas fa-plus mr-2"></i>เพิ่มรถใหม่
      </button>
    </div>



    <!-- ตารางแสดงรายการรถ -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
        <h2 class="text-lg font-semibold">รายการรถทั้งหมด</h2>
        <div class="relative">
          <input type="text" x-model="carSearchQuery" placeholder="ค้นหา..."
            class="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสรถ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ยี่ห้อ/รุ่น
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ทะเบียน</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                พื้นที่การใช้งาน</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สี</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ราคาเช่า/วัน
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="car in filteredCarsForCarTable" :key="car.id">
              <tr>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="car.รหัสรถ"></td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                  <span x-text="car.ยี่ห้อ"></span>
                  <span x-text="car.รุ่น ? ' ' + car.รุ่น : ''"></span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="car.ทะเบียน"></td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatZone(car.พื้นที่การใช้งาน)">
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="car.สี"></td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500"
                  x-text="formatCurrency(car.ราคาเช่าต่อวัน)"></td>
                <td class="px-4 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" :class="{
                              'bg-green-100 text-green-800': car.สถานะ === 'พร้อมให้เช่า',                             
                              'bg-red-100 text-red-800': car.สถานะ === 'ไม่พร้อมให้เช่า'
                            }" x-text="car.สถานะ"></span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                  <div class="group relative inline-block">
                    <button @click="editCar(car)" class="text-blue-600 hover:text-blue-900 mr-2">
                      <i class="fas fa-edit"></i>
                    </button>
                    <div
                      class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                      แก้ไขข้อมูลรถ
                    </div>
                  </div>

                  <div class="group relative inline-block">
                    <button @click="deleteCar(car.id)" class="text-red-600 hover:text-red-900">
                      <i class="fas fa-trash"></i>
                    </button>
                    <div
                      class="absolute z-10 -mt-10 -ml-12 px-2 py-1 text-xs bg-gray-900 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                      ลบข้อมูลรถ
                    </div>
                  </div>
                </td>
              </tr>
            </template>
            <tr x-show="filteredCarsForCarTable.length === 0">
              <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">ไม่พบรายการรถ</td>
            </tr>
          </tbody>
        </table>

      </div>

    </div>



    <!-- การ์ดแจ้งเตือนทั้งหมดสำหรับหน้าจัดการรถ -->
    <div class="mt-6">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">

        <!-- หัวข้อและปุ่มการแจ้งเตือนแบบ Responsive -->
        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100 rounded-t-lg shadow-sm">
          <div class="flex flex-col md:flex-row md:justify-between md:items-center">
            <!-- ส่วนซ้าย: หัวข้อและสถิติ -->
            <div class="flex flex-col mb-4 md:mb-0">
              <div class="flex items-center">
                <div
                  class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center mr-3 shadow-inner">
                  <i class="fas fa-bell text-blue-600"></i>
                </div>
                <h2 class="text-xl font-bold text-blue-800 flex items-center">
                  ตารางการแจ้งเตือนการบำรุงรักษา
                  <span x-show="maintenance.length > 0"
                    class="ml-2 inline-flex items-center justify-center px-2.5 py-1 text-xs font-bold leading-none text-white bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full transform transition-transform hover:scale-105 shadow"
                    x-text="maintenance.length"></span>
                </h2>
              </div>

              <!-- สถิติการแจ้งเตือน -->
              <div class="mt-2 flex items-center space-x-4 pl-12">
                <div class="flex items-center text-sm text-gray-600">
                  <div class="h-2.5 w-2.5 rounded-full bg-green-500 mr-1.5"></div>
                  <span x-text="'เสร็จสิ้น: ' + completedCount"></span>
                </div>
                <div class="flex items-center text-sm text-gray-600">
                  <div class="h-2.5 w-2.5 rounded-full bg-yellow-500 mr-1.5"></div>
                  <span x-text="'รอดำเนินการ: ' + pendingCount"></span>
                </div>
                <div class="flex items-center text-sm text-gray-600">
                  <div class="h-2.5 w-2.5 rounded-full bg-red-500 mr-1.5"></div>
                  <span x-text="'เกินกำหนด: ' + overdueCount"></span>
                </div>
              </div>
            </div>

            <!-- ส่วนขวา: ปุ่มสร้างแจ้งเตือนและค้นหา -->
            <div class="flex flex-col space-y-3 md:flex-row md:space-y-0 md:space-x-3">


              <!-- ปุ่มสร้างการแจ้งเตือน -->
              <button @click="openMaintenanceForm()"
                class="relative overflow-hidden bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-2 px-4 rounded-md hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md transition-all duration-300 transform hover:scale-105 md:w-auto">
                <span class="absolute right-0 top-0 h-4 w-4 transform translate-x-1/2 -translate-y-1/2 rotate-45">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-30"></span>
                </span>
                <i class="fas fa-plus-circle mr-2"></i>สร้างการแจ้งเตือน
              </button>
            </div>
          </div>

          <!-- จุดสังเกตและคำแนะนำ -->
          <div class="flex items-center mt-4 px-3 py-2 bg-white bg-opacity-70 rounded-md border border-blue-100">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
            <p class="text-sm text-gray-600">
              <span class="font-medium">เคล็ดลับ:</span>
              การตั้งค่าการแจ้งเตือนที่เหมาะสมช่วยลดค่าใช้จ่ายในการซ่อมบำรุงได้ถึง 35%
            </p>
          </div>
        </div>

        <!-- ส่วนค้นหาและกรอง -->
        <div class="p-4 border-b border-gray-200 bg-gray-50">
          <div class="flex flex-wrap items-center gap-3">
            <div class="flex-1 min-w-[200px]">
              <input type="text" x-model="carMaintenanceSearchQuery" placeholder="ค้นหารายการแจ้งเตือน..."
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="flex items-center space-x-2">
              <span class="text-sm text-gray-600">สถานะ:</span>
              <select x-model="carMaintenanceStatusFilter"
                class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="all">ทั้งหมด</option>
                <option value="active">ยังไม่เสร็จสิ้น</option>
                <option value="overdue">เลยกำหนด</option>
                <option value="completed">เสร็จสิ้นแล้ว</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ถ้าไม่มีการแจ้งเตือน -->
        <div x-show="maintenance.length === 0" class="p-6 text-center">
          <i class="fas fa-bell-slash text-gray-400 text-4xl mb-3"></i>
          <h3 class="text-lg font-medium text-gray-900 mb-1">ไม่มีการแจ้งเตือนการบำรุงรักษา</h3>
          <p class="text-gray-500">คุณยังไม่มีรายการแจ้งเตือนสำหรับรถของคุณ</p>
        </div>

        <!-- รายการแจ้งเตือนทั้งหมด -->
        <div x-show="maintenance.length > 0" class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รถ</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รูปแบบ</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  วันที่/ระยะทาง</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="item in filteredCarMaintenance" :key="item.id">
                <tr :class="{
    'bg-red-50': isOverdue(item) && !item.ทำรายการแล้ว,
    'bg-yellow-50': !isOverdue(item) && !item.ทำรายการแล้ว,
    'bg-green-50': item.ทำรายการแล้ว
  }" class="hover:bg-gray-100 border-l-4 transition-all duration-150" :class="{
    'border-l-red-500': isOverdue(item) && !item.ทำรายการแล้ว,
    'border-l-yellow-500': !isOverdue(item) && !item.ทำรายการแล้ว,
    'border-l-green-500': item.ทำรายการแล้ว
  }">
                  <td class="px-4 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <span :class="{
          'bg-red-200 text-red-700 shadow-md shadow-red-100': isOverdue(item) && !item.ทำรายการแล้ว,
          'bg-yellow-200 text-yellow-700 shadow-md shadow-yellow-100': !isOverdue(item) && !item.ทำรายการแล้ว,
          'bg-green-200 text-green-700 shadow-md shadow-green-100': item.ทำรายการแล้ว
        }" class="flex items-center justify-center w-10 h-10 rounded-full mr-3">
                        <i :class="getMaintenanceIcon(item.ประเภทการแจ้งเตือน)"></i>
                      </span>
                      <span class="text-sm font-medium" :class="{
          'text-red-800': isOverdue(item) && !item.ทำรายการแล้ว,
          'text-yellow-800': !isOverdue(item) && !item.ทำรายการแล้ว,
          'text-green-800': item.ทำรายการแล้ว
        }" x-text="item.ประเภทการแจ้งเตือน"></span>
                    </div>
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600" x-text="item.รถ"></td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600" x-text="item.รูปแบบการแจ้งเตือน"></td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600" x-html="formatMaintenanceDate(item)">
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap">
                    <span :class="{
        'bg-green-200 text-green-800 border border-green-300': item.ทำรายการแล้ว,
        'bg-red-200 text-red-800 border border-red-300 font-bold': isOverdue(item) && !item.ทำรายการแล้ว,
        'bg-yellow-200 text-yellow-800 border border-yellow-300': !isOverdue(item) && !item.ทำรายการแล้ว
      }" class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                      <i :class="{
          'fas fa-check-circle mr-1': item.ทำรายการแล้ว,
          'fas fa-exclamation-circle mr-1': isOverdue(item) && !item.ทำรายการแล้ว,
          'fas fa-clock mr-1': !isOverdue(item) && !item.ทำรายการแล้ว
        }"></i>
                      <span x-text="getStatusText(item)"></span>
                    </span>
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-3">
                      <button @click="markAsCompleted(item)"
                        :class="item.ทำรายการแล้ว ? 'text-gray-400 cursor-not-allowed' : 'text-green-600 hover:text-green-900 hover:scale-110 transition-transform'"
                        :disabled="item.ทำรายการแล้ว" title="ทำเครื่องหมายว่าเสร็จสิ้น">
                        <i class="fas fa-check-circle text-lg"></i>
                      </button>
                      <button @click="editMaintenance(item)"
                        class="text-blue-600 hover:text-blue-900 hover:scale-110 transition-transform" title="แก้ไข">
                        <i class="fas fa-edit text-lg"></i>
                      </button>
                      <button @click="deleteMaintenance(item.id)"
                        class="text-red-600 hover:text-red-900 hover:scale-110 transition-transform" title="ลบ">
                        <i class="fas fa-trash text-lg"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>



      </div>
    </div>















    <br><br><br>

    <!-- Modal สำหรับเพิ่ม/แก้ไขรถ -->


    <!-- Modal เพิ่ม/แก้ไขรถ - เวอร์ชันปรับปรุงพร้อมรหัสรถและประเภทรถ -->
    <!-- Modal เพิ่ม/แก้ไขรถ - แก้ไขแล้วรองรับมือถือ (Inline Management) -->
    <div x-show="showCarModal" x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
      x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
      x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
      class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">

      <div class="flex items-end sm:items-center justify-center min-h-screen pt-4 px-4 pb-20">
        <!-- Background overlay -->
        <div class="fixed inset-0 transition-opacity" aria-hidden="true" @click="closeCarModal()">
          <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <!-- Modal content - Responsive -->
        <div
          class="inline-block w-full sm:align-middle bg-white rounded-t-2xl sm:rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-2xl sm:w-full max-h-[95vh] flex flex-col">

          <!-- Header - Sticky -->
          <div :class="carEditMode ? 'bg-blue-600' : 'bg-green-600'" class="px-4 sm:px-6 py-4 flex-shrink-0">
            <div class="flex items-center justify-between">
              <h3 class="text-lg sm:text-xl leading-6 font-bold text-white flex items-center">
                <i x-show="!carEditMode" class="fas fa-plus-circle mr-2 sm:mr-3"></i>
                <i x-show="carEditMode" class="fas fa-edit mr-2 sm:mr-3"></i>
                <span x-text="carModalTitle"></span>
              </h3>
              <!-- ปุ่มปิดสำหรับมือถือ -->
              <button @click="closeCarModal()" class="sm:hidden text-white hover:text-gray-200 p-1">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>

          <!-- Warning สำหรับ edit mode -->
          <div x-show="carEditMode" class="px-4 sm:px-6 py-3 bg-yellow-50 border-b border-yellow-200 flex-shrink-0">
            <p class="text-sm text-yellow-700 flex items-center">
              <i class="fas fa-info-circle mr-2 text-yellow-600"></i>
              การแก้ไขข้อมูลรถจะมีผลกับรายการเช่าที่เกี่ยวข้องทั้งหมด
            </p>
          </div>

          <!-- Content - Scrollable -->
          <div class="flex-1 overflow-y-auto">
            <div :class="carEditMode ? 'bg-blue-50' : 'bg-white'" class="px-4 sm:px-6 py-4 sm:py-6">
              <div class="space-y-4 sm:space-y-6">

                <!-- ===== ส่วนบน: รหัสรถและประเภทรถ ===== -->
                <div
                  class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 sm:p-6 border-2 border-dashed border-gray-300">
                  <h4 class="text-base sm:text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    ข้อมูลหลัก
                  </h4>

                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">

                    <!-- รหัสรถ -->
                    <div class="space-y-2">
                      <label class="block text-sm font-bold text-gray-700">
                        <i class="fas fa-hashtag mr-2 text-blue-500"></i>รหัสรถ
                      </label>
                      <div class="relative">
                        <input type="text"
                          :value="carEditMode ? (currentCar.รหัสรถ || 'ไม่มีรหัส') : 'จะสร้างอัตโนมัติหลังบันทึก'"
                          disabled
                          :class="carEditMode ? 'bg-gray-100 text-gray-700 font-medium border-gray-300' : 'bg-blue-50 text-blue-600 border-blue-200'"
                          class="w-full px-3 sm:px-4 py-3 border-2 rounded-xl text-center text-sm sm:text-base font-mono tracking-wider">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                          <i :class="carEditMode ? 'fas fa-lock text-gray-400' : 'fas fa-magic text-blue-500'"
                            :title="carEditMode ? 'ไม่สามารถแก้ไขได้' : 'สร้างอัตโนมัติ'"></i>
                        </div>
                      </div>
                      <p class="text-xs text-gray-500 flex items-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        <span
                          x-text="carEditMode ? 'รหัสรถไม่สามารถแก้ไขได้เพื่อความปลอดภัย' : 'รหัสรถจะถูกสร้างอัตโนมัติเมื่อบันทึกข้อมูล'"></span>
                      </p>
                    </div>

                    <!-- ประเภทรถ -->
                    <div class="space-y-2">
                      <label class="block text-sm font-bold text-gray-700">
                        <i class="fas fa-tags mr-2 text-purple-500"></i>ประเภทรถ
                        <span class="text-red-500 ml-1">*</span>
                      </label>
                      <div class="flex gap-2">
                        <select x-model="currentCar.ประเภทรถ" required
                          class="flex-1 px-3 sm:px-4 py-3 border-2 border-gray-300 rounded-xl text-sm sm:text-base focus:border-purple-500 focus:ring-2 focus:ring-purple-100 transition-all duration-300">
                          <option value="">-- เลือกประเภทรถ --</option>
                          <template x-for="category in carCategories" :key="category">
                            <option :value="category" x-text="category"></option>
                          </template>
                        </select>
                        <button @click="toggleCategoryManagement()" type="button"
                          :class="showCategoryManagement ? 'bg-red-600 hover:bg-red-700' : 'bg-purple-600 hover:bg-purple-700'"
                          class="px-3 sm:px-4 py-3 text-white rounded-xl transition-colors duration-200 flex items-center justify-center"
                          :title="showCategoryManagement ? 'ปิดการจัดการ' : 'จัดการประเภทรถ'">
                          <i :class="showCategoryManagement ? 'fas fa-times' : 'fas fa-cog'"
                            class="text-sm sm:text-base"></i>
                        </button>
                      </div>
                      <p class="text-xs text-gray-500 flex items-center">
                        <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>
                        เลือกประเภทรถ หรือคลิก <i
                          :class="showCategoryManagement ? 'fas fa-times text-red-500' : 'fas fa-cog text-purple-500'"
                          class="mx-1"></i> เพื่อ<span x-text="showCategoryManagement ? 'ปิด' : 'เปิด'"></span>การจัดการ
                      </p>
                    </div>
                  </div>
                </div>

                <!-- ===== การจัดการประเภทรถ (Inline Expandable) ===== -->
                <div x-show="showCategoryManagement" x-transition:enter="transition ease-out duration-300"
                  x-transition:enter-start="opacity-0 -translate-y-4 scale-95"
                  x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                  x-transition:leave="transition ease-in duration-200"
                  x-transition:leave-start="opacity-100 translate-y-0 scale-100"
                  x-transition:leave-end="opacity-0 -translate-y-4 scale-95"
                  class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-4 sm:p-6 shadow-inner">

                  <h4 class="text-base sm:text-lg font-bold text-purple-800 mb-4 flex items-center">
                    <i class="fas fa-tags mr-2"></i>
                    จัดการประเภทรถ
                    <span
                      class="ml-auto text-xs sm:text-sm font-normal text-purple-600 bg-purple-100 px-2 py-1 rounded-full">
                      <i class="fas fa-layer-group mr-1"></i>โหมดจัดการ
                    </span>
                  </h4>

                  <!-- เพิ่มประเภทใหม่ -->
                  <div class="mb-4 sm:mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2 sm:mb-3">
                      <i class="fas fa-plus-circle mr-2 text-green-500"></i>เพิ่มประเภทใหม่
                    </label>
                    <div class="flex gap-2">
                      <input type="text" x-model="newCategoryName" @keyup.enter="addCarCategory()"
                        class="flex-1 px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-200 rounded-xl text-sm sm:text-base focus:border-green-500 focus:ring-2 focus:ring-green-100 transition-all duration-300"
                        placeholder="เช่น รถของร้าน, รถ Partner">
                      <button @click="addCarCategory()" :disabled="!newCategoryName.trim()"
                        :class="newCategoryName.trim() ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-300 cursor-not-allowed'"
                        class="px-4 sm:px-6 py-2 sm:py-3 text-white rounded-xl text-sm sm:text-base transition-colors duration-200">
                        <i class="fas fa-plus"></i>
                        <span class="hidden sm:inline ml-2">เพิ่ม</span>
                      </button>
                    </div>
                  </div>

                  <!-- รายการประเภทที่มีอยู่ -->
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 sm:mb-3">
                      <i class="fas fa-list mr-2 text-blue-500"></i>ประเภทที่มีอยู่
                    </label>

                    <div x-show="carCategories.length === 0" class="text-center py-6 sm:py-8 text-gray-500">
                      <i class="fas fa-inbox text-2xl sm:text-4xl mb-2 sm:mb-3"></i>
                      <p class="text-sm sm:text-base">ยังไม่มีประเภทรถ</p>
                      <p class="text-xs sm:text-sm mt-1">เพิ่มประเภทใหม่ด้านบนเพื่อเริ่มต้น</p>
                    </div>

                    <div x-show="carCategories.length > 0" class="space-y-2 max-h-48 overflow-y-auto">
                      <template x-for="(category, index) in carCategories" :key="index">
                        <div
                          class="flex items-center justify-between p-3 bg-white rounded-xl border hover:bg-gray-50 transition-colors duration-200 shadow-sm">
                          <div class="flex items-center flex-1 min-w-0">
                            <i class="fas fa-tag text-purple-500 mr-3 flex-shrink-0"></i>
                            <span x-text="category"
                              class="font-medium text-gray-700 text-sm sm:text-base truncate"></span>
                          </div>
                          <button @click="removeCarCategory(index)"
                            class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded-lg transition-colors duration-200 ml-2 flex-shrink-0"
                            title="ลบประเภทนี้">
                            <i class="fas fa-trash text-sm"></i>
                          </button>
                        </div>
                      </template>
                    </div>
                  </div>

                  <!-- ปุ่มบันทึกการตั้งค่า -->
                  <div class="mt-4 sm:mt-6 pt-4 border-t border-purple-200">
                    <button @click="saveCarCategories()"
                      class="w-full sm:w-auto px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl text-sm sm:text-base font-medium transition-colors duration-200 flex items-center justify-center">
                      <i class="fas fa-save mr-2"></i>
                      บันทึกการตั้งค่า
                    </button>
                  </div>
                </div>

                <!-- ===== ข้อมูลทั่วไป ===== -->
                <div class="space-y-4">
                  <h4
                    class="text-base sm:text-lg font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                    <i class="fas fa-car mr-2 text-blue-500"></i>
                    ข้อมูลรถยนต์
                  </h4>

                  <!-- แถวที่ 1: สถานะและประเภทรถ (เก่า) -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">สถานะ</label>
                      <select x-model="currentCar.สถานะ" required
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                        <option value="พร้อมให้เช่า">พร้อมให้เช่า</option>
                        <option value="ไม่พร้อมให้เช่า">ไม่พร้อมให้เช่า</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ประเภทพาหนะ</label>
                      <select x-model="currentCar.ประเภท" @change="updateFuelTypeVisibility()"
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                        <option value="รถยนต์(น้ำมัน)">รถยนต์(น้ำมัน)</option>
                        <option value="รถยนต์(รถไฟฟ้า)">รถยนต์(รถไฟฟ้า)</option>
                        <option value="รถจักรยานยนต์(น้ำมัน)">รถจักรยานยนต์(น้ำมัน)</option>
                        <option value="รถจักรยานยนต์(รถไฟฟ้า)">รถจักรยานยนต์(รถไฟฟ้า)</option>
                      </select>
                    </div>
                  </div>

                  <!-- แถวที่ 2: ยี่ห้อและรุ่น -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ยี่ห้อ <span
                          class="text-red-500">*</span></label>
                      <div class="relative">
                        <input type="text" list="car-brands-list" x-model="currentCar.ยี่ห้อ" required
                          class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500"
                          autocomplete="off">
                        <datalist id="car-brands-list">
                          <template x-for="brand in carBrands" :key="brand">
                            <option :value="brand"></option>
                          </template>
                        </datalist>
                        <div
                          class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                          <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                      </div>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">รุ่น <span
                          class="text-red-500">*</span></label>
                      <div class="relative">
                        <input type="text" list="car-models-list" x-model="currentCar.รุ่น" required
                          class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500"
                          autocomplete="off">
                        <datalist id="car-models-list">
                          <template x-for="model in carModels" :key="model">
                            <option :value="model"></option>
                          </template>
                        </datalist>
                        <div
                          class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                          <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- แถวที่ 3: ทะเบียนและสี -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ทะเบียน <span
                          class="text-red-500">*</span></label>
                      <input type="text" x-model="currentCar.ทะเบียน" required
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">สี</label>
                      <input type="text" x-model="currentCar.สี"
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                    </div>
                  </div>

                  <!-- แถวที่ 4: ราคาเช่าและค่าประกัน -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ราคาเช่าต่อวัน</label>
                      <input type="number" x-model="currentCar.ราคาเช่าต่อวัน" required
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ค่าประกันความเสียหาย</label>
                      <input type="number" x-model="currentCar.ค่าประกันความเสียหาย"
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                    </div>
                  </div>

                  <!-- แถวที่ 4.5: ค่าล่วงเวลาต่อชั่วโมง และค่ามัดจำคิวรถ -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">
                        ค่าล่วงเวลาต่อชั่วโมง
                        <span class="text-xs text-gray-500">(ถ้าไม่ระบุ จะใช้ค่าเริ่มต้นจากการตั้งค่าระบบ)</span>
                      </label>
                      <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">฿</span>
                        <input type="number" x-model="currentCar.ค่าล่วงเวลาต่อชั่วโมง" placeholder="100" min="0"
                          class="w-full pl-8 px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                      </div>
                      <p class="text-xs text-gray-500 mt-1">
                        ค่าใช้จ่ายที่เรียกเก็บเพิ่มเติมสำหรับการคืนรถล่าช้าต่อชั่วโมง
                      </p>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">
                        ค่ามัดจำคิวรถ
                        <span class="text-xs text-gray-500">(จำนวนเงินที่ต้องวางมัดจำเพื่อจองคิวรถ)</span>
                      </label>
                      <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">฿</span>
                        <input type="number" x-model="currentCar.ค่ามัดจำคิวรถ" placeholder="0" min="0"
                          class="w-full pl-8 px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                      </div>
                      <p class="text-xs text-gray-500 mt-1">
                        เงินมัดจำที่ลูกค้าต้องชำระล่วงหน้าเพื่อยืนยันการจองรถ
                      </p>
                    </div>
                  </div>

                  <!-- แถวที่ 5: ชนิดเชื้อเพลิงและพื้นที่การใช้งาน -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div x-show="showFuelTypeField">
                      <label class="block text-sm font-medium text-gray-700 mb-1">ชนิดเชื้อเพลิง</label>
                      <select x-model="currentCar.ชนิดเชื้อเพลิง"
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                        <option value="[FUELTYPE_1]">เบนซิน91</option>
                        <option value="[FUELTYPE_2]">เบนซิน95</option>
                        <option value="[FUELTYPE_3]">เบนซิน</option>
                        <option value="[FUELTYPE_4]">ดีเซล</option>
                      </select>
                    </div>
                    <div>
                      <div class="flex items-center">
                        <label class="block text-sm font-medium text-gray-700 mb-1 mr-1">พื้นที่การใช้งาน</label>
                        <div class="relative">
                          <button @click.prevent="showZoneHelpModal()" type="button"
                            class="text-gray-500 hover:text-blue-500 focus:outline-none">
                            <i class="fas fa-question-circle"></i>
                          </button>
                        </div>
                      </div>
                      <select x-model="currentCar.พื้นที่การใช้งาน" @change="loadZoneDescription()" required
                        class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500">
                        <option value="[ZONE1]">zone1</option>
                        <option value="[ZONE2]">zone2</option>
                        <option value="[ZONE3]">zone3</option>
                        <option value="[ZONE4]">zone4</option>
                      </select>
                    </div>
                  </div>

                  <!-- คำอธิบายโซน -->
                  <div>
                    <p x-show="zoneDescription" x-text="'โซนที่เลือกหมายถึง: ' + zoneDescription"
                      class="mt-1 text-sm text-red-500"></p>
                  </div>

                  <!-- ===== การตั้งค่าคอมมิชชั่น ===== -->
                  <div class="border-t pt-4 sm:pt-6">
                    <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-4 flex items-center">
                      <i class="fas fa-percentage mr-2 text-green-500"></i>
                      การตั้งค่าคอมมิชชั่น
                    </h4>

                    <div class="p-4 bg-green-50 border border-green-200 rounded-xl flex items-start mb-4">
                      <i class="fas fa-lightbulb text-green-500 mr-3 mt-1 flex-shrink-0"></i>
                      <p class="text-sm text-green-600">
                        แนะนำให้เปิดใช้งาน <strong>เฉพาะรถจากพาร์ทเนอร์</strong>
                        เพื่อสะดวกในการจัดการค่าคอมมิชชั่น<br>
                        (สามารถเปิด/ปิดได้อีกครั้งที่ขั้นตอนการสร้างสัญญาเช่า)
                      </p>
                    </div>

                    <div class="flex items-center">
                      <input type="checkbox" id="hasCommission" x-model="currentCar.มีค่าคอมมิชชั่น"
                        class="h-4 w-4 text-blue-600 rounded">
                      <label for="hasCommission" class="ml-2 text-sm text-gray-700">รถคันนี้มีค่าคอมมิชชั่น</label>
                    </div>

                    <div x-show="currentCar.มีค่าคอมมิชชั่น" x-transition class="mt-4">
                      <label class="block text-sm font-medium text-gray-700 mb-2">
                        เลือกประเภทค่าคอมมิชชั่น
                      </label>

                      <template x-if="commissionList.length > 0">
                        <select x-model="currentCar.ค่าคอมมิชชั่นที่เลือก" x-ref="commissionSelector"
                          class="w-full px-3 py-2 sm:py-3 border border-gray-300 rounded-xl text-sm sm:text-base">
                          <template x-for="item in commissionList" :key="item.ชื่อ">
                            <option :value="item.ชื่อ" x-text="item.ชื่อ"></option>
                          </template>
                        </select>
                      </template>

                      <template x-if="commissionList.length === 0">
                        <div class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm">
                          <p class="font-medium text-yellow-700 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            ยังไม่ได้ตั้งค่ารูปแบบค่าคอมมิชชั่น
                          </p>
                        </div>
                      </template>

                      <div x-show="currentCar.ค่าคอมมิชชั่นที่เลือก"
                        class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm">
                        <p class="font-medium text-blue-800">
                          ตัวอย่างการคำนวณ (ค่าเช่า 1,000 บาท/วัน):
                        </p>
                        <p x-html="calculateCommissionExample(1000)"></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer buttons - Sticky -->
          <div
            class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 border-t border-gray-200 flex-shrink-0">
            <button @click="closeCarModal()" type="button"
              class="w-full sm:w-auto px-6 py-3 border border-gray-300 rounded-xl text-gray-700 bg-white hover:bg-gray-50 text-sm sm:text-base focus:outline-none focus:ring-4 focus:ring-gray-100 transition-all duration-200">
              <i class="fas fa-times mr-2"></i>ยกเลิก
            </button>
            <button @click="saveCar()" type="button"
              :class="carEditMode ? 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-100' : 'bg-green-600 hover:bg-green-700 focus:ring-green-100'"
              class="w-full sm:w-auto px-6 py-3 text-white rounded-xl text-sm sm:text-base focus:outline-none focus:ring-4 transition-all duration-200">
              <i :class="carEditMode ? 'fas fa-save' : 'fas fa-plus'" class="mr-2"></i>
              <span x-text="carEditMode ? 'บันทึกการแก้ไข' : 'เพิ่มรถใหม่'"></span>
            </button>
          </div>
        </div>
      </div>
    </div>




















    <!-- Modal คำอธิบายโซน -->
    <!-- Modal คำอธิบายโซน - Enhanced Version -->
    <div x-show="showZoneHelp" class="fixed inset-0 z-50 overflow-y-auto"
      x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" style="display: none;">
      <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true" @click="showZoneHelp = false">
          <div class="absolute inset-0 bg-gray-500 opacity-75 backdrop-blur-sm"></div>
        </div>

        <div
          class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-blue-100"
          x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95"
          x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 transform scale-100"
          x-transition:leave-end="opacity-0 transform scale-95">
          <!-- Header section with gradient background -->
          <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-4 relative">
            <div class="absolute top-3 right-3">
              <button @click="showZoneHelp = false"
                class="text-white hover:text-blue-100 focus:outline-none transition-colors duration-200">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <h3 class="text-xl leading-6 font-medium text-white flex items-center">
              <i class="fas fa-map-marker-alt mr-2"></i>
              <span>คำอธิบายพื้นที่การใช้งาน</span>
            </h3>
          </div>

          <!-- Main content with enhanced styling -->
          <div class="bg-gradient-to-b from-blue-50 to-white px-6 pt-5 pb-6">
            <div class="flex flex-col sm:flex-row sm:items-start">
              <!-- Left side icon with animation -->
              <div class="mx-auto flex-shrink-0 mb-4 sm:mb-0">
                <div
                  class="h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center relative overflow-hidden sm:h-14 sm:w-14 border-2 border-blue-200 shadow-inner">
                  <i class="fas fa-map-marked-alt text-blue-600 text-xl"></i>
                  <!-- Animation rings -->
                  <div class="absolute inset-0 border-4 border-blue-200 rounded-full animate-ping opacity-20"></div>
                </div>
              </div>

              <!-- Right side content -->
              <div class="sm:ml-6 text-center sm:text-left">
                <h3 class="text-lg leading-6 font-semibold text-blue-800">
                  เข้าใจพื้นที่การใช้งานรถ
                </h3>

                <!-- Information cards -->
                <div class="mt-4 space-y-4">
                  <!-- What is zone card -->
                  <div
                    class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500 hover:shadow-md transition-shadow duration-200">
                    <h4 class="font-medium text-blue-600 mb-1 flex items-center">
                      <i class="fas fa-info-circle mr-2"></i>
                      โซนคืออะไร?
                    </h4>
                    <p class="text-sm text-gray-700">
                      โซนที่เลือกหมายถึง<span class="font-medium">พื้นที่ที่อนุญาตให้ใช้รถคันนี้</span>
                      การกำหนดโซนช่วยให้การบริหารจัดการรถมีประสิทธิภาพและปลอดภัยยิ่งขึ้น
                    </p>
                  </div>

                  <!-- How to edit card -->
                  <div
                    class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500 hover:shadow-md transition-shadow duration-200">
                    <h4 class="font-medium text-green-600 mb-1 flex items-center">
                      <i class="fas fa-edit mr-2"></i>
                      วิธีการแก้ไขโซน
                    </h4>
                    <p class="text-sm text-gray-700">
                      ท่านสามารถแก้ไขพื้นที่การใช้งานได้ที่:
                    </p>
                    <div class="mt-1 p-2 bg-gray-50 rounded text-xs font-mono">
                      <ol class="list-decimal list-inside text-gray-600">
                        <li>เมนูตั้งค่าระบบ</li>
                        <li>จัดการแปลภาษาสัญญาเช่า</li>
                        <li>แก้ไขคำแปล</li>
                        <li>เลือก [ZONE1-4] ที่ต้องการแก้ไข</li>
                      </ol>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer with more attractive button -->
          <div class="bg-gray-50 px-6 py-4 flex justify-end border-t border-gray-100">
            <button @click="showZoneHelp = false" type="button"
              class="inline-flex justify-center items-center rounded-md px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-medium text-sm hover:from-blue-700 hover:to-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transform hover:scale-105 transition-all duration-200 shadow-md">
              <i class="fas fa-check mr-2"></i>
              เข้าใจแล้ว
            </button>
          </div>
        </div>
      </div>
    </div>


  </div>



  <div x-show="currentPage === 'finance'" x-cloak class="p-4 space-y-6">

    <!-- Header Dashboard Title -->
    <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4 border-purple-300">
      <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5 bg-purple-300">
        <i class="fas fa-chart-bar text-white text-2xl"></i>
      </div>
      <div>
        <h2 class="text-2xl font-bold text-gray-800">แดชบอร์ดการเงิน</h2>
        <p class="mt-1 text-gray-600">
          <i class="fas fa-chart-line mr-2 text-purple-300"></i>ภาพรวมรายรับ-รายจ่ายของธุรกิจ
        </p>
      </div>
    </div>



    <!-- ฟิลเตอร์และปุ่มเพิ่ม -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex flex-col md:flex-row justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">จัดการข้อมูลการเงิน</h2>
        <button @click="openAddFinanceModal()"
          class="mt-2 md:mt-0 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
          <i class="fas fa-plus mr-2"></i>สร้างรายการใหม่
        </button>
      </div>



      <div class="bg-gray-50 p-4 rounded-lg border mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ค้นหาจาก</label>

            <select x-model="searchFinanceType" class="w-full p-2 border rounded-md">
              <option value="booking_number">หมายเลขการจอง</option>
              <option value="car_name">ชื่อรถ</option>
            </select>




          </div>
          <div class="md:col-span-2 flex items-end gap-2">
            <div class="flex-grow">
              <label class="block text-sm font-medium text-gray-700 mb-1">คำค้นหา</label>

              <!-- แสดง input หรือ dropdown ตามประเภทการค้นหา -->
              <template x-if="searchFinanceType === 'car_name'">
                <select x-model="searchFinanceQuery" class="w-full p-2 border rounded-md">
                  <option value="">-- เลือกรถ --</option>
                  <template x-for="car in cars" :key="car.id">
                    <option :value="car.ยี่ห้อ + ' ' + car.รุ่น + ' (' + car.ทะเบียน + ')'"
                      x-text="car.ยี่ห้อ + ' ' + car.รุ่น + ' (' + car.ทะเบียน + ')'"></option>
                  </template>
                </select>
              </template>

              <template x-if="searchFinanceType !== 'car_name'">
                <input type="text" x-model="searchFinanceQuery" @keyup.enter="searchFinance()"
                  class="w-full p-2 border rounded-md" placeholder="พิมพ์เพื่อค้นหา...">
              </template>
            </div>

            <button @click="searchFinance()"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md flex items-center">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- ตารางข้อมูล -->
      <div class="overflow-x-auto" x-show="financeSearchResults.length > 0">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">วันที่</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">ประเภท</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">รายการ</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">จำนวนเงิน</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">จัดการ</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="item in financeSearchResults" :key="item.id">
              <tr>
                <td class="px-4 py-2 text-sm" x-text="formatDate(item.วันที่)"></td>
                <td class="px-4 py-2 text-sm">
                  <span :class="item.ประเภท === 'รายรับ' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" x-text="item.ประเภท"></span>
                </td>
                <td class="px-4 py-2 text-sm" x-text="item.รายการ"></td>
                <td class="px-4 py-2 text-sm text-right"
                  :class="item.ประเภท === 'รายรับ' ? 'text-green-600' : 'text-red-600'"
                  x-text="formatCurrency(item.จำนวนเงิน)"></td>
                <td class="px-4 py-2 text-center text-sm space-x-2">
                  <button @click="openEditFinanceModal(item)" class="text-blue-600 hover:text-blue-900"><i
                      class="fas fa-edit"></i></button>
                  <button @click="confirmDeleteFinancialRecord(item.id)" class="text-red-600 hover:text-red-900"><i
                      class="fas fa-trash"></i></button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>



    </div>

    <!-- กำลังโหลดข้อมูล -->
    <div x-show="isLoadingFinance" class="animate-pulse">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="h-24 bg-gray-200 rounded-lg"></div>
        <div class="h-24 bg-gray-200 rounded-lg"></div>
        <div class="h-24 bg-gray-200 rounded-lg"></div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="h-80 bg-gray-200 rounded-lg"></div>
        <div class="h-80 bg-gray-200 rounded-lg"></div>
      </div>
    </div>

    <!-- รายงานและกราฟ -->
    <div x-show="!isLoadingFinance">
      <div class="bg-white p-4 rounded-lg shadow-md mb-6 mt-6">
        <div class="flex flex-wrap gap-4 items-center">
          <div class="flex-shrink-0 text-gray-600">
            <i class="fas fa-filter mr-2"></i>ตัวกรองข้อมูล:
          </div>

          <div class="min-w-[120px] flex-1">
            <select x-model="selectedFinanceMonth" @change="loadFinancialData()"
              class="w-full p-2 border border-gray-300 rounded-md">
              <template x-for="month in monthNames" :key="month.value">
                <option :value="month.value" x-text="month.name"></option>
              </template>
            </select>
          </div>

          <div class="min-w-[120px] flex-1">
            <select x-model="selectedFinanceYear" @change="loadFinancialData()"
              class="w-full p-2 border border-gray-300 rounded-md">
              <template x-for="year in availableYears" :key="year">
                <option :value="year" x-text="year"></option>
              </template>
            </select>
          </div>
        </div>
      </div>


      <!-- การ์ดสรุป -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-6 rounded-xl shadow-lg">
          <div class="flex justify-between items-center">
            <p class="text-lg font-semibold">ยอดรายรับ</p>
            <i class="fas fa-arrow-up text-xl opacity-50"></i>
          </div>
          <p class="text-4xl font-bold mt-2" x-text="formatCurrency(financeSummary.totalRevenue)"></p>
        </div>
        <div class="bg-gradient-to-br from-red-400 to-red-600 text-white p-6 rounded-xl shadow-lg">
          <div class="flex justify-between items-center">
            <p class="text-lg font-semibold">ยอดรายจ่าย</p>
            <i class="fas fa-arrow-down text-xl opacity-50"></i>
          </div>
          <p class="text-4xl font-bold mt-2" x-text="formatCurrency(financeSummary.totalExpense)"></p>
        </div>
        <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white p-6 rounded-xl shadow-lg">
          <div class="flex justify-between items-center">
            <p class="text-lg font-semibold">กำไร/ขาดทุนสุทธิ</p>
            <i class="fas fa-balance-scale text-xl opacity-50"></i>
          </div>
          <p class="text-4xl font-bold mt-2" x-text="formatCurrency(financeSummary.netProfit)"></p>
        </div>
      </div>

      <!-- กราฟ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-4 rounded-lg shadow-md">
          <h3 class="font-semibold text-center mb-2 text-gray-700">กราฟเปรียบเทียบ รายรับ vs รายจ่าย</h3>
          <div id="monthlyRevenueExpenseBarChart" class="w-full h-80"></div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-md">
          <h3 class="font-semibold text-center mb-2 text-gray-700">สัดส่วนรายจ่ายตามหมวดหมู่</h3>
          <div id="expenseCategoryChart" class="w-full h-80"></div>
        </div>

      </div>




      <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <h3 class="font-semibold text-center mb-2 text-gray-700">เปรียบเทียบรายรับ-รายจ่าย (รายคัน)</h3>
        <div id="carProfitabilityChart" class="w-full h-80"></div>
      </div>







      <!-- กราฟรายได้ประจำปี -->
      <div class="bg-white rounded-lg shadow-md relative mt-14 mb-6">
        <div class="absolute -top-4 left-8 bg-indigo-600 text-white px-6 py-2 rounded-t-lg font-bold shadow-md">
          สรุปรายได้ประจำปี
        </div>
        <div class="pt-8 pb-5 px-6 mt-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="flex items-center justify-center w-14 h-14 bg-indigo-100 rounded-full shadow-sm mr-5">
                <i class="fas fa-chart-line text-indigo-600 text-2xl"></i>
              </div>
              <div>
                <p class="text-gray-500 mt-1 flex items-center text-lg">
                  <i class="fas fa-info-circle mr-2 text-indigo-500"></i>
                  แนวโน้มรายได้ตลอดทั้งปี
                </p>
                <div class="mt-2 flex space-x-2">
                  <span class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded-full">กราฟ</span>
                  <span class="text-xs px-2 py-1 bg-amber-50 text-amber-600 rounded-full">รายได้</span>
                </div>
              </div>
            </div>
            <div>
              <select x-model="selectedRevenueYear" @change="loadRevenueChart()"
                class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                <template x-for="year in availableYears" :key="year">
                  <option :value="year" x-text="year"></option>
                </template>
              </select>
            </div>
          </div>
        </div>
        <div class="p-6 border-t border-gray-100">
          <div class="w-full h-80" id="revenueChart"></div>
        </div>
      </div>
    </div>
  </div>



  <div x-show="currentPage === 'documents'" x-cloak>
    <div class="mb-6">
      <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4 border-teal-500">
        <div class="flex items-center justify-center w-16 h-16 bg-teal-100 rounded-full shadow-inner mr-5">
          <i class="fas fa-file-invoice-dollar text-teal-600 text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-800">สร้างเอกสาร</h2>
          <p class="mt-1 text-gray-600">สร้างใบเสนอราคา, บิลเงินสด, และใบกำกับภาษี</p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <div class="bg-white p-6 rounded-2xl shadow-lg" data-aos="fade-up">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i
            class="fas fa-file-invoice text-blue-500 mr-3"></i>สร้างใบเสนอราคา</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">ชื่อลูกค้า*</label>
            <input type="text" x-model="quotationFormData.customerName" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">รุ่นรถ</label>
            <input type="text" x-model="quotationFormData.carModel" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">วันที่รับรถ</label>
            <input type="date" x-model="quotationFormData.pickupDate" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">วันที่คืนรถ</label>
            <input type="date" x-model="quotationFormData.returnDate" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">ราคา</label>
            <input type="number" x-model="quotationFormData.price" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <button @click="generateDocument('quotation', quotationFormData)"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4">
            สร้างใบเสนอราคา
          </button>
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-lg" data-aos="fade-up" data-aos-delay="100">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i
            class="fas fa-money-bill-wave text-green-500 mr-3"></i>สร้างบิลเงินสด</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">ชื่อลูกค้า*</label>
            <input type="text" x-model="cashBillFormData.customerName" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">รายการ</label>
            <input type="text" x-model="cashBillFormData.carModel" placeholder="เช่น ค่าเช่ารถ Toyota Yaris"
              class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">จำนวนเงิน</label>
            <input type="number" x-model="cashBillFormData.price" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <button @click="generateDocument('cashBill', cashBillFormData)"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mt-4">
            สร้างบิลเงินสด
          </button>
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-lg" data-aos="fade-up" data-aos-delay="200">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i
            class="fas fa-file-contract text-purple-500 mr-3"></i>สร้างใบกำกับภาษี</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">ชื่อลูกค้า*</label>
            <input type="text" x-model="taxInvoiceFormData.customerName"
              class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">รายการ</label>
            <input type="text" x-model="taxInvoiceFormData.carModel" placeholder="เช่น ค่าเช่ารถ Toyota Yaris"
              class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">จำนวนเงิน</label>
            <input type="number" x-model="taxInvoiceFormData.price" class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <button @click="generateDocument('taxInvoice', taxInvoiceFormData)"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg mt-4">
            สร้างใบกำกับภาษี
          </button>
        </div>
      </div>
    </div>
  </div>


  <div x-show="showAddFinanceModal || showEditFinanceModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4" x-cloak>

    <!-- Backdrop -->
    <div class="absolute inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm" @click="closeFinanceModal()"></div>

    <!-- Modal Content -->
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden"
      x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95 translate-y-4"
      x-transition:enter-end="opacity-100 scale-100 translate-y-0" x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100 scale-100 translate-y-0"
      x-transition:leave-end="opacity-0 scale-95 translate-y-4">

      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-6">
        <div class="flex justify-between items-center">
          <div class="flex items-center space-x-3">
            <div class="bg-white bg-opacity-20 p-3 rounded-xl">
              <i class="fas fa-wallet text-2xl"></i>
            </div>
            <div>
              <h3 class="text-2xl font-semibold" x-text="showEditFinanceModal ? 'แก้ไขรายการ' : 'สร้างรายการใหม่'">
              </h3>
              <p class="text-blue-100 text-sm mt-1">จัดการรายรับรายจ่ายของคุณ</p>
            </div>
          </div>
          <button @click="closeFinanceModal()"
            class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <!-- Body Content -->
      <div class="p-8">
        <!-- Add Finance Form -->
        <div x-show="showAddFinanceModal" class="space-y-6 max-h-[60vh] overflow-y-auto pr-4 custom-scrollbar">

          <!-- Link Section -->
          <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
            <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
              <i class="fas fa-link text-blue-500 mr-2"></i>
              การเชื่อมโยงข้อมูล
            </h4>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">เชื่อมโยงกับ</label>
                <div class="grid grid-cols-3 gap-3">
                  <button @click="newFinancialRecord.linkType = 'booking'"
                    :class="newFinancialRecord.linkType === 'booking' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                    class="p-3 rounded-lg border-2 transition-all duration-200 flex flex-col items-center">
                    <i class="fas fa-calendar-check text-xl mb-1"></i>
                    <span class="text-sm">การจอง</span>
                  </button>
                  <button @click="newFinancialRecord.linkType = 'car'"
                    :class="newFinancialRecord.linkType === 'car' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                    class="p-3 rounded-lg border-2 transition-all duration-200 flex flex-col items-center">
                    <i class="fas fa-car text-xl mb-1"></i>
                    <span class="text-sm">รถ</span>
                  </button>
                  <button @click="newFinancialRecord.linkType = 'none'"
                    :class="newFinancialRecord.linkType === 'none' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                    class="p-3 rounded-lg border-2 transition-all duration-200 flex flex-col items-center">
                    <i class="fas fa-times-circle text-xl mb-1"></i>
                    <span class="text-sm">ไม่เชื่อมโยง</span>
                  </button>
                </div>
              </div>

              <div x-show="newFinancialRecord.linkType === 'booking'"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">
                <label class="block text-sm font-medium text-gray-700 mb-2">หมายเลขการจอง</label>
                <div class="relative">
                  <i class="fas fa-hashtag absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="newFinancialRecord.หมายเลขการจอง" placeholder="เช่น KP00001"
                    class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
              </div>

              <div x-show="newFinancialRecord.linkType === 'car'" x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">
                <label class="block text-sm font-medium text-gray-700 mb-2">เลือกรถ</label>
                <div class="relative">
                  <i class="fas fa-car-side absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <select x-model="newFinancialRecord.รถที่เกี่ยวข้อง"
                    class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all appearance-none">
                    <option value="">-- เลือกรถ --</option>
                    <template x-for="car in cars" :key="car.id">
                      <option :value="car.ยี่ห้อ + ' ' + car.รุ่น + ' (' + car.ทะเบียน + ')'"
                        x-text="car.ยี่ห้อ + ' ' + car.รุ่น + ' (' + car.ทะเบียน + ')'"></option>
                    </template>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Transaction Details Section -->
          <div class="bg-white rounded-xl p-6 border-2 border-gray-200">
            <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
              <i class="fas fa-file-invoice text-green-500 mr-2"></i>
              รายละเอียดรายการ
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Date -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-calendar-alt text-gray-400 mr-1"></i>
                  วันที่
                </label>
                <input type="date" x-model="newFinancialRecord.วันที่"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  required>
              </div>

              <!-- Type -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-exchange-alt text-gray-400 mr-1"></i>
                  ประเภท
                </label>
                <div class="grid grid-cols-2 gap-2">
                  <button @click="newFinancialRecord.ประเภท = 'รายจ่าย'"
                    :class="newFinancialRecord.ประเภท === 'รายจ่าย' ? 'bg-red-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                    class="py-3 px-4 rounded-lg border-2 transition-all duration-200 flex items-center justify-center">
                    <i class="fas fa-minus-circle mr-2"></i>
                    รายจ่าย
                  </button>
                  <button @click="newFinancialRecord.ประเภท = 'รายรับ'"
                    :class="newFinancialRecord.ประเภท === 'รายรับ' ? 'bg-green-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                    class="py-3 px-4 rounded-lg border-2 transition-all duration-200 flex items-center justify-center">
                    <i class="fas fa-plus-circle mr-2"></i>
                    รายรับ
                  </button>
                </div>
              </div>

              <!-- Category -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-tag text-gray-400 mr-1"></i>
                  รายการ
                </label>
                <div class="flex items-center gap-2">
                  <select x-model="newFinancialRecord.รายการ" required
                    class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    <option value="">-- เลือกรายการ --</option>
                    <template x-for="cat in expenseCategories" :key="cat">
                      <option :value="cat" x-text="cat"></option>
                    </template>
                  </select>
                  <button @click.prevent="toggleCategoryManager()"
                    class="p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                    title="จัดการหมวดหมู่รายจ่าย">
                    <i class="fas fa-cog text-gray-600"></i>
                  </button>
                </div>

                <input type="text" x-show="newFinancialRecord.รายการ === 'อื่นๆ'"
                  @input="newFinancialRecord.รายการ = $event.target.value" placeholder="ระบุชื่อรายการ..."
                  class="w-full mt-2 px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              </div>

              <!-- Amount -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-dollar-sign text-gray-400 mr-1"></i>
                  จำนวนเงิน (บาท)
                </label>
                <div class="relative">
                  <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg">฿</span>
                  <input type="number" x-model="newFinancialRecord.จำนวนเงิน" required
                    class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-lg font-medium">
                </div>
              </div>
            </div>
          </div>

          <!-- Category Manager -->
          <div x-show="showCategoryManager" x-transition class="bg-yellow-50 rounded-xl p-6 border-2 border-yellow-200">
            <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
              <i class="fas fa-folder-plus text-yellow-600 mr-2"></i>
              จัดการหมวดหมู่รายจ่าย
            </h4>

            <div class="space-y-2 mb-4 max-h-40 overflow-y-auto custom-scrollbar pr-2">
              <template x-for="(cat, index) in expenseCategories" :key="index">
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                  <span x-text="cat" class="text-sm font-medium"></span>
                  <button @click.prevent="removeExpenseCategory(index)"
                    class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </template>
            </div>

            <div class="flex gap-2 mb-3">
              <input type="text" x-model="newCategoryName" @keyup.enter="addExpenseCategory()"
                placeholder="เพิ่มหมวดหมู่ใหม่..."
                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
              <button @click.prevent="addExpenseCategory()"
                class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition-colors">
                <i class="fas fa-plus mr-1"></i>เพิ่ม
              </button>
            </div>

            <div class="text-right">
              <button @click.prevent="saveExpenseCategories()"
                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">
                <i class="fas fa-save mr-2"></i>บันทึกการตั้งค่า
              </button>
            </div>
          </div>
        </div>

        <!-- Edit Finance Form -->
        <div x-show="showEditFinanceModal" class="space-y-6">
          <div class="bg-white rounded-xl p-6 border-2 border-gray-200">
            <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
              <i class="fas fa-edit text-purple-500 mr-2"></i>
              แก้ไขรายละเอียด
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Type -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-exchange-alt text-gray-400 mr-1"></i>
                  ประเภท
                </label>
                <div class="grid grid-cols-2 gap-2">
                  <button @click="editingFinancialRecord.ประเภท = 'รายจ่าย'"
                    :class="editingFinancialRecord.ประเภท === 'รายจ่าย' ? 'bg-red-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                    class="py-3 px-4 rounded-lg border-2 transition-all duration-200 flex items-center justify-center">
                    <i class="fas fa-minus-circle mr-2"></i>
                    รายจ่าย
                  </button>
                  <button @click="editingFinancialRecord.ประเภท = 'รายรับ'"
                    :class="editingFinancialRecord.ประเภท === 'รายรับ' ? 'bg-green-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                    class="py-3 px-4 rounded-lg border-2 transition-all duration-200 flex items-center justify-center">
                    <i class="fas fa-plus-circle mr-2"></i>
                    รายรับ
                  </button>
                </div>
              </div>

              <!-- Date -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-calendar-alt text-gray-400 mr-1"></i>
                  วันที่
                </label>
                <input type="date" x-model="editingFinancialRecord.วันที่" required
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
              </div>

              <!-- Category -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-tag text-gray-400 mr-1"></i>
                  รายการ
                </label>
                <input type="text" x-model="editingFinancialRecord.รายการ" required
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
              </div>

              <!-- Amount -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-dollar-sign text-gray-400 mr-1"></i>
                  จำนวนเงิน (บาท)
                </label>
                <div class="relative">
                  <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg">฿</span>
                  <input type="number" x-model="editingFinancialRecord.จำนวนเงิน" required
                    class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all text-lg font-medium">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="px-8 py-6 bg-gray-50 border-t border-gray-200">
        <div class="flex justify-end space-x-3">
          <button @click="closeFinanceModal()"
            class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">
            <i class="fas fa-times mr-2"></i>ยกเลิก
          </button>

          <button x-show="showAddFinanceModal" :disabled="isLoading" @click="saveNewFinancialRecord()"
            class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
            <template x-if="isLoading">
              <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 11-8 8z"></path>
              </svg>
            </template>
            <i x-show="!isLoading" class="fas fa-save mr-2"></i>
            <span x-text="isLoading ? 'กำลังบันทึก...' : 'บันทึกรายการ'"></span>
          </button>

          <button x-show="showEditFinanceModal" :disabled="isLoading" @click="updateFinancialRecord()"
            class="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
            <template x-if="isLoading">
              <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 11-8 8z"></path>
              </svg>
            </template>
            <i x-show="!isLoading" class="fas fa-check mr-2"></i>
            <span x-text="isLoading ? 'กำลังอัปเดต...' : 'อัปเดตรายการ'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>





  <!-- หน้าคู่มือการใช้งาน -->

  <div x-show="currentPage === 'manual'" x-cloak x-data="{ 
    activeSection: 'overview',
    openFaq: null,
    
    scrollToSection(sectionId) {
        document.getElementById(sectionId).scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
        this.activeSection = sectionId;
    }
}">



    <!-- Manual Navigation -->
    <nav class="bg-gradient-to-r from-blue-700 to-blue-500 text-white shadow-lg rounded-lg mb-8">
      <div class="px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo & Title -->
          <div class="flex items-center space-x-3">
            <i class="fas fa-book text-2xl"></i>
            <div>
              <h1 class="text-xl font-bold">คู่มือการใช้งาน</h1>
              <p class="text-sm text-blue-200">ระบบจัดการรถเช่า</p>
            </div>
          </div>

          <!-- Quick Navigation -->
          <div class="hidden md:flex items-center space-x-2">
            <button @click="scrollToSection('overview')"
              :class="activeSection === 'overview' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-home mr-1"></i>ภาพรวม
            </button>
            <button @click="scrollToSection('search')"
              :class="activeSection === 'search' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-search mr-1"></i>ค้นหา
            </button>
            <button @click="scrollToSection('new-rental')"
              :class="activeSection === 'new-rental' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-plus mr-1"></i>เช่าใหม่
            </button>
            <button @click="scrollToSection('schedule')"
              :class="activeSection === 'schedule' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-calendar mr-1"></i>ตาราง
            </button>
            <button @click="scrollToSection('cars')"
              :class="activeSection === 'cars' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-car mr-1"></i>จัดการรถ
            </button>
            <button @click="scrollToSection('reports')"
              :class="activeSection === 'reports' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-chart-bar mr-1"></i>รายงาน
            </button>
            <button @click="scrollToSection('settings')"
              :class="activeSection === 'settings' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-cog mr-1"></i>ตั้งค่า
            </button>
            <button @click="scrollToSection('faq')"
              :class="activeSection === 'faq' ? 'bg-white/20' : 'bg-white/10 hover:bg-white/20'"
              class="px-3 py-2 rounded-lg transition-colors text-sm">
              <i class="fas fa-question-circle mr-1"></i>FAQ
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="space-y-16">

      <!-- Overview Section -->
      <section id="overview" class="scroll-mt-20">
        <div class="text-center mb-12">
          <h1 class="text-4xl font-bold text-gray-900 mb-4">
            คู่มือการใช้งานระบบจัดการรถเช่า
          </h1>
          <p class="text-xl text-gray-600 max-w-3xl mx-auto">
            คู่มือฉบับสมบูรณ์สำหรับการใช้งานระบบจัดการร้านเช่ารถด้วย Google Apps Scripts
          </p>

          <!-- รูปภาพหลัก -->
          <div class="mt-8 mb-8">
            <div class="image-placeholder rounded-xl h-64 flex items-center justify-center mx-auto max-w-4xl">
              <div class="text-center text-gray-500">
                <i class="fas fa-image text-4xl mb-2"></i>
                <p class="font-semibold">รูปที่ 1: ภาพหน้าจอหลักของระบบ</p>
                <p class="text-sm">แสดงภาพรวมของหน้าจอหลักพร้อมเมนูและฟีเจอร์ต่างๆ</p>
              </div>
            </div>
          </div>

          <!-- Quick Access Buttons -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
            <button @click="scrollToSection('search')"
              class="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-search text-2xl mb-2"></i>
              <div class="font-semibold">ค้นหาข้อมูล</div>
            </button>
            <button @click="scrollToSection('new-rental')"
              class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-plus-circle text-2xl mb-2"></i>
              <div class="font-semibold">เช่าใหม่</div>
            </button>
            <button @click="scrollToSection('schedule')"
              class="bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-calendar-alt text-2xl mb-2"></i>
              <div class="font-semibold">ตารางรับส่ง</div>
            </button>
            <button @click="scrollToSection('cars')"
              class="bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-car text-2xl mb-2"></i>
              <div class="font-semibold">จัดการรถ</div>
            </button>
            <button @click="scrollToSection('reports')"
              class="bg-gradient-to-br from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-chart-bar text-2xl mb-2"></i>
              <div class="font-semibold">รายงาน</div>
            </button>
            <button @click="scrollToSection('settings')"
              class="bg-gradient-to-br from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-cog text-2xl mb-2"></i>
              <div class="font-semibold">ตั้งค่า</div>
            </button>
            <button @click="scrollToSection('faq')"
              class="bg-gradient-to-br from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-question-circle text-2xl mb-2"></i>
              <div class="font-semibold">คำถามที่พบบ่อย</div>
            </button>
            <button @click="scrollToSection('contact')"
              class="bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-4 rounded-xl text-center transition-all hover-scale shadow-lg">
              <i class="fas fa-headset text-2xl mb-2"></i>
              <div class="font-semibold">ติดต่อ</div>
            </button>
          </div>
        </div>

        <!-- System Features -->
        <div class="grid md:grid-cols-3 gap-8">
          <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
            <div class="gradient-bg-1 w-12 h-12 rounded-full flex items-center justify-center mb-4">
              <i class="fas fa-tachometer-alt text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">ระบบครบครัน</h3>
            <p class="text-gray-600">
              จัดการรถเช่าตั้งแต่การจองจนถึงการคืนรถ พร้อมระบบรายงานและการเงินแบบครบวงจร
            </p>
          </div>

          <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
            <div class="gradient-bg-2 w-12 h-12 rounded-full flex items-center justify-center mb-4">
              <i class="fas fa-cloud text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">บนระบบคลาวด์</h3>
            <p class="text-gray-600">
              ใช้งานผ่าน Google Apps Scripts เข้าถึงได้ทุกที่ทุกเวลา ข้อมูลปลอดภัยบน Google Drive
            </p>
          </div>

          <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
            <div class="gradient-bg-3 w-12 h-12 rounded-full flex items-center justify-center mb-4">
              <i class="fas fa-mobile-alt text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">รองรับทุกอุปกรณ์</h3>
            <p class="text-gray-600">
              ใช้งานได้ทั้งคอมพิวเตอร์ แท็บเล็ต และมือถือ ออกแบบให้ใช้งานง่ายในทุกสถานการณ์
            </p>
          </div>
        </div>
      </section>

      <!-- Search Section -->
      <section id="search" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="flex items-center mb-6">
              <div class="gradient-bg-1 w-16 h-16 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-search text-white text-2xl"></i>
              </div>
              <div>
                <h2 class="text-3xl font-bold text-gray-900">หน้าค้นหาข้อมูล</h2>
                <p class="text-gray-600 mt-2">ค้นหาข้อมูลการจอง ลูกค้า และรถว่าง</p>
              </div>
            </div>




            <!-- Function Overview -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
              <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                <h3 class="text-lg font-bold text-blue-900 mb-3">
                  <i class="fas fa-bookmark mr-2"></i>ค้นหาข้อมูลเดิม
                </h3>
                <ul class="text-blue-800 space-y-2">
                  <li><i class="fas fa-check mr-2"></i>ค้นหาการจองด้วยหมายเลข</li>
                  <li><i class="fas fa-check mr-2"></i>ค้นหาลูกค้าด้วยชื่อหรือเบอร์</li>
                  <li><i class="fas fa-check mr-2"></i>แก้ไขและลบข้อมูล</li>
                  <li><i class="fas fa-check mr-2"></i>ดูประวัติการเช่า</li>
                </ul>
              </div>

              <div class="bg-green-50 p-6 rounded-lg border-l-4 border-green-500">
                <h3 class="text-lg font-bold text-green-900 mb-3">
                  <i class="fas fa-car mr-2"></i>ค้นหารถว่าง
                </h3>
                <ul class="text-green-800 space-y-2">
                  <li><i class="fas fa-check mr-2"></i>กำหนดวันเวลารับส่ง</li>
                  <li><i class="fas fa-check mr-2"></i>กรองตามยี่ห้อและรุ่น</li>
                  <li><i class="fas fa-check mr-2"></i>เลือกจากรถที่ว่าง</li>
                  <li><i class="fas fa-check mr-2"></i>ดูรายละเอียดรถ</li>
                </ul>
              </div>
            </div>

            <!-- Step-by-step Guide -->
            <div class="space-y-8">
              <h3 class="text-2xl font-bold text-gray-900">ขั้นตอนการใช้งาน</h3>

              <!-- Step 1: Search Booking -->
              <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    1</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">ค้นหาข้อมูลการจอง</h4>
                    <p class="text-gray-600 mb-4">ใช้สำหรับค้นหาข้อมูลการจองที่มีอยู่แล้ว เพื่อดู แก้ไข หรือลบ</p>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 2: หน้าจอค้นหาข้อมูล</p>
                        <p class="text-sm">แสดงช่องค้นหาและตัวกรองต่างๆ</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>กรอกข้อมูลในช่องค้นหา: หมายเลขการจอง, ชื่อลูกค้า หรือเบอร์โทรศัพท์</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>เลือกช่วงวันที่หากต้องการ (ไม่บังคับ)</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>กดปุ่ม "ค้นหา" เพื่อแสดงผลลัพธ์</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>คลิกที่ไอคอน <i class="fas fa-edit text-blue-500 mx-1"></i> เพื่อแก้ไข หรือ <i
                            class="fas fa-trash text-red-500 mx-1"></i> เพื่อลบ</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Search Available Cars -->
              <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    2</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">ค้นหารถว่าง</h4>
                    <p class="text-gray-600 mb-4">ตรวจสอบรถที่พร้อมให้เช่าในช่วงเวลาที่ต้องการ</p>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 3: การค้นหารถว่าง</p>
                        <p class="text-sm">แสดงฟอร์มเลือกวันเวลาและผลลัพธ์รถที่ว่าง</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>เลือกวันที่และเวลารับรถ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>เลือกวันที่และเวลาคืนรถ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>กดปุ่ม "ค้นหารถว่าง"</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>ใช้ตัวกรองยี่ห้อและรุ่นเพื่อลดตัวเลือก</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>เลือกรถที่ต้องการและกดปุ่ม "เลือกรถคันนี้"</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tips Section -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 mt-8">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <i class="fas fa-lightbulb text-yellow-400 text-xl"></i>
                </div>
                <div class="ml-3">
                  <h3 class="text-lg font-medium text-yellow-800">เคล็ดลับการใช้งาน</h3>
                  <div class="mt-2 text-yellow-700">
                    <ul class="list-disc list-inside space-y-1">
                      <li>ใช้การค้นหาขั้นสูงเพื่อกรองข้อมูลได้ละเอียดขึ้น</li>
                      <li>สามารถค้นหาด้วยชื่อลูกค้าหรือเบอร์โทรศัพท์แค่บางส่วนได้</li>
                      <li>ตรวจสอบสถานะการเช่าด้วยสีที่แสดงในผลลัพธ์</li>
                      <li>ใช้ปุ่มลัดเพื่อเข้าถึงฟังก์ชันต่างๆ ได้เร็วขึ้น</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- New Rental Section -->
      <section id="new-rental" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="flex items-center mb-6">
              <div class="gradient-bg-2 w-16 h-16 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-plus-circle text-white text-2xl"></i>
              </div>
              <div class="flex-1">
                <h2 class="text-3xl font-bold text-gray-900">หน้าสร้างรายการเช่าใหม่</h2>
                <p class="text-gray-600 mt-2">สร้างรายการจองและสัญญาเช่ารถใหม่</p>
              </div>
              <div class="ml-4">
                <button @click="scrollToSection('search')"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                  <i class="fas fa-question-circle mr-2"></i>วิธีค้นหารถว่าง
                </button>
              </div>
            </div>

            <!-- Process Overview -->
            <div class="grid md:grid-cols-4 gap-4 mb-8">
              <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                  <i class="fas fa-user-plus text-blue-600"></i>
                </div>
                <h3 class="font-bold text-blue-900">ข้อมูลลูกค้า</h3>
                <p class="text-sm text-blue-700 mt-1">กรอกชื่อและเบอร์ติดต่อ</p>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                  <i class="fas fa-car text-green-600"></i>
                </div>
                <h3 class="font-bold text-green-900">เลือกรถ</h3>
                <p class="text-sm text-green-700 mt-1">เลือกรถและกำหนดเวลา</p>
              </div>
              <div class="text-center p-4 bg-yellow-50 rounded-lg">
                <div class="bg-yellow-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                  <i class="fas fa-money-bill-wave text-yellow-600"></i>
                </div>
                <h3 class="font-bold text-yellow-900">ข้อมูลราคา</h3>
                <p class="text-sm text-yellow-700 mt-1">กำหนดราคาและค่าใช้จ่าย</p>
              </div>
              <div class="text-center p-4 bg-purple-50 rounded-lg">
                <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                  <i class="fas fa-file-contract text-purple-600"></i>
                </div>
                <h3 class="font-bold text-purple-900">สร้างสัญญา</h3>
                <p class="text-sm text-purple-700 mt-1">สร้างสัญญาเช่าอัตโนมัติ</p>
              </div>
            </div>

            <!-- Detailed Steps -->
            <div class="space-y-8">
              <h3 class="text-2xl font-bold text-gray-900">ขั้นตอนการสร้างรายการเช่าใหม่</h3>

              <!-- Step 1: Customer Info -->
              <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    1</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">กรอกข้อมูลลูกค้า</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 4: ฟอร์มข้อมูลลูกค้า</p>
                        <p class="text-sm">แสดงส่วนกรอกข้อมูลลูกค้าและช่องทางการจอง</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span><strong>ช่องทางการจอง:</strong> เลือกว่าลูกค้าจองผ่านช่องทางไหน (เช่น Walk-in, โทรศัพท์,
                          LINE)</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span><strong>หมายเลขการจอง:</strong> สร้างอัตโนมัติหรือกรอกเอง</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span><strong>ชื่อลูกค้า:</strong> กรอกชื่อ-นามสกุลของลูกค้า</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span><strong>เบอร์โทรศัพท์:</strong> กรอกหมายเลขติดต่อ</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Car Selection -->
              <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    2</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">เลือกรถและกำหนดเวลา</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 5: ส่วนเลือกรถและกำหนดเวลา</p>
                        <p class="text-sm">แสดง dropdown เลือกรถและช่องกำหนดวันเวลา</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span><strong>เลือกรถ:</strong> เลือกจาก dropdown ที่แสดงรถที่พร้อมให้เช่า</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span><strong>วันที่เช่า:</strong> เลือกวันที่รับรถ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span><strong>เวลารับรถ:</strong> กำหนดเวลารับรถ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span><strong>วันที่คืน:</strong> เลือกวันที่คืนรถ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span><strong>เวลาคืนรถ:</strong> กำหนดเวลาคืนรถ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span><strong>สถานที่รับ-ส่ง:</strong> ระบุสถานที่รับและคืนรถ</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 3: Pricing -->
              <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-yellow-100 text-yellow-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    3</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">กำหนดราคาและค่าใช้จ่าย</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 6: ส่วนข้อมูลการชำระเงิน</p>
                        <p class="text-sm">แสดงช่องกรอกราคาและค่าใช้จ่ายต่างๆ</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span><strong>ราคาต่อวัน:</strong> กำหนดค่าเช่าต่อวัน</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span><strong>ค่าเช่ารวม:</strong> จะคำนวณอัตโนมัติจากจำนวนวัน</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span><strong>ค่ามัดจำคิวรถ:</strong> เงินจองล่วงหน้า</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span><strong>เงินประกันความเสียหาย:</strong> เงินประกันรถ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span><strong>ค่าบริการเพิ่มเติม:</strong> ค่าใช้จ่ายอื่นๆ (ถ้ามี)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 4: Contract -->
              <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    4</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">สร้างสัญญาเช่า</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 7: ส่วนตั้งค่าสัญญาเช่า</p>
                        <p class="text-sm">แสดงตัวเลือกสร้างสัญญาและเลือกภาษา</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span><strong>สร้างสัญญาเช่า:</strong> เลือกว่าต้องการสร้างสัญญาหรือไม่</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span><strong>ภาษาสัญญา:</strong> เลือกภาษาไทยหรือภาษาอังกฤษ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span><strong>บันทึกข้อมูล:</strong> กดปุ่ม "สร้างรายการเช่า" เพื่อบันทึก</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span><strong>ดาวน์โหลดสัญญา:</strong> ระบบจะสร้างและส่งลิงก์สัญญาให้อัตโนมัติ</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Important Notes -->
            <div class="bg-red-50 border-l-4 border-red-400 p-6 mt-8">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
                </div>
                <div class="ml-3">
                  <h3 class="text-lg font-medium text-red-800">ข้อควรระวัง</h3>
                  <div class="mt-2 text-red-700">
                    <ul class="list-disc list-inside space-y-1">
                      <li>ตรวจสอบความถูกต้องของข้อมูลก่อนกดบันทึก</li>
                      <li>หากรถไม่ปรากฏในรายการ อาจเป็นเพราะมีการจองในช่วงเวลานั้นแล้ว</li>
                      <li>สัญญาเช่าจะถูกสร้างเป็น PDF และบันทึกใน Google Drive อัตโนมัติ</li>
                      <li>หากต้องการแก้ไขหลังบันทึก ให้ใช้ฟังก์ชันค้นหาและแก้ไขข้อมูล</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Schedule Section -->
      <section id="schedule" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="flex items-center mb-6">
              <div class="gradient-bg-3 w-16 h-16 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-calendar-alt text-white text-2xl"></i>
              </div>
              <div>
                <h2 class="text-3xl font-bold text-gray-900">ตารางรับส่งรถ</h2>
                <p class="text-gray-600 mt-2">จัดการตารางรับส่งรถประจำวันและรายเดือน</p>
              </div>
            </div>

            <!-- Features Overview -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
              <div class="bg-blue-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-blue-900 mb-3">
                  <i class="fas fa-calendar-day mr-2"></i>ตารางรายวัน
                </h3>
                <p class="text-blue-800">ดูการรับส่งรถในวันที่เลือก พร้อมรายละเอียดเวลาและสถานที่</p>
              </div>

              <div class="bg-green-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-green-900 mb-3">
                  <i class="fas fa-calendar mr-2"></i>ตารางรายเดือน
                </h3>
                <p class="text-green-800">ดูภาพรวมการรับส่งรถทั้งเดือน สร้าง PDF เพื่อพิมพ์ได้</p>
              </div>

              <div class="bg-purple-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-purple-900 mb-3">
                  <i class="fas fa-file-pdf mr-2"></i>ส่งออก PDF
                </h3>
                <p class="text-purple-800">สร้างตารางเป็น PDF เพื่อพิมพ์หรือแชร์ให้พนักงาน</p>
              </div>
            </div>

            <!-- รูปภาพประกอบ -->
            <div class="image-placeholder rounded-lg h-64 flex items-center justify-center mb-8">
              <div class="text-center text-gray-500">
                <i class="fas fa-image text-4xl mb-2"></i>
                <p class="font-semibold">รูปที่ 8: ตารางรับส่งรถ</p>
                <p class="text-sm">แสดงตารางรายวันและรายเดือน พร้อมปุ่มสร้าง PDF</p>
              </div>
            </div>

            <!-- Status Colors -->
            <div class="bg-gray-50 p-6 rounded-lg">
              <h3 class="text-lg font-bold text-gray-900 mb-4">สีแสดงสถานะในตาราง</h3>
              <div class="grid md:grid-cols-2 gap-4">
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 bg-green-200 rounded"></div>
                  <span class="text-green-800 font-medium">สีเขียว:</span>
                  <span class="text-gray-600">กำลังใช้งาน</span>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 bg-blue-200 rounded"></div>
                  <span class="text-blue-800 font-medium">สีน้ำเงิน:</span>
                  <span class="text-gray-600">กำลังจะมาถึง</span>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 bg-gray-200 rounded"></div>
                  <span class="text-gray-800 font-medium">สีเทา:</span>
                  <span class="text-gray-600">เสร็จสิ้นแล้ว</span>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 bg-red-200 rounded"></div>
                  <span class="text-red-800 font-medium">สีแดง:</span>
                  <span class="text-gray-600">ยกเลิก/มีปัญหา</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Cars Management Section -->
      <section id="cars" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="flex items-center mb-6">
              <div class="gradient-bg-4 w-16 h-16 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-car text-white text-2xl"></i>
              </div>
              <div>
                <h2 class="text-3xl font-bold text-gray-900">จัดการรถยนต์</h2>
                <p class="text-gray-600 mt-2">เพิ่ม แก้ไข และจัดการข้อมูลรถในระบบ</p>
              </div>
            </div>

            <!-- Functions Overview -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
              <div class="bg-blue-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-blue-900 mb-3">
                  <i class="fas fa-plus mr-2"></i>เพิ่มรถใหม่
                </h3>
                <p class="text-blue-800">เพิ่มรถใหม่เข้าสู่ระบบ พร้อมข้อมูลรายละเอียดครบถ้วน</p>
              </div>

              <div class="bg-green-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-green-900 mb-3">
                  <i class="fas fa-edit mr-2"></i>แก้ไขข้อมูล
                </h3>
                <p class="text-green-800">แก้ไขข้อมูลรถ เปลี่ยนสถานะ หรืออัพเดตราคา</p>
              </div>

              <div class="bg-orange-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-orange-900 mb-3">
                  <i class="fas fa-tools mr-2"></i>จัดการสถานะ
                </h3>
                <p class="text-orange-800">เปลี่ยนสถานะรถ เช่น พร้อมให้เช่า, ซ่อมบำรุง, ไม่พร้อมใช้</p>
              </div>
            </div>

            <!-- รูปภาพประกอบ -->
            <div class="image-placeholder rounded-lg h-64 flex items-center justify-center mb-8">
              <div class="text-center text-gray-500">
                <i class="fas fa-image text-4xl mb-2"></i>
                <p class="font-semibold">รูปที่ 9: หน้าจัดการรถยนต์</p>
                <p class="text-sm">แสดงฟอร์มเพิ่มรถใหม่และรายการรถที่มีอยู่</p>
              </div>
            </div>

            <!-- Status Explanation -->
            <div class="bg-gray-50 p-6 rounded-lg">
              <h3 class="text-lg font-bold text-gray-900 mb-4">คำอธิบายสถานะรถ</h3>
              <div class="grid md:grid-cols-3 gap-4">
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 bg-green-500 rounded"></div>
                  <div>
                    <span class="text-green-800 font-medium">พร้อมให้เช่า:</span>
                    <p class="text-gray-600 text-sm">รถพร้อมใช้งานและให้เช่าได้</p>
                  </div>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                  <div>
                    <span class="text-yellow-800 font-medium">ซ่อมบำรุง:</span>
                    <p class="text-gray-600 text-sm">อยู่ระหว่างการซ่อมหรือบำรุงรักษา</p>
                  </div>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 bg-red-500 rounded"></div>
                  <div>
                    <span class="text-red-800 font-medium">ไม่พร้อมใช้:</span>
                    <p class="text-gray-600 text-sm">ไม่สามารถให้เช่าได้ชั่วคราว</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Reports Section -->
      <section id="reports" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="flex items-center mb-6">
              <div class="gradient-bg-6 w-16 h-16 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-chart-bar text-white text-2xl"></i>
              </div>
              <div>
                <h2 class="text-3xl font-bold text-gray-900">รายงานและการเงิน</h2>
                <p class="text-gray-600 mt-2">ดูรายงานรายได้ สถิติการเช่า และข้อมูลทางการเงิน</p>
              </div>
            </div>

            <!-- Report Types -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
              <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                <h3 class="text-lg font-bold text-blue-900 mb-3">
                  <i class="fas fa-chart-line mr-2"></i>รายงานรายได้
                </h3>
                <ul class="text-blue-800 space-y-2">
                  <li><i class="fas fa-check mr-2"></i>รายได้รายเดือน/รายปี</li>
                  <li><i class="fas fa-check mr-2"></i>กราฟแสดงแนวโน้ม</li>
                  <li><i class="fas fa-check mr-2"></i>เปรียบเทียบรายได้ต่างปี</li>
                </ul>
              </div>

              <div class="bg-green-50 p-6 rounded-lg border-l-4 border-green-500">
                <h3 class="text-lg font-bold text-green-900 mb-3">
                  <i class="fas fa-car mr-2"></i>สถิติการเช่า
                </h3>
                <ul class="text-green-800 space-y-2">
                  <li><i class="fas fa-check mr-2"></i>จำนวนการเช่าต่อเดือน</li>
                  <li><i class="fas fa-check mr-2"></i>รถที่ได้รับความนิยม</li>
                  <li><i class="fas fa-check mr-2"></i>อัตราการใช้งานรถ</li>
                </ul>
              </div>
            </div>

            <!-- Step-by-step Guide -->
            <div class="space-y-8">
              <h3 class="text-2xl font-bold text-gray-900">วิธีดูรายงาน</h3>

              <!-- Revenue Report -->
              <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    1</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">ดูรายงานรายได้</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 10: หน้ารายงานรายได้</p>
                        <p class="text-sm">แสดงกราฟรายได้และสถิติต่างๆ</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>เข้าหน้า "รายงาน" จากเมนูหลัก</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>เลือกปีที่ต้องการดูรายงาน</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>ดูกราฟรายได้แต่ละเดือน</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>เปรียบเทียบกับปีก่อนหน้า</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Summary -->
              <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    2</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">สรุปข้อมูลรายเดือน</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 11: สรุปข้อมูลรายเดือน</p>
                        <p class="text-sm">แสดงสถิติและตัวเลขสำคัญในแต่ละเดือน</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>เลือกเดือนที่ต้องการดูสรุป</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>ดูจำนวนการจองทั้งหมด</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>ดูรายได้รวมและค่าเฉลี่ย</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>ดูอัตราการใช้งานรถแต่ละคัน</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Important Notes -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-6 mt-8">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <i class="fas fa-info-circle text-blue-400 text-xl"></i>
                </div>
                <div class="ml-3">
                  <h3 class="text-lg font-medium text-blue-800">หมายเหตุสำคัญ</h3>
                  <div class="mt-2 text-blue-700">
                    <ul class="list-disc list-inside space-y-1">
                      <li>ข้อมูลรายงานจะอัพเดตแบบเรียลไทม์เมื่อมีการเปลี่ยนแปลงข้อมูล</li>
                      <li>สามารถส่งออกรายงานเป็น PDF สำหรับการนำเสนอได้</li>
                      <li>กราฟรายได้จะแสดงเฉพาะรายการที่มีสถานะ "เสร็จสิ้น"</li>
                      <li>ข้อมูลจะถูกบันทึกใน Google Sheets โดยอัตโนมัติ</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings Section -->
      <section id="settings" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="flex items-center mb-6">
              <div class="gradient-bg-7 w-16 h-16 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-cog text-white text-2xl"></i>
              </div>
              <div>
                <h2 class="text-3xl font-bold text-gray-900">การตั้งค่าระบบ</h2>
                <p class="text-gray-600 mt-2">ปรับแต่งการทำงานของระบบและข้อมูลร้าน</p>
              </div>
            </div>

            <!-- Settings Categories -->
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
              <div class="bg-blue-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-blue-900 mb-3">
                  <i class="fas fa-store mr-2"></i>ข้อมูลร้าน
                </h3>
                <p class="text-blue-800 text-sm">ชื่อร้าน ที่อยู่ เบอร์ติดต่อ และโลโก้</p>
              </div>

              <div class="bg-green-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-green-900 mb-3">
                  <i class="fas fa-file-contract mr-2"></i>สัญญาเช่า
                </h3>
                <p class="text-green-800 text-sm">แก้ไขเทมเพลตสัญญาและข้อกำหนด</p>
              </div>

              <div class="bg-purple-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-purple-900 mb-3">
                  <i class="fas fa-users mr-2"></i>ผู้ใช้งาน
                </h3>
                <p class="text-purple-800 text-sm">จัดการบัญชีผู้ใช้และสิทธิ์การเข้าถึง</p>
              </div>

              <div class="bg-yellow-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-yellow-900 mb-3">
                  <i class="fas fa-money-bill mr-2"></i>การเงิน
                </h3>
                <p class="text-yellow-800 text-sm">ตั้งค่าราคาเริ่มต้นและค่าธรรมเนียม</p>
              </div>

              <div class="bg-red-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-red-900 mb-3">
                  <i class="fas fa-map-marker-alt mr-2"></i>สถานที่
                </h3>
                <p class="text-red-800 text-sm">จัดการรายการสถานที่รับส่งรถ</p>
              </div>

              <div class="bg-indigo-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-indigo-900 mb-3">
                  <i class="fas fa-backup mr-2"></i>การสำรอง
                </h3>
                <p class="text-indigo-800 text-sm">สำรองข้อมูลและการกู้คืน</p>
              </div>
            </div>

            <!-- Step-by-step Guide -->
            <div class="space-y-8">
              <h3 class="text-2xl font-bold text-gray-900">คู่มือการตั้งค่า</h3>

              <!-- Shop Info -->
              <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    1</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">ตั้งค่าข้อมูลร้าน</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 12: หน้าตั้งค่าข้อมูลร้าน</p>
                        <p class="text-sm">แสดงฟอร์มกรอกข้อมูลร้านและอัพโหลดโลโก้</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>กรอกชื่อบริษัท/ร้าน</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>กรอกที่อยู่ เบอร์โทรศัพท์ และอีเมล</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>อัพโหลดโลโก้ร้าน (ไฟล์ .jpg, .png)</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>กรอกข้อมูลบัญชีธนาคารสำหรับการโอนเงิน</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-blue-500"></i>
                        <span>บันทึกการตั้งค่า</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Contract Settings -->
              <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    2</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">ตั้งค่าสัญญาเช่า</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 13: หน้าจัดการเทมเพลตสัญญา</p>
                        <p class="text-sm">แสดงการแก้ไขเทมเพลตสัญญาและข้อกำหนด</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>แก้ไขเทมเพลตสัญญาภาษาไทยและอังกฤษ</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>กำหนดข้อกำหนดและเงื่อนไขการเช่า</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>ตั้งค่าตัวแปรที่ใช้ในสัญญา เช่น {{ชื่อลูกค้า}}, {{รถ}}</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-green-500"></i>
                        <span>ทดสอบการสร้างสัญญาตัวอย่าง</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- User Management -->
              <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    3</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">จัดการผู้ใช้งาน</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 14: หน้าจัดการผู้ใช้งาน</p>
                        <p class="text-sm">แสดงรายการผู้ใช้และการกำหนดสิทธิ์</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span>เพิ่มผู้ใช้งานใหม่ด้วยอีเมล Gmail</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span>กำหนดสิทธิ์การเข้าถึงแต่ละหน้า</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span>สร้างกลุ่มผู้ใช้ตามบทบาท (เช่น พนักงาน, ผู้จัดการ)</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-purple-500"></i>
                        <span>ลบหรือระงับผู้ใช้ที่ไม่ต้องการ</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Financial Settings -->
              <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-start space-x-4">
                  <div
                    class="bg-yellow-100 text-yellow-600 w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                    4</div>
                  <div class="flex-1">
                    <h4 class="text-xl font-bold text-gray-900 mb-3">ตั้งค่าการเงิน</h4>

                    <!-- รูปภาพประกอบ -->
                    <div class="image-placeholder rounded-lg h-48 flex items-center justify-center mb-4">
                      <div class="text-center text-gray-500">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <p class="font-semibold">รูปที่ 15: หน้าตั้งค่าการเงิน</p>
                        <p class="text-sm">แสดงการตั้งค่าราคาและค่าธรรมเนียมต่างๆ</p>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span>กำหนดค่ามัดจำคิวรถเริ่มต้น</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span>กำหนดเงินประกันความเสียหายเริ่มต้น</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span>ตั้งค่าจำนวนชั่วโมงที่คิดเป็นหนึ่งวัน</span>
                      </div>
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-arrow-right text-yellow-500"></i>
                        <span>กำหนดอัตราค่าคอมมิชชั่น (ถ้ามี)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Warning -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 mt-8">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
                </div>
                <div class="ml-3">
                  <h3 class="text-lg font-medium text-yellow-800">ข้อควรระวังในการตั้งค่า</h3>
                  <div class="mt-2 text-yellow-700">
                    <ul class="list-disc list-inside space-y-1">
                      <li>การเปลี่ยนแปลงการตั้งค่าจะมีผลกับรายการใหม่เท่านั้น</li>
                      <li>สำรองข้อมูลก่อนทำการเปลี่ยนแปลงที่สำคัญ</li>
                      <li>ตรวจสอบการตั้งค่าให้ถูกต้องก่อนเริ่มใช้งานจริง</li>
                      <li>เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถเข้าถึงหน้าตั้งค่าได้</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FAQ Section -->
      <section id="faq" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="flex items-center mb-8">
              <div class="gradient-bg-8 w-16 h-16 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-question-circle text-white text-2xl"></i>
              </div>
              <div>
                <h2 class="text-3xl font-bold text-gray-900">คำถามที่พบบ่อย (FAQ)</h2>
                <p class="text-gray-600 mt-2">คำตอบสำหรับปัญหาและคำถามที่พบบ่อย</p>
              </div>
            </div>

            <div class="space-y-6">
              <!-- FAQ 1 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 1 ? null : 1"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">ทำไมรถไม่ปรากฏในรายการเมื่อค้นหารถว่าง?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 1 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 1" x-transition class="px-6 py-4 bg-white">
                  <p class="text-gray-600 mb-3">อาจเกิดจากสาเหตุต่อไปนี้:</p>
                  <ul class="list-disc list-inside text-gray-600 space-y-1">
                    <li>รถมีการจองในช่วงเวลาที่เลือกแล้ว</li>
                    <li>สถานะรถเป็น "ซ่อมบำรุง" หรือ "ไม่พร้อมใช้"</li>
                    <li>ข้อมูลรถยังไม่ได้บันทึกในระบบ</li>
                    <li>ช่วงเวลาที่เลือกทับซ้อนกับการจองอื่น</li>
                  </ul>
                </div>
              </div>

              <!-- FAQ 2 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 2 ? null : 2"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">สัญญาเช่าไม่ได้ถูกสร้างขึ้นมาทำอย่างไร?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 2 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 2" x-transition class="px-6 py-4 bg-white">
                  <p class="text-gray-600 mb-3">ตรวจสอบขั้นตอนต่อไปนี้:</p>
                  <ul class="list-disc list-inside text-gray-600 space-y-1">
                    <li>เปิดใช้งานตัวเลือก "สร้างสัญญาเช่า" ในฟอร์ม</li>
                    <li>ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต</li>
                    <li>ดูในโฟลเดอร์ Google Drive ว่ามีไฟล์สัญญาหรือไม่</li>
                    <li>ลองสร้างใหม่หากยังไม่ได้</li>
                  </ul>
                </div>
              </div>

              <!-- FAQ 3 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 3 ? null : 3"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">จะแก้ไขข้อมูลการจองหลังจากบันทึกแล้วได้อย่างไร?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 3 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 3" x-transition class="px-6 py-4 bg-white">
                  <div class="text-gray-600 space-y-2">
                    <p>1. ไปที่หน้า "ค้นหาข้อมูล"</p>
                    <p>2. ค้นหาด้วยหมายเลขการจองหรือชื่อลูกค้า</p>
                    <p>3. คลิกปุ่ม <i class="fas fa-edit text-blue-500 mx-1"></i> ในรายการที่ต้องการแก้ไข</p>
                    <p>4. แก้ไขข้อมูลและกดบันทึก</p>
                    <p class="text-amber-600 font-medium">หมายเหตุ: การแก้ไขบางรายการอาจต้องสร้างสัญญาใหม่</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 4 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 4 ? null : 4"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">จะสำรองข้อมูลระบบได้อย่างไร?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 4 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 4" x-transition class="px-6 py-4 bg-white">
                  <div class="text-gray-600 space-y-2">
                    <p>ข้อมูลถูกบันทึกใน Google Sheets อัตโนมัติ แต่สามารถสำรองเพิ่มเติมได้:</p>
                    <p>1. ไปที่ Google Drive ของคุณ</p>
                    <p>2. หาโฟลเดอร์ "ระบบจัดการรถเช่า"</p>
                    <p>3. คลิกขวาที่ไฟล์ Sheets และเลือก "ดาวน์โหลด"</p>
                    <p>4. เลือกรูปแบบไฟล์ที่ต้องการ (Excel, CSV)</p>
                    <p class="text-green-600 font-medium">แนะนำ: สำรองข้อมูลเป็นประจำทุกสัปดาห์</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 5 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 5 ? null : 5"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">ทำไมระบบช้าหรือไม่ตอบสนอง?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 5 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 5" x-transition class="px-6 py-4 bg-white">
                  <div class="text-gray-600 space-y-2">
                    <p>ลองแก้ไขด้วยวิธีต่อไปนี้:</p>
                    <p>1. รีเฟรชหน้าเว็บ (กด F5 หรือ Ctrl+R)</p>
                    <p>2. ล้างแคชเบราว์เซอร์</p>
                    <p>3. ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต</p>
                    <p>4. ลองเปิดในแท็บใหม่หรือเบราว์เซอร์อื่น</p>
                    <p>5. หากยังมีปัญหา ติดต่อผู้ดูแลระบบ</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 6 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 6 ? null : 6"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">จะเพิ่มรถใหม่เข้าระบบได้อย่างไร?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 6 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 6" x-transition class="px-6 py-4 bg-white">
                  <div class="text-gray-600 space-y-2">
                    <p>1. ไปที่หน้า "จัดการรถ"</p>
                    <p>2. กดปุ่ม "เพิ่มรถใหม่"</p>
                    <p>3. กรอกข้อมูลรถครบถ้วน: ยี่ห้อ รุ่น ทะเบียน สี ราคา</p>
                    <p>4. ตั้งค่าสถานะเป็น "พร้อมให้เช่า"</p>
                    <p>5. กดปุ่ม "บันทึก"</p>
                    <p class="text-blue-600 font-medium">เคล็ดลับ: ตรวจสอบทะเบียนรถให้ถูกต้องก่อนบันทึก</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 7 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 7 ? null : 7"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">ต้องการเปลี่ยนแปลงเทมเพลตสัญญาเช่าทำอย่างไร?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 7 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 7" x-transition class="px-6 py-4 bg-white">
                  <div class="text-gray-600 space-y-2">
                    <p>1. ไปที่หน้า "ตั้งค่าระบบ"</p>
                    <p>2. เลือกแท็บ "การจัดการเทมเพลต"</p>
                    <p>3. เลือกเทมเพลตที่ต้องการแก้ไข</p>
                    <p>4. แก้ไขเนื้อหาตามต้องการ</p>
                    <p>5. ใช้ตัวแปรเช่น {{ชื่อลูกค้า}} {{รถ}} สำหรับข้อมูลที่เปลี่ยนแปลง</p>
                    <p>6. กดปุ่ม "บันทึกเทมเพลต"</p>
                    <p class="text-orange-600 font-medium">คำเตือน: การเปลี่ยนแปลงจะมีผลกับสัญญาใหม่เท่านั้น</p>
                  </div>
                </div>
              </div>

              <!-- FAQ 8 -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="openFaq = openFaq === 8 ? null : 8"
                  class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">จะดูรายงานรายได้ได้อย่างไร?</h3>
                  <i class="fas fa-chevron-down transition-transform" :class="openFaq === 8 ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="openFaq === 8" x-transition class="px-6 py-4 bg-white">
                  <div class="text-gray-600 space-y-2">
                    <p>1. ไปที่หน้า "รายงาน" จากเมนูหลัก</p>
                    <p>2. เลือกปีที่ต้องการดูรายงาน</p>
                    <p>3. ดูกราฟรายได้รายเดือน</p>
                    <p>4. คลิกที่แต่ละเดือนเพื่อดูรายละเอียด</p>
                    <p>5. ใช้ปุ่ม "ส่งออก PDF" เพื่อบันทึกรายงาน</p>
                    <p class="text-green-600 font-medium">ข้อมูลจะอัพเดตแบบเรียลไทม์</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Additional Support -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mt-8">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <i class="fas fa-life-ring text-blue-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                  <h3 class="text-lg font-medium text-blue-900 mb-2">ไม่พบคำตอบที่ต้องการ?</h3>
                  <p class="text-blue-700 mb-4">หากคุณมีคำถามอื่นๆ หรือต้องการความช่วยเหลือเพิ่มเติม</p>
                  <button @click="scrollToSection('contact')"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-headset mr-2"></i>ติดต่อฝ่ายสนับสนุน
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Contact Section -->
      <section id="contact" class="scroll-mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="section-card rounded-xl p-8">
            <div class="text-center">
              <div class="gradient-bg-5 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-headset text-white text-3xl"></i>
              </div>
              <h2 class="text-3xl font-bold text-gray-900 mb-4">ติดต่อและความช่วยเหลือ</h2>
              <p class="text-xl text-gray-600 mb-8">หากมีคำถามหรือต้องการความช่วยเหลือเพิ่มเติม</p>

              <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg hover-scale">
                  <i class="fas fa-envelope text-blue-600 text-2xl mb-3"></i>
                  <h3 class="text-lg font-bold text-blue-900 mb-2">อีเมลสนับสนุน</h3>
                  <p class="text-blue-800">support@carrentalsystem.com</p>
                  <p class="text-sm text-blue-600 mt-2">ตอบกลับภายใน 24 ชั่วโมง</p>
                </div>

                <div class="bg-green-50 p-6 rounded-lg hover-scale">
                  <i class="fas fa-phone text-green-600 text-2xl mb-3"></i>
                  <h3 class="text-lg font-bold text-green-900 mb-2">โทรศัพท์</h3>
                  <p class="text-green-800">02-XXX-XXXX</p>
                  <p class="text-sm text-green-600 mt-2">พร้อมให้บริการในเวลาทำการ</p>
                </div>

                <div class="bg-purple-50 p-6 rounded-lg hover-scale">
                  <i class="fab fa-line text-purple-600 text-2xl mb-3"></i>
                  <h3 class="text-lg font-bold text-purple-900 mb-2">LINE Support</h3>
                  <p class="text-purple-800">@carrentalsupport</p>
                  <p class="text-sm text-purple-600 mt-2">ตอบกลับเร็วที่สุด</p>
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div class="bg-gray-50 p-6 rounded-lg">
                  <h3 class="text-lg font-bold text-gray-900 mb-3">เวลาให้บริการ</h3>
                  <div class="space-y-2 text-gray-600">
                    <p><i class="fas fa-clock mr-2 text-blue-500"></i>จันทร์ - ศุกร์: 09:00 - 18:00 น.</p>
                    <p><i class="fas fa-clock mr-2 text-green-500"></i>เสาร์ - อาทิตย์: 09:00 - 16:00 น.</p>
                    <p><i class="fas fa-phone-slash mr-2 text-red-500"></i>วันหยุดนักขัตฤกษ์: ปิดให้บริการ</p>
                  </div>
                </div>

                <div class="bg-gray-50 p-6 rounded-lg">
                  <h3 class="text-lg font-bold text-gray-900 mb-3">ประเภทการสนับสนุน</h3>
                  <div class="space-y-2 text-gray-600">
                    <p><i class="fas fa-question-circle mr-2 text-blue-500"></i>คำถามการใช้งาน</p>
                    <p><i class="fas fa-bug mr-2 text-red-500"></i>รายงานปัญหา Bug</p>
                    <p><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>ข้อเสนอแนะ</p>
                    <p><i class="fas fa-cogs mr-2 text-purple-500"></i>การตั้งค่าระบบ</p>
                  </div>
                </div>
              </div>




            </div>
          </div>
        </div>
      </section>
    </div>


    <!-- Back to Top Button -->
    <div x-data="{ showBackToTop: false }" @scroll.window="showBackToTop = window.pageYOffset > 100">
      <button @click="window.scrollTo({top: 0, behavior: 'smooth'})" x-show="showBackToTop" x-transition
        class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-all z-40 hover-scale">
        <i class="fas fa-arrow-up"></i>
      </button>
    </div>

    <!-- Footer -->
    <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white py-8 mt-16 rounded-lg">
      <div class="text-center">
        <div class="flex items-center justify-center mb-4">
          <i class="fas fa-book text-2xl mr-3"></i>
          <span class="text-xl font-bold">คู่มือการใช้งานระบบจัดการรถเช่า</span>
        </div>
        <p class="text-gray-400 mb-2">คู่มือฉบับสมบูรณ์ - เวอร์ชัน 1.0</p>
        <p class="text-gray-500 text-sm mb-4">
          © 2024 Car Rental Management System. All rights reserved.
        </p>

        <div class="flex justify-center space-x-6 text-sm">
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-file-alt mr-1"></i>เงื่อนไขการใช้งาน
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-shield-alt mr-1"></i>นโยบายความเป็นส่วนตัว
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-question-circle mr-1"></i>ช่วยเหลือ
          </a>
        </div>
      </div>
    </div>

  </div>



  <!-- หน้าตั้งค่าระบบ -->

  <div x-show="currentPage === 'config'" x-cloak>

    <!-- ตั้งค่าระบบ -->
    <div class="mb-6">
      <div class="flex items-center bg-white p-4 rounded-xl shadow-md border-l-4" style="border-color: #B4C1C7;">
        <div class="flex items-center justify-center w-16 h-16 rounded-full shadow-md mr-5"
          style="background-color: #B4C1C7;">
          <i class="fas fa-sliders-h text-white text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-800 flex items-center">ตั้งค่าระบบ</h2>
          <p class="mt-1 text-gray-600">
            <i class="fas fa-tools mr-2" style="color: #B4C1C7;"></i>ตั้งค่าพื้นฐานและการทำงานของระบบ
          </p>
        </div>
      </div>
    </div>


    <!-- แถบปุ่มคีย์ลัด - เพิ่มหลังจากหัวข้อ "ตั้งค่าระบบ" -->
    <div class="mb-6">
      <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 shadow-sm">
        <div class="mb-2 flex items-center text-blue-700">
          <i class="fas fa-bolt mr-2"></i>
          <span class="font-medium">คีย์ลัด</span>
        </div>

        <div class="flex flex-wrap gap-2">
          <!-- ข้อมูลบริษัท -->
          <button x-show="hasPermission('company-info')"
            @click="document.getElementById('company-info').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-building mr-2"></i>
            ข้อมูลบริษัท
          </button>

          <!-- ตั้งค่าการชำระเงิน -->
          <button x-show="hasPermission('payment-settings')"
            @click="document.getElementById('payment-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-credit-card mr-2"></i>
            ตั้งค่าการชำระเงิน
          </button>

          <!-- ตั้งค่า LINE Bot -->
          <button x-show="hasPermission('linebot-settings')"
            @click="document.getElementById('linebot-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fab fa-line mr-2"></i>
            ตั้งค่า LINE Bot
          </button>

          <button x-show="hasPermission('commission-settings')"
            @click="document.getElementById('commission-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-percent mr-2"></i>
            ตั้งค่าคอมมิชชั่น
          </button>

          <!-- การจอง -->
          <button x-show="hasPermission('booking-settings')"
            @click="document.getElementById('booking-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-bookmark mr-2"></i>
            การจอง
          </button>

          <!-- จัดการสถานที่ -->
          <button x-show="hasPermission('location-settings')"
            @click="document.getElementById('location-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-map-marker-alt mr-2"></i>
            จัดการสถานที่
          </button>

          <!-- ตั้งค่าข้อความสรุปรายการเช่า -->
          <button x-show="hasPermission('summary-message-settings')"
            @click="document.getElementById('summary-message-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-receipt mr-2"></i>
            ตั้งค่าข้อความสรุปรายการเช่า
          </button>

          <!-- ตั้งค่าข้อความเสนอราคา -->
          <button x-show="hasPermission('quote-message-settings')"
            @click="document.getElementById('quote-message-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-file-invoice-dollar mr-2"></i>
            ตั้งค่าข้อความเสนอราคา
          </button>

          <!-- จัดการแปลภาษาสัญญาเช่า -->
          <button x-show="hasPermission('translation-settings')"
            @click="document.getElementById('translation-settings').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-language mr-2"></i>
            แปลภาษา
          </button>

          <!-- จัดการผู้ใช้งาน -->
          <button
            @click="document.getElementById('user-management').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-users-cog mr-2"></i>
            ผู้ใช้งาน
          </button>

          <!-- จัดการกลุ่มผู้ใช้และสิทธิ์ -->
          <button x-show="hasPermission('role-management')"
            @click="document.getElementById('role-management').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-user-shield mr-2"></i>
            กลุ่มผู้ใช้
          </button>

          <!-- รายชื่อ Blacklist -->
          <button x-show="hasPermission('blacklist-management')"
            @click="document.getElementById('blacklist-management').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-ban mr-2"></i>
            Blacklist
          </button>

          <!-- ข้อมูล License -->
          <button x-show="hasPermission('license-info')"
            @click="document.getElementById('license-info').scrollIntoView({behavior: 'smooth', block: 'start'})"
            class="px-3 py-2 bg-white hover:bg-blue-100 text-blue-700 text-sm rounded-md border border-blue-200 transition-all shadow-sm hover:shadow flex items-center">
            <i class="fas fa-key mr-2"></i>
            License
          </button>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 mb-6 space-y-8">
      <form @submit.prevent="saveConfig" class="space-y-6">
        <!-- ส่วนข้อมูลบริษัท -->
        <div id="company-info" class="bg-gray-50 p-4 rounded-lg border border-gray-200"
          x-show="hasPermission('company-info')">
          <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
            <i class="fas fa-building mr-3"></i>
            ข้อมูลบริษัท
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อบริษัท</label>
              <input type="text" x-model="config.ชื่อบริษัท"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">รูปโลโก้ร้าน</label>
              <div class="flex flex-col space-y-2">
                <div class="flex items-center space-x-2">
                  <input type="file" id="logoFile" @change="uploadLogo($event)" accept="image/*" class="hidden">
                  <button @click="document.getElementById('logoFile').click()" type="button"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-upload mr-2"></i>เลือกรูปภาพ
                  </button>
                  <span x-text="logoUploadStatus" class="text-sm text-gray-600"></span>
                </div>

                <!-- แสดงปุ่มดูรูปและลบรูป (เมื่อมีการอัปโหลดรูปแล้ว) -->
                <div x-show="config.URLรูปโลโก้ร้าน" class="mt-2 flex items-center space-x-2">
                  <a :href="config.URLรูปโลโก้ร้าน" target="_blank"
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 inline-flex items-center">
                    <i class="fas fa-external-link-alt mr-2"></i>
                    ดูรูปโลโก้
                  </a>
                  <button @click="removeLogo()" type="button"
                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 inline-flex items-center">
                    <i class="fas fa-trash-alt mr-2"></i>
                    ลบรูป
                  </button>
                </div>
              </div>
              <!-- คำอธิบายเพิ่มเติม -->
              <p x-show="!config.URLรูปโลโก้ร้าน" class="text-xs text-gray-500 mt-1">
                <i class="fas fa-info-circle mr-1"></i>
                อัปโหลดรูปโลโก้ร้านเพื่อแสดงในเอกสารและใบเสร็จ
              </p>

              <!-- ฟิลด์สำหรับเก็บ URL ของรูปโลโก้ร้าน (hidden) -->
              <input type="hidden" x-model="config.URLรูปโลโก้ร้าน">
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">เบอร์โทรศัพท์</label>
              <input type="tel" x-model="config.เบอร์โทรศัพท์"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">อีเมล</label>
              <input type="email" x-model="config.อีเมล"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ที่อยู่</label>
              <textarea x-model="config.ที่อยู่" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>

        </div>

        <div class="bg-white p-6 rounded-xl shadow-md" data-aos="fade-up" data-aos-delay="200">

          <div class="flex items-center border-b pb-3 mb-4">
            <i class="fas fa-database text-xl text-blue-500 mr-3"></i>
            <h3 class="text-lg font-bold text-gray-800">ฐานข้อมูลร้าน</h3>
          </div>

          <div>
            <p class="text-sm text-gray-600 mb-4">
              เข้าถึงไฟล์ข้อมูลหลักและโฟลเดอร์ที่เก็บไฟล์สัญญาและรูปภาพทั้งหมดของร้าน
            </p>

            <div class="flex flex-col md:flex-row md:space-x-3 space-y-3 md:space-y-0">

              <a href="#"
                @click.prevent="window.open('https://docs.google.com/spreadsheets/d/' + (localStorage.getItem('sheetID') || ''), '_blank')"
                class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors shadow-sm flex items-center justify-center">
                <i class="fas fa-file-excel mr-2"></i>
                <span>ไฟล์ฐานข้อมูล</span>
              </a>

              <a :href="'https://drive.google.com/drive/folders/' + (config['IDโฟลเดอร์หลัก'] || '')" target="_blank"
                x-show="config['IDโฟลเดอร์หลัก']"
                class="flex-1 text-center bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2.5 px-4 rounded-lg transition-colors shadow-sm flex items-center justify-center">
                <i class="fas fa-folder-open mr-2"></i>
                <span>โฟลเดอร์เก็บข้อมูล</span>
              </a>

            </div>
          </div>
        </div>


        <!-- ส่วนตั้งค่าการชำระเงิน -->
        <div id="payment-settings" class="bg-gray-50 p-4 rounded-lg border border-gray-200"
          x-show="hasPermission('payment-settings')">
          <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
            <i class="fas fa-credit-card mr-3"></i>
            ตั้งค่าการชำระเงิน
          </h2>
          <div class="space-y-4">
            <!-- ข้อมูลบัญชีธนาคาร -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อธนาคาร</label>
                <input type="text" x-model="config.ชื่อธนาคาร" placeholder="เช่น กสิกรไทย, ไทยพาณิชย์, กรุงไทย"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อบัญชี</label>
                <input type="text" x-model="config.ชื่อบัญชี" placeholder="ชื่อบัญชีธนาคาร"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">หมายเลขบัญชีธนาคาร</label>
                <input type="text" x-model="config.หมายเลขบัญชีธนาคาร" placeholder="เช่น xxx-x-xxxxx-x"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">หมายเลขพร้อมเพย์ (ถ้ามี)</label>
                <input type="text" x-model="config.หมายเลขพร้อมเพย์"
                  placeholder="เช่น เบอร์โทรศัพท์, เลขประจำตัวผู้เสียภาษี"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>

            <!-- ส่วนจัดการ QR Code แบบใหม่ - แทนที่ส่วนเดิมทั้งหมด -->
            <div class="mt-6 border-t pt-4">
              <h3 class="text-lg font-medium mb-3 flex items-center">
                <i class="fas fa-qrcode text-gray-700 mr-2"></i>
                ตั้งค่า QR Code สำหรับชำระเงิน
              </h3>

              <div class="space-y-2">
                <!-- ตัวเลือกที่ 1: ใช้รูป QR Code ของคุณเอง -->
                <div class="flex items-center">
                  <input type="radio" id="useManualQRCode" name="qrCodeType"
                    :checked="config.วิธีการใช้QRCode === 'manual'" @change="config.วิธีการใช้QRCode = 'manual'"
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                  <label for="useManualQRCode" class="ml-2 block text-sm text-gray-700">
                    ใช้รูป QR Code ของคุณเอง (สแกนและระบุยอดเงินเอง)
                  </label>
                </div>

                <!-- ตัวเลือกที่ 2: สร้าง QR Code อัตโนมัติ -->
                <div class="flex items-center">
                  <input type="radio" id="useAutoQRCode" name="qrCodeType" :checked="config.วิธีการใช้QRCode === 'auto'"
                    @change="config.วิธีการใช้QRCode = 'auto'"
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                  <label for="useAutoQRCode" class="ml-2 block text-sm text-gray-700">
                    สร้างรูป QR Code อัตโนมัติ (สแกนแล้วเป็นยอดชำระวันรับรถ)
                  </label>
                </div>

                <!-- ตัวเลือกที่ 3: ไม่ใช้ QR Code -->
                <div class="flex items-center">
                  <input type="radio" id="noQRCode" name="qrCodeType" :checked="config.วิธีการใช้QRCode === 'none'"
                    @change="config.วิธีการใช้QRCode = 'none'"
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                  <label for="noQRCode" class="ml-2 block text-sm text-gray-700">
                    ไม่ใช้รูป QR Code (ลูกค้าชำระผ่านช่องทางอื่น)
                  </label>
                </div>
              </div>

              <!-- ส่วนอัปโหลด QR Code (แสดงเฉพาะเมื่อเลือกใช้รูป QR Code ของตัวเอง) -->
              <div x-show="config.วิธีการใช้QRCode === 'manual'" class="mt-4" x-transition>
                <label class="block text-sm font-medium text-gray-700 mb-2">อัปโหลดรูป QR Code</label>
                <div class="flex flex-col space-y-2">
                  <div class="flex items-center space-x-2">
                    <input type="file" id="qrCodeFile" @change="uploadQRCode($event)" accept="image/*" class="hidden">
                    <button @click="document.getElementById('qrCodeFile').click()" type="button"
                      class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <i class="fas fa-upload mr-2"></i>เลือกรูปภาพ
                    </button>
                    <span x-text="qrCodeUploadStatus" class="text-sm text-gray-600"></span>
                  </div>

                  <!-- แสดงปุ่มดูรูปและลบรูป (เมื่อมีการอัปโหลดรูปแล้ว) -->
                  <div x-show="config.URLรูปQRCode" class="mt-2 flex items-center space-x-2">
                    <a :href="config.URLรูปQRCode" target="_blank"
                      class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 inline-flex items-center">
                      <i class="fas fa-external-link-alt mr-2"></i>
                      ดูรูป QR Code
                    </a>
                    <button @click="removeQRCode()" type="button"
                      class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 inline-flex items-center">
                      <i class="fas fa-trash-alt mr-2"></i>
                      ลบรูป
                    </button>
                  </div>
                </div>
              </div>

              <!-- คำอธิบายเพิ่มเติมตามตัวเลือกที่เลือก -->
              <div class="mt-3">
                <p x-show="config.วิธีการใช้QRCode === 'manual'" class="text-xs text-gray-500">
                  <i class="fas fa-info-circle mr-1"></i>
                  อัปโหลดรูป QR Code สำหรับชำระเงิน ผู้ใช้ต้องระบุจำนวนเงินเองเมื่อสแกน QR Code
                </p>
                <p x-show="config.วิธีการใช้QRCode === 'auto'" class="text-xs text-gray-500">
                  <i class="fas fa-info-circle mr-1"></i>
                  ระบบจะสร้าง QR Code ตามยอดเงินในแต่ละรายการโดยอัตโนมัติ ผู้ใช้ไม่ต้องระบุจำนวนเงินเมื่อสแกน
                </p>
                <p x-show="config.วิธีการใช้QRCode === 'none'" class="text-xs text-gray-500">
                  <i class="fas fa-info-circle mr-1"></i>
                  ไม่แสดง QR Code ในเอกสารสัญญาเช่า ลูกค้าจะต้องชำระเงินผ่านช่องทางอื่น เช่น โอนเงินผ่านธนาคาร
                </p>
              </div>

              <!-- ฟิลด์สำหรับเก็บ URL ของรูป QR Code (hidden) -->
              <input type="hidden" x-model="config.URLรูปQRCode">
              <input type="hidden" x-model="config.IDโฟลเดอร์หลัก">
            </div>




          </div>

          <div class="flex justify-end">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>

        </div>


        <!-- ส่วนตั้งค่า LINE Bot -->
        <div id="linebot-settings" class="bg-gray-50 p-4 rounded-lg border border-gray-200"
          x-show="hasPermission('linebot-settings')">
          <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
            <i class="fab fa-line mr-3"></i>
            ตั้งค่า LINE Bot
          </h2>

          <!-- คำอธิบาย -->
          <div class="p-4 bg-blue-50 border border-blue-300 rounded-md text-sm text-blue-800 mb-6">
            <strong class="block mb-1 text-blue-700">ℹ️ เกี่ยวกับ LINE Bot:</strong>
            <p class="mt-2 text-gray-700">
              LINE Bot ช่วยให้สามารถเช็คคิวรถว่างและตารางรับส่งรถผ่าน LINE ได้โดยตรง
              ผู้ใช้ต้องลงทะเบียนด้วย Secret ID ที่สุ่มได้จากระบบนี้ ซึ่งเป็นรหัสเฉพาะของร้านเท่านั้น
            </p>
          </div>

          <!-- ส่วนจัดการ Secret ID -->
          <div class="mb-6 bg-white p-4 rounded-lg shadow">
            <h3 class="text-gray-700 font-medium mb-3 flex items-center">
              <i class="fas fa-key mr-2"></i>
              Secret ID สำหรับลงทะเบียน
            </h3>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">Secret ID (6 หลัก)</label>
              <div class="relative flex items-center">
                <input type="text" x-model="config.LINEBotSecretID" readonly placeholder="คลิก 'สุ่ม Secret ID'"
                  class="flex-1 px-3 py-2 pr-16 sm:pr-24 border border-gray-300 rounded-md shadow-sm bg-gray-50 font-mono text-lg">
                <button @click="generateLineBotSecret()" type="button"
                  class="absolute right-1 px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm rounded focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center whitespace-nowrap">
                  <i class="fas fa-random mr-1"></i>
                  <span class="hidden sm:inline">สุ่ม Secret ID</span>
                  <span class="sm:hidden">สุ่ม</span>
                </button>
              </div>
              <p class="text-xs text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                ให้ Secret ID นี้แก่พนักงานเพื่อใช้ลงทะเบียนกับ LINE Bot
              </p>
            </div>
          </div>

          <!-- ตารางจัดการผู้ใช้ LINE Bot -->
          <div class="mb-6 bg-white p-4 rounded-lg shadow">
            <h3 class="text-gray-700 font-medium mb-3 flex items-center">
              <i class="fas fa-users mr-2"></i>
              ผู้ใช้ที่ลงทะเบียนแล้ว
            </h3>

            <!-- ตาราง -->
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">LINE
                      User ID</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                      ชื่อผู้ใช้</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">สถานะ
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                      วันที่ลงทะเบียน</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                      ใช้งานล่าสุด</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">
                      จัดการ</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr x-show="linebotUsers.length === 0">
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500 italic">
                      ยังไม่มีผู้ใช้ลงทะเบียน LINE Bot
                    </td>
                  </tr>

                  <template x-for="user in linebotUsers" :key="user.LineUserID">
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3 text-sm text-gray-900 font-mono"
                        x-text="user.LineUserID.substring(0, 20) + '...'"></td>
                      <td class="px-4 py-3 text-sm text-gray-900" x-text="user.UserName"></td>
                      <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs font-medium"
                          :class="user.Status === 'REGISTERED' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                          x-text="user.Status === 'REGISTERED' ? 'ลงทะเบียนแล้ว' : user.Status"></span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-600" x-text="formatDate(user.RegisteredDate)"></td>
                      <td class="px-4 py-3 text-sm text-gray-600" x-text="formatDate(user.LastActive)"></td>
                      <td class="px-4 py-3 text-center">
                        <button @click="deleteLineBotUser(user.LineUserID)"
                          class="text-red-600 hover:text-red-800 text-sm font-medium">
                          <i class="fas fa-trash-alt mr-1"></i>ลบ
                        </button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ปุ่มบันทึก -->
          <div class="flex justify-end">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>
        </div>


        <div id="receipt-settings" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
          <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
            <i class="fas fa-receipt mr-3"></i>
            ตั้งค่ารหัสเอกสาร
          </h2>
          <div class="space-y-6">

            <!-- ส่วนที่ 1: ตั้งค่าตัวอักษรนำหน้า (Prefix) -->
            <div>
              <label class="block text-base font-medium text-gray-800 mb-2">ตัวอักษรนำหน้า (Prefix)</label>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                <!-- รหัสใบเสนอราคา -->
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">ใบเสนอราคา</label>
                  <input type="text" x-model="config['รหัสใบเสนอราคา']" placeholder="เช่น QUO-"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" title="รหัสใบเสนอราคา">
                </div>

                <!-- รหัสบิลเงินสด -->
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">บิลเงินสด</label>
                  <input type="text" x-model="config['รหัสบิลเงินสด']" placeholder="เช่น BNS"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" title="รหัสบิลเงินสด">
                </div>

                <!-- รหัสใบกำกับภาษี -->
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">ใบกำกับภาษี</label>
                  <input type="text" x-model="config['รหัสใบกำกับภาษี']" placeholder="เช่น TIV"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" title="รหัสใบกำกับภาษี">
                </div>
              </div>
            </div>

            <!-- ส่วนที่ 2: ตั้งค่ารูปแบบการรันเลข -->
            <div>
              <label class="block text-base font-medium text-gray-800 mb-2">รูปแบบการรันเลข</label>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                <!-- รูปแบบรหัสใบเสนอราคา -->
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">ใบเสนอราคา</label>
                  <select x-model="config['รูปแบบรหัสใบเสนอราคา']"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                    <option value="continuous">รันเลขต่อเนื่อง</option>
                    <option value="ymd">รันเลขตามปี-เดือน-วัน</option>
                    <option value="ym">รันเลขตามปี-เดือน</option>
                    <option value="y">รันเลขตามปี</option>
                  </select>
                </div>

                <!-- รูปแบบรหัสบิลเงินสด -->
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">บิลเงินสด</label>
                  <select x-model="config['รูปแบบรหัสบิลเงินสด']"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                    <option value="continuous">รันเลขต่อเนื่อง</option>
                    <option value="ymd">รันเลขตามปี-เดือน-วัน</option>
                    <option value="ym">รันเลขตามปี-เดือน</option>
                    <option value="y">รันเลขตามปี</option>
                  </select>
                </div>

                <!-- รูปแบบรหัสใบกำกับภาษี -->
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">ใบกำกับภาษี</label>
                  <select x-model="config['รูปแบบรหัสใบกำกับภาษี']"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                    <option value="continuous">รันเลขต่อเนื่อง</option>
                    <option value="ymd">รันเลขตามปี-เดือน-วัน</option>
                    <option value="ym">รันเลขตามปี-เดือน</option>
                    <option value="y">รันเลขตามปี</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- ปุ่มบันทึก -->
          <div class="flex justify-end mt-6">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>
        </div>



        <div id="commission-settings" class="bg-gray-50 p-4 rounded-lg border border-gray-200"
          x-show="hasPermission('payment-settings')" x-init="loadCommissionList()">

          <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
            <i class="fas fa-percent mr-2"></i>
            ตั้งค่าคอมมิชชั่น
          </h2>

          <!-- 🔶 กล่องตัวอย่างตัวอย่าง + คำอธิบาย -->
          <div class="p-4 bg-blue-50 border border-blue-300 rounded-md text-sm text-blue-800 mb-6">
            <strong class="block mb-1 text-blue-700">📌 ตัวอย่าง:</strong>
            <ul class="list-disc pl-5 space-y-1">
              <li><b>DriveHub</b>: ค่าคอม 20% จากยอดเช่า + VAT 7% → เลือก "เปอร์เซ็นต์ + Vat", ใส่ 20 และ 7</li>
              <li><b>พาร์ทเนอร์ A</b>: ค่าคอมคงที่ 200 บาท/วัน → เลือก "ตายตัว", ใส่ 200</li>
            </ul>
            <p class="mt-2 text-gray-700">สามารถเพิ่มได้หลายรายการตามผู้ให้บริการหรือช่องทาง</p>
          </div>

          <!-- 📝 ฟอร์มเพิ่มรายการใหม่ -->
          <div class="space-y-3 mb-4 bg-white p-4 rounded-lg shadow">
            <h3 class="text-gray-700 font-medium">เพิ่มรายการคอมมิชชั่นใหม่</h3>

            <div>
              <input type="text" x-model="newCommission.ชื่อ" placeholder="ชื่อ เช่น DriveHub"
                class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <p class="text-xs text-gray-500 mt-1">ชื่อผู้ให้ค่าคอม เช่น DriveHub, พาร์ทเนอร์ A</p>
            </div>

            <div>
              <select x-model="newCommission.รูปแบบ" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="fixed">ตายตัว (Fixed)</option>
                <option value="percent+vat">เปอร์เซ็นต์ + Vat</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">เลือกรูปแบบที่ต้องการคิดค่าคอมมิชชั่น</p>
            </div>

            <div x-show="newCommission.รูปแบบ === 'fixed'" x-transition>
              <input type="number" x-model="newCommission.ค่าFixed" placeholder="บาท/วัน"
                class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <p class="text-xs text-gray-500 mt-1">ใส่จำนวนค่าคอมที่ต้องการคิดรายวัน เช่น 200</p>
            </div>

            <div x-show="newCommission.รูปแบบ === 'percent+vat'" x-transition class="grid grid-cols-2 gap-3">
              <div>
                <input type="number" x-model="newCommission.ค่าเปอร์เซ็นต์" placeholder="เปอร์เซ็นต์ (%)"
                  class="px-3 py-2 border border-gray-300 rounded-md">
                <p class="text-xs text-gray-500 mt-1">เช่น 20 หมายถึงคิด 20% จากยอดเช่า</p>
              </div>
              <div>
                <input type="number" x-model="newCommission.vat" placeholder="VAT (%)"
                  class="px-3 py-2 border border-gray-300 rounded-md">
                <p class="text-xs text-gray-500 mt-1">ถ้ามี VAT เพิ่ม เช่น 7</p>
              </div>
            </div>

            <div class="text-right mt-2">
              <button @click="addCommissionItem"
                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                <i class="fas fa-plus mr-1"></i> เพิ่มรายการ
              </button>
            </div>
          </div>

          <!-- 📋 รายการคอมมิชชั่นที่มีอยู่ -->
          <div class="space-y-2">
            <template x-if="commissionList.length === 0">
              <div class="text-gray-500 italic">ยังไม่มีรายการคอมมิชชั่น</div>
            </template>

            <template x-for="(item, index) in commissionList" :key="index">
              <div class="bg-white p-3 rounded-md border flex justify-between items-center shadow-sm">
                <div>
                  <div class="font-semibold text-gray-800" x-text="item.ชื่อ"></div>
                  <div class="text-sm text-gray-600" x-text="formatCommissionDetail(item)"></div>
                </div>
                <button @click="commissionList.splice(index, 1)" class="text-red-500 hover:text-red-700 text-sm">
                  ลบ
                </button>
              </div>
            </template>
          </div>

          <!-- 💾 ปุ่มบันทึก -->
          <div class="flex justify-end">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>
        </div>










        <!-- ส่วนการจอง - ปรับปรุง -->
        <div id="booking-settings" class="bg-gray-50 p-4 rounded-lg border border-gray-200"
          x-show="hasPermission('booking-settings')">
          <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
            <i class="fas fa-bookmark mr-3"></i>
            การจอง
          </h2>

          <div class="space-y-6">

            <!-- คำนำหน้าหมายเลขการจอง -->
            <div>
              <label class="inline-block border-b border-blue-200 text-base font-semibold text-gray-800 mb-3 pb-1">
                คำนำหน้าหมายเลขการจอง
              </label>
              <div class="space-y-2">
                <input type="text" x-model="config.คำนำหน้าหมายเลขการจอง" @input="validateBookingPrefix()" maxlength="2"
                  placeholder="เช่น KP"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                <div class="text-sm text-green-600">
                  <span x-text="'ตัวอย่างหมายเลขการจอง ' + (config.คำนำหน้าหมายเลขการจอง || 'KP') + '00001'"></span>
                </div>
                <p x-show="!isValidPrefix" class="text-xs text-red-500">
                  กรุณาใช้ตัวอักษรภาษาอังกฤษพิมพ์ใหญ่เท่านั้น ไม่เกิน 2 ตัว
                </p>
              </div>
            </div>

            <!-- ช่องทางการจอง -->
            <div>
              <label class="bg-gray-100 px-3 py-1 rounded text-base font-semibold text-gray-800 mb-2 inline-block">
                ช่องทางการจอง <span class="text-sm text-gray-500 font-normal">(คั่นด้วยเครื่องหมาย , )</span>
              </label>
              <textarea x-model="config.ช่องทางการจอง" rows="2" placeholder="เช่น Walk-in, Line, Facebook, Telephone"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
              <p class="text-xs text-gray-500 mt-1">
                ช่องทางการจองแต่ละรายการให้คั่นด้วยเครื่องหมายจุลภาค (,)
              </p>
            </div>

            <!-- จำนวนชั่วโมงที่คิดเพิ่มเป็น 1 วัน และ ค่าประกันเสริมต่อวัน -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- จำนวนชั่วโมงที่คิดเพิ่มเป็น 1 วัน -->
              <div>
                <label class="block text-base font-semibold text-gray-800 mb-2">
                  จำนวนชั่วโมงที่คิดเพิ่มเป็น 1 วัน
                </label>
                <div class="flex items-center">
                  <input type="number" x-model="config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน" min="0" max="24"
                    placeholder="4"
                    class="w-24 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <span class="ml-2 text-gray-700">ชั่วโมง</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  หากเวลาคืนรถเกินจากเวลารับรถตามจำนวนชั่วโมงที่กำหนด จะคิดค่าเช่าเพิ่มอีก 1 วัน
                </p>
              </div>

              <!-- ค่าประกันเสริมต่อวัน -->
              <div>
                <label class="block text-base font-semibold text-gray-800 mb-2">
                  ค่าประกันเสริมต่อวัน
                </label>
                <div class="flex items-center">
                  <span class="text-gray-600 mr-2">฿</span>
                  <input type="number" x-model="config.ค่าประกันเสริมต่อวัน" min="0" placeholder="0"
                    class="w-32 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <span class="ml-2 text-gray-700">บาท/วัน</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  ราคาประกันเสริมต่อวันที่จะใช้เป็นค่าเริ่มต้นเมื่อลูกค้าเลือกซื้อประกันเสริม
                </p>
              </div>
            </div>

            <!-- ค่าล่วงเวลาเริ่มต้น และ จำนวนชั่วโมงฟรี -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-base font-semibold text-gray-800 mb-2">
                  ค่าล่วงเวลาเริ่มต้น
                </label>
                <div class="flex items-center">
                  <span class="text-gray-600 mr-2">฿</span>
                  <input type="number" x-model="config.ค่าล่วงเวลาเริ่มต้น" min="0" placeholder="100"
                    class="w-32 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <span class="ml-2 text-gray-700">บาท/ชั่วโมง</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  ค่าใช้จ่ายเริ่มต้นที่จะคิดกับรถที่ไม่ได้ระบุค่าล่วงเวลาเฉพาะรถ
                </p>
              </div>

              <div>
                <label class="block text-base font-semibold text-gray-800 mb-2">
                  จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน
                </label>
                <div class="flex items-center">
                  <input type="number" x-model="config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน" min="0" placeholder="0"
                    class="w-24 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <span class="ml-2 text-gray-700">ชั่วโมง</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  ช่วงเวลาที่ไม่คิดค่าล่วงเวลา เช่น ตั้งค่า 1 ชม. หากลูกค้าคืนรถช้า 3 ชม. จะคิดค่าล่วงเวลาเพียง 2 ชม.
                  (แต่หากเกินจำนวนชั่วโมงที่คิดเพิ่มเป็น 1 วัน จะถูกคิดเพิ่มเป็นอีก 1 วันทันที)
                </p>
              </div>
            </div>

            <!-- ค่ามัดจำคิวรถ และ เงินประกัน -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-base font-semibold text-gray-800 mb-2">
                  ค่ามัดจำคิวรถเริ่มต้น
                </label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">฿</span>
                  <input type="number" x-model="config.ค่ามัดจำคิวรถเริ่มต้น" min="0" placeholder="500"
                    class="w-full pl-8 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  จำนวนเงินเริ่มต้นสำหรับค่ามัดจำคิวรถในการสร้างรายการเช่าใหม่
                </p>
              </div>

              <div>
                <label class="block text-base font-semibold text-gray-800 mb-2">
                  เงินประกันความเสียหายเริ่มต้น
                </label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">฿</span>
                  <input type="number" x-model="config.เงินประกันความเสียหายเริ่มต้น" min="0" placeholder="5000"
                    class="w-full pl-8 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  จำนวนเงินเริ่มต้นสำหรับเงินประกันความเสียหายในการสร้างรายการเช่าใหม่
                </p>
              </div>
            </div>

            <!-- การตั้งค่าภาษี -->
            <div class="mt-6 pt-4 border-t border-gray-200">
              <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-file-invoice-dollar mr-2 text-green-500"></i>
                การตั้งค่าภาษี (VAT & หัก ณ ที่จ่าย)
              </h4>

              <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-4 text-sm">
                <p class="text-yellow-800">
                  <i class="fas fa-info-circle mr-1"></i>
                  <span class="font-medium">หมายเหตุ:</span> ตั้งค่าเริ่มต้นว่าบริการใดรวมในการคำนวณภาษี
                  ผู้ใช้ยังสามารถแก้ไขได้เป็นรายการๆ
                </p>
              </div>

              <div class="space-y-4">
                <!-- ค่าคาร์ซีท -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                  <div class="flex items-center justify-between">
                    <span class="font-medium text-gray-800">
                      <i class="fas fa-baby mr-2 text-purple-500"></i>
                      ค่าคาร์ซีท (หากมีค่าบริการ)
                    </span>
                    <div class="flex items-center space-x-4">
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" x-model="config.carSeatIncludeVAT"
                          class="form-checkbox h-4 w-4 text-green-600">
                        <span class="text-sm text-gray-700">รวม VAT</span>
                      </label>
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" x-model="config.carSeatIncludeWHT"
                          class="form-checkbox h-4 w-4 text-orange-600">
                        <span class="text-sm text-gray-700">รวมหัก ณ ที่จ่าย</span>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- ประกันเสริม -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                  <div class="flex items-center justify-between">
                    <span class="font-medium text-gray-800">
                      <i class="fas fa-shield-alt mr-2 text-blue-500"></i>
                      ประกันเสริม
                    </span>
                    <div class="flex items-center space-x-4">
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" x-model="config.insuranceIncludeVAT"
                          class="form-checkbox h-4 w-4 text-green-600">
                        <span class="text-sm text-gray-700">รวม VAT</span>
                      </label>
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" x-model="config.insuranceIncludeWHT"
                          class="form-checkbox h-4 w-4 text-orange-600">
                        <span class="text-sm text-gray-700">รวมหัก ณ ที่จ่าย</span>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- ค่าบริการเพิ่มเติม -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                  <div class="flex items-center justify-between">
                    <span class="font-medium text-gray-800">
                      <i class="fas fa-plus-circle mr-2 text-indigo-500"></i>
                      ค่าบริการเพิ่มเติม
                    </span>
                    <div class="flex items-center space-x-4">
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" x-model="config.additionalServiceIncludeVAT"
                          class="form-checkbox h-4 w-4 text-green-600">
                        <span class="text-sm text-gray-700">รวม VAT</span>
                      </label>
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" x-model="config.additionalServiceIncludeWHT"
                          class="form-checkbox h-4 w-4 text-orange-600">
                        <span class="text-sm text-gray-700">รวมหัก ณ ที่จ่าย</span>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- เปอร์เซ็นต์หัก ณ ที่จ่ายเริ่มต้น -->
                <div class="mt-4">
                  <label class="block text-base font-semibold text-gray-800 mb-2">
                    เปอร์เซ็นต์หัก ณ ที่จ่ายเริ่มต้น
                  </label>
                  <div class="relative w-32">
                    <input type="number" x-model="config.defaultWHTPercentage" min="0" max="15" step="0.5"
                      placeholder="5"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-600">%</span>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">
                    เปอร์เซ็นต์เริ่มต้นสำหรับหัก ณ ที่จ่าย (ค่าปกติ: 3% หรือ 5%)
                  </p>
                </div>
              </div>
            </div>

            <!-- การตรวจสอบคิวรถ -->
            <div class="mt-6 pt-4 border-t border-gray-200">
              <!-- ปรับหัวข้อและเพิ่มกล่องคำอธิบายที่เห็นชัดกว่าเดิม -->
              <div class="flex items-center justify-start mb-3">
                <label class="text-base font-semibold text-gray-800 flex items-center">
                  <i class="fas fa-car-side mr-2 text-blue-500"></i>
                  ตั้งค่าการตรวจสอบคิวรถก่อนสร้างการจองใหม่
                </label>

                <!-- เพิ่มปุ่มดูตัวอย่างที่ชัดเจนกว่าไอคอนเดิม -->
                <button @click.prevent="openCarQueueModal()"
                  class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded-full text-sm flex items-center transition-all duration-200 hover:shadow-md">
                  <i class="fas fa-lightbulb mr-2"></i>
                  ตัวอย่าง
                </button>
              </div>

              <!-- เพิ่มกล่องคำอธิบายสั้นๆ เพื่อให้ผู้ใช้เข้าใจฟีเจอร์นี้คืออะไร -->
              <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-sm">
                <p class="text-blue-700">
                  <i class="fas fa-info-circle mr-1"></i>
                  <span class="font-medium">ฟีเจอร์นี้คืออะไร?</span>
                  ช่วยตรวจสอบว่ารถคันที่ลูกค้าต้องการจองนั้นว่างในช่วงเวลาที่ต้องการหรือไม่ ช่วยป้องกันการจองซ้ำซ้อน

                </p>
              </div>

              <!-- ส่วนเปิด/ปิดการใช้งานฟีเจอร์ -->
              <div
                class="flex items-center mb-4 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <div class="relative inline-block w-12 mr-3 align-middle">
                  <input type="checkbox" id="checkCarAvailability" x-model="config.ตรวจสอบคิวรถ"
                    class="peer absolute opacity-0 w-0 h-0" />
                  <div class="
        w-10 h-5 bg-gray-300 rounded-full peer-checked:bg-blue-500 
        transition-all duration-300 peer-focus:ring-2 peer-focus:ring-blue-300
      "></div>
                  <div class="
        absolute left-0 top-0 w-5 h-5 bg-white rounded-full shadow transform 
        peer-checked:translate-x-5 transition-all duration-300
      "></div>
                </div>
                <label for="checkCarAvailability" class="text-sm text-gray-700 font-medium cursor-pointer select-none">
                  เปิดใช้งานการตรวจสอบความพร้อมของรถ
                </label>
              </div>

              <!-- ตัวเลือกตั้งค่า (แสดงเมื่อเปิดใช้งานฟีเจอร์) -->
              <div x-show="config.ตรวจสอบคิวรถ" x-transition class="pl-4 border-l-2 border-blue-200 mt-4">
                <label class="block text-base font-medium text-gray-800 mb-2">
                  ระยะเวลาเตรียมรถหลังคืนรถในการจองก่อนหน้า:
                </label>

                <!-- ปรับ select เป็น radio buttons ที่มองเห็นชัดเจนกว่า -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                  <label
                    class="relative border rounded-lg p-3 flex items-center cursor-pointer hover:bg-blue-50 transition-colors"
                    :class="{'bg-blue-50 border-blue-500 ring-2 ring-blue-200': config.ระยะเวลาเตรียมรถ === '0'}">
                    <input type="radio" name="prepTime" value="0" x-model="config.ระยะเวลาเตรียมรถ" class="sr-only">
                    <div class="w-5 h-5 border border-gray-300 rounded-full flex items-center justify-center mr-3"
                      :class="{'border-blue-500': config.ระยะเวลาเตรียมรถ === '0'}">
                      <div x-show="config.ระยะเวลาเตรียมรถ === '0'" class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    </div>
                    <span>ส่งต่อได้ทันที (0 นาที)</span>
                  </label>

                  <!-- ต่อเนื่องจากส่วนก่อนหน้า -->
                  <label
                    class="relative border rounded-lg p-3 flex items-center cursor-pointer hover:bg-blue-50 transition-colors"
                    :class="{'bg-blue-50 border-blue-500 ring-2 ring-blue-200': config.ระยะเวลาเตรียมรถ === '30'}">
                    <input type="radio" name="prepTime" value="30" x-model="config.ระยะเวลาเตรียมรถ" class="sr-only">
                    <div class="w-5 h-5 border border-gray-300 rounded-full flex items-center justify-center mr-3"
                      :class="{'border-blue-500': config.ระยะเวลาเตรียมรถ === '30'}">
                      <div x-show="config.ระยะเวลาเตรียมรถ === '30'" class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    </div>
                    <span>30 นาที</span>
                  </label>

                  <label
                    class="relative border rounded-lg p-3 flex items-center cursor-pointer hover:bg-blue-50 transition-colors"
                    :class="{'bg-blue-50 border-blue-500 ring-2 ring-blue-200': config.ระยะเวลาเตรียมรถ === '60'}">
                    <input type="radio" name="prepTime" value="60" x-model="config.ระยะเวลาเตรียมรถ" class="sr-only">
                    <div class="w-5 h-5 border border-gray-300 rounded-full flex items-center justify-center mr-3"
                      :class="{'border-blue-500': config.ระยะเวลาเตรียมรถ === '60'}">
                      <div x-show="config.ระยะเวลาเตรียมรถ === '60'" class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    </div>
                    <span>1 ชั่วโมง</span>
                  </label>

                  <label
                    class="relative border rounded-lg p-3 flex items-center cursor-pointer hover:bg-blue-50 transition-colors"
                    :class="{'bg-blue-50 border-blue-500 ring-2 ring-blue-200': config.ระยะเวลาเตรียมรถ === '120'}">
                    <input type="radio" name="prepTime" value="120" x-model="config.ระยะเวลาเตรียมรถ" class="sr-only">
                    <div class="w-5 h-5 border border-gray-300 rounded-full flex items-center justify-center mr-3"
                      :class="{'border-blue-500': config.ระยะเวลาเตรียมรถ === '120'}">
                      <div x-show="config.ระยะเวลาเตรียมรถ === '120'" class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    </div>
                    <span>2 ชั่วโมง</span>
                  </label>
                </div>

                <!-- คำอธิบายเพิ่มเติมที่ชัดเจนมากขึ้น -->

              </div>

              <div class="flex justify-end">
                <button type="submit"
                  class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                  <i class="fas fa-save mr-2"></i>
                  บันทึกการตั้งค่า
                </button>
              </div>

            </div>


          </div>
        </div>

        <!-- ไอคอนสำหรับเปิด Modal -->


        <!-- Modal สำหรับตรวจสอบคิวรถ -->
        <div x-show="showCarQueueModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
          <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
              <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div
              class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-4 py-3">
                <h3 class="text-lg leading-6 font-semibold text-white flex items-center">
                  <i class="fas fa-lightbulb mr-2"></i>
                  ตัวอย่างการตรวจสอบคิวรถ (1 ชั่วโมง)
                </h3>
              </div>

              <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 text-sm text-gray-700 space-y-4">
                <div>
                  <p class="font-medium">📌 การจองเดิม:</p>
                  <ul class="ml-4 list-disc">
                    <li>วันที่รับรถ: 18/04/2568 เวลา 08:00</li>
                    <li>วันที่คืนรถ: 20/04/2568 เวลา 12:00</li>
                    <li>ตั้งค่าเวลาเตรียมรถ: 1 ชั่วโมง</li>
                  </ul>
                </div>

                <div>
                  <p class="font-medium mt-4">📅 การจองใหม่:</p>
                  <table class="w-full mt-2 text-left text-sm border border-gray-200">
                    <thead class="bg-gray-100">
                      <tr>
                        <th class="py-1.5 px-2 border-b">วันที่รับรถ</th>
                        <th class="py-1.5 px-2 border-b">สถานะ</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="py-1.5 px-2">18/04/2568 เวลา 08:00</td>
                        <td class="py-1.5 px-2 text-red-600">❌ ไม่ว่าง</td>
                      </tr>
                      <tr>
                        <td class="py-1.5 px-2">18/04/2568 เวลา 09:00</td>
                        <td class="py-1.5 px-2 text-green-600">✅ ว่าง</td>
                      </tr>
                      <tr>
                        <td class="py-1.5 px-2">20/04/2568 เวลา 12:00</td>
                        <td class="py-1.5 px-2 text-red-600">❌ ไม่ว่าง</td>
                      </tr>
                      <tr>
                        <td class="py-1.5 px-2">20/04/2568 เวลา 13:00</td>
                        <td class="py-1.5 px-2 text-green-600">✅ ว่าง</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <p class="mt-3 text-xs text-gray-500">
                  รถจะว่างเมื่อเลยจากเวลาคืนรถของการจองก่อนหน้าไปอีกอย่างน้อย 1 ชั่วโมง
                </p>
              </div>

              <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click.prevent="showCarQueueModal = false"
                  class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                  <i class="fas fa-times mr-2"></i>ปิด
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ส่วนจัดการสถานที่ -->
        <div id="location-settings" class="bg-gray-50 p-4 rounded-lg border border-gray-200"
          x-show="hasPermission('location-settings')">
          <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
            <i class="fas fa-map-marker-alt mr-3"></i>
            จัดการสถานที่
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-blue-700 mb-2">
                สถานที่รับรถ
                <span class="text-xs text-gray-500">(คั่นด้วยเครื่องหมาย , )</span>
              </label>
              <textarea x-model="config.สถานที่รับรถ" rows="3"
                placeholder="เช่น สนามบินเชียงใหม่, สถานีขนส่งอาเขต, สถานีรถไฟเชียงใหม่, หน้าร้าน"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
              <p class="text-xs text-gray-500 mt-1">
                กรอกสถานที่รับรถที่ใช้บ่อย โดยคั่นแต่ละสถานที่ด้วยเครื่องหมายจุลภาค (,)
              </p>
            </div>

            <div>
              <label class="block text-sm font-semibold text-blue-700 mb-2">
                สถานที่คืนรถ
                <span class="text-xs text-gray-500">(คั่นด้วยเครื่องหมาย , )</span>
              </label>
              <textarea x-model="config.สถานที่คืนรถ" rows="3"
                placeholder="เช่น สนามบินเชียงใหม่, สถานีขนส่งอาเขต, สถานีรถไฟเชียงใหม่, หน้าร้าน"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
              <p class="text-xs text-gray-500 mt-1">
                กรอกสถานที่คืนรถที่ใช้บ่อย โดยคั่นแต่ละสถานที่ด้วยเครื่องหมายจุลภาค (,)
              </p>
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>

        </div>

        <!-- ส่วนตั้งค่าข้อความสรุปรายการเช่า -->
        <div id="summary-message-settings" class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6"
          x-show="hasPermission('summary-message-settings')">
          <h3 class="text-lg font-semibold text-blue-600 mb-4 flex items-center">
            <i class="fas fa-receipt mr-2"></i>ตั้งค่าข้อความสรุปรายการเช่า
          </h3>

          <!-- คำอธิบายแยกตามประเภท -->
          <div class="bg-blue-50 border border-blue-200 p-4 mb-4 rounded-lg">
            <h4 class="font-semibold text-blue-800 mb-2 text-sm flex items-center">
              <i class="fas fa-info-circle mr-2"></i>
              📘 วิธีใช้งาน Placeholders
            </h4>
            <div class="space-y-2 text-sm text-blue-900">
              <div>
                <strong class="text-blue-700">🔵 ปุ่มสีน้ำเงิน/ม่วง/เขียว/ส้ม</strong> - ค่าข้อมูลจริง
                <code>{{'{{'}}ชื่อคีย์{{'}}'}}</code>
                <p class="text-xs text-blue-700 ml-4 mt-1">→ จะถูกแทนที่ด้วยข้อมูลจริงจากรายการเช่า เช่น
                  {{'{{'}}ชื่อลูกค้า{{'}}'}} → "สมชาย ใจดี"</p>
              </div>
              <div>
                <strong class="text-indigo-700">🟣 ปุ่มสีม่วงอมน้ำเงิน (Indigo)</strong> - คีย์การแปลภาษา
                <code>[[ชื่อคีย์]]</code>
                <p class="text-xs text-indigo-700 ml-4 mt-1">→ จะถูกแทนที่ด้วยข้อความตามภาษาที่เลือก เช่น
                  [[customer_name]] → "Customer Name" (EN) หรือ "ชื่อลูกค้า" (TH)</p>
              </div>
            </div>
          </div>

          <!-- กลุ่มที่ 1: ค่าข้อมูลจริง -->
          <div class="mb-4">
            <h4 class="font-semibold text-gray-800 mb-2 text-sm flex items-center bg-gray-100 px-3 py-2 rounded">
              <i class="fas fa-database mr-2 text-blue-600"></i>
              📊 ค่าข้อมูลจริง (Data Values) - แทนที่ด้วยข้อมูลจากรายการเช่า
            </h4>
            <div class="flex flex-wrap gap-2 mb-3">
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ชื่อลูกค้า}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ชื่อลูกค้า
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{เบอร์โทรศัพท์}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                เบอร์โทรศัพท์
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{หมายเลขการจอง}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                หมายเลขการจอง
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{รถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                รถที่จอง
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ทะเบียนรถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ทะเบียนรถ
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{วันที่เช่า}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                วันที่เช่า
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{วันที่คืน}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                วันที่คืน
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{จำนวนวัน}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                จำนวนวัน
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{เวลารับรถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                เวลารับรถ
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{เวลาคืนรถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                เวลาคืนรถ
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{สถานที่รับรถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                สถานที่รับรถ
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{สถานที่คืนรถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                สถานที่คืนรถ
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ราคาต่อวัน}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ราคาต่อวัน
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ค่าเช่ารวมทั้งหมด}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ค่าเช่ารวมทั้งหมด
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ค่ามัดจำคิวรถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ค่ามัดจำคิวรถ
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '{{เงินประกันความเสียหาย}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                เงินประกันความเสียหาย
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ค่าบริการเพิ่มเติม}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ค่าบริการเพิ่มเติม
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '{{รวมยอดชำระวันรับรถ}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                รวมยอดชำระวันรับรถ
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ลิงก์สัญญาเช่า}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ลิงก์สัญญาเช่า
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '{{วันที่เวลาปัจจุบัน}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                วันที่เวลาปัจจุบัน
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ชื่อบริษัท}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ชื่อบริษัท
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ชื่อธนาคาร}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ชื่อธนาคาร
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '{{หมายเลขบัญชีธนาคาร}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                หมายเลขบัญชีธนาคาร
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ชื่อบัญชี}}')"
                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
                ชื่อบัญชี
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ชั่วโมงล่วงเวลา}}')"
                class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs">
                ชั่วโมงล่วงเวลา
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ค่าล่วงเวลา}}')"
                class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs">
                ค่าล่วงเวลา
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ค่าคาร์ซีท}}')"
                class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs">
                ค่าคาร์ซีท
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ค่าประกันเสริมรวม}}')"
                class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs">
                ค่าประกันเสริม
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '{{จำนวนวันประกันเสริม}}')"
                class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs">
                จำนวนวันประกันเสริม
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ราคาประกันเสริมต่อวัน}}')"
                class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs">
                ราคาประกันเสริมต่อวัน
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{จำนวนเงินก่อนVAT}}')"
                class="px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs">
                จำนวนเงินก่อน VAT
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{VAT7เปอร์เซ็นต์}}')"
                class="px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs">
                VAT 7%
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ยอดรวมVAT}}')"
                class="px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs">
                ยอดรวม VAT
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{สูตรค่าเช่า}}')"
                class="px-2 py-1 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded text-xs">
                สูตรค่าเช่า (วัน x ราคา = ยอด)
              </button>

              <!-- ส่วนลด (ใหม่) -->
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '{{ส่วนลด}}')"
                class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs">
                ส่วนลด ⭐
              </button>

              <!-- VAT/WHT Shorthand (ใหม่) -->
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[VAT]]')"
                class="px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs">
                [[VAT]] (สั้น) ⭐
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[WHT]]')"
                class="px-2 py-1 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded text-xs">
                [[WHT]] (สั้น) ⭐
              </button>
            </div>
          </div>

          <!-- กลุ่มที่ 2: คีย์การแปลภาษา -->
          <div class="mb-4">
            <h4 class="font-semibold text-gray-800 mb-2 text-sm flex items-center bg-indigo-100 px-3 py-2 rounded">
              <i class="fas fa-language mr-2 text-indigo-600"></i>
              🌐 คีย์การแปลภาษา (Translation Keys) - แทนที่ด้วยข้อความตามภาษาที่เลือก
            </h4>
            <div class="flex flex-wrap gap-2 mb-3">
              <!-- คีย์การแปลภาษา (Translation Keys) -->
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '[[rental_summary_title]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[หัวข้อสรุป]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[booking_number]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[หมายเลขการจอง]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[document_date]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[วันที่เอกสาร]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[customer_info]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ข้อมูลลูกค้า]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[customer_name]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ชื่อลูกค้า]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[phone_number]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[เบอร์โทรศัพท์]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[car_info]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ข้อมูลรถ]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[car_model]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[รุ่นรถ]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[license_plate]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ทะเบียนรถ]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[rental_period]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ระยะเวลาเช่า]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[pickup_date]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[วันที่รับรถ]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[return_date]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[วันที่คืนรถ]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[time]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[เวลา]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[rental_days]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[จำนวนวันเช่า]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[pickup_location]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[สถานที่รับรถ]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[return_location]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[สถานที่คืนรถ]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[payment_info]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ข้อมูลการชำระเงิน]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[daily_rate]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ราคาต่อวัน]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[total_rental]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ค่าเช่ารวม]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[booking_deposit]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ค่ามัดจำการจอง]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[security_deposit]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[เงินประกันความเสียหาย]]
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '[[additional_service]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ค่าบริการเพิ่มเติม]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[total_amount]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ยอดรวมทั้งหมด]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[payment_method]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[วิธีการชำระเงิน]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[bank_name]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ชื่อธนาคาร]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[account_number]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[หมายเลขบัญชี]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[account_name]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ชื่อบัญชี]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[rental_contract]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[สัญญาเช่า]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[issued_by]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ออกโดย]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[hours]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ชั่วโมง]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[extra_hours_info]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ข้อมูลชั่วโมงเพิ่ม]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[days]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[วัน]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[overtime_hours]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ชั่วโมงล่วงเวลา]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[overtime_fee]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ค่าล่วงเวลา]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[car_seat_fee]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ค่าคาร์ซีท]]
              </button>
              <button type="button"
                @click.prevent="insertMessagePlaceholder('summaryMessage', '[[additional_insurance_fee]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ค่าประกันเสริม]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[insurance_days]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[จำนวนวันประกัน]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[amount_before_vat]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[จำนวนก่อน VAT]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[vat_7_percent]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[VAT 7%]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[total_with_vat]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ยอดรวม VAT]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[base_rental_cost]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ค่าเช่าพื้นฐาน]]
              </button>
              <button type="button" @click.prevent="insertMessagePlaceholder('summaryMessage', '[[discount]]')"
                class="px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs">
                [[ส่วนลด]]
              </button>
            </div>
          </div>

          <!-- คำอธิบายการซ่อนอัตโนมัติ -->
          <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-orange-400 p-4 mb-4 rounded-r-lg">
            <div class="flex items-start">
              <i class="fas fa-lightbulb text-orange-500 text-xl mr-3 mt-1"></i>
              <div>
                <h4 class="font-semibold text-orange-800 mb-2 flex items-center">
                  💡 ข้อมูลที่จะซ่อนอัตโนมัติเมื่อไม่มีค่า
                </h4>
                <p class="text-sm text-orange-700 leading-relaxed">
                  <strong>ส่วนลด</strong> | <strong>ค่าล่วงเวลา / ชั่วโมงล่วงเวลา</strong> |
                  <strong>ค่าคาร์ซีท</strong> | <strong>ค่าประกันเสริม</strong> | <strong>[[VAT]] และ
                    {{จำนวนเงินก่อนVAT}}</strong> | <strong>[[WHT]]</strong>
                </p>
                <p class="text-xs text-orange-600 mt-2 italic">
                  <i class="fas fa-info-circle mr-1"></i>
                  ข้อมูลอื่นๆ จะแสดงเป็น "-" หากไม่มีค่า
                </p>
              </div>
            </div>
          </div>

          <!-- คำอธิบาย VAT/WHT Shorthand -->
          <div class="bg-blue-50 border border-blue-200 p-3 mb-3 rounded-lg">
            <h4 class="font-semibold text-blue-800 mb-2 text-sm flex items-center">
              <i class="fas fa-star text-yellow-500 mr-2"></i>
              ✨ รูปแบบสั้น (Shorthand) - ใหม่!
            </h4>
            <div class="text-xs text-blue-700 space-y-1">
              <p>• <code class="bg-blue-100 px-1 rounded">[[VAT]]</code> = "ภาษีมูลค่าเพิ่ม 7% (252 บาท)"
                หรือซ่อนถ้าไม่มี</p>
              <p>• <code class="bg-blue-100 px-1 rounded">[[WHT]]</code> = "หัก ณ ที่จ่าย 5% (180 บาท)"
                หรือซ่อนถ้าไม่มี</p>
            </div>
          </div>

          <div class="flex space-x-2 mb-3">
            <button type="button" @click.prevent="clearMessageTemplate('summaryMessage')"
              class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm flex items-center">
              <i class="fas fa-eraser mr-1"></i> ล้างข้อความ
            </button>
            <button type="button" @click.prevent="resetMessageTemplate('summaryMessage')"
              class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded text-sm flex items-center">
              <i class="fas fa-undo mr-1"></i> คืนค่าเริ่มต้น
            </button>
            <button type="button" @click.prevent="previewMessage('summaryMessage')"
              class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-sm flex items-center">
              <i class="fas fa-eye mr-1"></i> แสดงตัวอย่าง
            </button>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">ข้อความสรุปรายการเช่า</label>
            <textarea x-model="config.summaryMessageTemplate" rows="10"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            <p class="text-xs text-gray-500 mt-1">สามารถปรับแต่งข้อความได้ทั้งหมด ยกเว้นที่อยู่ในเครื่องหมาย {{...}}
            </p>
          </div>

          <!-- ปุ่มบันทึก -->
          <div class="flex justify-end">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>

        </div>

        <!-- ส่วนตั้งค่าข้อความเสนอราคา -->
        <div id="quote-message-settings" class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6"
          x-show="hasPermission('quote-message-settings')">
          <h3 class="text-lg font-semibold text-blue-600 mb-4 flex items-center">
            <i class="fas fa-file-invoice-dollar mr-2"></i>ตั้งค่าข้อความเสนอราคา
          </h3>

          <p class="text-sm text-gray-500 mb-3">
            <i class="fas fa-info-circle mr-1 text-blue-500"></i>
            คลิกเลือกคำที่ต้องการแทรกลงในข้อความ ระบบจะแทนที่ด้วยข้อมูลจริงโดยอัตโนมัติ
          </p>

          <div class="flex flex-wrap gap-2 mb-3">
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{รถ}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              รถ
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{วันที่รับรถ}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              วันที่รับรถ
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{เวลารับรถ}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              เวลารับรถ
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{วันที่คืนรถ}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              วันที่คืนรถ
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{เวลาคืนรถ}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              เวลาคืนรถ
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{จำนวนวัน}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              จำนวนวัน
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{ราคาต่อวัน}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              ราคาต่อวัน
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{ค่าเช่ารวมทั้งหมด}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              ค่าเช่ารวมทั้งหมด
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{ค่าประกันความเสียหาย}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              ค่าประกันความเสียหาย
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{ค่ามัดจำคิวรถ}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              ค่ามัดจำคิวรถ
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{ส่วนลด}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              ส่วนลด
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{รวมชำระวันรับรถ}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              รวมชำระวันรับรถ
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{ชื่อบริษัท}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              ชื่อบริษัท
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{เบอร์โทรศัพท์}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              เบอร์โทรศัพท์
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{อีเมล}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              อีเมล
            </button>
            <button type="button" @click.prevent="insertMessagePlaceholder('quoteMessage', '{{ที่อยู่}}')"
              class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs">
              ที่อยู่
            </button>
          </div>

          <div class="flex space-x-2 mb-3">
            <button type="button" @click.prevent="clearMessageTemplate('quoteMessage')"
              class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm flex items-center">
              <i class="fas fa-eraser mr-1"></i> ล้างข้อความ
            </button>
            <button type="button" @click.prevent="resetMessageTemplate('quoteMessage')"
              class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded text-sm flex items-center">
              <i class="fas fa-undo mr-1"></i> คืนค่าเริ่มต้น
            </button>
            <button type="button" @click.prevent="previewMessage('quoteMessage')"
              class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-sm flex items-center">
              <i class="fas fa-eye mr-1"></i> แสดงตัวอย่าง
            </button>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">ข้อความเสนอราคา</label>
            <textarea x-model="config.quoteMessageTemplate" rows="10"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            <p class="text-xs text-gray-500 mt-1">สามารถปรับแต่งข้อความได้ทั้งหมด ยกเว้นที่อยู่ในเครื่องหมาย {{...}}
            </p>
          </div>

          <!-- ปุ่มบันทึก -->
          <div class="flex justify-end">
            <button type="submit"
              class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              บันทึกการตั้งค่า
            </button>
          </div>
        </div>

        <!-- Modal แสดงตัวอย่างข้อความ -->
        <div x-show="showMessagePreviewModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
          <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
              <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div
              class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-4 py-3">
                <h3 class="text-lg leading-6 font-semibold text-white flex items-center">
                  <i class="fas fa-eye mr-2"></i>
                  ตัวอย่างข้อความ
                </h3>
              </div>

              <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="mt-3 text-center sm:mt-0 sm:text-left">
                  <div class="mt-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-800 whitespace-pre-line" x-html="messagePreviewContent"></p>
                  </div>
                </div>
              </div>

              <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" @click="showMessagePreviewModal = false"
                  class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                  <i class="fas fa-times mr-2"></i>ปิด
                </button>
              </div>
            </div>
          </div>
        </div>


      </form>
    </div>



    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <i class="fas fa-file-alt mr-2 text-green-600"></i>จัดการแปลข้อความสรุปสัญญาเช่า
      </h2>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">เลือกคีย์ที่ต้องการแก้ไข</label>
        <div class="flex space-x-2">
          <select x-model="selectedSummaryKey" @change="loadSummaryTranslationByKey()"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
            <option value="">-- เลือกคีย์ --</option>
            <template x-if="summaryTranslationKeys && summaryTranslationKeys.length > 0">
              <template x-for="(key, index) in summaryTranslationKeys" :key="index">
                <option :value="key" x-text="key"></option>
              </template>
            </template>
          </select>
          <button @click.prevent="loadSummaryTranslationKeys()" type="button"
            class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <p class="text-sm text-gray-500 mt-1">เลือกคีย์ที่ต้องการแก้ไขคำแปล จากนั้นทำการแก้ไขและบันทึกข้อมูล</p>
      </div>

      <div class="flex justify-end space-x-3 mt-4 mb-4">
        <button @click.prevent="translateAllSummary()" type="button"
          :disabled="!currentSummaryTranslation.th || isTranslatingSummary"
          class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 focus:outline-none disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center">
          <i class="fas fa-language mr-2"></i>
          <span x-text="isTranslatingSummary ? 'กำลังแปล...' : 'แปลอัตโนมัติ'"></span>
        </button>
        <button @click.prevent="saveSummaryTranslation()" type="button" :disabled="!selectedSummaryKey"
          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center">
          <i class="fas fa-save mr-2"></i>บันทึกคำแปล
        </button>
      </div>

      <div x-show="selectedSummaryKey" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div class="col-span-full">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <span class="inline-flex items-center"><img src="https://flagcdn.com/24x18/th.png" class="mr-2"> ภาษาไทย
                (th) <span class="text-red-500 ml-1">*</span></span>
            </label>
            <textarea x-model="currentSummaryTranslation.th" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/gb.png" class="mr-2"> ภาษาอังกฤษ (en)</span></label>
            <textarea x-model="currentSummaryTranslation.en" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/cn.png" class="mr-2"> ภาษาจีน (zh-CN)</span></label>
            <textarea x-model="currentSummaryTranslation['zh-CN']" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/kr.png" class="mr-2"> ภาษาเกาหลี (ko)</span></label>
            <textarea x-model="currentSummaryTranslation.ko" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/ru.png" class="mr-2"> ภาษารัสเซีย (ru)</span></label>
            <textarea x-model="currentSummaryTranslation.ru" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/my.png" class="mr-2"> ภาษามาเลเซีย (ms)</span></label>
            <textarea x-model="currentSummaryTranslation.ms" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/jp.png" class="mr-2"> ภาษาญี่ปุ่น (ja)</span></label>
            <textarea x-model="currentSummaryTranslation.ja" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/il.png" class="mr-2"> ภาษาฮิบรู (he)</span></label>
            <textarea x-model="currentSummaryTranslation.he" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/fr.png" class="mr-2"> ภาษาฝรั่งเศส (fr)</span></label>
            <textarea x-model="currentSummaryTranslation.fr" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/tr.png" class="mr-2"> ภาษาตุรกี (tr)</span></label>
            <textarea x-model="currentSummaryTranslation.tr" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/es.png" class="mr-2"> ภาษาสเปน (es)</span></label>
            <textarea x-model="currentSummaryTranslation.es" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/it.png" class="mr-2"> ภาษาอิตาลี (it)</span></label>
            <textarea x-model="currentSummaryTranslation.it" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/la.png" class="mr-2"> ภาษาลาว (lo)</span></label>
            <textarea x-model="currentSummaryTranslation.lo" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/mm.png" class="mr-2"> ภาษาพม่า (my)</span></label>
            <textarea x-model="currentSummaryTranslation.my" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/vn.png" class="mr-2"> ภาษาเวียดนาม (vi)</span></label>
            <textarea x-model="currentSummaryTranslation.vi" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/de.png" class="mr-2"> ภาษาเยอรมัน (de)</span></label>
            <textarea x-model="currentSummaryTranslation.de" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/tw.png" class="mr-2"> ภาษาจีน (zh-TW)</span></label>
            <textarea x-model="currentSummaryTranslation['zh-TW']" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><span class="inline-flex items-center"><img
                  src="https://flagcdn.com/24x18/id.png" class="mr-2"> ภาษาอินโดนีเซีย (id)</span></label>
            <textarea x-model="currentSummaryTranslation.id" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>

        </div>
      </div>
    </div>










    <!-- ส่วนจัดการแปลภาษา -->
    <div id="translation-settings" class="bg-white rounded-lg shadow-md p-6 mb-6"
      x-show="hasPermission('translation-settings')">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <i class="fas fa-language mr-2 text-blue-600"></i>จัดการแปลภาษาสัญญาเช่า
      </h2>



      <div class="mb-6 border-b border-gray-200 bg-white rounded-t-lg">
        <ul class="flex flex-wrap text-sm font-semibold text-center">
          <li class="mr-2">
            <a href="#" @click.prevent="translationMode = 'edit'" :class="[
           'inline-block p-4 rounded-t-lg transition duration-200',
           translationMode === 'edit' 
             ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' 
             : 'text-gray-500 hover:text-blue-600 hover:border-blue-300 border-b-2 border-transparent'
         ]">
              ✏️ แก้ไขคำแปล
            </a>
          </li>
          <li class="mr-2">
            <a href="#" @click.prevent="translationMode = 'create'" :class="[
           'inline-block p-4 rounded-t-lg transition duration-200',
           translationMode === 'create' 
             ? 'text-green-600 border-b-2 border-green-600 bg-green-50' 
             : 'text-gray-500 hover:text-green-600 hover:border-green-300 border-b-2 border-transparent'
         ]">
              ➕ สร้างคำแปล
            </a>
          </li>
          <li class="mr-2">
            <a href="#" @click.prevent="translationMode = 'delete'" :class="[
           'inline-block p-4 rounded-t-lg transition duration-200',
           translationMode === 'delete' 
             ? 'text-red-600 border-b-2 border-red-600 bg-red-50' 
             : 'text-gray-500 hover:text-red-600 hover:border-red-300 border-b-2 border-transparent'
         ]">
              🗑️ ลบคำแปล
            </a>
          </li>
        </ul>
      </div>


      <!-- ส่วนแก้ไขคำแปลที่มีอยู่แล้ว -->
      <div x-show="translationMode === 'edit'" x-cloak>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">เลือกคีย์ที่ต้องการแก้ไข</label>
          <div class="flex space-x-2">
            <select x-model="selectedTranslationKey" @change="loadTranslationKey()"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <option value="">-- เลือกคีย์ --</option>
              <template x-for="key in translationKeys" :key="key">
                <option :value="key" x-text="key"></option>
              </template>
            </select>
            <button @click.prevent="loadTranslationKey()" type="button"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <p class="text-sm text-gray-500 mt-1">เลือกคีย์ที่ต้องการแก้ไขคำแปล จากนั้นทำการแก้ไขและบันทึกข้อมูล</p>
        </div>


        <!-- ปุ่มกดแปลและบันทึก -->
        <div class="flex justify-end space-x-3 mt-4">
          <button @click.prevent="translateAll('edit')" type="button"
            :disabled="!(currentTranslation && currentTranslation.th)"
            class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 focus:outline-none disabled:bg-gray-300 disabled:cursor-not-allowed">
            <i class="fas fa-language mr-2"></i>แปลอัตโนมัติ
          </button>
          <button @click.prevent="saveTranslation('edit')" type="button"
            :disabled="!(currentTranslation && currentTranslation.th)"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none disabled:bg-gray-300 disabled:cursor-not-allowed">
            <i class="fas fa-save mr-2"></i>บันทึกคำแปล
          </button>
        </div>


        <!-- ฟอร์มสำหรับแก้ไขคำแปล -->
        <div x-show="selectedTranslationKey && currentTranslation" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- ภาษาไทย - เป็นภาษาหลัก -->
            <div class="col-span-full">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/th.png" class="mr-2"> ภาษาไทย (Thai) <span
                    class="text-red-500 ml-1">*</span>
                </span>
              </label>
              <textarea x-model="currentTranslation.th" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="คำแปลภาษาไทย"></textarea>
            </div>

            <!-- ภาษาอังกฤษ -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/gb.png" class="mr-2"> ภาษาอังกฤษ (English)
                </span>
              </label>
              <textarea x-model="currentTranslation.en" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="English translation"></textarea>
            </div>

            <!-- ภาษาจีน (ย่อ) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/cn.png" class="mr-2"> ภาษาจีน (จีนย่อ)
                </span>
              </label>
              <textarea x-model="currentTranslation['zh-CN']" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="简体中文翻译"></textarea>
            </div>

            <!-- ภาษาเกาหลี -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/kr.png" class="mr-2"> ภาษาเกาหลี (Korean)
                </span>
              </label>
              <textarea x-model="currentTranslation.ko" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="한국어 번역"></textarea>
            </div>

            <!-- ภาษารัสเซีย -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/ru.png" class="mr-2"> ภาษารัสเซีย (Russian)
                </span>
              </label>
              <textarea x-model="currentTranslation.ru" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Русский перевод"></textarea>
            </div>

            <!-- ภาษามาเลเซีย -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/my.png" class="mr-2"> ภาษามาเลเซีย (Malay)
                </span>
              </label>
              <textarea x-model="currentTranslation.ms" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Terjemahan Bahasa Melayu"></textarea>
            </div>

            <!-- ภาษาญี่ปุ่น -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/jp.png" class="mr-2"> ภาษาญี่ปุ่น (Japanese)
                </span>
              </label>
              <textarea x-model="currentTranslation.ja" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="日本語翻訳"></textarea>
            </div>

            <!-- ภาษาฮิบรู -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/il.png" class="mr-2"> ภาษาฮิบรู (Hebrew)
                </span>
              </label>
              <textarea x-model="currentTranslation.he" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="תרגום עברי" dir="rtl"></textarea>
            </div>

            <!-- ภาษาฝรั่งเศส -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/fr.png" class="mr-2"> ภาษาฝรั่งเศส (French)
                </span>
              </label>
              <textarea x-model="currentTranslation.fr" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Traduction française"></textarea>
            </div>

            <!-- ภาษาตุรกี -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/tr.png" class="mr-2"> ภาษาตุรกี (Turkish)
                </span>
              </label>
              <textarea x-model="currentTranslation.tr" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Türkçe çeviri"></textarea>
            </div>

            <!-- ภาษาสเปน -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/es.png" class="mr-2"> ภาษาสเปน (Spanish)
                </span>
              </label>
              <textarea x-model="currentTranslation.es" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Traducción española"></textarea>
            </div>

            <!-- ภาษาอิตาลี -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/it.png" class="mr-2"> ภาษาอิตาลี (Italian)
                </span>
              </label>
              <textarea x-model="currentTranslation.it" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Traduzione italiana"></textarea>
            </div>

            <!-- ภาษาลาว -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/la.png" class="mr-2"> ภาษาลาว (Lao)
                </span>
              </label>
              <textarea x-model="currentTranslation.lo" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="ການແປພາສາລາວ"></textarea>
            </div>

            <!-- ภาษาพม่า -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/mm.png" class="mr-2"> ภาษาพม่า (Burmese)
                </span>
              </label>
              <textarea x-model="currentTranslation.my" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="မြန်မာဘာသာပြန်ဆိုမှု"></textarea>
            </div>

            <!-- ภาษาเวียดนาม -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/vn.png" class="mr-2"> ภาษาเวียดนาม (Vietnamese)
                </span>
              </label>
              <textarea x-model="currentTranslation.vi" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Bản dịch tiếng Việt"></textarea>
            </div>

            <!-- ภาษาเยอรมัน -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/de.png" class="mr-2"> ภาษาเยอรมัน (German)
                </span>
              </label>
              <textarea x-model="currentTranslation.de" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Deutsche Übersetzung"></textarea>
            </div>

            <!-- ภาษาจีน (ไต้หวัน) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/tw.png" class="mr-2"> ภาษาจีน (ไต้หวัน)
                </span>
              </label>
              <textarea x-model="currentTranslation['zh-TW']" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="繁體中文翻譯"></textarea>
            </div>

            <!-- ภาษาอินโดนีเซีย -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/id.png" class="mr-2"> ภาษาอินโดนีเซีย (Indonesian)
                </span>
              </label>
              <textarea x-model="currentTranslation.id" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Terjemahan Bahasa Indonesia"></textarea>
            </div>
          </div>


        </div>


      </div>

      <!-- ส่วนสร้างคำแปลใหม่ -->
      <div x-show="translationMode === 'create'" x-cloak>
        <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
          <div class="flex items-start">
            <div class="flex-shrink-0 pt-0.5">
              <i class="fas fa-info-circle text-blue-600 text-lg"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-blue-800">สร้างคำแปลใหม่</h3>
              <div class="mt-2 text-sm text-blue-700">
                <p>กรุณากรอกคำแปลในภาษาไทยก่อน จากนั้นกดปุ่ม "แปลอัตโนมัติ" เพื่อแปลเป็นภาษาอื่นๆ หรือกรอกด้วยตนเอง
                </p>
                <p class="mt-1">คีย์ใหม่จะถูกสร้างต่อจากคีย์ล่าสุดในระบบ</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">คีย์ใหม่ที่จะสร้าง</label>
          <input type="text" x-model="newTranslationKey"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-100">
          <p class="text-sm text-gray-500 mt-1">คีย์ใหม่จะถูกสร้างอัตโนมัติเมื่อบันทึก
            หรือสามารถระบุชื่อคีย์ได้ตามต้องการ</p>
        </div>

        <!-- ปุ่มกดแปลและบันทึก -->
        <div class="flex justify-end space-x-3 mt-4">
          <button @click.prevent="translateAll('create')" type="button" :disabled="!newTranslation.th"
            class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 focus:outline-none disabled:bg-gray-300 disabled:cursor-not-allowed">
            <i class="fas fa-language mr-2"></i>แปลอัตโนมัติ
          </button>
          <button @click.prevent="saveTranslation('create')" type="button" :disabled="!newTranslation.th"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none disabled:bg-gray-300 disabled:cursor-not-allowed">
            <i class="fas fa-save mr-2"></i>บันทึกคำแปล
          </button>
        </div>


        <!-- ฟอร์มสำหรับเพิ่มคำแปลใหม่ -->
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- ภาษาไทย - เป็นภาษาหลัก -->
            <div class="col-span-full">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/th.png" class="mr-2"> ภาษาไทย (Thai) <span
                    class="text-red-500 ml-1">*</span>
                </span>
              </label>
              <textarea x-model="newTranslation.th" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="คำแปลภาษาไทย"></textarea>
            </div>

            <!-- ภาษาอังกฤษ -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/gb.png" class="mr-2"> ภาษาอังกฤษ (English)
                </span>
              </label>
              <textarea x-model="newTranslation.en" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="English translation"></textarea>
            </div>

            <!-- ภาษาจีน (ย่อ) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/cn.png" class="mr-2"> ภาษาจีน (จีนย่อ)
                </span>
              </label>
              <textarea x-model="newTranslation['zh-CN']" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="简体中文翻译"></textarea>
            </div>

            <!-- ภาษาเกาหลี -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/kr.png" class="mr-2"> ภาษาเกาหลี (Korean)
                </span>
              </label>
              <textarea x-model="newTranslation.ko" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="한국어 번역"></textarea>
            </div>

            <!-- ภาษารัสเซีย -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/ru.png" class="mr-2"> ภาษารัสเซีย (Russian)
                </span>
              </label>
              <textarea x-model="newTranslation.ru" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Русский перевод"></textarea>
            </div>

            <!-- ภาษามาเลเซีย -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/my.png" class="mr-2"> ภาษามาเลเซีย (Malay)
                </span>
              </label>
              <textarea x-model="newTranslation.ms" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Terjemahan Bahasa Melayu"></textarea>
            </div>

            <!-- ภาษาญี่ปุ่น -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/jp.png" class="mr-2"> ภาษาญี่ปุ่น (Japanese)
                </span>
              </label>
              <textarea x-model="newTranslation.ja" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="日本語翻訳"></textarea>
            </div>

            <!-- ภาษาฮิบรู -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/il.png" class="mr-2"> ภาษาฮิบรู (Hebrew)
                </span>
              </label>
              <textarea x-model="newTranslation.he" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="תרגום עברי" dir="rtl"></textarea>
            </div>

            <!-- ภาษาฝรั่งเศส -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/fr.png" class="mr-2"> ภาษาฝรั่งเศส (French)
                </span>
              </label>
              <textarea x-model="newTranslation.fr" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Traduction française"></textarea>
            </div>

            <!-- ภาษาตุรกี -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/tr.png" class="mr-2"> ภาษาตุรกี (Turkish)
                </span>
              </label>
              <textarea x-model="newTranslation.tr" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Türkçe çeviri"></textarea>
            </div>

            <!-- ภาษาสเปน -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/es.png" class="mr-2"> ภาษาสเปน (Spanish)
                </span>
              </label>
              <textarea x-model="newTranslation.es" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Traducción española"></textarea>
            </div>

            <!-- ภาษาอิตาลี -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/it.png" class="mr-2"> ภาษาอิตาลี (Italian)
                </span>
              </label>
              <textarea x-model="newTranslation.it" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Traduzione italiana"></textarea>
            </div>

            <!-- ภาษาลาว -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/la.png" class="mr-2"> ภาษาลาว (Lao)
                </span>
              </label>
              <textarea x-model="newTranslation.lo" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="ການແປພາສາລາວ"></textarea>
            </div>

            <!-- ภาษาพม่า -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/mm.png" class="mr-2"> ภาษาพม่า (Burmese)
                </span>
              </label>
              <textarea x-model="newTranslation.my" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="မြန်မာဘာသာပြန်ဆိုမှု"></textarea>
            </div>

            <!-- ภาษาเวียดนาม -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/vn.png" class="mr-2"> ภาษาเวียดนาม (Vietnamese)
                </span>
              </label>
              <textarea x-model="newTranslation.vi" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Bản dịch tiếng Việt"></textarea>
            </div>

            <!-- ภาษาเยอรมัน -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/de.png" class="mr-2"> ภาษาเยอรมัน (German)
                </span>
              </label>
              <textarea x-model="newTranslation.de" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Deutsche Übersetzung"></textarea>
            </div>

            <!-- ภาษาจีน (ไต้หวัน) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/tw.png" class="mr-2"> ภาษาจีน (ไต้หวัน)
                </span>
              </label>
              <textarea x-model="newTranslation['zh-TW']" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="繁體中文翻譯"></textarea>
            </div>

            <!-- ภาษาอินโดนีเซีย -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="inline-flex items-center">
                  <img src="https://flagcdn.com/24x18/id.png" class="mr-2"> ภาษาอินโดนีเซีย (Indonesian)
                </span>
              </label>
              <textarea x-model="newTranslation.id" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Terjemahan Bahasa Indonesia"></textarea>
            </div>
          </div>


        </div>

      </div>


      <!-- ส่วนแก้ไขการแสดงผลในโหมดลบคีย์ -->
      <div x-show="translationMode === 'delete'" x-cloak>
        <div class="mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
          <div class="flex items-start">
            <div class="flex-shrink-0 pt-0.5">
              <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">คำเตือน: การลบคีย์แปลภาษา</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>การลบคีย์จะลบคำแปลทั้งหมดที่เกี่ยวข้องกับคีย์นั้นออกจากระบบโดยถาวร</p>
                <p class="mt-1">กรุณาตรวจสอบให้แน่ใจว่าคุณต้องการลบคีย์นี้จริงๆ</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">เลือกคีย์ที่ต้องการลบ</label>
          <div class="flex space-x-2">
            <select x-model="selectedKeyToDelete" @change="loadKeyInfoForDeletion()"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
              <option value="">-- เลือกคีย์ --</option>
              <template x-for="key in translationKeys" :key="key">
                <option :value="key" x-text="key"></option>
              </template>
            </select>
            <button @click.prevent="loadKeyInfoForDeletion()" type="button"
              class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>

        <!-- เพิ่มการแสดงข้อมูลเมื่อยังไม่ได้เลือกคีย์ -->
        <div x-show="!selectedKeyToDelete && translationKeys.length > 0" class="bg-blue-50 p-4 rounded-lg text-center">
          <p class="text-blue-700">กรุณาเลือกคีย์ที่ต้องการลบจากรายการด้านบน</p>
        </div>

        <!-- เพิ่มการแสดงข้อมูลเมื่อไม่มีคีย์ในระบบ -->
        <div x-show="translationKeys.length === 0" class="bg-yellow-50 p-4 rounded-lg text-center">
          <p class="text-yellow-700">ไม่พบรายการคีย์ในระบบ</p>
        </div>

        <div x-show="keyInfoForDeletion.loaded && selectedKeyToDelete"
          class="mb-6 p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
          <h3 class="text-lg font-medium text-gray-800 mb-2">ข้อมูลคีย์ที่จะลบ</h3>

          <div class="grid grid-cols-1 gap-4">
            <div>
              <p class="text-sm font-medium text-gray-500">คีย์:</p>
              <p class="text-md font-bold" x-text="selectedKeyToDelete"></p>
            </div>

            <div>
              <p class="text-sm font-medium text-gray-500">คำแปลภาษาไทย:</p>
              <p class="text-md font-medium bg-gray-50 p-2 rounded"
                x-text="keyInfoForDeletion.thTranslation || '(ไม่มีข้อมูล)'"></p>
            </div>

            <div>
              <p class="text-sm font-medium text-gray-500">คำแปลภาษาอังกฤษ:</p>
              <p class="text-md font-medium bg-gray-50 p-2 rounded"
                x-text="keyInfoForDeletion.enTranslation || '(ไม่มีข้อมูล)'"></p>
            </div>

            <div>
              <p class="text-sm font-medium text-gray-500">จำนวนภาษาที่มีคำแปล:</p>
              <p class="text-md font-medium bg-gray-50 p-2 rounded"
                x-text="keyInfoForDeletion.translationCount + ' ภาษา'"></p>
            </div>
          </div>

          <div class="mt-6">
            <button @click.prevent="confirmDeleteKey()" type="button"
              class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none flex items-center">
              <i class="fas fa-trash-alt mr-2"></i>
              ลบคีย์นี้
            </button>
          </div>
        </div>
      </div>

    </div>

    <!-- ส่วนจัดการผู้ใช้งาน -->
    <div id="user-management" class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <i class="fas fa-users-cog mr-2 text-blue-600"></i>จัดการผู้ใช้งาน
      </h2>

      <!-- ตารางแสดงรายชื่อผู้ใช้งานสำหรับ admin -->
      <div class="mb-8" x-show="hasPermission('user-management')">
        <h3 class="text-lg font-medium mb-4">รายชื่อผู้ใช้งานทั้งหมด</h3>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลำดับ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ชื่อผู้ใช้งาน</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  อีเมลสำหรับเข้าสู่ระบบ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">กลุ่มผู้ใช้
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="(user, index) in users" :key="user.id">
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="index + 1"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="user.displayName">
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="user.username"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span x-show="user.role === 'admin'"
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                      ผู้ดูแลระบบ
                    </span>
                    <span x-show="user.role !== 'admin'"
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                      x-text="getGroupName(user.role)">
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button @click="editUser(user)" class="text-blue-600 hover:text-blue-900">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button @click="confirmDeleteUser(user.id)" :disabled="user.role === 'admin' && adminCount <= 1"
                      :class="{'text-red-600 hover:text-red-900': !(user.role === 'admin' && adminCount <= 1), 'text-gray-400 cursor-not-allowed': (user.role === 'admin' && adminCount <= 1)}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </template>
              <tr x-show="!users.length">
                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">ไม่พบรายชื่อผู้ใช้งาน</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ตารางแสดงรายชื่อผู้ใช้งานสำหรับ user ทั่วไป (จะเห็นเฉพาะข้อมูลตัวเอง) -->
      <div class="mb-8" x-show="currentUser.role !== 'admin'">
        <h3 class="text-lg font-medium mb-4">ข้อมูลผู้ใช้งานของคุณ</h3>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ชื่อผู้ใช้งาน</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  อีเมลสำหรับเข้าสู่ระบบ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">กลุ่มผู้ใช้
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                  x-text="currentUser.displayName"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="currentUser.username"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <span x-show="currentUser.role === 'admin'"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    ผู้ดูแลระบบ
                  </span>
                  <span x-show="currentUser.role !== 'admin'"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                    x-text="getGroupName(currentUser.role)">
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <button @click="editUser(currentUser)" class="text-blue-600 hover:text-blue-900">
                    <i class="fas fa-key mr-1"></i> เปลี่ยนรหัสผ่าน
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ฟอร์มเพิ่ม/แก้ไขผู้ใช้งาน - แสดงเฉพาะกรณี admin หรือการแก้ไขข้อมูลตัวเอง -->
      <div class="border rounded-lg p-4 bg-gray-50" x-show="hasPermission('user-management') || userEditMode">
        <h3 class="text-lg font-medium mb-4 flex items-center">
          <!-- ไอคอนเปลี่ยนตามโหมด -->
          <i class="fas mr-2" :class="userEditMode ? 'fa-user-edit text-blue-600' : 'fa-user-plus text-green-600'"></i>
          <span x-text="userEditMode ? 'แก้ไขผู้ใช้งาน' : 'เพิ่มผู้ใช้งานใหม่'"></span>
        </h3>

        <form @submit.prevent="saveUser" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">อีเมลสำหรับเข้าสู่ระบบ</label>
              <input type="email" x-model="editingUser.username" required pattern="[a-zA-Z0-9._%+-]+@gmail\.com$"
                placeholder="ต้องเป็นอีเมล @gmail.com เท่านั้น"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">รูปแบบ: example@gmail.com</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้งาน</label>
              <input type="text" x-model="editingUser.displayName" required placeholder="ชื่อที่ใช้แสดงในระบบ"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
              <input type="password" x-model="editingUser.password" :required="!userEditMode"
                :placeholder="userEditMode ? 'เว้นว่างถ้าไม่ต้องการเปลี่ยนรหัสผ่าน' : 'กรอกรหัสผ่าน'"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">รหัสผ่านสำหรับเข้าสู่ระบบรถเช่าเท่านั้น
                ไม่ควรเป็นรหัสผ่านเดียวกับGmail</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">กลุ่มผู้ใช้</label>
              <select x-model="editingUser.role" required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                :disabled="currentUser.role !== 'admin'">
                <option value="admin">ผู้ดูแลระบบ</option>
                <template x-for="(permissions, role) in rolePermissions" :key="role">
                  <option x-show="role !== 'admin'" :value="role" x-text="getGroupName(role)"></option>
                </template>
              </select>
            </div>
          </div>

          <div class="flex justify-end space-x-3">
            <button type="button" @click="resetUserForm"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              ยกเลิก
            </button>
            <button type="submit"
              class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              <span x-text="userEditMode ? 'บันทึกการแก้ไข' : 'เพิ่มผู้ใช้'"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ส่วนจัดการกลุ่มผู้ใช้และสิทธิ์ (ปรับปรุงใหม่) - แสดงเฉพาะกรณี admin -->
    <div id="role-management" class="bg-white rounded-lg shadow-md p-6 mb-6" x-show="hasPermission('role-management')">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <i class="fas fa-user-shield mr-2 text-red-600"></i>จัดการกลุ่มผู้ใช้และสิทธิ์
      </h2>

      <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
        <div class="flex items-start">
          <div class="flex-shrink-0 pt-0.5">
            <i class="fas fa-info-circle text-blue-600 text-lg"></i>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">การจัดการกลุ่มผู้ใช้และสิทธิ์</h3>
            <div class="mt-2 text-sm text-blue-700">
              <p>สร้างและกำหนดสิทธิ์ให้กับกลุ่มผู้ใช้ต่างๆ โดยผู้ดูแลระบบจะมีสิทธิ์เข้าถึงทุกส่วนเสมอ</p>
            </div>
          </div>
        </div>
      </div>

      <!-- รายการกลุ่มผู้ใช้ -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">รายการกลุ่มผู้ใช้</h3>
          <button @click="showAddRoleModal = true"
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
            <i class="fas fa-plus-circle mr-2"></i> เพิ่มกลุ่มใหม่
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อกลุ่ม
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">คำอธิบาย
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนผู้ใช้
                </th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <!-- กลุ่ม Admin (ไม่สามารถแก้ไขหรือลบได้) -->
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                  <div class="flex items-center">
                    <span
                      class="bg-red-100 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mr-2">Admin</span>
                    ผู้ดูแลระบบ
                  </div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">มีสิทธิ์เข้าถึงทุกส่วนของระบบ</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="countUsersByRole('admin')"></td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                  <span class="text-gray-400">
                    <i class="fas fa-lock mr-1"></i> ไม่สามารถแก้ไขได้
                  </span>
                </td>
              </tr>

              <!-- รายการกลุ่มที่สร้างขึ้น -->
              <template x-for="(permissions, role) in rolePermissions" :key="role">
                <tr x-show="role !== 'admin'">
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    <div class="flex items-center">
                      <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mr-2"
                        x-text="role"></span>
                      <span x-text="getGroupName(role)"></span>
                    </div>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="getGroupDescription(role)">
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="countUsersByRole(role)"></td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button @click="editRole(role)" class="text-blue-600 hover:text-blue-900 mx-1">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button @click="confirmDeleteRole(role)" class="text-red-600 hover:text-red-900 mx-1">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </template>

              <tr x-show="Object.keys(rolePermissions).length <= 1">
                <td colspan="4" class="px-4 py-3 text-sm text-gray-500 text-center">
                  ยังไม่มีกลุ่มผู้ใช้ที่สร้างเพิ่มเติม</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- แสดงเฉพาะเมื่อมีการเลือกแก้ไขกลุ่ม -->
      <div class="mb-8" x-show="currentEditingRole !== ''">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium flex items-center">
            <i class="fas fa-edit text-blue-600 mr-2"></i>
            แก้ไขกลุ่ม: <span class="ml-2 font-semibold" x-text="getGroupName(currentEditingRole)"></span>
          </h3>
          <button @click="cancelEditRole" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-times-circle"></i> ยกเลิกการแก้ไข
          </button>
        </div>

        <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">รหัสกลุ่ม</label>
            <input type="text" x-model="currentEditingRole" disabled
              class="w-full px-3 py-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
            <p class="text-xs text-gray-500 mt-1">รหัสกลุ่มไม่สามารถแก้ไขได้</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อกลุ่มที่แสดง</label>
            <input type="text" x-model="roleNames[currentEditingRole]" required placeholder="ชื่อกลุ่มที่แสดงในระบบ"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบายกลุ่ม</label>
            <input type="text" x-model="roleDescriptions[currentEditingRole]" placeholder="คำอธิบายกลุ่มผู้ใช้นี้"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>

        <!-- ตารางกำหนดสิทธิ์ -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <h4 class="font-medium mb-4">กำหนดสิทธิ์การเข้าถึง</h4>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    ส่วนของระบบ</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                    อนุญาต</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <!-- ส่วนสิทธิ์การเข้าถึงหน้าหลักต่างๆ -->
                <tr class="bg-gray-50">
                  <td colspan="2" class="px-4 py-3 text-sm font-semibold text-gray-700">
                    <i class="fas fa-desktop mr-2"></i> การเข้าถึงหน้าหลักในระบบ
                  </td>
                </tr>

                <!-- หน้าสรุปข้อมูลประจำวัน -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-[#57daf7]"></i>
                    หน้าสรุปข้อมูลประจำวัน
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('page-summary')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'page-summary') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'page-summary') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- หน้าค้นหาข้อมูล -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-search mr-2 text-[#A1B4FF]"></i>
                    หน้าค้นหาข้อมูล
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('page-bookings')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'page-bookings') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'page-bookings') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- หน้าตารางรับส่งรถ -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-[#B0F0A5]"></i>
                    หน้าตารางรับส่งรถ
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('page-schedule')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'page-schedule') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'page-schedule') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- หน้าสร้างรายการเช่าใหม่ -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-[#FB9F9E]"></i>
                    หน้าสร้างรายการเช่าใหม่
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('page-newRental')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'page-newRental') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'page-newRental') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- หน้าจัดการรถ -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-car mr-2 text-[#FFD09E]"></i>
                    หน้าจัดการรถ
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('page-cars')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'page-cars') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'page-cars') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- หน้าตั้งค่าระบบ -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-cog mr-2 text-[#B4C1C7]"></i>
                    หน้าตั้งค่าระบบ
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('page-config')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'page-config') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'page-config') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- หัวข้อสำหรับส่วนตั้งค่าย่อยในหน้าตั้งค่าระบบ -->
                <tr class="bg-gray-50">
                  <td colspan="2" class="px-4 py-3 text-sm font-semibold text-gray-700">
                    <div class="flex items-center">
                      <i class="fas fa-sliders-h mr-2"></i>
                      การเข้าถึงส่วนย่อยในหน้าตั้งค่าระบบ
                      <span class="ml-2 px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">
                        เฉพาะเมื่อเข้าถึงหน้าตั้งค่าระบบได้
                      </span>
                    </div>
                  </td>
                </tr>

                <!-- ข้อมูลบริษัท -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-building mr-2 text-blue-500"></i>
                    ข้อมูลบริษัท
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('company-info')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'company-info') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'company-info') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- ตั้งค่าการชำระเงิน -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-credit-card mr-2 text-blue-500"></i>
                    ตั้งค่าการชำระเงิน
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('payment-settings')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'payment-settings') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'payment-settings') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- การจอง -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-bookmark mr-2 text-blue-500"></i>
                    การจอง
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('booking-settings')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'booking-settings') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'booking-settings') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- จัดการสถานที่ -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                    จัดการสถานที่
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('location-settings')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'location-settings') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'location-settings') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- ตั้งค่าข้อความสรุปรายการเช่า -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-receipt mr-2 text-blue-500"></i>
                    ตั้งค่าข้อความสรุปรายการเช่า
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('summary-message-settings')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'summary-message-settings') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'summary-message-settings') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- ตั้งค่าข้อความเสนอราคา -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-file-invoice-dollar mr-2 text-blue-500"></i>
                    ตั้งค่าข้อความเสนอราคา
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('quote-message-settings')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'quote-message-settings') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'quote-message-settings') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- จัดการแปลภาษาสัญญาเช่า -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-language mr-2 text-blue-500"></i>
                    จัดการแปลภาษาสัญญาเช่า
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('translation-settings')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'translation-settings') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'translation-settings') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- รายชื่อ Blacklist -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-ban mr-2 text-red-500"></i>
                    รายชื่อ Blacklist
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('blacklist-management')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'blacklist-management') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'blacklist-management') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>

                <!-- ข้อมูล License -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                    <i class="fas fa-key mr-2 text-purple-500"></i>
                    ข้อมูล License
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <button type="button" @click="toggleRolePermission('license-info')"
                      class="w-10 h-5 relative rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors duration-300"
                      :class="checkRolePermission(currentEditingRole, 'license-info') ? 'bg-blue-500' : 'bg-gray-300'">
                      <span
                        class="block w-5 h-5 bg-white rounded-full shadow absolute transform transition-transform duration-300"
                        :class="checkRolePermission(currentEditingRole, 'license-info') ? 'right-0' : 'left-0'">
                      </span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="flex items-start">
              <div class="flex-shrink-0 pt-0.5">
                <i class="fas fa-info-circle text-blue-600 text-lg"></i>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">หมายเหตุเกี่ยวกับสิทธิ์การเข้าถึง</h3>
                <div class="mt-2 text-sm text-blue-700">
                  <p>1. การเข้าถึงหน้าหลักต่างๆ ควรกำหนดให้สอดคล้องกับความรับผิดชอบของผู้ใช้</p>
                  <p>2. ส่วนย่อยในหน้าตั้งค่าระบบจะเข้าถึงได้ก็ต่อเมื่อมีสิทธิ์เข้าถึงหน้าตั้งค่าระบบ (page-config)
                    ก่อน</p>
                  <p>3. คุณสามารถปรับแต่งสิทธิ์ให้กับกลุ่มผู้ใช้ได้ตามต้องการ สำหรับกลุ่ม "ผู้ดูแลระบบ"
                    จะมีสิทธิ์ครบทุกส่วนเสมอ</p>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 flex justify-end">
            <button @click="saveRolePermissions" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              <i class="fas fa-save mr-2"></i> บันทึกการเปลี่ยนแปลง
            </button>
          </div>
        </div>

      </div>

      <!-- แสดงสถานะการแจ้งเตือน -->
      <div x-show="notificationMessage" x-text="notificationMessage" :class="{
         'text-sm mt-4 p-2 rounded transition-opacity duration-500': true,
         'bg-blue-100 text-blue-800': notificationType === 'info',
         'bg-green-100 text-green-800': notificationType === 'success',
         'bg-red-100 text-red-800': notificationType === 'error'
     }" style="opacity: 1;">
      </div>
    </div>

    <!-- หน้าต่าง Modal สำหรับเพิ่มกลุ่มใหม่ -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-show="showAddRoleModal"
      x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" style="display: none;">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="transform scale-95 opacity-0"
        x-transition:enter-end="transform scale-100 opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform scale-100 opacity-100"
        x-transition:leave-end="transform scale-95 opacity-0">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">เพิ่มกลุ่มผู้ใช้งานใหม่</h3>
          <button @click="showAddRoleModal = false" class="text-gray-400 hover:text-gray-500">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form @submit.prevent="addNewRole" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">รหัสกลุ่ม</label>
            <input type="text" x-model="newRoleId" required pattern="[a-z0-9-]+"
              placeholder="ตัวอักษรภาษาอังกฤษพิมพ์เล็กหรือตัวเลขหรือเครื่องหมาย - เท่านั้น"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <p class="text-xs text-gray-500 mt-1">เช่น manager, staff, guest เป็นต้น</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อกลุ่มที่แสดง</label>
            <input type="text" x-model="newRoleName" required placeholder="ชื่อกลุ่มที่แสดงในระบบ"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <p class="text-xs text-gray-500 mt-1">เช่น ผู้จัดการ, พนักงาน, ลูกค้า เป็นต้น</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบายกลุ่ม</label>
            <input type="text" x-model="newRoleDescription" placeholder="คำอธิบายกลุ่มผู้ใช้นี้"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ต้นแบบสิทธิ์</label>
            <select x-model="newRoleTemplate"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <option value="empty">สร้างใหม่ (ไม่มีสิทธิ์ใดๆ)</option>
              <option value="full">สิทธิ์ครบถ้วน (เข้าถึงทุกส่วน)</option>
              <option value="basic">สิทธิ์พื้นฐาน (เฉพาะส่วนที่จำเป็น)</option>
              <template x-for="(permissions, role) in rolePermissions" :key="role">
                <option x-show="role !== 'admin'" :value="role" x-text="'คัดลอกจาก: ' + getGroupName(role)"></option>
              </template>
            </select>
            <p class="text-xs text-gray-500 mt-1">เลือกต้นแบบสิทธิ์เริ่มต้นสำหรับกลุ่มนี้</p>
          </div>

          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" @click="showAddRoleModal = false"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">
              ยกเลิก
            </button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
              เพิ่มกลุ่ม
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- หน้าต่าง Modal สำหรับยืนยันการลบกลุ่ม -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-show="showDeleteRoleModal"
      style="display: none;">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
            <i class="fas fa-exclamation-triangle text-red-600"></i>
          </div>
          <h3 class="mt-3 text-lg font-medium text-gray-900">ยืนยันการลบกลุ่มผู้ใช้</h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500">
              คุณกำลังจะลบกลุ่ม <span class="font-semibold" x-text="getGroupName(roleToDelete)"></span>
              <br>การลบกลุ่มนี้อาจส่งผลต่อผู้ใช้ที่อยู่ในกลุ่มนี้
              <br><br>ต้องการดำเนินการต่อหรือไม่?
            </p>
          </div>
          <div class="flex justify-center space-x-4 mt-3">
            <button @click="showDeleteRoleModal = false"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
              ยกเลิก
            </button>
            <button @click="deleteRole" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
              ลบกลุ่ม
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- ส่วน Blacklist -->
    <div id="blacklist-management" class="bg-white rounded-lg shadow-md p-6 mb-6"
      x-show="hasPermission('blacklist-management')">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <i class="fas fa-ban mr-2 text-red-600"></i>รายชื่อ Blacklist
      </h2>

      <!-- ส่วนค้นหา Blacklist -->
      <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
        <h3 class="text-lg font-medium mb-4">ค้นหารายชื่อ Blacklist</h3>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
          <div class="flex-grow">
            <input type="text" x-model="blacklistSearchQuery" placeholder="ค้นหาด้วยชื่อหรือเลขบัตรประจำตัวประชาชน"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <button @click="searchBlacklist()"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            <i class="fas fa-search mr-1"></i> ค้นหา
          </button>
        </div>

        <!-- ผลการค้นหา -->
        <div x-show="blacklistSearchResults.length > 0" class="mt-4">
          <h4 class="text-md font-medium mb-2">ผลการค้นหา</h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    เลขบัตรประจำตัวประชาชน</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    รูปแบบการโกง</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้บันทึก
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="result in blacklistSearchResults" :key="result.id">
                  <tr>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="result.ชื่อ">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500"
                      x-text="result.เลขบัตรประจำตัวประชาชน"></td>
                    <td class="px-4 py-4 text-sm text-gray-500" x-text="result.รูปแบบการโกง"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="result.ผู้บันทึก"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                      <button @click="deleteBlacklistItem(result.id)" class="text-red-600 hover:text-red-900"
                        title="ลบรายการ">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <div x-show="blacklistSearchResults.length === 0 && hasSearched"
          class="mt-4 p-4 bg-gray-100 text-gray-600 text-center rounded-md">
          ไม่พบข้อมูลที่ตรงกับคำค้นหา
        </div>
      </div>

      <!-- ส่วนเพิ่มรายชื่อใหม่ -->
      <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
        <h3 class="text-lg font-medium mb-4">เพิ่มรายชื่อ Blacklist ใหม่</h3>
        <form @submit.prevent="addBlacklistItem">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล *</label>
              <input type="text" x-model="newBlacklist.ชื่อ" required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เลขบัตรประจำตัวประชาชน *</label>
              <input type="text" x-model="newBlacklist.เลขบัตรประจำตัวประชาชน" required pattern="[0-9]*" maxlength="13"
                placeholder="เลขบัตร 13 หลัก"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">รูปแบบการโกง *</label>
              <textarea x-model="newBlacklist.รูปแบบการโกง" required rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
          </div>

          <div class="mt-4 flex justify-end">
            <button type="submit"
              class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
              <i class="fas fa-plus mr-1"></i> เพิ่มรายชื่อ Blacklist
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ส่วนข้อมูล License -->
    <div id="license-info" class="bg-white rounded-lg shadow-md p-6 mb-6" x-show="hasPermission('license-info')">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <i class="fas fa-key mr-2 text-purple-600"></i>ข้อมูล License
      </h2>

      <div class="space-y-4">
        <!-- Store SID -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Store SID</h3>
          <p x-text="config.storeSID || 'ไม่พบข้อมูล'" class="text-lg font-mono"></p>
        </div>

        <!-- วันหมดอายุ -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-sm font-medium text-gray-700 mb-2">วันหมดอายุ License</h3>
          <p x-text="licenseExpireDate || 'ไม่พบข้อมูล'"
            :class="{'text-red-600': licenseExpired, 'text-yellow-600': !licenseExpired && licenseDaysRemaining <= 10, 'text-green-600': !licenseExpired && licenseDaysRemaining > 10}"
            class="text-lg font-mono"></p>
        </div>

        <!-- สถานะ License -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-sm font-medium text-gray-700 mb-2">สถานะ License</h3>

          <template x-if="licenseExpired">
            <div class="bg-red-50 border-l-4 border-red-500 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-triangle text-red-500"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-red-700">
                    License หมดอายุแล้ว กรุณาต่ออายุเพื่อใช้งานระบบต่อไป
                  </p>
                </div>
              </div>
            </div>
          </template>

          <template x-if="!licenseExpired && licenseDaysRemaining <= 10">
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-circle text-yellow-500"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-yellow-700">
                    License จะหมดอายุในอีก <span x-text="licenseDaysRemaining"></span> วัน กรุณาต่ออายุ
                  </p>
                </div>
              </div>
            </div>
          </template>

          <template x-if="!licenseExpired && licenseDaysRemaining > 10">
            <div class="bg-green-50 border-l-4 border-green-500 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-check-circle text-green-500"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-green-700">
                    License ยังใช้งานได้อีก <span x-text="licenseDaysRemaining"></span> วัน
                  </p>
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- ปุ่มต่ออายุ -->
        <div class="mt-6 flex justify-center">
          <button @click="openLicenseRenewalModal()"
            class="px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 shadow-md transition duration-200 flex items-center">
            <i class="fas fa-sync-alt mr-2"></i>
            ต่ออายุ License
          </button>
        </div>
      </div>
    </div>



    <!-- ปุ่มกลับด้านบนแบบ Fixed Position - วางไว้ที่มุมขวาล่างตลอดเวลา -->
    <!-- ปุ่ม Scroll to Top -->
    <div x-show="window.scrollY >= 200" class="fixed bottom-20 right-4 z-50 transition-all duration-300" x-data="{}"
      x-init="
       window.addEventListener('scroll', () => {
         $el.style.display = window.scrollY >= 200 ? 'block' : 'none';
       })
     ">
      <button @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        class="group flex items-center justify-center w-12 h-12 rounded-full bg-green-300 hover:bg-green-700 text-white shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105"
        title="กลับไปด้านบน">
        <i
          class="fas fa-arrow-up transform transition-transform duration-300 group-hover:translate-y-[-3px] group-hover:animate-bounce"></i>
      </button>
    </div>


  </div>






  <!-- Modal สำหรับแก้ไขรายการเช่า -->
  <div x-show="showRentalModal" x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
    class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">

    <div class="flex items-center justify-center min-h-screen p-4">
      <!-- Background overlay -->
      <div class="fixed inset-0 transition-opacity" aria-hidden="true" @click="closeRentalModal()">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>

      <!-- Modal content - Responsive & Modern Design -->
      <div
        class="relative w-full max-w-6xl bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all max-h-[95vh] flex flex-col mx-auto">

        <!-- Header - Sticky with Gradient -->
        <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 px-6 py-4 flex-shrink-0">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold text-white flex items-center">
              <i class="fas mr-3 text-white" :class="isViewMode ? 'fa-eye' : 'fa-edit'"></i>
              <span x-text="isViewMode ? 'ดูข้อมูลรายการเช่า' : 'แก้ไขรายการเช่า'"></span>
            </h3>
            <div class="flex items-center space-x-2">
              <!-- ปุ่มแก้ไข (แสดงเฉพาะในโหมดดู) -->
              <button x-show="isViewMode" @click="startEditFromModal()"
                class="px-3 py-1.5 bg-white text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex items-center text-sm font-medium">
                <i class="fas fa-edit mr-1.5"></i>
                แก้ไข
              </button>
              <button @click="closeRentalModal()" class="text-white hover:text-gray-200 transition-colors">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>
          <!-- Booking Number Display -->
          <div class="mt-2">
            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm text-white">
              <i class="fas fa-hashtag mr-1"></i>
              <span x-text="editRentalData.หมายเลขการจอง"></span>
            </span>
          </div>
        </div>

        <!-- Content - Scrollable -->
        <div class="flex-1 overflow-y-auto bg-gray-50">
          <div class="p-6 space-y-6" :class="{'pointer-events-none': isViewMode, 'opacity-90': isViewMode}">

            <!-- Section 1: ข้อมูลการจอง -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                ข้อมูลการจอง
              </h4>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">ช่องทางการจอง</label>
                  <select x-model="editRentalData.ช่องทางการจอง"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">เลือกช่องทางการจอง</option>
                    <template x-for="channel in bookingChannels" :key="channel">
                      <option :value="channel" x-text="channel"></option>
                    </template>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">หมายเลขการจอง</label>
                  <input type="text" x-model="editRentalData.หมายเลขการจอง" disabled
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
                <select x-model="editRentalData.สถานะ" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="จอง">จอง</option>
                  <option value="ยืนยัน">ยืนยัน</option>
                  <option value="เสร็จสิ้น">เสร็จสิ้น</option>
                  <option value="ยกเลิก">ยกเลิก</option>
                </select>
              </div> -->
              </div>
            </div>

            <!-- Section 2: ข้อมูลลูกค้า -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-user mr-2 text-green-500"></i>
                ข้อมูลลูกค้า
              </h4>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อลูกค้า</label>
                  <input type="text" x-model="editRentalData.ชื่อลูกค้า"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">เบอร์โทรศัพท์</label>
                  <input type="tel" x-model="editRentalData.เบอร์โทรศัพท์"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">เลขบัตรประชาชน/Passport</label>
                  <input type="text" x-model="editRentalData.เลขบัตรประชาชน" @input="validateIdPassport($event)"
                    placeholder="เลขบัตรประชาชน/Passport (ไม่บังคับ)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">หมายเลขใบขับขี่</label>
                  <input type="text" x-model="editRentalData.หมายเลขใบขับขี่" placeholder="หมายเลขใบขับขี่ (ไม่บังคับ)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="lg:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-2">ที่อยู่ลูกค้า</label>
                  <textarea x-model="editRentalData.ที่อยู่ลูกค้า" rows="3" placeholder="ที่อยู่ลูกค้า (ไม่บังคับ)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
              </div>
            </div>

            <!-- Section 3: ข้อมูลรถ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-car mr-2 text-purple-500"></i>
                ข้อมูลรถ
              </h4>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">รถ</label>
                  <select x-model="editRentalData.รถ" @change="populateCarDetailsForEdit()"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">เลือกรถ</option>

                    <template x-for="(car, index) in carOptions" :key="index">
                      <option :value="car.value" x-text="car.text"></option>
                    </template>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">ทะเบียนรถ</label>
                  <input type="text" x-model="editRentalData.ทะเบียนรถ"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                    readonly>
                </div>
              </div>
            </div>

            <!-- Section 4: วันเวลาเช่า -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-clock mr-2 text-orange-500"></i>
                วันเวลาเช่า
              </h4>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- รับรถ -->
                <div class="space-y-4">
                  <h5 class="font-medium text-gray-700 flex items-center">
                    <i class="fas fa-arrow-right mr-2 text-green-500"></i>
                    รับรถ
                  </h5>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium text-gray-600 mb-2">วันที่</label>
                      <input type="date" x-model="editRentalData.วันที่เช่า" @change="calculateEditTotalRental()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-600 mb-2">เวลา</label>
                      <input type="time" x-model="editRentalData.เวลารับรถ" @change="calculateEditTotalRental()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">สถานที่รับรถ</label>
                    <div class="flex space-x-2">
                      <input type="text" x-model="editRentalData.สถานที่รับรถ" list="edit-pickup-locations"
                        placeholder="เลือกหรือพิมพ์สถานที่รับรถ"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <datalist id="edit-pickup-locations">
                        <template x-for="location in pickupLocations" :key="location">
                          <option :value="location"></option>
                        </template>
                      </datalist>
                      <button @click="openPickupEditor" type="button"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-xs text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none"
                        title="แก้ไขรายการสถานที่รับรถ">
                        <i class="fas fa-cog"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- คืนรถ -->
                <div class="space-y-4">
                  <h5 class="font-medium text-gray-700 flex items-center">
                    <i class="fas fa-arrow-left mr-2 text-red-500"></i>
                    คืนรถ
                  </h5>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium text-gray-600 mb-2">วันที่</label>
                      <input type="date" x-model="editRentalData.วันที่คืน" @change="calculateEditTotalRental()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-600 mb-2">เวลา</label>
                      <input type="time" x-model="editRentalData.เวลาคืนรถ" @change="calculateEditTotalRental()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">สถานที่คืนรถ</label>
                    <div class="flex space-x-2">
                      <input type="text" x-model="editRentalData.สถานที่คืนรถ" list="edit-return-locations"
                        placeholder="เลือกหรือพิมพ์สถานที่คืนรถ"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <datalist id="edit-return-locations">
                        <template x-for="location in returnLocations" :key="location">
                          <option :value="location"></option>
                        </template>
                      </datalist>
                      <button @click="openReturnEditor" type="button"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-xs text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none"
                        title="แก้ไขรายการสถานที่คืนรถ">
                        <i class="fas fa-cog"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- แสดงรวมระยะเวลาเช่า -->
              <div
                class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 mt-4 shadow-sm hover:shadow-md transition-shadow duration-300">
                <div class="text-center">
                  <div class="flex items-center justify-center mb-2">
                    <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center mr-2 shadow-sm">
                      <i class="fas fa-calculator text-blue-600"></i>
                    </div>
                    <span class="text-lg font-semibold text-blue-900">รวมระยะเวลาเช่า</span>
                  </div>

                  <div class="flex items-center justify-center">
                    <template x-if="calculateEditRentalDays() > 0">
                      <div class="flex items-center space-x-2">
                        <span class="text-4xl font-bold text-indigo-700"
                          x-text="calculateEditRentalDays() || '0'"></span>
                        <span class="text-2xl text-gray-500">วัน</span>

                        <!-- แสดงชั่วโมงที่เหลือ -->
                        <template x-if="calculateEditRemainingHours() > 0">
                          <div class="flex items-center space-x-2 ml-2">
                            <span class="text-2xl font-bold text-blue-600"
                              x-text="calculateEditRemainingHours()"></span>
                            <span class="text-xl text-gray-500">ชั่วโมง</span>
                          </div>
                        </template>
                      </div>
                    </template>
                    <template x-if="calculateEditRentalDays() === 0">
                      <div class="text-xl text-gray-500">ไม่มีข้อมูล</div>
                    </template>
                  </div>

                  <div class="text-xs text-gray-600 mt-3 bg-green-100 px-3 py-1 rounded-full inline-block"
                    x-show="config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน > 0">
                    หากเกิน <span x-text="config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน || '4'"></span> ชั่วโมง คิดเพิ่มเป็น
                    1 วัน
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 5: ตัวเลือกเพิ่มเติม -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-plus-circle mr-2 text-purple-500"></i>
                ตัวเลือกเพิ่มเติม
              </h4>

              <div class="space-y-6">
                <!-- คาร์ซีท -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex items-center">
                      <i class="fas fa-baby mr-2 text-purple-500"></i>
                      <label class="font-semibold text-gray-700">ต้องการคาร์ซีท</label>
                    </div>
                    <input type="checkbox" x-model="editRentalData.ต้องการคาร์ซีท"
                      @change="if (!editRentalData.ต้องการคาร์ซีท) { editRentalData.คาร์ซีทมีค่าบริการ = false; editRentalData.ค่าคาร์ซีท = 0; calculateEditTotalRental(); }"
                      class="toggle-switch">
                  </div>

                  <div x-show="editRentalData.ต้องการคาร์ซีท" x-transition class="pl-4 space-y-3">
                    <div class="flex items-center space-x-4">
                      <label class="flex items-center cursor-pointer">
                        <input type="radio" x-model="editRentalData.คาร์ซีทมีค่าบริการ" value="false"
                          @change="editRentalData.ค่าคาร์ซีท = 0; calculateEditTotalRental()" class="mr-2">
                        <span class="text-sm text-gray-700">ไม่มีค่าบริการ</span>
                      </label>
                      <label class="flex items-center cursor-pointer">
                        <input type="radio" x-model="editRentalData.คาร์ซีทมีค่าบริการ" value="true" class="mr-2">
                        <span class="text-sm text-gray-700">มีค่าบริการ</span>
                      </label>
                    </div>

                    <div
                      x-show="editRentalData.คาร์ซีทมีค่าบริการ === true || editRentalData.คาร์ซีทมีค่าบริการ === 'true'"
                      x-transition>
                      <label class="block text-sm font-medium text-gray-700 mb-2">ค่าบริการคาร์ซีท</label>
                      <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-purple-600">฿</span>
                        <input type="number" x-model="editRentalData.ค่าคาร์ซีท" @input="calculateEditTotalRental()"
                          placeholder="ระบุค่าบริการ"
                          class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all">
                      </div>
                      <template
                        x-if="editRentalData.ค่าคาร์ซีท && parseFloat(editRentalData.ค่าคาร์ซีท) > 0 && (editRentalData.wantsTaxInvoice || editRentalData.wantsWHT)">
                        <div class="mt-3 flex items-center space-x-4 bg-white p-3 rounded-lg border border-purple-200">
                          <span class="text-sm font-medium text-gray-700">นำไปคำนวณ:</span>
                          <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="checkbox" x-model="editRentalData.carSeatIncludeVAT"
                              @change="recalculateEditVATBase(); calculateEditWHT(); calculateEditFinalAmount()"
                              class="form-checkbox h-4 w-4 text-green-600">
                            <span class="text-sm text-gray-700">VAT</span>
                          </label>
                          <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="checkbox" x-model="editRentalData.carSeatIncludeWHT"
                              @change="calculateEditWHT(); calculateEditFinalAmount()"
                              class="form-checkbox h-4 w-4 text-orange-600">
                            <span class="text-sm text-gray-700">หัก ณ ที่จ่าย</span>
                          </label>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- ประกันเสริม -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between p-3 bg-teal-50 rounded-lg border border-teal-200">
                    <div class="flex items-center">
                      <i class="fas fa-shield-alt mr-2 text-teal-500"></i>
                      <label class="font-semibold text-gray-700">ประกันเสริม</label>
                    </div>
                    <input type="checkbox" x-model="editRentalData.ต้องการประกันเสริม"
                      @change="if (!editRentalData.ต้องการประกันเสริม) { editRentalData.จำนวนวันประกันเสริม = 0; editRentalData.ราคาประกันเสริมต่อวัน = 0; editRentalData.ค่าประกันเสริมรวม = 0; calculateEditTotalRental(); } else { const rentalInfo = calculateRentalDaysWithHours(editRentalData.วันที่เช่า, editRentalData.วันที่คืน, editRentalData.เวลารับรถ, editRentalData.เวลาคืนรถ); editRentalData.จำนวนวันประกันเสริม = rentalInfo.days || 1; editRentalData.ราคาประกันเสริมต่อวัน = parseFloat(config.ค่าประกันเสริมต่อวัน) || 0; editRentalData.ค่าประกันเสริมรวม = editRentalData.จำนวนวันประกันเสริม * editRentalData.ราคาประกันเสริมต่อวัน; calculateEditTotalRental(); }"
                      class="toggle-switch">
                  </div>

                  <div x-show="editRentalData.ต้องการประกันเสริม" x-transition class="pl-4 space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนวันที่ซื้อ</label>
                        <input type="number" x-model="editRentalData.จำนวนวันประกันเสริม"
                          @input="editRentalData.ค่าประกันเสริมรวม = (parseFloat(editRentalData.จำนวนวันประกันเสริม) || 0) * (parseFloat(editRentalData.ราคาประกันเสริมต่อวัน) || 0); calculateEditTotalRental()"
                          min="1"
                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all">
                      </div>

                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          ราคาประกันเสริมต่อวัน
                          <span x-show="!config.ค่าประกันเสริมต่อวัน || config.ค่าประกันเสริมต่อวัน == 0"
                            class="text-xs text-orange-600">(ยังไม่ตั้งค่า)</span>
                        </label>
                        <div class="relative">
                          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-teal-600">฿</span>
                          <input type="number" x-model="editRentalData.ราคาประกันเสริมต่อวัน"
                            @input="editRentalData.ค่าประกันเสริมรวม = (parseFloat(editRentalData.จำนวนวันประกันเสริม) || 0) * (parseFloat(editRentalData.ราคาประกันเสริมต่อวัน) || 0); calculateEditTotalRental()"
                            placeholder="0"
                            class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all">
                        </div>
                        <p x-show="!config.ค่าประกันเสริมต่อวัน || config.ค่าประกันเสริมต่อวัน == 0"
                          class="text-xs text-orange-600 mt-1">
                          <i class="fas fa-info-circle mr-1"></i>ตั้งค่าได้ที่หน้าตั้งค่าระบบ
                        </p>
                      </div>

                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ราคาประกันเสริมรวม</label>
                        <div class="relative">
                          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-teal-600">฿</span>
                          <input type="number" x-model="editRentalData.ค่าประกันเสริมรวม" readonly
                            class="w-full pl-8 px-4 py-3 border-2 border-teal-400 rounded-xl bg-teal-50 text-teal-700 font-bold">
                        </div>
                      </div>
                    </div>
                    <template
                      x-if="editRentalData.ค่าประกันเสริมรวม && parseFloat(editRentalData.ค่าประกันเสริมรวม) > 0 && (editRentalData.wantsTaxInvoice || editRentalData.wantsWHT)">
                      <div class="mt-3 flex items-center space-x-4 bg-white p-3 rounded-lg border border-teal-200">
                        <span class="text-sm font-medium text-gray-700">นำไปคำนวณ:</span>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="editRentalData.insuranceIncludeVAT"
                            @change="recalculateEditVATBase(); calculateEditWHT(); calculateEditFinalAmount()"
                            class="form-checkbox h-4 w-4 text-green-600">
                          <span class="text-sm text-gray-700">VAT</span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="editRentalData.insuranceIncludeWHT"
                            @change="calculateEditWHT(); calculateEditFinalAmount()"
                            class="form-checkbox h-4 w-4 text-orange-600">
                          <span class="text-sm text-gray-700">หัก ณ ที่จ่าย</span>
                        </label>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>


            <!-- <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-images mr-2 text-pink-500"></i>
              การจัดการรูปภาพ
            </h4>
            
          
            <div x-show="editRentalData.รูปภาพ && editRentalData.รูปภาพ.length > 0" class="mb-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <h5 class="text-sm font-medium text-blue-800 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    รูปภาพที่อัพโหลดไว้แล้ว
                  </h5>
               
                  <button @click="confirmDeleteAllImages()" 
                          class="text-red-600 hover:text-red-800 text-sm flex items-center">
                    <i class="fas fa-trash mr-1"></i>
                    ลบทั้งหมด
                  </button>
                </div>
                <div class="flex flex-wrap gap-2">
                  <template x-for="(image, index) in editRentalData.รูปภาพ" :key="index">
                    <div class="relative group">
                      <button @click="viewImage(image.url)" 
                              class="flex items-center px-3 py-2 bg-white border border-blue-300 rounded-md hover:bg-blue-50 transition-colors">
                        <i class="fas fa-image mr-2 text-blue-600"></i>
                        <span class="text-sm text-blue-800" x-text="image.name || `รูปภาพ ${index + 1}`"></span>
                      </button>
                    
                      <button @click="deleteExistingImage(index)" 
                              class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </template>
                </div>
              </div>
            </div>  
            
      
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  เพิ่มรูปภาพใหม่ (หรือแทนที่รูปภาพเดิม)
                </label>
                <div class="flex items-center justify-center w-full">
                  <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                      <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                      <p class="mb-2 text-sm text-gray-500">
                        <span class="font-semibold">คลิกเพื่อเลือกไฟล์</span> หรือลากไฟล์มาวาง
                      </p>
                      <p class="text-xs text-gray-500">PNG, JPG, JPEG (MAX. 10MB)</p>
                    </div>
                    <input type="file" @change="handleImageUpload($event)" 
                           class="hidden" multiple accept="image/*">
                  </label>
                </div>
              </div>
              
          
              <div x-show="editRentalData.newImages && editRentalData.newImages.length > 0" class="mt-4">
                <h5 class="text-sm font-medium text-gray-700 mb-2">รูปภาพที่เลือกใหม่</h5>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <template x-for="(image, index) in editRentalData.newImages" :key="index">
                    <div class="relative group">
                      <img :src="image.preview" :alt="`รูปภาพ ${index + 1}`" 
                           class="w-full h-20 object-cover rounded-lg border border-gray-300">
                      <button @click="removeNewImage(index)" 
                              class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div> -->

            <!-- Section 6: ราคาและค่าใช้จ่าย -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-money-bill-wave mr-2 text-yellow-500"></i>
                ราคาและค่าใช้จ่าย
              </h4>

              <!-- ค่าเช่าหลัก -->
              <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
                <h3 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                  <i class="fas fa-calculator mr-2"></i>ค่าเช่าหลัก
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- ค่าเช่าต่อวัน -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      ค่าเช่าต่อวัน
                      <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                      <input type="number" x-model="editRentalData.ราคา" @input="calculateEditTotalRental()"
                        placeholder="1000"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                    </div>
                  </div>

                  <!-- ค่าบริการเพิ่มเติม -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      ค่าบริการเพิ่มเติม
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                      <input type="number" x-model="editRentalData.ค่าบริการเพิ่มเติม"
                        @input="calculateEditTotalRental(); recalculateEditVATBase(); calculateEditWHT(); calculateEditFinalAmount();"
                        placeholder="หากไม่มีให้เว้นว่างไว้"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                    </div>
                    <template
                      x-if="editRentalData.ค่าบริการเพิ่มเติม && parseFloat(editRentalData.ค่าบริการเพิ่มเติม) > 0 && (editRentalData.wantsTaxInvoice || editRentalData.wantsWHT)">
                      <div class="mt-2 flex items-center space-x-4 bg-white p-3 rounded-lg border border-blue-200">
                        <span class="text-sm font-medium text-gray-700">นำไปคำนวณ:</span>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="editRentalData.additionalServiceIncludeVAT"
                            @change="recalculateEditVATBase(); calculateEditWHT(); calculateEditFinalAmount()"
                            class="form-checkbox h-4 w-4 text-green-600">
                          <span class="text-sm text-gray-700">VAT</span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                          <input type="checkbox" x-model="editRentalData.additionalServiceIncludeWHT"
                            @change="calculateEditWHT(); calculateEditFinalAmount()"
                            class="form-checkbox h-4 w-4 text-orange-600">
                          <span class="text-sm text-gray-700">หัก ณ ที่จ่าย</span>
                        </label>
                      </div>
                    </template>
                  </div>

                  <!-- ส่วนลด -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      <i class="fas fa-tags mr-2 text-red-500"></i>ส่วนลด
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-red-600">฿</span>
                      <input type="number" x-model="editRentalData.ส่วนลด" @input="calculateEditTotalRental()"
                        placeholder="จำนวนเงินส่วนลด"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all">
                    </div>
                  </div>

                  <!-- ค่าล่วงเวลา -->
                  <div class="space-y-2" x-show="editRentalData.ค่าล่วงเวลา > 0">
                    <label class="block text-sm font-semibold text-orange-700">
                      <i class="fas fa-clock mr-1"></i>
                      ค่าล่วงเวลา
                      <span class="text-xs text-gray-500">
                        <template
                          x-if="(config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0) > 0 && (editRentalData.ชั่วโมงล่วงเวลา || 0) > 0">
                          <span
                            x-text="'(' + ((editRentalData.ชั่วโมงล่วงเวลา - (config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0)) > 0 ? (editRentalData.ชั่วโมงล่วงเวลา - (config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0)).toFixed(2) : '0.00') + ' ชม. หลังหักชั่วโมงฟรี ' + (config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0) + ' ชั่วโมง)'"></span>
                        </template>
                        <template
                          x-if="!((config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน || 0) > 0 && (editRentalData.ชั่วโมงล่วงเวลา || 0) > 0)">
                          <span x-text="'(' + (editRentalData.ชั่วโมงล่วงเวลา || 0).toFixed(2) + ' ชม.)'"></span>
                        </template>
                      </span>
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-orange-600">฿</span>
                      <input type="number" x-model="editRentalData.ค่าล่วงเวลา"
                        @input="calculateEditFinalAmount(); calculateEditCommission()" placeholder="ค่าล่วงเวลา"
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-100 transition-all">
                    </div>
                    <!-- แสดงคำเตือนเมื่อใช้ค่าเริ่มต้น -->
                    <div x-show="editRentalData.usingDefaultOvertimeRate"
                      class="flex items-start gap-2 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
                      <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                      <p class="text-xs text-yellow-800">
                        <strong>รถคันนี้ยังไม่ได้ตั้งค่าค่าล่วงเวลาต่อชั่วโมง</strong><br>
                        ใช้ค่าเริ่มต้น (<span x-text="config.ค่าล่วงเวลาเริ่มต้น || 100"></span> บาท/ชั่วโมง)
                        โปรดไปตั้งค่าที่หน้า <strong>จัดการรถ</strong>
                      </p>
                    </div>
                  </div>

                  <!-- ค่าเช่ารวมทั้งหมด -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-blue-700">
                      ค่าเช่ารวมทั้งหมด
                      <i class="fas fa-asterisk text-red-500 text-xs ml-1"></i>
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                      <input type="number" step="0.01" x-model="editRentalData.ค่าเช่ารวมทั้งหมด"
                        @input="calculateEditFinalAmount(); calculateEditCommission()"
                        placeholder="ค่าเช่าทั้งหมด รวมค่าบริการเพิ่มเติมแล้ว" readonly
                        class="w-full pl-8 px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 cursor-not-allowed transition-all">
                    </div>
                  </div>
                </div>

                <!-- คำอธิบายวิธีการคำนวณ -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mt-4">
                  <h5 class="text-md font-medium text-blue-800 mb-2">💡 วิธีการคำนวณ</h5>
                  <div class="text-sm text-blue-700 space-y-1">
                    <div><strong>ค่าเช่ารวมทั้งหมด</strong> = (ราคาต่อวัน × จำนวนวัน) + ค่าล่วงเวลา +
                      ค่าบริการเพิ่มเติม + ค่าคาร์ซีท + ค่าประกันเสริม - ส่วนลด</div>
                    <div><strong>ค่าล่วงเวลา</strong> = (ชั่วโมงเกิน - ชั่วโมงฟรี) × ค่าล่วงเวลาต่อชั่วโมง</div>
                    <div><strong>ค่าประกันเสริม</strong> = จำนวนวันที่ซื้อ × ราคาประกันเสริมต่อวัน</div>
                    <div class="text-xs italic text-blue-600 mt-2">
                      <i class="fas fa-info-circle mr-1"></i>
                      หากชั่วโมงเกิน >= <span x-text="config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน || 4"></span> ชม.
                      จะคิดเพิ่มเป็นอีก 1 วันทันที (ไม่คิดค่าล่วงเวลา)
                    </div>
                  </div>
                </div>
              </div>

              <!-- เงินมัดจำและประกัน -->
              <div class="bg-green-50 p-6 rounded-xl border border-green-200 mb-6">
                <h3 class="text-lg font-semibold text-green-700 mb-4 flex items-center">
                  <i class="fas fa-shield-alt mr-2"></i>เงินมัดจำและประกัน
                </h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      ค่ามัดจำคิวรถ
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-green-600">฿</span>
                      <input type="number" x-model="editRentalData.ค่ามัดจำคิวรถ" @input="calculateEditFinalAmount()"
                        class="w-full pl-8 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      เงินประกันความเสียหาย
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-green-600">฿</span>
                      <input type="number" x-model="editRentalData.เงินประกันความเสียหาย"
                        @input="calculateEditFinalAmount()"
                        class="w-full pl-8 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                  <i class="fas fa-receipt mr-2 text-teal-500"></i>
                  ข้อมูลใบเสร็จ
                </h4>
                <div class="space-y-3">
                  <label @click="editRentalData.wantsTaxInvoice = false"
                    class="flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all"
                    :class="{'bg-blue-50 border-blue-400 ring-1 ring-blue-300': editRentalData.wantsCashBill}">
                    <div class="flex items-center">
                      <i class="fas fa-money-bill-wave mr-3 text-blue-500"></i>
                      <span class="font-medium text-gray-700">ต้องการบิลเงินสด</span>
                    </div>
                    <input type="checkbox" x-model="editRentalData.wantsCashBill" class="toggle-switch">
                  </label>

                  <label @click="editRentalData.wantsCashBill = false"
                    class="flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all"
                    :class="{'bg-green-50 border-green-400 ring-1 ring-green-300': editRentalData.wantsTaxInvoice}">
                    <div class="flex items-center">
                      <i class="fas fa-file-invoice-dollar mr-3 text-green-500"></i>
                      <span class="font-medium text-gray-700">ต้องการใบกำกับภาษี</span>
                    </div>
                    <input type="checkbox" x-model="editRentalData.wantsTaxInvoice" @change="toggleEditTaxInvoice()"
                      class="toggle-switch">
                  </label>

                  <!-- ฟิลด์ VAT สำหรับใบกำกับภาษี (โหมดแก้ไข) -->
                  <div x-show="editRentalData.wantsTaxInvoice" x-transition
                    class="mt-3 p-4 bg-green-50 rounded-xl border border-green-200 space-y-4">
                    <div class="space-y-2">
                      <label class="block text-sm font-semibold text-green-700">
                        จำนวนเงินก่อน VAT (บาท)
                        <i class="fas fa-info-circle text-gray-400 text-xs ml-1" title="สามารถแก้ไขได้"></i>
                      </label>
                      <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-green-600">฿</span>
                        <input type="number" step="0.01" x-model="editRentalData.taxInvoiceAmountExVAT"
                          @input="calculateEditTaxInvoiceVAT()" placeholder="จำนวนเงินก่อน VAT"
                          class="w-full pl-8 px-4 py-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all">
                      </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      <div class="space-y-2">
                        <label class="block text-sm font-semibold text-green-700">
                          VAT 7% (บาท)
                        </label>
                        <div class="relative">
                          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-green-600">฿</span>
                          <input type="text" :value="formatNumber(editRentalData.taxInvoiceVATAmount)" readonly
                            class="w-full pl-8 px-4 py-3 border-2 border-green-200 bg-green-50 rounded-xl text-green-800 font-semibold">
                        </div>
                      </div>

                      <div class="space-y-2">
                        <label class="block text-sm font-semibold text-green-700">
                          ยอดรวมทั้งสิ้น (รวม VAT)
                        </label>
                        <div class="relative">
                          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-green-600">฿</span>
                          <input type="text" :value="formatNumber(editRentalData.taxInvoiceTotal)" readonly
                            class="w-full pl-8 px-4 py-3 border-2 border-green-200 bg-green-50 rounded-xl text-green-800 font-bold text-lg">
                        </div>
                      </div>
                    </div>

                    <div class="text-xs text-green-700 bg-white p-3 rounded-lg">
                      <i class="fas fa-calculator mr-1"></i>
                      <strong>สูตรคำนวณ:</strong> ยอดรวม = จำนวนก่อน VAT × 1.07
                    </div>
                  </div>

                  <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all"
                    :class="{'bg-orange-50 border-orange-400 ring-1 ring-orange-300': editRentalData.wantsWHT}">
                    <div class="flex items-center">
                      <i class="fas fa-file-invoice mr-3 text-orange-500"></i>
                      <div>
                        <span class="font-medium text-gray-700">ต้องการหัก ณ ที่จ่าย</span>
                      </div>
                    </div>
                    <input type="checkbox" x-model="editRentalData.wantsWHT" @change="toggleEditWHT()"
                      class="toggle-switch">
                  </label>

                  <div x-show="editRentalData.wantsWHT" x-transition
                    class="mt-3 p-4 bg-orange-50 rounded-xl border border-orange-200 space-y-4">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      <div class="space-y-2">
                        <label class="block text-sm font-semibold text-orange-700">
                          เปอร์เซ็นต์หัก ณ ที่จ่าย
                        </label>
                        <div class="relative">
                          <input type="number" x-model="editRentalData.whtPercentage"
                            @input="calculateEditWHT(); calculateEditFinalAmount()" min="0" max="15" step="0.5"
                            class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-100">
                          <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">%</span>
                        </div>
                      </div>
                      <div class="space-y-2">
                        <label class="block text-sm font-semibold text-orange-700">
                          จำนวนเงินหัก ณ ที่จ่าย
                        </label>
                        <div class="relative">
                          <input type="text" :value="formatNumber(editRentalData.whtAmount)" readonly
                            class="w-full px-4 py-3 border-2 border-orange-200 bg-orange-50 rounded-xl text-orange-800 font-semibold">
                          <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">บาท</span>
                        </div>
                      </div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-orange-200">
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">ฐานคำนวณ (ก่อน VAT):</span>
                        <span class="font-semibold"
                          x-text="formatNumber(editRentalData.whtBaseAmount || 0) + ' บาท'"></span>
                      </div>
                    </div>

                    <div class="text-xs text-orange-700 bg-white p-3 rounded-lg">
                      <i class="fas fa-info-circle mr-1"></i>
                      <strong>หมายเหตุ:</strong> หัก ณ ที่จ่าย คำนวณจากยอดก่อน VAT
                    </div>
                  </div>
                </div>
              </div>

              <!-- Wrapper: สรุปภาพรวมค่าใช้จ่าย -->
              <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200 mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-6">
                  <i class="fas fa-chart-pie mr-3 text-indigo-500"></i>
                  สรุปภาพรวมค่าใช้จ่าย
                </h3>

                <!-- กรอบที่ 1: รายละเอียดค่าเช่า (สีเขียว) -->
                <div class="bg-green-50 p-4 rounded-xl border border-green-200 mb-4">
                  <h3 class="text-base font-semibold text-green-700 flex items-center mb-3">
                    <i class="fas fa-receipt mr-2"></i>รายละเอียดค่าเช่า
                  </h3>
                  <div class="text-sm space-y-1 text-green-800">
                    <div class="flex justify-between">
                      <span>ค่าเช่าพื้นฐาน (<span x-text="editRentalData.จำนวนวันเช่า || 0"></span> วัน × <span
                          x-text="formatCurrency(editRentalData.ราคา)"></span>)</span>
                      <span x-text="formatCurrency(editRentalData.ค่าเช่าพื้นฐาน || 0)"></span>
                    </div>
                    <template x-if="(parseFloat(editRentalData.ค่าล่วงเวลา) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าล่วงเวลา</span>
                        <span x-text="formatCurrency(editRentalData.ค่าล่วงเวลา)"></span>
                      </div>
                    </template>
                    <template x-if="(parseFloat(editRentalData.ค่าบริการเพิ่มเติม) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าบริการเพิ่มเติม</span>
                        <span x-text="formatCurrency(editRentalData.ค่าบริการเพิ่มเติม)"></span>
                      </div>
                    </template>
                    <template
                      x-if="editRentalData.ต้องการคาร์ซีท && (editRentalData.คาร์ซีทมีค่าบริการ === 'true' || editRentalData.คาร์ซีทมีค่าบริการ === true) && (parseFloat(editRentalData.ค่าคาร์ซีท) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าคาร์ซีท</span>
                        <span x-text="formatCurrency(editRentalData.ค่าคาร์ซีท)"></span>
                      </div>
                    </template>
                    <template
                      x-if="editRentalData.ต้องการประกันเสริม && (parseFloat(editRentalData.ค่าประกันเสริมรวม) || 0) > 0">
                      <div class="flex justify-between">
                        <span>+ ค่าประกันเสริม</span>
                        <span x-text="formatCurrency(editRentalData.ค่าประกันเสริมรวม)"></span>
                      </div>
                    </template>

                    <!-- ส่วนลด -->
                    <template x-if="(parseFloat(editRentalData.ส่วนลด) || 0) > 0">
                      <div class="flex justify-between text-red-600 pt-2 border-t border-green-300">
                        <span>- ส่วนลด</span>
                        <span x-text="formatCurrency(editRentalData.ส่วนลด)"></span>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- กรอบที่ 2: ใบกำกับภาษี (สีฟ้า) -->
                <template
                  x-if="editRentalData.wantsTaxInvoice && (parseFloat(editRentalData.taxInvoiceVATAmount) || 0) > 0">
                  <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-4">
                    <h3 class="text-base font-semibold text-blue-700 flex items-center mb-3">
                      <i class="fas fa-file-invoice mr-2"></i>ใบกำกับภาษี
                    </h3>
                    <div class="text-sm space-y-1 text-blue-800">
                      <div class="flex justify-between">
                        <span>จำนวนเงินที่นำมาคำนวณ VAT</span>
                        <span x-text="formatCurrencyOptional(editRentalData.taxInvoiceAmountExVAT)"></span>
                      </div>
                      <div class="flex justify-between">
                        <span>VAT 7%</span>
                        <span x-text="formatCurrencyOptional(editRentalData.taxInvoiceVATAmount)"></span>
                      </div>
                      <div class="flex justify-between font-bold pt-2 border-t border-blue-300 text-blue-900">
                        <span>= ยอดรวม VAT</span>
                        <span x-text="formatCurrencyOptional(editRentalData.taxInvoiceTotal)"></span>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- กรอบที่ 3: หัก ณ ที่จ่าย (สีส้ม) -->
                <template x-if="editRentalData.wantsWHT && (parseFloat(editRentalData.whtAmount) || 0) > 0">
                  <div class="bg-orange-50 p-4 rounded-xl border border-orange-200 mb-4">
                    <h3 class="text-base font-semibold text-orange-700 flex items-center mb-3">
                      <i class="fas fa-file-contract mr-2"></i>หัก ณ ที่จ่าย
                    </h3>
                    <div class="text-sm space-y-1 text-orange-800">
                      <div class="flex justify-between">
                        <span>ฐานคำนวณ (ก่อน VAT)</span>
                        <span x-text="formatCurrencyOptional(parseFloat(editRentalData.whtBaseAmount) || 0)"></span>
                      </div>
                      <div class="flex justify-between font-bold pt-2 border-t border-orange-300 text-orange-900">
                        <span>= หัก <span x-text="editRentalData.whtPercentage || 5"></span>%</span>
                        <span x-text="'-' + formatCurrencyOptional(editRentalData.whtAmount)"></span>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- กรอบที่ 4: สรุปค่าเช่ารวมทั้งหมด (สีเทา) -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-300 mb-4">
                  <h3 class="text-base font-semibold text-gray-700 flex items-center mb-3">
                    <i class="fas fa-calculator mr-2"></i>สรุปค่าเช่ารวมทั้งหมด
                  </h3>
                  <div class="text-sm space-y-1 text-gray-800">
                    <!-- กรณีมี VAT/WHT -->
                    <template x-if="editRentalData.wantsTaxInvoice || editRentalData.wantsWHT">
                      <div class="space-y-1">
                        <div class="flex justify-between">
                          <span>ยอดคิด VAT/WHT (ค่าเช่า + VAT - WHT)</span>
                          <span
                            x-text="((parseFloat(editRentalData.taxInvoiceTotal) || parseFloat(editRentalData.taxInvoiceAmountExVAT) || 0) - (parseFloat(editRentalData.whtAmount) || 0)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                        </div>

                        <!-- แจกแจงค่าใช้จ่ายที่ไม่คิด VAT/WHT -->
                        <!-- ค่าบริการเพิ่มเติม (ถ้าไม่คิด VAT) -->
                        <template
                          x-if="editRentalData.additionalServiceIncludeVAT !== true && (parseFloat(editRentalData.ค่าบริการเพิ่มเติม) || 0) > 0">
                          <div class="flex justify-between">
                            <span>+ ค่าบริการเพิ่มเติม</span>
                            <span
                              x-text="parseFloat(editRentalData.ค่าบริการเพิ่มเติม).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                          </div>
                        </template>

                        <!-- ค่าคาร์ซีท (ถ้าไม่คิด VAT) -->
                        <template
                          x-if="editRentalData.carSeatIncludeVAT !== true && (parseFloat(editRentalData.ค่าคาร์ซีท) || 0) > 0">
                          <div class="flex justify-between">
                            <span>+ ค่าคาร์ซีท</span>
                            <span
                              x-text="parseFloat(editRentalData.ค่าคาร์ซีท).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                          </div>
                        </template>

                        <!-- ค่าประกันเสริม (ถ้าไม่คิด VAT) -->
                        <template
                          x-if="editRentalData.insuranceIncludeVAT !== true && (parseFloat(editRentalData.ค่าประกันเสริมรวม) || 0) > 0">
                          <div class="flex justify-between">
                            <span>+ ค่าประกันเสริม</span>
                            <span
                              x-text="parseFloat(editRentalData.ค่าประกันเสริมรวม).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                          </div>
                        </template>
                      </div>
                    </template>

                    <!-- กรณีไม่มี VAT/WHT - แสดงยอดรวมตรงๆ (หลังหักส่วนลดแล้ว) -->
                    <template x-if="!editRentalData.wantsTaxInvoice && !editRentalData.wantsWHT">
                      <div class="flex justify-between">
                        <span>รวมค่าใช้จ่ายทั้งหมด (หลังหักส่วนลด)</span>
                        <span
                          x-text="((parseFloat(editRentalData.ค่าเช่าพื้นฐาน) || 0) + (parseFloat(editRentalData.ค่าล่วงเวลา) || 0) + (parseFloat(editRentalData.ค่าบริการเพิ่มเติม) || 0) + (parseFloat(editRentalData.ค่าคาร์ซีท) || 0) + (parseFloat(editRentalData.ค่าประกันเสริมรวม) || 0) - (parseFloat(editRentalData.ส่วนลด) || 0)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                      </div>
                    </template>

                    <!-- ยอดสุทธิ -->
                    <div class="flex justify-between font-bold pt-2 border-t border-gray-400 text-gray-900">
                      <span>= ค่าเช่ารวมทั้งหมด</span>
                      <span x-text="(
                          (editRentalData.wantsTaxInvoice || editRentalData.wantsWHT)
                          ? (
                              ((parseFloat(editRentalData.taxInvoiceTotal) || parseFloat(editRentalData.taxInvoiceAmountExVAT) || 0) - (parseFloat(editRentalData.whtAmount) || 0))
                              + (editRentalData.additionalServiceIncludeVAT !== true ? (parseFloat(editRentalData.ค่าบริการเพิ่มเติม) || 0) : 0)
                              + (editRentalData.carSeatIncludeVAT !== true ? (parseFloat(editRentalData.ค่าคาร์ซีท) || 0) : 0)
                              + (editRentalData.insuranceIncludeVAT !== true ? (parseFloat(editRentalData.ค่าประกันเสริมรวม) || 0) : 0)
                            )
                          : (
                              (parseFloat(editRentalData.ค่าเช่าพื้นฐาน) || 0)
                              + (parseFloat(editRentalData.ค่าล่วงเวลา) || 0)
                              + (parseFloat(editRentalData.ค่าบริการเพิ่มเติม) || 0)
                              + (parseFloat(editRentalData.ค่าคาร์ซีท) || 0)
                              + (parseFloat(editRentalData.ค่าประกันเสริมรวม) || 0)
                              - (parseFloat(editRentalData.ส่วนลด) || 0)
                            )
                        ).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                    </div>
                  </div>
                </div>

                <!-- กรอบที่ 5: ยอดชำระวันรับรถ (สีม่วง) -->
                <div class="bg-purple-50 p-6 rounded-xl border border-purple-200">
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                    <h3 class="text-lg font-semibold text-purple-700 flex items-center mb-2 sm:mb-0">
                      <i class="fas fa-calculator mr-2"></i>รวมยอดชำระวันรับรถ
                    </h3>
                    <div class="text-right">
                      <div class="text-3xl font-bold text-purple-700"
                        x-text="parseFloat(editRentalData.รวมยอดชำระวันรับรถ || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})">
                      </div>

                    </div>
                  </div>
                  <div class="border-t border-purple-300 pt-3">
                    <div class="text-sm space-y-1 text-purple-800">
                      <!-- ยอดสุทธิค่าเช่ารวมทั้งหมด -->
                      <div class="flex justify-between font-semibold">
                        <span>ค่าเช่ารวมทั้งหมด</span>
                        <span x-text="(
                            (editRentalData.wantsTaxInvoice || editRentalData.wantsWHT)
                            ? (
                                ((parseFloat(editRentalData.taxInvoiceTotal) || parseFloat(editRentalData.taxInvoiceAmountExVAT) || 0) - (parseFloat(editRentalData.whtAmount) || 0))
                                + (editRentalData.additionalServiceIncludeVAT !== true ? (parseFloat(editRentalData.ค่าบริการเพิ่มเติม) || 0) : 0)
                                + (editRentalData.carSeatIncludeVAT !== true ? (parseFloat(editRentalData.ค่าคาร์ซีท) || 0) : 0)
                                + (editRentalData.insuranceIncludeVAT !== true ? (parseFloat(editRentalData.ค่าประกันเสริมรวม) || 0) : 0)
                              )
                            : (
                                (parseFloat(editRentalData.ค่าเช่าพื้นฐาน) || 0)
                                + (parseFloat(editRentalData.ค่าล่วงเวลา) || 0)
                                + (parseFloat(editRentalData.ค่าบริการเพิ่มเติม) || 0)
                                + (parseFloat(editRentalData.ค่าคาร์ซีท) || 0)
                                + (parseFloat(editRentalData.ค่าประกันเสริมรวม) || 0)
                                - (parseFloat(editRentalData.ส่วนลด) || 0)
                              )
                          ).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                      </div>

                      <!-- มัดจำและประกัน -->
                      <template x-if="(parseFloat(editRentalData.ค่ามัดจำคิวรถ) || 0) > 0">
                        <div class="flex justify-between text-red-600">
                          <span>- ค่ามัดจำคิวรถ</span>
                          <span
                            x-text="'-' + parseFloat(editRentalData.ค่ามัดจำคิวรถ).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                        </div>
                      </template>
                      <template x-if="(parseFloat(editRentalData.เงินประกันความเสียหาย) || 0) > 0">
                        <div class="flex justify-between text-green-600">
                          <span>+ เงินประกันความเสียหาย</span>
                          <span
                            x-text="'+' + parseFloat(editRentalData.เงินประกันความเสียหาย).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Wrapper: สรุปภาพรวมค่าใช้จ่าย -->
            </div>

            <div class="mb-6"></div>

            <!-- Section: ค่าคอมมิชชั่น -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-percentage mr-2 text-purple-500"></i>
                ค่าคอมมิชชั่น
              </h4>

              <div class="space-y-6">
                <!-- Toggle มีค่าคอมมิชชั่น -->
                <div class="flex items-center justify-between p-4 bg-purple-50 rounded-xl border border-purple-200">
                  <div class="flex items-center">
                    <i class="fas fa-percentage mr-3 text-purple-500 text-xl"></i>
                    <div>
                      <div class="font-semibold text-gray-800">มีค่าคอมมิชชั่น</div>
                      <div class="text-sm text-gray-600">เปิดใช้งานระบบคำนวณค่าคอมมิชชั่น</div>
                    </div>
                  </div>
                  <input type="checkbox" x-model="editRentalData.มีค่าคอมมิชชั่น"
                    @change="updateEditCommissionOnToggle()" class="toggle-switch">
                </div>

                <!-- แสดงเมื่อติ๊ก มีค่าคอมมิชชั่น -->
                <div x-show="editRentalData.มีค่าคอมมิชชั่น" x-transition class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- Dropdown เลือกประเภทคอมมิชชั่น -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      <i class="fas fa-list mr-2 text-blue-500"></i>เลือกประเภทคอมมิชชั่น
                    </label>
                    <select x-model="editRentalData.ค่าคอมมิชชั่นที่เลือก" @change="calculateEditCommission()"
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300">
                      <option value="">กำหนดเอง</option>
                      <template x-for="commission in commissionList" :key="commission.ชื่อ">
                        <option :value="commission.ชื่อ" x-text="commission.ชื่อ"></option>
                      </template>
                    </select>
                  </div>

                  <!-- Input แสดงค่าคอมมิชชั่น -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-blue-700">
                      ค่าคอมมิชชั่น
                      <span x-show="editRentalData.ค่าคอมมิชชั่นที่เลือก"
                        class="text-xs text-gray-500">(คำนวณอัตโนมัติ)</span>
                      <span x-show="!editRentalData.ค่าคอมมิชชั่นที่เลือก" class="text-xs text-orange-600">(กำหนดเอง -
                        แก้ไขได้)</span>
                    </label>
                    <div class="relative">
                      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-600">฿</span>
                      <input type="number" x-model="editRentalData.ค่าคอมมิชชั่น"
                        :readonly="editRentalData.ค่าคอมมิชชั่นที่เลือก !== ''"
                        :class="editRentalData.ค่าคอมมิชชั่นที่เลือก ? 'bg-blue-50 border-blue-400' : 'bg-white border-orange-400'"
                        class="w-full pl-8 px-4 py-3 border-2 rounded-xl font-semibold text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 7: หมายเหตุและสัญญาเช่า -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-file-contract mr-2 text-indigo-500"></i>
                หมายเหตุและสัญญาเช่า
              </h4>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุเพิ่มเติม</label>
                  <textarea x-model="editRentalData.หมายเหตุเพิ่มเติม" rows="3"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="ระบุข้อมูลเพิ่มเติม..."></textarea>
                </div>

                <!-- แสดงลิงก์สัญญาเช่าเดิม -->
                <div x-show="editRentalData.ลิงก์สัญญาเช่า"
                  class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div class="font-medium text-blue-700 mb-2">สัญญาเช่าปัจจุบัน</div>
                  <div class="flex items-center justify-between">
                    <a :href="editRentalData.ลิงก์สัญญาเช่า" target="_blank"
                      class="flex items-center text-blue-600 hover:text-blue-800 hover:underline pointer-events-auto">
                      <i class="fas fa-file-pdf mr-1"></i>
                      <span>ดูสัญญาเช่า</span>
                      <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                    </a>

                    <!-- ปุ่มสลับเพื่อแสดง/ซ่อนส่วนสร้างสัญญาเช่าใหม่ -->
                    <button
                      @click="editRentalData.แก้ไขสัญญาเช่า = !editRentalData.แก้ไขสัญญาเช่า; editRentalData.สร้างสัญญาเช่า = editRentalData.แก้ไขสัญญาเช่า"
                      type="button" class="text-sm px-3 py-1 rounded-md border"
                      :class="editRentalData.แก้ไขสัญญาเช่า ? 'bg-red-100 border-red-300 text-red-700' : 'bg-gray-100 border-gray-300 text-gray-700'">
                      <span x-text="editRentalData.แก้ไขสัญญาเช่า ? 'ยกเลิกการแก้ไข' : 'แก้ไขสัญญาเช่า'"></span>
                    </button>
                  </div>
                </div>

                <!-- สัญญาเช่า Options -->
                <div x-show="!editRentalData.ลิงก์สัญญาเช่า || editRentalData.แก้ไขสัญญาเช่า">
                  <div class="flex items-center mb-3">
                    <input type="checkbox" id="editGenerateContract" x-model="editRentalData.สร้างสัญญาเช่า"
                      class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="editGenerateContract" class="ml-2 block text-sm text-gray-700">
                      <span x-text="editRentalData.ลิงก์สัญญาเช่า ? 'สร้างสัญญาเช่าใหม่' : 'สร้างสัญญาเช่า'"></span>
                    </label>
                  </div>

                  <div x-show="editRentalData.สร้างสัญญาเช่า" x-transition>
                    <div class="mb-2">
                      <label class="block text-sm font-medium text-gray-700 mb-2">เลือกภาษา</label>
                      <select x-model="editRentalData.ภาษาสัญญาเช่า"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="th">🇹🇭 ภาษาไทย</option>
                        <option value="en">🇬🇧 ภาษาอังกฤษ</option>
                        <option value="zh">🇨🇳 ภาษาจีน (ย่อ)</option>
                        <option value="zh-TW">🇹🇼 ภาษาจีน (ตัวเต็ม)</option>
                        <option value="ko">🇰🇷 ภาษาเกาหลี</option>
                        <option value="lo">🇱🇦 ภาษาลาว</option>
                        <option value="my">🇲🇲 ภาษาพม่า</option>
                        <option value="vi">🇻🇳 ภาษาเวียดนาม</option>
                        <option value="ru">🇷🇺 ภาษารัสเซีย</option>
                        <option value="ms">🇲🇾 ภาษามาเลย์</option>
                        <option value="id">🇮🇩 ภาษาอินโดนีเซีย</option>
                        <option value="ja">🇯🇵 ภาษาญี่ปุ่น</option>
                        <option value="he">🇮🇱 ภาษาฮิบรู</option>
                        <option value="fr">🇫🇷 ภาษาฝรั่งเศส</option>
                        <option value="tr">🇹🇷 ภาษาตุรกี</option>
                        <option value="es">🇪🇸 ภาษาสเปน</option>
                        <option value="it">🇮🇹 ภาษาอิตาลี</option>
                        <option value="de">🇩🇪 ภาษาเยอรมัน</option>
                      </select>
                    </div>

                    <div x-show="editRentalData.ลิงก์สัญญาเช่า" class="mt-2">
                      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                        <div class="flex">
                          <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                          </div>
                          <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                              การสร้างสัญญาเช่าใหม่จะลบสัญญาเช่าเดิมออก ลิงก์เดิมจะไม่สามารถใช้งานได้
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                      สัญญาเช่าจะถูกสร้างหลังจากบันทึกการแก้ไขข้อมูล
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- แสดงลิงก์ปฏิทิน (ย้ายมาไว้ล่างสุด) -->
            <div x-show="editRentalData.ลิงก์ปฏิทิน" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-calendar-alt mr-2 text-green-500"></i>
                ปฏิทินการเช่าปัจจุบัน
              </h4>
              <div class="flex items-center justify-between bg-green-50 p-4 rounded-lg border border-green-200">
                <a :href="editRentalData.ลิงก์ปฏิทิน" target="_blank"
                  class="flex items-center text-green-600 hover:text-green-800 hover:underline font-medium pointer-events-auto">
                  <i class="fas fa-calendar-alt mr-2"></i>
                  <span>ดูรายการในปฏิทิน Google Calendar</span>
                  <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer - Sticky -->
        <div class="flex-shrink-0 bg-gray-50 px-6 py-4 border-t border-gray-200">
          <div class="flex flex-col sm:flex-row sm:justify-end gap-3">
            <button @click="closeRentalModal()" type="button"
              class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
              <i class="fas fa-times mr-2"></i>
              <span x-text="isViewMode ? 'ปิด' : 'ยกเลิก'"></span>
            </button>

            <button x-show="!isViewMode" @click="saveRentalEdit()" type="button"
              class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent rounded-lg text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105 shadow-lg">
              <i class="fas fa-save mr-2"></i>
              บันทึกการแก้ไข
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>






  </div>

  <script>
    // Check if Alpine.js is loaded
    console.log('🔍 [Debug] Script tag loaded');
    console.log('🔍 [Debug] Alpine.js available:', typeof Alpine !== 'undefined');

    function app() {
      return {
        currentPage: 'summary',
        isLoading: true,
        searchQuery: '',

        config: {
          ตรวจสอบคิวรถ: false,
          ระยะเวลาเตรียมรถ: "0",
          LINEBotSecretID: ""
        },


        showColumnSelectionModal: false,
        showSummarySection: false,
        availableColumns: [
          { key: 'bookingNo', label: 'หมายเลขจอง' },
          { key: 'carName', label: 'รถที่จอง' },
          { key: 'pickupDate', label: 'วันที่รับรถ' },
          { key: 'pickupTime', label: 'เวลารับรถ' },
          { key: 'pickupLocation', label: 'สถานที่รับรถ' },
          { key: 'returnDate', label: 'วันที่คืนรถ' },
          { key: 'returnTime', label: 'เวลาคืนรถ' },
          { key: 'returnLocation', label: 'สถานที่คืนรถ' },
          { key: 'customerName', label: 'ชื่อลูกค้า' },
          { key: 'customerPhone', label: 'เบอร์ติดต่อ' }
        ],
        selectedColumns: [], // จะเก็บคีย์ของคอลัมน์ที่ถูกเลือก
        isPdfGenerating: false,
        isPdfGenerated: false,
        pdfLoadingStep: 'กำลังเตรียมข้อมูล...',
        pdfLoadingProgress: 10,
        generatedPdfUrl: '',
        pdfIsDailyReport: false,
        isDailyReportMode: false,

        notificationMessage: '', // สำหรับเก็บข้อความ
        notificationType: '', // สำหรับเก็บประเภท (info, success, error)
        notificationTimeout: null, // สำหรับเก็บ ID timeout

        customerSearchResults: [], // เก็บผลลัพธ์การค้นหาลูกค้า
        customerSearchTimeout: null, // ใช้สำหรับหน่วงเวลาการค้นหา
        isCustomerSearching: false, // สถานะกำลังค้นหาลูกค้า
        isValidPrefix: true,

        pickupLocations: [],
        returnLocations: [],
        showPickupLocationEditor: false,
        showReturnLocationEditor: false,
        newPickupLocations: "",
        newReturnLocations: "",

        unspecifiedVehicleMode: false, // สำหรับ toggle switch
        unspecifiedVehicleName: '',
        showUnspecifiedModeInfo: false,
        showBookingNumberInfo: false,


        showPendingVehicleModal: false,
        pendingVehicleBookings: [],
        pendingVehicleStats: {
          total: 0,
          todayPickup: 0,
          tomorrowPickup: 0,
          urgent: 0,
          upcoming: 0
        },

        // สำหรับ Modal ระบุรถ
        showAssignVehicleModal: false,
        currentAssignBooking: null,
        selectedCarForAssignment: '',
        isLoadingAssignment: false,





        assignmentStep: 1,
        contractLanguage: 'th',
        isProcessingAssignment: false,
        currentAssignBooking: null,
        partnerCarData: {
          fullCarName: '',
          licensePlate: '',
          actualRevenue: 0,
          deliveryMethod: 'ส่งเอง',
          returnMethod: 'รับคืนเอง',
          additionalNotes: '',
          pickupLocation: '',
          returnLocation: ''
        },



        allCustomers: [],
        filteredCustomers: [],
        customerSearchQuery: '',
        showCustomerModal: false,
        isEditingCustomer: false,

        // ตัวแปรสำหรับรายการจองล่าสุด
        recentRentals: [],
        isLoadingRecentRentals: false,
        recentRentalsCacheTime: null,
        currentCustomer: {},
        showCustomerDetailsModal: false,
        customerDetails: {
          data: null,
          rentalHistory: []
        },
        expandedHistoryItem: null,
        customerStats: {}, // << เพิ่ม: สำหรับเก็บข้อมูลสรุป
        customerCarChart: null, // << เพิ่ม: สำหรับเก็บ instance ของกราฟ


        showDbMaintenanceModal: false,
        analysisResult: null,

        customerOverviewData: null,


        isBenchmarking_original: false,
        isBenchmarking_optimized: false,
        benchmarkResults_original: [],
        benchmarkResults_optimized: [],
        // ...

        searchFinanceType: 'booking_number',
        searchFinanceQuery: '',
        financeSearchResults: [],
        showAddFinanceModal: false,
        showEditFinanceModal: false,
        newFinancialRecord: {
          linkType: 'none',
          หมายเลขการจอง: '',
          รถที่เกี่ยวข้อง: '',
          รายการ: '',
          ประเภท: 'รายจ่าย',
          จำนวนเงิน: ''
        },

        notification: {
          show: false,
          message: '',
          type: 'info', // 'success', 'error', 'info', 'warning'
          timeout: null
        },

        editingFinancialRecord: {},
        monthlyRevenueExpenseBarChart: null,
        revenueByCarChart: null,



        financeData: { revenues: [], expenses: [] },
        selectedFinanceMonth: new Date().getMonth() + 1,
        selectedFinanceYear: new Date().getFullYear(),
        isLoadingFinance: false,
        financeChart: null,
        monthNames: [
          { value: 1, name: 'มกราคม' }, { value: 2, name: 'กุมภาพันธ์' },
          { value: 3, name: 'มีนาคม' }, { value: 4, name: 'เมษายน' },
          { value: 5, name: 'พฤษภาคม' }, { value: 6, name: 'มิถุนายน' },
          { value: 7, name: 'กรกฎาคม' }, { value: 8, name: 'สิงหาคม' },
          { value: 9, name: 'กันยายน' }, { value: 10, name: 'ตุลาคม' },
          { value: 11, name: 'พฤศจิกายน' }, { value: 12, name: 'ธันวาคม' }
        ],


        advancedSearchQuery: '',
        advancedSearchResults: [],
        isAdvancedSearchActive: false,
        showNewBookingDetailsModal: false,
        currentBookingDetailsForNewModal: null,

        // ตัวแปรใหม่สำหรับฟีเจอร์ค้นหาที่เพิ่มเติม
        showAdvancedSearch: false,
        searchSuggestions: [],
        searchHistory: [],
        activeSuggestionIndex: -1,
        showSuggestions: false,
        isSearching: false,
        searchStatus: null,

        searchTimeout: null,
        minSearchLength: 2, // กำหนดจำนวนตัวอักษรขั้นต่ำที่จะค้นหา
        debounceDelay: 500,


        // มุมมองและการกรอง
        viewMode: 'table',
        currentView: 'all',
        sortField: 'วันที่เช่า',
        sortDirection: 'desc',
        isReordering: false,

        // ตัวกรอง
        advancedFilters: {
          customerInfo: '',
          carInfo: '',
          startDate: '',
          endDate: '',
          status: '',
          sortBy: 'date_desc'
        },

        // ตัวกรองด่วน
        quickFilters: {
          หมายเลขการจอง: '',
          ชื่อลูกค้า: '',
          เบอร์โทรศัพท์: '',
          รถ: '',
          วันที่เช่า: '',
          เลขบัตรประชาชน: '',
          หมายเลขใบขับขี่: ''
        },
        isQuickFilterActive: false,

        // ปฏิทิน
        currentCalendarDate: new Date(),

        // ข้อมูลดิบสำหรับการกรอง
        rawSearchResults: [],


        qrCodeUploadStatus: '',
        logoUploadStatus: "",

        // LINE Bot
        linebotUsers: [], // สำหรับเก็บรายการผู้ใช้ LINE Bot

        carBrands: [], // สำหรับเก็บยี่ห้อรถที่ไม่ซ้ำกัน
        carModels: [],


        showRentalSuccessModal: false, // Modal แสดงหลังบันทึกสำเร็จ
        successRentalData: {}, // ข้อมูลรายการเช่าที่บันทึกสำเร็จ
        showMessagePreviewModal: false, // Modal แสดงตัวอย่างข้อความ
        messagePreviewContent: '', // เนื้อหาข้อความตัวอย่าง


        selectedScheduleDateString: new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 10),

        pickupsForSelectedDate: [], // สำหรับเก็บรายการรับรถของวันที่เลือก
        returnsForSelectedDate: [], // สำหรับเก็บรายการคืนรถของวันที่เลือก
        scheduleDetailModal: { show: false, item: null },



        availabilitySummary: null,


        newFeaturesImages: {
          1: 'https://img2.pic.in.th/pic/1848cdf0452bbb7e4.png', // URL รูปภาพสำหรับ Step 1
          2: 'https://img2.pic.in.th/pic/22618dfdcb36552f3.png', // URL รูปภาพสำหรับ Step 2
          3: 'https://img5.pic.in.th/file/secure-sv1/343d1065156ab8582.png'  // URL รูปภาพสำหรับ Step 3
        },





        // --- ตัวแปรและฟังก์ชันเดิม (ไม่ต้องแก้ไข) ---
        showNewFeatures: false,
        newFeaturesStep: 1,
        totalNewFeaturesSteps: 3,

        // New Features 2025 Tutorial
        showNewFeatures2025Tutorial: false,
        newFeatures2025Step: 1,

        // LINE Bot Tutorial
        showLineBotTutorial: false,
        linebotTutorialStep: 1,
        totalLinebotTutorialSteps: 3,

        translations: {},
        summaryLanguage: 'th',


        typeFilter: '',


        // ส่วนจัดการ license
        showLicenseRenewalModal: false,
        licenseExpired: false,
        licenseExpireDate: '',
        licenseDaysRemaining: 0,
        selectedRenewalPlan: '',
        showPaymentInfo: false,

        slipPreviewUrl: null,
        activeTab: 'plans',




        selectedRevenueYear: new Date().getFullYear(),
        availableYears: [],
        revenueData: [],
        revenueChart: null,


        translationMode: 'edit', // โหมดการแปลภาษา 'edit' หรือ 'create'
        translationKeys: [], // เก็บ key ทั้งหมดสำหรับการแปลภาษา
        selectedTranslationKey: '', // key ที่เลือก
        currentTranslation: {
          th: '', en: '', 'zh-CN': '', ko: '', ru: '', ms: '', ja: '', he: '', fr: '', tr: '',
          es: '', it: '', lo: '', my: '', vi: '', de: '', 'zh-TW': '', id: ''
        },

        newTranslationKey: '', // key ใหม่สำหรับการสร้างแปลภาษาใหม่
        newTranslation: { // ข้อมูลแปลภาษาใหม่
          th: '', en: '', 'zh-CN': '', ko: '', ru: '', ms: '', ja: '', he: '', fr: '', tr: '',
          es: '', it: '', lo: '', my: '', vi: '', de: '', 'zh-TW': '', id: ''
        },
        isTranslating: false, // สถานะกำลังแปล

        selectedKeyToDelete: '', // คีย์ที่เลือกเพื่อลบ
        keyInfoForDeletion: {    // ข้อมูลของคีย์ที่จะลบ
          loaded: false,
          thTranslation: '',
          enTranslation: '',
          translationCount: 0
        },


        bookingForecastData: [],
        bookingForecastChartInstance: null,

        isContractGenerating: false,        // สถานะกำลังสร้างสัญญาเช่า
        contractLoadingStep: "กำลังเตรียมข้อมูล",   // ข้อความแสดงขั้นตอน
        contractLoadingProgress: 0,         // ความคืบหน้าเป็นเปอร์เซ็นต์

        isCarSaving: false,                 // สถานะกำลังบันทึกข้อมูลรถ
        carSavingStep: "กำลังเตรียมข้อมูล",    // ข้อความแสดงขั้นตอน
        carSavingProgress: 0,               // ความคืบหน้าเป็นเปอร์เซ็นต์

        selectedScheduleDate: null,
        showDatePicker: false,
        currentYear: null,
        currentMonth: null,

        selectedScheduleMonth: new Date().getMonth() + 1, // เดือนปัจจุบัน (1-12)
        selectedScheduleYear: new Date().getFullYear(), // ปีปัจจุบัน
        bookingData: {}, // ข้อมูลการจองรถ
        isLoadingBookingTable: false, // สถานะกำลังโหลดข้อมูล
        showBookingDetailsModal: false, // สถานะแสดง modal รายละเอียดการจอง
        currentBookingDetails: null, // ข้อมูลการจองที่กำลังดู
        viewMode: 'table',

        blacklistSearchQuery: "", // คำค้นหา Blacklist
        blacklistSearchResults: [], // ผลลัพธ์การค้นหา
        hasSearched: false, // สถานะว่ามีการค้นหาหรือไม่
        newBlacklist: { // ข้อมูลใหม่ที่จะเพิ่ม
          ชื่อ: "",
          เลขบัตรประจำตัวประชาชน: "",
          รูปแบบการโกง: "",
        },
        blacklistSheetId: "1ysy0Q4vzfpbrbNerkjFQtJcSOqg4hDOVS7faNZCxOa4",




        // === 1. สถานะระบบออนไลน์ ===
        onlineBookingSystemEnabled: false,              // สถานะเปิด/ปิดระบบจองออนไลน์
        isUpdatingSystemStatus: false,                  // สถานะกำลังอัพเดทระบบ
        isLoadingCompleteData: false,                   // สถานะโหลดข้อมูลทั้งหมด

        // === 2. จัดการรถและสถานะออนไลน์ ===
        vehiclesOnlineBookingList: [],                  // รายชื่อรถทั้งหมดพร้อมสถานะ
        isLoadingVehiclesOnlineList: false,             // สถานะโหลดรายชื่อรถ
        vehicleOnlineStatusUpdating: null,              // รหัสรถที่กำลังอัพเดทสถานะ

        // === 3. จัดการกฎราคา (เฉพาะรถที่เปิดออนไลน์) ===
        availableVehiclesForPricing: [],                // รถที่เปิดจองออนไลน์สำหรับตั้งราคา
        priceRulesConfiguration: [],                    // กฎราคาที่ตั้งไว้
        isLoadingPricingVehicles: false,                // สถานะโหลดรถสำหรับตั้งราคา
        pricingMode: 'single',                          // โหมด: 'single' หรือ 'group'

        // === 4. จัดการกลุ่มรถ ===
        vehicleGroupsForPricing: [],                    // กลุ่มรถสำหรับตั้งราคา
        vehicleGroupManagementModal: false,             // Modal จัดการกลุ่มรถ
        vehicleGroupEditingModal: false,                // Modal แก้ไขกลุ่มรถ
        currentEditingVehicleGroup: null,               // กลุ่มรถที่กำลังแก้ไข
        ungroupedVehiclesForSelection: [],              // รถที่ยังไม่ได้จัดกลุ่ม
        vehicleGroupFormData: {                         // ข้อมูลฟอร์มกลุ่มรถ
          id: null,
          name: '',
          description: '',
          selectedVehicleCodes: []                      // ใช้รหัสรถแทนชื่อ
        },
        isUpdatingVehicleGroup: false,                  // สถานะอัพเดทกลุ่มรถ

        // === 5. ตัวแปรสำหรับระบบ Online Booking (ไม่กระทบระบบเดิม) ===
        onlineRentals: [],                              // รายการจองออนไลน์
        isLoadingRentals: false,                        // สถานะโหลดรายการเช่า
        thaiHolidays: [],                               // วันหยุดไทย
        selectedCarId: '',                              // รถที่เลือกในโหมดรายคัน
        selectedGroupId: '',                            // กลุ่มที่เลือก







        // === ตัวแปรปฏิทินเฉพาะ Online Booking (ไม่ซ้ำกับระบบเดิม) ===
        onlineBookingYear: new Date().getFullYear(),    // ปีสำหรับระบบ Online Booking
        onlineBookingMonth: new Date().getMonth(),      // เดือนสำหรับระบบ Online Booking  
        onlineBookingDateRange: { start: null, end: null }, // ช่วงวันที่สำหรับกฎราคา
        onlineBookingAvailableYears: (() => {           // รายการปีสำหรับ Online Booking
          const currentYear = new Date().getFullYear();
          const years = [];
          for (let i = currentYear - 2; i <= currentYear + 5; i++) {
            years.push(i);
          }
          return years;
        })(),

        // === ตัวแปรอื่นๆ ===
        ruleForm: { price: '', description: '' },      // ฟอร์มกฎราคา
        weekDays: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'], // วันในสัปดาห์

        // === ตัวแปรสำหรับการจัดการวันหยุด ===
        autoHolidayPricing: false,                      // เปิด/ปิดการตั้งราคาวันหยุดอัตโนมัติ
        holidayPriceMultiplier: 1.5,                    // ตัวคูณราคาสำหรับวันหยุด (1.5 = เพิ่ม 50%)
        showHolidayNames: true,






















        rentalFilter: 'today',
        customStartDate: '',
        customEndDate: '',
        selectedMonth: new Date().getMonth() + 1,
        selectedYear: new Date().getFullYear(),

        // ข้อมูลสำหรับระบบ Login
        isLoggedIn: false,
        isLoginProcessing: false,
        loginForm: {
          username: '',
          password: ''
        },
        currentUser: {
          username: '',
          role: ''
        },

        editingUser: {
          id: '',
          username: '',
          password: '',
          role: 'user',
          displayName: ''
        },

        // ข้อมูลสำหรับจัดการผู้ใช้งาน
        users: [],
        userPermissions: {},
        currentUser: {},
        editingUser: {},
        userEditMode: false,

        // ตัวแปรใหม่สำหรับระบบกลุ่ม
        rolePermissions: {}, // เก็บสิทธิ์ของแต่ละกลุ่ม
        roleNames: {}, // เก็บชื่อที่แสดงของแต่ละกลุ่ม
        roleDescriptions: {}, // เก็บคำอธิบายของแต่ละกลุ่ม
        currentEditingRole: '', // กลุ่มที่กำลังแก้ไขอยู่
        showAddRoleModal: false, // แสดง/ซ่อนหน้าต่างเพิ่มกลุ่ม
        showDeleteRoleModal: false, // แสดง/ซ่อนหน้าต่างยืนยันการลบกลุ่ม
        roleToDelete: '', // กลุ่มที่จะลบ

        // ตัวแปรสำหรับการเพิ่มกลุ่มใหม่
        newRoleId: '', // รหัสกลุ่มใหม่
        newRoleName: '', // ชื่อกลุ่มใหม่
        newRoleDescription: '', // คำอธิบายกลุ่มใหม่
        newRoleTemplate: 'empty', // ต้นแบบสิทธิ์

        bookingChannels: [],
        // สถิติรายการเช่า


        carUsageStats: [],

        rentalStats: {
          total: 0,
          completed: 0,
          inProgress: 0,
          totalRevenue: 0,
          availableCars: 0,
          totalCars: 0,
          todayPickups: 0,
          todayReturns: 0
        },


        commissionList: [],

        newCommission: {
          ชื่อ: '',
          รูปแบบ: 'fixed',
          ค่าFixed: '',
          ค่าเปอร์เซ็นต์: '',
          vat: ''
        },


        // ข้อมูลหน้าจัดการรถ

        zoneDescription: '',
        showZoneHelp: false,


        showCategoryManagement: false,
        carCategories: [],
        newCategoryName: '',

        cars: [],
        carSearchQuery: '',
        showCarModal: false,
        carCategorySummary: [],
        carModalTitle: 'เพิ่มรถใหม่',
        currentCar: {
          รหัสรถ: '',           // ใหม่
          ประเภทรถ: '',         // ใหม่
          ยี่ห้อ: '',
          รุ่น: '',
          ทะเบียน: '',
          พื้นที่การใช้งาน: '[ZONE1]',
          สี: '',
          ค่าประกันความเสียหาย: '3000',
          ประเภท: 'รถยนต์(น้ำมัน)',
          ราคาเช่าต่อวัน: '',
          สถานะ: 'พร้อมให้เช่า',
          ชนิดเชื้อเพลิง: '[FUELTYPE_1]',
          มีค่าคอมมิชชั่น: false,
          ค่าคอมมิชชั่นที่เลือก: '',
          "รูปแบบค่าคอมมิชชั่น": ''
        },
        showFuelTypeField: true,
        carEditMode: false,

        // ข้อมูลสำหรับสร้างรายการเช่าใหม่

        newRental: {
          ช่องทางการจอง: '',
          หมายเลขการจอง: '',
          ชื่อลูกค้า: '',
          เบอร์โทรศัพท์: '',
          รถ: '',
          ทะเบียนรถ: '',
          วันที่เช่า: new Date().toISOString().slice(0, 10),
          วันที่คืน: '',
          เวลารับรถ: '08:00',
          เวลาคืนรถ: '08:00',
          ราคา: '',
          สถานะ: 'จอง',
          หมายเหตุ: '',
          สร้างสัญญาเช่า: true,
          ภาษาสัญญาเช่า: 'th',
          ลิงก์สัญญาเช่า: '',
          สถานที่รับรถ: '',
          ส่วนลด: '',
          สถานที่คืนรถ: '',
          ค่าเช่ารวมทั้งหมด: '',
          ค่ามัดจำคิวรถ: '',
          เงินประกันความเสียหาย: '',
          ค่าบริการเพิ่มเติม: '',
          รวมยอดชำระวันรับรถ: '',
          เลขบัตรประชาชน: '',
          มีค่าคอมมิชชั่น: false,
          ค่าคอมมิชชั่นที่เลือก: '',
          ค่าคอมมิชชั่น: 0,
          หมายเลขใบขับขี่: '',
          // วันเดือนปีเกิด: '',
          ที่อยู่ลูกค้า: '',
          idCardFile: null,
          idCardPreviewUrl: '',
          drivingLicenseFile: null,
          drivingLicensePreviewUrl: '',
          doc1File: null,
          doc1PreviewUrl: '',
          doc2File: null,
          doc2PreviewUrl: '',
          doc3File: null,
          doc3PreviewUrl: '',
          wantsReceipt: false,
          receiptType: 'cash_bill', // 'cash_bill' or 'tax_invoice'
          totalRentWithoutVat: 0,
          vatAmount: 0,
          wantsWHT: false, // Withholding Tax
          wantsCashBill: false,      // << เพิ่มใหม่
          wantsTaxInvoice: false,  // << เพิ่มใหม่
          whtAmount: 0,
          whtPercentage: 3, // จะถูก override จาก config หลัง loadConfig() เสร็จ
          // Checkbox สำหรับการนำค่าไปคำนวณ VAT/WHT (จะถูก override จาก config หลัง loadConfig() เสร็จ)
          additionalServiceIncludeVAT: false,
          additionalServiceIncludeWHT: false,
          carSeatIncludeVAT: false,
          carSeatIncludeWHT: false,
          insuranceIncludeVAT: false,
          insuranceIncludeWHT: false
        },

        isIdCardProcessing: false,
        idCardProcessStatus: '',
        isDrivingLicenseProcessing: false,
        drivingLicenseProcessStatus: '',
        showImagePreviewModal: false,
        largePreviewImageUrl: '',

        // ข้อมูลสำหรับการแก้ไขรายการเช่า
        showRentalModal: false,
        isViewMode: false, // สถานะโหมดดูข้อมูล (read-only)
        editRentalData: {},

        // สถานะการสร้างเลขที่อัตโนมัติ
        autoGenerateBookingChannel: true,
        autoGenerateBookingNumber: true,
        isGeneratingBookingNumber: false,
        carOptions: [],
        availableCarsData: [],

        showBlankContractModal: false,
        showBlankContractResultModal: false,
        isGeneratingBlankContract: false,
        blankContractSuccess: false,
        blankContractMessage: '',
        blankContractFileUrl: '',
        blankContract: {
          templateName: 'Template_สัญญาเช่า_รถยนต์',
          language: 'th'
        },
        blankContractSuccessState: null,


        showHandoverModal: false,

        // ในส่วนของ handoverData
        handoverData: {
          หมายเลขการจอง: '',
          รถ: '',
          ประเภท: '',
          เลขไมล์: '',
          photos: {
            customer: null,
            speedometer: null,
            front: null,
            back: null,
            left: null,
            right: null
          },
          // --- เพิ่มส่วนนี้ ---
          existingPhotos: { // สำหรับเก็บ URL รูปเดิม
            customer: '',
            speedometer: '',
            front: '',
            back: '',
            left: '',
            right: ''
          },
          oldPhotoFileIds: { // สำหรับเก็บ File ID ของรูปเดิมที่จะลบ
            customer: '',
            speedometer: '',
            front: '',
            back: '',
            left: '',
            right: ''
          },
          gpsLocation: '',
          recordedBy: ''
        },

        currentPhotoType: '',

        displayName: '',


        quotationFormData: { customerName: '', carModel: '', pickupDate: '', returnDate: '', price: '' },
        cashBillFormData: { customerName: '', carModel: '', price: '' },
        taxInvoiceFormData: { customerName: '', carModel: '', price: '' },



        scheduleSearchQuery: '', // สำหรับเก็บค่าในช่องค้นหา
        isSearchingSchedule: false, // สถานะกำลังค้นหา
        scheduleSearchResults: { // สำหรับเก็บผลลัพธ์การค้นหา
          pickups: [],
          returns: [],
          bookingNumber: null
        },

        showTutorial: false,
        tutorialStep: 1,
        stepImages: {
          1: "https://img2.pic.in.th/pic/171f5a83408b0c9fe.png", // รูปแนะนำฟีเจอร์ใหม่
          2: "https://img5.pic.in.th/file/secure-sv1/297aa715f12d5f3c8.png", // รูปการเปิดสวิตช์
          3: "https://img2.pic.in.th/pic/33339f00d685e9fc99af.png", // รูปการ์ดแจ้งเตือน
          4: "https://img2.pic.in.th/pic/448465c191a8df927c.png", // รูปปุ่มระบุรถ
          5: "https://img5.pic.in.th/file/secure-sv1/5ea4738bf40c2db12.png", // รูปฟอร์มกรอกข้อมูล
          6: "https://img2.pic.in.th/pic/6c865ea7cda555731.png", // รูปการส่งรับคืนรถ
          7: "https://img2.pic.in.th/pic/7777bd7d731dffd99d15.png"  // รูปสร้างสัญญา
        },

        expenseCategories: [], // สำหรับเก็บรายการหมวดหมู่เพื่อใช้ใน dropdown
        showCategoryManager: false, // สำหรับเปิด/ปิดส่วนจัดการหมวดหมู่
        newCategoryName: '',



        newBookingcarSearchQuery: '',  // หรือใช้ searchQuery เดิมถ้ามีแล้ว
        showCarSearchResults: false,
        filteredCarOptions: [],


        // --- ตัวแปรสำหรับ "แปลข้อความสรุปสัญญาเช่า" ---
        summaryTranslationKeys: [],
        selectedSummaryKey: '',
        currentSummaryTranslation: {},
        isTranslatingSummary: false,


        // สำหรับระบบแจ้งเตือน
        maintenance: [], // เก็บรายการแจ้งเตือนทั้งหมด
        upcomingMaintenance: [], // เก็บรายการแจ้งเตือนที่กำลังจะถึง
        showMaintenanceModal: false, // สถานะการแสดง Modal
        maintenanceEditMode: false, // โหมดการแก้ไข
        maintenanceModalTitle: 'สร้างการแจ้งเตือนใหม่', // หัวข้อของ Modal
        isCustomMaintenanceType: false, // สถานะการระบุประเภทการแจ้งเตือนเอง
        showAllMaintenanceCards: false, // ควบคุมการแสดงการ์ดแจ้งเตือนแบบขยาย

        currentMaintenance: { // ข้อมูลการแจ้งเตือนที่กำลังแก้ไขหรือสร้างใหม่
          รถ: '',
          ประเภทการแจ้งเตือน: '',
          รูปแบบการแจ้งเตือน: 'ครั้งเดียว',
          วันที่แจ้งเตือน: '',
          วันที่ในเดือน: 1,
          ระยะทางเป้าหมาย: 0,
          ระยะทางปัจจุบัน: 0,
          หมายเหตุ: '',
          สถานะ: 'Active',
          ทำรายการแล้ว: false
        },

        carMaintenanceSearchQuery: '',
        carMaintenanceStatusFilter: 'all',

        showTodayScheduleModal: false,

        showCarQueueModal: false,


        showFilterPanel: false,

        showTodayRentalsModal: false,
        showAvailableCarsModal: false,
        todayActiveRentals: [],
        availableCarsToday: [],
        todayPickups: [],
        todayReturns: [],
        timelineViewMode: 'list', // 'list' หรือ 'compact'
        selectedTimeGroup: null,
        showTimeGroupModal: false,

        scheduleForTimeline: [],

        availabilityResultV2: null,

        pickupDate: new Date().toISOString().split('T')[0],
        pickupTime: '09:00',
        returnDate: new Date(new Date().setDate(new Date().getDate() + 3)).toISOString().split('T')[0],
        returnTime: '09:00',
        prepTime: '60',

        // Results
        allCars: [],
        availableCars: [],
        brandFilter: '',
        modelFilter: '',
        searchPerformed: false,
        isLoading: false,

        // Tab control for bookings page
        bookingsTab: 'search', // 'search' หรือ 'timeline'

        // Timeline Tab Data
        timeline: {
          selectedCar: '',
          selectedMonth: '',
          carList: [],
          monthOptions: [],
          bookings: [],
          summary: { totalDays: 0, rentedDays: 0, freeDays: 0 },
          isLoading: false,
          isLoadingCarList: false, // สถานะการโหลดรายชื่อรถ
          isLoadingComparison: false,
          searchPerformed: false,
          viewMode: 'single', // 'single' หรือ 'comparison'
          similarCars: [],
          comparisonFilterDate: '', // วันที่สำหรับกรองรถว่าง
          showAlternativeSearch: false, // แสดง/ซ่อนการ์ดค้นหารถทดแทน
          alternativeSearch: {
            pickupDate: '',
            pickupTime: '10:00',
            returnDate: '',
            returnTime: '10:00',
            isSearching: false,
            searched: false,
            results: []
          }
        },

        showModelModal: false,
        modalType: '',                  // 'free' | 'short'
        selectedModel: '',
        modelCarsFree: [],              // รายคันของรุ่นที่เลือก (ว่างตลอดช่วง)
        modelCarsShort: [],

        // Toast notification
        showToast: false,
        toastMessage: '',

        // Quote Modal
        showQuoteModal: false,
        quoteData: {
          รถ: '',
          วันที่รับรถ: '',
          เวลารับรถ: '',
          วันที่คืนรถ: '',
          เวลาคืนรถ: '',
          จำนวนวัน: '',
          ราคาต่อวัน: '',
          ค่าประกันความเสียหาย: '',
          ค่าเช่ารวมทั้งหมด: ''
        },
        rawQuoteData: {
          car: '',
          pickupDate: '',
          pickupTime: '',
          returnDate: '',
          returnTime: '',
          rentalDays: 0,
          dailyRate: 0,
          depositAmount: 0,
          bookingDeposit: 0,
          discount: 0,
          totalRent: 0,
          totalPayOnPickup: 0
        },
        quoteMessageGenerated: false,
        generatedQuoteMessage: '',
        quoteCopied: false,



        // ลงทะเบียน
        showRegisterServiceModal: false,
        isRegistered: false,
        selectedServicePlan: '',
        showPaymentFormInfo: false,
        slipFile: null,
        slipPreviewUrl: null,
        activeTab: 'plans',

        // ตัวแปรควบคุมการแสดงโปรโมชั่นเพียงครั้งเดียว
        dismissedPromotion: true,

        // ข้อมูลสำหรับลงทะเบียน
        newUserInfo: {
          email: '',
          password: '',
          phoneNumber: '',
          storeName: ''
        },

        // ตรวจสอบความถูกต้องของข้อมูล
        isValidEmail: true,
        isSubmitting: false,

        // --- New State for Announcements & Problems ---
        loading: false,
        importantAnnouncements: [],
        generalAnnouncements: [],
        announcements: [],
        isModalOpen: false,
        isAllAnnouncementsModalOpen: false,
        selectedAnnouncement: null,
        hasNewAnnouncements: false,

        showReportProblemModal: false,
        reportStep: null, // null, 'form'
        reportProblemType: '', // 'ทั่วไป' or 'ร้ายแรง'
        reportDetails: '',
        isSystemLocked: false,

        isInitialized: false,
        isFetchingAnnouncements: false,

        scheduleDetailModal: {
          show: false,
          item: null
        },


        // เพิ่มตัวแปรสำหรับเก็บค่าใน filter ของ Modal
        pdfFilter: { location: '', carModel: '' },
        allLocations: [], // สำหรับเก็บตัวเลือกสถานที่ใน dropdown
        allCarModels: [], // สำหรับเก็บตัวเลือกรุ่นรถใน dropdown




        availableVehiclesForBlocking: [],
        blockedDatesConfiguration: [],
        blockingReasonsData: [],

        // ตัวแปรสำหรับปฏิทิน
        vehicleBlockingYear: new Date().getFullYear(),
        vehicleBlockingMonth: new Date().getMonth(),
        availableYearsForBlocking: (() => {
          const currentYear = new Date().getFullYear();
          const years = [];
          for (let i = currentYear - 1; i <= currentYear + 2; i++) {
            years.push(i);
          }
          return years;
        })(),
        thaiMonthsForBlocking: [
          'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
          'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
        ],
        dayNamesForBlocking: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'],

        // ตัวแปรสำหรับการเลือกและฟอร์ม
        selectedVehicleForBlocking: '',
        vehicleBlockingDateRange: { start: null, end: null },
        vehicleBlockingForm: { reasonCode: '', description: '' },
        isVehicleBlockingFormEnabled: false,

        // ตัวแปรสำหรับการแก้ไข
        editVehicleBlockingModal: false,
        editingVehicleBlockingRule: {},
        deleteVehicleBlockingModal: false,
        deletingBlockingId: '',

        // ตัวแปรสำหรับความขัดแย้ง
        vehicleBlockingConflictModal: false,
        vehicleBlockingConflicts: [],

        // สถานะการโหลด
        isLoadingVehicleBlocking: false,





        openNewFeaturesTutorial() {
          this.newFeaturesStep = 1; // เริ่มที่ขั้นตอนแรกเสมอ
          this.showNewFeatures = true;
          // เราจะใช้ localStorage เพื่อจำว่าผู้ใช้เคยเห็น Tutorial นี้แล้วหรือยัง
          // เพื่อไม่ให้แสดงซ้ำทุกครั้งที่เปิดหน้าเว็บ
          localStorage.setItem('seenNewFeatures_2025_08', 'true');
        },

        // ฟังก์ชันสำหรับปิด Tutorial
        closeNewFeaturesTutorial() {
          this.showNewFeatures = false;
        },

        // ฟังก์ชันที่ทำงานเมื่อกดปุ่ม "เริ่มใช้งาน" ในขั้นตอนสุดท้าย
        completeNewFeaturesTutorial() {
          this.showNewFeatures = false;
          // อาจจะมีการทำงานอื่นๆ เพิ่มเติมได้ในอนาคต
        },

        // ==================== LINE Bot Tutorial Functions ====================

        // ฟังก์ชันปิด LINE Bot Tutorial
        closeLineBotTutorial() {
          this.showLineBotTutorial = false;
        },

        // ฟังก์ชันเมื่อกดปุ่ม "เริ่มใช้งาน" ใน LINE Bot Tutorial
        completeLineBotTutorial() {
          this.showLineBotTutorial = false;
          localStorage.setItem('seenLineBotTutorial_2025', 'true');

          // นำไปยังหน้าตั้งค่า LINE Bot
          this.currentPage = 'config';
          this.$nextTick(() => {
            const linebotSection = document.getElementById('linebot-settings');
            if (linebotSection) {
              linebotSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        },

        // ฟังก์ชันตรวจสอบว่าควรแสดง LINE Bot Tutorial หรือไม่
        checkAndShowLineBotTutorial() {
          // เช็คว่าเคยเห็น newFeatures แล้วหรือยัง (ต้องเป็น true)
          const seenNewFeatures = localStorage.getItem('seenNewFeatures_2025_08');
          const seenLineBotTutorial = localStorage.getItem('seenLineBotTutorial_2025');

          // แสดง LINE Bot Tutorial ก็ต่อเมื่อ:
          // 1. เคยเห็น newFeatures แล้ว (เพื่อไม่ให้ Modal ซ้อนกัน)
          // 2. ยังไม่เคยเห็น LINE Bot Tutorial
          if (seenNewFeatures === 'true' && !seenLineBotTutorial) {
            setTimeout(() => {
              this.showLineBotTutorial = true;
            }, 800); // หน่วงเวลา 800ms
          }
        },

        // ==================== End LINE Bot Tutorial Functions ====================

        // ==================== New Features 2025 Tutorial Functions ====================

        // ฟังก์ชันปิด New Features 2025 Tutorial
        closeNewFeatures2025Tutorial() {
          this.showNewFeatures2025Tutorial = false;
        },

        // ฟังก์ชันเมื่อกดปุ่ม "เข้าใจแล้ว" ใน New Features 2025 Tutorial
        completeNewFeatures2025Tutorial() {
          this.showNewFeatures2025Tutorial = false;
          localStorage.setItem('seenNewFeatures2025Tutorial', 'true');
        },

        // ฟังก์ชันตรวจสอบว่าควรแสดง New Features 2025 Tutorial หรือไม่
        checkAndShowNewFeatures2025Tutorial() {
          // เช็คว่าเคยเห็น LINE Bot Tutorial แล้วหรือยัง (ต้องเป็น true)
          const seenLineBotTutorial = localStorage.getItem('seenLineBotTutorial_2025');
          const seenNewFeatures2025 = localStorage.getItem('seenNewFeatures2025Tutorial');

          // แสดง New Features 2025 Tutorial ก็ต่อเมื่อ:
          // 1. เคยเห็น LINE Bot Tutorial แล้ว
          // 2. ยังไม่เคยเห็น New Features 2025 Tutorial
          if (seenLineBotTutorial === 'true' && !seenNewFeatures2025) {
            setTimeout(() => {
              this.showNewFeatures2025Tutorial = true;
            }, 800); // หน่วงเวลา 800ms
          }
        },

        // ==================== End New Features 2025 Tutorial Functions ====================

        // ฟังก์ชันสำหรับตรวจสอบว่าควรแสดง Tutorial นี้หรือไม่เมื่อเปิดหน้าเว็บ
        // คุณสามารถเรียกใช้ฟังก์ชันนี้ในส่วน init() ของ Alpine.js ได้
        checkAndShowNewFeatures() {
          if (!localStorage.getItem('seenNewFeatures_2025_08')) {
            // หน่วงเวลาเล็กน้อยเพื่อให้หน้าเว็บโหลดเสร็จก่อน
            setTimeout(() => {
              this.openNewFeaturesTutorial();
            }, 1500); // 1.5 วินาที
          }
        },









        login() {
          if (!this.loginForm.username || !this.loginForm.password) {
            Swal.fire({
              title: 'กรุณากรอกข้อมูล',
              text: 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน',
              icon: 'warning',
              confirmButtonText: 'ตกลง'
            });
            return;
          }

          this.isLoginProcessing = true;

          google.script.run
            .withSuccessHandler(result => {
              this.isLoginProcessing = false;

              if (result.success) {
                this.isLoggedIn = true;
                this.currentUser = result.user;

                // เก็บค่า sheetID และ storeID
                this.sheetID = result.sheetID || '';
                this.storeID = result.storeSID || '';

                // เก็บข้อมูลใน localStorage
                localStorage.setItem('sheetID', this.sheetID);
                localStorage.setItem('storeSID', this.storeID);

                // เก็บข้อมูล license ใน localStorage
                if (result.licenseInfo) {
                  localStorage.setItem('licenseExpireDate', result.licenseInfo.expireDate);
                  localStorage.setItem('licenseNearExpiration', String(result.licenseInfo.nearExpiration || false));
                  localStorage.setItem('licenseExpired', String(result.licenseInfo.expired || false));
                  localStorage.setItem('licenseDaysRemaining', String(result.licenseInfo.daysToExpiration || 0));
                  localStorage.setItem('licensePackage', result.licenseInfo.package || '');
                }

                // เก็บข้อมูลผู้ใช้ใน localStorage
                localStorage.setItem('currentUser', JSON.stringify(result.user));

                // เก็บ displayName
                if (result.user.displayName) {
                  localStorage.setItem('displayName', result.user.displayName);
                }

                // อัพเดทค่าในตัวแปร
                this.licenseExpireDate = result.licenseInfo.expireDate;
                this.licenseExpired = result.licenseInfo.expired || false;
                this.licenseDaysRemaining = result.licenseInfo.daysToExpiration || 0;
                this.licensePackage = result.licenseInfo.package || '';
                this.displayName = result.user.displayName || result.user.username;

                // ตรวจสอบว่า license หมดอายุหรือไม่
                if (this.licenseExpired) {
                  this.openLicenseRenewalModal();
                  return;
                }

                // ตรวจสอบว่ามี sheetID และ storeID หรือไม่
                if (this.sheetID && this.storeID) {
                  // เรียกฟังก์ชันเริ่มต้นหลัง login
                  this.initAfterLogin();
                } else {
                  Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่พบข้อมูล sheetID หรือ storeID โปรดติดต่อผู้ดูแลระบบ',
                    icon: 'error',
                    confirmButtonText: 'ตกลง'
                  });
                  this.logout();
                }
              } else {
                // จัดการกรณี login ไม่สำเร็จ
                if (result.licenseExpired) {
                  this.licenseExpired = true;
                  this.licenseExpireDate = result.expireDate;
                  this.licenseDaysRemaining = 0;

                  localStorage.setItem('licenseExpired', 'true');
                  localStorage.setItem('licenseExpireDate', result.expireDate || '');
                  localStorage.setItem('licenseDaysRemaining', '0');

                  this.openLicenseRenewalModal();
                } else {
                  Swal.fire({
                    title: 'เข้าสู่ระบบไม่สำเร็จ',
                    text: result.message,
                    icon: 'error',
                    confirmButtonText: 'ตกลง'
                  });
                }
              }
            })
            .withFailureHandler(error => {
              this.isLoginProcessing = false;
              Swal.fire({
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error,
                icon: 'error',
                confirmButtonText: 'ตกลง'
              });
            })
            .checkLogin(this.loginForm.username, this.loginForm.password);
        },




        get filteredForPdf() {
          let pickups = this.pickupsForSelectedDate;
          let returns = this.returnsForSelectedDate;

          if (this.pdfFilter.location) {
            const loc = this.pdfFilter.location;
            pickups = pickups.filter(p => p.สถานที่รับรถ === loc);
            returns = returns.filter(r => r.สถานที่คืนรถ === loc);
          }
          if (this.pdfFilter.carModel) {
            const car = this.pdfFilter.carModel;
            pickups = pickups.filter(p => p.รถ === car);
            returns = returns.filter(r => r.รถ === car);
          }
          return { pickups, returns };
        },





        //////////////ถ่ายรูปรถ


        openHandoverModal(item) {
          console.log("=== DEBUG OPEN HANDOVER MODAL ===");
          console.log("item ที่ได้รับ:", JSON.stringify(item, null, 2));

          this.handoverData = {
            หมายเลขการจอง: item.หมายเลขการจอง,
            รถ: item.รถ,
            ประเภท: item.ประเภท || 'รับรถ', // เพิ่ม fallback
            เลขไมล์: '',
            photos: { customer: null, speedometer: null, front: null, back: null, left: null, right: null },
            existingPhotos: { customer: '', speedometer: '', front: '', back: '', left: '', right: '' },
            oldPhotoFileIds: { customer: '', speedometer: '', front: '', back: '', left: '', right: '' },
            gpsLocation: '',
            termsAccepted: false,
            signatureData: null,
            existingSignature: '',
            oldSignatureFileId: ''
          };

          console.log("handoverData หลังจากกำหนดค่า:", {
            หมายเลขการจอง: this.handoverData.หมายเลขการจอง,
            ประเภท: this.handoverData.ประเภท,
            รถ: this.handoverData.รถ
          });

          this.showHandoverModal = true;
          this.isLoading = true;

          // เรียกใช้งาน signature canvas
          this.$nextTick(() => {
            this.initializeSignatureCanvas();
          });

          const sheetID = localStorage.getItem('sheetID') || '';
          console.log("sheetID:", sheetID);

          // === เพิ่ม debug สำหรับการเรียก getHandoverRecord ===
          console.log("กำลังเรียก getHandoverRecord ด้วยพารามิเตอร์:");
          console.log("- bookingNumber:", item.หมายเลขการจอง);
          console.log("- handoverType:", item.ประเภท);
          console.log("- sheetID:", sheetID);

          google.script.run
            .withSuccessHandler(result => {
              console.log("=== DEBUG RESULT FROM getHandoverRecord ===");
              console.log("result:", JSON.stringify(result, null, 2));

              if (result && result.success && result.data) {
                console.log("✅ พบข้อมูลเดิม");
                const record = result.data;

                this.handoverData.เลขไมล์ = record.เลขไมล์ || '';
                this.handoverData.recordedBy = record.ผู้บันทึก || '';

                // ดึงข้อมูลรูปภาพเดิม
                this.handoverData.existingPhotos.customer = record['รูปลูกค้าคู่กับรถ'] || '';
                this.handoverData.existingPhotos.speedometer = record['รูปเรือนไมล์'] || '';
                this.handoverData.existingPhotos.front = record['รูปรถด้านหน้า'] || '';
                this.handoverData.existingPhotos.back = record['รูปรถด้านหลัง'] || '';
                this.handoverData.existingPhotos.left = record['รูปรถด้านซ้าย'] || '';
                this.handoverData.existingPhotos.right = record['รูปรถด้านขวา'] || '';

                // ดึงข้อมูลลายเซ็นเดิม
                this.handoverData.existingSignature = record['ลายเซ็นผู้เช่า'] || '';
                this.handoverData.termsAccepted = !!record['ยืนยันเงื่อนไข'];

                console.log("ข้อมูลลายเซ็นที่ดึงได้:");
                console.log("- existingSignature:", this.handoverData.existingSignature ? "มี" : "ไม่มี");
                console.log("- termsAccepted:", this.handoverData.termsAccepted);

                // แสดงลายเซ็นเดิมใน canvas หากมี
                if (this.handoverData.existingSignature) {
                  console.log("กำลังโหลดลายเซ็นเดิมลง canvas");
                  this.$nextTick(() => {
                    this.loadExistingSignature(this.handoverData.existingSignature);
                  });
                }

                this.handoverData.oldPhotoFileIds = record.photoIds || {};
                this.handoverData.oldSignatureFileId = record.signatureFileId || '';

                this.showNotification('โหลดข้อมูลเดิมสำเร็จ', 'info');
              } else if (result && result.success && !result.data) {
                console.log("ℹ️ ไม่พบข้อมูลเดิม (เป็นการบันทึกครั้งแรก)");
              } else {
                console.error("❌ เกิดข้อผิดพลาด:", result);
                this.showNotification('ไม่สามารถโหลดข้อมูลได้: ' + (result.message || 'ไม่ทราบสาเหตุ'), 'error');
              }

              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("❌ การเรียก getHandoverRecord ล้มเหลว:", error);
              this.showNotification('ไม่สามารถดึงข้อมูลเดิมได้: ' + error, 'error');
              this.isLoading = false;
            })
            .getHandoverRecord(item.หมายเลขการจอง, item.ประเภท, sheetID);
        },

        loadExistingSignature(signatureUrl) {
          console.log("โหลดลายเซ็นเดิม:", signatureUrl);

          const canvas = document.getElementById('signatureCanvas');
          if (!canvas) return;

          const ctx = canvas.getContext('2d');
          const img = new Image();

          img.onload = function () {
            console.log("โหลดสำเร็จ");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.classList.add('signed');
          };

          img.onerror = function () {
            console.log("โหลดไม่ได้");
          };

          // แปลง Google Drive URL
          if (signatureUrl.includes('drive.google.com/file/d/')) {
            const match = signatureUrl.match(/\/file\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
              img.src = 'https://drive.google.com/uc?id=' + match[1];
              return;
            }
          }

          img.src = signatureUrl;
        },

        // ปิดโมดัลบันทึกการรับส่งรถ
        closeHandoverModal() {
          this.showHandoverModal = false;
        },

        // แก้ไขฟังก์ชัน takePhoto ทั้งหมดด้วยโค้ดนี้

        async takePhoto(photoType) {
          this.currentPhotoType = photoType;

          // --- เพิ่มส่วนตรวจสอบและยืนยัน ---
          if (this.handoverData.existingPhotos[photoType]) {
            const result = await Swal.fire({
              title: 'รูปภาพเดิมจะถูกลบ',
              text: "คุณกำลังจะถ่ายรูปใหม่ทับรูปเดิม รูปเก่าจะถูกลบออกจากระบบ ยืนยันหรือไม่?",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#d33',
              cancelButtonColor: '#3085d6',
              confirmButtonText: 'ใช่, ถ่ายรูปใหม่',
              cancelButtonText: 'ยกเลิก'
            });

            if (!result.isConfirmed) {
              return; // ผู้ใช้ยกเลิก
            }
          }
          // --- สิ้นสุดส่วนที่เพิ่ม ---

          const input = document.getElementById('photoCapture');
          input.click();
        },



        // แก้ไขฟังก์ชัน fileToBase64 ให้แน่ใจว่าได้ pure base64
        fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
              const result = reader.result;
              // ✅ ตรวจสอบและตัด data URL prefix ออกให้แน่ใจ
              const base64 = result.includes(',') ? result.split(',')[1] : result;
              resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        },

        // แก้ไขฟังก์ชัน addOverlayToImage ให้มีการตรวจสอบ base64Data
        async addOverlayToImage(base64Data) {
          return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = () => {
              // ตั้งขนาด canvas ตามรูป
              canvas.width = img.width;
              canvas.height = img.height;

              // วาดรูปลงใน canvas
              ctx.drawImage(img, 0, 0);

              // เตรียมข้อมูลสำหรับ overlay
              const now = new Date();
              const dateStr = now.toLocaleDateString('th-TH');
              const timeStr = now.toLocaleTimeString('th-TH');

              // รับตำแหน่ง GPS (ถ้ามี)
              this.getCurrentLocation().then(location => {
                let overlayText = `${dateStr} ${timeStr}`;
                if (location) {
                  overlayText += `\nGPS: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
                } else {
                  overlayText += '\nGPS: ไม่สามารถระบุตำแหน่งได้';
                }

                // วาด overlay ที่มุมขวาล่าง
                this.drawOverlay(ctx, overlayText, canvas.width, canvas.height);

                // แปลงกลับเป็น base64
                const processedBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                resolve(processedBase64);
              }).catch(() => {
                // ถ้าไม่สามารถได้ GPS ให้ใส่แค่วันที่เวลา
                let overlayText = `${dateStr} ${timeStr}\nGPS: ไม่สามารถระบุตำแหน่งได้`;
                this.drawOverlay(ctx, overlayText, canvas.width, canvas.height);

                const processedBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                resolve(processedBase64);
              });
            };

            img.onerror = (error) => {
              console.error('❌ Image load error:', error);
              console.error('❌ base64Data length:', base64Data.length);
              console.error('❌ base64Data preview:', base64Data.substring(0, 100));
              reject(new Error('ไม่สามารถโหลดรูปภาพได้'));
            };

            // ✅ ตรวจสอบและทำความสะอาด base64Data ก่อนใช้งาน
            let cleanBase64 = base64Data;

            // ตรวจสอบว่ามี data URL prefix หรือไม่
            if (cleanBase64.startsWith('data:')) {
              const commaIndex = cleanBase64.indexOf(',');
              if (commaIndex !== -1) {
                cleanBase64 = cleanBase64.substring(commaIndex + 1);
              }
            }

            // ตรวจสอบว่าเป็น valid base64 หรือไม่
            try {
              // ทดสอบ decode base64
              atob(cleanBase64.substring(0, 100)); // ทดสอบแค่ส่วนแรก
              img.src = `data:image/jpeg;base64,${cleanBase64}`;
            } catch (e) {
              console.error('❌ Invalid base64 data:', e);
              reject(new Error('ข้อมูลรูปภาพไม่ถูกต้อง'));
            }
          });
        },

        // แก้ไขฟังก์ชัน handlePhotoCapture ให้มี error handling ที่ดีขึ้น
        async handlePhotoCapture(event) {
          const file = event.target.files[0];
          if (!file) return;

          console.log('📷 Starting photo capture process...');
          console.log('📄 File info:', {
            name: file.name,
            size: file.size,
            type: file.type
          });

          try {
            this.isLoading = true;

            // ตรวจสอบประเภทไฟล์
            if (!file.type.startsWith('image/')) {
              throw new Error('กรุณาเลือกไฟล์รูปภาพเท่านั้น');
            }

            // ตรวจสอบขนาดไฟล์ (เช่น ไม่เกิน 10MB)
            if (file.size > 10 * 1024 * 1024) {
              throw new Error('ไฟล์รูปภาพขนาดใหญ่เกินไป (ไม่เกิน 10MB)');
            }

            console.log('🔄 Converting file to base64...');
            // แปลงไฟล์เป็น base64
            const base64Data = await this.fileToBase64(file);
            console.log('✅ Base64 conversion completed, length:', base64Data.length);

            console.log('🎨 Adding overlay to image...');
            // เพิ่ม GPS และ timestamp overlay
            const processedImage = await this.addOverlayToImage(base64Data);
            console.log('✅ Overlay added successfully, length:', processedImage.length);

            // เก็บรูปใน handoverData
            this.handoverData.photos[this.currentPhotoType] = processedImage;

            console.log('✅ Photo capture process completed successfully');
            this.showNotification('ถ่ายรูปสำเร็จ');

          } catch (error) {
            console.error('❌ Photo capture error:', error);
            this.showNotification('เกิดข้อผิดพลาดในการถ่ายรูป: ' + error.message, 'error');
          } finally {
            this.isLoading = false;
            // รีเซ็ต input
            event.target.value = '';
          }
        },

        // เพิ่มฟังก์ชันตรวจสอบ base64 (สำหรับ debugging)
        validateBase64(base64String) {
          try {
            // ตรวจสอบว่าเป็น valid base64
            const decoded = atob(base64String);

            // ตรวจสอบ signature ของไฟล์รูปภาพ
            const uint8Array = new Uint8Array(decoded.length);
            for (let i = 0; i < decoded.length; i++) {
              uint8Array[i] = decoded.charCodeAt(i);
            }

            // ตรวจสอบ magic number ของไฟล์รูปภาพ
            const hex = Array.from(uint8Array.slice(0, 4))
              .map(b => b.toString(16).padStart(2, '0'))
              .join('');

            console.log('🔍 File signature (hex):', hex);

            // JPEG: FFD8FF, PNG: 89504E47
            const isValidImage = hex.startsWith('ffd8ff') || hex.startsWith('89504e47');

            return {
              isValid: true,
              isValidImage: isValidImage,
              fileType: hex.startsWith('ffd8ff') ? 'JPEG' :
                hex.startsWith('89504e47') ? 'PNG' : 'Unknown',
              size: uint8Array.length
            };
          } catch (error) {
            return {
              isValid: false,
              error: error.message
            };
          }
        },


        // วาด overlay text ลงใน canvas
        drawOverlay(ctx, text, width, height) {
          const fontSize = Math.max(width * 0.02, 12); // ขนาดฟอนต์ตามขนาดรูป
          ctx.font = `${fontSize}px Arial`;
          ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          ctx.strokeStyle = 'white';
          ctx.lineWidth = 2;

          const lines = text.split('\n');
          const lineHeight = fontSize * 1.2;
          const padding = 10;

          // คำนวณตำแหน่งมุมขวาล่าง
          const textWidth = Math.max(...lines.map(line => ctx.measureText(line).width));
          const textHeight = lines.length * lineHeight;

          const x = width - textWidth - padding;
          const y = height - textHeight - padding;

          // วาดพื้นหลัง
          ctx.fillRect(x - 5, y - 5, textWidth + 10, textHeight + 10);

          // วาดข้อความ
          ctx.fillStyle = 'white';
          ctx.textAlign = 'left';

          lines.forEach((line, index) => {
            const lineY = y + (index + 1) * lineHeight;
            ctx.strokeText(line, x, lineY);
            ctx.fillText(line, x, lineY);
          });
        },

        // ดึงตำแหน่ง GPS
        getCurrentLocation() {
          return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error('GPS ไม่รองรับในเบราว์เซอร์นี้'));
              return;
            }

            navigator.geolocation.getCurrentPosition(
              position => {
                resolve({
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude
                });
              },
              error => {
                reject(error);
              },
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
              }
            );
          });
        },


        // แก้ไขใน resetHandoverData()
        resetHandoverData() {
          this.handoverData = {
            หมายเลขการจอง: '',
            รถ: '',
            ประเภท: '',
            เลขไมล์: '',
            photos: { customer: null, speedometer: null, front: null, back: null, left: null, right: null },
            existingPhotos: { customer: '', speedometer: '', front: '', back: '', left: '', right: '' },
            oldPhotoFileIds: { customer: '', speedometer: '', front: '', back: '', left: '', right: '' },
            gpsLocation: '',
            // เพิ่มส่วนลายเซ็น
            termsAccepted: false,
            signatureData: null,
            existingSignature: '',
            oldSignatureFileId: ''
          };
          this.currentPhotoType = '';
          this.initializeSignatureCanvas();
        },


        async saveHandoverData() {
          if (!this.isHandoverDataComplete()) {
            this.showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
            return;
          }

          const action = this.handoverData.ประเภท === 'รับรถ' ? 'ส่งรถ' : 'คืนรถ';

          const confirmResult = await Swal.fire({
            title: `ยืนยันการ${action}`,
            text: `คุณต้องการบันทึกการ${action}หมายเลขการจอง ${this.handoverData.หมายเลขการจอง} ใช่หรือไม่?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: `ใช่, บันทึกการ${action}`,
            cancelButtonText: 'ยกเลิก'
          });

          if (!confirmResult.isConfirmed) return;

          const sheetID = localStorage.getItem('sheetID') || '';
          if (!sheetID) {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่พบ Sheet ID ในระบบ', 'error');
            return;
          }

          // === เพิ่ม DEBUG สำหรับข้อมูลที่จะส่ง ===
          console.log("=== DEBUG FRONTEND DATA ===");
          console.log("handoverData.ประเภท:", this.handoverData.ประเภท);
          console.log("handoverData.termsAccepted:", this.handoverData.termsAccepted);
          console.log("handoverData.signatureData:", this.handoverData.signatureData ? "มีข้อมูล" : "ไม่มีข้อมูล");
          console.log("handoverData.existingSignature:", this.handoverData.existingSignature ? "มีข้อมูล" : "ไม่มีข้อมูล");
          console.log("============================");

          // ตรวจสอบเลขไมล์สำหรับการคืนรถ
          if (this.handoverData.ประเภท === 'ส่งคืนรถ') {
            Swal.fire({
              title: 'กำลังตรวจสอบข้อมูล...',
              text: 'กรุณารอสักครู่ ระบบกำลังตรวจสอบเลขไมล์',
              allowOutsideClick: false,
              showConfirmButton: false,
              didOpen: () => { Swal.showLoading(); }
            });

            try {
              const pickupRecordResult = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .getHandoverRecord(this.handoverData.หมายเลขการจอง, 'รับรถ', sheetID);
              });

              if (pickupRecordResult.success && pickupRecordResult.data) {
                const pickupMileage = parseFloat(pickupRecordResult.data.เลขไมล์);
                const returnMileage = parseFloat(this.handoverData.เลขไมล์);

                if (!isNaN(pickupMileage) && !isNaN(returnMileage) && returnMileage < pickupMileage) {
                  Swal.fire({
                    icon: 'error',
                    title: 'เลขไมล์ไม่ถูกต้อง!',
                    text: `เลขไมล์ปัจจุบัน (${returnMileage}) ต้องมากกว่าหรือเท่ากับเลขไมล์ตอนรับรถ (${pickupMileage})`,
                    confirmButtonText: 'ตกลง'
                  });
                  return;
                }
              }
            } catch (error) {
              console.error("เกิดข้อผิดพลาดในการตรวจสอบเลขไมล์:", error);
            }
          }

          Swal.fire({
            title: 'กำลังบันทึกข้อมูล...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => { Swal.showLoading(); }
          });

          try {
            // เตรียมข้อมูลสำหรับส่งไป Backend
            const dataToSend = {
              หมายเลขการจอง: this.handoverData.หมายเลขการจอง,
              รถ: this.handoverData.รถ,
              ประเภท: this.handoverData.ประเภท,
              เลขไมล์: this.handoverData.เลขไมล์,
              photos: this.handoverData.photos,
              existingPhotos: this.handoverData.existingPhotos,
              oldPhotoFileIds: this.handoverData.oldPhotoFileIds,
              gpsLocation: this.handoverData.gpsLocation,
              username: this.currentUser.username,

              // === เพิ่มข้อมูลลายเซ็นที่ขาดหายไป ===
              termsAccepted: this.handoverData.termsAccepted || false,
              signatureData: this.handoverData.signatureData || null,
              existingSignature: this.handoverData.existingSignature || '',
              oldSignatureFileId: this.handoverData.oldSignatureFileId || ''
            };

            // === DEBUG ข้อมูลที่จะส่ง ===
            console.log("=== DATA TO SEND ===");
            console.log("termsAccepted:", dataToSend.termsAccepted);
            console.log("signatureData:", dataToSend.signatureData ? "มีข้อมูล" : "ไม่มีข้อมูล");
            console.log("existingSignature:", dataToSend.existingSignature ? "มีข้อมูล" : "ไม่มีข้อมูล");
            console.log("====================");

            const result = await new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .saveVehicleHandover(dataToSend, sheetID);
            });

            if (result.success) {
              Swal.fire({
                icon: 'success',
                title: 'บันทึกสำเร็จ!',
                text: `บันทึกการ${action}เรียบร้อยแล้ว`,
                timer: 2000,
                showConfirmButton: false
              });

              this.closeHandoverModal();
            } else {
              throw new Error(result.message || 'เกิดข้อผิดพลาดไม่ทราบสาเหตุ');
            }

          } catch (error) {
            console.error("เกิดข้อผิดพลาดในการบันทึก:", error);
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด!',
              text: 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message,
              confirmButtonText: 'ตกลง'
            });
          }
        },



        // เพิ่มฟังก์ชันใหม่ในส่วน app()
        initializeSignatureCanvas() {
          this.$nextTick(() => {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let hasSignature = false;

            // ตั้งค่า canvas
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // ฟังก์ชันเริ่มวาด
            const startDrawing = (e) => {
              isDrawing = true;
              hasSignature = true;
              const rect = canvas.getBoundingClientRect();
              const x = (e.clientX || e.touches[0].clientX) - rect.left;
              const y = (e.clientY || e.touches[0].clientY) - rect.top;
              ctx.beginPath();
              ctx.moveTo(x, y);
            };

            // ฟังก์ชันวาด
            const draw = (e) => {
              if (!isDrawing) return;
              e.preventDefault();
              const rect = canvas.getBoundingClientRect();
              const x = (e.clientX || e.touches[0].clientX) - rect.left;
              const y = (e.clientY || e.touches[0].clientY) - rect.top;
              ctx.lineTo(x, y);
              ctx.stroke();
            };

            // ฟังก์ชันหยุดวาด
            const stopDrawing = () => {
              if (isDrawing && hasSignature) {
                isDrawing = false;
                this.handoverData.signatureData = canvas.toDataURL('image/png');
                canvas.classList.add('signed');
              }
            };

            // Event listeners สำหรับ mouse
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Event listeners สำหรับ touch (มือถือ)
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            // เก็บ reference ไว้ใช้ใน clearSignature
            this.signatureCanvas = canvas;
            this.signatureCtx = ctx;
          });
        },

        clearSignature() {
          if (this.signatureCanvas && this.signatureCtx) {
            this.signatureCtx.clearRect(0, 0, this.signatureCanvas.width, this.signatureCanvas.height);
            this.handoverData.signatureData = null;
            this.signatureCanvas.classList.remove('signed');
          }
        },

        openRentalContract() {
          // ตรวจสอบว่ามีหมายเลขการจองหรือไม่
          if (!this.handoverData.หมายเลขการจอง) {
            this.showNotification('ไม่พบหมายเลขการจอง', 'error');
            return;
          }

          // แสดงสถานะกำลังโหลด
          this.showNotification('กำลังค้นหาไฟล์สัญญาเช่า...', 'info');

          const sheetID = localStorage.getItem('sheetID') || '';

          // เรียกใช้ฟังก์ชันเพื่อหาลิงก์สัญญาเช่า
          google.script.run
            .withSuccessHandler(result => {
              if (result && result.success && result.contractUrl) {
                // เปิดไฟล์สัญญาเช่าในแท็บใหม่
                window.open(result.contractUrl, '_blank');
                this.showNotification('เปิดไฟล์สัญญาเช่าแล้ว', 'success');
              } else {
                this.showNotification('ไม่พบไฟล์สัญญาเช่าสำหรับหมายเลขการจองนี้', 'warning');
              }
            })
            .withFailureHandler(error => {
              console.error('Error fetching contract:', error);
              this.showNotification('เกิดข้อผิดพลาดในการดึงข้อมูลสัญญาเช่า', 'error');
            })
            .getRentalContractUrl(this.handoverData.หมายเลขการจอง, sheetID);
        },



        // สร้างฟังก์ชันใหม่สำหรับขั้นตอนการบันทึกโดยเฉพาะ
        async processSave() {
          Swal.fire({
            title: 'กำลังบันทึกข้อมูล',
            html: 'กรุณารอสักครู่...',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          try {
            const sheetID = localStorage.getItem('sheetID') || '';

            // ดึงตำแหน่ง GPS
            try {
              const location = await this.getCurrentLocation();
              this.handoverData.gpsLocation = `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
              Swal.update({ html: 'กำลังอัปโหลดรูปภาพ... (ได้รับตำแหน่ง GPS แล้ว)' });
            } catch (gpsError) {
              console.warn("ไม่สามารถรับตำแหน่ง GPS ได้:", gpsError.message);
              this.handoverData.gpsLocation = "ไม่สามารถระบุตำแหน่งได้";
              Swal.update({ html: 'กำลังอัปโหลดรูปภาพ... (ไม่สามารถรับตำแหน่ง GPS)' });
            }

            const idsToDelete = {};
            const photoTypes = ['customer', 'speedometer', 'front', 'back', 'left', 'right'];
            photoTypes.forEach(type => {
              if (this.handoverData.photos[type] && this.handoverData.oldPhotoFileIds[type]) {
                idsToDelete[type] = this.handoverData.oldPhotoFileIds[type];
              }
            });

            const handoverRecord = {
              หมายเลขการจอง: this.handoverData.หมายเลขการจอง,
              รถ: this.handoverData.รถ,
              ประเภท: this.handoverData.ประเภท,
              เลขไมล์: this.handoverData.เลขไมล์,
              photos: this.handoverData.photos,
              username: this.currentUser.displayName,
              gpsLocation: this.handoverData.gpsLocation,
              oldPhotoFileIds: idsToDelete,
              existingPhotos: this.handoverData.existingPhotos,
            };

            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  Swal.fire({
                    title: 'บันทึกสำเร็จ!',
                    text: result.message,
                    icon: 'success'
                  });
                  this.closeHandoverModal();
                  this.fetchScheduleForDate();
                } else {
                  Swal.fire('เกิดข้อผิดพลาด', result.message, 'error');
                }
              })
              .withFailureHandler(error => {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error, 'error');
              })
              .saveVehicleHandover(handoverRecord, sheetID);

          } catch (error) {
            Swal.fire('เกิดข้อผิดพลาด', error.message, 'error');
          }
        },






        loadExpenseCategories() {
          if (this.config && this.config["การจับคู่หมวดหมู่รายจ่าย"]) {
            try {
              const mapping = JSON.parse(this.config["การจับคู่หมวดหมู่รายจ่าย"]);
              // เราจะใช้ Key ของ object มาเป็นรายการหมวดหมู่
              this.expenseCategories = Object.keys(mapping).sort();
            } catch (e) {
              console.error("ไม่สามารถโหลดหมวดหมู่รายจ่ายได้:", e);
              this.expenseCategories = [];
            }
          } else {
            this.expenseCategories = [];
          }
        },

        // เปิด/ปิดส่วนจัดการหมวดหมู่
        toggleCategoryManager() {
          this.showCategoryManager = !this.showCategoryManager;
        },

        // เพิ่มหมวดหมู่ใหม่ (ในฝั่ง Client ก่อน)
        addExpenseCategory() {
          const newCat = this.newCategoryName.trim();
          if (newCat && !this.expenseCategories.includes(newCat)) {
            this.expenseCategories.push(newCat);
            this.expenseCategories.sort();
            this.newCategoryName = '';
          } else if (this.expenseCategories.includes(newCat)) {
            this.showNotification('มีหมวดหมู่นี้อยู่แล้ว', 'warning');
          }
        },

        // ลบหมวดหมู่ (ในฝั่ง Client ก่อน)
        removeExpenseCategory(index) {
          this.expenseCategories.splice(index, 1);
        },

        // บันทึกการเปลี่ยนแปลงหมวดหมู่ลง Google Sheet
        saveExpenseCategories() {
          const sheetID = localStorage.getItem('sheetID') || '';
          if (!sheetID) {
            this.showNotification('ไม่พบ Sheet ID', 'error');
            return;
          }
          this.isLoading = true;
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('บันทึกการตั้งค่าหมวดหมู่สำเร็จ', 'success');
                // โหลด Config ใหม่อีกครั้งเพื่อให้ข้อมูลตรงกัน
                this.loadConfig();
                this.showCategoryManager = false; // ปิดส่วนจัดการ
              } else {
                this.showNotification('บันทึกไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .saveExpenseCategories(sheetID, this.expenseCategories);
        },




        // เพิ่มฟังก์ชันช่วยสำหรับ debug
        debugHandoverData() {
          console.log("=== DEBUG HANDOVER DATA ===");
          console.log("showHandoverModal:", this.showHandoverModal);
          console.log("handoverData:", JSON.stringify(this.handoverData, null, 2));
          console.log("currentPhotoType:", this.currentPhotoType);
          console.log("isHandoverDataComplete:", this.isHandoverDataComplete());
          console.log("sheetID:", localStorage.getItem('sheetID'));
          console.log("google.script available:", typeof google !== 'undefined' && !!google.script);
          console.log("===========================");
        },

        // ปรับปรุงฟังก์ชัน isHandoverDataComplete เพื่อเพิ่ม logging
        //... ให้นำโค้ดใหม่นี้ไปวางทับฟังก์ชัน isHandoverDataComplete() เดิม
        // isHandoverDataComplete() {
        //   // 1. ตรวจสอบว่ากรอกเลขไมล์หรือยัง (สำคัญที่สุด)
        //   if (!this.handoverData.เลขไมล์ || String(this.handoverData.เลขไมล์).trim() === '') {
        //     return false;
        //   }

        //   // 2. สร้างรายการรูปภาพที่ต้องตรวจสอบ
        //   const photoChecks = ['speedometer', 'front', 'back', 'left', 'right'];

        //   // 3. ถ้าเป็น "รับรถ" ต้องมีรูปลูกค้าด้วย
        //   if (this.handoverData.ประเภท === 'รับรถ') {
        //     photoChecks.push('customer');
        //   }

        //   // 4. ตรวจสอบรูปภาพแต่ละจุด
        //   // .every() จะคืนค่า true ก็ต่อเมื่อทุกรายการใน array เป็นไปตามเงื่อนไขทั้งหมด
        //   const allPhotosReady = photoChecks.every(type => {
        //     // เงื่อนไข: มีรูปที่ถ่ายใหม่ (photos[type] มีค่า) หรือ มีรูปเดิมอยู่แล้ว (existingPhotos[type] มี URL)
        //     const hasNewPhoto = !!this.handoverData.photos[type];
        //     const hasExistingPhoto = !!this.handoverData.existingPhotos[type];

        //     // ถ้ามีอย่างใดอย่างหนึ่ง ถือว่าจุดนี้พร้อม
        //     return hasNewPhoto || hasExistingPhoto;
        //   });

        //   // 5. คืนค่าผลลัพธ์: ต้องกรอกเลขไมล์ และรูปภาพทุกจุดต้องพร้อม
        //   return allPhotosReady;
        // },


        // ฟังก์ชันตรวจสอบความครบถ้วนของข้อมูลการรับส่งรถ (ตามความต้องการใหม่)
        isHandoverDataComplete() {
          // 1. ตรวจสอบเลขไมล์ (บังคับทุกกรณี)
          if (!this.handoverData.เลขไมล์ || String(this.handoverData.เลขไมล์).trim() === '') {
            return false;
          }

          // 2. ตรวจสอบความสอดคล้องระหว่างการติ๊กยืนยันและลายเซ็น (เฉพาะการรับรถ)
          if (this.handoverData.ประเภท === 'รับรถ') {
            const hasAccepted = !!this.handoverData.termsAccepted;
            const hasNewSignature = !!this.handoverData.signatureData;
            const hasExistingSignature = !!this.handoverData.existingSignature;
            const hasSignature = hasNewSignature || hasExistingSignature;

            // ตรวจสอบความสอดคล้อง: ต้องติ๊กและเซ็น หรือ ไม่ติ๊กและไม่เซ็น
            if (hasAccepted && !hasSignature) {
              // ติ๊กยืนยันแล้วแต่ไม่มีลายเซ็น → ไม่ผ่าน
              return false;
            }

            if (!hasAccepted && hasSignature) {
              // ไม่ติ๊กยืนยันแต่มีลายเซ็น → ไม่ผ่าน
              return false;
            }

            // กรณีที่ผ่าน:
            // - ติ๊กยืนยัน + มีลายเซ็น (hasAccepted && hasSignature)
            // - ไม่ติ๊กยืนยัน + ไม่มีลายเซ็น (!hasAccepted && !hasSignature)
          }

          // 3. ผ่านการตรวจสอบทั้งหมด
          return true;
        },


























        logout() {
          // ล้างข้อมูลการ login
          this.isLoggedIn = false;
          this.currentUser = null;
          this.sheetID = '';
          this.storeID = '';
          this.isInitialized = false;

          this.currentUser = {
            username: '',
            displayName: '',
            password: '',
            role: 'user'
          };

          // ล้างข้อมูลใน localStorage
          localStorage.removeItem('currentUser');
          localStorage.removeItem('displayName');
          localStorage.removeItem('sheetID');
          localStorage.removeItem('storeSID');
          // (อาจต้องล้างข้อมูล license ด้วย ถ้าต้องการ)

          localStorage.removeItem('licensePackage');
          localStorage.removeItem('licenseExpired');
          localStorage.removeItem('licenseNearExpiration');
          localStorage.removeItem('licenseExpireDate');
          localStorage.removeItem('licenseDaysRemaining');

          // กลับไปที่หน้า login
          this.prepareLoginScreen();
        },

        showZoneHelpModal() {
          this.showZoneHelp = true;
        },


        loadZoneDescription() {
          // ดึงค่าโซนที่เลือกในปัจจุบัน
          const selectedZoneKey = this.currentCar.พื้นที่การใช้งาน;

          // แสดง loading
          this.zoneDescription = 'กำลังโหลด...';

          const sheetID = localStorage.getItem('sheetID') || '';

          // เรียกใช้ฟังก์ชัน server-side เพื่อดึงคำอธิบาย
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.zoneDescription = result.description || 'ไม่พบคำอธิบาย';
              } else {
                this.zoneDescription = 'ไม่สามารถโหลดคำอธิบายได้: ' + result.message;
                console.error("[Client] โหลดคำอธิบายโซนไม่สำเร็จ:", result.message);
              }
            })
            .withFailureHandler(error => {
              this.zoneDescription = 'เกิดข้อผิดพลาดในการโหลดคำอธิบาย';
              console.error("[Client] เกิดข้อผิดพลาดในการโหลดคำอธิบายโซน:", error);
            })
            .getZoneDescription(selectedZoneKey, sheetID);
        },

        openCarQueueModal() {
          this.showCarQueueModal = true;
        },

        // ฟังก์ชันปิด Modal
        closeCarQueueModal() {
          this.showCarQueueModal = false;
        },


        formatZone(ZONE) {
          if (!ZONE) return '';
          // รองรับทั้งรูปแบบ [[zone1]] และ [zone1]
          return ZONE.replace(/\[|\]/g, '');
        },



        setActivePage(page) {
          // ตรวจสอบสิทธิ์ก่อนเปลี่ยนหน้า
          if (!this.hasPermission('page-' + page)) {
            this.showNotification('คุณไม่มีสิทธิ์เข้าถึงหน้า "' + this.getPageName(page) + '"', 'error');
            return;
          }

          // ถ้ากำลังจะไปที่หน้าสร้างรายการเช่าใหม่ - โหลดข้อมูลพื้นฐานเท่านั้น
          if (page === 'newRental') {
            this.isLoading = true;
            const sheetID = localStorage.getItem('sheetID') || '';

            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  // --- โหลดข้อมูลพื้นฐานโดยไม่เช็ครถ ---
                  this.currentPage = page;
                  this.config = result.config;

                  // ตั้งค่าช่องทางการจอง
                  if (this.config.ช่องทางการจอง) {
                    this.bookingChannels = this.config.ช่องทางการจอง.split(',').map(channel => channel.trim());
                  } else {
                    this.bookingChannels = ['Walk-in', 'Line', 'Facebook', 'Telephone'];
                  }

                  // ตั้งค่าหมายเลขการจอง
                  if (this.autoGenerateBookingNumber) {
                    this.newRental.หมายเลขการจอง = result.bookingNumber;
                  }

                  // โหลดข้อมูลสถานที่
                  this.loadLocations();
                  this.loadCommissionList();

                  // โหลดรายการเช่าล่าสุด
                  this.loadRecentRentals();

                  this.$nextTick(() => {
                    this.initNewRentalPage();
                    // โหลดรถหลังจากที่หน้าโหลดเสร็จแล้ว
                    this.loadAvailableCarsForNewRental();
                  });

                } else {
                  this.showNotification('โหลดข้อมูลสำหรับสร้างรายการเช่าไม่สำเร็จ: ' + result.message, 'error');
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error, 'error');
                this.isLoading = false;
              })
              .getNewRentalBasicData(sheetID); // เปลี่ยนเป็นฟังก์ชันใหม่ที่ไม่โหลดรถ

            return;
          }

          // กำหนดหน้าปัจจุบันสำหรับหน้าอื่นๆ
          this.currentPage = page;


          if (page === 'summary') {
            this.loadSummaryData(); // โหลดข้อมูลสรุปทั้งหมด รวมสถิติการใช้งานรถจาก backend

            setTimeout(() => {
              this.checkAndShowNewFeatures();
              // เช็ค LINE Bot Tutorial หลังจาก New Features
              this.checkAndShowLineBotTutorial();
              // เช็ค New Features 2025 Tutorial หลังจาก LINE Bot Tutorial
              this.checkAndShowNewFeatures2025Tutorial();
            }, 500);
          } else if (page === 'schedule') {
            // 1. ตรวจสอบว่ามีวันที่เลือกหรือยัง ถ้ายัง ให้ตั้งเป็นวันนี้
            if (!this.selectedScheduleDateString) {
              const today = new Date();
              const year = today.getFullYear();
              const month = String(today.getMonth() + 1).padStart(2, '0');
              const day = String(today.getDate()).padStart(2, '0');
              this.selectedScheduleDateString = `${year}-${month}-${day}`;
            }
            // 2. เรียกใช้ฟังก์ชันดึงข้อมูลสดใหม่เสมอ
            this.fetchScheduleForDate();
            this.updateBookingTable();
          } else if (page === 'bookings') {

          } else if (page === 'customers') {
            this.loadCustomers();
          } else if (page === 'manual') {
            return;
          } else if (page === 'cars') {
            this.loadConfig();
            this.loadCommissionList();
            this.loadCars();
            this.loadCarCategories();
            this.updateCarCategorySummary();
            this.loadMaintenance();
          } else if (page === 'onlinebooking') {
            this.initOnlineBookingSystem();
            this.ensureCurrentDateTime();
            this.loadVehicleBlockingData();
            this.syncDropdowns();
          } else if (page === 'finance') {
            this.loadRevenueChart();
            this.loadFinancialData();
            this.loadExpenseCategories();
            this.selectedFinanceMonth = (new Date().getMonth() + 1).toString();
            this.selectedFinanceYear = new Date().getFullYear().toString();
            this.loadCars();
          } else if (page === 'config') {
            this.loadConfig();
            this.loadCommissionList();
            this.loadUsers();
            this.loadLineBotSecretID(); // โหลด SecretID จาก Master Sheet
            this.loadLineBotUsers(); // โหลดรายการผู้ใช้ LINE Bot

            this.translationMode = 'delete';
            this.currentTranslation = this.createEmptyTranslation();
            this.syncSummaryTranslationKeys(); // ซิงค์คีย์แปลภาษาสำหรับสรุปการเช่า
            this.loadTranslationKeys();

            this.loadSummaryTranslationKeys();

            this.selectedKeyToDelete = '';
            this.keyInfoForDeletion = {
              loaded: false,
              thTranslation: '',
              enTranslation: '',
              translationCount: 0
            };

            if (!this.userPermissions) {
              this.userPermissions = {
                'company-info': true,
                'payment-settings': true,
                'booking-settings': true,
                'location-settings': true,
                'summary-message-settings': true,
                'translation-settings': false,
                'blacklist-management': false,
                'license-info': false
              };
            }
          }
        },




        // เพิ่มฟังก์ชันใหม่สำหรับโหลดรถหลังจากเข้าหน้า newRental แล้ว
        loadAvailableCarsForNewRental() {
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(result => {
              console.log('getAllCars result:', result); // Debug log

              let carsData = [];
              if (result.success && result.data) {
                carsData = result.data;
              } else if (result.success && result.cars) {
                carsData = result.cars;
              } else if (Array.isArray(result)) {
                carsData = result;
              }

              if (carsData && carsData.length > 0) {
                const availableCars = carsData.filter(car => car && car.สถานะ === 'พร้อมให้เช่า');

                if (availableCars.length === 0) {
                  this.showNotification('ไม่พบรถที่พร้อมให้เช่า กรุณาเพิ่มรถในหน้าจัดการรถ', 'warning');
                  this.carOptions = [];
                  this.availableCarsData = [];
                } else {
                  // --- จุดแก้ไขสำคัญ: เปลี่ยนจากการ map เป็น string มาเป็น object ---
                  this.carOptions = availableCars.map((car, index) => {
                    const brand = car.ยี่ห้อ || '';
                    const model = car.รุ่น || '';
                    const license = car.ทะเบียน || '';

                    let displayText = `${brand} ${model}`.trim();

                    if (license) {
                      displayText += ` (${license})`;
                    } else {
                      displayText += ' (ไม่ระบุทะเบียน)';
                    }

                    // คืนค่าเป็น Object ที่มี id (สำหรับ key) และ text (สำหรับแสดงผล)
                    return {
                      id: index, // ใช้ index ของ array เป็น key ที่ไม่ซ้ำกัน
                      value: displayText, // ค่าที่จะส่งไปเมื่อเลือก
                      text: displayText   // ข้อความที่จะแสดงใน dropdown
                    };
                  });

                  this.availableCarsData = availableCars;
                }
              } else {
                this.showNotification('ไม่พบข้อมูลรถ กรุณาเพิ่มรถในหน้าจัดการรถ', 'warning');
                this.carOptions = [];
                this.availableCarsData = [];
              }
            })
            .withFailureHandler(error => {
              console.error('getAllCars error:', error);
              this.showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูลรถ: ' + error, 'warning');
              this.carOptions = [];
              this.availableCarsData = [];
            })
            .getAllCars(sheetID);
        },


        getPageName(pageCode) {
          const pageNames = {
            'summary': 'สรุปข้อมูลประจำวัน',
            'bookings': 'ค้นหาข้อมูล',
            'schedule': 'ตารางรับส่งรถ',
            'newRental': 'สร้างรายการเช่าใหม่',
            'cars': 'จัดการรถ',
            'config': 'ตั้งค่าระบบ',
            'manual': 'คู่มือการใช้งาน',
            'finance': 'รายรับ-รายจ่าย',
            'onlinebooking': 'จัดการการจองออนไลน์'
          };

          return pageNames[pageCode] || pageCode;
        },


        getGridColumns() {
          // นับจำนวนเมนูที่มีสิทธิ์เข้าถึง
          let visibleMenuCount = 0;
          // เพิ่ม 'finance' ในรายการหน้าทั้งหมด
          const pages = ['summary', 'bookings', 'schedule', 'newRental', 'cars', 'config', 'finance', 'manual', 'onlinebooking'];

          pages.forEach(page => {
            if (this.hasPermission('page-' + page)) {
              visibleMenuCount++;
            }
          });

          // กำหนดจำนวนคอลัมน์ตามจำนวนเมนูที่แสดง
          return `grid-cols-${visibleMenuCount}`;
        },


        loadInitialPage() {
          // console.log("loadInitialPage กำลังทำงาน...");

          // ตรวจสอบว่ามีข้อมูลสิทธิ์หรือไม่
          if (!this.rolePermissions || Object.keys(this.rolePermissions).length === 0) {
            console.warn("ไม่พบข้อมูลสิทธิ์ กำลังใช้ค่าเริ่มต้น");
            // เพิ่มโค้ดสำหรับตั้งค่าเริ่มต้นสิทธิ์ที่นี่ (คล้ายกับที่มีใน initAfterLogin)
          }

          // เรียงลำดับหน้าตามความสำคัญ และเพิ่ม 'finance' เข้าไป
          const pageOrder = ['summary', 'bookings', 'schedule', 'newRental', 'finance', 'cars', 'onlinebooking', 'config'];

          // console.log("กำลังตรวจสอบสิทธิ์การเข้าถึงหน้า...");
          // วนลูปตรวจสอบสิทธิ์และเลือกหน้าแรกที่มีสิทธิ์เข้าถึง
          for (const page of pageOrder) {
            const permission = 'page-' + page;
            // console.log(`ตรวจสอบสิทธิ์ ${permission}: ${this.hasPermission(permission)}`);
            if (this.hasPermission(permission)) {
              this.currentPage = page;
              // console.log(`พบสิทธิ์สำหรับหน้า ${page} กำลังเปิดหน้า...`);
              this.setActivePage(page);
              return;
            }
          }

          // กรณีไม่มีสิทธิ์เข้าถึงหน้าใดเลย
          console.error("ไม่พบสิทธิ์สำหรับหน้าใด ๆ");
          this.showNotification('คุณไม่มีสิทธิ์เข้าถึงส่วนใดของระบบ กรุณาติดต่อผู้ดูแลระบบ', 'error');
        },



        // setActivePage(page) {
        //   this.currentPage = page;

        //   // โหลดข้อมูลตามหน้าที่เปิด
        //   if (page === 'summary') {
        //     this.loadRentals(); // โหลดรายการเช่า (จะเรียกฟังก์ชัน calculateStats ด้วย)
        //     this.loadCars(); // โหลดข้อมูลรถเพื่อคำนวณจำนวนรถว่าง
        //     this.fetchScheduleForDate(); // โหลดตารางรับส่งรถเพื่อคำนวณจำนวนรถส่ง/คืนวันนี้
        //   } else if (page === 'schedule') {
        //     this.fetchScheduleForDate();
        //     this.updateBookingTable();
        //   } else if (page === 'cars') {
        //     this.loadCars();
        //     this.loadMaintenance();
        //   } else if (page === 'config') {
        //     this.loadConfig();
        //     this.loadUsers(); 

        //     // ตั้งค่าสำหรับหน้าแก้ไขคำแปล
        //     this.translationMode = 'delete';
        //     this.currentTranslation = this.createEmptyTranslation(); // กำหนดค่าเริ่มต้นเพื่อป้องกัน null errors
        //     this.loadTranslationKeys();

        //     // เตรียมข้อมูลสำหรับโหมดลบคำแปล
        //     this.selectedKeyToDelete = '';
        //     this.keyInfoForDeletion = {
        //       loaded: false,
        //       thTranslation: '',
        //       enTranslation: '',
        //       translationCount: 0
        //     };
        //   } else if (page === 'newRental') {
        //     // เรียกโหลดการตั้งค่าก่อน และเมื่อโหลดเสร็จแล้วจึงค่อยโหลดข้อมูลอื่นๆ  
        //     this.isLoading = true;
        //     google.script.run
        //       .withSuccessHandler(result => {
        //         this.config = result;

        //         // แปลงช่องทางการจองจากสตริงเป็นอาร์เรย์
        //         if (this.config.ช่องทางการจอง) {
        //           this.bookingChannels = this.config.ช่องทางการจอง.split(',').map(channel => channel.trim());
        //         } else {
        //           // ถ้าไม่มีข้อมูล ให้ใช้ค่าเริ่มต้น
        //           this.bookingChannels = ['Walk-in', 'Line', 'Facebook', 'Telephone'];
        //         }

        //         // เมื่อโหลดการตั้งค่าเสร็จแล้ว ค่อยโหลดข้อมูลอื่นๆ
        //         this.loadLocations();
        //         this.loadCarsForRental();
        //         this.generateBookingNumberIfNeeded();

        //         this.isLoading = false;
        //       })
        //       .withFailureHandler(error => {
        //         this.showNotification('โหลดข้อมูลไม่สำเร็จ: ' + error, 'error');
        //         this.isLoading = false;
        //       })
        //       .getSystemConfig();
        //   }
        // },



        // ฟังก์ชันไว้ใช้ในเมธอดอื่นๆ
        getThaiDate() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        },


        // โหลดปีที่มีข้อมูล
        loadAvailableYears() {
          const years = new Set();
          const currentYear = new Date().getFullYear(); // ได้ค่าเป็น 2025

          // เพิ่มปีย้อนหลังไป 4 ปี, ปีปัจจุบัน และปีถัดไป 1 ปี
          for (let i = -1; i <= 4; i++) {
            years.add(currentYear - i);
          }

          // ถ้ามีข้อมูลการเช่า ดึงปีจากข้อมูลด้วย
          if (this.rentals && this.rentals.length > 0) {
            this.rentals.forEach(rental => {
              if (rental.วันที่เช่า) {
                try {
                  const date = new Date(rental.วันที่เช่า);
                  if (!isNaN(date.getTime())) {
                    years.add(date.getFullYear());
                  }
                } catch (e) {
                  console.error("ไม่สามารถแปลงวันที่ได้:", e);
                }
              }
            });
          }

          // แปลงจาก Set เป็น Array และเรียงลำดับ
          let yearsArray = Array.from(years).sort((a, b) => b - a);

          // สลับตำแหน่งให้ปีปัจจุบันมาเป็นตัวแรก (ถ้ามีในรายการ)
          if (yearsArray.includes(currentYear)) {
            // กรองปีปัจจุบันออกจากรายการ
            yearsArray = yearsArray.filter(year => year !== currentYear);
            // ใส่ปีปัจจุบันเป็นตัวแรก
            yearsArray.unshift(currentYear);
          }

          this.availableYears = yearsArray;

          // ใช้ปีปัจจุบันเป็นค่าเริ่มต้น
          this.selectedRevenueYear = currentYear;
        },





        loadRevenueData(year) {
          this.isLoadingRevenue = true;

          // แสดงสถานะการโหลด
          const chartElement = document.getElementById('revenueChart');
          if (chartElement) {
            chartElement.innerHTML = `
      <div class="flex items-center justify-center h-full">
        <div class="text-center p-8">
          <i class="fas fa-spinner fa-spin text-indigo-500 text-3xl mb-3"></i>
          <p class="text-gray-500">กำลังโหลดข้อมูลรายได้ปี ${year || this.selectedRevenueYear}...</p>
        </div>
      </div>
    `;
          }

          // ตรวจสอบว่า google.script.run พร้อมใช้งานหรือไม่
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            this.showNotification('เกิดข้อผิดพลาด: ไม่สามารถเชื่อมต่อกับ Google Apps Script ได้', 'error');
            console.error("Google Script API (google.script.run) is not available.");
            this.isLoadingRevenue = false;
            return;
          }

          const sheetID = localStorage.getItem('sheetID') || '';
          const selectedYear = year || this.selectedRevenueYear;

          console.log(`[Client] กำลังโหลดข้อมูลรายได้สำหรับปี ${selectedYear}...`);

          // เพิ่ม timeout เพื่อให้แน่ใจว่า UI แสดงไอคอนการโหลดก่อน
          setTimeout(() => {
            google.script.run
              .withSuccessHandler(result => {
                console.log(`[Client] ได้รับข้อมูลรายได้สำเร็จสำหรับปี ${selectedYear}, จำนวน ${result.length} รายการ`);

                // จัดเรียงข้อมูลตามเดือน
                const monthlyRevenue = Array(12).fill(0);
                const monthNames = [
                  "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
                  "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
                ];

                // คำนวณรายได้รายเดือน
                if (Array.isArray(result) && result.length > 0) {
                  result.forEach(item => {
                    if (item.month >= 0 && item.month < 12 && !isNaN(item.revenue)) {
                      monthlyRevenue[item.month] += parseFloat(item.revenue);
                    }
                  });
                }

                // สร้างข้อมูลสำหรับกราฟ
                this.revenueData = monthlyRevenue.map((revenue, index) => {
                  return {
                    x: monthNames[index],
                    y: revenue
                  };
                });

                // คำนวณรายได้รวม
                const totalRevenue = monthlyRevenue.reduce((sum, val) => sum + val, 0);
                console.log(`[Client] รายได้รวมทั้งปี ${selectedYear}: ${totalRevenue.toLocaleString('th-TH')} บาท`);

                // เรียกสร้างกราฟหลังจากจัดเตรียมข้อมูลเสร็จ
                this.renderRevenueChart();
                this.isLoadingRevenue = false;
              })
              .withFailureHandler(error => {
                console.error(`[Client] เกิดข้อผิดพลาดในการโหลดข้อมูลรายได้ปี ${selectedYear}:`, error);
                const errorMessage = typeof error === 'object' ? error.message : error;
                this.showNotification('โหลดข้อมูลรายได้ไม่สำเร็จ: ' + errorMessage, 'error');

                // ล้างข้อมูลเดิมและแสดงข้อความผิดพลาด
                const chartElement = document.getElementById('revenueChart');
                if (chartElement) {
                  chartElement.innerHTML = `
            <div class="flex items-center justify-center h-full">
              <div class="text-center p-8">
                <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
                <p class="text-gray-500">เกิดข้อผิดพลาดในการโหลดข้อมูลรายได้</p>
              </div>
            </div>
          `;
                }

                this.isLoadingRevenue = false;
              })
              .getRevenueData(sheetID, selectedYear);
          }, 100); // ให้เวลา UI แสดงไอคอนการโหลด 100ms
        },

        // ปรับปรุงฟังก์ชั่น loadRevenueChart
        loadRevenueChart() {
          // ดึงข้อมูลรายได้โดยตรงจาก Google Sheets
          this.loadRevenueData(this.selectedRevenueYear);
        },



        // ฟังก์ชั่นใหม่สำหรับการโหลดข้อมูลรายได้โดยเฉพาะ
        loadRevenueData(year) {
          this.isLoadingRevenue = true; // เพิ่มตัวแปรสถานะการโหลด

          // ตรวจสอบว่า google.script.run พร้อมใช้งานหรือไม่
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            this.showNotification('เกิดข้อผิดพลาด: ไม่สามารถเชื่อมต่อกับ Google Apps Script ได้', 'error');
            console.error("Google Script API (google.script.run) is not available.");
            this.isLoadingRevenue = false;
            return;
          }

          const sheetID = localStorage.getItem('sheetID') || '';
          const selectedYear = year || this.selectedRevenueYear; // ถ้าไม่ระบุปี ใช้ปีที่เลือกปัจจุบัน

          console.log(`[Client] กำลังโหลดข้อมูลรายได้สำหรับปี ${selectedYear}...`);

          google.script.run
            .withSuccessHandler(result => {
              console.log(`[Client] ได้รับข้อมูลรายได้สำเร็จสำหรับปี ${selectedYear}`);

              if (Array.isArray(result)) {
                // จัดเรียงข้อมูลตามเดือน
                const monthlyRevenue = Array(12).fill(0);
                const monthNames = [
                  "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
                  "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
                ];

                result.forEach(item => {
                  if (item.month >= 0 && item.month < 12) {
                    monthlyRevenue[item.month] += item.revenue;
                  }
                });

                // สร้างข้อมูลสำหรับกราฟ
                this.revenueData = monthlyRevenue.map((revenue, index) => {
                  return {
                    x: monthNames[index],
                    y: revenue
                  };
                });

                // คำนวณรายได้รวม
                const totalRevenue = monthlyRevenue.reduce((sum, val) => sum + val, 0);
                console.log(`[Client] รายได้รวมทั้งปี ${selectedYear}: ${totalRevenue} บาท`);

                // สร้างหรืออัปเดตกราฟ
                this.renderRevenueChart();
              } else {
                console.error("[Client] ข้อมูลที่ได้รับไม่ใช่ Array - กราฟ:", result);
                this.showNotification('ข้อมูลที่ได้รับมีรูปแบบไม่ถูกต้อง', 'error');
              }

              this.isLoadingRevenue = false;
            })
            .withFailureHandler(error => {
              console.error(`[Client] เกิดข้อผิดพลาดในการโหลดข้อมูลรายได้ปี ${selectedYear}:`, error);
              const errorMessage = typeof error === 'object' ? error.message : error;
              this.showNotification('โหลดข้อมูลรายได้ไม่สำเร็จ: ' + errorMessage, 'error');
              this.isLoadingRevenue = false;
            })
            .getRevenueData(sheetID, selectedYear); // เรียกใช้ฟังก์ชัน getRevenueData ใน Apps Script
        },

        // ปรับปรุงฟังก์ชั่น loadRevenueChart
        loadRevenueChart() {
          // ดึงข้อมูลรายได้โดยตรงจาก Google Sheets
          this.loadRevenueData(this.selectedRevenueYear);
        },




        renderRevenueChart() {
          console.log("เริ่มสร้างกราฟด้วยข้อมูล:", this.revenueData);

          // ตรวจสอบว่ามีข้อมูลหรือไม่
          const hasData = this.revenueData.some(item => item.y > 0);
          console.log("มีข้อมูลรายได้:", hasData);

          // ลบกราฟเก่าถ้ามี
          if (this.revenueChart) {
            this.revenueChart.destroy();
          }

          const chartElement = document.getElementById('revenueChart');
          if (!chartElement) {
            console.error("ไม่พบ Element 'revenueChart' สำหรับสร้างกราฟ");
            return;
          }

          if (!hasData) {
            // กรณีไม่มีข้อมูล ให้แสดงข้อความแทนกราฟ
            chartElement.innerHTML = `
      <div class="flex items-center justify-center h-full">
        <div class="text-center p-8">
          <i class="fas fa-info-circle text-gray-400 text-3xl mb-3"></i>
          <p class="text-gray-500">ไม่พบข้อมูลรายได้สำหรับปี ${this.selectedRevenueYear}</p>
        </div>
      </div>
    `;
            return;
          }

          // กำหนดค่า options สำหรับกราฟ
          const options = {
            series: [{
              name: 'รายได้',
              data: this.revenueData
            }],
            chart: {
              type: 'bar',
              height: 320,
              toolbar: {
                show: false
              }
            },
            colors: ['#8b5cf6'], // สีม่วง
            plotOptions: {
              bar: {
                borderRadius: 4,
                dataLabels: {
                  position: 'top',
                },
              }
            },
            dataLabels: {
              enabled: true,
              formatter: function (val) {
                // ไม่แสดงค่าถ้าเป็น 0
                return val === 0 ? '' : val.toLocaleString('th-TH') + ' ฿';
              },
              offsetY: -20,
              style: {
                fontSize: '12px',
                colors: ["#304758"]
              }
            },
            xaxis: {
              categories: this.revenueData.map(item => item.x),
              position: 'bottom',
              labels: {
                style: {
                  fontFamily: 'Prompt, sans-serif'
                }
              },
              axisBorder: {
                show: false
              },
              axisTicks: {
                show: false
              },
              crosshairs: {
                fill: {
                  type: 'gradient',
                  gradient: {
                    colorFrom: '#D8E3F0',
                    colorTo: '#BED1E6',
                    stops: [0, 100],
                    opacityFrom: 0.4,
                    opacityTo: 0.5,
                  }
                }
              },
              tooltip: {
                enabled: true,
              }
            },
            yaxis: {
              axisBorder: {
                show: false
              },
              axisTicks: {
                show: false,
              },
              labels: {
                show: true,
                formatter: function (val) {
                  return val.toLocaleString('th-TH') + ' ฿';
                },
                style: {
                  fontFamily: 'Prompt, sans-serif'
                }
              }
            },
            title: {
              text: `รายได้ประจำปี ${this.selectedRevenueYear}`,
              align: 'center',
              style: {
                fontFamily: 'Prompt, sans-serif',
                fontSize: '16px'
              }
            },
            tooltip: {
              y: {
                formatter: function (val) {
                  return val.toLocaleString('th-TH') + ' บาท';
                }
              }
            }
          };

          // สร้างกราฟใหม่
          try {
            console.log("กำลังสร้างกราฟ...");
            this.revenueChart = new ApexCharts(chartElement, options);
            this.revenueChart.render();
            console.log("สร้างกราฟเสร็จสมบูรณ์");
          } catch (error) {
            console.error("เกิดข้อผิดพลาดในการสร้างกราฟ:", error);
            chartElement.innerHTML = `
      <div class="flex items-center justify-center h-full">
        <div class="text-center p-8">
          <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
          <p class="text-gray-500">เกิดข้อผิดพลาดในการสร้างกราฟ: ${error.message}</p>
        </div>
      </div>
    `;
          }
        },
















        // ฟังก์ชันค้นหาข้อมูลลูกค้า
        searchCustomer(event) {
          const query = event.target.value;

          // ยกเลิกการค้นหาเก่าที่กำลังรอ (ป้องกันการส่ง request มากเกินไป)
          clearTimeout(this.customerSearchTimeout);

          // ล้างผลการค้นหาเมื่อไม่มีข้อมูลในช่อง
          if (!query || query.length < 2) {
            this.customerSearchResults = [];
            this.isCustomerSearching = false;
            return;
          }

          // หน่วงเวลาการค้นหา 300ms เพื่อรอให้ผู้ใช้พิมพ์เสร็จ
          this.isCustomerSearching = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          this.customerSearchTimeout = setTimeout(() => {
            google.script.run
              .withSuccessHandler(result => {
                if (result.success && result.data) {
                  this.customerSearchResults = result.data;
                } else {
                  this.customerSearchResults = [];
                }
                this.isCustomerSearching = false;
              })
              .withFailureHandler(error => {
                console.error("Error searching customer:", error);
                this.customerSearchResults = [];
                this.isCustomerSearching = false;
              })
              .searchCustomer(query, sheetID);
          }, 300);
        },


        openNewBookingDetailsModal(rental) {
          this.currentBookingDetailsForNewModal = rental;
          this.showNewBookingDetailsModal = true;
        },

        closeNewBookingDetailsModal() {
          this.showNewBookingDetailsModal = false;
          this.currentBookingDetailsForNewModal = null;
        },




        validateBookingPrefix() {
          // ปรับค่าให้เป็นตัวพิมพ์ใหญ่ทั้งหมด
          if (this.config.คำนำหน้าหมายเลขการจอง) {
            this.config.คำนำหน้าหมายเลขการจอง = this.config.คำนำหน้าหมายเลขการจอง.toUpperCase();
          }

          // ตรวจสอบว่าเป็นตัวอักษรภาษาอังกฤษพิมพ์ใหญ่เท่านั้น
          const regex = /^[A-Z]{0,2}$/;
          this.isValidPrefix = regex.test(this.config.คำนำหน้าหมายเลขการจอง || '');
        },

        // ฟังก์ชันเลือกข้อมูลลูกค้า
        // selectCustomer(customer) {
        //   // นำข้อมูลลูกค้าไปกรอกในฟอร์ม
        //   this.newRental.ชื่อลูกค้า = customer.ชื่อลูกค้า;
        //   this.newRental.เบอร์โทรศัพท์ = customer.เบอร์โทรศัพท์;

        //   // ล้างผลการค้นหา
        //   this.customerSearchResults = [];

        //   // แจ้งเตือนว่าได้นำข้อมูลลูกค้าเดิมมาใช้
        //   Swal.fire({
        //     title: 'ใช้ข้อมูลลูกค้าเดิม',
        //     text: `ได้นำข้อมูลของ ${customer.ชื่อลูกค้า} มาใช้แล้ว`,
        //     icon: 'success',
        //     timer: 1500,
        //     showConfirmButton: false
        //   });
        // },


        selectCustomer(customer) {
          // นำข้อมูลลูกค้าไปกรอกในฟอร์ม
          this.newRental.ชื่อลูกค้า = customer.ชื่อลูกค้า;
          this.newRental.เบอร์โทรศัพท์ = customer.เบอร์โทรศัพท์;
          this.newRental.เลขบัตรประชาชน = customer.เลขบัตรประชาชน;  // กรอกเลขบัตรประชาชน
          this.newRental.หมายเลขใบขับขี่ = customer.หมายเลขใบขับขี่;  // กรอกหมายเลขใบขับขี่
          this.newRental.ที่อยู่ลูกค้า = customer.ที่อยู่ลูกค้า;  // กรอกที่อยู่ลูกค้า

          // ล้างผลการค้นหา
          this.customerSearchResults = [];

          // เรียกใช้ฟังก์ชัน checkIdCardHistory ทันทีหลังจากเลือกข้อมูลลูกค้า
          this.checkIdCardHistory({
            target: { value: customer.เลขบัตรประชาชน }
          });

          // แจ้งเตือนว่าได้นำข้อมูลลูกค้าเดิมมาใช้
          Swal.fire({
            title: 'ใช้ข้อมูลลูกค้าเดิม',
            text: `ได้นำข้อมูลของ ${customer.ชื่อลูกค้า} มาใช้แล้ว`,
            icon: 'success',
            timer: 1500,
            showConfirmButton: false
          });
        },

        useSearchedData(rental) {
          // นำข้อมูลที่ได้จากการค้นหาไปเติมในฟอร์ม newRental
          this.newRental.ชื่อลูกค้า = rental.ชื่อลูกค้า || '';
          this.newRental.เบอร์โทรศัพท์ = rental.เบอร์โทรศัพท์ || '';
          this.newRental.เลขบัตรประชาชน = rental.เลขบัตรประชาชน || '';
          this.newRental.หมายเลขใบขับขี่ = rental.หมายเลขใบขับขี่ || '';
          this.newRental.ที่อยู่ลูกค้า = rental.ที่อยู่ลูกค้า || '';

          // ซ่อนผลการค้นหาหลังจากเลือกแล้ว
          this.isAdvancedSearchActive = false;
          this.advancedSearchQuery = '';
          this.advancedSearchResults = [];

          // แสดงข้อความยืนยัน
          Swal.fire({
            title: 'นำข้อมูลมาใช้แล้ว',
            text: `ข้อมูลของ ${rental.ชื่อลูกค้า} ถูกนำไปกรอกในฟอร์มเรียบร้อยแล้ว`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });

          // เลื่อนหน้าจอไปที่ด้านบนสุดของฟอร์ม
          const formElement = document.querySelector('[data-tutorial="booking-info"]');
          if (formElement) {
            formElement.scrollIntoView({ behavior: 'smooth' });
          }
        },


        showNotification(message, type = 'success', duration = 3000) {
          // ยกเลิก timeout เก่า (ถ้ามี)
          if (this.notification.timeout) {
            clearTimeout(this.notification.timeout);
          }

          // ตั้งค่าข้อความและประเภท
          this.notification.message = message;
          this.notification.type = type;
          this.notification.show = true;

          // ตั้งเวลาซ่อนอัตโนมัติ
          this.notification.timeout = setTimeout(() => {
            this.notification.show = false;
          }, duration);
        },



        // สร้างตัวเลือกเดือนสำหรับ Timeline Tab
        initializeTimelineMonthOptions() {
          // ป้องกันการทำงานซ้ำ
          if (this.timeline.monthOptions && this.timeline.monthOptions.length > 0) {
            console.log('[Timeline] initializeTimelineMonthOptions() - ข้ามการทำงานเพราะมี monthOptions อยู่แล้ว');
            return;
          }

          const monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
          const today = new Date();

          const options = [];

          for (let i = -6; i <= 6; i++) {
            const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
            const year = date.getFullYear() + 543;
            const month = date.getMonth();
            const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const label = `${monthNames[month]} ${year}`;
            options.push({ value, label });
          }

          this.timeline.monthOptions = options;

          // ตั้งค่าเดือนปัจจุบันหลังจากสร้าง options แล้ว
          const currentMonth = new Date();
          const currentValue = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;

          // ใช้ $nextTick เพื่อให้แน่ใจว่า DOM อัปเดตแล้ว
          this.$nextTick(() => {
            this.timeline.selectedMonth = currentValue;
            console.log('[Timeline] เริ่มต้นเดือน:', this.timeline.selectedMonth, 'ตัวเลือกทั้งหมด:', this.timeline.monthOptions.length);
          });
        },

        init() {
          // ส่วนที่ต้องทำงานเสมอไม่ว่าจะ login หรือไม่
          // this.updateTime();
          // setInterval(() => this.updateTime(), 1000);

          // เริ่มต้น AOS (แอนิเมชัน)
          if (typeof AOS !== 'undefined') {
            AOS.init({
              duration: 800,
              once: true
            });
          }

          // สร้าง monthOptions สำหรับ Timeline Tab
          this.initializeTimelineMonthOptions();

          this.currentUser = {
            username: '',
            displayName: '',
            password: '',
            role: 'user'
          };

          // โหลดการตั้งค่า timeline view mode จาก localStorage
          const savedTimelineViewMode = localStorage.getItem('timelineViewMode');
          if (savedTimelineViewMode && (savedTimelineViewMode === 'list' || savedTimelineViewMode === 'compact')) {
            this.timelineViewMode = savedTimelineViewMode;
          }

          // ตรวจสอบว่ามีข้อมูล sheetID และ storeID ใน localStorage หรือไม่
          const sheetID = localStorage.getItem('sheetID');
          const storeID = localStorage.getItem('storeSID');
          const storedUser = localStorage.getItem('currentUser');

          if (storedUser && sheetID && storeID) {
            // มีข้อมูลครบถ้วน ให้ทำการ "auto login"
            this.autoLoginFromStorage();
          } else {
            // ไม่มีข้อมูลครบถ้วน ให้แสดงหน้า login เท่านั้น
            this.prepareLoginScreen();
          }
        },





        prepareLoginScreen() {
          // โหลดเฉพาะข้อมูลที่ไม่ต้องใช้ sheetID และ storeID


          // ตั้งค่าวันที่เริ่มต้นสำหรับ UI ที่อาจจำเป็นในหน้า login
          const now = new Date();
          this.selectedScheduleMonth = now.getMonth() + 1;
          this.selectedScheduleYear = now.getFullYear();
        },



        // Modify the autoLoginFromStorage function to add license checking from server
        autoLoginFromStorage() {
          const storedUser = localStorage.getItem('currentUser');
          const sheetID = localStorage.getItem('sheetID');
          const storeID = localStorage.getItem('storeSID');

          if (storedUser && sheetID && storeID) {
            const parsedUser = JSON.parse(storedUser);
            this.currentUser = parsedUser;
            this.isLoggedIn = true;
            this.sheetID = sheetID;
            this.storeID = storeID;

            // รับค่า displayName
            this.displayName = localStorage.getItem('displayName') || parsedUser.username;

            // First use local license data (in case server is unavailable)
            const localLicenseValid = this.updateLicenseStatus();

            // Then check with server for updated license info (asynchronously)
            this.checkLicenseStatus();

            // ถ้า license ยังใช้งานได้ (ตามข้อมูลใน localStorage) ให้โหลดข้อมูลต่อ
            if (localLicenseValid) {
              // โหลดข้อมูลที่จำเป็นหลัง login
              this.initAfterLogin();
            }
            // กรณี license หมดอายุ จะมีการเปิด Modal ใน updateLicenseStatus แล้ว
          } else {
            // ถ้าข้อมูลไม่ครบถ้วน ให้แสดงหน้า login
            this.isLoggedIn = false;
            this.prepareLoginScreen();
          }
        },



        updateLicenseStatus() {
          const expireDate = localStorage.getItem('licenseExpireDate');

          if (expireDate) {
            // แยกวันที่และสร้าง Date object ที่ถูกต้อง
            const dateParts = expireDate.split('/');
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1; // เดือนใน JavaScript เริ่มจาก 0
            const year = parseInt(dateParts[2], 10);

            // สร้าง Date object โดยไม่มีเวลา
            const expireDateObj = new Date(year, month, day);
            const today = new Date();
            const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

            // คำนวณความต่างของวัน
            const diffTime = expireDateObj - todayWithoutTime;
            const calculatedDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            // อัพเดทค่าที่คำนวณได้
            this.licenseExpireDate = expireDate;
            this.licenseDaysRemaining = calculatedDays;
            this.licenseExpired = calculatedDays <= 0;

            // บันทึกค่าที่คำนวณได้กลับไปที่ localStorage
            localStorage.setItem('licenseDaysRemaining', calculatedDays.toString());
            localStorage.setItem('licenseExpired', (calculatedDays <= 0).toString());

            // ถ้า license หมดอายุ ให้เปิด Modal ต่ออายุ
            if (this.licenseExpired) {
              this.openLicenseRenewalModal();
              return false; // แจ้งว่า license ไม่สามารถใช้งานได้
            }
          }

          return true; // license ยังใช้งานได้
        },




        initAfterLogin() {
          // ตรวจสอบว่าเคยเรียกฟังก์ชันนี้แล้วหรือไม่
          if (this.isInitialized) {
            console.log("initAfterLogin ถูกเรียกซ้ำ - ข้ามการทำงาน");
            return;
          }

          // ตั้งค่าเป็น true เพื่อป้องกันการเรียกซ้ำ
          this.isInitialized = true;
          this.isFetchingAnnouncements = false;

          // ตรวจสอบว่ามี sheetID และ storeID หรือไม่
          if (!this.sheetID || !this.storeID) {
            console.error('ไม่พบ sheetID หรือ storeID');
            this.logout();
            return;
          }

          // โหลดข้อมูลพื้นฐานที่ไม่ต้องรอ Config
          this.todayActiveRentals = [];
          this.availableCarsToday = [];

          this.loadUsers();
          this.loadTranslations();
          this.syncSummaryTranslationKeys(); // ซิงค์คีย์แปลภาษาสำหรับสรุปการเช่า
          this.loadTranslationKeys();

          // โหลด Config และตั้งค่าสิทธิ์ก่อน แล้วค่อยโหลดหน้าเริ่มต้น
          this.loadConfig(() => {
            // console.log("โหลด Config เสร็จแล้ว กำลังจะโหลดหน้าเริ่มต้น");

            // Initialize ค่า default สำหรับ newRental จาก config
            this.initializeNewRentalDefaults();

            // **ย้ายการเรียกฟังก์ชันมาไว้ตรงนี้ เพื่อให้ทำงานในลำดับที่ถูกต้อง**
            this.fetchAnnouncements();
            this.performCriticalCheck();

            // เมื่อโหลดข้อมูลสำคัญเสร็จแล้ว จึงเรียก loadInitialPage
            this.loadInitialPage();
          });

          // โหลดข้อมูลอื่นๆ ที่ไม่เกี่ยวกับการแสดงหน้าเริ่มต้น
          this.loadLocations();
          // ไม่ต้องโหลดข้อมูลเหล่านี้ เพราะจะถูกโหลดใน setActivePage อยู่แล้ว
          // this.loadRentals();
          // this.loadCars();
          // this.fetchScheduleForDate();
          this.loadMaintenance();
          this.loadSearchHistory();
          this.loadInitialCars();

          // ตั้งค่าอื่นๆ
          this.newRental.วันที่เช่า = this.getThaiDate();
          this.initScheduleDateSelection();

          const now = new Date();
          this.selectedScheduleMonth = now.getMonth() + 1;
          this.selectedScheduleYear = now.getFullYear();
          this.updateBookingTable();

          this.loadCarsForRental();

          // ตั้งค่าคอลัมน์เบอร์โทรศัพท์
          const sheetID = localStorage.getItem('sheetID') || '';
          // ตั้งค่าคอลัมน์เบอร์โทรศัพท์
          google.script.run.setupPhoneNumberColumn(sheetID);

          // อัพเดตตัวเลือกหลังจากโหลดข้อมูลเสร็จ
          setTimeout(() => this.updateFilterOptions(), 500);
        },
































        // เพิ่มฟังก์ชันตรวจสอบสถานะ license
        checkLicenseStatus() {
          // แสดง Loading เมื่อกำลังตรวจสอบ
          this.isLoading = true;

          // ดึงค่า sheetID และ storeSID จาก localStorage
          const sheetID = localStorage.getItem('sheetID');
          const storeSID = localStorage.getItem('storeSID');

          // ตรวจสอบว่ามีค่าหรือไม่
          if (!sheetID || !storeSID) {
            console.error('ไม่พบข้อมูล sheetID หรือ storeSID ใน localStorage');
            this.isLoading = false;

            // ถ้าเชื่อมต่อไม่ได้ ให้ใช้ข้อมูลจาก localStorage (fallback)
            const expireDate = localStorage.getItem('licenseExpireDate');
            const daysRemaining = parseInt(localStorage.getItem('licenseDaysRemaining') || '0');

            if (expireDate) {
              this.licenseExpireDate = expireDate;
              this.licenseDaysRemaining = daysRemaining;

              // ตรวจสอบว่า license หมดอายุหรือไม่ ด้วยวันที่ปัจจุบัน
              const today = new Date();
              const dateParts = expireDate.split('/');
              const day = parseInt(dateParts[0], 10);
              const month = parseInt(dateParts[1], 10) - 1;
              const year = parseInt(dateParts[2], 10);
              const expireDateObj = new Date(year, month, day);
              const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

              this.licenseExpired = todayWithoutTime > expireDateObj;
            }

            return;
          }

          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;
              // console.log("License status check result:", result);

              if (result.valid) {
                // License ถูกต้อง อัพเดตข้อมูล
                this.licenseExpireDate = result.expireDate;

                // คำนวณวันที่เหลือจากวันที่ server ส่งกลับมาเพื่อความแน่นอน
                const today = new Date();
                const dateParts = result.expireDate.split('/');
                const day = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1;
                const year = parseInt(dateParts[2], 10);

                const expireDateObj = new Date(year, month, day);
                const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                const diffTime = expireDateObj - todayWithoutTime;
                const calculatedDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                this.licenseDaysRemaining = calculatedDays;
                this.licenseExpired = calculatedDays <= 0;
                this.licensePackage = result.package || '';

                // บันทึกลง localStorage
                localStorage.setItem('licenseExpireDate', result.expireDate);
                localStorage.setItem('licenseNearExpiration', String(result.nearExpiration || false));
                localStorage.setItem('licenseExpired', String(this.licenseExpired));
                localStorage.setItem('licenseDaysRemaining', String(calculatedDays));
                localStorage.setItem('licensePackage', result.package || '');
                localStorage.setItem('storeSID', result.storeSID || '');
                localStorage.setItem('sheetID', result.sheetID || '');
              } else {
                // License ไม่ถูกต้องหรือหมดอายุ
                this.licenseExpired = true;
                this.licenseExpireDate = result.expireDate || 'ไม่พบข้อมูล';
                this.licenseDaysRemaining = 0;

                // บันทึกสถานะลง localStorage
                localStorage.setItem('licenseExpired', 'true');
                localStorage.setItem('licenseExpireDate', result.expireDate || '');
                localStorage.setItem('licenseDaysRemaining', '0');

                // ล้างข้อมูลผู้ใช้ใน localStorage
                localStorage.removeItem('currentUser');

                // แสดง Modal ต่ออายุ
                this.openLicenseRenewalModal();

                // กำหนดค่าเริ่มต้นใหม่สำหรับผู้ใช้
                this.currentUser = {
                  username: '',
                  role: ''
                };
              }
            })
            .withFailureHandler(error => {
              console.error('Error checking license:', error);
              this.isLoading = false;

              // ถ้าเชื่อมต่อไม่ได้ ให้ใช้ข้อมูลจาก localStorage (fallback)
              const expireDate = localStorage.getItem('licenseExpireDate');
              const nearExpiration = localStorage.getItem('licenseNearExpiration') === 'true';
              const daysRemaining = parseInt(localStorage.getItem('licenseDaysRemaining') || '0');

              if (expireDate) {
                this.licenseExpireDate = expireDate;
                this.licenseDaysRemaining = daysRemaining;

                // ตรวจสอบว่า license หมดอายุหรือไม่ ด้วยวันที่ปัจจุบัน
                const today = new Date();
                const dateParts = expireDate.split('/');
                const day = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1;
                const year = parseInt(dateParts[2], 10);
                const expireDateObj = new Date(year, month, day);
                const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                this.licenseExpired = todayWithoutTime > expireDateObj;

                if (this.licenseExpired) {
                  // ถ้าหมดอายุแล้ว ต้องเซ็ต isLoggedIn เป็น true ชั่วคราวเพื่อซ่อน login modal
                  localStorage.removeItem('currentUser');
                  this.isLoggedIn = true;

                  setTimeout(() => {
                    this.openLicenseRenewalModal();
                  }, 100);

                  this.currentUser = {
                    username: '',
                    role: ''
                  };
                }
              }
            })
            .checkLicenseStatus(sheetID, storeSID);
        },






        // --- Announcement Functions ---
        fetchAnnouncements() {
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.announcements = result.data.sort((a, b) => (a.type === 'feature' ? -1 : 1)); // Show features first
                this.checkNewAnnouncements(result.data);
              } else {
                console.error("Failed to fetch announcements:", result.message);
              }
            })
            .withFailureHandler(error => console.error("Error fetching announcements:", error))
            .getAllAnnouncements();
        },

        checkNewAnnouncements(data) {
          const seen = JSON.parse(localStorage.getItem('seenAnnouncements') || '[]');
          const newAnns = data.filter(ann => !seen.includes(ann.id ?? ann.title));
          this.hasNewAnnouncements = newAnns.length > 0;
        }
        ,

        // นำโค้ดนี้ไปแทนที่ฟังก์ชัน showAllAnnouncements ของเดิม
        showAllAnnouncements() {
          this.isAllAnnouncementsModalOpen = true;
          document.body.classList.add('overflow-hidden');

          const allIds = (this.announcements || []).map(a => a.id ?? a.title);
          localStorage.setItem('seenAnnouncements', JSON.stringify(allIds));
          this.hasNewAnnouncements = false;
        },

        openModal(announcement) {
          this.selectedAnnouncement = announcement;
          this.isModalOpen = true;
          document.body.classList.add('overflow-hidden');

          const key = 'seenAnnouncements';
          let seen = [];
          try { seen = JSON.parse(localStorage.getItem(key) || '[]'); } catch { }
          const id = announcement.id ?? announcement.title;
          if (!seen.includes(id)) {
            seen.push(id);
            localStorage.setItem(key, JSON.stringify(seen));
          }

          const allIds = (this.announcements || []).map(a => a.id ?? a.title);
          this.hasNewAnnouncements = allIds.some(x => !seen.includes(x));
        },

        closeModal() {
          this.isModalOpen = false;
          setTimeout(() => { this.selectedAnnouncement = null; }, 300);
        },



        closeAllAnnouncementsModal() {
          this.isAllAnnouncementsModalOpen = false;
        },

        formatDateForDisplay(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        },

        // --- Problem Reporting Functions ---
        closeReportModal() {
          this.showReportProblemModal = false;
          setTimeout(() => {
            this.reportStep = null;
            this.reportProblemType = '';
            this.reportDetails = '';
          }, 300);
        },

        submitProblemReport() {
          const problemData = {
            storeName: this.config.ชื่อบริษัท || 'ไม่ระบุ',
            problemType: this.reportProblemType,
            details: this.reportDetails
          };
          Swal.fire({ title: 'กำลังส่งข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                Swal.fire('ส่งสำเร็จ!', 'ขอบคุณสำหรับข้อมูล เราจะรีบดำเนินการตรวจสอบครับ', 'success');
                this.closeReportModal();
              } else {
                Swal.fire('เกิดข้อผิดพลาด', result.message, 'error');
              }
            })
            .withFailureHandler(error => Swal.fire('เกิดข้อผิดพลาด', error.message, 'error'))
            .reportProblem(problemData);
        },

        performCriticalCheck() {
          google.script.run
            .withSuccessHandler(result => {
              if (result.shouldLock) {
                this.isSystemLocked = true;
              }
            })
            .checkCriticalProblems();
        },










        loadRentals(callback) { // เพิ่ม callback เป็นพารามิเตอร์
          this.isLoading = true;
          console.log("[Client] Calling lightweight getAllRentals...");

          const sheetID = localStorage.getItem('sheetID') || '';
          if (!sheetID) {
            this.showNotification('ไม่พบ Sheet ID', 'warning');
            this.isLoading = false;
            if (typeof callback === 'function') callback(false); // แจ้งว่าทำงานไม่สำเร็จ
            return;
          }

          google.script.run
            .withSuccessHandler(raw => {
              console.log('[Client] raw response:', raw);
              let arr;
              try {
                arr = JSON.parse(raw);
              } catch (e) {
                console.error('JSON parse error', e);
                this.showNotification('ข้อมูลไม่อยู่ในรูปแบบ JSON', 'error');
                arr = [];
              }

              if (Array.isArray(arr)) {
                this.rentals = arr;
                // คำนวณสถิติการใช้งานรถหลังจากโหลด rentals เสร็จ
                this.calculateCarUsageStats();
              } else {
                console.error('Parsed not array', arr);
                this.rentals = [];
              }

              // === จุดที่แก้ไข ===
              // ไม่เรียก refreshAll() แต่เรียก callback แทนเพื่อแจ้งว่าโหลดเสร็จแล้ว
              if (typeof callback === 'function') {
                callback(true); // ส่ง true เพื่อบอกว่าโหลดสำเร็จ
              } else {
                // ถ้าไม่มี callback ให้ปิด loading เอง
                this.isLoading = false;
              }
            })
            .withFailureHandler(err => {
              console.error("[Client] Load error:", err);
              this.showNotification('โหลดข้อมูลไม่สำเร็จ: ' + (err.message || err), 'error');
              this.rentals = [];

              // === จุดที่แก้ไข ===
              // ไม่เรียก refreshAll() และเรียก callback แทน
              if (typeof callback === 'function') {
                callback(false); // ส่ง false เพื่อบอกว่าโหลดไม่สำเร็จ
              } else {
                this.isLoading = false;
              }
            })
            .getAllRentals(sheetID);
        },




        refreshAll() {
          this.calculateStats();
          this.calculateAvailableCars();
          this.calculateTodayPickupsAndReturns();
          this.loadAvailableYears();
          this.loadTodayActiveRentals();
          this.calculateCarUsageStats();
          this.isLoading = false;
        },


        updateFilterOptions() {
          // ตรวจสอบว่ามีข้อมูลที่จะกรองหรือไม่
          if (!this.scheduleItems || !Array.isArray(this.scheduleItems) || this.scheduleItems.length === 0) {
            this.allLocations = [];
            this.allCarModels = [];
            return;
          }

          // ดึงค่าต่างๆ จากข้อมูลทั้งหมด
          const pickupLocations = [];
          const returnLocations = [];
          const carModels = [];

          this.scheduleItems.forEach(item => {
            if (item.สถานที่รับรถ && !pickupLocations.includes(item.สถานที่รับรถ)) {
              pickupLocations.push(item.สถานที่รับรถ);
            }

            if (item.สถานที่คืนรถ && !returnLocations.includes(item.สถานที่คืนรถ)) {
              returnLocations.push(item.สถานที่คืนรถ);
            }

            if (item.รถ && !carModels.includes(item.รถ)) {
              carModels.push(item.รถ);
            }
          });

          // รวมและกรองค่าที่ซ้ำกัน
          this.allLocations = [...new Set([...pickupLocations, ...returnLocations])];
          this.allCarModels = [...new Set(carModels)];
        },





        // โหลดข้อมูลผู้ใช้งาน
        loadUsers() {
          this.isLoading = true;

          // ดึงค่า storeSID และ sheetID จาก localStorage
          const storeSID = localStorage.getItem('storeSID');
          const sheetID = localStorage.getItem('sheetID');

          if (!storeSID || !sheetID) {
            this.showNotification('ไม่พบข้อมูลร้านค้า กรุณาเข้าสู่ระบบใหม่', 'error');
            this.isLoading = false;
            return;
          }

          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.users = result.data || [];
                // นับจำนวนผู้ดูแลระบบ
                this.adminCount = this.users.filter(user => user.role === 'admin').length;
              } else {
                this.showNotification('โหลดข้อมูลผู้ใช้ไม่สำเร็จ: ' + result.message, 'error');
                this.users = [];
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('โหลดข้อมูลผู้ใช้ไม่สำเร็จ: ' + error, 'error');
              this.users = [];
              this.isLoading = false;
            })
            .getAllUsers(sheetID, storeSID);
        },

        // แก้ไขข้อมูลผู้ใช้
        resetUserForm() {
          this.userEditMode = false;
          this.editingUser = {  // เปลี่ยนจาก currentUser เป็น editingUser
            id: '',
            username: '',
            password: '',
            role: 'user',
            displayName: ''
          };
        },

        // แก้ไขฟังก์ชัน editUser
        editUser(user) {
          this.userEditMode = true;
          this.editingUser = {  // เปลี่ยนจาก currentUser เป็น editingUser
            ...user,
            password: '',
            displayName: user.displayName || user.username
          };
        },

        // บันทึกข้อมูลผู้ใช้
        saveUser() {
          this.isLoading = true;

          // ดึงค่า storeSID และ sheetID จาก localStorage
          const storeSID = localStorage.getItem('storeSID');
          const sheetID = localStorage.getItem('sheetID');

          if (!storeSID || !sheetID) {
            this.showNotification('ไม่พบข้อมูลร้านค้า กรุณาเข้าสู่ระบบใหม่', 'error');
            this.isLoading = false;
            return;
          }

          if (this.userEditMode) {
            // กรณีแก้ไขผู้ใช้เดิม
            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  this.showNotification(result.message);
                  this.loadUsers();
                  this.resetUserForm();
                } else {
                  this.showNotification(result.message, 'error');
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.showNotification('เกิดข้อผิดพลาดในการอัพเดตผู้ใช้: ' + error, 'error');
                this.isLoading = false;
              })
              .updateUser(this.editingUser.id, this.editingUser, sheetID, storeSID);
          } else {
            // กรณีเพิ่มผู้ใช้ใหม่
            if (!this.editingUser.username || !this.editingUser.password) {
              this.showNotification('กรุณากรอกชื่อผู้ใช้และรหัสผ่าน', 'error');
              this.isLoading = false;
              return;
            }

            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  this.showNotification(result.message);
                  this.loadUsers();
                  this.resetUserForm();
                } else {
                  this.showNotification(result.message, 'error');
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.showNotification('เกิดข้อผิดพลาดในการเพิ่มผู้ใช้: ' + error, 'error');
                this.isLoading = false;
              })
              .addNewUser(this.editingUser, sheetID, storeSID);
          }
        },

        // ยืนยันการลบผู้ใช้
        confirmDeleteUser(userId) {
          // ตรวจสอบว่าเป็นแอดมินคนสุดท้ายหรือไม่
          const userToDelete = this.users.find(user => user.id === userId);
          if (userToDelete.role === 'admin' && this.adminCount <= 1) {
            this.showNotification('ไม่สามารถลบผู้ดูแลระบบคนสุดท้ายได้', 'error');
            return;
          }

          // ดึงค่า storeSID และ sheetID จาก localStorage
          const storeSID = localStorage.getItem('storeSID');
          const sheetID = localStorage.getItem('sheetID');

          if (!storeSID || !sheetID) {
            this.showNotification('ไม่พบข้อมูลร้านค้า กรุณาเข้าสู่ระบบใหม่', 'error');
            return;
          }

          Swal.fire({
            title: 'ยืนยันการลบผู้ใช้',
            text: 'คุณต้องการลบผู้ใช้นี้ใช่หรือไม่?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isLoading = true;

              google.script.run
                .withSuccessHandler(result => {
                  if (result.success) {
                    this.showNotification(result.message);
                    this.loadUsers();
                  } else {
                    this.showNotification(result.message, 'error');
                  }
                  this.isLoading = false;
                })
                .withFailureHandler(error => {
                  this.showNotification('เกิดข้อผิดพลาดในการลบผู้ใช้: ' + error, 'error');
                  this.isLoading = false;
                })
                .deleteUser(userId, sheetID, storeSID);
            }
          });
        },





        loadLocations() {
          // เรียกฟังก์ชันนี้ใน init() เพื่อโหลดข้อมูลสถานที่ตอนเริ่มต้น
          const config = this.config;

          // ตรวจสอบว่ามีข้อมูลสถานที่รับรถในการตั้งค่าหรือไม่
          if (config.สถานที่รับรถ) {
            this.pickupLocations = config.สถานที่รับรถ.split(',').map(location => location.trim());
          } else {
            this.pickupLocations = []; // ถ้าไม่มีให้ใช้อาร์เรย์ว่าง
          }

          // ตรวจสอบว่ามีข้อมูลสถานที่คืนรถในการตั้งค่าหรือไม่
          if (config.สถานที่คืนรถ) {
            this.returnLocations = config.สถานที่คืนรถ.split(',').map(location => location.trim());
          } else {
            this.returnLocations = []; // ถ้าไม่มีให้ใช้อาร์เรย์ว่าง
          }
        },

        // 3. เพิ่มฟังก์ชันสำหรับบันทึกข้อมูลสถานที่
        savePickupLocations() {
          this.isLoading = true;

          // แปลงข้อความที่ผู้ใช้กรอกเป็นอาร์เรย์
          const locationArray = this.newPickupLocations.split(',').map(location => location.trim());

          // กรองค่าว่างออก
          const filteredLocations = locationArray.filter(location => location.length > 0);

          // อัพเดตในตัวแปรภายใน
          this.pickupLocations = filteredLocations;

          // สร้างสตริงสำหรับเก็บในการตั้งค่า
          const locationsString = filteredLocations.join(',');

          // อัพเดตในการตั้งค่า
          this.config.สถานที่รับรถ = locationsString;
          const sheetID = localStorage.getItem('sheetID') || '';
          // บันทึกการตั้งค่าไปยังเซิร์ฟเวอร์
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                // ปิดหน้าต่างแก้ไข
                this.showPickupLocationEditor = false;
                this.showNotification('บันทึกสถานที่รับรถสำเร็จ');
              } else {
                this.showNotification('บันทึกสถานที่รับรถไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('บันทึกสถานที่รับรถไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .updateSystemConfig(this.config, sheetID);
        },

        // 4. เพิ่มฟังก์ชันสำหรับบันทึกข้อมูลสถานที่คืนรถ
        saveReturnLocations() {
          this.isLoading = true;

          // แปลงข้อความที่ผู้ใช้กรอกเป็นอาร์เรย์
          const locationArray = this.newReturnLocations.split(',').map(location => location.trim());

          // กรองค่าว่างออก
          const filteredLocations = locationArray.filter(location => location.length > 0);

          // อัพเดตในตัวแปรภายใน
          this.returnLocations = filteredLocations;

          // สร้างสตริงสำหรับเก็บในการตั้งค่า
          const locationsString = filteredLocations.join(',');

          // อัพเดตในการตั้งค่า
          this.config.สถานที่คืนรถ = locationsString;
          const sheetID = localStorage.getItem('sheetID') || '';
          // บันทึกการตั้งค่าไปยังเซิร์ฟเวอร์
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                // ปิดหน้าต่างแก้ไข
                this.showReturnLocationEditor = false;
                this.showNotification('บันทึกสถานที่คืนรถสำเร็จ');
              } else {
                this.showNotification('บันทึกสถานที่คืนรถไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('บันทึกสถานที่คืนรถไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .updateSystemConfig(this.config, sheetID);
        },

        // 5. เพิ่มฟังก์ชันสำหรับเปิด editor สถานที่รับรถ
        openPickupEditor() {
          // เตรียมข้อมูลสำหรับแก้ไข
          this.newPickupLocations = this.pickupLocations.join(', ');
          this.showPickupLocationEditor = true;
        },

        // 6. เพิ่มฟังก์ชันสำหรับเปิด editor สถานที่คืนรถ
        openReturnEditor() {
          // เตรียมข้อมูลสำหรับแก้ไข
          this.newReturnLocations = this.returnLocations.join(', ');
          this.showReturnLocationEditor = true;
        },



        getDaysInMonth(year, month) {
          // อ้างอิงวันที่ 0 ของเดือนถัดไปจะได้วันสุดท้ายของเดือนปัจจุบัน
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const firstDayOfMonth = new Date(year, month, 1).getDay();

          const days = [];

          // เติมวันว่างก่อนวันแรกของเดือน
          for (let i = 0; i < firstDayOfMonth; i++) {
            days.push(0);
          }

          // เพิ่มวันของเดือน
          for (let i = 1; i <= daysInMonth; i++) {
            days.push(i);
          }

          return days;
        },

        // ตรวจสอบวันที่ถูกเลือก
        isSelectedDate(day) {
          if (!day || day === 0 || !this.selectedScheduleDate) return false;

          const selected = new Date(this.selectedScheduleDate);
          return (
            day === selected.getDate() &&
            this.currentMonth === selected.getMonth() &&
            this.currentYear === selected.getFullYear()
          );
        },

        // เลือกวันที่
        selectDate(day) {
          if (day === 0) return;

          // เก็บวันที่เดิมไว้เพื่อเปรียบเทียบ
          const oldDate = this.selectedScheduleDate ? new Date(this.selectedScheduleDate) : null;

          // กำหนดวันที่ใหม่
          this.selectedScheduleDate = new Date(this.currentYear, this.currentMonth, day);

          // ปิด datepicker
          this.showDatePicker = false;

          // ตรวจสอบว่าวันที่เปลี่ยนไปหรือไม่
          const dateChanged = !oldDate ||
            oldDate.getDate() !== this.selectedScheduleDate.getDate() ||
            oldDate.getMonth() !== this.selectedScheduleDate.getMonth() ||
            oldDate.getFullYear() !== this.selectedScheduleDate.getFullYear();

          // ถ้ามีการเปลี่ยนวันที่ ให้รีเซ็ตตัวกรอง
          if (dateChanged) {
            // รีเซ็ตค่าตัวกรองเมื่อเปลี่ยนวันที่
            this.selectedLocation = '';
            this.selectedCarModel = '';

            // อัพเดตตัวกรองให้แสดงตัวเลือกเฉพาะวันที่ที่เลือก
            this.updateFilterOptionsForSelectedDate();
          }
        },




        // เพิ่มใน app() หรือแก้ไขฟังก์ชันที่มีอยู่แล้ว
        updateFilterOptionsForSelectedDate() {
          if (!this.scheduleItems || !this.selectedScheduleDate) {
            this.allLocations = [];
            this.allCarModels = [];
            return;
          }

          const selectedDateStr = this.formatDateForComparison(this.selectedScheduleDate);

          // กรองรายการตามวันที่ที่เลือกเท่านั้น
          const todayItems = this.scheduleItems.filter(item => {
            const itemDate = this.formatDateForComparison(item.วันที่);
            return itemDate === selectedDateStr;
          });

          // รวบรวมสถานที่และรุ่นรถเฉพาะวันที่ที่เลือก
          const pickupLocations = [];
          const returnLocations = [];
          const carModels = [];

          todayItems.forEach(item => {
            // ถ้าเป็นรับรถ ให้เก็บสถานที่รับรถ
            if (item.ประเภท === 'รับรถ' && item.สถานที่รับรถ && !pickupLocations.includes(item.สถานที่รับรถ)) {
              pickupLocations.push(item.สถานที่รับรถ);
            }

            // ถ้าเป็นส่งคืนรถ ให้เก็บสถานที่คืนรถ
            if (item.ประเภท === 'ส่งคืนรถ' && item.สถานที่คืนรถ && !returnLocations.includes(item.สถานที่คืนรถ)) {
              returnLocations.push(item.สถานที่คืนรถ);
            }

            // เก็บรุ่นรถ
            if (item.รถ && !carModels.includes(item.รถ)) {
              carModels.push(item.รถ);
            }
          });

          // รวมและกรองค่าที่ซ้ำกัน
          this.allLocations = [...new Set([...pickupLocations, ...returnLocations])];
          this.allCarModels = [...new Set(carModels)];

          // เปิดตัวกรองอัตโนมัติถ้ามีตัวเลือกมากกว่า 1 รายการ
          if ((this.allLocations.length > 1 || this.allCarModels.length > 1) && todayItems.length > 3) {
            this.showFilterPanel = true;
          } else {
            this.showFilterPanel = false;
          }
        },






        // เปลี่ยนเดือน
        // changeMonth(delta) {
        //   this.currentMonth += delta;

        //   if (this.currentMonth < 0) {
        //     this.currentMonth = 11;
        //     this.currentYear--;
        //   }

        //   if (this.currentMonth > 11) {
        //     this.currentMonth = 0;
        //     this.currentYear++;
        //   }
        // },

        // ฟังก์ชันเปลี่ยนเดือน
        changeMonth(delta) {
          let newMonth = parseInt(this.selectedScheduleMonth) + delta;
          let newYear = parseInt(this.selectedScheduleYear);

          if (newMonth > 12) {
            newMonth = 1;
            newYear++;
          } else if (newMonth < 1) {
            newMonth = 12;
            newYear--;
          }

          this.selectedScheduleMonth = newMonth;
          this.selectedScheduleYear = newYear;

          // อัพเดตการแสดงผล
          if (this.viewMode === 'table') {
            this.updateBookingTable();
          } else {
            this.renderCalendarView();
          }
        },



        // สลับการแสดง Datepicker
        toggleDatePicker() {
          this.showDatePicker = !this.showDatePicker;

          // ถ้าปิด datepicker ให้อัพเดตตัวกรอง
          if (!this.showDatePicker && this.selectedScheduleDate) {
            this.updateFilterOptionsForSelectedDate();
          }
        },

        // คำนวณการกรองรายการตามวันที่



        // เตรียมข้อมูลเริ่มต้นสำหรับการเลือกวัน
        initScheduleDateSelection() {
          const today = new Date();
          this.selectedScheduleDate = today;
          this.currentYear = today.getFullYear();
          this.currentMonth = today.getMonth();

          // อัพเดตตัวกรองเมื่อเริ่มต้น
          setTimeout(() => this.updateFilterOptionsForSelectedDate(), 500);
        },


        isToday2(day) {
          if (!day || day === 0) return false;

          const today = new Date();
          return (
            day === today.getDate() &&
            this.currentMonth === today.getMonth() &&
            this.currentYear === today.getFullYear()
          );
        },



        // สร้างหมายเลขการจองอัตโนมัติ
        // generateBookingNumberIfNeeded() {
        //   if (this.autoGenerateBookingNumber && !this.newRental.หมายเลขการจอง) {
        //     this.isLoading = true;

        //     google.script.run
        //       .withSuccessHandler(result => {
        //         this.newRental.หมายเลขการจอง = result;
        //         if (this.autoGenerateBookingChannel) {
        //           this.newRental.ช่องทางการจอง = 'Walk-in';
        //         }
        //         this.isLoading = false;
        //       })
        //       .withFailureHandler(error => {
        //         this.showNotification('ไม่สามารถสร้างหมายเลขการจองได้: ' + error, 'error');
        //         this.isLoading = false;
        //       })
        //       .generateBookingNumber();
        //   }
        // },


        handleAutoGenerateChange() {
          if (this.autoGenerateBookingNumber) {
            // เคลียร์หมายเลขการจองที่มีอยู่และช่องทางการจองเมื่อเปลี่ยนเป็นสร้างอัตโนมัติ
            this.newRental.หมายเลขการจอง = '';
            // เคลียร์ช่องทางการจองในระหว่างกำลังโหลด
            this.newRental.ช่องทางการจอง = '';
            this.generateBookingNumberIfNeeded();
          }
        },

        // อัปเดตเมธอดที่มีอยู่แล้ว
        generateBookingNumberIfNeeded() {
          if (this.autoGenerateBookingNumber && !this.newRental.หมายเลขการจอง) {
            this.isGeneratingBookingNumber = true; // ใช้ตัวแปรใหม่
            this.newRental.ช่องทางการจอง = '';

            const sheetID = localStorage.getItem('sheetID') || '';
            google.script.run
              .withSuccessHandler(result => {
                this.newRental.หมายเลขการจอง = result;
                if (this.autoGenerateBookingChannel) {
                  this.newRental.ช่องทางการจอง = 'Walk-in';
                }
                this.isGeneratingBookingNumber = false; // รีเซ็ตตัวแปรใหม่
              })
              .withFailureHandler(error => {
                this.showNotification('ไม่สามารถสร้างหมายเลขการจองได้: ' + error, 'error');
                this.isGeneratingBookingNumber = false; // รีเซ็ตตัวแปรใหม่
              })
              .generateBookingNumber(sheetID);
          }
        },







        // ฟังก์ชันโหลดรายการจองล่าสุด
        loadRecentRentals(forceRefresh = false) {
          console.log('🔄 Loading recent rentals...');
          const sheetID = localStorage.getItem('sheetID');
          if (!sheetID) {
            console.log('❌ No sheetID found');
            return;
          }

          // ตรวจสอบแคช (cache 5 นาที)
          const cacheKey = `recentRentals_${sheetID}`;
          const cacheTimeKey = `recentRentalsTime_${sheetID}`;
          const cachedData = localStorage.getItem(cacheKey);
          const cacheTime = localStorage.getItem(cacheTimeKey);

          const now = Date.now();
          const fiveMinutes = 5 * 60 * 1000;

          if (!forceRefresh && cachedData && cacheTime && (now - parseInt(cacheTime)) < fiveMinutes) {
            console.log('✅ Using cached recent rentals');
            this.recentRentals = JSON.parse(cachedData);
            return;
          }

          // โหลดข้อมูลใหม่
          console.log('📥 Fetching new recent rentals from server...');
          this.isLoadingRecentRentals = true;
          google.script.run
            .withSuccessHandler((result) => {
              console.log('📦 Received result:', result);
              // ตรวจสอบว่า result ไม่เป็น null
              if (result && typeof result === 'object' && result.success) {
                this.recentRentals = result.data || [];
                console.log('✅ Loaded', (result.data || []).length, 'recent rentals');
                // บันทึกแคช
                localStorage.setItem(cacheKey, JSON.stringify(result.data || []));
                localStorage.setItem(cacheTimeKey, now.toString());
                this.recentRentalsCacheTime = now;
              } else {
                console.log('⚠️ No data or failed:', result);
                this.recentRentals = [];
              }
              this.isLoadingRecentRentals = false;
            })
            .withFailureHandler((error) => {
              console.error('❌ Error loading recent rentals:', error);
              this.recentRentals = [];
              this.isLoadingRecentRentals = false;
            })
            .getRecentRentals(sheetID, 4);
        },


        // อัพเดทแคชเมื่อมีการ CRUD
        updateRecentRentalsCache() {
          const sheetID = localStorage.getItem('sheetID');
          if (!sheetID) return;

          // ลบแคชเดิม
          const cacheKey = `recentRentals_${sheetID}`;
          const cacheTimeKey = `recentRentalsTime_${sheetID}`;
          localStorage.removeItem(cacheKey);
          localStorage.removeItem(cacheTimeKey);

          // โหลดข้อมูลใหม่
          this.loadRecentRentals(true);
        },

        // ใช้ข้อมูลจากรายการล่าสุดเพื่อแสดงใน Modal
        loadRecentRentalForEdit(rental) {
          console.log('Opening rental in modal:', rental);

          // เรียกใช้ฟังก์ชัน editRental ที่มีอยู่แล้ว โดยส่ง viewMode = true
          // ฟังก์ชันนี้จะเตรียมข้อมูลให้ครบถ้วนเหมือนตอนค้นหาและกดแก้ไข
          this.editRental(rental, true);
        },

        // ฟังก์ชันสำหรับแก้ไขจาก Modal (เมื่อกดปุ่มแก้ไขใน Modal)
        startEditFromModal() {
          // เปลี่ยนเป็นโหมดแก้ไข
          this.isViewMode = false;

          // โหลดข้อมูลรถถ้ายังไม่ได้โหลด
          if (!this.availableCars || this.availableCars.length === 0) {
            this.loadCarsForRental();
          }
        },

        loadCarsForRental() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          // โหลด commissionList ก่อน
          this.loadCommissionList();

          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                // เก็บข้อมูลรถที่พร้อมให้เช่าเท่านั้น
                const availableCars = result.data.filter(car => car.สถานะ === 'พร้อมให้เช่า');

                // --- จุดแก้ไขสำคัญ: เปลี่ยนจากการ map เป็น string มาเป็น object ---
                this.carOptions = availableCars.map((car, index) => {
                  const brand = car.ยี่ห้อ || '';
                  const model = car.รุ่น || '';
                  const license = car.ทะเบียน || '';

                  let displayText = `${brand} ${model}`.trim();

                  if (license) {
                    displayText += ` (${license})`;
                  } else {
                    displayText += ' (ไม่ระบุทะเบียน)';
                  }

                  // คืนค่าเป็น Object ที่มี id, value, และ text
                  return {
                    id: index,
                    value: displayText,
                    text: displayText
                  };
                });

                // เก็บข้อมูลรถทั้งหมดเพื่อใช้ในการเลือกรายละเอียดเพิ่มเติม
                this.availableCarsData = availableCars;

                console.log("[Debug] โหลดข้อมูลรถเสร็จ:", this.availableCarsData.length, "คัน");
                console.log("[Debug] โหลด commissionList เสร็จ:", this.commissionList.length, "รายการ");
              } else {
                this.showNotification('โหลดข้อมูลรถไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('โหลดข้อมูลรถไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .getAllCars(sheetID);
        },



        populateCarDetails() {
          if (this.newRental.รถ) {
            const selectedCarInfo = this.availableCarsData.find(car =>
              `${car.ยี่ห้อ} ${car.รุ่น} (${car.ทะเบียน})` === this.newRental.รถ
            );

            if (selectedCarInfo) {
              console.log("[Debug] ข้อมูลรถที่เลือก:", selectedCarInfo);
              console.log("[Debug] รูปแบบค่าคอมมิชชั่นที่ตั้งค่าไว้:", selectedCarInfo["รูปแบบค่าคอมมิชชั่น"]);
              console.log("[Debug] รายการ commissionList ปัจจุบัน:", this.commissionList);

              // กรอกข้อมูลอัตโนมัติ
              this.newRental.ทะเบียนรถ = selectedCarInfo.ทะเบียน;
              this.newRental.ราคา = selectedCarInfo.ราคาเช่าต่อวัน;

              // ดึงค่ามัดจำคิวรถจากรถที่เลือก หรือใช้ค่าเริ่มต้นของระบบ
              const carBookingDeposit = parseFloat(selectedCarInfo.ค่ามัดจำคิวรถ);
              this.newRental.ค่ามัดจำคิวรถ = (carBookingDeposit && carBookingDeposit > 0)
                ? selectedCarInfo.ค่ามัดจำคิวรถ
                : (this.config.ค่ามัดจำคิวรถเริ่มต้น || '');

              this.newRental.เงินประกันความเสียหาย = this.config.เงินประกันความเสียหายเริ่มต้น || '';

              // ===== แก้ไขส่วนการจัดการ Commission =====

              // ถ้า commissionList ยังไม่โหลด ให้โหลดก่อน
              if (!this.commissionList || this.commissionList.length === 0) {
                this.loadCommissionList();
                console.log("[Debug] โหลด commissionList ใหม่");
              }

              // ใช้ setTimeout เพื่อให้แน่ใจว่า commissionList โหลดเสร็จแล้ว
              setTimeout(() => {
                this.setupCommissionForSelectedCar(selectedCarInfo);
              }, 100);

              // คำนวณยอดเงินอัตโนมัติ

              this.calculateTotalRental();
              this.calculateFinalAmount();
            }
          }
        },



        setupCommissionForSelectedCar(selectedCarInfo) {
          const carCommissionType = selectedCarInfo["รูปแบบค่าคอมมิชชั่น"];

          console.log("[Debug] กำลังตั้งค่า Commission สำหรับรถ");
          console.log("[Debug] ชื่อคอมมิชชั่นจากรถ:", carCommissionType);
          console.log("[Debug] รายการ commissionList:", this.commissionList);

          // ถ้าไม่มีค่าคอมมิชชั่นในรถ
          if (!carCommissionType || carCommissionType === '') {
            this.newRental.มีค่าคอมมิชชั่น = false;
            this.newRental.ค่าคอมมิชชั่นที่เลือก = '';
            console.log("[Debug] รถคันนี้ไม่มีค่าคอมมิชชั่น");
            return;
          }

          // ตรวจสอบว่ามีในรายการ commissionList หรือไม่ (ไม่เคร่งครัดเรื่องตัวพิมพ์)
          const foundCommission = this.commissionList.find(c =>
            c.ชื่อ.toLowerCase() === carCommissionType.toLowerCase()
          );

          if (foundCommission) {
            // ถ้าเจอ ให้ติ๊ก checkbox และเลือก dropdown
            this.newRental.มีค่าคอมมิชชั่น = true;
            this.newRental.ค่าคอมมิชชั่นที่เลือก = foundCommission.ชื่อ; // ใช้ชื่อจริงจาก commissionList
            console.log("[Debug] ✅ ติ๊ก checkbox และเลือก:", foundCommission.ชื่อ);

            // คำนวณค่าคอมมิชชั่นอัตโนมัติ
            this.calculateCommission();
          } else {
            // ถ้าไม่เจอ แสดง log และไม่ติ๊ก
            this.newRental.มีค่าคอมมิชชั่น = false;
            this.newRental.ค่าคอมมิชชั่นที่เลือก = '';
            console.log("[Debug] ❌ ไม่พบรายการคอมมิชชั่น '", carCommissionType, "' ในรายการ");
            console.log("[Debug] รายการที่มี:", this.commissionList.map(c => c.ชื่อ));
          }
        },



        // เมื่อเลือกรถในโหมดแก้ไข
        populateCarDetailsForEdit() {
          if (this.editRentalData.รถ) {
            // หารถที่เลือกจากข้อมูลที่มีอยู่
            const selectedCarInfo = this.availableCarsData.find(car =>
              `${car.ยี่ห้อ} ${car.รุ่น} (${car.ทะเบียน})` === this.editRentalData.รถ
            );

            if (selectedCarInfo) {
              // กรอกข้อมูลอัตโนมัติ
              this.editRentalData.ทะเบียนรถ = selectedCarInfo.ทะเบียน;
              this.editRentalData.ราคา = selectedCarInfo.ราคาเช่าต่อวัน;
            }
          }
        },

        // โหลดข้อมูลการตั้งค่า



        loadConfig(callback) {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              // โหลดข้อมูลการตั้งค่าทั่วไป
              this.config = result.config;

              // โหลดข้อมูลกลุ่มและสิทธิ์แบบใหม่
              if (result.rolePermissions) {
                this.rolePermissions = result.rolePermissions;
                // console.log("โหลดสิทธิ์ตามบทบาทสำเร็จ:", this.rolePermissions);
              } else {
                // กำหนดค่าเริ่มต้นหากไม่มีข้อมูล
                this.rolePermissions = {
                  'admin': {
                    'company-info': true,
                    'payment-settings': true,
                    'booking-settings': true,
                    'location-settings': true,
                    'summary-message-settings': true,
                    'translation-settings': true,
                    'blacklist-management': true,
                    'license-info': true,
                    'user-management': true,
                    'role-management': true,
                    'page-summary': true,
                    'page-bookings': true,
                    'page-finance': true,
                    'commission-settings': true,
                    'page-schedule': true,
                    'page-newRental': true,
                    'page-cars': true,
                    'page-config': true
                  },
                  'user': { ...this.userPermissions } // ใช้ข้อมูลจาก userPermissions เป็นค่าเริ่มต้น
                };
                console.log("ไม่พบข้อมูลสิทธิ์ตามบทบาท กำหนดค่าเริ่มต้น:", this.rolePermissions);
              }

              // โหลดข้อมูลชื่อกลุ่ม
              if (result.roleNames) {
                this.roleNames = result.roleNames;
              } else {
                // กำหนดค่าเริ่มต้น
                this.roleNames = {
                  'admin': 'ผู้ดูแลระบบ',
                  'user': 'ผู้ใช้งานทั่วไป'
                };
              }

              // โหลดข้อมูลคำอธิบายกลุ่ม
              if (result.roleDescriptions) {
                this.roleDescriptions = result.roleDescriptions;
              } else {
                // กำหนดค่าเริ่มต้น
                this.roleDescriptions = {
                  'admin': 'มีสิทธิ์เข้าถึงทุกส่วนของระบบ',
                  'user': 'มีสิทธิ์เข้าถึงเฉพาะส่วนที่กำหนด'
                };
              }

              // แปลงช่องทางการจองจากสตริงเป็นอาร์เรย์
              if (this.config.ช่องทางการจอง) {
                this.bookingChannels = this.config.ช่องทางการจอง.split(',').map(channel => channel.trim());
              } else {
                // ถ้าไม่มีข้อมูล ให้ใช้ค่าเริ่มต้น
                this.bookingChannels = ['Walk-in', 'Line', 'Facebook', 'Telephone'];
              }

              // แปลงค่า "ตรวจสอบคิวรถ" ให้เป็น boolean
              if (this.config.ตรวจสอบคิวรถ === undefined) {
                this.config.ตรวจสอบคิวรถ = false;
              } else if (typeof this.config.ตรวจสอบคิวรถ === 'string') {
                this.config.ตรวจสอบคิวรถ = this.config.ตรวจสอบคิวรถ === 'true';
              }

              // ตรวจสอบว่ามีค่า "ระยะเวลาเตรียมรถ" หรือไม่
              if (this.config.ระยะเวลาเตรียมรถ === undefined) {
                this.config.ระยะเวลาเตรียมรถ = "0";
              }

              // ตรวจสอบว่ามีค่า "ค่าล่วงเวลาเริ่มต้น" หรือไม่
              if (this.config.ค่าล่วงเวลาเริ่มต้น === undefined || this.config.ค่าล่วงเวลาเริ่มต้น === null || this.config.ค่าล่วงเวลาเริ่มต้น === '') {
                this.config.ค่าล่วงเวลาเริ่มต้น = 100;
              }

              // ตรวจสอบว่ามีค่า "จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน" หรือไม่
              if (this.config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน === undefined || this.config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน === null || this.config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน === '') {
                this.config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน = 0;
              }

              // ตรวจสอบว่ามีค่า "ข้อความเสนอราคา" หรือไม่ ถ้าไม่มีให้ใช้ค่าเริ่มต้น
              if (!this.config.quoteMessageTemplate) {
                this.config.quoteMessageTemplate = this.getDefaultQuoteTemplate();
              }

              // เรียกฟังก์ชันย้ายข้อมูลสิทธิ์จากรูปแบบเดิมไปยังรูปแบบใหม่ (ถ้าจำเป็น)
              // this.migratePermissionsIfNeeded();

              // เพิ่มคอลัมน์คาร์ซีทและประกันเสริมหากยังไม่มี (รันเบื้องหลัง - ไม่รอผลลัพธ์)
              google.script.run
                .withSuccessHandler(result => {
                  if (result.success && result.columnsAdded && result.columnsAdded.length > 0) {
                    console.log("✅ เพิ่มคอลัมน์สำเร็จ:", result.message);
                  }
                })
                .withFailureHandler(error => {
                  console.error("⚠️ ไม่สามารถเพิ่มคอลัมน์คาร์ซีทและประกันเสริมได้:", error);
                })
                .ensureCarSeatAndInsuranceColumns(sheetID);

              this.isLoading = false;

              // เรียกใช้ฟังก์ชันตรวจสอบค่าว่างหลังจากโหลดข้อมูลเสร็จ
              this.checkMissingConfig();

              // console.log("loadConfig ทำงานเสร็จแล้ว");

              // เรียกใช้ callback ถ้ามี
              if (typeof callback === 'function') {
                // console.log("กำลังเรียกใช้ callback จาก loadConfig");
                callback();
              }
            })
            .withFailureHandler(error => {
              console.error("เกิดข้อผิดพลาดในการโหลด config:", error);
              this.showNotification('โหลดข้อมูลไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;

              // กำหนดค่าเริ่มต้นในกรณีที่โหลดไม่สำเร็จ
              if (!this.rolePermissions || Object.keys(this.rolePermissions).length === 0) {
                console.log("กำหนดค่าเริ่มต้นให้ rolePermissions เนื่องจากโหลดไม่สำเร็จ");
                this.rolePermissions = {
                  'admin': {
                    'company-info': true,
                    'payment-settings': true,
                    'booking-settings': true,
                    'location-settings': true,
                    'summary-message-settings': true,
                    'translation-settings': true,
                    'blacklist-management': true,
                    'license-info': true,
                    'user-management': true,
                    'role-management': true,
                    'page-summary': true,
                    'page-bookings': true,
                    'page-schedule': true,
                    'page-newRental': true,
                    'page-cars': true,
                    'page-finance': true,
                    'commission-settings': true,
                    'page-config': true
                  },
                  'user': {
                    'company-info': true,
                    'payment-settings': true,
                    'booking-settings': true,
                    'location-settings': true,
                    'summary-message-settings': true,
                    'translation-settings': false,
                    'blacklist-management': false,
                    'license-info': false,
                    'user-management': false,
                    'role-management': false,
                    'page-summary': true,
                    'page-bookings': true,
                    'page-schedule': true,
                    'page-newRental': true,
                    'page-finance': true,
                    'commission-settings': true,
                    'page-cars': true,
                    'page-config': true
                  }
                };
              }

              // เรียกใช้ callback ถึงแม้จะเกิดข้อผิดพลาด
              if (typeof callback === 'function') {
                console.log("กำลังเรียกใช้ callback จาก loadConfig (กรณีเกิดข้อผิดพลาด)");
                callback();
              }
            })
            .getSystemConfig(sheetID);
        },






        checkMissingConfig() {
          // รายการค่าที่ต้องตรวจสอบ
          const requiredFields = [
            { key: 'ที่อยู่', label: 'ที่อยู่' },
            { key: 'เบอร์โทรศัพท์', label: 'เบอร์โทรศัพท์' },
            { key: 'คำนำหน้าหมายเลขการจอง', label: 'คำนำหน้าหมายเลขการจอง' },
            { key: 'ชื่อธนาคาร', label: 'ชื่อธนาคาร' },
            { key: 'หมายเลขบัญชีธนาคาร', label: 'หมายเลขบัญชีธนาคาร' },
            { key: 'ชื่อบัญชี', label: 'ชื่อบัญชี' }
          ];

          // รวบรวมฟิลด์ที่ว่าง
          const missingFields = [];

          for (const field of requiredFields) {
            // ตรวจสอบว่าค่าว่างหรือไม่มีค่า
            if (!this.config[field.key] || this.config[field.key].trim() === '') {
              missingFields.push(field);
            }
          }

          // ถ้ามีค่าที่ว่างให้แสดง modal
          if (missingFields.length > 0) {
            this.showConfigSetupModal(missingFields);
          }
        },



        // 3. สร้างฟังก์ชันแสดง modal สำหรับตั้งค่า
        showConfigSetupModal(missingFields) {
          // เก็บข้อมูลฟิลด์ที่ว่างไว้ในตัวแปร instance
          this.missingConfigFields = missingFields;

          // เตรียมข้อมูลสำหรับแสดงใน modal
          const fieldHtml = missingFields.map(field => {
            const currentValue = this.config[field.key] || '';
            return `
      <div class="mb-4">
        <label for="config-${field.key}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" 
               id="config-${field.key}" value="${currentValue}" placeholder="กรุณากรอก${field.label}">
      </div>
    `;
          }).join('');

          // สร้าง modal element
          const modalId = 'configSetupModal';
          let modalElement = document.getElementById(modalId);

          if (modalElement) {
            // ถ้ามีอยู่แล้วให้ลบออกก่อน
            modalElement.remove();
          }

          // สร้าง modal element ใหม่
          modalElement = document.createElement('div');
          modalElement.id = modalId;
          modalElement.className = 'fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center';
          modalElement.style.display = 'none';

          // สร้าง HTML สำหรับ modal
          modalElement.innerHTML = `
<div class="bg-white rounded-xl shadow-2xl max-w-md mx-auto w-full transform transition-all duration-300 border border-gray-100 overflow-hidden"> 
  <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-blue-50"> 
    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
      <svg class="h-5 w-5 text-indigo-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
      </svg>
      ตั้งค่าระบบ
    </h3> 
    <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-full p-1 transition-colors"> 
      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"> 
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /> 
      </svg> 
    </button> 
  </div> 
  <div class="px-6 py-5"> 
    <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-5 rounded-r-md shadow-sm"> 
      <div class="flex"> 
        <div class="flex-shrink-0"> 
          <svg class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor"> 
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /> 
          </svg> 
        </div> 
        <div class="ml-3"> 
          <p class="text-sm font-medium text-amber-800"> กรุณาตั้งค่าระบบก่อนเริ่มใช้งาน </p>
          <p class="text-xs text-amber-700 mt-1"> เพื่อให้ระบบทำงานได้อย่างสมบูรณ์ </p>
        </div> 
      </div> 
    </div> 
    <form id="config-setup-form" class="space-y-4"> ${fieldHtml} </form> 
  </div> 
  <div class="px-6 py-4 bg-gray-50 sm:px-6 border-t border-gray-100 flex justify-between items-center"> 
    <div class="text-xs text-gray-500 flex items-center">
      <span class="inline-block h-2 w-2 bg-green-400 rounded-full mr-1"></span>
      พร้อมใช้งาน
    </div>
    <button type="button" id="save-config-btn" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:-translate-y-px"> 
      <svg class="w-4 h-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
      บันทึกการตั้งค่า 
    </button> 
  </div> 
</div>`;

          // เพิ่ม modal เข้าไปในเอกสาร
          document.body.appendChild(modalElement);

          // แสดง modal
          modalElement.style.display = 'flex';

          // เพิ่ม event listener สำหรับปุ่มปิด
          document.getElementById('closeModalBtn').addEventListener('click', () => {
            this.closeModal(modalId);
          });

          // เพิ่ม event listener สำหรับปุ่มบันทึก
          document.getElementById('save-config-btn').addEventListener('click', () => {
            this.saveConfigSetup();
          });

          // เพิ่ม event listener สำหรับการคลิกพื้นหลัง
          modalElement.addEventListener('click', (event) => {
            if (event.target === modalElement) {
              this.closeModal(modalId);
            }
          });
        },



        // 4. สร้างฟังก์ชันสำหรับปิด modal
        closeModal(modalId) {
          const modalElement = document.getElementById(modalId);
          if (modalElement) {
            modalElement.style.display = 'none';
          }
        },




        // 5. สร้างฟังก์ชันบันทึกการตั้งค่า
        saveConfigSetup() {
          // เตรียมข้อมูลสำหรับบันทึก
          const updatedConfig = {};

          // รวบรวมข้อมูลจาก form
          for (const field of this.missingConfigFields) {
            const inputElement = document.getElementById(`config-${field.key}`);
            if (inputElement) {
              updatedConfig[field.key] = inputElement.value.trim();
            }
          }

          // ตรวจสอบว่ามีการกรอกข้อมูลครบหรือไม่
          const stillMissing = this.missingConfigFields.some(field => {
            return !updatedConfig[field.key] || updatedConfig[field.key] === '';
          });

          if (stillMissing) {
            this.showNotification('กรุณากรอกข้อมูลให้ครบทุกช่อง', 'warning');
            return;
          }

          // แสดง loading
          this.isLoading = true;

          // เปลี่ยนข้อความปุ่มเป็น Loading และปิดการใช้งาน
          const saveButton = document.getElementById('save-config-btn');
          const originalText = saveButton.innerHTML;
          saveButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> กำลังบันทึก...';
          saveButton.disabled = true;

          const sheetID = localStorage.getItem('sheetID') || '';

          // 🔧 แก้ไข: จัดรูปแบบข้อมูลให้ตรงกับที่ Backend ต้องการ
          const configData = {
            config: updatedConfig,           // ✅ ข้อมูลการตั้งค่า
            userPermissions: {},             // ✅ สิทธิ์ผู้ใช้ (ว่างไว้ก่อน)
            rolePermissions: {},             // ✅ สิทธิ์กลุ่ม (ว่างไว้ก่อน)
            roleNames: {},                   // ✅ ชื่อกลุ่ม (ว่างไว้ก่อน)
            roleDescriptions: {}             // ✅ คำอธิบายกลุ่ม (ว่างไว้ก่อน)
          };

          // เพิ่มการ debug
          console.log('กำลังส่งข้อมูล:', configData);
          console.log('Sheet ID:', sheetID);

          // บันทึกการตั้งค่า
          google.script.run
            .withSuccessHandler(result => {
              console.log('บันทึกสำเร็จ:', result);

              // อัพเดทค่าใน config object
              for (const key in updatedConfig) {
                this.config[key] = updatedConfig[key];
              }

              // ปิด modal
              const modalElement = document.getElementById('configSetupModal');
              if (modalElement) {
                modalElement.style.display = 'none';
                modalElement.remove();
              }

              // คืนค่าปุ่มเป็นสถานะปกติ
              saveButton.innerHTML = originalText;
              saveButton.disabled = false;

              // แสดงข้อความแจ้งเตือน
              this.showNotification('บันทึกการตั้งค่าเรียบร้อยแล้ว', 'success');
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error('บันทึกไม่สำเร็จ:', error);

              // คืนค่าปุ่มเป็นสถานะปกติ
              saveButton.innerHTML = originalText;
              saveButton.disabled = false;

              this.showNotification('บันทึกการตั้งค่าไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .updateSystemConfig(configData, sheetID); // ✅ ส่งข้อมูลรูปแบบใหม่
        },




        // แก้ไขฟังก์ชัน calculateStats เพื่อใช้ฟังก์ชันกลาง
        calculateStats() {
          // ตรวจสอบว่ามีข้อมูลหรือไม่
          if (!this.rentals || !Array.isArray(this.rentals)) {
            this.rentalStats = {
              total: 0,
              completed: 0,
              inProgress: 0,
              upcoming: 0,
              incomeCurrent: 0,
              incomeTotal: 0,
              availableCars: 0,
              totalCars: 0
            };
            return;
          }

          // นับจำนวนรวม
          const totalRentals = this.rentals.length;

          // ตรวจสอบรายการที่เสร็จสิ้นแล้ว, กำลังดำเนินการ, และกำลังจะมาถึง
          const today = new Date();
          today.setHours(0, 0, 0, 0); // ตั้งเวลาเป็นต้นวัน

          let completedCount = 0;
          let inProgressCount = 0;
          let upcomingCount = 0;
          let incomeCurrent = 0;
          let incomeTotal = 0;

          this.rentals.forEach(rental => {
            try {
              if (rental.ราคา) {
                incomeTotal += parseFloat(rental.ราคา) || 0;
              }

              if (!rental.วันที่เช่า || !rental.วันที่คืน) return;

              // แปลงวันที่จาก ISO string เป็น Date
              const startDate = new Date(rental.วันที่เช่า);
              startDate.setHours(0, 0, 0, 0);

              const endDate = new Date(rental.วันที่คืน);
              endDate.setHours(23, 59, 59, 999);

              // ตรวจสอบสถานะของการเช่า
              if (endDate < today) {
                // รายการที่เสร็จสิ้นแล้ว (วันสิ้นสุดผ่านไปแล้ว)
                completedCount++;
              } else if (startDate <= today && today <= endDate) {
                // รายการที่กำลังดำเนินการอยู่ (วันนี้อยู่ในช่วงเช่า)
                inProgressCount++;

                if (rental.ราคา) {
                  incomeCurrent += parseFloat(rental.ราคา) || 0;
                }
              } else if (startDate > today) {
                // รายการที่กำลังจะมาถึง (วันเริ่มต้นยังมาไม่ถึง)
                upcomingCount++;
              }
            } catch (e) {
              console.error("เกิดข้อผิดพลาดในการคำนวณสถิติ:", e);
            }
          });

          // ใช้ฟังก์ชันกลางสำหรับนับจำนวนรถว่างและรถทั้งหมด
          const availableCarsCount = this.getAvailableCarsCount(); // ใช้ฟังก์ชันกลาง
          const totalCarsCount = this.cars && Array.isArray(this.cars) ? this.cars.length : 0;

          // this.debugCarData();
          // อัปเดตข้อมูลสถิติ
          this.rentalStats = {
            total: totalRentals,
            completed: completedCount,
            inProgress: inProgressCount,
            upcoming: upcomingCount,
            incomeCurrent: incomeCurrent,
            incomeTotal: incomeTotal,
            availableCars: availableCarsCount,  // ใช้ค่าจากฟังก์ชันกลาง
            totalCars: totalCarsCount
          };
        },






        fetchTodayScheduleFromCache() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.pickupsForSelectedDate = result.data.pickups || [];
                this.returnsForSelectedDate = result.data.returns || [];
              } else {
                // หากดึงจาก Cache ไม่สำเร็จ ให้กลับไปใช้วิธีเดิม
                this.showNotification('ไม่สามารถโหลดข้อมูลจากแคชได้: ' + result.message, 'warning');
                this.fetchScheduleForDate(); // Fallback to original function
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูลตารางเวลา: ' + error, 'error');
              this.fetchScheduleForDate(); // Fallback to original function
              this.isLoading = false;
            })
            .getTodayScheduleFromCache(sheetID);
        },



        fetchScheduleForDate() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          // ไม่มีการแยกเงื่อนไขสำหรับ "วันนี้" อีกต่อไป
          // ฟังก์ชันนี้จะดึงข้อมูลสดใหม่ตามวันที่เลือกเสมอ
          google.script.run
            .withSuccessHandler(jsonResult => {
              this.isLoading = false;
              try {
                // **ส่วนสำคัญที่ขาดไป: แปลง JSON string ที่ได้รับกลับมาเป็น Object**
                if (typeof jsonResult === 'string' && jsonResult.length > 0) {
                  const result = JSON.parse(jsonResult);
                  if (result.success) {
                    this.pickupsForSelectedDate = result.data.pickups || [];
                    this.returnsForSelectedDate = result.data.returns || [];
                  } else {
                    this.showNotification('ไม่สามารถโหลดข้อมูลได้: ' + result.message, 'error');
                    this.pickupsForSelectedDate = [];
                    this.returnsForSelectedDate = [];
                  }
                } else {
                  // กรณีได้รับข้อมูลที่ไม่ใช่ string หรือ string ว่างเปล่า
                  this.pickupsForSelectedDate = [];
                  this.returnsForSelectedDate = [];
                }
              } catch (e) {
                console.error("JSON Parse Error in fetchScheduleForDate:", e, "Received:", jsonResult);
                this.showNotification('เกิดข้อผิดพลาดในการประมวลผลข้อมูล', 'error');
                this.pickupsForSelectedDate = [];
                this.returnsForSelectedDate = [];
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลตารางรับส่งรถ:", error);
              this.showNotification('โหลดข้อมูลตารางรับส่งรถไม่สำเร็จ: ' + error, 'error');
              this.pickupsForSelectedDate = [];
              this.returnsForSelectedDate = [];
            })
            .getScheduleForDate(this.selectedScheduleDateString, sheetID);
        },






        get sortedScheduleForTimeline() {
          // ---- โค้ดป้องกัน Error ที่ดีที่สุด ----
          if (!Array.isArray(this.pickupsForSelectedDate) || !Array.isArray(this.returnsForSelectedDate)) {
            return []; // ถ้าข้อมูลยังไม่พร้อม ให้ส่งค่าว่างกลับไปก่อน
          }
          // ---- จบส่วนป้องกัน ----

          const pickups = this.pickupsForSelectedDate.map((item, index) => ({
            ...item,
            ประเภท: 'รับรถ',
            id: item.id || item.หมายเลขการจอง || `pickup_${this.selectedScheduleDateString}_${index}`
          }));

          const returns = this.returnsForSelectedDate.map((item, index) => ({
            ...item,
            ประเภท: 'ส่งคืนรถ',
            id: item.id || item.หมายเลขการจอง || `return_${this.selectedScheduleDateString}_${index}`
          }));

          const allItems = [...pickups, ...returns];

          return allItems.sort((a, b) => {
            try {
              const timeA = String(a.เวลา || '00:00');
              const timeB = String(b.เวลา || '00:00');
              return timeA.localeCompare(timeB);
            } catch (e) {
              console.error('เกิดข้อผิดพลาดขณะจัดเรียงข้อมูลไทม์ไลน์:', e, { a, b });
              return 0;
            }
          });
        },


        // ฟังก์ชันสำหรับเปิด Modal แสดงรายละเอียด
        openScheduleDetailsModal(item) {
          this.scheduleDetailModal.item = item;
          this.scheduleDetailModal.show = true;
        },

        // ฟังก์ชันสร้างข้อความสรุปสำหรับแชร์
        generateScheduleSummary() {
          const pickupCount = this.pickupsForSelectedDate.length;
          const returnCount = this.returnsForSelectedDate.length;
          const date = this.formatDate(this.selectedScheduleDateString); // ใช้ค่าจาก model ได้เลย

          let summary = `🗓️ รายการรับส่งรถวันที่ ${date}\n\n`;
          summary += `⬆️ รับรถ: ${pickupCount} คัน\n`;
          summary += `⬇️ ส่งคืนรถ: ${returnCount} คัน\n\n`;

          if (pickupCount > 0) {
            summary += `--- รายการรับรถ ---\n`;
            this.pickupsForSelectedDate.forEach((item, index) => {
              summary += `${index + 1}. #${item.หมายเลขการจอง} ${item.รถ}\n`;
              summary += `   ⏰ ${this.formatTime(item.เวลา)} น.\n`;
              if (item.สถานที่รับรถ) {
                summary += `   📍 ${item.สถานที่รับรถ}\n`;
              }
              summary += '\n';
            });
          }

          if (returnCount > 0) {
            summary += `--- รายการส่งคืนรถ ---\n`;
            this.returnsForSelectedDate.forEach((item, index) => {
              summary += `${index + 1}. #${item.หมายเลขการจอง} ${item.รถ}\n`;
              summary += `   ⏰ ${this.formatTime(item.เวลา)} น.\n`;
              if (item.สถานที่คืนรถ) {
                summary += `   📍 ${item.สถานที่คืนรถ}\n`;
              }
              summary += '\n';
            });
          }

          return summary;
        },

        // ฟังก์ชันแชร์ (ทำงานเหมือนเดิม แต่ใช้ข้อมูลใหม่)
        async shareScheduleSummary() {
          const summary = this.generateScheduleSummary();
          const shareTitle = `รายการรับส่งรถ ${this.formatDate(this.selectedScheduleDateString)}`;

          try {
            if (navigator.share) {
              await navigator.share({ title: shareTitle, text: summary });
              this.showNotification('แชร์ข้อมูลสำเร็จ', 'success');
            } else {
              this.copyScheduleSummaryToClipboard(); // Fallback to copy
            }
          } catch (err) {
            if (err.name !== 'AbortError') {
              console.error('เกิดข้อผิดพลาดในการแชร์: ', err);
              this.showNotification('การแชร์ล้มเหลว', 'error');
            }
          }
        },

        // ฟังก์ชันคัดลอก (ทำงานเหมือนเดิม แต่ใช้ข้อมูลใหม่)
        copyScheduleSummaryToClipboard() {
          const summary = this.generateScheduleSummary();
          navigator.clipboard.writeText(summary).then(() => {
            this.showNotification('คัดลอกข้อความไปยังคลิปบอร์ดแล้ว', 'success');
          }).catch(err => {
            console.error('ไม่สามารถคัดลอกข้อความได้: ', err);
            this.showNotification('คัดลอกข้อความไม่สำเร็จ', 'error');
          });
        },




        // แก้ไขฟังก์ชันนี้
        generateDailySchedulePDF() {
          // 1. รวบรวมข้อมูลสำหรับสร้าง dropdown filter
          const pickups = this.pickupsForSelectedDate;
          const returns = this.returnsForSelectedDate;

          const locations = new Set();
          const carModels = new Set();

          pickups.forEach(item => {
            if (item.สถานที่รับรถ) locations.add(item.สถานที่รับรถ);
            if (item.รถ) carModels.add(item.รถ);
          });
          returns.forEach(item => {
            if (item.สถานที่คืนรถ) locations.add(item.สถานที่คืนรถ);
            if (item.รถ) carModels.add(item.รถ);
          });

          this.allLocations = [...locations].sort();
          this.allCarModels = [...carModels].sort();

          // 2. รีเซ็ตค่า filter ใน modal ทุกครั้งที่เปิด
          this.pdfFilter = { location: '', carModel: '' };

          // 3. เปิด Modal
          this.showColumnSelectionModal = true;
          this.isPdfGenerated = false;
          this.isPdfGenerating = false;
        },






        // แก้ไขฟังก์ชันนี้
        confirmDailyReportPDF() {
          // --- ส่วนแก้ไข: ปิด Modal ตัวเลือก และเปิด Modal กำลังประมวลผล ---
          this.showColumnSelectionModal = false;
          this.isPdfGenerating = true;
          // -----------------------------------------------------------

          this.pdfLoadingStep = 'กำลังเตรียมข้อมูล...';
          this.pdfLoadingProgress = 10;

          // --- ส่วนแก้ไข: ใช้ข้อมูลจาก filteredForPdf แทนข้อมูลดิบ ---
          const filteredData = this.filteredForPdf;
          const allItems = [...filteredData.pickups, ...filteredData.returns].sort((a, b) => (a.เวลา || '').localeCompare(b.เวลา || ''));
          const pickupsCount = filteredData.pickups.length;
          const returnsCount = filteredData.returns.length;
          // ----------------------------------------------------

          const formattedDate = this.formatDate(this.selectedScheduleDateString);
          const sheetID = localStorage.getItem('sheetID') || '';

          // ส่วนที่เหลือของฟังก์ชัน (การเรียก google.script.run) คงเดิม...
          google.script.run
            .withSuccessHandler((pdfUrl) => {
              this.pdfLoadingProgress = 100;
              this.pdfLoadingStep = 'การสร้าง PDF สำเร็จ!';
              setTimeout(() => {
                this.generatedPdfUrl = pdfUrl;
                this.isPdfGenerating = false;
                this.isPdfGenerated = true; // เปิด Modal ผลลัพธ์
                window.open(pdfUrl, '_blank');
              }, 700);
            })
            .withFailureHandler((error) => {
              this.isPdfGenerating = false;
              this.showNotification('สร้าง PDF ไม่สำเร็จ: ' + error, 'error');
            })
            .createDailyScheduleToPDF(formattedDate, allItems, pickupsCount, returnsCount, sheetID);
        },







        // --- ฟังก์ชันสร้าง DateTime ที่ง่ายขึ้น ---
        createDateTime(dateISOString, timeHHMMString) {
          // //console.log(`[createDateTime] Input Date: ${dateISOString}, Time: ${timeHHMMString}`);

          // --- ตรวจสอบ Input ---
          if (!dateISOString || typeof dateISOString !== 'string') {
            console.error(`[createDateTime] Error: dateISOString ไม่ถูกต้อง (${dateISOString})`);
            return null;
          }
          // ตรวจสอบ timeHHMMString เพิ่มเติม
          if (!timeHHMMString || typeof timeHHMMString !== 'string' || !/^\d{2}:\d{2}$/.test(timeHHMMString)) {
            console.error(`[createDateTime] Error: timeHHMMString ไม่ถูกต้อง (${timeHHMMString})`);
            // อาจจะลองใช้เวลา default 00:00 ถ้าต้องการ แต่คืน null ปลอดภัยกว่า
            return null;
          }

          try {
            // 1. แยกชั่วโมงและนาทีจาก "HH:MM"
            const [hours, minutes] = timeHHMMString.split(':').map(Number);

            // 2. สร้าง Date object จาก ISO string
            // new Date() สามารถ parse ISO string ได้โดยตรง และจะเก็บค่าเป็น UTC
            // แต่เมื่อเรียกใช้ getFullYear, getMonth, getDate จะได้ค่าตาม *local timezone* ของ Client
            const baseDate = new Date(dateISOString);
            if (isNaN(baseDate.getTime())) {
              console.error(`[createDateTime] Error: ไม่สามารถแปลง dateISOString เป็น Date ได้ (${dateISOString})`);
              return null;
            }

            // 3. สร้าง Date object สุดท้ายโดยระบุ ปี, เดือน, วัน, ชั่วโมง, นาที เป็น *Local Time*
            // ใช้ค่า ปี, เดือน, วัน จาก baseDate ที่แปลงเป็น Local แล้ว
            // และใช้ ชั่วโมง, นาที ที่ได้จาก timeHHMMString
            const finalDateTime = new Date(
              baseDate.getFullYear(), // ปีท้องถิ่น
              baseDate.getMonth(),    // เดือนท้องถิ่น (0-11)
              baseDate.getDate(),     // วันที่ท้องถิ่น
              hours,                  // ชั่วโมงที่ต้องการ
              minutes,                // นาทีที่ต้องการ
              0,                      // วินาที
              0                       // มิลลิวินาที
            );

            // ตรวจสอบผลลัพธ์สุดท้ายอีกครั้ง
            if (isNaN(finalDateTime.getTime())) {
              console.error(`[createDateTime] Error: ไม่สามารถสร้าง Final DateTime จาก Components ได้`);
              return null;
            }

            // //console.log(`[createDateTime] สร้างสำเร็จ (Local): ${finalDateTime}`);
            return finalDateTime; // คืนค่า Date object ที่สมบูรณ์

          } catch (error) {
            console.error(`[createDateTime] เกิด Exception: ${error}. Inputs: Date=${dateISOString}, Time=${timeHHMMString}`);
            return null;
          }
        },




        // ฟังก์ชันคำนวณจำนวนรถว่างและรถทั้งหมด
        calculateAvailableCars() {
          // ใช้ฟังก์ชันกลาง getAvailableCarsCount แทนการคำนวณเอง
          const availableCars = this.getAvailableCarsCount();
          const totalCars = this.cars && Array.isArray(this.cars) ? this.cars.length : 0;

          // อัปเดตค่าสถิติ
          this.rentalStats.availableCars = availableCars;
          this.rentalStats.totalCars = totalCars;

          // console.log(`[Client] จำนวนรถที่ว่างจริงๆ (calculateAvailableCars): ${availableCars}`);
        },


        calculateTodayPickupsAndReturns() {
          if (!this.scheduleItems || !Array.isArray(this.scheduleItems)) {
            this.fetchTodayScheduleFromCache(); // <-- แก้ไขให้เรียกฟังก์ชันใหม่ที่ดึงจากแคชโดยตรง
            return;
          }

          // ส่วนที่เหลือของฟังก์ชันเหมือนเดิม...
          const today = this.formatDateForComparison(new Date());

          let todayPickups = 0;
          let todayReturns = 0;

          this.scheduleItems.forEach(item => {
            if (!item.วันที่ || !item.ประเภท) return;

            const itemDate = this.formatDateForComparison(item.วันที่);

            if (itemDate === today) {
              if (item.ประเภท === 'รับรถ') {
                todayPickups++;
              } else if (item.ประเภท === 'ส่งคืนรถ') {
                todayReturns++;
              }
            }
          });

          this.rentalStats.todayPickups = todayPickups;
          this.rentalStats.todayReturns = todayReturns;
        },



        formatCurrency(amount) {
          const num = parseFloat(amount) || 0;

          const options = {
            style: 'currency',
            currency: 'THB',
            minimumFractionDigits: 2, // <--- ✅ แก้ไขเป็น 2
            maximumFractionDigits: 2
          };

          return new Intl.NumberFormat('th-TH', options).format(num);
        },




        formatNumber(value) {
          const num = parseFloat(value) || 0;

          return num.toFixed(2); // <--- ✅ แก้ไขเป็น .toFixed(2) เสมอ
        },

        // ฟังก์ชันแสดงทศนิยม 2 ตำแหน่งเมื่อมีทศนิยม แต่ถ้าเป็น .00 ไม่แสดงทศนิยม
        formatCurrencyOptional(amount) {
          const num = parseFloat(amount) || 0;
          const hasFraction = num % 1 !== 0;

          const options = {
            style: 'currency',
            currency: 'THB',
            minimumFractionDigits: hasFraction ? 2 : 0,
            maximumFractionDigits: hasFraction ? 2 : 0
          };

          return new Intl.NumberFormat('th-TH', options).format(num);
        },

        // ฟังก์ชันแสดงตัวเลขทศนิยม 2 ตำแหน่งเมื่อมีทศนิยม แต่ถ้าเป็น .00 ไม่แสดงทศนิยม (ไม่มี currency symbol)
        formatNumberOptional(value) {
          const num = parseFloat(value) || 0;
          const hasFraction = num % 1 !== 0;

          if (hasFraction) {
            return num.toLocaleString('th-TH', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            });
          }
          return num.toLocaleString('th-TH');
        },






        formatCurrencyForSummary(value, language = 'th') {
          if (!value) return "0";

          const amount = parseFloat(value);
          if (isNaN(amount)) return String(value);

          // ถ้าอยากแสดง .00 เมื่อมีทศนิยมจริงๆ แต่ไม่แสดง .00 เมื่อเป็นจำนวนเต็ม
          const hasFraction = amount % 1 !== 0;
          const fractionDigits = hasFraction ? 2 : 0;

          const options = {
            style: 'currency',
            currency: 'THB',
            minimumFractionDigits: fractionDigits,
            maximumFractionDigits: fractionDigits,
          };

          if (language === 'th') {
            return new Intl.NumberFormat('th-TH', options).format(amount);
          } else {
            return new Intl.NumberFormat('en-US', options).format(amount);
          }
        },




        formatDateForSummary(dateValue, language = 'th') {
          if (!dateValue) return "";

          let date;
          if (dateValue instanceof Date) {
            date = dateValue;
          } else {
            date = new Date(dateValue);
          }

          if (isNaN(date.getTime())) return String(dateValue);

          // แยกเฉพาะภาษาไทยและภาษาอังกฤษ
          if (language === 'th') {
            return date.toLocaleDateString('th-TH', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          } else {
            // ภาษาอื่นๆ ทั้งหมดใช้รูปแบบภาษาอังกฤษ
            return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          }
        },


        // จัดรูปแบบวันที่
        formatDate(dateValue) {
          if (!dateValue) return '-';

          let date;
          if (typeof dateValue === 'string' && dateValue.includes('/')) {
            const parts = dateValue.split('/');
            date = new Date(parts[2], parts[1] - 1, parts[0]);
          } else if (dateValue instanceof Date) {
            date = dateValue;
          } else {
            date = new Date(dateValue);
          }

          if (isNaN(date.getTime())) return dateValue;

          return date.toLocaleDateString('th-TH');
        },

        // จัดรูปแบบเวลา
        formatTime(timeValue) {
          if (!timeValue) return '-';
          return timeValue;
        },

        // ============================================
        // Timeline Tab Functions
        // ============================================

        // โหลดรายชื่อรถและตัวเลือกเดือน
        initTimelineData() {
          console.log('[Timeline] initTimelineData() called');
          console.log('[Timeline] Current selectedMonth:', this.timeline.selectedMonth);
          console.log('[Timeline] monthOptions:', this.timeline.monthOptions);

          // โหลดรายชื่อรถ (monthOptions และ selectedMonth ถูกสร้างไว้แล้วตอนเริ่มต้น)
          if (!this.timeline.carList || this.timeline.carList.length === 0) {
            console.log('[Timeline] Loading car list...');
            this.timeline.isLoadingCarList = true;
            google.script.run
              .withSuccessHandler((cars) => {
                console.log('[Timeline] Car list loaded:', cars);
                this.timeline.carList = cars;
                this.timeline.isLoadingCarList = false;
              })
              .withFailureHandler((error) => {
                console.error('[Timeline] Failed to load car list:', error);
                this.timeline.isLoadingCarList = false;
                alert('ไม่สามารถโหลดรายชื่อรถได้: ' + error.message);
              })
              .getCarList(this.sheetID);
          } else {
            console.log('[Timeline] Car list already loaded:', this.timeline.carList.length, 'cars');
          }
        },

        // ค้นหาตารางคิวรถ
        searchCarTimeline() {
          if (!this.timeline.selectedCar) {
            alert('กรุณาเลือกรถ');
            return;
          }

          console.log('[Timeline] searchCarTimeline() called');
          console.log('[Timeline] Selected car:', this.timeline.selectedCar);
          console.log('[Timeline] Selected month:', this.timeline.selectedMonth);

          // รีเซ็ตข้อมูลการ์ดค้นหารถทดแทน
          this.timeline.alternativeSearch = {
            pickupDate: '',
            pickupTime: '10:00',
            returnDate: '',
            returnTime: '10:00',
            isSearching: false,
            searched: false,
            results: []
          };
          this.timeline.showAlternativeSearch = false;

          this.timeline.isLoading = true;
          this.timeline.searchPerformed = false;

          const [year, month] = this.timeline.selectedMonth.split('-');
          console.log('[Timeline] Search params - Year:', year, 'Month:', month, 'SheetID:', this.sheetID);

          google.script.run
            .withSuccessHandler((result) => {
              console.log('[Timeline] Backend result:', result);

              // ตรวจสอบว่ามี error หรือไม่
              if (result.error) {
                console.error('[Timeline] Backend error:', result.error);
                if (result.headers) {
                  console.log('[Timeline] Available headers in sheet:', result.headers);
                }
                alert('เกิดข้อผิดพลาด: ' + result.error);
                this.timeline.isLoading = false;
                return;
              }

              console.log('[Timeline] Bookings found:', result.bookings?.length || 0);
              console.log('[Timeline] Summary:', result.summary);

              this.timeline.bookings = result.bookings || [];
              this.timeline.summary = result.summary || { totalDays: 0, rentedDays: 0, freeDays: 0 };
              this.timeline.searchPerformed = true;
              this.timeline.isLoading = false;
            })
            .withFailureHandler((error) => {
              console.error('[Timeline] Search failed:', error);
              alert('ไม่สามารถค้นหาได้: ' + error.message);
              this.timeline.isLoading = false;
            })
            .getCarBookingsByMonth(this.timeline.selectedCar, parseInt(year), parseInt(month), this.sheetID);
        },


        // ตั้งค่าช่วงวันที่แบบด่วน
        setQuickDateRange(type) {
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);

          if (type === 'today') {
            // วันนี้ - พรุ่งนี้
            this.timeline.alternativeSearch.pickupDate = today.toISOString().split('T')[0];
            this.timeline.alternativeSearch.returnDate = tomorrow.toISOString().split('T')[0];
          } else if (type === 'weekend') {
            // สุดสัปดาห์นี้ (ศุกร์ - อาทิตย์)
            const dayOfWeek = today.getDay();
            const daysUntilFriday = (5 - dayOfWeek + 7) % 7 || 7;
            const friday = new Date(today);
            friday.setDate(today.getDate() + daysUntilFriday);
            const sunday = new Date(friday);
            sunday.setDate(friday.getDate() + 2);

            this.timeline.alternativeSearch.pickupDate = friday.toISOString().split('T')[0];
            this.timeline.alternativeSearch.returnDate = sunday.toISOString().split('T')[0];
          } else if (type === 'week') {
            // 7 วันข้างหน้า
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            this.timeline.alternativeSearch.pickupDate = today.toISOString().split('T')[0];
            this.timeline.alternativeSearch.returnDate = nextWeek.toISOString().split('T')[0];
          }
        },

        // ค้นหารถทดแทน
        searchAlternativeCars() {
          const { pickupDate, returnDate, pickupTime, returnTime } = this.timeline.alternativeSearch;

          if (!pickupDate || !returnDate) {
            Swal.fire({
              icon: 'warning',
              title: 'กรุณากรอกข้อมูล',
              text: 'กรุณาเลือกวันรับรถและวันคืนรถ',
              confirmButtonColor: '#3b82f6'
            });
            return;
          }

          // ตรวจสอบว่าวันคืนต้องมากกว่าหรือเท่ากับวันรับ
          if (new Date(returnDate) < new Date(pickupDate)) {
            Swal.fire({
              icon: 'error',
              title: 'วันที่ไม่ถูกต้อง',
              text: 'วันคืนรถต้องมากกว่าหรือเท่ากับวันรับรถ',
              confirmButtonColor: '#ef4444'
            });
            return;
          }

          // รีเซ็ตผลการค้นหาก่อนหน้า
          this.timeline.alternativeSearch.results = [];
          this.timeline.alternativeSearch.isSearching = true;
          this.timeline.alternativeSearch.searched = false;

          // ดึงชื่อรุ่นรถจาก selectedCar
          const carModel = this.timeline.selectedCar.split('(')[0].trim();
          console.log('[Alternative Search] Looking for cars with model:', carModel);

          // หารถรุ่นเดียวกันทั้งหมด
          const similarCars = this.timeline.carList.filter(car =>
            car.fullName.toLowerCase().includes(carModel.toLowerCase())
          );

          if (similarCars.length === 0) {
            this.timeline.alternativeSearch.isSearching = false;
            this.timeline.alternativeSearch.searched = true;
            Swal.fire({
              icon: 'info',
              title: 'ไม่พบรถรุ่นเดียวกัน',
              text: `ไม่พบรถรุ่น ${carModel} ในระบบ`,
              confirmButtonColor: '#3b82f6'
            });
            return;
          }

          // สร้าง array ของรถที่จะเช็ค
          const carsToCheck = similarCars.map(car => ({
            carName: car.fullName,
            plate: car.plate || car.fullName.match(/\((.*?)\)/)?.[1] || ''
          }));

          // เช็คทีละคัน
          const results = [];
          let checkedCount = 0;

          // แสดง progress
          Swal.fire({
            html: `<div class="text-center">
              <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-3"></i>
              <p class="text-lg font-semibold">กำลังตรวจสอบรถ...</p>
              <p class="text-sm text-gray-500 mt-2">
                <span id="check-progress">0</span> / ${similarCars.length} คัน
              </p>
            </div>`,
            allowOutsideClick: false,
            showConfirmButton: false
          });

          // เช็คทีละคันแบบ sequential
          const checkNextCar = (index) => {
            if (index >= similarCars.length) {
              // เช็คเสร็จหมดแล้ว
              Swal.close();

              this.timeline.alternativeSearch.results = results;
              this.timeline.alternativeSearch.searched = true;
              this.timeline.alternativeSearch.isSearching = false;

              // แสดงผลสรุป
              const availableCars = results.filter(car => car.available);

              if (availableCars.length > 0) {
                Swal.fire({
                  icon: 'success',
                  title: 'พบรถว่าง!',
                  html: `พบรถรุ่น ${carModel} ว่าง <strong>${availableCars.length}</strong> คัน<br>จากทั้งหมด ${results.length} คัน`,
                  timer: 2000,
                  showConfirmButton: false
                });
              } else {
                Swal.fire({
                  icon: 'warning',
                  title: 'ไม่มีรถว่าง',
                  html: `รถรุ่น ${carModel} ทั้งหมด ${results.length} คัน<br>ไม่ว่างในช่วงเวลาที่เลือก`,
                  confirmButtonColor: '#f59e0b'
                });
              }
              return;
            }

            const car = similarCars[index];
            const plate = car.plate || car.fullName.match(/\((.*?)\)/)?.[1] || '';

            // สร้าง DateTime string สำหรับการเช็ค (ISO format)
            const pickupDateTimeString = `${pickupDate}T${pickupTime}:00`;
            const returnDateTimeString = `${returnDate}T${returnTime}:00`;

            // เรียก checkCarBookingAvailability สำหรับรถแต่ละคัน
            google.script.run
              .withSuccessHandler((result) => {
                checkedCount++;
                const progressEl = document.getElementById('check-progress');
                if (progressEl) progressEl.textContent = checkedCount;

                console.log(`[Alternative Search] Result for ${car.fullName}:`, result);

                // ตรวจสอบว่ารถว่างหรือไม่
                const isAvailable = result && result.available === true;

                results.push({
                  fullName: car.fullName,
                  plate: plate,
                  available: isAvailable,
                  conflicts: result?.conflicts || []
                });

                // เช็คคันถัดไป
                checkNextCar(index + 1);
              })
              .withFailureHandler((error) => {
                console.error(`[Alternative Search] Error checking ${car.fullName}:`, error);

                // ถ้า error ก็นับเป็นไม่ว่าง
                results.push({
                  fullName: car.fullName,
                  plate: plate,
                  available: false,
                  conflicts: []
                });

                checkedCount++;
                const progressEl = document.getElementById('check-progress');
                if (progressEl) progressEl.textContent = checkedCount;

                // เช็คคันถัดไป
                checkNextCar(index + 1);
              })
              .checkCarBookingAvailability(
                car.fullName,
                pickupDateTimeString,
                returnDateTimeString,
                pickupDate,
                returnDate,
                this.sheetID,
                null,  // editingBookingNumber
                30     // prepTimeMinutes
              );
          };

          // เริ่มเช็คจากคันแรก
          checkNextCar(0);
        },


        // แปลงเดือนเป็นชื่อภาษาไทย
        getMonthNameThai(yearMonth) {
          if (!yearMonth) return '';
          const [year, month] = yearMonth.split('-');
          const monthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
            'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
          const monthIndex = parseInt(month) - 1;
          const thaiYear = parseInt(year) + 543;
          return monthNames[monthIndex] + ' ' + (thaiYear % 100);
        },

        // คำนวณตำแหน่งและขนาดของ booking bar ใน timeline
        getBookingStyle(booking, index, selectedMonth, totalDays) {
          const [year, month] = selectedMonth.split('-');
          const monthStart = new Date(parseInt(year), parseInt(month) - 1, 1);
          const monthEnd = new Date(parseInt(year), parseInt(month), 0);

          const bookingStart = new Date(booking.startDate);
          bookingStart.setHours(0, 0, 0, 0);
          const bookingEnd = new Date(booking.endDate);
          bookingEnd.setHours(23, 59, 59, 999);

          // คำนวณวันที่เริ่มและสิ้นสุดภายในเดือนนี้
          const displayStart = bookingStart < monthStart ? monthStart : bookingStart;
          const displayEnd = bookingEnd > monthEnd ? monthEnd : bookingEnd;

          // คำนวณ column position (1-based)
          const startDay = displayStart.getDate();
          const endDay = displayEnd.getDate();
          const span = endDay - startDay + 1;

          // คำนวณ left และ width สำหรับ absolute positioning
          // แต่ละคอลัมน์คือ (100% / totalDays)
          const columnWidth = 100 / totalDays;
          const left = (startDay - 1) * columnWidth; // startDay - 1 เพราะวันที่ 1 = index 0
          const width = span * columnWidth;

          // คำนวณ row position (แถบสูง 40px + gap 8px = 48px ต่อแถว)
          const barHeight = 40;
          const barGap = 8;
          const top = index * (barHeight + barGap) + 5;

          // เลือกสี - เช็คว่าวันที่ปัจจุบันอยู่ระหว่างวันเช่า-วันคืนหรือไม่
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          let bgColor = '#10b981'; // เขียว - การจองปกติ

          // ถ้าวันปัจจุบันอยู่ระหว่างวันเช่าและวันคืน = กำลังเช่าอยู่
          if (today >= bookingStart && today <= bookingEnd) {
            bgColor = '#f97316'; // ส้ม - กำลังเช่าอยู่
          }

          return `
            left: ${left}%;
            width: ${width}%;
            top: ${top}px;
            height: ${barHeight}px;
            background: ${bgColor};
          `;
        },

        // แสดงรายละเอียด booking
        showBookingDetail(booking) {
          const startDateFormatted = this.formatThaiDateShort(booking.startDate);
          const endDateFormatted = this.formatThaiDateShort(booking.endDate);
          const days = this.calculateDays(booking.startDate, booking.endDate);

          Swal.fire({
            title: '<i class="fas fa-calendar-check text-blue-600"></i> รายละเอียดการจอง',
            html: `
              <div class="text-left space-y-3">
                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                  <i class="fas fa-hashtag text-blue-600 mr-3"></i>
                  <div>
                    <p class="text-xs text-gray-500">หมายเลขการจอง</p>
                    <p class="font-semibold text-gray-800">${booking.bookingNumber}</p>
                  </div>
                </div>
                <div class="flex items-center p-3 bg-green-50 rounded-lg">
                  <i class="fas fa-user text-green-600 mr-3"></i>
                  <div>
                    <p class="text-xs text-gray-500">ชื่อลูกค้า</p>
                    <p class="font-semibold text-gray-800">${booking.customerName}</p>
                  </div>
                </div>
                <div class="flex items-center p-3 bg-purple-50 rounded-lg">
                  <i class="fas fa-calendar-alt text-purple-600 mr-3"></i>
                  <div>
                    <p class="text-xs text-gray-500">วันที่เช่า - วันที่คืน</p>
                    <p class="font-semibold text-gray-800">${startDateFormatted} - ${endDateFormatted}</p>
                    <p class="text-xs text-gray-500 mt-1">${days} วัน</p>
                  </div>
                </div>
              </div>
            `,
            confirmButtonText: 'ปิด',
            confirmButtonColor: '#3b82f6',
            width: '400px'
          });
        },

        // แปลงวันที่เป็นชื่อวันย่อ (จ, อ, พ, ...)
        getDayName(day, selectedMonth) {
          const [year, month] = selectedMonth.split('-');
          const date = new Date(parseInt(year), parseInt(month) - 1, day);
          const dayNames = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
          return dayNames[date.getDay()];
        },

        // Format วันที่แบบสั้น (11 พ.ย. 68)
        formatThaiDateShort(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          const monthNamesShort = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
          const thaiYear = (date.getFullYear() + 543).toString().slice(-2);
          return `${date.getDate()} ${monthNamesShort[date.getMonth()]} ${thaiYear}`;
        },

        // คำนวณจำนวนวัน
        calculateDays(startDate, endDate) {
          const start = new Date(startDate);
          const end = new Date(endDate);
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays;
        },

        // กรองรายการเช่าตามคำค้นหา
        // เมธอดช่วยคำนวณวันแรกและวันสุดท้ายของเดือน
        getMonthStartAndEnd(month, year) {
          const startDate = new Date(year, month - 1, 1);
          const endDate = new Date(year, month, 0);
          return { startDate, endDate };
        },




        // เมธอดช่วยเปรียบเทียบวันที่
        isSameDay(date1, date2) {
          return (
            date1.getFullYear() === date2.getFullYear() &&
            date1.getMonth() === date2.getMonth() &&
            date1.getDate() === date2.getDate()
          );
        },

        // รับตัวเลือกปี (ปีปัจจุบัน - 1, ปีปัจจุบัน, ปีปัจจุบัน + 1, ปีปัจจุบัน + 2)
        getYearOptions() {
          const currentYear = new Date().getFullYear(); // จะได้ปี 2025 ตามเวลาปัจจุบัน
          return [
            currentYear - 1, // 2024
            currentYear,     // 2025
            currentYear + 1, // 2026
            currentYear + 2  // 2027
          ];
        },






        // ฟังก์ชันสำหรับค้นหาใน Blacklist
        searchBlacklist() {
          if (!this.blacklistSearchQuery) {
            this.showNotification('กรุณาระบุคำค้นหา', 'error');
            return;
          }

          this.isLoading = true;
          this.hasSearched = true;

          // เรียกใช้ฟังก์ชันใน Google Apps Script
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.blacklistSearchResults = result.data || [];
                if (this.blacklistSearchResults.length === 0) {
                  this.showNotification('ไม่พบข้อมูลที่ตรงกับคำค้นหา', 'info');
                }
              } else {
                this.showNotification('ค้นหาข้อมูล Blacklist ไม่สำเร็จ: ' + result.message, 'error');
                this.blacklistSearchResults = [];
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('ค้นหาข้อมูล Blacklist ไม่สำเร็จ: ' + error, 'error');
              this.blacklistSearchResults = [];
              this.isLoading = false;
            })
            .searchBlacklist(this.blacklistSheetId, this.blacklistSearchQuery);
        },


        addBlacklistItem() {
          // ตรวจสอบข้อมูลครบถ้วนหรือไม่
          if (!this.newBlacklist.ชื่อ || !this.newBlacklist.เลขบัตรประจำตัวประชาชน || !this.newBlacklist.รูปแบบการโกง) {
            this.showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
            return;
          }

          // ตรวจสอบรูปแบบเลขบัตรประชาชน

          const idPassport = this.newBlacklist.เลขบัตรประจำตัวประชาชน;

          // ตรวจสอบกรณีบัตรประชาชน 13 หลัก
          const isThaiID = /^\d{13}$/.test(idPassport);
          // ตรวจสอบกรณีพาสปอร์ต (ตัวอักษร+ตัวเลข ความยาว 8-9 ตัว)
          const isPassport = /^[A-Z0-9]{8,9}$/.test(idPassport);

          if (!isThaiID && !isPassport) {
            this.showNotification('กรุณากรอกเลขบัตรประชาชน 13 หลัก หรือเลขพาสปอร์ต 8-9 หลัก (ตัวพิมพ์ใหญ่และตัวเลข)', 'error');
            return;
          }

          this.isLoading = true;

          // สร้างข้อมูลที่จะส่งไปบันทึก
          const blacklistData = {
            ชื่อ: this.newBlacklist.ชื่อ,
            เลขบัตรประจำตัวประชาชน: this.newBlacklist.เลขบัตรประจำตัวประชาชน, // แก้ชื่อฟิลด์ให้ตรงกับ spreadsheet
            รูปแบบการโกง: this.newBlacklist.รูปแบบการโกง,
            บริษัท: this.config.ชื่อบริษัท, // ส่งชื่อบริษัทไปด้วย
            ผู้บันทึก: this.currentUser.username, // ยังคงส่ง username ไปด้วยเผื่อกรณีที่ไม่มีชื่อบริษัท
            วันที่บันทึก: new Date().toISOString()
          };

          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('เพิ่มรายชื่อ Blacklist สำเร็จ');

                // รีเซ็ตฟอร์ม
                this.newBlacklist = {
                  ชื่อ: "",
                  เลขบัตรประจำตัวประชาชน: "",
                  รูปแบบการโกง: ""
                };


              } else {
                this.showNotification('เพิ่มรายชื่อ Blacklist ไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เพิ่มรายชื่อ Blacklist ไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .addBlacklistItem(this.blacklistSheetId, blacklistData);
        },

        // ฟังก์ชันสำหรับลบรายการ Blacklist
        deleteBlacklistItem(id) {
          const config = this.config;

          // แสดงกล่องยืนยันการลบ
          Swal.fire({
            title: 'ยืนยันการลบ',
            text: 'คุณต้องการลบรายชื่อนี้ออกจาก Blacklist ใช่หรือไม่?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบรายการ!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isLoading = true;

              // เรียกใช้ฟังก์ชันใน Google Apps Script
              google.script.run
                .withSuccessHandler(result => {
                  if (result.success) {
                    this.showNotification('ลบรายชื่อ Blacklist สำเร็จ');

                    // อัพเดตผลการค้นหาด้วย (ถ้ามี)
                    if (this.blacklistSearchResults.length > 0) {
                      this.blacklistSearchResults = this.blacklistSearchResults.filter(item => item.id !== result.id);
                    }

                    // ค้นหาข้อมูลใหม่หลังจากลบ
                    if (this.blacklistSearchQuery) {
                      this.searchBlacklist();
                    }
                  } else {
                    this.showNotification(result.message, 'error');
                  }
                  this.isLoading = false;
                })
                .withFailureHandler(error => {
                  this.showNotification('ลบรายชื่อ Blacklist ไม่สำเร็จ: ' + error, 'error');
                  this.isLoading = false;
                })
                .deleteBlacklistItem(this.blacklistSheetId, id, config.ชื่อบริษัท);
            }
          });
        },




        // จัดรูปแบบวันที่สำหรับเปรียบเทียบ
        //   formatDateForComparison(dateValue) {
        //   if (!dateValue) return '';

        //   let date;

        //   // กรณีรับค่าเป็น string จาก Google Sheets
        //   if (typeof dateValue === 'string') {
        //     // แปลงวันที่จาก format dd/mm/yyyy หรือ yyyy-mm-dd
        //     if (dateValue.includes('/')) {
        //       const [day, month, year] = dateValue.split('/');
        //       date = new Date(year, month - 1, day);
        //     } else if (dateValue.includes('-')) {
        //       date = new Date(dateValue);
        //     }
        //   } else if (dateValue instanceof Date) {
        //     date = dateValue;
        //   } else {
        //     date = new Date(dateValue);
        //   }

        //   if (isNaN(date.getTime())) return '';

        //   // ใช้ toLocaleDateString เพื่อให้ได้วันที่ตามโซนเวลาไทย
        //   return date.toLocaleDateString('th-TH', { 
        //     year: 'numeric', 
        //     month: '2-digit', 
        //     day: '2-digit' 
        //   }).split(' ').join('-');
        // },



        // แก้ไขฟังก์ชันนี้ทั้งหมด
        formatDateForComparison(dateValue) {
          if (!dateValue) return '';
          try {
            const date = new Date(dateValue);
            // ตรวจสอบว่าเป็นวันที่ที่ถูกต้องหรือไม่
            if (isNaN(date.getTime())) return '';

            // ดึงค่า ปี, เดือน, วัน ออกมาตรงๆ เพื่อหลีกเลี่ยงปัญหา Timezone
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // +1 เพราะเดือนเริ่มที่ 0
            const day = String(date.getDate()).padStart(2, '0');

            // คืนค่าเป็นรูปแบบมาตรฐาน YYYY-MM-DD ที่เปรียบเทียบได้ง่าย
            return `<span class="math-inline">\{year\}\-</span>{month}-${day}`;
          } catch (e) {
            console.error("Error formatting date for comparison:", e);
            return '';
          }
        },





        searchScheduleByBookingNumber() {
          if (!this.scheduleSearchQuery.trim()) {
            this.showNotification('กรุณากรอกหมายเลขการจอง', 'warning');
            return;
          }
          this.isSearchingSchedule = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.scheduleSearchResults = {
                  pickups: result.data.pickups || [],
                  returns: result.data.returns || [],
                  bookingNumber: this.scheduleSearchQuery.trim()
                };
              } else {
                this.showNotification(result.message, 'error');
                this.scheduleSearchResults.bookingNumber = null; // ไม่พบข้อมูล
              }
              this.isSearchingSchedule = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาดในการค้นหา: ' + error, 'error');
              this.isSearchingSchedule = false;
            })
            .getScheduleByBookingNumber(this.scheduleSearchQuery.trim(), sheetID);
        },

        clearScheduleSearch() {
          this.scheduleSearchQuery = '';
          this.scheduleSearchResults = { pickups: [], returns: [], bookingNumber: null };
        },








        // เพิ่มรายการเช่าใหม่
        addRental() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          // ตรวจสอบหมายเลขการจอง
          if (!this.newRental.หมายเลขการจอง) {
            if (this.autoGenerateBookingNumber) {
              google.script.run
                .withSuccessHandler(bookingNumber => {
                  this.newRental.หมายเลขการจอง = bookingNumber;
                  this.continueAddRental();
                })
                .withFailureHandler(error => {
                  this.showNotification('ไม่สามารถสร้างหมายเลขการจองได้: ' + error, 'error');
                  this.isLoading = false;
                })
                .generateBookingNumber(sheetID);
            } else {
              this.showNotification('กรุณาระบุหมายเลขการจอง', 'error');
              this.isLoading = false;
            }
          } else {
            this.continueAddRental();
          }
        },

        // ดำเนินการเพิ่มรายการเช่าต่อจากการตรวจสอบหมายเลขการจอง

        // continueAddRental() {
        //   // สร้างรายการสำหรับตารางรับส่งรถ
        //   const pickupSchedule = {
        //     หมายเลขการจอง: this.newRental.หมายเลขการจอง,
        //     วันที่: this.newRental.วันที่เช่า,
        //     เวลา: this.newRental.เวลารับรถ,
        //     ชื่อลูกค้า: this.newRental.ชื่อลูกค้า,
        //     รถ: this.newRental.รถ,
        //     ประเภท: 'รับรถ',
        //     หมายเหตุ: this.newRental.หมายเหตุ
        //   };

        //   const returnSchedule = {
        //     หมายเลขการจอง: this.newRental.หมายเลขการจอง,
        //     วันที่: this.newRental.วันที่คืน,
        //     เวลา: this.newRental.เวลาคืนรถ,
        //     ชื่อลูกค้า: this.newRental.ชื่อลูกค้า,
        //     รถ: this.newRental.รถ,
        //     ประเภท: 'ส่งคืนรถ',
        //     หมายเหตุ: this.newRental.หมายเหตุ
        //   };

        //   // เพิ่มรายการเช่า
        //   this.isLoading = false; // ปิดการแสดง Loading ทั่วไป
        //   this.isContractGenerating = true; // เปิดการแสดง Loading เฉพาะสัญญา
        //   this.contractLoadingStep = "กำลังบันทึกข้อมูลการเช่า";
        //   this.contractLoadingProgress = 20;
        //   const sheetID = localStorage.getItem('sheetID') || '';

        //   google.script.run
        //     .withSuccessHandler(result => {
        //       if (result.success) {
        //         // ตรวจสอบว่าผู้ใช้ต้องการสร้างสัญญาเช่าหรือไม่
        //         if (this.newRental.สร้างสัญญาเช่า) {
        //           // อัพเดทสถานะเป็นกำลังสร้างสัญญาเช่า
        //           this.contractLoadingStep = "กำลังสร้างสัญญาเช่า";
        //           this.contractLoadingProgress = 40;

        //           // เรียกใช้ฟังก์ชันสร้างสัญญาเช่า
        //           google.script.run
        //             .withSuccessHandler(contractResult => {
        //               if (contractResult.success) {
        //                 // อัพเดทสถานะเป็นกำลังบันทึกสัญญาเช่า
        //                 this.contractLoadingStep = "กำลังบันทึกสัญญาเช่า";
        //                 this.contractLoadingProgress = 60;

        //                 // เก็บลิงก์สัญญาเช่า
        //                 this.newRental.ลิงก์สัญญาเช่า = contractResult.pdfUrl;

        //                 // อัพเดตรายการเช่าด้วยลิงก์สัญญาเช่า
        //                 google.script.run
        //                   .withSuccessHandler(() => {
        //                     // เพิ่มขั้นตอนการสร้างกิจกรรมในปฏิทิน
        //                     this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
        //                     this.contractLoadingProgress = 70;

        //                     // สร้างกิจกรรมในปฏิทิน
        //                     google.script.run
        //                       .withSuccessHandler(calendarResult => {
        //                         if (calendarResult.success) {
        //                           // เก็บข้อมูลปฏิทิน
        //                           this.newRental.ลิงก์ปฏิทิน = calendarResult.eventUrl;
        //                           this.newRental.IDกิจกรรมปฏิทิน = calendarResult.eventId;
        //                           this.newRental.IDปฏิทิน = calendarResult.calendarId;

        //                           // อัพเดตข้อมูลปฏิทินในรายการเช่า
        //                           google.script.run
        //                             .withSuccessHandler(() => {
        //                               // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
        //                               this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                               this.contractLoadingProgress = 80;

        //                               // เพิ่มรายการในตารางรับส่งรถ
        //                               this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, calendarResult.eventUrl);
        //                             })
        //                             .withFailureHandler(error => {
        //                               console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", error);
        //                               // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
        //                               this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                               this.contractLoadingProgress = 80;

        //                               // เพิ่มรายการในตารางรับส่งรถแม้อัพเดตข้อมูลปฏิทินไม่สำเร็จ
        //                               this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, calendarResult.eventUrl);
        //                             })
        //                             .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
        //                         } else {
        //                           console.log("ไม่สามารถสร้างกิจกรรมในปฏิทินได้:", calendarResult.message);
        //                           // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
        //                           this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                           this.contractLoadingProgress = 80;

        //                           // เพิ่มรายการในตารางรับส่งรถแม้สร้างกิจกรรมปฏิทินไม่สำเร็จ
        //                           this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
        //                         }
        //                       })
        //                       .withFailureHandler(error => {
        //                         console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
        //                         // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
        //                         this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                         this.contractLoadingProgress = 80;

        //                         // เพิ่มรายการในตารางรับส่งรถแม้สร้างกิจกรรมปฏิทินไม่สำเร็จ
        //                         this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
        //                       })
        //                       .createCalendarEventForRental(this.newRental, sheetID);
        //                   })
        //                   .withFailureHandler(error => {
        //                     console.error("อัพเดตลิงก์สัญญาเช่าไม่สำเร็จ:", error);
        //                     // เพิ่มขั้นตอนการสร้างกิจกรรมในปฏิทิน แม้อัพเดตลิงก์สัญญาเช่าไม่สำเร็จ
        //                     this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
        //                     this.contractLoadingProgress = 70;

        //                     google.script.run
        //                       .withSuccessHandler(calendarResult => {
        //                         if (calendarResult.success) {
        //                           // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
        //                           this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                           this.contractLoadingProgress = 80;

        //                           // เพิ่มรายการในตารางรับส่งรถ
        //                           this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, calendarResult.eventUrl);
        //                         } else {
        //                           // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
        //                           this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                           this.contractLoadingProgress = 80;

        //                           // เพิ่มรายการในตารางรับส่งรถ
        //                           this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
        //                         }
        //                       })
        //                       .withFailureHandler(error => {
        //                         console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
        //                         // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
        //                         this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                         this.contractLoadingProgress = 80;

        //                         // เพิ่มรายการในตารางรับส่งรถแม้สร้างกิจกรรมปฏิทินไม่สำเร็จ
        //                         this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
        //                       })
        //                       .createCalendarEventForRental(this.newRental, sheetID);
        //                   })
        //                   .updateRentalContract(this.newRental.หมายเลขการจอง, contractResult.pdfUrl, sheetID);
        //               } else {
        //                 // สร้างสัญญาเช่าไม่สำเร็จ แต่รายการเช่าถูกสร้างเรียบร้อยแล้ว
        //                 this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
        //                 this.contractLoadingProgress = 70;

        //                 // สร้างกิจกรรมในปฏิทิน แม้สร้างสัญญาเช่าไม่สำเร็จ
        //                 google.script.run
        //                   .withSuccessHandler(calendarResult => {
        //                     if (calendarResult.success) {
        //                       // อัพเดตข้อมูลปฏิทินในรายการเช่า
        //                       google.script.run
        //                         .withSuccessHandler(() => {
        //                           this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                           this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
        //                           this.addScheduleItems(pickupSchedule, returnSchedule);
        //                         })
        //                         .withFailureHandler(error => {
        //                           this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                           this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
        //                           this.addScheduleItems(pickupSchedule, returnSchedule);
        //                         })
        //                         .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
        //                     } else {
        //                       this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                       this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
        //                       this.addScheduleItems(pickupSchedule, returnSchedule);
        //                     }
        //                   })
        //                   .withFailureHandler(error => {
        //                     this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                     this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
        //                     this.addScheduleItems(pickupSchedule, returnSchedule);
        //                   })
        //                   .createCalendarEventForRental(this.newRental, sheetID);
        //               }
        //             })
        //             .withFailureHandler(error => {
        //               // สร้างกิจกรรมในปฏิทิน แม้สร้างสัญญาเช่าไม่สำเร็จ
        //               this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
        //               this.contractLoadingProgress = 70;

        //               google.script.run
        //                 .withSuccessHandler(calendarResult => {
        //                   if (calendarResult.success) {
        //                     // อัพเดตข้อมูลปฏิทินในรายการเช่า
        //                     google.script.run
        //                       .withSuccessHandler(() => {
        //                         this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                         this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
        //                         this.addScheduleItems(pickupSchedule, returnSchedule);
        //                       })
        //                       .withFailureHandler(updateError => {
        //                         this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                         this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
        //                         this.addScheduleItems(pickupSchedule, returnSchedule);
        //                       })
        //                       .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
        //                   } else {
        //                     this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                     this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
        //                     this.addScheduleItems(pickupSchedule, returnSchedule);
        //                   }
        //                 })
        //                 .withFailureHandler(calendarError => {
        //                   this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                   this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
        //                   this.addScheduleItems(pickupSchedule, returnSchedule);
        //                 })
        //                 .createCalendarEventForRental(this.newRental, sheetID);
        //             })
        //             .generateRentalContract(this.newRental.หมายเลขการจอง, this.newRental.ภาษาสัญญาเช่า, sheetID);
        //         } else {
        //           // กรณีไม่ต้องการสร้างสัญญาเช่า
        //           // เพิ่มขั้นตอนสร้างกิจกรรมในปฏิทิน
        //           this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
        //           this.contractLoadingProgress = 70;

        //           google.script.run
        //             .withSuccessHandler(calendarResult => {
        //               if (calendarResult.success) {
        //                 // เก็บข้อมูลกิจกรรมปฏิทิน
        //                 this.newRental.ลิงก์ปฏิทิน = calendarResult.eventUrl;
        //                 this.newRental.IDกิจกรรมปฏิทิน = calendarResult.eventId;
        //                 this.newRental.IDปฏิทิน = calendarResult.calendarId;

        //                 // อัพเดตรายการเช่าด้วยข้อมูลปฏิทิน
        //                 google.script.run
        //                   .withSuccessHandler(() => {
        //                     this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
        //                     this.contractLoadingProgress = 80;

        //                     // เพิ่มรายการในตารางรับส่งรถต่อไป
        //                     google.script.run
        //                       .withSuccessHandler(() => {
        //                         google.script.run
        //                           .withSuccessHandler(() => {
        //                             this.contractLoadingProgress = 100;
        //                             this.contractLoadingStep = "เสร็จสิ้น";

        //                             setTimeout(() => {
        //                               this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา

        //                               // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
        //                               this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

        //                               // แสดง Modal สำเร็จแทนการรีเซ็ตฟอร์มอัตโนมัติ
        //                               this.showRentalSuccessModal = true;
        //                               // this.loadRentals();
        //                             }, 500);
        //                           })
        //                           .withFailureHandler(error => {
        //                             this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                             this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'error');

        //                             // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
        //                             this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

        //                             // แสดง Modal สำเร็จแทนการรีเซ็ตฟอร์มอัตโนมัติ
        //                             this.showRentalSuccessModal = true;
        //                             // this.loadRentals();
        //                           })
        //                           .addScheduleItem(returnSchedule, sheetID);
        //                       })
        //                       .withFailureHandler(error => {
        //                         this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                         this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'error');

        //                         // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
        //                         this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

        //                         // แสดง Modal สำเร็จแทนการรีเซ็ตฟอร์มอัตโนมัติ
        //                         this.showRentalSuccessModal = true;
        //                         // this.loadRentals();
        //                       })
        //                       .addScheduleItem(pickupSchedule, sheetID);
        //                   })
        //                   .withFailureHandler(error => {
        //                     console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", error);
        //                     this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                     this.addScheduleItems(pickupSchedule, returnSchedule);
        //                   })
        //                   .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
        //               } else {
        //                 console.log("ไม่สามารถสร้างกิจกรรมในปฏิทินได้:", calendarResult.message);
        //                 this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //                 this.addScheduleItems(pickupSchedule, returnSchedule);
        //               }
        //             })
        //             .withFailureHandler(error => {
        //               console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
        //               this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //               this.addScheduleItems(pickupSchedule, returnSchedule);
        //             })
        //             .createCalendarEventForRental(this.newRental, sheetID);
        //         }
        //       } else {
        //         this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //         this.showNotification('เพิ่มรายการเช่าไม่สำเร็จ: ' + result.message, 'error');
        //       }
        //     })
        //     .withFailureHandler(error => {
        //       this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
        //       this.showNotification('เพิ่มรายการเช่าไม่สำเร็จ: ' + error, 'error');
        //     })
        //     .addNewRental(this.newRental, sheetID);
        // },



        async continueAddRental() {
          try {
            console.log('🚀 เริ่มต้นการบันทึกรายการเช่า');

            const sheetID = localStorage.getItem('sheetID') || '';

            // 🚦 เช็คว่ากำลังสร้างรายการอยู่หรือไม่
            const flagCheckResult = await new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .setRentalCreationFlag(sheetID, 'web');
            });

            if (!flagCheckResult) {
              // มี flag อยู่แล้ว - มีคนกำลังสร้างรายการอยู่
              this.showNotification('⏳ กำลังสร้างรายการเช่าอยู่\n\nกรุณารอสักครู่แล้วลองใหม่อีกครั้ง', 'warning');
              return;
            }

            // สร้างรายการสำหรับตารางรับส่งรถ (เหมือนเดิม)
            const pickupSchedule = {
              หมายเลขการจอง: this.newRental.หมายเลขการจอง,
              วันที่: this.newRental.วันที่เช่า,
              เวลา: this.newRental.เวลารับรถ,
              ชื่อลูกค้า: this.newRental.ชื่อลูกค้า,
              รถ: this.newRental.รถ,
              ประเภท: 'รับรถ',
              หมายเหตุ: this.newRental.หมายเหตุ
            };

            const returnSchedule = {
              หมายเลขการจอง: this.newRental.หมายเลขการจอง,
              วันที่: this.newRental.วันที่คืน,
              เวลา: this.newRental.เวลาคืนรถ,
              ชื่อลูกค้า: this.newRental.ชื่อลูกค้า,
              รถ: this.newRental.รถ,
              ประเภท: 'ส่งคืนรถ',
              หมายเหตุ: this.newRental.หมายเหตุ
            };

            // 🔥 เพิ่มส่วนใหม่ - แปลงรูปภาพเป็น base64
            console.log('📷 เริ่มแปลงรูปภาพเป็น base64...');
            const rentalDataWithImages = { ...this.newRental };
            // ใช้ Net Total (รวมภาษี) สำหรับบันทึก แต่หน้าจอยังแสดง Base Amount
            if (this.newRental.netTotal) {
              rentalDataWithImages.ค่าเช่ารวมทั้งหมด = this.newRental.netTotal;
            }
            rentalDataWithImages.images = {};

            // รายการไฟล์รูปภาพที่ต้องประมวลผล
            const imageFiles = [
              { key: 'idCard', file: this.newRental.idCardFile, name: 'บัตรประชาชน' },
              { key: 'drivingLicense', file: this.newRental.drivingLicenseFile, name: 'ใบขับขี่' },
              { key: 'doc1', file: this.newRental.doc1File, name: 'เอกสารเพิ่มเติม 1' },
              { key: 'doc2', file: this.newRental.doc2File, name: 'เอกสารเพิ่มเติม 2' },
              { key: 'doc3', file: this.newRental.doc3File, name: 'เอกสารเพิ่มเติม 3' }
            ];

            let imageCount = 0;
            // ประมวลผลไฟล์รูปภาพแต่ละไฟล์
            for (const { key, file, name } of imageFiles) {
              if (file) {
                try {
                  // ตรวจสอบขนาดไฟล์ (ไม่เกิน 5MB)
                  if (file.size > 5 * 1024 * 1024) {
                    console.warn(`⚠️ ไฟล์ ${name} มีขนาดใหญ่เกินไป: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                    this.showNotification(`ไฟล์ ${name} มีขนาดใหญ่เกินไป (เกิน 5MB)`, 'warning');
                    continue; // ข้ามไฟล์นี้
                  }

                  // แปลงไฟล์เป็น base64
                  const base64String = await this.fileToBase64(file);
                  const base64Data = base64String.split(',')[1]; // แยกเฉพาะส่วน base64

                  rentalDataWithImages.images[key] = {
                    base64: base64Data,
                    name: file.name,
                    type: file.type // เพิ่มบรรทัดนี้เข้าไป
                  };

                  imageCount++;
                  console.log(`✅ แปลง ${name} เป็น base64 สำเร็จ: ${file.name}`);
                } catch (error) {
                  console.error(`❌ แปลง ${name} ไม่สำเร็จ:`, error);
                  this.showNotification(`แปลงไฟล์ ${name} ไม่สำเร็จ: ${error}`, 'warning');
                }
              }
            }

            console.log(`📊 แปลงรูปภาพเสร็จ: ${imageCount} ไฟล์`);

            // ลบข้อมูลไฟล์ที่ไม่จำเป็นออกก่อนส่งไป backend
            delete rentalDataWithImages.idCardFile;
            delete rentalDataWithImages.drivingLicenseFile;
            delete rentalDataWithImages.doc1File;
            delete rentalDataWithImages.doc2File;
            delete rentalDataWithImages.doc3File;
            delete rentalDataWithImages.idCardPreviewUrl;
            delete rentalDataWithImages.drivingLicensePreviewUrl;
            delete rentalDataWithImages.doc1PreviewUrl;
            delete rentalDataWithImages.doc2PreviewUrl;
            delete rentalDataWithImages.doc3PreviewUrl;

            console.log('📦 ข้อมูลที่จะส่งไป backend:', {
              ...rentalDataWithImages,
              images: Object.keys(rentalDataWithImages.images || {})
            });
            // 🔥 จบส่วนใหม่

            // เริ่มกระบวนการบันทึกข้อมูล (เหมือนเดิม)
            this.isLoading = false; // ปิดการแสดง Loading ทั่วไป
            this.isContractGenerating = true; // เปิดการแสดง Loading เฉพาะสัญญา
            this.contractLoadingStep = "กำลังบันทึกข้อมูลการเช่า";
            this.contractLoadingProgress = 20;
            // sheetID ถูก declare ไว้ที่บรรทัดบนแล้ว

            // 🔥 เปลี่ยนจาก this.newRental เป็น rentalDataWithImages
            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  // ตรวจสอบว่าผู้ใช้ต้องการสร้างสัญญาเช่าหรือไม่
                  if (this.newRental.สร้างสัญญาเช่า) {
                    // อัพเดทสถานะเป็นกำลังสร้างสัญญาเช่า
                    this.contractLoadingStep = "กำลังสร้างสัญญาเช่า";
                    this.contractLoadingProgress = 40;

                    // เรียกใช้ฟังก์ชันสร้างสัญญาเช่า
                    google.script.run
                      .withSuccessHandler(contractResult => {
                        if (contractResult.success) {
                          // อัพเดทสถานะเป็นกำลังบันทึกสัญญาเช่า
                          this.contractLoadingStep = "กำลังบันทึกสัญญาเช่า";
                          this.contractLoadingProgress = 60;

                          // เก็บลิงก์สัญญาเช่า
                          this.newRental.ลิงก์สัญญาเช่า = contractResult.pdfUrl;

                          // อัพเดตรายการเช่าด้วยลิงก์สัญญาเช่า
                          google.script.run
                            .withSuccessHandler(() => {
                              // เพิ่มขั้นตอนการสร้างกิจกรรมในปฏิทิน
                              this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
                              this.contractLoadingProgress = 70;

                              // ✅ สร้าง object ที่มีลิงก์สัญญาเช่าสำหรับปฏิทิน
                              const rentalDataForCalendar = { ...rentalDataWithImages };
                              rentalDataForCalendar.ลิงก์สัญญาเช่า = contractResult.pdfUrl;

                              // สร้างกิจกรรมในปฏิทิน
                              google.script.run
                                .withSuccessHandler(calendarResult => {
                                  if (calendarResult.success) {
                                    // เก็บข้อมูลปฏิทิน
                                    this.newRental.ลิงก์ปฏิทิน = calendarResult.eventUrl;
                                    this.newRental.IDกิจกรรมปฏิทิน = calendarResult.eventId;
                                    this.newRental.IDปฏิทิน = calendarResult.calendarId;

                                    // อัพเดตข้อมูลปฏิทินในรายการเช่า
                                    google.script.run
                                      .withSuccessHandler(() => {
                                        // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
                                        this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                                        this.contractLoadingProgress = 80;

                                        // เพิ่มรายการในตารางรับส่งรถ
                                        this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, calendarResult.eventUrl);
                                      })
                                      .withFailureHandler(error => {
                                        console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", error);
                                        // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
                                        this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                                        this.contractLoadingProgress = 80;

                                        // เพิ่มรายการในตารางรับส่งรถแม้อัพเดตข้อมูลปฏิทินไม่สำเร็จ
                                        this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, calendarResult.eventUrl);
                                      })
                                      .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                                  } else {
                                    console.log("ไม่สามารถสร้างกิจกรรมในปฏิทินได้:", calendarResult.message);
                                    // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
                                    this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                                    this.contractLoadingProgress = 80;

                                    // เพิ่มรายการในตารางรับส่งรถแม้สร้างกิจกรรมปฏิทินไม่สำเร็จ
                                    this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
                                  }
                                })
                                .withFailureHandler(error => {
                                  console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
                                  // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
                                  this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                                  this.contractLoadingProgress = 80;

                                  // เพิ่มรายการในตารางรับส่งรถแม้สร้างกิจกรรมปฏิทินไม่สำเร็จ
                                  this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
                                })
                                .createCalendarEventForRental(rentalDataForCalendar, sheetID); // ✅ ใช้ object ที่มีลิงก์สัญญาเช่า
                            })
                            .withFailureHandler(error => {
                              console.error("อัพเดตลิงก์สัญญาเช่าไม่สำเร็จ:", error);
                              // เพิ่มขั้นตอนการสร้างกิจกรรมในปฏิทิน แม้อัพเดตลิงก์สัญญาเช่าไม่สำเร็จ
                              this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
                              this.contractLoadingProgress = 70;

                              // ✅ สร้าง object ที่มีลิงก์สัญญาเช่าสำหรับปฏิทิน (กรณีอัพเดตไม่สำเร็จ)
                              const rentalDataForCalendar = { ...rentalDataWithImages };
                              rentalDataForCalendar.ลิงก์สัญญาเช่า = contractResult.pdfUrl;

                              google.script.run
                                .withSuccessHandler(calendarResult => {
                                  if (calendarResult.success) {
                                    // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
                                    this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                                    this.contractLoadingProgress = 80;

                                    // เพิ่มรายการในตารางรับส่งรถ
                                    this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, calendarResult.eventUrl);
                                  } else {
                                    // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
                                    this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                                    this.contractLoadingProgress = 80;

                                    // เพิ่มรายการในตารางรับส่งรถ
                                    this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
                                  }
                                })
                                .withFailureHandler(error => {
                                  console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
                                  // อัพเดทสถานะเป็นกำลังเพิ่มรายการในตารางรับส่งรถ
                                  this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                                  this.contractLoadingProgress = 80;

                                  // เพิ่มรายการในตารางรับส่งรถแม้สร้างกิจกรรมปฏิทินไม่สำเร็จ
                                  this.addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractResult.pdfUrl, null);
                                })
                                .createCalendarEventForRental(rentalDataForCalendar, sheetID); // ✅ ใช้ object ที่มีลิงก์สัญญาเช่า
                            })
                            .updateRentalContract(this.newRental.หมายเลขการจอง, contractResult.pdfUrl, sheetID);
                        } else {
                          // สร้างสัญญาเช่าไม่สำเร็จ แต่รายการเช่าถูกสร้างเรียบร้อยแล้ว
                          this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
                          this.contractLoadingProgress = 70;

                          // สร้างกิจกรรมในปฏิทิน แม้สร้างสัญญาเช่าไม่สำเร็จ (ไม่มีลิงก์สัญญาเช่า)
                          google.script.run
                            .withSuccessHandler(calendarResult => {
                              if (calendarResult.success) {
                                // อัพเดตข้อมูลปฏิทินในรายการเช่า
                                google.script.run
                                  .withSuccessHandler(() => {
                                    this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                                    this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                                    this.addScheduleItems(pickupSchedule, returnSchedule);
                                  })
                                  .withFailureHandler(error => {
                                    this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                                    this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                                    this.addScheduleItems(pickupSchedule, returnSchedule);
                                  })
                                  .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                              } else {
                                this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                                this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                                this.addScheduleItems(pickupSchedule, returnSchedule);
                              }
                            })
                            .withFailureHandler(error => {
                              this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                              this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                              this.addScheduleItems(pickupSchedule, returnSchedule);
                            })
                            .createCalendarEventForRental(rentalDataWithImages, sheetID); // ✅ ไม่มีลิงก์สัญญาเช่า ใช้ตัวเดิมได้
                        }
                      })
                      .withFailureHandler(error => {
                        // สร้างกิจกรรมในปฏิทิน แม้สร้างสัญญาเช่าไม่สำเร็จ
                        this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
                        this.contractLoadingProgress = 70;

                        google.script.run
                          .withSuccessHandler(calendarResult => {
                            if (calendarResult.success) {
                              // อัพเดตข้อมูลปฏิทินในรายการเช่า
                              google.script.run
                                .withSuccessHandler(() => {
                                  this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                                  this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                                  this.addScheduleItems(pickupSchedule, returnSchedule);
                                })
                                .withFailureHandler(updateError => {
                                  this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                                  this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                                  this.addScheduleItems(pickupSchedule, returnSchedule);
                                })
                                .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                            } else {
                              this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                              this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                              this.addScheduleItems(pickupSchedule, returnSchedule);
                            }
                          })
                          .withFailureHandler(calendarError => {
                            this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                            this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                            this.addScheduleItems(pickupSchedule, returnSchedule);
                          })
                          .createCalendarEventForRental(rentalDataWithImages, sheetID); // ✅ ไม่มีลิงก์สัญญาเช่า ใช้ตัวเดิมได้
                      })
                      .generateRentalContract(this.newRental.หมายเลขการจอง, this.newRental.ภาษาสัญญาเช่า, sheetID);
                  } else {
                    // กรณีไม่ต้องการสร้างสัญญาเช่า
                    // เพิ่มขั้นตอนสร้างกิจกรรมในปฏิทิน
                    this.contractLoadingStep = "กำลังเพิ่มรายการในปฏิทิน";
                    this.contractLoadingProgress = 70;

                    google.script.run
                      .withSuccessHandler(calendarResult => {
                        if (calendarResult.success) {
                          // เก็บข้อมูลกิจกรรมปฏิทิน
                          this.newRental.ลิงก์ปฏิทิน = calendarResult.eventUrl;
                          this.newRental.IDกิจกรรมปฏิทิน = calendarResult.eventId;
                          this.newRental.IDปฏิทิน = calendarResult.calendarId;

                          // อัพเดตรายการเช่าด้วยข้อมูลปฏิทิน
                          google.script.run
                            .withSuccessHandler(() => {
                              this.contractLoadingStep = "กำลังอัพเดทตารางรับส่งรถ";
                              this.contractLoadingProgress = 80;

                              // เพิ่มรายการในตารางรับส่งรถต่อไป
                              google.script.run
                                .withSuccessHandler(() => {
                                  google.script.run
                                    .withSuccessHandler(() => {
                                      this.contractLoadingProgress = 100;
                                      this.contractLoadingStep = "เสร็จสิ้น";

                                      setTimeout(() => {
                                        this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา

                                        // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
                                        this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

                                        // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
                                        this.updateRecentRentalsCache();
                                        this.loadRecentRentals(true); // force refresh

                                        // 🚦 ลบ flag เมื่อสร้างสำเร็จ
                                        google.script.run.clearRentalCreationFlag(sheetID);

                                        // แสดง Modal สำเร็จแทนการรีเซ็ตฟอร์มอัตโนมัติ
                                        this.showRentalSuccessModal = true;
                                        // this.loadRentals();
                                      }, 500);
                                    })
                                    .withFailureHandler(error => {
                                      this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                                      this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'error');

                                      // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
                                      this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

                                      // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
                                      this.updateRecentRentalsCache();
                                      this.loadRecentRentals(true);

                                      // 🚦 ลบ flag เมื่อสร้างสำเร็จ
                                      google.script.run.clearRentalCreationFlag(sheetID);

                                      // แสดง Modal สำเร็จแทนการรีเซ็ตฟอร์มอัตโนมัติ
                                      this.showRentalSuccessModal = true;
                                      // this.loadRentals();
                                    })
                                    .addScheduleItem(returnSchedule, sheetID);
                                })
                                .withFailureHandler(error => {
                                  this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                                  this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'error');

                                  // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
                                  this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

                                  // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
                                  this.updateRecentRentalsCache();
                                  this.loadRecentRentals(true);

                                  // แสดง Modal สำเร็จแทนการรีเซ็ตฟอร์มอัตโนมัติ
                                  this.showRentalSuccessModal = true;
                                  // this.loadRentals();
                                })
                                .addScheduleItem(pickupSchedule, sheetID);
                            })
                            .withFailureHandler(error => {
                              console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", error);
                              this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                              this.addScheduleItems(pickupSchedule, returnSchedule);
                            })
                            .updateRentalCalendarInfo(this.newRental.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                        } else {
                          console.log("ไม่สามารถสร้างกิจกรรมในปฏิทินได้:", calendarResult.message);
                          this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                          this.addScheduleItems(pickupSchedule, returnSchedule);
                        }
                      })
                      .withFailureHandler(error => {
                        console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
                        this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                        this.addScheduleItems(pickupSchedule, returnSchedule);
                      })
                      .createCalendarEventForRental(rentalDataWithImages, sheetID); // ✅ ไม่มีลิงก์สัญญาเช่า ใช้ตัวเดิมได้
                  }
                } else {
                  // 🚦 ลบ flag เมื่อสร้างไม่สำเร็จ
                  google.script.run.clearRentalCreationFlag(sheetID);

                  this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                  this.showNotification('เพิ่มรายการเช่าไม่สำเร็จ: ' + result.message, 'error');
                }
              })
              .withFailureHandler(error => {
                // 🚦 ลบ flag เมื่อเกิด error
                google.script.run.clearRentalCreationFlag(sheetID);

                this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา
                this.showNotification('เพิ่มรายการเช่าไม่สำเร็จ: ' + error, 'error');
              })
              .addNewRental(rentalDataWithImages, sheetID); // 🔥 เปลี่ยนจาก this.newRental เป็น rentalDataWithImages

          } catch (error) {
            // 🚦 ลบ flag เมื่อเกิด error
            google.script.run
              .withSuccessHandler(() => console.log('Flag cleared after error'))
              .withFailureHandler(err => console.error('Failed to clear flag:', err))
              .clearRentalCreationFlag(sheetID);

            // 🔥 เพิ่ม error handling สำหรับส่วนการแปลงรูปภาพ
            console.error('💥 Error in continueAddRental:', error);
            this.isLoading = false;
            this.isContractGenerating = false;
            this.showNotification('เกิดข้อผิดพลาดในการเตรียมข้อมูล: ' + error, 'error');
          }
        },











        // addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractUrl) {
        //   this.contractLoadingStep = "กำลังบันทึกรายการรับรถ";
        //   this.contractLoadingProgress = 85;
        //   const sheetID = localStorage.getItem('sheetID') || '';

        //   google.script.run
        //     .withSuccessHandler(() => {
        //       this.contractLoadingStep = "กำลังบันทึกรายการคืนรถ";
        //       this.contractLoadingProgress = 95;

        //       google.script.run
        //         .withSuccessHandler(() => {
        //           this.contractLoadingStep = "เสร็จสิ้น";
        //           this.contractLoadingProgress = 100;

        //           // หน่วงเวลาสักครู่ก่อนปิดหน้า Loading เพื่อให้ผู้ใช้เห็นว่าทำงานเสร็จแล้ว
        //           setTimeout(() => {
        //             this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา

        //             // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
        //             this.successRentalData = JSON.parse(JSON.stringify(this.newRental));
        //             this.successRentalData.ลิงก์สัญญาเช่า = contractUrl;

        //             // แสดง Modal สำเร็จ
        //             this.showRentalSuccessModal = true;

        //             // === จุดที่แก้ไขที่ 1 ===
        //             this.loadRentals(success => {
        //                 if (success) this.fetchScheduleForDate();
        //             });
        //             // =======================

        //             // สร้างข้อมูลสรุปอัตโนมัติ (หากต้องการใช้ในอนาคต)
        //             // this.generateSummary();
        //           }, 500);
        //         })
        //         .withFailureHandler(error => {
        //           this.isContractGenerating = false;
        //           this.showNotification('เพิ่มรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'warning');

        //           this.successRentalData = JSON.parse(JSON.stringify(this.newRental));
        //           this.successRentalData.ลิงก์สัญญาเช่า = contractUrl;

        //           this.showRentalSuccessModal = true;

        //           // === จุดที่แก้ไขที่ 2 ===
        //           this.loadRentals(success => {
        //               if (success) this.fetchScheduleForDate();
        //           });
        //           // =======================
        //         })
        //         .addScheduleItem(returnSchedule, sheetID);
        //     })
        //     .withFailureHandler(error => {
        //       this.isContractGenerating = false;
        //       this.showNotification('เพิ่มรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'warning');

        //       this.successRentalData = JSON.parse(JSON.stringify(this.newRental));
        //       this.successRentalData.ลิงก์สัญญาเช่า = contractUrl;

        //       this.showRentalSuccessModal = true;

        //       // === จุดที่แก้ไขที่ 3 ===
        //       this.loadRentals(success => {
        //           if (success) this.fetchScheduleForDate();
        //       });
        //       // =======================
        //     })
        //     .addScheduleItem(pickupSchedule, sheetID);
        // },



        addScheduleItemsAfterContract(pickupSchedule, returnSchedule, contractUrl) {
          this.contractLoadingStep = "กำลังบันทึกรายการรับรถ";
          this.contractLoadingProgress = 85;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(() => {
              this.contractLoadingStep = "กำลังบันทึกรายการคืนรถ";
              this.contractLoadingProgress = 95;

              google.script.run
                .withSuccessHandler(() => {
                  this.contractLoadingStep = "เสร็จสิ้น";
                  this.contractLoadingProgress = 100;

                  // หน่วงเวลาสักครู่ก่อนปิดหน้า Loading เพื่อให้ผู้ใช้เห็นว่าทำงานเสร็จแล้ว
                  setTimeout(() => {
                    this.isContractGenerating = false; // ปิดการแสดง Loading เฉพาะสัญญา

                    // เก็บข้อมูลรายการเช่าสำหรับแสดงใน Modal
                    this.successRentalData = JSON.parse(JSON.stringify(this.newRental));
                    this.successRentalData.ลิงก์สัญญาเช่า = contractUrl;

                    // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
                    this.updateRecentRentalsCache();
                    this.loadRecentRentals(true);

                    // แสดง Modal สำเร็จ
                    this.showRentalSuccessModal = true;

                    // === ลบการโหลดข้อมูลออก - ข้ามขั้นตอนนี้ ===
                    // this.loadRentals(success => {
                    //     if (success) this.fetchScheduleForDate();
                    // });
                    // ==============================================

                    // สร้างข้อมูลสรุปอัตโนมัติ (หากต้องการใช้ในอนาคต)
                    // this.generateSummary();
                  }, 500);
                })
                .withFailureHandler(error => {
                  this.isContractGenerating = false;
                  this.showNotification('เพิ่มรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'warning');

                  this.successRentalData = JSON.parse(JSON.stringify(this.newRental));
                  this.successRentalData.ลิงก์สัญญาเช่า = contractUrl;

                  // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
                  this.updateRecentRentalsCache();
                  this.loadRecentRentals(true);

                  this.showRentalSuccessModal = true;

                  // === ลบการโหลดข้อมูลออก - ข้ามขั้นตอนนี้ ===
                  // this.loadRentals(success => {
                  //     if (success) this.fetchScheduleForDate();
                  // });
                  // ==============================================
                })
                .addScheduleItem(returnSchedule, sheetID);
            })
            .withFailureHandler(error => {
              this.isContractGenerating = false;
              this.showNotification('เพิ่มรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'warning');

              this.successRentalData = JSON.parse(JSON.stringify(this.newRental));
              this.successRentalData.ลิงก์สัญญาเช่า = contractUrl;

              // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
              this.updateRecentRentalsCache();
              this.loadRecentRentals(true);

              this.showRentalSuccessModal = true;

              // === ลบการโหลดข้อมูลออก - ข้ามขั้นตอนนี้ ===
              // this.loadRentals(success => {
              //     if (success) this.fetchScheduleForDate();
              // });
              // ==============================================
            })
            .addScheduleItem(pickupSchedule, sheetID);
        },



















        get todayTimelineItems() {
          if (!this.todayPickups || !this.todayReturns) return [];

          // รวมรายการรับและคืนรถ
          const allItems = [
            ...this.todayPickups.map(item => ({ ...item, ประเภท: 'รับรถ' })),
            ...this.todayReturns.map(item => ({ ...item, ประเภท: 'ส่งคืนรถ' }))
          ];

          // เรียงลำดับตามเวลา
          return allItems.sort((a, b) => {
            const timeA = a.เวลา || '00:00';
            const timeB = b.เวลา || '00:00';
            return timeA.localeCompare(timeB);
          });
        },

        // จัดกลุ่มรายการตามช่วงเวลา สำหรับมุมมอง compact
        get groupedTimelineItems() {
          const items = this.todayTimelineItems;
          const grouped = {};

          items.forEach(item => {
            const time = item.เวลา || '00:00';
            const type = item.ประเภท;
            const key = `${time}-${type}`;

            if (!grouped[key]) {
              grouped[key] = {
                time: time,
                type: type,
                count: 0,
                items: []
              };
            }
            grouped[key].count++;
            grouped[key].items.push(item);
          });

          // แปลงเป็น array และเรียงตามเวลา
          return Object.values(grouped).sort((a, b) => a.time.localeCompare(b.time));
        },

        // ฟังก์ชันสำหรับ render กราฟทั้งหมดในหน้า Summary (ตัดส่วนการเงินออก)
        renderSummaryCharts() {
          this.renderSummaryCarStatusChart();
        },

        // ฟังก์ชันสำหรับ render กราฟสถานะรถ
        // (แก้ไขฟังก์ชัน renderSummaryCarStatusChart เดิม)

        renderSummaryCarStatusChart() {
          const chartEl = document.getElementById('summaryCarStatusChart');
          if (!chartEl) return;

          if (this.summaryCarStatusChartInstance) {
            this.summaryCarStatusChartInstance.destroy();
          }

          const unavailableCount = (this.rentalStats.totalCars || 0) - (this.rentalStats.inProgress || 0) - (this.rentalStats.availableCars || 0);

          const options = {
            series: [this.rentalStats.availableCars || 0, this.rentalStats.inProgress || 0, unavailableCount > 0 ? unavailableCount : 0],
            chart: {
              type: 'donut',
              height: 250,
              sparkline: { enabled: true } // ทำให้กราฟกระทัดรัดขึ้น
            },
            labels: ['ว่าง', 'กำลังให้เช่า', 'ไม่พร้อมใช้งาน'],
            colors: ['#22c55e', '#f59e0b', '#9ca3af'], // เขียว, ส้ม, เทา
            stroke: { width: 0 }, // ไม่มีเส้นขอบ
            legend: { show: false }, // <--- ซ่อน Legend ของกราฟ
            tooltip: {
              y: {
                formatter: function (val) {
                  return val + " คัน"
                }
              }
            }
          };

          this.summaryCarStatusChartInstance = new ApexCharts(chartEl, options);
          this.summaryCarStatusChartInstance.render();
        },








        // เมธอดที่มีอยู่แล้ว สำหรับกรณีไม่มีการสร้างสัญญาเช่า
        addScheduleItems(pickupSchedule, returnSchedule) {
          this.contractLoadingStep = "กำลังอัพเดทตารางรับรถ";
          this.contractLoadingProgress = 80;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(() => {
              this.contractLoadingStep = "กำลังอัพเดทตารางคืนรถ";
              this.contractLoadingProgress = 90;

              google.script.run
                .withSuccessHandler(() => {
                  this.contractLoadingProgress = 100;
                  this.contractLoadingStep = "เสร็จสิ้น";

                  setTimeout(() => {
                    this.isContractGenerating = false; // ✅ เปลี่ยนจาก isLoading

                    // ✅ เก็บข้อมูลสำหรับ Success Modal
                    this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

                    // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
                    this.updateRecentRentalsCache();
                    this.loadRecentRentals(true);

                    // ✅ แสดง Success Modal แทน showNotification
                    this.showRentalSuccessModal = true;

                    // ✅ ไม่ reset form ทันที ให้ user ปิด modal เอง
                  }, 500);
                })
                .withFailureHandler(error => {
                  this.isContractGenerating = false;
                  this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'warning');

                  // ✅ แสดง Success Modal แม้เกิดข้อผิดพลาด
                  this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

                  // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
                  this.updateRecentRentalsCache();
                  this.loadRecentRentals(true);

                  this.showRentalSuccessModal = true;
                })
                .addScheduleItem(returnSchedule, sheetID);
            })
            .withFailureHandler(error => {
              this.isContractGenerating = false;
              this.showNotification('เพิ่มรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'warning');

              // ✅ แสดง Success Modal แม้เกิดข้อผิดพลาด
              this.successRentalData = JSON.parse(JSON.stringify(this.newRental));

              // อัพเดทรายการเช่าล่าสุดทันทีหลังสร้างรายการสำเร็จ
              this.updateRecentRentalsCache();
              this.loadRecentRentals(true);

              this.showRentalSuccessModal = true;
            })
            .addScheduleItem(pickupSchedule, sheetID);
        },

        // ปิด Modal แสดงผลสำเร็จ
        closeSuccessModal() {
          this.showRentalSuccessModal = false;
          this.showSummarySection = true;
          // อัพเดทรายการเช่าล่าสุดหลังจากเพิ่มรายการใหม่สำเร็จ
          this.updateRecentRentalsCache();
          this.loadRecentRentals(true); // force refresh

          const summaryText = this.generateSummary(this.successRentalData);
          this.displaySummaryText(summaryText);

          // รอให้โมดัลปิดและข้อมูลถูกสร้างเสร็จ
          setTimeout(() => {
            // หา element ที่มี id เป็น 'rentalSummaryText'
            const textareaElement = document.getElementById('rentalSummaryText');

            if (textareaElement) {
              // เลื่อนไปที่ textarea
              textareaElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

              // ไฮไลต์ข้อความทั้งหมดใน textarea
              textareaElement.focus();
              textareaElement.select();

              // เพิ่มเอฟเฟกต์การไฮไลต์
              textareaElement.classList.add('highlight-animation');

              // ลบคลาสหลังจากผ่านไป 2 วินาที
              setTimeout(() => {
                textareaElement.classList.remove('highlight-animation');
              }, 2000);
            }
          }, 300);
        },




        resetFormAfterSuccess() {
          this.resetNewRentalForm();
          this.closeSuccessModal();
          // อัพเดทรายการเช่าล่าสุดหลังจากเพิ่มรายการใหม่สำเร็จ
          this.updateRecentRentalsCache();
          this.loadRecentRentals(true); // force refresh
        },



        // เพิ่มฟังก์ชันแปลงข้อความเป็นตัวพิมพ์ใหญ่
        convertToUppercase() {
          if (this.advancedSearchQuery) {
            // แปลงเป็นตัวพิมพ์ใหญ่แล้วกำหนดค่ากลับไป
            this.advancedSearchQuery = this.advancedSearchQuery.toUpperCase();
          }
        },



        // ล้างผลการค้นหา
        clearAdvancedSearch() {
          this.advancedSearchQuery = '';
          this.advancedSearchResults = [];
          this.isAdvancedSearchActive = false;
        },












        generateSummary(rentalData) {
          // ตรวจสอบว่ามีเทมเพลตข้อความหรือไม่
          if (!this.config.summaryMessageTemplate) {
            this.resetMessageTemplate('summaryMessage');
          }

          // กำหนดภาษาที่ใช้ - ใช้ภาษาเดียวกับสัญญาเช่า
          const language = rentalData.ภาษาสัญญาเช่า || 'th';
          console.log('this.newRental.ภาษาสัญญาเช่า:', this.newRental.ภาษาสัญญาเช่า);

          let startDate, endDate;

          // ฟังก์ชันช่วยในการแปลงวันที่
          const parseDate = (dateString, timeString) => {
            let dateObj;
            try {
              if (dateString.includes('T')) {
                // ISO format
                dateObj = new Date(dateString);
              } else if (dateString.includes('/')) {
                // dd/mm/yyyy format
                const parts = dateString.split('/');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                let year = parseInt(parts[2], 10);
                if (year < 100) {
                  year += 2000; // หรือ 1900 ขึ้นอยู่กับบริบท
                }
                dateObj = new Date(year, month, day);
              } else {
                // รูปแบบอื่น ๆ (คุณอาจต้องเพิ่มการรองรับรูปแบบอื่น ๆ ที่นี่)
                dateObj = new Date(dateString);
              }

              if (timeString && timeString.includes(':')) {
                const timeParts = timeString.split(':');
                const hours = parseInt(timeParts[0], 10);
                const minutes = parseInt(timeParts[1], 10);
                if (dateObj) {
                  dateObj.setHours(hours, minutes, 0, 0);
                }
              }

              // console.log('parseDate:', dateString, timeString, dateObj); // Log ผลลัพธ์ของ parseDate

            } catch (error) {
              console.error('Error parsing date:', dateString, timeString, error);
              return null;
            }
            return dateObj;
          };

          // แปลงวันที่
          // console.log('ข้อมูลวันที่ก่อนแปลง:', rentalData.วันที่เช่า, rentalData.วันที่คืน, rentalData.เวลารับรถ, rentalData.เวลาคืนรถ); // Log ข้อมูลวันที่ก่อนแปลง
          startDate = parseDate(rentalData.วันที่เช่า, rentalData.เวลารับรถ);
          endDate = parseDate(rentalData.วันที่คืน, rentalData.เวลาคืนรถ);

          // ตรวจสอบวันที่
          // console.log('วันที่หลังแปลง:', startDate, endDate); // Log วันที่หลังแปลง
          if (!startDate || isNaN(startDate.getTime()) || !endDate || isNaN(endDate.getTime())) {
            console.error('Invalid date(s):', startDate, endDate);
            return 'Invalid date(s) in rental data';
          }

          // คำนวณความต่างในชั่วโมง
          const diffMs = Math.abs(endDate.getTime() - startDate.getTime());
          const diffHours = diffMs / (1000 * 60 * 60);

          // คำนวณจำนวนวันเต็ม
          const diffDays = Math.floor(diffHours / 24);

          // คำนวณชั่วโมงที่เหลือ
          const remainingHours = Math.floor(diffHours % 24);

          // console.log('ผลลัพธ์การคำนวณวันที่:', { diffDays, remainingHours }); // Log ผลลัพธ์การคำนวณ

          // ดึงค่าชั่วโมงที่คิดเพิ่ม
          const extraHoursThreshold = parseFloat(this.config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน) || 4;

          // คำนวณจำนวนวันที่ต้องจ่าย
          let rentalDays = diffDays;
          if (remainingHours > extraHoursThreshold) {
            rentalDays += 1;
          }

          // ถ้าเป็นศูนย์วัน ให้นับเป็น 1 วัน
          if (rentalDays === 0) {
            rentalDays = 1;
          }

          // สร้างข้อความแสดงระยะเวลาเช่า
          let rentalPeriodText = "";

          // สร้างข้อความตามภาษา
          if (remainingHours > extraHoursThreshold) {
            rentalPeriodText = rentalDays + " " + this.translate('days', language);
          } else {
            rentalPeriodText = diffDays + " " + this.translate('days', language);
            if (remainingHours > 0) {
              rentalPeriodText += " " + remainingHours + " " + this.translate('hours', language);
            }
          }

          // สร้างข้อมูลสำหรับใช้แทนที่ placeholder
          const placeholderData = {
            "{{หมายเลขการจอง}}": rentalData.หมายเลขการจอง || "-",
            "{{ชื่อลูกค้า}}": rentalData.ชื่อลูกค้า || "-",
            "{{เบอร์โทรศัพท์}}": rentalData.เบอร์โทรศัพท์ || "-",
            "{{รถ}}": rentalData.รถ || "-",
            "{{ทะเบียนรถ}}": rentalData.ทะเบียนรถ || "-",
            "{{วันที่เช่า}}": this.formatDateForSummary(rentalData.วันที่เช่า, language) || "-",
            "{{วันที่คืน}}": this.formatDateForSummary(rentalData.วันที่คืน, language) || "-",
            "{{จำนวนวัน}}": rentalPeriodText || "1 " + this.translate('days', language),
            "{{เวลารับรถ}}": rentalData.เวลารับรถ || "-",
            "{{เวลาคืนรถ}}": rentalData.เวลาคืนรถ || "-",
            "{{สถานที่รับรถ}}": rentalData.สถานที่รับรถ || "-",
            "{{สถานที่คืนรถ}}": rentalData.สถานที่คืนรถ || "-",
            "{{ราคาต่อวัน}}": this.formatCurrencyForSummary(rentalData.ราคา, language) || "-",
            "{{ค่าเช่ารวมทั้งหมด}}": this.formatCurrencyForSummary(rentalData.netTotal || rentalData.ค่าเช่ารวมทั้งหมด, language) || "-",
            "{{สูตรค่าเช่า}}": "",
            "{{ค่ามัดจำคิวรถ}}": this.formatCurrencyForSummary(rentalData.ค่ามัดจำคิวรถ, language) || "-",
            "{{เงินประกันความเสียหาย}}": this.formatCurrencyForSummary(rentalData.เงินประกันความเสียหาย, language) || "-",
            "{{ค่าบริการเพิ่มเติม}}": this.formatCurrencyForSummary(rentalData.ค่าบริการเพิ่มเติม, language) || "-",
            "{{รวมยอดชำระวันรับรถ}}": this.formatCurrencyForSummary(rentalData.รวมยอดชำระวันรับรถ, language) || "-",
            "{{ส่วนลด}}": rentalData.ส่วนลด ? this.formatCurrencyForSummary(rentalData.ส่วนลด, language) : "",
            "[[VAT]]": rentalData.receiptType === 'tax_invoice' ? `ภาษีมูลค่าเพิ่ม 7% (${this.formatCurrencyForSummary(rentalData.vatAmount, language)})` : "",
            "[[WHT]]": rentalData.wantsWHT ? `หัก ณ ที่จ่าย ${rentalData.whtPercentage}% (${this.formatCurrencyForSummary(rentalData.whtAmount, language)})` : "",
            "{{ลิงก์สัญญาเช่า}}": rentalData.ลิงก์สัญญาเช่า || "",

            "{{วันที่เวลาปัจจุบัน}}": this.formatDateForSummary(new Date(), language) || "-",
            "{{ชื่อธนาคาร}}": this.config.ชื่อธนาคาร || "-",
            "{{หมายเลขบัญชีธนาคาร}}": this.config.หมายเลขบัญชีธนาคาร || "-",
            "{{ชื่อบัญชี}}": this.config.ชื่อบัญชี || "-",
            "{{ชื่อบริษัท}}": this.config.ชื่อบริษัท || "-",
            "{{จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน}}": extraHoursThreshold.toString(),
            "{{ชั่วโมงล่วงเวลา}}": (remainingHours > extraHoursThreshold && remainingHours > 0) ? remainingHours.toString() : "",
            "{{ค่าล่วงเวลา}}": rentalData.ค่าล่วงเวลา ? this.formatCurrencyForSummary(rentalData.ค่าล่วงเวลา, language) : "",
            "{{ค่าคาร์ซีท}}": rentalData.ค่าคาร์ซีท ? this.formatCurrencyForSummary(rentalData.ค่าคาร์ซีท, language) : "",
            "{{ค่าประกันเสริมรวม}}": rentalData.ค่าประกันเสริมรวม ? this.formatCurrencyForSummary(rentalData.ค่าประกันเสริมรวม, language) : "",
            "{{จำนวนวันประกันเสริม}}": rentalData.จำนวนวันประกันเสริม ? rentalData.จำนวนวันประกันเสริม.toString() : "",
            "{{ราคาประกันเสริมต่อวัน}}": rentalData.ราคาประกันเสริมต่อวัน ? this.formatCurrencyForSummary(rentalData.ราคาประกันเสริมต่อวัน, language) : "",
            "{{จำนวนเงินก่อนVAT}}": "",
            "{{VAT7เปอร์เซ็นต์}}": "",
            "{{ยอดรวมVAT}}": ""
          };

          // คำนวณสูตรค่าเช่า (จำนวนวัน x ราคาต่อวัน = ค่าเช่าพื้นฐาน)
          const dailyRate = parseFloat(rentalData.ราคา) || 0;
          const baseRentalCost = rentalDays * dailyRate;
          placeholderData["{{สูตรค่าเช่า}}"] = rentalDays + " x " + this.formatCurrencyForSummary(dailyRate, language) + " = " + this.formatCurrencyForSummary(baseRentalCost, language);

          // ดึงข้อมูล VAT จาก ReceiptInfo (ถ้ามี)
          let receiptInfo = {};
          if (rentalData.ReceiptInfo) {
            try {
              receiptInfo = typeof rentalData.ReceiptInfo === 'string'
                ? JSON.parse(rentalData.ReceiptInfo)
                : rentalData.ReceiptInfo;
            } catch (e) {
              console.error('Error parsing ReceiptInfo:', e);
            }
          }

          // ถ้ามีข้อมูล VAT ให้แทนที่ placeholders
          if (receiptInfo.wantsTaxInvoice && receiptInfo.taxInvoiceTotal > 0) {
            placeholderData["{{จำนวนเงินก่อนVAT}}"] = this.formatCurrencyForSummary(receiptInfo.taxInvoiceAmountExVAT, language);
            placeholderData["{{VAT7เปอร์เซ็นต์}}"] = this.formatCurrencyForSummary(receiptInfo.taxInvoiceVATAmount, language);
            placeholderData["{{ยอดรวมVAT}}"] = this.formatCurrencyForSummary(receiptInfo.taxInvoiceTotal, language);
          }

          let summaryText = this.config.summaryMessageTemplate;

          // แทนที่ทุกคีย์การแปลภาษา [[key]]
          const translationRegex = /\[\[(.*?)\]\]/g;
          summaryText = summaryText.replace(translationRegex, (match, key) => {
            console.log('กำลังแปล key:', key, 'ด้วยภาษา:', language);
            let translated = this.translate(key, language);

            // กรณีพิเศษสำหรับ extra_hours_info
            if (key === "extra_hours_info") {
              if (remainingHours > 0 && remainingHours > extraHoursThreshold && extraHoursThreshold > 0 && translated) {
                return translated.replace("{0}", extraHoursThreshold.toString());
              }
              return "";
            }

            return translated !== key ? translated : match;
          });

          console.log('this.translations ภายใน generateSummary:', this.translations);
          console.log('ข้อมูลที่จะนำไปแทนที่:', placeholderData);

          // แทนที่ทุก placeholder {{key}}
          for (const [placeholder, value] of Object.entries(placeholderData)) {
            summaryText = summaryText.split(placeholder).join(value);
          }

          // ลบบรรทัดที่มี VAT keys แต่ค่าว่าง (ถ้าไม่มี VAT)
          if (!receiptInfo.wantsTaxInvoice || !receiptInfo.taxInvoiceTotal) {
            const vatRelatedKeys = ['amount_before_vat', 'vat_7_percent', 'total_with_vat'];
            const lines = summaryText.split('\n');
            const filteredLines = lines.filter(line => {
              // ลบบรรทัดที่มี VAT keys และค่าว่าง
              const hasVatKey = vatRelatedKeys.some(key => {
                const translatedKey = this.translate(key, language);
                return line.includes(translatedKey);
              });
              return !hasVatKey;
            });
            summaryText = filteredLines.join('\n');
          }

          // ลบบรรทัดที่มี [[additional_service]] แต่ค่าว่าง
          const additionalServiceValue = parseFloat(rentalData.ค่าบริการเพิ่มเติม) || 0;
          if (additionalServiceValue === 0) {
            const additionalServiceKey = this.translate('additional_service', language);
            const lines = summaryText.split('\n');
            const filteredLines = lines.filter(line => !line.includes(additionalServiceKey));
            summaryText = filteredLines.join('\n');
          }

          // ลบบรรทัดที่มี {{ค่าคาร์ซีท}} และ [[car_seat_fee]] แต่ค่าว่างหรือเป็น 0
          const carSeatValue = parseFloat(rentalData.ค่าคาร์ซีท) || 0;
          if (carSeatValue === 0) {
            const carSeatKey = this.translate('car_seat_fee', language);
            const lines = summaryText.split('\n');
            const filteredLines = lines.filter(line => {
              // ลบบรรทัดที่มี {{ค่าคาร์ซีท}} หรือ translation key
              return !line.includes('{{ค่าคาร์ซีท}}') && !line.includes(carSeatKey);
            });
            summaryText = filteredLines.join('\n');
          }

          // ลบบรรทัดที่มี {{ลิงก์สัญญาเช่า}} และ [[rental_contract]] เมื่อไม่มีลิงก์
          if (!rentalData.ลิงก์สัญญาเช่า) {
            const rentalContractKey = this.translate('rental_contract', language);
            const lines = summaryText.split('\n');
            const filteredLines = lines.filter(line => {
              // ลบบรรทัดที่มี {{ลิงก์สัญญาเช่า}} หรือ translation key
              return !line.includes('{{ลิงก์สัญญาเช่า}}') && !line.includes(rentalContractKey);
            });
            summaryText = filteredLines.join('\n');
          }

          // ลบบรรทัดที่มี translation key แต่ไม่มีข้อมูล และเพิ่มบรรทัดที่มีข้อมูลแต่ไม่มีใน template
          summaryText = this.adjustSummaryLines(summaryText, placeholderData, language);

          return summaryText;
        },

        adjustSummaryLines(summaryText, placeholderData, language) {
          // แยกเป็นบรรทัด
          let lines = summaryText.split('\n');

          // Filter ออกบรรทัดว่างที่มี placeholder หรือ translation key แต่ไม่มีข้อมูล
          const keysToCheck = [
            { key: 'overtime_hours', placeholder: '{{ชั่วโมงล่วงเวลา}}' },
            { key: 'overtime_fee', placeholder: '{{ค่าล่วงเวลา}}' },
            { key: 'additional_service', placeholder: '{{ค่าบริการเพิ่มเติม}}' },
            { key: 'car_seat_fee', placeholder: '{{ค่าคาร์ซีท}}' },
            { key: 'additional_insurance_fee', placeholder: '{{ค่าประกันเสริมรวม}}' },
            { key: 'insurance_days', placeholder: '{{จำนวนวันประกันเสริม}}' },
            { key: 'discount', placeholder: '{{ส่วนลด}}' }
          ];

          lines = lines.filter(line => {
            // ถ้าบรรทัดมี placeholder แต่ค่าว่าง → ลบทิ้ง
            for (const item of keysToCheck) {
              if (line.includes(item.placeholder) && placeholderData[item.placeholder] === "") {
                return false; // ลบบรรทัดนี้
              }
              // ถ้าบรรทัดมี translation key แต่ค่าว่าง → ลบทิ้ง
              const translatedKey = this.translate(item.key, language);
              if (line.includes(translatedKey) && placeholderData[item.placeholder] === "") {
                return false; // ลบบรรทัดนี้
              }
            }
            return true; // เก็บบรรทัดนี้
          });

          return lines.join('\n');
        },



        displaySummaryText(summaryText) {
          document.getElementById('rentalSummaryText').value = summaryText;
          //  console.log('ข้อความสรุปก่อนแสดง:', summaryText);
        },


        // คัดลอกข้อมูลสรุปไปยังคลิปบอร์ด
        copySummaryToClipboard(event) {
          if (event) event.preventDefault();

          const textarea = document.getElementById('rentalSummaryText');

          if (!textarea.value) {
            this.showNotification('กรุณาสร้างข้อมูลสรุปก่อน', 'error');
            return;
          }

          textarea.select();
          document.execCommand('copy');

          this.showNotification('คัดลอกข้อมูลสรุปไปยังคลิปบอร์ดแล้ว', 'success');
        },

        async shareSummary(event) {
          if (event) event.preventDefault();

          const textarea = document.getElementById('rentalSummaryText');
          const text = textarea.value;

          if (!text) {
            this.showNotification('กรุณาสร้างข้อมูลสรุปก่อน', 'error');
            return;
          }

          // ถ้าเบราว์เซอร์รองรับ Web Share API
          if (navigator.share) {
            try {
              await navigator.share({
                title: 'สรุปรายการเช่า',
                text: text,
              });
              this.showNotification('แชร์ข้อความสรุปเรียบร้อยแล้ว', 'success');
            } catch (err) {
              console.error('Error sharing:', err);
              this.showNotification('ไม่สามารถแชร์ข้อความได้', 'error');
            }
          } else {
            // fallback: คัดลอกไปยังคลิปบอร์ดแทน
            textarea.select();
            const copied = document.execCommand('copy');
            if (copied) {
              this.showNotification(
                'เบราว์เซอร์ไม่รองรับการแชร์โดยตรง แต่ข้อความถูกคัดลอกไปยังคลิปบอร์ดแล้ว',
                'info'
              );
            } else {
              this.showNotification('ไม่สามารถคัดลอกข้อความได้', 'error');
            }
          }
        },


        // แทรก placeholder ลงในข้อความ
        insertMessagePlaceholder(templateType, placeholder) {
          if (templateType === 'confirmMessage') {
            // แทรกใน confirm message
            const textarea = document.querySelector('textarea[x-model="config.confirmMessageTemplate"]');
            if (textarea) {
              const startPos = textarea.selectionStart;
              const endPos = textarea.selectionEnd;
              const currentValue = this.config.confirmMessageTemplate || '';

              this.config.confirmMessageTemplate = currentValue.substring(0, startPos) + placeholder + currentValue.substring(endPos);

              // ตั้งค่าตำแหน่ง cursor หลังจาก placeholder
              setTimeout(() => {
                textarea.focus();
                textarea.setSelectionRange(startPos + placeholder.length, startPos + placeholder.length);
              }, 0);
            }
          } else if (templateType === 'summaryMessage') {
            // แทรกใน summary message
            const textarea = document.querySelector('textarea[x-model="config.summaryMessageTemplate"]');
            if (textarea) {
              const startPos = textarea.selectionStart;
              const endPos = textarea.selectionEnd;
              const currentValue = this.config.summaryMessageTemplate || '';

              this.config.summaryMessageTemplate = currentValue.substring(0, startPos) + placeholder + currentValue.substring(endPos);

              // ตั้งค่าตำแหน่ง cursor หลังจาก placeholder
              setTimeout(() => {
                textarea.focus();
                textarea.setSelectionRange(startPos + placeholder.length, startPos + placeholder.length);
              }, 0);
            }
          } else if (templateType === 'quoteMessage') {
            // แทรกใน quote message
            const textarea = document.querySelector('textarea[x-model="config.quoteMessageTemplate"]');
            if (textarea) {
              const startPos = textarea.selectionStart;
              const endPos = textarea.selectionEnd;
              const currentValue = this.config.quoteMessageTemplate || '';

              this.config.quoteMessageTemplate = currentValue.substring(0, startPos) + placeholder + currentValue.substring(endPos);

              // ตั้งค่าตำแหน่ง cursor หลังจาก placeholder
              setTimeout(() => {
                textarea.focus();
                textarea.setSelectionRange(startPos + placeholder.length, startPos + placeholder.length);
              }, 0);
            }
          }
        },

        // ล้างข้อความเทมเพลต
        clearMessageTemplate(templateType) {
          if (templateType === 'confirmMessage') {
            this.config.confirmMessageTemplate = '';
          } else if (templateType === 'summaryMessage') {
            this.config.summaryMessageTemplate = '';
          } else if (templateType === 'quoteMessage') {
            this.config.quoteMessageTemplate = '';
          }
        },


        // เพิ่มฟังก์ชันใหม่สำหรับการเปิดลิงก์สัญญาเช่า
        openContractPdf(event, url) {
          // ป้องกันการ submit form
          if (event) {
            event.preventDefault();
          }

          // เปิดลิงก์ในแท็บใหม่
          window.open(url, '_blank');
        },




        // คืนค่าเริ่มต้นของเทมเพลต
        resetMessageTemplate(templateType) {
          if (templateType === 'summaryMessage') {
            this.config.summaryMessageTemplate = `[[rental_summary_title]]
[[booking_number]]: {{หมายเลขการจอง}}
[[document_date]]: {{วันที่เวลาปัจจุบัน}}

[[customer_info]]
[[customer_name]]: {{ชื่อลูกค้า}}
[[phone_number]]: {{เบอร์โทรศัพท์}}

[[car_info]]
[[car_model]]: {{รถ}}
[[license_plate]]: {{ทะเบียนรถ}}

[[rental_period]]
[[pickup_date]]: {{วันที่เช่า}} [[time]]: {{เวลารับรถ}}
[[return_date]]: {{วันที่คืน}} [[time]]: {{เวลาคืนรถ}}
[[rental_days]]: {{จำนวนวัน}}
[[extra_hours_info]]
[[overtime_hours]]: {{ชั่วโมงล่วงเวลา}}
[[overtime_fee]]: {{ค่าล่วงเวลา}}
[[car_seat_fee]]: {{ค่าคาร์ซีท}}
[[additional_insurance_fee]]: {{ค่าประกันเสริมรวม}}
[[insurance_days]]: {{จำนวนวันประกันเสริม}}

[[pickup_location]]: {{สถานที่รับรถ}}
[[return_location]]: {{สถานที่คืนรถ}}

[[payment_info]]
[[daily_rate]]: {{ราคาต่อวัน}}
[[total_rental]]: {{ค่าเช่ารวมทั้งหมด}}
[[booking_deposit]]: {{ค่ามัดจำคิวรถ}}
[[security_deposit]]: {{เงินประกันความเสียหาย}}
[[additional_service]]: {{ค่าบริการเพิ่มเติม}}
[[total_amount]]: {{รวมยอดชำระวันรับรถ}}

[[payment_method]]
[[bank_name]]: {{ชื่อธนาคาร}}
[[account_number]]: {{หมายเลขบัญชีธนาคาร}}
[[account_name]]: {{ชื่อบัญชี}}

[[rental_contract]]: {{ลิงก์สัญญาเช่า}}

[[issued_by]]: {{ชื่อบริษัท}}`;
          } else if (templateType === 'quoteMessage') {
            this.config.quoteMessageTemplate = this.getDefaultQuoteTemplate();
          }
        },

        // แสดงตัวอย่างข้อความ
        previewMessage(templateType) {
          let template = '';
          let placeholderData = {};

          // ดึงข้อมูลธนาคารจากการตั้งค่า (เพิ่มส่วนนี้)
          const bankName = this.config.ชื่อธนาคาร || 'ธนาคารกรุงไทย';
          const accountNumber = this.config.หมายเลขบัญชีธนาคาร || 'XXX-X-XXXXX-X';
          const accountName = this.config.ชื่อบัญชี || 'บริษัท รักเช่ารถ จำกัด';

          if (templateType === 'confirmMessage') {
            template = this.config.confirmMessageTemplate || '';

            // สร้างข้อมูลตัวอย่าง
            placeholderData = {
              "{{ชื่อลูกค้า}}": "สมชาย รักดี",
              "{{หมายเลขการจอง}}": "KP00123",
              "{{รถ}}": "Honda City (กข 1234)",
              "{{วันที่เช่า}}": this.formatDate(new Date()),
              "{{วันที่คืน}}": this.formatDate(new Date(new Date().setDate(new Date().getDate() + 3))),
              "{{เวลารับรถ}}": "10:00",
              "{{เวลาคืนรถ}}": "16:00",
              "{{สถานที่รับรถ}}": "สนามบินเชียงใหม่",
              "{{สถานที่คืนรถ}}": "สนามบินเชียงใหม่",
              "{{ค่าเช่ารวมทั้งหมด}}": "฿3,600",
              "{{ค่ามัดจำคิวรถ}}": "฿500",
              "{{เงินประกันความเสียหาย}}": "฿5,000",
              "{{รวมยอดชำระวันรับรถ}}": "฿8,100",
              "{{ลิงก์สัญญาเช่า}}": "https://example.com/rental/KP00123",
              "{{ชื่อบริษัท}}": this.config.ชื่อบริษัท || "บริษัทเช่ารถ จำกัด",

              // เพิ่มข้อมูลธนาคาร
              "{{ชื่อธนาคาร}}": bankName,
              "{{หมายเลขบัญชีธนาคาร}}": accountNumber,
              "{{ชื่อบัญชี}}": accountName
            };
          } else if (templateType === 'quoteMessage') {
            template = this.config.quoteMessageTemplate || this.getDefaultQuoteTemplate();

            // สร้างข้อมูลตัวอย่าง
            placeholderData = {
              "{{รถ}}": "Honda City",
              "{{วันที่รับรถ}}": this.formatDate(new Date()),
              "{{เวลารับรถ}}": "10:00",
              "{{วันที่คืนรถ}}": this.formatDate(new Date(new Date().setDate(new Date().getDate() + 3))),
              "{{เวลาคืนรถ}}": "16:00",
              "{{จำนวนวัน}}": "3",
              "{{ราคาต่อวัน}}": "฿1,200",
              "{{ค่าเช่ารวมทั้งหมด}}": "฿3,600",
              "{{ค่าประกันความเสียหาย}}": "฿5,000",
              "{{ค่ามัดจำคิวรถ}}": "฿500",
              "{{ส่วนลด}}": "฿200",
              "{{รวมชำระวันรับรถ}}": "฿7,900",
              "{{ชื่อบริษัท}}": this.config.ชื่อบริษัท || "บริษัทเช่ารถ จำกัด",
              "{{เบอร์โทรศัพท์}}": this.config.เบอร์โทรศัพท์ || "081-234-5678",
              "{{อีเมล}}": this.config.อีเมล || "info@rental.com",
              "{{ที่อยู่}}": this.config.ที่อยู่ || "123 ถนนหลัก เชียงใหม่"
            };
          } else if (templateType === 'summaryMessage') {
            template = this.config.summaryMessageTemplate || '';

            // สร้างข้อมูลตัวอย่างครบถ้วน
            placeholderData = {
              "{{ชื่อลูกค้า}}": "สมชาย รักดี",
              "{{เบอร์โทรศัพท์}}": "081-234-5678",
              "{{หมายเลขการจอง}}": "KP00123",
              "{{รถ}}": "Honda City",
              "{{ทะเบียนรถ}}": "กข 1234",
              "{{วันที่เช่า}}": this.formatDate(new Date()),
              "{{วันที่คืน}}": this.formatDate(new Date(new Date().setDate(new Date().getDate() + 3))),
              "{{จำนวนวัน}}": "3 วัน",
              "{{เวลารับรถ}}": "10:00",
              "{{เวลาคืนรถ}}": "16:00",
              "{{สถานที่รับรถ}}": "สนามบินเชียงใหม่",
              "{{สถานที่คืนรถ}}": "สนามบินเชียงใหม่",
              "{{ราคาต่อวัน}}": "1,200 บาท",
              "{{สูตรค่าเช่า}}": "3 x 1,200 = 3,600 บาท",
              "{{ค่าเช่ารวมทั้งหมด}}": "3,600 บาท",
              "{{ค่ามัดจำคิวรถ}}": "500 บาท",
              "{{เงินประกันความเสียหาย}}": "5,000 บาท",
              "{{ค่าบริการเพิ่มเติม}}": "0 บาท",
              "{{รวมยอดชำระวันรับรถ}}": "8,100 บาท",

              // ค่าเพิ่มเติม (ตัวอย่างที่ซ่อนได้)
              "{{ส่วนลด}}": "200 บาท",
              "{{ค่าล่วงเวลา}}": "",
              "{{ชั่วโมงล่วงเวลา}}": "",
              "{{ค่าคาร์ซีท}}": "",
              "{{ค่าประกันเสริมรวม}}": "",
              "{{จำนวนวันประกันเสริม}}": "",
              "{{ราคาประกันเสริมต่อวัน}}": "",

              // VAT (ใช้รูปแบบสั้น)
              "[[VAT]]": "ภาษีมูลค่าเพิ่ม 7% (252 บาท)",
              "{{จำนวนเงินก่อนVAT}}": "3,600 บาท",
              "{{VAT7เปอร์เซ็นต์}}": "252 บาท",
              "{{ยอดรวมVAT}}": "3,852 บาท",

              // WHT (ใช้รูปแบบสั้น)
              "[[WHT]]": "หัก ณ ที่จ่าย 5% (180 บาท)",

              // ลิงก์และข้อมูลอื่นๆ
              "{{ลิงก์สัญญาเช่า}}": "https://example.com/rental/KP00123",
              "{{วันที่เวลาปัจจุบัน}}": new Date().toLocaleString('th-TH'),
              "{{ชื่อบริษัท}}": this.config.ชื่อบริษัท || "บริษัทเช่ารถ จำกัด",
              "{{จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน}}": "4",

              // ข้อมูลธนาคาร
              "{{ชื่อธนาคาร}}": bankName,
              "{{หมายเลขบัญชีธนาคาร}}": accountNumber,
              "{{ชื่อบัญชี}}": accountName
            };

            // แทนที่ translation keys [[key]] ด้วยคำแปลภาษาไทย
            const translationKeys = {
              "[[rental_summary_title]]": "ใบยืนยันการจองรถเช่า",
              "[[booking_number]]": "หมายเลขการจอง",
              "[[document_date]]": "วันที่ออกเอกสาร",
              "[[customer_info]]": "ข้อมูลลูกค้า",
              "[[customer_name]]": "ชื่อลูกค้า",
              "[[phone_number]]": "เบอร์โทรศัพท์",
              "[[car_info]]": "ข้อมูลรถ",
              "[[car_model]]": "รถที่เช่า",
              "[[license_plate]]": "ทะเบียนรถ",
              "[[rental_period]]": "ระยะเวลาเช่า",
              "[[pickup_date]]": "วันที่รับรถ",
              "[[return_date]]": "วันที่คืนรถ",
              "[[time]]": "เวลา",
              "[[rental_days]]": "จำนวนวันเช่า",
              "[[pickup_time]]": "เวลารับรถ",
              "[[return_time]]": "เวลาคืนรถ",
              "[[pickup_location]]": "สถานที่รับรถ",
              "[[return_location]]": "สถานที่คืนรถ",
              "[[payment_info]]": "ข้อมูลการชำระเงิน",
              "[[daily_rate]]": "ราคาเช่าต่อวัน",
              "[[rental_formula]]": "คำนวณค่าเช่า",
              "[[total_rental]]": "ค่าเช่ารวมทั้งหมด",
              "[[discount]]": "ส่วนลด",
              "[[queue_deposit]]": "ค่ามัดจำคิวรถ",
              "[[booking_deposit]]": "ค่ามัดจำการจอง",
              "[[security_deposit]]": "เงินประกันความเสียหาย",
              "[[additional_service]]": "ค่าบริการเพิ่มเติม",
              "[[total_amount]]": "ยอดรวมทั้งหมด",
              "[[payment_method]]": "วิธีการชำระเงิน",
              "[[bank_name]]": "ธนาคาร",
              "[[account_number]]": "หมายเลขบัญชี",
              "[[account_name]]": "ชื่อบัญชี",
              "[[rental_contract]]": "สัญญาเช่า",
              "[[issued_by]]": "ออกโดย",
              "[[hours]]": "ชั่วโมง",
              "[[days]]": "วัน",
              "[[extra_hours_info]]": "ข้อมูลชั่วโมงเพิ่ม",
              "[[overtime_hours]]": "ชั่วโมงล่วงเวลา",
              "[[overtime_fee]]": "ค่าล่วงเวลา",
              "[[car_seat_fee]]": "ค่าคาร์ซีท",
              "[[additional_insurance_fee]]": "ค่าประกันเสริม",
              "[[insurance_days]]": "จำนวนวันประกัน",
              "[[amount_before_vat]]": "จำนวนเงินก่อน VAT",
              "[[vat_7_percent]]": "VAT 7%",
              "[[total_with_vat]]": "ยอดรวมรวม VAT",
              "[[base_rental_cost]]": "ค่าเช่าพื้นฐาน"
            };

            // แทนที่ translation keys
            for (const [key, value] of Object.entries(translationKeys)) {
              template = template.split(key).join(value);
            }
          }

          // แทนที่ placeholder ด้วยข้อมูลตัวอย่าง
          for (const [placeholder, value] of Object.entries(placeholderData)) {
            template = template.split(placeholder).join(value);
          }

          // แสดงใน Modal
          this.messagePreviewContent = template.replace(/\n/g, '<br>');
          this.showMessagePreviewModal = true;
        },

        // ฟังก์ชันดูข้อมูลรายการเช่า (Read-only Mode)
        viewRental(rental) {
          this.editRental(rental, true); // เรียกใช้ editRental ในโหมดดู (read-only)
        },




        // (ในไฟล์ index.html ภายใน <script> และ app())

        editRental(rental, viewMode = false) {
          // ตั้งค่าโหมดตาม parameter ที่ส่งมา
          this.isViewMode = viewMode;

          this.isLoading = true;
          this.loadCarsForRental();

          // ทำสำเนาข้อมูลรายการเช่า
          this.editRentalData = JSON.parse(JSON.stringify(rental));

          // เพิ่มคุณสมบัติสำหรับจัดการสัญญาเช่า
          // ถ้ามีสัญญาเช่าเดิม ให้เลือก checkbox "สร้างสัญญาเช่าใหม่" และเปิดส่วนแก้ไขสัญญาเช่าโดย default
          const hasExistingContract = !!this.editRentalData.ลิงก์สัญญาเช่า;
          this.editRentalData.สร้างสัญญาเช่า = hasExistingContract;
          this.editRentalData.แก้ไขสัญญาเช่า = hasExistingContract; // เปิดส่วนแก้ไขสัญญาเช่าถ้ามีสัญญาเดิม
          this.editRentalData.ภาษาสัญญาเช่า = this.editRentalData.ภาษาสัญญาเช่า || 'th';

          // แปลงรูปแบบวันที่ให้ถูกต้องสำหรับ input type="date"
          if (this.editRentalData.วันที่เช่า) {
            try {
              const date = new Date(this.editRentalData.วันที่เช่า);
              if (!isNaN(date.getTime())) {
                const thaiDate = new Date(date.getTime() + (7 * 60 * 60 * 1000));
                this.editRentalData.วันที่เช่า = thaiDate.toISOString().split('T')[0];
              }
            } catch (e) {
              console.error("ไม่สามารถแปลงวันที่เช่าได้:", e);
            }
          }

          // ทำเช่นเดียวกันกับวันที่คืน
          if (this.editRentalData.วันที่คืน) {
            try {
              const date = new Date(this.editRentalData.วันที่คืน);
              if (!isNaN(date.getTime())) {
                const thaiDate = new Date(date.getTime() + (7 * 60 * 60 * 1000));
                this.editRentalData.วันที่คืน = thaiDate.toISOString().split('T')[0];
              }
            } catch (e) {
              console.error("ไม่สามารถแปลงวันที่คืนได้:", e);
            }
          }

          // === ส่วนการจัดการค่าคอมมิชชั่น ===
          if (!this.commissionList || this.commissionList.length === 0) {
            this.loadCommissionList();
          }

          const commissionAmount = parseFloat(this.editRentalData.ค่าคอมมิชชั่น) || 0;
          if (commissionAmount > 0) {
            this.editRentalData.มีค่าคอมมิชชั่น = true;
            const savedCommissionType = rental["รูปแบบค่าคอมมิชชั่น"] || '';
            this.editRentalData.ค่าคอมมิชชั่นที่เลือก = savedCommissionType;
            if (!savedCommissionType) {
              this.editRentalData.ค่าคอมมิชชั่นที่เลือก = '';
            }
          } else {
            this.editRentalData.มีค่าคอมมิชชั่น = false;
            this.editRentalData.ค่าคอมมิชชั่นที่เลือก = '';
          }

          // ========== 👇 จุดที่เพิ่มเข้ามาใหม่ 👇 ==========
          // === ส่วนจัดการข้อมูลใบเสร็จ ===
          if (this.editRentalData.ReceiptInfo && typeof this.editRentalData.ReceiptInfo === 'string') {
            try {
              const receiptInfo = JSON.parse(this.editRentalData.ReceiptInfo);
              this.editRentalData.wantsCashBill = receiptInfo.wantsCashBill || false;
              this.editRentalData.wantsTaxInvoice = receiptInfo.wantsTaxInvoice || false;
              this.editRentalData.wantsWHT = receiptInfo.wantsWHT || false;
              // เพิ่มการโหลดข้อมูล VAT สำหรับใบกำกับภาษี
              this.editRentalData.taxInvoiceAmountExVAT = receiptInfo.taxInvoiceAmountExVAT || 0;
              this.editRentalData.taxInvoiceVATAmount = receiptInfo.taxInvoiceVATAmount || 0;
              this.editRentalData.taxInvoiceTotal = receiptInfo.taxInvoiceTotal || 0;
              // โหลด checkbox สำหรับรายการย่อย (VAT/WHT)
              this.editRentalData.carSeatIncludeVAT = receiptInfo.carSeatIncludeVAT !== false;
              this.editRentalData.carSeatIncludeWHT = receiptInfo.carSeatIncludeWHT !== false;
              this.editRentalData.insuranceIncludeVAT = receiptInfo.insuranceIncludeVAT !== false;
              this.editRentalData.insuranceIncludeWHT = receiptInfo.insuranceIncludeWHT !== false;
              this.editRentalData.additionalServiceIncludeVAT = receiptInfo.additionalServiceIncludeVAT !== false;
              this.editRentalData.additionalServiceIncludeWHT = receiptInfo.additionalServiceIncludeWHT !== false;
              // โหลดข้อมูล WHT
              this.editRentalData.whtPercentage = receiptInfo.whtPercentage || 5;
              this.editRentalData.whtBaseAmount = receiptInfo.whtBaseAmount || 0;
              this.editRentalData.whtAmount = receiptInfo.whtAmount || 0;

              // ถ้ามีข้อมูล VAT อยู่แล้ว ให้ใช้ค่า taxInvoiceTotal เป็น "ค่าเช่ารวมทั้งหมด" โดยตรง
              if (this.editRentalData.wantsTaxInvoice && receiptInfo.taxInvoiceTotal > 0) {
                // เก็บค่าก่อน VAT ไว้เป็น _originalTotalRental
                this.editRentalData._originalTotalRental = receiptInfo.taxInvoiceAmountExVAT;
                // ใช้ค่า taxInvoiceAmountExVAT (Base) เป็นค่าเช่ารวมทั้งหมดเพื่อแสดงผล
                this.editRentalData.ค่าเช่ารวมทั้งหมด = receiptInfo.taxInvoiceAmountExVAT;
                // ตั้ง flag เพื่อไม่ให้คำนวณค่าเช่ารวมทั้งหมดใหม่
                this.editRentalData._hasTaxInvoiceTotal = true;
              }
            } catch (e) {
              console.error("ไม่สามารถแปลงข้อมูล ReceiptInfo ได้:", this.editRentalData.ReceiptInfo);
              // กำหนดค่าเริ่มต้นหากข้อมูลเสียหาย
              this.editRentalData.wantsCashBill = false;
              this.editRentalData.wantsTaxInvoice = false;
              this.editRentalData.wantsWHT = false;
              this.editRentalData.taxInvoiceAmountExVAT = 0;
              this.editRentalData.taxInvoiceVATAmount = 0;
              this.editRentalData.taxInvoiceTotal = 0;
              this.editRentalData.carSeatIncludeVAT = true;
              this.editRentalData.carSeatIncludeWHT = true;
              this.editRentalData.insuranceIncludeVAT = true;
              this.editRentalData.insuranceIncludeWHT = true;
              this.editRentalData.additionalServiceIncludeVAT = true;
              this.editRentalData.additionalServiceIncludeWHT = true;
              this.editRentalData.whtPercentage = 5;
              this.editRentalData.whtBaseAmount = 0;
              this.editRentalData.whtAmount = 0;
            }
          } else {
            // กำหนดค่าเริ่มต้นหากไม่มีข้อมูล ReceiptInfo (สำหรับรายการเก่า)
            this.editRentalData.wantsCashBill = false;
            this.editRentalData.wantsTaxInvoice = false;
            this.editRentalData.wantsWHT = false;
            this.editRentalData.taxInvoiceAmountExVAT = 0;
            this.editRentalData.taxInvoiceVATAmount = 0;
            this.editRentalData.taxInvoiceTotal = 0;
            // ค่าเริ่มต้นสำหรับ checkbox รายการย่อย (default: รวมทั้งหมด)
            this.editRentalData.carSeatIncludeVAT = true;
            this.editRentalData.carSeatIncludeWHT = true;
            this.editRentalData.insuranceIncludeVAT = true;
            this.editRentalData.insuranceIncludeWHT = true;
            this.editRentalData.additionalServiceIncludeVAT = true;
            this.editRentalData.additionalServiceIncludeWHT = true;
            this.editRentalData.whtPercentage = 5;
            this.editRentalData.whtBaseAmount = 0;
            this.editRentalData.whtAmount = 0;
          }
          // ========== 👆 สิ้นสุดส่วนที่เพิ่ม 👆 ==========

          // แปลงเวลารับรถ
          if (this.editRentalData.เวลารับรถ) {
            try {
              if (this.editRentalData.เวลารับรถ.includes('1899-12-30')) {
                this.editRentalData.เวลารับรถ = "08:00";
              } else if (this.editRentalData.เวลารับรถ.includes(':')) {
                const timeParts = this.editRentalData.เวลารับรถ.split(':');
                if (timeParts.length >= 2) {
                  this.editRentalData.เวลารับรถ = `${timeParts[0]}:${timeParts[1]}`;
                }
              }
            } catch (e) {
              console.error("ไม่สามารถแปลงเวลารับรถได้:", e);
              this.editRentalData.เวลารับรถ = "08:00";
            }
          } else {
            this.editRentalData.เวลารับรถ = "08:00";
          }

          // แปลงเวลาคืนรถ
          if (this.editRentalData.เวลาคืนรถ) {
            try {
              if (this.editRentalData.เวลาคืนรถ.includes('1899-12-30')) {
                this.editRentalData.เวลาคืนรถ = "12:30";
              } else if (this.editRentalData.เวลาคืนรถ.includes(':')) {
                const timeParts = this.editRentalData.เวลาคืนรถ.split(':');
                if (timeParts.length >= 2) {
                  this.editRentalData.เวลาคืนรถ = `${timeParts[0]}:${timeParts[1]}`;
                }
              }
            } catch (e) {
              console.error("ไม่สามารถแปลงเวลาคืนรถได้:", e);
              this.editRentalData.เวลาคืนรถ = "12:30";
            }
          } else {
            this.editRentalData.เวลาคืนรถ = "12:30";
          }

          // กำหนดค่าเริ่มต้นสำหรับการคำนวณ
          this.editRentalData.ค่าเช่ารวมทั้งหมด = this.editRentalData.ค่าเช่ารวมทั้งหมด || this.editRentalData.ราคา || '';
          this.editRentalData.ค่ามัดจำคิวรถ = this.editRentalData.ค่ามัดจำคิวรถ || '';
          this.editRentalData.เงินประกันความเสียหาย = this.editRentalData.เงินประกันความเสียหาย || '';
          this.editRentalData.ค่าบริการเพิ่มเติม = this.editRentalData.ค่าบริการเพิ่มเติม || '';

          // กำหนดค่าเริ่มต้นสำหรับคาร์ซีท
          // แปลงค่าจาก string/number และอนุมานจากค่าอื่นๆ ถ้าไม่มีคอลัมน์ 'ต้องการคาร์ซีท'
          this.editRentalData.ค่าคาร์ซีท = parseFloat(this.editRentalData.ค่าคาร์ซีท) || 0;
          // แปลงเป็น string "true"/"false" เพื่อให้ match กับ radio button
          this.editRentalData.คาร์ซีทมีค่าบริการ = (this.editRentalData.คาร์ซีทมีค่าบริการ === true ||
            this.editRentalData.คาร์ซีทมีค่าบริการ === 'TRUE' ||
            this.editRentalData.คาร์ซีทมีค่าบริการ === 'true') ? 'true' : 'false';

          // อนุมาน 'ต้องการคาร์ซีท' จากข้อมูลที่มี
          if (this.editRentalData.ต้องการคาร์ซีท !== undefined && this.editRentalData.ต้องการคาร์ซีท !== null && this.editRentalData.ต้องการคาร์ซีท !== '') {
            // มีค่าในคอลัมน์ ต้องการคาร์ซีท - ใช้ค่านั้น
            this.editRentalData.ต้องการคาร์ซีท = this.editRentalData.ต้องการคาร์ซีท === true ||
              this.editRentalData.ต้องการคาร์ซีท === 'TRUE' ||
              this.editRentalData.ต้องการคาร์ซีท === 'true';
          } else {
            // ไม่มีค่าในคอลัมน์ (ข้อมูลเก่า) - อนุมานจากค่าคาร์ซีท
            this.editRentalData.ต้องการคาร์ซีท = this.editRentalData.ค่าคาร์ซีท > 0 || this.editRentalData.คาร์ซีทมีค่าบริการ;
          }

          // กำหนดค่าเริ่มต้นสำหรับประกันเสริม
          // แปลงค่าจาก string/number และอนุมานจากค่าอื่นๆ ถ้าไม่มีคอลัมน์ 'ต้องการประกันเสริม'
          this.editRentalData.จำนวนวันประกันเสริม = parseFloat(this.editRentalData.จำนวนวันประกันเสริม) || 0;
          this.editRentalData.ราคาประกันเสริมต่อวัน = parseFloat(this.editRentalData.ราคาประกันเสริมต่อวัน) || (parseFloat(this.config.ค่าประกันเสริมต่อวัน) || 0);
          this.editRentalData.ค่าประกันเสริมรวม = parseFloat(this.editRentalData.ค่าประกันเสริมรวม) || 0;

          // อนุมาน 'ต้องการประกันเสริม' จากข้อมูลที่มี
          if (this.editRentalData.ต้องการประกันเสริม !== undefined && this.editRentalData.ต้องการประกันเสริม !== null && this.editRentalData.ต้องการประกันเสริม !== '') {
            // มีค่าในคอลัมน์ ต้องการประกันเสริม - ใช้ค่านั้น
            this.editRentalData.ต้องการประกันเสริม = this.editRentalData.ต้องการประกันเสริม === true ||
              this.editRentalData.ต้องการประกันเสริม === 'TRUE' ||
              this.editRentalData.ต้องการประกันเสริม === 'true';
          } else {
            // ไม่มีค่าในคอลัมน์ (ข้อมูลเก่า) - อนุมานจากค่าประกันเสริมรวมหรือจำนวนวัน
            this.editRentalData.ต้องการประกันเสริม = this.editRentalData.ค่าประกันเสริมรวม > 0 || this.editRentalData.จำนวนวันประกันเสริม > 0;
          }

          // ⭐⭐ START: จุดที่แก้ไข (เพิ่ม 1 บรรทัดนี้) ⭐⭐
          // เราต้องเรียกฟังก์ชันนี้ก่อน เพื่อให้มันคำนวณ .จำนวนวันเช่า และ .ค่าเช่ารวมทั้งหมด
          this.calculateEditTotalRental();
          // ⭐⭐ END: จุดที่แก้ไข ⭐⭐

          // ไม่คำนวณภาษีใหม่ตอนเปิด modal แค่แสดงค่าที่บันทึกไว้
          // เมื่อผู้ใช้เปลี่ยนค่า จะมี @change event ที่เรียกฟังก์ชันคำนวณใหม่อัตโนมัติ

          // คำนวณรวมยอดชำระวันรับรถ (ฟังก์ชันนี้จะใช้ค่าที่เพิ่งคำนวณจาก .calculateEditTotalRental())
          this.calculateEditFinalAmount();

          this.isLoading = false;
          this.showRentalModal = true;
        },





        // ปิด Modal แก้ไขรายการเช่า
        closeRentalModal() {
          this.showRentalModal = false;
          // Reset ข้อมูลการแก้ไข
          this.editRentalData = {};
        },








        // ========= START: ฟังก์ชันใหม่สำหรับการคำนวณคอมมิชชั่นในโหมดแก้ไข =========
        calculateEditCommission() {
          if (!this.editRentalData.มีค่าคอมมิชชั่น) {
            this.editRentalData.ค่าคอมมิชชั่น = 0;
            return;
          }

          const selectedName = this.editRentalData.ค่าคอมมิชชั่นที่เลือก;
          const totalRental = parseFloat(this.editRentalData.ค่าเช่ารวมทั้งหมด) || 0;

          if (!selectedName) {
            // กรณี "กำหนดเอง" จะไม่คำนวณอัตโนมัติ
            return;
          }

          const commissionSetting = this.commissionList.find(item => item.ชื่อ === selectedName);

          if (!commissionSetting) {
            this.editRentalData.ค่าคอมมิชชั่น = 0;
            return;
          }

          let commission = 0;
          if (commissionSetting.รูปแบบ === 'fixed') {
            const rentalInfo = this.calculateRentalDaysWithHours(
              this.editRentalData.วันที่เช่า,
              this.editRentalData.วันที่คืน,
              this.editRentalData.เวลารับรถ,
              this.editRentalData.เวลาคืนรถ
            );

            // ตรวจสอบว่าได้ค่า rentalInfo ที่ถูกต้องหรือไม่
            if (!rentalInfo || typeof rentalInfo.days !== 'number' || isNaN(rentalInfo.days)) {
              console.error("calculateRentalDaysWithHours() ส่งค่ากลับมาไม่ถูกต้องใน calculateEditCommission:", rentalInfo);
              this.editRentalData.ค่าคอมมิชชั่น = 0;
              return;
            }

            commission = (parseFloat(commissionSetting.ค่าFixed) || 0) * rentalInfo.days;

          } else if (commissionSetting.รูปแบบ === 'percent+vat') {
            const percent = parseFloat(commissionSetting.ค่าเปอร์เซ็นต์) || 0;
            const vat = parseFloat(commissionSetting.vat) || 0;
            const baseCommission = (totalRental * percent) / 100;
            const vatAmount = (baseCommission * vat) / 100;
            commission = baseCommission + vatAmount;
          }

          // ตรวจสอบว่าไม่มี NaN ก่อน assign
          if (!isNaN(commission) && isFinite(commission)) {
            this.editRentalData.ค่าคอมมิชชั่น = commission.toFixed(2);
          } else {
            this.editRentalData.ค่าคอมมิชชั่น = 0;
          }
        },

        updateEditCommissionOnToggle() {
          if (!this.editRentalData.มีค่าคอมมิชชั่น) {
            // ถ้าไม่ติ๊ก ให้เคลียร์ค่าทั้งหมด
            this.editRentalData.ค่าคอมมิชชั่นที่เลือก = '';
            this.editRentalData.ค่าคอมมิชชั่น = 0;
          } else {
            // ถ้าติ๊ก ให้คำนวณใหม่ตามรูปแบบที่เลือกไว้
            this.calculateEditCommission();
          }
        },







        saveRentalEdit() {
          // แสดง SweetAlert2 เพื่อยืนยันการบันทึกก่อน
          Swal.fire({
            title: 'ยืนยันการบันทึกข้อมูล',
            html: `คุณต้องการบันทึกการแก้ไขข้อมูลการจองหมายเลข <strong>${this.editRentalData.หมายเลขการจอง}</strong> ใช่หรือไม่?<br><br>
           <span class="text-red-500">หมายเหตุ: ข้อมูลเดิมจะถูกลบและแทนที่ด้วยข้อมูลใหม่</span>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ยืนยัน, บันทึกการแก้ไข!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {

              this.editRentalData.ผู้ทำรายการ = this.currentUser.displayName || this.currentUser.username || '';
              // ตรวจสอบความพร้อมของรถ
              this.checkCarAvailabilityAndProceed(true);
            }
          });
        },

        // ฟังก์ชันบันทึกการแก้ไขรายการเช่าหลังจากการยืนยัน
        saveRentalEditConfirmed() {
          // ปิด Modal แก้ไขก่อน
          this.showRentalModal = false;

          // แสดง animation loading แบบใหม่
          this.isContractGenerating = true;
          this.contractLoadingStep = "กำลังเตรียมข้อมูล";
          this.contractLoadingProgress = 10;

          // ดำเนินการต่อ
          setTimeout(() => {
            this.processRentalUpdate();
          }, 500);
        },




        processRentalUpdate() {
          // อัพเดตสถานะ loading
          this.contractLoadingStep = "กำลังตรวจสอบข้อมูลเดิม";
          this.contractLoadingProgress = 20;

          // เก็บหมายเลขการจองที่ต้องการอัพเดต
          const bookingNumber = this.editRentalData.หมายเลขการจอง;
          const sheetID = localStorage.getItem('sheetID') || '';

          console.log("🔍 ตรวจสอบข้อมูลกิจกรรมปฏิทิน:", {
            IDกิจกรรมปฏิทิน: this.editRentalData.IDกิจกรรมปฏิทิน,
            IDปฏิทิน: this.editRentalData.IDปฏิทิน,
            ลิงก์ปฏิทิน: this.editRentalData.ลิงก์ปฏิทิน
          });

          // ตรวจสอบและลบกิจกรรมปฏิทินเดิมก่อน - เพิ่มเงื่อนไขให้ครบถ้วน
          const hasCalendarData = this.editRentalData.IDกิจกรรมปฏิทิน &&
            this.editRentalData.IDปฏิทิน &&
            this.editRentalData.IDกิจกรรมปฏิทิน.trim() !== '' &&
            this.editRentalData.IDปฏิทิน.trim() !== '';

          if (hasCalendarData) {
            this.contractLoadingStep = "กำลังลบกิจกรรมปฏิทินเดิม";
            this.contractLoadingProgress = 25;

            console.log("🗑️ เริ่มลบกิจกรรมปฏิทินเดิม...");

            google.script.run
              .withSuccessHandler(deleteCalendarResult => {
                console.log("✅ ผลการลบกิจกรรมปฏิทิน:", deleteCalendarResult);

                // ล้างข้อมูลกิจกรรมปฏิทินเดิมออกจาก editRentalData
                this.clearOldCalendarData();

                // ดำเนินการลบข้อมูลเดิมต่อไป
                this.deleteOldRentalAndContinue(bookingNumber, sheetID);
              })
              .withFailureHandler(error => {
                console.error("❌ ลบกิจกรรมปฏิทินไม่สำเร็จ:", error);

                // ล้างข้อมูลกิจกรรมปฏิทินเดิมออกจาก editRentalData (เพื่อไม่ให้เกิดปัญหาซ้ำ)
                this.clearOldCalendarData();

                // ดำเนินการลบข้อมูลเดิมต่อไปแม้ว่าจะลบกิจกรรมปฏิทินไม่สำเร็จ
                this.deleteOldRentalAndContinue(bookingNumber, sheetID);
              })
              .deleteCalendarEvent(this.editRentalData.IDกิจกรรมปฏิทิน, this.editRentalData.IDปฏิทิน, sheetID);
          } else {
            console.log("ℹ️ ไม่มีข้อมูลกิจกรรมปฏิทินเดิม หรือข้อมูลไม่ครบถ้วน - ข้ามการลบกิจกรรมปฏิทิน");

            // ล้างข้อมูลกิจกรรมปฏิทินเดิมออก (เผื่อมีข้อมูลผิดพลาด)
            this.clearOldCalendarData();

            // ดำเนินการลบข้อมูลเดิมได้เลย
            this.deleteOldRentalAndContinue(bookingNumber, sheetID);
          }
        },


        clearOldCalendarData() {
          console.log("🧹 ล้างข้อมูลกิจกรรมปฏิทินเดิม...");

          // ล้างข้อมูลกิจกรรมปฏิทินเดิมออก
          this.editRentalData.IDกิจกรรมปฏิทิน = '';
          this.editRentalData.IDปฏิทิน = '';
          this.editRentalData.ลิงก์ปฏิทิน = '';

          console.log("✅ ล้างข้อมูลกิจกรรมปฏิทินเดิมเสร็จแล้ว");
        },

        // เมธอดที่จะถูกเรียกหลังจากลบกิจกรรมปฏิทินเดิมแล้ว (หรือข้ามขั้นตอนนี้)
        deleteOldRentalAndContinue(bookingNumber, sheetID) {
          console.log("🔄 [deleteOldRentalAndContinue] เริ่มต้นการลบและอัพเดตรายการเช่า");
          console.log("📝 [deleteOldRentalAndContinue] Booking Number:", bookingNumber);
          console.log("📝 [deleteOldRentalAndContinue] Sheet ID:", sheetID);
          console.log("📊 [deleteOldRentalAndContinue] Current editRentalData:", {
            หมายเลขการจอง: this.editRentalData.หมายเลขการจอง,
            สร้างสัญญาเช่า: this.editRentalData.สร้างสัญญาเช่า,
            แก้ไขสัญญาเช่า: this.editRentalData.แก้ไขสัญญาเช่า,
            ลิงก์สัญญาเช่า: this.editRentalData.ลิงก์สัญญาเช่า ? "มีสัญญาเช่าเดิม" : "ไม่มีสัญญาเช่าเดิม"
          });

          this.contractLoadingStep = "กำลังลบข้อมูลรายการเช่าเดิม";
          this.contractLoadingProgress = 30;

          console.log("🗑️ [deleteOldRentalAndContinue] เรียกใช้ deleteRentalByBookingNumber...");

          // 1. ลบข้อมูลเดิมก่อน
          google.script.run
            .withSuccessHandler(deleteResult => {
              console.log("✅ [deleteOldRentalAndContinue] deleteRentalByBookingNumber สำเร็จ");
              console.log("📋 [deleteOldRentalAndContinue] Delete Result:", deleteResult);

              // อัพเดตสถานะ loading
              this.contractLoadingStep = "กำลังบันทึกข้อมูลใหม่";
              this.contractLoadingProgress = 40;

              // 2. หลังลบสำเร็จ ค่อยเพิ่มข้อมูลใหม่
              if (deleteResult.success) {
                console.log("🔍 [deleteOldRentalAndContinue] ตรวจสอบเงื่อนไขการสร้างสัญญาเช่า...");

                // ตรวจสอบว่ามีการเลือกสร้างสัญญาเช่าใหม่หรือไม่
                const shouldGenerateNewContract = this.editRentalData.สร้างสัญญาเช่า;
                const hasExistingContract = !!this.editRentalData.ลิงก์สัญญาเช่า;
                const isEditingContract = this.editRentalData.แก้ไขสัญญาเช่า;

                console.log("📊 [deleteOldRentalAndContinue] Contract Conditions:");
                console.log("  - shouldGenerateNewContract:", shouldGenerateNewContract);
                console.log("  - hasExistingContract:", hasExistingContract);
                console.log("  - isEditingContract:", isEditingContract);
                console.log("  - Existing Contract URL:", this.editRentalData.ลิงก์สัญญาเช่า || "N/A");

                // ถ้าเลือกสร้างสัญญาเช่าใหม่ แต่มีสัญญาเช่าเดิมอยู่แล้ว และกำลังแก้ไขสัญญาเช่า
                // ให้ลบสัญญาเช่าเดิมก่อนสร้างสัญญาใหม่
                if (shouldGenerateNewContract && hasExistingContract && isEditingContract) {
                  console.log("🗑️ [deleteOldRentalAndContinue] ต้องลบสัญญาเช่าเดิมก่อนสร้างใหม่");

                  // อัพเดตสถานะ loading
                  this.contractLoadingStep = "กำลังลบสัญญาเช่าเดิม";
                  this.contractLoadingProgress = 50;

                  // เก็บ URL ของสัญญาเช่าเดิมไว้ log
                  const oldContractUrl = this.editRentalData.ลิงก์สัญญาเช่า;
                  console.log("🔗 [deleteOldRentalAndContinue] ลิงก์สัญญาเช่าเดิมที่จะลบ:", oldContractUrl);

                  // ลบลิงก์สัญญาเช่าเดิมในข้อมูลที่จะบันทึก
                  delete this.editRentalData.ลิงก์สัญญาเช่า;
                  console.log("✂️ [deleteOldRentalAndContinue] ลบลิงก์สัญญาเช่าออกจาก editRentalData แล้ว");

                  console.log("🗑️ [deleteOldRentalAndContinue] เรียกใช้ deleteRentalContract...");

                  // ลบไฟล์สัญญาเช่าเดิมใน Google Drive
                  google.script.run
                    .withSuccessHandler(() => {
                      console.log("✅ [deleteOldRentalAndContinue] ลบสัญญาเช่าเดิมสำเร็จ");
                      console.log("➡️ [deleteOldRentalAndContinue] ดำเนินการต่อด้วย continueRentalUpdateWithAnimation");

                      // ดำเนินการต่อหลังจากลบสัญญาเช่าเดิมแล้ว
                      this.continueRentalUpdateWithAnimation(this.editRentalData);
                    })
                    .withFailureHandler(error => {
                      console.error("❌ [deleteOldRentalAndContinue] ลบสัญญาเช่าเดิมไม่สำเร็จ:", error);
                      console.log("⚠️ [deleteOldRentalAndContinue] ดำเนินการต่อถึงแม้จะลบสัญญาเช่าไม่สำเร็จ");

                      // ดำเนินการต่อถึงแม้จะลบไม่สำเร็จ
                      this.continueRentalUpdateWithAnimation(this.editRentalData);
                    })
                    .deleteRentalContract(bookingNumber, sheetID);
                } else {
                  console.log("⏩ [deleteOldRentalAndContinue] ไม่ต้องลบสัญญาเช่าเดิม - ดำเนินการต่อทันที");
                  console.log("🔄 [deleteOldRentalAndContinue] เหตุผล:", {
                    "ไม่ได้เลือกสร้างสัญญาใหม่": !shouldGenerateNewContract,
                    "ไม่มีสัญญาเดิม": !hasExistingContract,
                    "ไม่ได้แก้ไขสัญญา": !isEditingContract
                  });

                  // กรณีไม่ต้องลบสัญญาเช่าเดิม
                  this.continueRentalUpdateWithAnimation(this.editRentalData);
                }
              } else {
                console.error("❌ [deleteOldRentalAndContinue] ลบข้อมูลเดิมไม่สำเร็จ:", deleteResult.message);

                this.isContractGenerating = false; // ปิดการแสดง Loading
                this.showNotification('ลบข้อมูลเดิมไม่สำเร็จ: ' + deleteResult.message, 'error');
              }
            })
            .withFailureHandler(error => {
              console.error("💥 [deleteOldRentalAndContinue] deleteRentalByBookingNumber ล้มเหลว:", error);
              console.log("📍 [deleteOldRentalAndContinue] Parameters ที่ส่งไป:", {
                bookingNumber: bookingNumber,
                sheetID: sheetID
              });

              this.isContractGenerating = false; // ปิดการแสดง Loading
              this.showNotification('ลบข้อมูลเดิมไม่สำเร็จ: ' + error, 'error');
            })
            .deleteRentalByBookingNumber(bookingNumber, sheetID);
        },




        continueRentalUpdateWithAnimation(updatedRentalData) {
          // ใช้ Net Total (รวมภาษี) สำหรับบันทึก แต่หน้าจอยังแสดง Base Amount
          if (updatedRentalData.netTotal) {
            updatedRentalData.ค่าเช่ารวมทั้งหมด = updatedRentalData.netTotal;
          }

          // อัพเดตสถานะ loading
          this.contractLoadingStep = "กำลังบันทึกข้อมูลรายการเช่า";
          this.contractLoadingProgress = 60;
          const sheetID = localStorage.getItem('sheetID') || '';

          // สร้างรายการสำหรับตารางรับส่งรถ
          const pickupSchedule = {
            หมายเลขการจอง: updatedRentalData.หมายเลขการจอง,
            วันที่: updatedRentalData.วันที่เช่า,
            เวลา: updatedRentalData.เวลารับรถ,
            ชื่อลูกค้า: updatedRentalData.ชื่อลูกค้า,
            รถ: updatedRentalData.รถ,
            ประเภท: 'รับรถ',
            หมายเหตุ: updatedRentalData.หมายเหตุ
          };

          const returnSchedule = {
            หมายเลขการจอง: updatedRentalData.หมายเลขการจอง,
            วันที่: updatedRentalData.วันที่คืน,
            เวลา: updatedRentalData.เวลาคืนรถ,
            ชื่อลูกค้า: updatedRentalData.ชื่อลูกค้า,
            รถ: updatedRentalData.รถ,
            ประเภท: 'ส่งคืนรถ',
            หมายเหตุ: updatedRentalData.หมายเหตุ
          };

          // เพิ่มรายการเช่าใหม่
          google.script.run
            .withSuccessHandler(addResult => {
              if (addResult.success) {

                // ตรวจสอบว่าต้องการสร้างสัญญาเช่าใหม่หรือไม่
                if (updatedRentalData.สร้างสัญญาเช่า) {
                  // อัพเดตสถานะ loading
                  this.contractLoadingStep = "กำลังสร้างสัญญาเช่า";
                  this.contractLoadingProgress = 70;

                  // สร้างสัญญาเช่าใหม่
                  google.script.run
                    .withSuccessHandler(contractResult => {
                      if (contractResult.success) {
                        // อัพเดตสถานะ loading
                        this.contractLoadingStep = "กำลังบันทึกสัญญาเช่า";
                        this.contractLoadingProgress = 75;

                        // อัพเดตลิงก์สัญญาเช่าในรายการเช่า
                        google.script.run
                          .withSuccessHandler(() => {
                            // อัพเดตสถานะเป็นกำลังสร้างกิจกรรมในปฏิทิน
                            this.contractLoadingStep = "กำลังสร้างกิจกรรมในปฏิทิน";
                            this.contractLoadingProgress = 80;

                            // เพิ่มกิจกรรมในปฏิทิน
                            updatedRentalData.ลิงก์สัญญาเช่า = contractResult.pdfUrl;

                            google.script.run
                              .withSuccessHandler(calendarResult => {
                                if (calendarResult.success) {
                                  // เก็บข้อมูลปฏิทิน
                                  updatedRentalData.ลิงก์ปฏิทิน = calendarResult.eventUrl;
                                  updatedRentalData.IDกิจกรรมปฏิทิน = calendarResult.eventId;
                                  updatedRentalData.IDปฏิทิน = calendarResult.calendarId;

                                  // อัพเดตข้อมูลปฏิทินในรายการเช่า
                                  google.script.run
                                    .withSuccessHandler(() => {
                                      // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไป
                                      this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                                    })
                                    .withFailureHandler(error => {
                                      console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", error);
                                      // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไปแม้ว่าจะอัพเดตข้อมูลปฏิทินไม่สำเร็จ
                                      this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                                    })
                                    .updateRentalCalendarInfo(updatedRentalData.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                                } else {
                                  console.log("ไม่สามารถสร้างกิจกรรมในปฏิทินได้:", calendarResult.message);
                                  // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไป
                                  this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                                }
                              })
                              .withFailureHandler(error => {
                                console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
                                // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไป
                                this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                              })
                              .createCalendarEventForRental(updatedRentalData, sheetID);
                          })
                          .withFailureHandler(error => {
                            console.error("อัพเดตลิงก์สัญญาเช่าไม่สำเร็จ:", error);

                            // อัพเดตสถานะเป็นกำลังสร้างกิจกรรมในปฏิทิน
                            this.contractLoadingStep = "กำลังสร้างกิจกรรมในปฏิทิน";
                            this.contractLoadingProgress = 80;

                            // เพิ่มรายการในตารางรับส่งรถ แม้อัพเดตลิงก์ไม่สำเร็จ
                            updatedRentalData.ลิงก์สัญญาเช่า = contractResult.pdfUrl;

                            google.script.run
                              .withSuccessHandler(calendarResult => {
                                if (calendarResult.success) {
                                  // เก็บข้อมูลปฏิทิน
                                  updatedRentalData.ลิงก์ปฏิทิน = calendarResult.eventUrl;
                                  updatedRentalData.IDกิจกรรมปฏิทิน = calendarResult.eventId;
                                  updatedRentalData.IDปฏิทิน = calendarResult.calendarId;

                                  // อัพเดตข้อมูลปฏิทินในรายการเช่า
                                  google.script.run
                                    .withSuccessHandler(() => {
                                      // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไป
                                      this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                                    })
                                    .withFailureHandler(updateError => {
                                      console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", updateError);
                                      // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไปแม้ว่าจะอัพเดตข้อมูลปฏิทินไม่สำเร็จ
                                      this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                                    })
                                    .updateRentalCalendarInfo(updatedRentalData.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                                } else {
                                  console.log("ไม่สามารถสร้างกิจกรรมในปฏิทินได้:", calendarResult.message);
                                  // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไป
                                  this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                                }
                              })
                              .withFailureHandler(calendarError => {
                                console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", calendarError);
                                // ดำเนินการเพิ่มรายการในตารางรับส่งรถต่อไป
                                this.addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractResult.pdfUrl, updatedRentalData);
                              })
                              .createCalendarEventForRental(updatedRentalData, sheetID);
                          })
                          .updateRentalContract(updatedRentalData.หมายเลขการจอง, contractResult.pdfUrl, sheetID);
                      } else {
                        // สร้างสัญญาเช่าไม่สำเร็จ แต่อัพเดตรายการเช่าสำเร็จแล้ว
                        this.contractLoadingStep = "กำลังสร้างกิจกรรมในปฏิทิน";
                        this.contractLoadingProgress = 80;

                        // เพิ่มกิจกรรมในปฏิทิน แม้ว่าจะสร้างสัญญาเช่าไม่สำเร็จ
                        google.script.run
                          .withSuccessHandler(calendarResult => {
                            if (calendarResult.success) {
                              // เก็บข้อมูลปฏิทิน
                              updatedRentalData.ลิงก์ปฏิทิน = calendarResult.eventUrl;
                              updatedRentalData.IDกิจกรรมปฏิทิน = calendarResult.eventId;
                              updatedRentalData.IDปฏิทิน = calendarResult.calendarId;

                              // อัพเดตข้อมูลปฏิทินในรายการเช่า
                              google.script.run
                                .withSuccessHandler(() => {
                                  // ดำเนินการต่อไป
                                  this.isContractGenerating = false; // ปิดการแสดง Loading
                                  this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                                  this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                                })
                                .withFailureHandler(error => {
                                  console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", error);
                                  this.isContractGenerating = false; // ปิดการแสดง Loading
                                  this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                                  this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                                })
                                .updateRentalCalendarInfo(updatedRentalData.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                            } else {
                              this.isContractGenerating = false; // ปิดการแสดง Loading
                              this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                              this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                            }
                          })
                          .withFailureHandler(error => {
                            this.isContractGenerating = false; // ปิดการแสดง Loading
                            this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                            this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                          })
                          .createCalendarEventForRental(updatedRentalData, sheetID);
                      }
                    })
                    .withFailureHandler(error => {
                      this.contractLoadingStep = "กำลังสร้างกิจกรรมในปฏิทิน";
                      this.contractLoadingProgress = 80;

                      // เพิ่มกิจกรรมในปฏิทิน แม้ว่าจะสร้างสัญญาเช่าไม่สำเร็จ
                      google.script.run
                        .withSuccessHandler(calendarResult => {
                          if (calendarResult.success) {
                            // เก็บข้อมูลปฏิทิน
                            updatedRentalData.ลิงก์ปฏิทิน = calendarResult.eventUrl;
                            updatedRentalData.IDกิจกรรมปฏิทิน = calendarResult.eventId;
                            updatedRentalData.IDปฏิทิน = calendarResult.calendarId;

                            // อัพเดตข้อมูลปฏิทินในรายการเช่า
                            google.script.run
                              .withSuccessHandler(() => {
                                this.isContractGenerating = false; // ปิดการแสดง Loading
                                this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                                this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                              })
                              .withFailureHandler(updateError => {
                                console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", updateError);
                                this.isContractGenerating = false; // ปิดการแสดง Loading
                                this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                                this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                              })
                              .updateRentalCalendarInfo(updatedRentalData.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                          } else {
                            this.isContractGenerating = false; // ปิดการแสดง Loading
                            this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                            this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                          }
                        })
                        .withFailureHandler(calendarError => {
                          this.isContractGenerating = false; // ปิดการแสดง Loading
                          this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + error, 'warning');
                          this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                        })
                        .createCalendarEventForRental(updatedRentalData, sheetID);
                    })
                    .generateRentalContract(updatedRentalData.หมายเลขการจอง, updatedRentalData.ภาษาสัญญาเช่า, sheetID);
                } else {
                  // ไม่ต้องสร้างสัญญาเช่าใหม่
                  // อัพเดตสถานะ loading
                  this.contractLoadingStep = "กำลังสร้างกิจกรรมในปฏิทิน";
                  this.contractLoadingProgress = 80;

                  // สร้างกิจกรรมในปฏิทิน
                  google.script.run
                    .withSuccessHandler(calendarResult => {
                      if (calendarResult.success) {
                        // เก็บข้อมูลปฏิทิน
                        updatedRentalData.ลิงก์ปฏิทิน = calendarResult.eventUrl;
                        updatedRentalData.IDกิจกรรมปฏิทิน = calendarResult.eventId;
                        updatedRentalData.IDปฏิทิน = calendarResult.calendarId;

                        // อัพเดตข้อมูลปฏิทินในรายการเช่า
                        google.script.run
                          .withSuccessHandler(() => {
                            // อัพเดตสถานะ loading
                            this.contractLoadingStep = "กำลังปรับปรุงตารางรับรถ";
                            this.contractLoadingProgress = 85;

                            // เพิ่มรายการในตารางรับส่งรถ
                            this.addScheduleItemsForUpdateWithoutAnimation(pickupSchedule, returnSchedule, updatedRentalData);
                          })
                          .withFailureHandler(error => {
                            console.error("อัพเดตข้อมูลปฏิทินไม่สำเร็จ:", error);
                            // อัพเดตสถานะ loading
                            this.contractLoadingStep = "กำลังปรับปรุงตารางรับรถ";
                            this.contractLoadingProgress = 85;

                            // เพิ่มรายการในตารางรับส่งรถแม้อัพเดตข้อมูลปฏิทินไม่สำเร็จ
                            this.addScheduleItemsForUpdateWithoutAnimation(pickupSchedule, returnSchedule, updatedRentalData);
                          })
                          .updateRentalCalendarInfo(updatedRentalData.หมายเลขการจอง, calendarResult.eventUrl, calendarResult.eventId, calendarResult.calendarId, sheetID);
                      } else {
                        console.log("ไม่สามารถสร้างกิจกรรมในปฏิทินได้:", calendarResult.message);
                        // อัพเดตสถานะ loading
                        this.contractLoadingStep = "กำลังปรับปรุงตารางรับรถ";
                        this.contractLoadingProgress = 85;

                        // เพิ่มรายการในตารางรับส่งรถ
                        this.addScheduleItemsForUpdateWithoutAnimation(pickupSchedule, returnSchedule, updatedRentalData);
                      }
                    })
                    .withFailureHandler(error => {
                      console.error("การสร้างกิจกรรมในปฏิทินล้มเหลว:", error);
                      // อัพเดตสถานะ loading
                      this.contractLoadingStep = "กำลังปรับปรุงตารางรับรถ";
                      this.contractLoadingProgress = 85;

                      // เพิ่มรายการในตารางรับส่งรถแม้สร้างกิจกรรมปฏิทินไม่สำเร็จ
                      this.addScheduleItemsForUpdateWithoutAnimation(pickupSchedule, returnSchedule, updatedRentalData);
                    })
                    .createCalendarEventForRental(updatedRentalData, sheetID);
                }
              } else {
                this.isContractGenerating = false; // ปิดการแสดง Loading
                this.showNotification('เพิ่มรายการเช่าไม่สำเร็จ: ' + addResult.message, 'error');
              }
            })
            .withFailureHandler(error => {
              this.isContractGenerating = false; // ปิดการแสดง Loading
              this.showNotification('เพิ่มรายการเช่าไม่สำเร็จ: ' + error, 'error');
            })
            .addNewRental(updatedRentalData, sheetID);
        },





        // เพิ่มรายการในตารางรับส่งรถหลังจากสร้างสัญญาเช่าใหม่ พร้อม Animation
        addScheduleItemsForUpdateWithAnimation(pickupSchedule, returnSchedule, contractUrl, updatedRentalData) {
          const sheetID = localStorage.getItem('sheetID') || '';
          // อัพเดตสถานะ loading
          this.contractLoadingStep = "กำลังปรับปรุงตารางรับรถ";
          this.contractLoadingProgress = 85;

          google.script.run
            .withSuccessHandler(() => {
              // อัพเดตสถานะ loading
              this.contractLoadingStep = "กำลังปรับปรุงตารางคืนรถ";
              this.contractLoadingProgress = 95;

              google.script.run
                .withSuccessHandler(() => {
                  // อัพเดตสถานะ loading
                  this.contractLoadingStep = "เสร็จสิ้น";
                  this.contractLoadingProgress = 100;

                  // หน่วงเวลาสักครู่ก่อนปิดหน้า Loading เพื่อให้ผู้ใช้เห็นว่าทำงานเสร็จแล้ว
                  setTimeout(() => {
                    this.isContractGenerating = false; // ปิดการแสดง Loading

                    // เก็บข้อมูลรายการเช่าที่อัพเดตแล้ว
                    updatedRentalData.ลิงก์สัญญาเช่า = contractUrl;

                    // แสดงข้อความสรุปที่แปลแล้ว
                    this.showTranslatedSummary(updatedRentalData, contractUrl);

                    // โหลดข้อมูลใหม่
                    // this.loadRentals();
                    // this.fetchScheduleForDate();
                  }, 500);
                })
                .withFailureHandler(error => {
                  this.isContractGenerating = false; // ปิดการแสดง Loading
                  this.showNotification('อัพเดตรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'warning');

                  // โหลดข้อมูลใหม่
                  // this.loadRentals();
                  // this.fetchScheduleForDate();
                })
                .addScheduleItem(returnSchedule, sheetID);
            })
            .withFailureHandler(error => {
              this.isContractGenerating = false; // ปิดการแสดง Loading
              this.showNotification('อัพเดตรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'warning');

              // โหลดข้อมูลใหม่
              // this.loadRentals();
              // this.fetchScheduleForDate();
            })
            .addScheduleItem(pickupSchedule, sheetID);
        },



        // เพิ่มรายการในตารางรับส่งรถโดยไม่มีการสร้างสัญญาเช่าใหม่ แต่มี Animation
        addScheduleItemsForUpdateWithoutAnimation(pickupSchedule, returnSchedule, updatedRentalData) {
          // อัพเดตสถานะ loading
          this.contractLoadingStep = "กำลังปรับปรุงตารางรับรถ";
          this.contractLoadingProgress = 85;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(() => {
              // อัพเดตสถานะ loading
              this.contractLoadingStep = "กำลังปรับปรุงตารางคืนรถ";
              this.contractLoadingProgress = 95;

              google.script.run
                .withSuccessHandler(() => {
                  // อัพเดตสถานะ loading
                  this.contractLoadingStep = "เสร็จสิ้น";
                  this.contractLoadingProgress = 100;

                  // หน่วงเวลาสักครู่ก่อนปิดหน้า Loading เพื่อให้ผู้ใช้เห็นว่าทำงานเสร็จแล้ว
                  setTimeout(() => {
                    this.isContractGenerating = false; // ปิดการแสดง Loading

                    // แสดงข้อความสรุปที่แปลแล้ว (ถ้ามีลิงก์สัญญาเช่าเดิม)
                    if (updatedRentalData.ลิงก์สัญญาเช่า) {
                      this.showTranslatedSummary(updatedRentalData, updatedRentalData.ลิงก์สัญญาเช่า);
                    } else {
                      // ✅ แก้ไข: แสดง Success Modal แทน showNotification
                      this.successRentalData = JSON.parse(JSON.stringify(updatedRentalData));
                      this.showRentalSuccessModal = true;
                    }
                  }, 500);
                })
                .withFailureHandler(error => {
                  this.isContractGenerating = false; // ปิดการแสดง Loading
                  this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'warning');

                  // โหลดข้อมูลใหม่
                  // this.loadRentals();
                  // this.fetchScheduleForDate();
                })
                .addScheduleItem(returnSchedule, sheetID);
            })
            .withFailureHandler(error => {
              this.isContractGenerating = false; // ปิดการแสดง Loading
              this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'warning');

              // โหลดข้อมูลใหม่
              // this.loadRentals();
              // this.fetchScheduleForDate();
            })
            .addScheduleItem(pickupSchedule, sheetID);
        },







        showTranslatedSummary(rentalData, contractUrl) {
          // ✅ อัพเดท ReceiptInfo จาก top-level fields ก่อนสร้างข้อความสรุป
          // เพื่อให้แน่ใจว่าใช้ข้อมูลล่าสุดที่ผู้ใช้แก้ไข ไม่ใช่ข้อมูลเก่าใน ReceiptInfo string
          if (rentalData.wantsTaxInvoice !== undefined || rentalData.wantsCashBill !== undefined) {
            rentalData.ReceiptInfo = JSON.stringify({
              wantsCashBill: rentalData.wantsCashBill || false,
              wantsTaxInvoice: rentalData.wantsTaxInvoice || false,
              wantsWHT: rentalData.wantsWHT || false,
              whtPercentage: rentalData.whtPercentage || 0,
              whtAmount: rentalData.whtAmount || 0,
              whtBaseAmount: rentalData.whtBaseAmount || 0,
              taxInvoiceAmountExVAT: rentalData.taxInvoiceAmountExVAT || 0,
              taxInvoiceVATAmount: rentalData.taxInvoiceVATAmount || 0,
              taxInvoiceTotal: rentalData.taxInvoiceTotal || 0,
              additionalServiceIncludeVAT: rentalData.additionalServiceIncludeVAT !== false,
              additionalServiceIncludeWHT: rentalData.additionalServiceIncludeWHT !== false,
              carSeatIncludeVAT: rentalData.carSeatIncludeVAT !== false,
              carSeatIncludeWHT: rentalData.carSeatIncludeWHT !== false,
              insuranceIncludeVAT: rentalData.insuranceIncludeVAT || false,
              insuranceIncludeWHT: rentalData.insuranceIncludeWHT || false
            });
          }

          // ใช้ generateSummary เพื่อสร้าง summaryText
          const summaryText = this.generateSummary(rentalData);

          // กำหนดภาษาที่ใช้ - ใช้ภาษาเดียวกับสัญญาเช่า
          const language = rentalData.ภาษาสัญญาเช่า || 'th';

          // สร้างตัวแปรที่จะเก็บข้อมูลการดำเนินการต่างๆ
          let documentOpened = false;

          // แสดง SweetAlert2 พร้อมข้อความสรุป
          Swal.fire({
            title: 'รายการเช่าถูกบันทึกเรียบร้อย',
            html: `
    <div class="text-left">
      <div class="mb-4 p-4 bg-gray-50 rounded-lg border overflow-auto" style="max-height: 300px;">
        <pre class="whitespace-pre-wrap text-sm">${summaryText}</pre>
      </div>
      
      <textarea id="summaryTextForCopy" class="hidden">${summaryText}</textarea>
      
      <div class="text-center">
        <p id="actionStatus" class="text-sm text-gray-500 mb-3">คุณสามารถ${contractUrl ? 'คัดลอกข้อความหรือดูสัญญาเช่า' : 'คัดลอกข้อความ'}ได้</p>
      </div>
    </div>
    `,
            icon: 'success',
            showCloseButton: true,
            showDenyButton: contractUrl ? true : false,  // แสดงปุ่มที่สองเฉพาะเมื่อมีลิงก์สัญญาเช่า
            showCancelButton: true,
            focusConfirm: false,
            confirmButtonText: `<i class="fas fa-copy mr-2"></i>คัดลอกข้อความ`,
            denyButtonText: `<i class="fas fa-file-pdf mr-2"></i>ดูสัญญาเช่า`,
            cancelButtonText: `<i class="fas fa-times mr-2"></i>ปิด`,
            confirmButtonColor: '#3085d6',
            denyButtonColor: '#d33',
            cancelButtonColor: '#6B7280',
            allowOutsideClick: false,

            didOpen: () => {
              // เพิ่ม Event listener ให้กับปุ่ม Confirm เพื่อจัดการการคัดลอกข้อความ
              const confirmButton = Swal.getConfirmButton();
              if (confirmButton) {
                confirmButton.addEventListener('click', (e) => {
                  e.stopPropagation(); // ป้องกันการปิด modal

                  // คัดลอกข้อความไปยังคลิปบอร์ด
                  const textarea = document.getElementById('summaryTextForCopy');
                  if (textarea) {
                    textarea.classList.remove('hidden');
                    textarea.select();
                    document.execCommand('copy');
                    textarea.classList.add('hidden');

                    // แสดงข้อความว่าคัดลอกแล้วในหน้าต่างเดิม
                    const statusElement = document.getElementById('actionStatus');
                    if (statusElement) {
                      // เก็บข้อความเดิมไว้
                      const originalText = statusElement.innerHTML;

                      // แสดงข้อความคัดลอกสำเร็จ พร้อมไอคอนและเอฟเฟค
                      statusElement.innerHTML = `
                <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full animate-pulse">
                  <i class="fas fa-check-circle mr-1"></i> คัดลอกข้อความไปยังคลิปบอร์ดแล้ว
                </span>
              `;

                      // คืนค่าข้อความเดิมหลังจาก 3 วินาที
                      setTimeout(() => {
                        statusElement.innerHTML = originalText;
                      }, 3000);
                    }

                    return false; // ป้องกันไม่ให้ modal ปิด
                  }
                });
              }

              // เพิ่ม Event listener ให้กับปุ่ม Deny (ดูสัญญาเช่า) เพื่อป้องกันไม่ให้ modal ปิด
              const denyButton = Swal.getDenyButton();
              if (denyButton && contractUrl) {
                denyButton.addEventListener('click', (e) => {
                  e.stopPropagation(); // ป้องกันการปิด modal

                  // เปิดสัญญาเช่าในแท็บใหม่
                  window.open(contractUrl, '_blank');

                  // ทำเครื่องหมายว่าได้เปิดเอกสารแล้ว
                  documentOpened = true;

                  // แสดงข้อความว่าได้เปิดเอกสารแล้วในหน้าต่างเดิม
                  const statusElement = document.getElementById('actionStatus');
                  if (statusElement) {
                    // เก็บข้อความเดิมไว้
                    const originalText = statusElement.innerHTML;

                    // แสดงข้อความเปิดเอกสารสำเร็จ
                    statusElement.innerHTML = `
              <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full animate-pulse">
                <i class="fas fa-external-link-alt mr-1"></i> กำลังเปิดเอกสารในแท็บใหม่
              </span>
            `;

                    // คืนค่าข้อความเดิมหลังจาก 3 วินาที
                    setTimeout(() => {
                      statusElement.innerHTML = originalText;
                    }, 3000);
                  }

                  return false; // ป้องกันไม่ให้ modal ปิด
                });
              }
            },

            preConfirm: () => {
              // เพื่อป้องกันการปิด Modal เมื่อกดปุ่ม Confirm
              return false;
            },

            preDeny: () => {
              // เพื่อป้องกันการปิด Modal เมื่อกดปุ่ม Deny
              return false;
            }
          });
        },




        // ส่วนหนึ่งของกระบวนการแก้ไขรายการเช่า
        continueRentalUpdate(updatedRentalData) {
          const pickupSchedule = { /* ...ข้อมูล... */ };
          const returnSchedule = { /* ...ข้อมูล... */ };
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(addResult => {
              if (addResult.success) {
                if (updatedRentalData.สร้างสัญญาเช่า) {
                  google.script.run
                    .withSuccessHandler(contractResult => {
                      if (contractResult.success) {
                        google.script.run
                          .withSuccessHandler(() => {
                            // === จุดที่แก้ไข ===
                            this.addScheduleItemsForUpdate(pickupSchedule, returnSchedule, contractResult.pdfUrl);
                            // =================
                          })
                          .updateRentalContract(updatedRentalData.หมายเลขการจอง, contractResult.pdfUrl, sheetID);
                      } else {
                        this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่ไม่สามารถสร้างสัญญาเช่าได้: ' + contractResult.message, 'warning');
                        this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                      }
                    })
                  //...
                } else {
                  // === จุดที่แก้ไข ===
                  this.addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule);
                  // =================
                }
              } else {
                this.showNotification('เพิ่มรายการเช่าไม่สำเร็จ: ' + addResult.message, 'error');
                this.isLoading = false;
              }
            })
            .addNewRental(updatedRentalData, sheetID);
        },






        // เพิ่มรายการในตารางรับส่งรถหลังจากสร้างสัญญาเช่าใหม่
        addScheduleItemsForUpdate(pickupSchedule, returnSchedule, contractUrl) {
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(() => {
              google.script.run
                .withSuccessHandler(() => {
                  Swal.fire({
                    title: 'อัพเดตรายการเช่าสำเร็จ',
                    html: 'บันทึกการแก้ไขข้อมูลและสร้างสัญญาเช่าเรียบร้อยแล้ว',
                    icon: 'success',
                    confirmButtonText: 'ดูสัญญาเช่า',
                    showCancelButton: true,
                    cancelButtonText: 'ปิด'
                  }).then((result) => {
                    if (result.isConfirmed && contractUrl) {
                      window.open(contractUrl, '_blank');
                    }
                    this.closeRentalModal();
                    // this.loadRentals();
                    // this.fetchScheduleForDate();
                    this.isLoading = false;
                  });
                })
                .withFailureHandler(error => {
                  this.showNotification('อัพเดตรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'warning');
                  this.closeRentalModal();
                  // this.loadRentals();
                  // this.fetchScheduleForDate();
                  this.isLoading = false;
                })
                .addScheduleItem(returnSchedule, sheetID);
            })
            .withFailureHandler(error => {
              this.showNotification('อัพเดตรายการเช่าและสร้างสัญญาเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'warning');
              this.closeRentalModal();
              // this.loadRentals();
              // this.fetchScheduleForDate();
              this.isLoading = false;
            })
            .addScheduleItem(pickupSchedule, sheetID);
        },

        // เพิ่มรายการในตารางรับส่งรถโดยไม่มีการสร้างสัญญาเช่าใหม่
        // เพิ่มรายการในตารางรับส่งรถโดยไม่มีการสร้างสัญญาเช่าใหม่
        addScheduleItemsForUpdateWithoutContract(pickupSchedule, returnSchedule) {
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(() => {
              google.script.run
                .withSuccessHandler(() => {
                  this.isContractGenerating = false; // ปิดการแสดง Loading
                  this.showNotification('อัพเดตรายการเช่าสำเร็จ');
                  // โหลดข้อมูลใหม่
                  // this.loadRentals();
                  // this.fetchScheduleForDate();
                })
                .withFailureHandler(error => {
                  this.isContractGenerating = false; // ปิดการแสดง Loading
                  this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการคืนรถ: ' + error, 'error');
                  // โหลดข้อมูลใหม่
                  // this.loadRentals();
                  // this.fetchScheduleForDate();
                })
                .addScheduleItem(returnSchedule, sheetID);
            })
            .withFailureHandler(error => {
              this.isContractGenerating = false; // ปิดการแสดง Loading
              this.showNotification('อัพเดตรายการเช่าสำเร็จ แต่เกิดข้อผิดพลาดในการเพิ่มรายการรับรถ: ' + error, 'error');
              // โหลดข้อมูลใหม่
              // this.loadRentals();
              // this.fetchScheduleForDate();
            })
            .addScheduleItem(pickupSchedule, sheetID);
        },


        // ฟังก์ชันสำหรับ initialize ค่า default จาก config หลังจาก loadConfig เสร็จ
        initializeNewRentalDefaults() {
          // ตั้งค่า checkbox สำหรับการนำค่าไปคำนวณ VAT/WHT
          this.newRental.additionalServiceIncludeVAT = (this.config && this.config.additionalServiceIncludeVAT !== undefined) ? this.config.additionalServiceIncludeVAT : false;
          this.newRental.additionalServiceIncludeWHT = (this.config && this.config.additionalServiceIncludeWHT !== undefined) ? this.config.additionalServiceIncludeWHT : false;
          this.newRental.carSeatIncludeVAT = (this.config && this.config.carSeatIncludeVAT !== undefined) ? this.config.carSeatIncludeVAT : false;
          this.newRental.carSeatIncludeWHT = (this.config && this.config.carSeatIncludeWHT !== undefined) ? this.config.carSeatIncludeWHT : false;
          this.newRental.insuranceIncludeVAT = (this.config && this.config.insuranceIncludeVAT !== undefined) ? this.config.insuranceIncludeVAT : false;
          this.newRental.insuranceIncludeWHT = (this.config && this.config.insuranceIncludeWHT !== undefined) ? this.config.insuranceIncludeWHT : false;

          // ตั้งค่าเปอร์เซ็นต์หัก ณ ที่จ่าย
          this.newRental.whtPercentage = (this.config && this.config.defaultWHTPercentage !== undefined) ? this.config.defaultWHTPercentage : 3;
        },

        resetNewRentalForm() {
          this.newRental = {
            ช่องทางการจอง: '',
            หมายเลขการจอง: '',
            ชื่อลูกค้า: '',
            เบอร์โทรศัพท์: '',
            รถ: '',
            ทะเบียนรถ: '',
            วันที่เช่า: new Date().toISOString().slice(0, 10),
            วันที่คืน: '',
            เวลารับรถ: '08:00',
            เวลาคืนรถ: '08:00',
            ราคา: '',
            สถานะ: 'จอง',
            หมายเหตุ: '',
            สร้างสัญญาเช่า: true,
            ภาษาสัญญาเช่า: 'th',
            ลิงก์สัญญาเช่า: '',
            สถานที่รับรถ: '',
            สถานที่คืนรถ: '',
            ค่าเช่ารวมทั้งหมด: '',
            // ดึงค่าตั้งต้นจากการตั้งค่าระบบมาใช้ (ถ้ามี)
            ค่ามัดจำคิวรถ: (this.config && this.config.ค่ามัดจำคิวรถเริ่มต้น !== undefined) ? this.config.ค่ามัดจำคิวรถเริ่มต้น : '',
            เงินประกันความเสียหาย: (this.config && this.config.เงินประกันความเสียหายเริ่มต้น !== undefined) ? this.config.เงินประกันความเสียหายเริ่มต้น : '',
            ค่าบริการเพิ่มเติม: '',
            รวมยอดชำระวันรับรถ: '',
            เลขบัตรประชาชน: '',
            หมายเลขใบขับขี่: '',
            // วันเดือนปีเกิด: '',
            ที่อยู่ลูกค้า: '',
            // คาร์ซีท
            ต้องการคาร์ซีท: false,
            คาร์ซีทมีค่าบริการ: 'false',
            ค่าคาร์ซีท: 0,
            // ประกันเสริม
            ต้องการประกันเสริม: false,
            จำนวนวันประกันเสริม: 0,
            ราคาประกันเสริมต่อวัน: 0,
            ค่าประกันเสริมรวม: 0,
            // Checkbox สำหรับการนำค่าไปคำนวณ VAT/WHT (ดึงค่าจาก config)
            additionalServiceIncludeVAT: (this.config && this.config.additionalServiceIncludeVAT !== undefined) ? this.config.additionalServiceIncludeVAT : false,
            additionalServiceIncludeWHT: (this.config && this.config.additionalServiceIncludeWHT !== undefined) ? this.config.additionalServiceIncludeWHT : false,
            carSeatIncludeVAT: (this.config && this.config.carSeatIncludeVAT !== undefined) ? this.config.carSeatIncludeVAT : false,
            carSeatIncludeWHT: (this.config && this.config.carSeatIncludeWHT !== undefined) ? this.config.carSeatIncludeWHT : false,
            insuranceIncludeVAT: (this.config && this.config.insuranceIncludeVAT !== undefined) ? this.config.insuranceIncludeVAT : false,
            insuranceIncludeWHT: (this.config && this.config.insuranceIncludeWHT !== undefined) ? this.config.insuranceIncludeWHT : false,
            // เปอร์เซ็นต์หัก ณ ที่จ่าย (ดึงค่าจาก config)
            whtPercentage: (this.config && this.config.defaultWHTPercentage !== undefined) ? this.config.defaultWHTPercentage : 3
          };

          // รีเซ็ตเฉพาะสถานะการสร้างหมายเลขการจองอัตโนมัติ
          this.autoGenerateBookingNumber = true;


          // รีเซ็ตตัวแปรโหมดไม่ระบุรถ
          this.unspecifiedVehicleMode = false;
          this.unspecifiedVehicleName = '';
          this.showUnspecifiedModeInfo = false;

          // --- รีเซ็ตข้อความสรุปรายการเช่า ---
          const rentalSummaryTextarea = document.getElementById('rentalSummaryText');
          if (rentalSummaryTextarea) {
            rentalSummaryTextarea.value = '';
          }

          // ซ่อนส่วนสรุปรายการเช่า
          this.showSummarySection = false;

          // สร้างหมายเลขการจองใหม่
          this.generateBookingNumberIfNeeded();

          this.$nextTick(() => {
            this.updateRentalDurationDisplay();
          });

        },

        // บันทึกการตั้งค่า
        saveConfig() {
          // 🟡 1. ตรวจสอบ Prefix
          if (!this.isValidPrefix) {
            this.showNotification('กรุณาใช้ตัวอักษรภาษาอังกฤษพิมพ์ใหญ่เท่านั้น ไม่เกิน 2 ตัวสำหรับคำนำหน้าหมายเลขการจอง', 'warning');
            return;
          }

          this.isLoading = true;

          // 🟢 2. แทรกค่าคอมมิชชั่นลงใน config ก่อนส่ง
          this.config["ค่าคอมมิชชั่นหลายรายการ"] = JSON.stringify(this.commissionList);

          // 🔵 3. เตรียม configData ทั้งหมด (ไม่รวม LINEBotSecretID เพราะบันทึกที่ Master Sheet แยก)
          const configToSave = { ...this.config };
          delete configToSave.LINEBotSecretID; // ลบออกเพราะบันทึกที่ Master Sheet แทน

          const configData = {
            config: configToSave,
            userPermissions: this.userPermissions,
            rolePermissions: this.rolePermissions,
            roleNames: this.roleNames,
            roleDescriptions: this.roleDescriptions
          };
          const sheetID = localStorage.getItem('sheetID') || '';

          // 🟣 4. เรียก backend
          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;

              if (result.success) {
                this.showNotification('บันทึกการตั้งค่าเรียบร้อย', 'success');

                // 🔄 sync userPermissions หากมี
                if (this.rolePermissions['user']) {
                  this.userPermissions = { ...this.rolePermissions['user'] };
                }
              } else {
                this.showNotification('ไม่สามารถบันทึกการตั้งค่าได้: ' + result.message, 'error');
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
            })
            .updateSystemConfig(configData, sheetID);
        },

        // ฟังก์ชันสำหรับบันทึกข้อมูลกลุ่มและสิทธิ์
        saveRoleData() {
          const roleData = {
            rolePermissions: this.rolePermissions,
            roleNames: this.roleNames,
            roleDescriptions: this.roleDescriptions
          };
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                console.log("บันทึกข้อมูลกลุ่มผู้ใช้เรียบร้อย");

                // อัปเดต userPermissions ให้ตรงกับ rolePermissions['user'] ด้วย
                if (this.rolePermissions['user']) {
                  this.userPermissions = { ...this.rolePermissions['user'] };
                }
              } else {
                console.error("บันทึกข้อมูลกลุ่มผู้ใช้ไม่สำเร็จ:", result.message);
              }
            })
            .withFailureHandler(error => {
              console.error("เกิดข้อผิดพลาดในการบันทึกข้อมูลกลุ่ม:", error);
            })
            .saveRoleData(roleData, sheetID);
        },



        // ฟังก์ชันลบรายการเช่า
        deleteRentalItem(rental) {
          // console.log("ข้อมูลที่จะลบ:", rental);
          const sheetID = localStorage.getItem('sheetID') || '';
          if (!rental || !rental.หมายเลขการจอง) {
            Swal.fire({
              title: 'เกิดข้อผิดพลาด!',
              text: 'ไม่พบข้อมูลหมายเลขการจองที่ต้องการลบ',
              icon: 'error',
              confirmButtonText: 'ตกลง'
            });
            return;
          }

          Swal.fire({
            title: 'ยืนยันการลบรายการเช่า',
            html: `
            <div style="text-align: left; margin: 20px 0;">
                <p><strong>หมายเลขการจอง:</strong> <span style="font-weight: bold; color: #dc3545;">${rental.หมายเลขการจอง}</span></p>
                <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin: 15px 0;">
                    <p style="margin: 0; color: #856404;"><strong>⚠️ คำเตือน:</strong></p>
                    <ul style="margin: 10px 0; color: #856404; text-align: left;">
                        <li><strong>การลบข้อมูล:</strong> ข้อมูลทุกอย่างที่เกี่ยวกับหมายเลขการจองนี้จะถูกลบทั้งหมด</li>
                        <li><strong>รวมถึง:</strong> รายการเช่า, ตารางรับส่งรถ, ข้อมูลการเงิน, กิจกรรมปฏิทิน, และไฟล์เอกสาร</li>
                    </ul>
                </div>
                <div style="background-color: #ffffff; border: 1px solid #bee5eb; border-radius: 5px; padding: 10px; margin: 10px 0;">
                    <p style="margin: 0; color: #28a745;"><strong>💡 <span style="color: #28a745;">หากต้องการแก้ไขข้อมูล:</span></strong> ให้ใช้ฟังก์ชั่น "แก้ไขข้อมูล" แทนการลบ</p>
                </div>
            </div>
        `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบทั้งหมด!',
            cancelButtonText: 'ยกเลิก',
            width: '600px'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isLoading = true;

              google.script.run
                .withSuccessHandler(result => {
                  this.isLoading = false; // ปิด loading เสมอ

                  // เพิ่ม debug log เพื่อดู result ที่ได้รับ
                  console.log("🎯 [deleteRentalItem] ได้รับผลลัพธ์จาก deleteRentalCompletely:", result);
                  console.log("🎯 [deleteRentalItem] ประเภทของ result:", typeof result);
                  console.log("🎯 [deleteRentalItem] result === null:", result === null);
                  console.log("🎯 [deleteRentalItem] result === undefined:", result === undefined);

                  // ตรวจสอบ result อย่างเข้มงวด
                  if (result === null || result === undefined) {
                    console.error("❌ [deleteRentalItem] Server ส่งค่า null/undefined กลับมา - แต่ไม่ได้เป็น error");

                    // แสดง message บอกว่าอาจสำเร็จแต่ไม่ได้รับผลลัพธ์
                    Swal.fire({
                      title: 'การลบเสร็จสิ้น',
                      html: `
                                <div style="text-align: left; margin: 20px 0;">
                                    <p><strong>หมายเลขการจอง:</strong> <span style="font-weight: bold; color: #dc3545;">${rental.หมายเลขการจอง}</span></p>
                                    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin: 15px 0;">
                                        <p style="margin: 0; color: #856404;"><strong>⚠️ แจ้งเตือน:</strong></p>
                                        <p style="margin: 10px 0; color: #856404;">ระบบได้ดำเนินการลบข้อมูลแล้ว แต่ไม่ได้รับรายละเอียดผลลัพธ์จากเซิร์ฟเวอร์</p>
                                        <p style="margin: 10px 0; color: #856404;">กรุณาตรวจสอบว่าข้อมูลถูกลบเรียบร้อยแล้ว</p>
                                    </div>
                                </div>
                            `,
                      icon: 'warning',
                      confirmButtonText: 'ตกลง',
                      width: '600px'
                    });
                    return;
                  }

                  // ตรวจสอบ success property
                  if (!result.hasOwnProperty('success')) {
                    console.error("❌ [deleteRentalItem] Result object ไม่มี success property:", result);

                    Swal.fire({
                      title: 'ผลลัพธ์ไม่ชัดเจน',
                      html: `
                                <div style="text-align: left; margin: 20px 0;">
                                    <p><strong>หมายเลขการจอง:</strong> <span style="font-weight: bold; color: #dc3545;">${rental.หมายเลขการจอง}</span></p>
                                    <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; margin: 15px 0;">
                                        <p style="margin: 0; color: #721c24;"><strong>❌ ข้อผิดพลาด:</strong></p>
                                        <p style="margin: 10px 0; color: #721c24;">ได้รับผลลัพธ์ที่ไม่ถูกต้องจากเซิร์ฟเวอร์</p>
                                        <p style="margin: 10px 0; color: #721c24; font-size: 12px;">กรุณาตรวจสอบ Console และลองใหม่อีกครั้ง</p>
                                    </div>
                                </div>
                            `,
                      icon: 'error',
                      confirmButtonText: 'ตกลง',
                      width: '600px'
                    });
                    return;
                  }

                  console.log("🎯 [deleteRentalItem] result.success:", result.success);
                  console.log("🎯 [deleteRentalItem] result.details:", result.details);

                  if (result.success) {
                    // สร้างข้อความสรุปผลการลบ
                    let summaryHtml = `
                            <div style="text-align: left; margin: 20px 0;">
                                <p><strong>หมายเลขการจอง:</strong> ${rental.หมายเลขการจอง}</p>
                                <div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; margin: 15px 0;">
                                    <h4 style="margin: 0 0 10px 0; color: #155724;">📊 สรุปผลการลบ:</h4>
                        `;

                    // ข้อมูลการเงิน
                    if (result.details && result.details.financial) {
                      const financial = result.details.financial;
                      if (financial.success) {
                        summaryHtml += `
                                    <p style="margin: 5px 0; color: #155724;">
                                        <strong>💰 ข้อมูลการเงิน:</strong> ${financial.message || 'ลบรายการทางการเงินสำเร็จ'}
                                    </p>
                                `;
                      } else {
                        summaryHtml += `
                                    <p style="margin: 5px 0; color: #dc3545;">
                                        <strong>💰 ข้อมูลการเงิน:</strong> ${financial.message || 'เกิดข้อผิดพลาดในการลบรายการทางการเงิน'}
                                    </p>
                                `;
                      }
                    } else {
                      summaryHtml += `
                                <p style="margin: 5px 0; color: #6c757d;">
                                    <strong>💰 ข้อมูลการเงิน:</strong> ไม่มีข้อมูลการเงินที่ต้องลบ
                                </p>
                            `;
                    }

                    // ข้อมูล Google Sheets
                    if (result.details && result.details.sheets) {
                      summaryHtml += `
                                <p style="margin: 5px 0; color: #155724;">
                                    <strong>📋 Google Sheets:</strong> 
                                    ลบรายการเช่า ${result.details.sheets.rentalRowsDeleted} รายการ, 
                                    ตารางรับส่งรถ ${result.details.sheets.scheduleRowsDeleted} รายการ
                                </p>
                            `;
                    }

                    // ข้อมูล Google Calendar
                    if (result.details && result.details.calendar) {
                      const cal = result.details.calendar;
                      if (cal.eventsFound > 0) {
                        summaryHtml += `
                                    <p style="margin: 5px 0; color: #155724;">
                                        <strong>📅 Google Calendar:</strong> 
                                        ลบกิจกรรม ${cal.successfulDeletes}/${cal.eventsFound} กิจกรรม
                                    </p>
                                `;
                      } else {
                        summaryHtml += `
                                    <p style="margin: 5px 0; color: #6c757d;">
                                        <strong>📅 Google Calendar:</strong> ไม่มีกิจกรรมที่ต้องลบ
                                    </p>
                                `;
                      }
                    }

                    // ข้อมูล Google Drive
                    if (result.details && result.details.drive) {
                      const drive = result.details.drive;
                      if (drive.success && drive.filesDeleted > 0) {
                        summaryHtml += `
                                    <p style="margin: 5px 0; color: #155724;">
                                        <strong>📁 Google Drive:</strong> 
                                        ลบไฟล์ ${drive.filesDeleted} ไฟล์, โฟลเดอร์ ${drive.foldersDeleted || 0} โฟลเดอร์
                                    </p>
                                `;
                      } else {
                        summaryHtml += `
                                    <p style="margin: 5px 0; color: #6c757d;">
                                        <strong>📁 Google Drive:</strong> ${drive.message || 'ไม่มีไฟล์ที่ต้องลบ'}
                                    </p>
                                `;
                      }
                    }

                    summaryHtml += `
                                </div>
                                <p style="color: #155724; margin: 10px 0;"><strong>✅ การลบข้อมูลเสร็จสมบูรณ์!</strong></p>
                            </div>
                        `;

                    Swal.fire({
                      title: 'ลบสำเร็จ!',
                      html: summaryHtml,
                      icon: 'success',
                      confirmButtonText: 'ตกลง',
                      width: '700px'
                    });

                    // ข้ามการเรียกใช้ loadRentals และ fetchScheduleForDate
                    // (ไม่รีเฟรชข้อมูล - ให้ผู้ใช้รีเฟรชเองหรือเปลี่ยนหน้า)

                  } else {
                    Swal.fire({
                      title: 'เกิดข้อผิดพลาด!',
                      html: `
                                <div style="text-align: left; margin: 20px 0;">
                                    <p><strong>หมายเลขการจอง:</strong> ${rental.หมายเลขการจอง}</p>
                                    <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; margin: 15px 0;">
                                        <p style="margin: 0; color: #721c24;"><strong>❌ ข้อผิดพลาด:</strong></p>
                                        <p style="margin: 10px 0; color: #721c24;">${result.message}</p>
                                    </div>
                                </div>
                            `,
                      icon: 'error',
                      confirmButtonText: 'ตกลง',
                      width: '600px'
                    });
                  }
                })
                .withFailureHandler(error => {
                  this.isLoading = false; // ปิด loading เสมอ

                  Swal.fire({
                    title: 'เกิดข้อผิดพลาดร้ายแรง!',
                    html: `
                            <div style="text-align: left; margin: 20px 0;">
                                <p><strong>หมายเลขการจอง:</strong> ${rental.หมายเลขการจอง}</p>
                                <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; margin: 15px 0;">
                                    <p style="margin: 0; color: #721c24;"><strong>💥 ข้อผิดพลาดในการเชื่อมต่อ:</strong></p>
                                    <p style="margin: 10px 0; color: #721c24;">${error}</p>
                                    <p style="margin: 10px 0; color: #721c24; font-size: 14px;">กรุณาลองใหม่อีกครั้ง หรือติดต่อผู้ดูแลระบบ</p>
                                </div>
                            </div>
                        `,
                    icon: 'error',
                    confirmButtonText: 'ตกลง',
                    width: '600px'
                  });
                })
                .deleteRentalCompletely(rental.หมายเลขการจอง, sheetID);
            }
          });
        },


        // ฟังก์ชันตรวจสอบเลขบัตรประชาชน/Passport
        validateIdPassport(event) {
          const value = event.target.value;
          // ใช้ Regular Expression เพื่อกรองให้รับเฉพาะตัวเลขหรือตัวอักษรภาษาอังกฤษตัวพิมพ์ใหญ่
          const regex = /^[0-9A-Z]*$/;

          if (!regex.test(value)) {
            // ถ้าไม่ตรงตามเงื่อนไข ให้แทนที่ด้วยค่าที่ถูกต้อง (ลบตัวอักษรที่ไม่ถูกต้องออก)
            if (this.newRental) {
              this.newRental.เลขบัตรประชาชน = value.replace(/[^0-9A-Z]/g, '');
            } else if (this.editRentalData) {
              this.editRentalData.เลขบัตรประชาชน = value.replace(/[^0-9A-Z]/g, '');
            }
          }
        },





        checkIdCardHistory(event) {
          const value = event.target.value;

          // ล้างผลการตรวจสอบเดิม
          const resultElement = document.getElementById('idCardVerifyResult');
          if (resultElement) {
            resultElement.innerHTML = '';
            resultElement.className = '';
          }

          // ตรวจสอบว่ามีข้อมูลที่จะเช็คหรือไม่ และมีความยาวเพียงพอหรือไม่
          if (!value || (value.length !== 13 && value.length < 6)) {
            return;
          }

          // แสดงไอคอนโหลด
          if (resultElement) {
            resultElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบ...';
            resultElement.className = 'text-blue-500 text-xs ml-2';
          }

          // เรียกใช้ฟังก์ชันตรวจสอบใน Google Apps Script
          google.script.run
            .withSuccessHandler(result => {
              if (!resultElement) return;

              if (result.found) {
                // กรณีพบประวัติ
                resultElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> พบประวัติมิจฉาชีพ';
                resultElement.className = 'text-red-500 text-xs ml-2';

                // แสดง SweetAlert กับข้อมูลที่พบ
                let photoLink = '';
                if (result.data.photoUrl && result.data.photoUrl !== 'No File') {
                  photoLink = `<br><a href="${result.data.photoUrl}" target="_blank" class="text-blue-500 hover:underline">
                        <i class="fas fa-image mr-1"></i>คลิกที่นี่เพื่อดูรูปภาพ</a>`;
                }

                Swal.fire({
                  title: 'พบประวัติการโกง!',
                  html: `เลขบัตรประชาชน : ${result.data.idCard}<br>
                 ชื่อ - นามสกุล : ${result.data.name}<br>
                 รูปแบบการโกง : ${result.data.scamType}
                 ${photoLink}`,
                  icon: 'warning',
                  customClass: {
                    title: 'swal-custom-title',
                    htmlContainer: 'swal-custom-left'
                  }
                });
              } else {
                // กรณีไม่พบประวัติ
                resultElement.innerHTML = '<i class="fas fa-check-circle"></i> ไม่พบประวัติมิจฉาชีพ';
                resultElement.className = 'text-green-500 text-xs ml-2';
              }
            })
            .withFailureHandler(error => {
              console.error("Error checking ID card:", error);

              if (resultElement) {
                resultElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> ไม่สามารถตรวจสอบได้';
                resultElement.className = 'text-gray-500 text-xs ml-2';
              }
            })
            .checkIDCard(value);
        },






        debugCommissionState() {
          console.log("=== DEBUG COMMISSION STATE ===");
          console.log("Config:", this.config);
          console.log("Commission Config:", this.config ? this.config["ค่าคอมมิชชั่นหลายรายการ"] : "ไม่มี config");
          console.log("Commission List:", this.commissionList);
          console.log("Commission List Length:", this.commissionList ? this.commissionList.length : 0);
          console.log("Selected Car Commission:", this.newRental.ค่าคอมมิชชั่นที่เลือก);
          console.log("Has Commission Checked:", this.newRental.มีค่าคอมมิชชั่น);
          console.log("================================");
        },


        // เพิ่มฟังก์ชันแปลงรหัสเชื้อเพลิงเป็นข้อความ
        getFuelTypeName(fuelTypeCode) {
          switch (fuelTypeCode) {
            case '[FUELTYPE_1]': return 'เบนซิน91';
            case '[FUELTYPE_2]': return 'เบนซิน95';
            case '[FUELTYPE_3]': return 'เบนซิน';
            case '[FUELTYPE_4]': return 'ดีเซล';
            case 'ไฟฟ้า': return 'ไฟฟ้า';
            default: return fuelTypeCode;
          }
        },

        // ปรับฟังก์ชัน updateFuelTypeVisibility
        updateFuelTypeVisibility() {
          // ตรวจสอบประเภทรถที่เลือก
          const fuelTypes = ['รถยนต์(น้ำมัน)', 'รถจักรยานยนต์(น้ำมัน)'];
          this.showFuelTypeField = fuelTypes.includes(this.currentCar.ประเภท);

          // ถ้าเป็นรถไฟฟ้า ให้กำหนดค่าเป็น "ไฟฟ้า"
          if (!this.showFuelTypeField) {
            this.currentCar.ชนิดเชื้อเพลิง = "ไฟฟ้า";
          } else if (!this.currentCar.ชนิดเชื้อเพลิง || this.currentCar.ชนิดเชื้อเพลิง === "ไฟฟ้า") {
            // ถ้ากลับมาเป็นรถน้ำมันและค่าเดิมเป็นไฟฟ้า ให้กำหนดค่าเริ่มต้นใหม่
            this.currentCar.ชนิดเชื้อเพลิง = "[FUELTYPE_1]";
          }
        },



        loadCars() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              // ตรวจสอบว่า result มีโครงสร้างที่คาดหวังหรือไม่
              if (result && result.success && Array.isArray(result.data)) {
                this.cars = result.data;
                this.calculateCarUsageStats();
              } else if (Array.isArray(result)) {
                // กรณีที่ API อาจจะส่งคืน array โดยตรง
                this.cars = result;
                this.calculateCarUsageStats();
              } else {
                console.error("ได้รับข้อมูลรถในรูปแบบที่ไม่คาดหวัง:", result);
                this.cars = [];
              }

              // ดึงและจัดรูปแบบยี่ห้อและรุ่นรถที่ไม่ซ้ำกัน
              const uniqueBrands = [...new Set(this.cars.map(car => car.ยี่ห้อ))];
              this.carBrands = uniqueBrands.sort();

              const uniqueModels = [...new Set(this.cars.map(car => car.รุ่น))];
              this.carModels = uniqueModels.sort();

              // คำนวณจำนวนรถว่าง
              this.calculateAvailableCars();

              // ต้องโหลด todayActiveRentals ก่อนจึงจะสามารถโหลด availableCarsToday ได้
              if (this.todayActiveRentals && Array.isArray(this.todayActiveRentals)) {
                this.loadAvailableCarsToday();
              }

              // ⭐ เพิ่มการอัปเดตสรุปประเภทรถ
              this.updateCarCategorySummary();

              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลรถ:", error);
              this.showNotification('โหลดข้อมูลรถไม่สำเร็จ: ' + error, 'error');
              this.cars = [];

              // ⭐ ล้างสรุปประเภทรถเมื่อโหลดไม่สำเร็จ
              this.carCategorySummary = [];

              this.isLoading = false;
            })
            .getAllCars(sheetID);
        },

        saveCar() {
          // ตรวจสอบข้อมูลที่จำเป็น
          if (!this.currentCar.ประเภทรถ || !this.currentCar.ยี่ห้อ || !this.currentCar.รุ่น || !this.currentCar.ทะเบียน) {
            this.showNotification('กรุณากรอกข้อมูลให้ครบถ้วน (ประเภทรถ, ยี่ห้อ, รุ่น, ทะเบียน)', 'error');
            return;
          }

          // ตรวจสอบค่าคอมมิชชั่น
          if (this.currentCar.มีค่าคอมมิชชั่น && !this.currentCar.ค่าคอมมิชชั่นที่เลือก) {
            this.showNotification('กรุณาเลือกประเภทค่าคอมมิชชั่น', 'error');
            return;
          }

          // กำหนดค่า "รูปแบบค่าคอมมิชชั่น"
          if (this.currentCar.มีค่าคอมมิชชั่น) {
            this.currentCar["รูปแบบค่าคอมมิชชั่น"] = this.currentCar.ค่าคอมมิชชั่นที่เลือก;
          } else {
            this.currentCar["รูปแบบค่าคอมมิชชั่น"] = "";
          }

          const sheetID = localStorage.getItem('sheetID') || '';

          if (!sheetID) {
            this.showNotification('กรุณาตั้งค่า Sheet ID ก่อนบันทึกข้อมูล', 'error');
            return;
          }

          // แสดง loading modal
          this.isCarSaving = true;
          this.carSavingStep = this.carEditMode ? "กำลังบันทึกการแก้ไขข้อมูลรถ..." : "กำลังเพิ่มรถใหม่...";
          this.carSavingProgress = 30;

          if (this.carEditMode) {
            // แก้ไขรถ (ใช้ฟังก์ชันเดิม)
            google.script.run
              .withSuccessHandler(result => {
                this.carSavingProgress = 70;
                this.carSavingStep = "กำลังอัพเดทข้อมูล...";

                if (result.success) {
                  this.carSavingProgress = 100;
                  this.carSavingStep = "บันทึกสำเร็จ!";

                  setTimeout(() => {
                    this.isCarSaving = false;
                    this.showNotification('แก้ไขข้อมูลรถสำเร็จ', 'success');
                    if (typeof this.loadCars === 'function') {
                      this.loadCars(); // โหลดข้อมูลรถใหม่ (จะเรียก updateCarCategorySummary() อัตโนมัติ)
                    } else {
                      // ⭐ ถ้าไม่มี loadCars ให้อัปเดตสรุปโดยตรง
                      this.updateCarCategorySummary();
                    }
                    this.closeCarModal();
                  }, 500);
                } else {
                  this.isCarSaving = false;
                  this.showNotification(result.message, 'error');
                }
              })
              .withFailureHandler(error => {
                this.isCarSaving = false;
                console.error('เกิดข้อผิดพลาดในการแก้ไขรถ:', error);
                this.showNotification('เกิดข้อผิดพลาดในการแก้ไขรถ', 'error');
              })
              .updateCar(this.currentCar.id, this.currentCar, sheetID);

          } else {
            // เพิ่มรถใหม่ (ใช้ฟังก์ชันใหม่ที่มีรหัสรถอัตโนมัติ)
            google.script.run
              .withSuccessHandler(result => {
                this.carSavingProgress = 70;
                this.carSavingStep = "กำลังอัพเดทข้อมูล...";

                if (result.success) {
                  this.carSavingProgress = 100;
                  this.carSavingStep = "เพิ่มรถใหม่สำเร็จ!";

                  setTimeout(() => {
                    this.isCarSaving = false;
                    this.showNotification(`เพิ่มรถใหม่สำเร็จ รหัสรถ: ${result.carCode || 'ไม่ระบุ'}`, 'success');
                    if (typeof this.loadCars === 'function') {
                      this.loadCars(); // โหลดข้อมูลรถใหม่ (จะเรียก updateCarCategorySummary() อัตโนมัติ)
                    } else {
                      // ⭐ ถ้าไม่มี loadCars ให้อัปเดตสรุปโดยตรง
                      this.updateCarCategorySummary();
                    }
                    this.closeCarModal();
                  }, 500);
                } else {
                  this.isCarSaving = false;
                  this.showNotification(result.message, 'error');
                }
              })
              .withFailureHandler(error => {
                this.isCarSaving = false;
                console.error('เกิดข้อผิดพลาดในการเพิ่มรถใหม่:', error);
                this.showNotification('เกิดข้อผิดพลาดในการเพิ่มรถใหม่', 'error');
              })
              .addNewCarWithCode(this.currentCar, sheetID);
          }
        },

        deleteCar(carId) {
          const car = this.cars.find(car => car.id === carId);
          if (!car) {
            this.showNotification('ไม่พบข้อมูลรถที่ต้องการลบ', 'error');
            return;
          }

          // แก้ไข: ใช้รหัสรถแทนทะเบียนเพื่อป้องกันการลบผิดคันกรณีทะเบียนซ้ำหรือว่าง
          const carCode = car.รหัสรถ;
          const carName = `${car.ยี่ห้อ} ${car.รุ่น} (${car.ทะเบียน})`;

          Swal.fire({
            title: 'ยืนยันการลบ',
            html: `
      <div class="text-left">
        <p>คุณต้องการลบรถ <strong>${carName}</strong> ใช่หรือไม่?</p>
        <div class="mt-3 p-3 bg-green-50 border border-green-300 rounded text-green-700 text-sm mb-4">
          <i class="fas fa-info-circle mr-2"></i>
          <strong>คำแนะนำ:</strong> หากคุณต้องการเปลี่ยนทะเบียนรถ <br>แนะนำให้ใช้การแก้ไขแทนการลบข้อมูล
        </div>
        <div class="mt-4 flex items-center">
          <input type="checkbox" id="deleteRelatedRentals" class="mr-2">
          <label for="deleteRelatedRentals" class="cursor-pointer text-gray-700">
            ลบรายการเช่าทั้งหมดของรถคันนี้ด้วย
          </label>
        </div>
        <div id="deleteWarning" class="hidden mt-3 p-3 bg-red-50 border border-red-300 rounded text-red-700 text-sm">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          <strong>คำเตือน!</strong> การกระทำนี้จะลบข้อมูลการเช่าและตารางรับส่งรถของลูกค้าที่เกี่ยวข้องกับรถคันนี้ทั้งหมดโดยถาวร
        </div>
      </div>
    `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก',
            didOpen: () => {
              const checkbox = document.getElementById('deleteRelatedRentals');
              const warning = document.getElementById('deleteWarning');
              if (checkbox && warning) {
                checkbox.addEventListener('change', function () {
                  warning.classList.toggle('hidden', !this.checked);
                });
              }
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const deleteRelatedRentals = document.getElementById('deleteRelatedRentals').checked;
              this.isLoading = true;
              const sheetID = localStorage.getItem('sheetID') || '';
              google.script.run
                .withSuccessHandler(result => {
                  if (result.success) {
                    Swal.fire(
                      'ลบสำเร็จ!',
                      result.message,
                      'success'
                    );

                    // โหลดข้อมูลใหม่
                    this.loadCars(); // จะเรียก updateCarCategorySummary() อัตโนมัติ
                    this.loadMaintenance();

                    // ⭐ เพิ่มการอัปเดตสรุปประเภทรถเพิ่มเติม (เผื่อไว้)
                    setTimeout(() => {
                      this.updateCarCategorySummary();
                    }, 200);

                    if (deleteRelatedRentals) {
                      this.loadRentals(loadSuccess => {
                        if (loadSuccess) this.fetchScheduleForDate();
                      });
                    }
                  } else {
                    Swal.fire('เกิดข้อผิดพลาด!', 'ลบรถไม่สำเร็จ: ' + result.message, 'error');
                  }
                  this.isLoading = false;
                })
                .withFailureHandler(error => {
                  Swal.fire('เกิดข้อผิดพลาด!', 'ลบรถไม่สำเร็จ: ' + error, 'error');
                  this.isLoading = false;
                })
                .deleteCar(carCode, deleteRelatedRentals, sheetID);
            }
          });
        },



        updateCarCategorySummary() {
          try {
            if (!this.cars || !Array.isArray(this.cars) || this.cars.length === 0) {
              this.carCategorySummary = [];
              return;
            }

            const categoryCount = {};

            this.cars.forEach(car => {
              let category = car.ประเภทรถ || car['ประเภทรถ'];

              if (!category || category === '' || category === null || category === undefined) {
                category = 'ไม่ระบุประเภท';
              }

              if (categoryCount[category]) {
                categoryCount[category]++;
              } else {
                categoryCount[category] = 1;
              }
            });

            this.carCategorySummary = Object.keys(categoryCount)
              .map(categoryName => ({
                name: categoryName,
                count: categoryCount[categoryName]
              }))
              .sort((a, b) => {
                if (b.count !== a.count) {
                  return b.count - a.count;
                }
                return a.name.localeCompare(b.name, 'th');
              });

          } catch (error) {
            console.error('Error updating car category summary:', error);
            this.carCategorySummary = [];
          }
        },


        loadCarOptions() {
          this.isLoading = true;
          // console.log("[Client] กำลังโหลดตัวเลือกยี่ห้อและรุ่นรถ...");
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                // สร้างชุดข้อมูลยี่ห้อและรุ่นรถที่ไม่ซ้ำกัน
                const uniqueBrands = new Set();
                const uniqueModels = new Set();

                if (Array.isArray(result.data)) {
                  result.data.forEach(car => {
                    // ทำความสะอาดข้อมูลก่อนเก็บค่า
                    if (car.ยี่ห้อ) {
                      const cleanBrand = car.ยี่ห้อ.toString().trim();
                      if (cleanBrand) uniqueBrands.add(cleanBrand);
                    }
                    if (car.รุ่น) {
                      const cleanModel = car.รุ่น.toString().trim();
                      if (cleanModel) uniqueModels.add(cleanModel);
                    }
                  });
                }

                // แปลง Set เป็น Array และเรียงตามตัวอักษร
                this.carBrands = [...uniqueBrands].sort((a, b) => a.localeCompare(b, 'th'));
                this.carModels = [...uniqueModels].sort((a, b) => a.localeCompare(b, 'th'));

                // console.log(`[Client] โหลดตัวเลือกสำเร็จ: ${this.carBrands.length} ยี่ห้อ, ${this.carModels.length} รุ่น`);
              } else {
                console.error("[Client] โหลดตัวเลือกยี่ห้อและรุ่นรถไม่สำเร็จ:", result.message);
                this.carBrands = [];
                this.carModels = [];
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("[Client] เกิดข้อผิดพลาดในการโหลดตัวเลือกยี่ห้อและรุ่นรถ:", error);
              this.carBrands = [];
              this.carModels = [];
              this.isLoading = false;
            })
            .getAllCars(sheetID);
        },


        openNewCarForm() {
          this.carEditMode = false;
          this.carModalTitle = 'เพิ่มรถใหม่';
          this.showCategoryManagement = false; // ปิดโหมดจัดการเมื่อเปิด Modal

          // ตั้งค่าเริ่มต้นสำหรับรถใหม่
          this.currentCar = {
            รหัสรถ: '',               // ใหม่ - จะถูกสร้างอัตโนมัติ
            ประเภทรถ: '',             // ใหม่
            ยี่ห้อ: '',
            รุ่น: '',
            ทะเบียน: '',
            พื้นที่การใช้งาน: '[ZONE1]',
            สี: '',
            ค่าประกันความเสียหาย: '3000',
            ประเภท: 'รถยนต์(น้ำมัน)',
            ราคาเช่าต่อวัน: '',
            สถานะ: 'พร้อมให้เช่า',
            ชนิดเชื้อเพลิง: '[FUELTYPE_1]',
            มีค่าคอมมิชชั่น: false,
            ค่าคอมมิชชั่นที่เลือก: '',
            "รูปแบบค่าคอมมิชชั่น": ''
          };

          // โหลดข้อมูลประเภทรถถ้ายังไม่มี
          if (this.carCategories.length === 0) {
            this.loadCarCategories();
          }

          // โหลดข้อมูลอื่นๆ ถ้าจำเป็น
          if (this.carBrands && this.carBrands.length === 0 || this.carModels && this.carModels.length === 0) {
            if (typeof this.loadCarOptions === 'function') {
              this.loadCarOptions();
            }
          }

          if (typeof this.updateFuelTypeVisibility === 'function') {
            this.updateFuelTypeVisibility();
          }
          if (typeof this.loadZoneDescription === 'function') {
            this.loadZoneDescription();
          }
          if (typeof this.loadCommissionList === 'function') {
            this.loadCommissionList();
          }

          this.showCarModal = true;
        },

        /**
         * แก้ไขข้อมูลรถ (อัปเดต)
         */
        editCar(car) {
          this.carEditMode = true;
          this.carModalTitle = 'แก้ไขข้อมูลรถ';
          this.showCategoryManagement = false; // ปิดโหมดจัดการเมื่อเปิด Modal
          this.currentCar = { ...car };

          // ตั้งค่าฟิลด์คอมมิชชั่นจากค่าเดิม
          if (car["รูปแบบค่าคอมมิชชั่น"]) {
            this.currentCar.มีค่าคอมมิชชั่น = true;
            this.currentCar.ค่าคอมมิชชั่นที่เลือก = car["รูปแบบค่าคอมมิชชั่น"];
          } else {
            this.currentCar.มีค่าคอมมิชชั่น = false;
            this.currentCar.ค่าคอมมิชชั่นที่เลือก = '';
          }

          // โหลดข้อมูลประเภทรถถ้ายังไม่มี
          if (this.carCategories.length === 0) {
            this.loadCarCategories();
          }

          // โหลดข้อมูลอื่นๆ ถ้าจำเป็น
          if (this.carBrands && this.carBrands.length === 0 || this.carModels && this.carModels.length === 0) {
            if (typeof this.loadCarOptions === 'function') {
              this.loadCarOptions();
            }
          }

          if (typeof this.updateFuelTypeVisibility === 'function') {
            this.updateFuelTypeVisibility();
          }
          if (typeof this.loadZoneDescription === 'function') {
            this.loadZoneDescription();
          }
          if (typeof this.loadCommissionList === 'function') {
            this.loadCommissionList();
          }

          this.showCarModal = true;
        },


        toggleCategoryManagement() {
          this.showCategoryManagement = !this.showCategoryManagement;

          if (this.showCategoryManagement) {
            // เมื่อเปิดโหมดจัดการ
            this.newCategoryName = '';

            // โหลดประเภทรถล่าสุด (ถ้ายังไม่มี)
            if (this.carCategories.length === 0) {
              this.loadCarCategories();
            }

            console.log('เปิดโหมดจัดการประเภทรถ');
          } else {
            // เมื่อปิดโหมดจัดการ
            this.newCategoryName = '';
            console.log('ปิดโหมดจัดการประเภทรถ');
          }
        },

        loadCarCategories() {
          const sheetID = localStorage.getItem('sheetID') || '';

          if (!sheetID) {
            this.showNotification('กรุณาตั้งค่า Sheet ID ก่อนใช้งาน', 'error');
            // ใช้ค่าเริ่มต้นถ้าไม่มี Sheet ID
            this.carCategories = ['รถของร้าน', 'รถ Partner', 'รถหุ้นส่วน'];
            return;
          }

          // แสดง loading state
          this.isLoading = true;

          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;

              if (result.success) {
                this.carCategories = result.data || [];
                console.log('โหลดประเภทรถสำเร็จ:', this.carCategories);
              } else {
                console.error('เกิดข้อผิดพลาดในการโหลดประเภทรถ:', result.message);
                this.showNotification(result.message, 'error');
                // ใช้ค่าเริ่มต้นถ้าโหลดไม่ได้
                this.carCategories = ['รถของร้าน', 'รถ Partner', 'รถหุ้นส่วน'];
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              console.error('เกิดข้อผิดพลาดในการเชื่อมต่อ:', error);
              this.showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ', 'error');
              // ใช้ค่าเริ่มต้นถ้าเชื่อมต่อไม่ได้
              this.carCategories = ['รถของร้าน', 'รถ Partner', 'รถหุ้นส่วน'];
            })
            .loadCarCategories(sheetID);
        },

        /**
         * เปิด Modal ตั้งค่าประเภทรถ
         */
        openCarCategoryModal() {
          this.newCategoryName = '';
          this.showCarCategoryModal = true;
          // โหลดข้อมูลล่าสุดเมื่อเปิด modal
          this.loadCarCategories();
        },

        /**
         * ปิด Modal ตั้งค่าประเภทรถ
         */
        closeCarCategoryModal() {
          this.showCarCategoryModal = false;
          this.newCategoryName = '';
        },

        /**
         * เพิ่มประเภทรถใหม่
         */
        addCarCategory() {
          const trimmedName = this.newCategoryName.trim();

          if (!trimmedName) {
            this.showNotification('กรุณากรอกชื่อประเภทรถ', 'warning');
            return;
          }

          // ตรวจสอบว่าประเภทนี้มีอยู่แล้วหรือไม่ (case-insensitive)
          const exists = this.carCategories.some(cat =>
            cat.toLowerCase() === trimmedName.toLowerCase()
          );

          if (exists) {
            this.showNotification('ประเภทรถนี้มีอยู่แล้ว', 'warning');
            return;
          }

          const sheetID = localStorage.getItem('sheetID') || '';

          if (!sheetID) {
            // หากไม่มี Sheet ID ให้เพิ่มในหน่วยความจำเท่านั้น
            this.carCategories.push(trimmedName);
            this.newCategoryName = '';
            this.showNotification(`เพิ่มประเภทรถ "${trimmedName}" สำเร็จ (เฉพาะในหน่วยความจำ)`, 'success');
            return;
          }

          // แสดง loading
          this.isLoading = true;

          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;

              if (result.success) {
                this.carCategories = result.data || [];
                this.newCategoryName = '';
                this.showNotification(`เพิ่มประเภทรถ "${trimmedName}" สำเร็จ`, 'success');
              } else {
                this.showNotification(result.message, 'error');
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              console.error('เกิดข้อผิดพลาดในการเพิ่มประเภทรถ:', error);
              this.showNotification('เกิดข้อผิดพลาดในการเพิ่มประเภทรถ', 'error');
            })
            .addCarCategory(sheetID, trimmedName);
        },

        /**
         * ลบประเภทรถ
         * @param {number} index - ตำแหน่งของประเภทรถใน array
         */
        removeCarCategory(index) {
          if (index < 0 || index >= this.carCategories.length) {
            this.showNotification('ข้อมูลประเภทรถไม่ถูกต้อง', 'error');
            return;
          }

          const categoryToRemove = this.carCategories[index];

          if (!confirm(`คุณต้องการลบประเภทรถ "${categoryToRemove}" หรือไม่?`)) {
            return;
          }

          const sheetID = localStorage.getItem('sheetID') || '';

          if (!sheetID) {
            // หากไม่มี Sheet ID ให้ลบในหน่วยความจำเท่านั้น
            if (this.carCategories.length <= 1) {
              this.showNotification('ต้องเหลือประเภทรถอย่างน้อย 1 ประเภท', 'warning');
              return;
            }
            this.carCategories.splice(index, 1);
            this.showNotification(`ลบประเภทรถ "${categoryToRemove}" สำเร็จ`, 'success');
            return;
          }

          // แสดง loading
          this.isLoading = true;

          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;

              if (result.success) {
                this.carCategories = result.data || [];
                this.showNotification(`ลบประเภทรถ "${categoryToRemove}" สำเร็จ`, 'success');
              } else {
                this.showNotification(result.message, 'error');
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              console.error('เกิดข้อผิดพลาดในการลบประเภทรถ:', error);
              this.showNotification('เกิดข้อผิดพลาดในการลบประเภทรถ', 'error');
            })
            .removeCarCategory(sheetID, categoryToRemove);
        },

        /**
         * บันทึกการตั้งค่าประเภทรถ
         */
        saveCarCategories() {
          if (this.carCategories.length === 0) {
            this.showNotification('ต้องมีประเภทรถอย่างน้อย 1 ประเภท', 'warning');
            return;
          }

          const sheetID = localStorage.getItem('sheetID') || '';

          if (!sheetID) {
            this.showNotification('บันทึกการตั้งค่าในหน่วยความจำเท่านั้น', 'info');
            this.closeCarCategoryModal();
            return;
          }

          // แสดง loading
          this.isLoading = true;

          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;

              if (result.success) {
                this.showNotification('บันทึกการตั้งค่าประเภทรถสำเร็จ', 'success');
                this.closeCarCategoryModal();
              } else {
                this.showNotification(result.message, 'error');
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              console.error('เกิดข้อผิดพลาดในการบันทึกประเภทรถ:', error);
              this.showNotification('เกิดข้อผิดพลาดในการบันทึกประเภทรถ', 'error');
            })
            .saveCarCategories(sheetID, this.carCategories);
        },





















        closeCarModal() {
          this.showCarModal = false;
          this.showCategoryManagement = false; // ปิดโหมดจัดการเมื่อปิด Modal
          this.newCategoryName = '';           // ล้างชื่อประเภทใหม่
        },


        // (เพิ่มฟังก์ชันนี้เข้าไปใน script)
        calculateCommissionExample(amount) {
          const selectedName = this.currentCar?.ค่าคอมมิชชั่นที่เลือก;
          if (!selectedName || !this.commissionList || this.commissionList.length === 0) {
            return '<span class="text-yellow-600 font-semibold">กรุณาเลือกประเภทค่าคอม</span>';
          }

          const selected = this.commissionList.find(item => item.ชื่อ === selectedName);
          if (!selected) {
            return '<span class="text-red-600 font-semibold">ไม่พบข้อมูลค่าคอมที่เลือก</span>';
          }

          if (selected.รูปแบบ === 'fixed') {
            return `จ่ายค่าคอมมิชชั่นวันละ <b class="text-green-700">${selected.ค่าFixed || 0}</b> บาท`;
          }

          if (selected.รูปแบบ === 'percent+vat') {
            const percent = parseFloat(selected.ค่าเปอร์เซ็นต์ || 0);
            const vat = parseFloat(selected.vat || 0);
            const base = (amount * percent) / 100;
            const vatAmount = (base * vat) / 100;
            const total = base + vatAmount;

            return `
      ค่าคอมมิชชั่น ${percent}%: <b class="text-blue-600">${base.toFixed(2)}</b> บาท<br>
      บวก Vat ${vat}%: <b class="text-purple-600">${vatAmount.toFixed(2)}</b> บาท<br>
      <span class="text-red-700 font-semibold">รวมทั้งหมด: ${total.toFixed(2)} บาท</span>
    `;
          }

          return '<span class="text-gray-600">รูปแบบค่าคอมมิชชั่นไม่ถูกต้อง</span>';
        },





        calculateRemainingHoursForNewRental() {
          try {
            if (!this.newRental.วันที่เช่า || !this.newRental.วันที่คืน ||
              !this.newRental.เวลารับรถ || !this.newRental.เวลาคืนรถ) {
              return 0;
            }

            // สร้าง Date objects
            const startDate = new Date(`${this.newRental.วันที่เช่า}T${this.newRental.เวลารับรถ}:00`);
            const endDate = new Date(`${this.newRental.วันที่คืน}T${this.newRental.เวลาคืนรถ}:00`);

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return 0;

            // คำนวณความต่างในมิลลิวินาที
            const diffMs = endDate.getTime() - startDate.getTime();

            // แปลงเป็นชั่วโมง
            const diffHours = diffMs / (1000 * 60 * 60);

            // คำนวณชั่วโมงที่เหลือ
            const remainingHours = Math.floor(diffHours % 24);

            // ดึงค่าชั่วโมงที่คิดเพิ่ม
            const extraHoursThreshold = parseFloat(this.config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน) || 4;

            // ถ้าชั่วโมงเกินกว่าค่าที่กำหนด จะถูกคิดเป็น 1 วันเต็ม แสดงเป็น 0 ชั่วโมง
            return remainingHours > extraHoursThreshold ? 0 : remainingHours;
          } catch (e) {
            console.error("เกิดข้อผิดพลาดในการคำนวณชั่วโมงที่เหลือ:", e);
            return 0;
          }
        },






        async confirmRentalSubmissionUnspecifiedVehicle() {

          if (this.isSubmitting) {
            return;
          }

          try {
            // ปรับสถานะปุ่มเป็นกำลังโหลด
            this.setSubmitButtonLoading();

            // ตรวจสอบข้อมูลพื้นฐานสำหรับโหมดไม่ระบุรถ
            if (!this.unspecifiedVehicleName.trim()) {
              this.resetSubmitButton();
              this.showNotification('กรุณาระบุชื่อรถที่ต้องการ', 'warning');
              return;
            }

            if (!this.newRental.ชื่อลูกค้า.trim()) {
              this.resetSubmitButton();
              this.showNotification('กรุณาระบุชื่อลูกค้า', 'warning');
              return;
            }

            if (!this.newRental.วันที่เช่า || !this.newRental.วันที่คืน) {
              this.resetSubmitButton();
              this.showNotification('กรุณาระบุวันที่เช่าและวันที่คืน', 'warning');
              return;
            }

            // กำหนดข้อมูลสำหรับโหมดไม่ระบุรถ
            this.newRental.รถ = this.unspecifiedVehicleName;
            this.newRental.ทะเบียนรถ = ''; // ไม่มีทะเบียนรถ
            this.newRental.สถานะ = 'รอหารถ'; // เปลี่ยนสถานะเป็น "รอหารถ"
            this.newRental.ผู้ทำรายการ = this.currentUser.displayName || this.currentUser.username || '';

            const sheetID = localStorage.getItem('sheetID') || '';

            // ตรวจสอบว่าหมายเลขการจองซ้ำหรือไม่
            const isDuplicate = await new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(result => resolve(result === true))
                .withFailureHandler(error => reject(error))
                .checkBookingNumberExists(this.newRental.หมายเลขการจอง, sheetID);
            });

            if (isDuplicate) {
              this.resetSubmitButton();

              const result = await Swal.fire({
                title: 'หมายเลขการจองซ้ำ',
                text: "หมายเลขการจองนี้ถูกใช้แล้ว ระบบจะสร้างหมายเลขการจองใหม่ให้อัตโนมัติ",
                icon: 'warning',
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'ตกลง',
                showCancelButton: true,
                cancelButtonText: 'ยกเลิก'
              });

              if (result.isConfirmed) {
                this.setSubmitButtonLoading();
                try {
                  const newBookingNumber = await new Promise((resolve, reject) => {
                    google.script.run
                      .withSuccessHandler(resolve)
                      .withFailureHandler(reject)
                      .generateBookingNumber(sheetID);
                  });

                  this.newRental.หมายเลขการจอง = newBookingNumber;

                  // เรียกใช้ proceedWithBookingSummary โดยตรง (ข้ามการตรวจสอบรถ)
                  this.proceedWithBookingSummary();
                } catch (error) {
                  this.resetSubmitButton();
                  this.showNotification('ไม่สามารถสร้างหมายเลขการจองได้: ' + error, 'error');
                }
              }
            } else {
              // เรียกใช้ proceedWithBookingSummary โดยตรง
              this.proceedWithBookingSummary();
            }
          } catch (error) {
            this.resetSubmitButton();
            this.showNotification('เกิดข้อผิดพลาดในการตรวจสอบหมายเลขการจอง: ' + error, 'error');
          }
        },









        async confirmRentalSubmission() {

          if (this.isSubmitting) {
            return;
          }

          try {
            // ปรับสถานะปุ่มเป็นกำลังโหลด
            this.setSubmitButtonLoading();

            // ตรวจสอบว่าฟอร์มถูกต้องครบถ้วนหรือไม่
            if (!this.validateRentalForm()) {
              this.resetSubmitButton();
              return;
            }

            this.newRental.ผู้ทำรายการ = this.currentUser.displayName || this.currentUser.username || '';
            const sheetID = localStorage.getItem('sheetID') || '';
            // ตรวจสอบว่าหมายเลขการจองซ้ำหรือไม่
            const isDuplicate = await new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(result => resolve(result === true))
                .withFailureHandler(error => reject(error))
                .checkBookingNumberExists(this.newRental.หมายเลขการจอง, sheetID);
            });

            if (isDuplicate) {
              this.resetSubmitButton();

              // แสดงข้อความเตือนหากหมายเลขการจองซ้ำ
              const result = await Swal.fire({
                title: 'หมายเลขการจองซ้ำ',
                text: "หมายเลขการจองนี้ถูกใช้แล้ว ระบบจะสร้างหมายเลขการจองใหม่ให้อัตโนมัติ",
                icon: 'warning',
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'ตกลง',
                showCancelButton: true,
                cancelButtonText: 'ยกเลิก'
              });

              if (result.isConfirmed) {
                // เปลี่ยนปุ่มกลับเป็นโหลดอีกครั้ง
                this.setSubmitButtonLoading();
                try {
                  // เรียกใช้ Google Script โดยตรงเพื่อสร้างหมายเลขการจองใหม่
                  const newBookingNumber = await new Promise((resolve, reject) => {
                    google.script.run
                      .withSuccessHandler(resolve)
                      .withFailureHandler(reject)
                      .generateBookingNumber(sheetID);
                  });

                  this.newRental.หมายเลขการจอง = newBookingNumber;

                  // ตรวจสอบความพร้อมของรถแล้วดำเนินการต่อ
                  await this.checkCarAvailabilityAndProceed(false);
                } catch (error) {
                  this.resetSubmitButton();
                  this.showNotification('ไม่สามารถสร้างหมายเลขการจองได้: ' + error, 'error');
                }
              }
            } else {
              // กรณีไม่ซ้ำ ดำเนินการต่อไป
              await this.checkCarAvailabilityAndProceed(false);
            }
          } catch (error) {
            this.resetSubmitButton();
            this.showNotification('เกิดข้อผิดพลาดในการตรวจสอบหมายเลขการจอง: ' + error, 'error');
          }
        },






        async checkCarAvailabilityAndProceed(isEdit) {
          try {
            const rentalData = isEdit ? this.editRentalData : this.newRental;

            // ตรวจสอบความพร้อมของรถ
            const result = await this.checkCarAvailability(rentalData, isEdit);

            if (result.continue) {
              // กรณีดำเนินการต่อ

              // เก็บสถานะการบังคับจอง
              if (result.forceBook) {
                // กรณีบังคับจอง ให้บันทึกในหมายเหตุพร้อมกับหมายเลขการจองที่ซ้อนทับ
                const currentNote = rentalData.หมายเหตุ || '';

                let noteMessage = '[ระบบ] การจองนี้มีการซ้อนทับกับการจองอื่น';

                // เพิ่มหมายเลขการจองถ้ามี
                if (result.bookingNumber) {
                  noteMessage = `[ระบบ] การจองนี้มีการซ้อนทับกับหมายเลขการจอง ${result.bookingNumber}`;
                }

                // เพิ่มข้อมูลเพิ่มเติมถ้ามี conflict
                if (result.conflict && result.conflict.customer) {
                  noteMessage += ` (ลูกค้า: ${result.conflict.customer})`;
                }

                rentalData.หมายเหตุ = currentNote + (currentNote ? '\n' : '') + noteMessage;
              }

              // ดำเนินการต่อไป
              if (isEdit) {
                // กรณีแก้ไข - บันทึกการแก้ไขรายการเช่า
                this.saveRentalEditConfirmed();
              } else {
                // กรณีสร้างใหม่ - แสดงข้อมูลสรุปและบันทึก
                this.proceedWithBookingSummary();
              }
            } else {
              // หากผลลัพธ์เป็น { continue: false } แสดงว่าผู้ใช้เลือกยกเลิกหรือกลับไปแก้ไข
              this.resetSubmitButton();
            }
          } catch (error) {
            this.resetSubmitButton();
            this.showNotification('เกิดข้อผิดพลาดในการตรวจสอบความพร้อมของรถ: ' + error, 'error');
          }
        },



        proceedWithBookingSummary() {
          try {
            // ตรวจสอบว่าเป็นโหมดไม่ระบุรถหรือไม่
            const isUnspecifiedMode = this.unspecifiedVehicleMode && this.newRental.สถานะ === 'รอหารถ';

            // คำนวณจำนวนวันและชั่วโมงที่เช่า
            const startDate = new Date(this.newRental.วันที่เช่า + 'T' + (this.newRental.เวลารับรถ || '08:00') + ':00');
            const endDate = new Date(this.newRental.วันที่คืน + 'T' + (this.newRental.เวลาคืนรถ || '08:00') + ':00');

            // คำนวณความต่างในชั่วโมง
            const diffMs = Math.abs(endDate - startDate);
            const diffHours = diffMs / (1000 * 60 * 60);

            // คำนวณจำนวนวันเต็ม
            const diffDays = Math.floor(diffHours / 24);

            // คำนวณชั่วโมงที่เหลือ
            const remainingHours = Math.floor(diffHours % 24);

            // ดึงค่าชั่วโมงที่คิดเพิ่ม
            const extraHoursThreshold = parseFloat(this.config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน) || 4;

            // คำนวณจำนวนวันที่ต้องจ่าย
            let rentalDays = diffDays;
            if (remainingHours > extraHoursThreshold) {
              rentalDays += 1;
            }

            // ถ้าเป็นศูนย์วัน ให้นับเป็น 1 วัน
            rentalDays = Math.max(1, rentalDays);

            // สร้างข้อความแสดงระยะเวลาเช่า
            let rentalPeriodText = `${rentalDays} วัน`;
            if (remainingHours > 0 && remainingHours <= extraHoursThreshold) {
              rentalPeriodText += ` ${remainingHours} ชั่วโมง`;
            }

            // สร้างข้อความอธิบายเพิ่มเติมเกี่ยวกับการคิดชั่วโมงเพิ่ม
            let extraHoursNote = '';
            if (extraHoursThreshold > 0) {
              extraHoursNote = `<div class="text-xs text-gray-500 mt-1">(หมายเหตุ: หากเกิน ${extraHoursThreshold} ชั่วโมง คิดเพิ่มเป็น 1 วัน)</div>`;
            }

            // สร้างข้อความสรุปข้อมูลการเช่า - แก้ไขเพื่อรองรับโหมดไม่ระบุรถ
            const rentalSummaryHTML = this.generateRentalSummaryHTML(rentalPeriodText, extraHoursNote, isUnspecifiedMode);

            // กำหนด title และสีของ SweetAlert ตามโหมด
            const alertTitle = isUnspecifiedMode
              ? 'ยืนยันการบันทึกรายการจองแบบไม่ระบุรถ'
              : 'ยืนยันการบันทึกรายการเช่า';

            const confirmButtonColor = isUnspecifiedMode ? '#f59e0b' : '#10b981'; // สีส้มสำหรับโหมดไม่ระบุรถ, สีเขียวสำหรับโหมดปกติ

            // แสดง SweetAlert2 เพื่อยืนยันการบันทึก
            Swal.fire({
              title: alertTitle,
              html: rentalSummaryHTML,
              icon: 'question',
              width: window.innerWidth < 640 ? '95%' : (window.innerWidth < 1024 ? '85%' : '48rem'), // Responsive width
              showCancelButton: true,
              confirmButtonText: isUnspecifiedMode ? 'บันทึกรายการจอง' : 'บันทึกรายการ',
              cancelButtonText: 'ยกเลิก',
              confirmButtonColor: confirmButtonColor,
              cancelButtonColor: '#ef4444', // สีแดง
              customClass: {
                container: 'rental-summary-container',
                popup: 'rental-summary-popup',
                content: 'text-left'
              },
              showClass: {
                popup: 'animate__animated animate__fadeInDown animate__faster'
              },
              hideClass: {
                popup: 'animate__animated animate__fadeOutUp animate__faster'
              }
            }).then((result) => {
              // รีเซ็ตปุ่มไม่ว่าจะยืนยันหรือยกเลิก
              this.resetSubmitButton();

              if (result.isConfirmed) {
                // ใช้ฟังก์ชันเดิมทั้งสองโหมด - ระบบจะทำงานปกติรวมถึงสร้าง PDF
                this.addRental();
              }
            }).catch(() => {
              // กรณีมีข้อผิดพลาดใน Swal ให้รีเซ็ตปุ่ม
              this.resetSubmitButton();
            });
          } catch (error) {
            // กรณีมีข้อผิดพลาดในการคำนวณ ให้รีเซ็ตปุ่มและแสดงข้อความผิดพลาด
            this.resetSubmitButton();
            this.showNotification('เกิดข้อผิดพลาดในการสร้างสรุปข้อมูล: ' + error, 'error');
          }
        },

        // ฟังก์ชันสำหรับสร้าง HTML สรุปข้อมูลการเช่า - แก้ไขเพื่อรองรับโหมดไม่ระบุรถ
        generateRentalSummaryHTML(rentalPeriodText, extraHoursNote, isUnspecifiedMode = false) {
          // ฟังก์ชันย่อยสำหรับสร้าง row ข้อมูล
          const createRow = (label, value, isHighlight = false, icon = '') => {
            const valueClass = isHighlight ?
              'font-bold text-lg text-green-600' :
              'text-gray-800';
            const iconHTML = icon ? `<i class="${icon} mr-2 text-xs"></i>` : '';
            return `
      <div class="flex justify-between items-center py-2 border-b border-gray-100">
        <span class="text-gray-600 text-sm">${iconHTML}${label}:</span>
        <span class="${valueClass} text-sm">${value}</span>
      </div>
    `;
          };

          // กำหนดสีและข้อความตามโหมด
          const modeClass = isUnspecifiedMode ? 'bg-orange-50 border-orange-200' : 'bg-blue-50 border-blue-200';
          const statusBadge = isUnspecifiedMode
            ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800"><i class="fas fa-clock mr-1"></i>รอหารถ</span>'
            : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>จอง</span>';

          const carInfo = isUnspecifiedMode
            ? this.unspecifiedVehicleName
            : `${this.newRental.รถ} (${this.newRental.ทะเบียนรถ})`;

          // สร้าง HTML
          let html = `
    <div class="text-left max-w-2xl mx-auto">
      <!-- Header แสดงสถานะ -->
      <div class="p-4 ${modeClass} rounded-lg mb-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-gray-800">สถานะการจอง</h4>
          ${statusBadge}
        </div>
        <p class="text-xs text-gray-600">
          ${isUnspecifiedMode
              ? 'การจองแบบไม่ระบุรถคันเฉพาะ - รอจัดหารถให้ลูกค้า'
              : 'การจองแบบล็อคคิว - รถคันนี้จะถูกใช้สำหรับการเช่านี้'}
        </p>
      </div>

      <!-- Section 1: ข้อมูลการจองและลูกค้า -->
      <div class="mb-3 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
        <h5 class="font-semibold text-blue-800 mb-3 text-sm flex items-center">
          <i class="fas fa-clipboard-list mr-2"></i>ข้อมูลการจองและลูกค้า
        </h5>
        <div class="space-y-1">
          ${createRow('หมายเลขการจอง', this.newRental.หมายเลขการจอง, false, 'fas fa-hashtag')}
          ${this.newRental.ช่องทางการจอง ? createRow('ช่องทางการจอง', this.newRental.ช่องทางการจอง, false, 'fas fa-route') : ''}
          ${createRow('ชื่อลูกค้า', this.newRental.ชื่อลูกค้า, false, 'fas fa-user-circle')}
          ${createRow('เบอร์โทรศัพท์', this.newRental.เบอร์โทรศัพท์, false, 'fas fa-phone')}
        </div>
      </div>

      <!-- Section 2: ข้อมูลรถและระยะเวลา -->
      <div class="mb-3 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
        <h5 class="font-semibold text-purple-800 mb-3 text-sm flex items-center">
          <i class="fas fa-car mr-2"></i>ข้อมูลรถและระยะเวลา
        </h5>
        <div class="space-y-1">
          ${createRow(
                isUnspecifiedMode ? 'รถที่ต้องการ' : 'รถที่เช่า',
                carInfo,
                false,
                'fas fa-car'
              )}
          ${createRow('วันที่เช่า', new Date(this.newRental.วันที่เช่า).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' + this.newRental.เวลารับรถ + ' น.', false, 'fas fa-calendar-alt')}
          ${createRow('วันที่คืน', new Date(this.newRental.วันที่คืน).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' + this.newRental.เวลาคืนรถ + ' น.', false, 'fas fa-calendar-check')}
          ${createRow('ระยะเวลาเช่า', rentalPeriodText, true, 'fas fa-clock')}
        </div>
        ${extraHoursNote}
      </div>

      <!-- Section 3: ค่าใช้จ่าย (แสดงเฉพาะโหมดปกติ) -->
      ${!isUnspecifiedMode && this.newRental.ราคา ? `
      <div class="mb-3 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
        <h5 class="font-semibold text-yellow-800 mb-3 text-sm flex items-center">
          <i class="fas fa-money-bill-wave mr-2"></i>รายละเอียดค่าใช้จ่าย
        </h5>
        <div class="space-y-1">
          ${createRow('ราคาต่อวัน', this.formatCurrency(this.newRental.ราคา), false, 'fas fa-tag')}
          ${this.newRental.ค่าบริการเพิ่มเติม && parseFloat(this.newRental.ค่าบริการเพิ่มเติม) > 0 ? createRow('ค่าบริการเพิ่มเติม', this.formatCurrency(this.newRental.ค่าบริการเพิ่มเติม), false, 'fas fa-plus-circle') : ''}
          ${this.newRental.ต้องการคาร์ซีท && (this.newRental.คาร์ซีทมีค่าบริการ === 'true' || this.newRental.คาร์ซีทมีค่าบริการ === true) && parseFloat(this.newRental.ค่าคาร์ซีท) > 0 ? createRow('ค่าคาร์ซีท', this.formatCurrency(this.newRental.ค่าคาร์ซีท), false, 'fas fa-baby') : ''}
          ${this.newRental.ต้องการประกันเสริม && parseFloat(this.newRental.ค่าประกันเสริมรวม) > 0 ? createRow('ค่าประกันเสริม', this.formatCurrency(this.newRental.ค่าประกันเสริมรวม), false, 'fas fa-shield-alt') : ''}
          ${this.newRental.ส่วนลด && parseFloat(this.newRental.ส่วนลด) > 0 ? createRow('ส่วนลด', '- ' + this.formatCurrency(this.newRental.ส่วนลด), false, 'fas fa-tags') : ''}
          ${this.newRental.ค่าล่วงเวลา && parseFloat(this.newRental.ค่าล่วงเวลา) > 0 ? createRow('ค่าล่วงเวลา', this.formatCurrency(this.newRental.ค่าล่วงเวลา), false, 'fas fa-hourglass-half') : ''}
          ${this.newRental.ค่าเช่ารวมทั้งหมด ? createRow('ค่าเช่ารวมทั้งหมด', this.formatCurrency(this.newRental.ค่าเช่ารวมทั้งหมด), true, 'fas fa-receipt') : ''}
        </div>
      </div>

      ${this.newRental.wantsTaxInvoice && parseFloat(this.newRental.taxInvoiceVATAmount) > 0 ? `
      <!-- Section: ใบกำกับภาษี VAT -->
      <div class="mb-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
        <h5 class="font-semibold text-green-800 mb-3 text-sm flex items-center">
          <i class="fas fa-file-invoice-dollar mr-2"></i>ใบกำกับภาษี
        </h5>
        <div class="space-y-1">
          ${createRow('จำนวนก่อน VAT', this.formatCurrencyOptional(this.newRental.taxInvoiceAmountExVAT), false, 'fas fa-calculator')}
          ${createRow('VAT 7%', this.formatCurrencyOptional(this.newRental.taxInvoiceVATAmount), false, 'fas fa-percentage')}
          ${createRow('ยอดรวม VAT', this.formatCurrencyOptional(this.newRental.taxInvoiceTotal), true, 'fas fa-money-check-alt')}
        </div>
      </div>
      ` : ''}

      ${this.newRental.wantsWHT && parseFloat(this.newRental.whtAmount) > 0 ? `
      <!-- Section: หัก ณ ที่จ่าย (WHT) -->
      <div class="mb-3 p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border border-orange-200">
        <h5 class="font-semibold text-orange-800 mb-3 text-sm flex items-center">
          <i class="fas fa-file-contract mr-2"></i>หัก ณ ที่จ่าย (WHT)
        </h5>
        <div class="space-y-1">
          ${createRow('ฐานภาษี (ก่อน VAT)', this.formatCurrencyOptional(this.newRental.whtBase || this.newRental.taxInvoiceAmountExVAT), false, 'fas fa-calculator')}
          ${createRow(`หัก ณ ที่จ่าย ${this.newRental.whtPercentage}%`, this.formatCurrencyOptional(this.newRental.whtAmount), true, 'fas fa-cut')}
        </div>
        <div class="mt-2 p-2 bg-orange-100 rounded text-xs text-orange-700">
          <i class="fas fa-info-circle mr-1"></i>
          <strong>หมายเหตุ:</strong> หัก ณ ที่จ่าย คำนวณจากยอดก่อน VAT
        </div>
      </div>
      ` : ''}

      <!-- Section 4: มัดจำและประกัน -->
      <div class="mb-3 p-4 bg-gradient-to-r from-teal-50 to-cyan-50 rounded-lg border border-teal-200">
        <h5 class="font-semibold text-teal-800 mb-3 text-sm flex items-center">
          <i class="fas fa-shield-alt mr-2"></i>มัดจำและประกัน
        </h5>
        <div class="space-y-1">
          ${this.newRental.ค่ามัดจำคิวรถ && parseFloat(this.newRental.ค่ามัดจำคิวรถ) > 0 ? createRow('ค่ามัดจำคิวรถ', this.formatCurrency(this.newRental.ค่ามัดจำคิวรถ), false, 'fas fa-hand-holding-usd') : createRow('ค่ามัดจำคิวรถ', '0 บาท', false, 'fas fa-hand-holding-usd')}
          ${this.newRental.เงินประกันความเสียหาย && parseFloat(this.newRental.เงินประกันความเสียหาย) > 0 ? createRow('เงินประกันความเสียหาย', this.formatCurrency(this.newRental.เงินประกันความเสียหาย), false, 'fas fa-shield-alt') : createRow('เงินประกันความเสียหาย', '0 บาท', false, 'fas fa-shield-alt')}
        </div>
      </div>

      <!-- Section 5: ยอดรวมชำระวันรับรถ (เด่นที่สุด) -->
      <div class="p-4 bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl border-2 border-green-400 shadow-md mb-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="bg-green-500 p-2.5 rounded-full mr-3 shadow-sm">
              <i class="fas fa-calculator text-white text-lg"></i>
            </div>
            <div>
              <h5 class="font-bold text-green-800 text-base">รวมยอดชำระวันรับรถ</h5>
              <p class="text-[10px] text-green-600 mt-0.5">(ค่าเช่า + เงินประกัน - ค่ามัดจำ)</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-green-700">
              ${this.formatCurrencyOptional(this.newRental.รวมยอดชำระวันรับรถ)}
            </div>
            <div class="text-xs text-green-600">บาท</div>
          </div>
        </div>
      </div>
      ` : ''}

      ${this.newRental.หมายเหตุ ? `
      <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
        <h5 class="font-semibold text-gray-700 mb-2 text-sm flex items-center">
          <i class="fas fa-comment-dots mr-2"></i>หมายเหตุ
        </h5>
        <p class="text-xs text-gray-600 leading-relaxed">${this.newRental.หมายเหตุ}</p>
      </div>
      ` : ''}
    </div>
  `;

          return html;
        },




        // proceedWithBookingSummary() {
        //   try {
        //     // คำนวณจำนวนวันและชั่วโมงที่เช่า
        //     const startDate = new Date(this.newRental.วันที่เช่า + 'T' + (this.newRental.เวลารับรถ || '08:00') + ':00');
        //     const endDate = new Date(this.newRental.วันที่คืน + 'T' + (this.newRental.เวลาคืนรถ || '08:00') + ':00');

        //     // คำนวณความต่างในชั่วโมง
        //     const diffMs = Math.abs(endDate - startDate);
        //     const diffHours = diffMs / (1000 * 60 * 60);

        //     // คำนวณจำนวนวันเต็ม
        //     const diffDays = Math.floor(diffHours / 24);

        //     // คำนวณชั่วโมงที่เหลือ
        //     const remainingHours = Math.floor(diffHours % 24);

        //     // ดึงค่าชั่วโมงที่คิดเพิ่ม
        //     const extraHoursThreshold = parseFloat(this.config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน) || 4;

        //     // คำนวณจำนวนวันที่ต้องจ่าย
        //     let rentalDays = diffDays;
        //     if (remainingHours > extraHoursThreshold) {
        //       rentalDays += 1;
        //     }

        //     // ถ้าเป็นศูนย์วัน ให้นับเป็น 1 วัน
        //     rentalDays = Math.max(1, rentalDays);

        //     // สร้างข้อความแสดงระยะเวลาเช่า
        //     let rentalPeriodText = `${rentalDays} วัน`;
        //     if (remainingHours > 0 && remainingHours <= extraHoursThreshold) {
        //       rentalPeriodText += ` ${remainingHours} ชั่วโมง`;
        //     }

        //     // สร้างข้อความอธิบายเพิ่มเติมเกี่ยวกับการคิดชั่วโมงเพิ่ม
        //     let extraHoursNote = '';
        //     if (extraHoursThreshold > 0) {
        //       extraHoursNote = `<div class="text-xs text-gray-500 mt-1">(หมายเหตุ: หากเกิน ${extraHoursThreshold} ชั่วโมง คิดเพิ่มเป็น 1 วัน)</div>`;
        //     }

        //     // สร้างข้อความสรุปข้อมูลการเช่า
        //     const rentalSummaryHTML = this.generateRentalSummaryHTML(rentalPeriodText, extraHoursNote);

        //     // แสดง SweetAlert2 เพื่อยืนยันการบันทึก
        //     Swal.fire({
        //   title: 'ยืนยันการบันทึกรายการเช่า',
        //   html: rentalSummaryHTML,
        //   icon: 'question',
        //   width: '36rem', // กำหนดความกว้างที่เหมาะสม
        //   showCancelButton: true,
        //   confirmButtonText: 'บันทึกรายการ',
        //   cancelButtonText: 'ยกเลิก',
        //   confirmButtonColor: '#10b981', // สีเขียว
        //   cancelButtonColor: '#ef4444', // สีแดง
        //   customClass: {
        //     container: 'rental-summary-container',
        //     popup: 'rental-summary-popup',
        //     content: 'text-left'
        //   }
        //     }).then((result) => {
        //       // รีเซ็ตปุ่มไม่ว่าจะยืนยันหรือยกเลิก
        //       this.resetSubmitButton();

        //       if (result.isConfirmed) {
        //         // ถ้ายืนยันให้เรียกฟังก์ชันบันทึกข้อมูล
        //         this.addRental();
        //       }
        //     }).catch(() => {
        //       // กรณีมีข้อผิดพลาดใน Swal ให้รีเซ็ตปุ่ม
        //       this.resetSubmitButton();
        //     });
        //   } catch (error) {
        //     // กรณีมีข้อผิดพลาดในการคำนวณ ให้รีเซ็ตปุ่มและแสดงข้อความผิดพลาด
        //     this.resetSubmitButton();
        //     this.showNotification('เกิดข้อผิดพลาดในการสร้างสรุปข้อมูล: ' + error, 'error');
        //   }
        // },

        // // ฟังก์ชันสำหรับสร้าง HTML สรุปข้อมูลการเช่า - แยกออกมาให้โค้ดอ่านง่ายขึ้น
        // generateRentalSummaryHTML(rentalPeriodText, extraHoursNote) {
        //   // ฟังก์ชันย่อยสำหรับสร้าง row ข้อมูล
        //   const createRow = (label, value, isHighlight = false) => {
        //     const valueClass = isHighlight ? 'font-bold text-green-600' : '';
        //     return `
        //       <div class="grid grid-cols-2 gap-2">
        //         <div class="font-semibold">${label}:</div>
        //         <div class="${valueClass}">${value}</div>
        //       </div>
        //     `;
        //   };

        //   // จัดกลุ่มข้อมูลตามประเภท
        //   const rentalData = [
        //     // ข้อมูลการจอง
        //     { 
        //       title: 'ข้อมูลการจอง',
        //       rows: [
        //         ['หมายเลขการจอง', this.newRental.หมายเลขการจอง],
        //         ['ช่องทางการจอง', this.newRental.ช่องทางการจอง]
        //       ]
        //     },
        //     // ข้อมูลลูกค้า
        //     {
        //       title: 'ข้อมูลลูกค้า',
        //       rows: [
        //         ['ชื่อลูกค้า', this.newRental.ชื่อลูกค้า],
        //         ['เบอร์โทรศัพท์', this.newRental.เบอร์โทรศัพท์]
        //       ]
        //     },
        //     // ข้อมูลรถ
        //     {
        //       title: 'ข้อมูลรถ',
        //       rows: [
        //         ['รถ', this.newRental.รถ],
        //         ['ทะเบียนรถ', this.newRental.ทะเบียนรถ]
        //       ]
        //     },
        //     // ข้อมูลระยะเวลา
        //     {
        //       title: 'ระยะเวลาการเช่า',
        //       rows: [
        //         ['วันที่เช่า', this.formatDate(this.newRental.วันที่เช่า)],
        //         ['วันที่คืน', this.formatDate(this.newRental.วันที่คืน)],
        //         ['ระยะเวลาเช่า', rentalPeriodText],
        //         ['เวลารับรถ', this.newRental.เวลารับรถ],
        //         ['เวลาคืนรถ', this.newRental.เวลาคืนรถ]
        //       ],
        //       extraNote: extraHoursNote
        //     },
        //     // ข้อมูลค่าใช้จ่าย
        //     {
        //       title: 'ค่าใช้จ่าย',
        //       rows: [
        //         ['ค่าเช่าต่อวัน', this.formatCurrency(this.newRental.ราคา)],
        //         ['ค่าเช่ารวมทั้งหมด', this.formatCurrency(this.newRental.ค่าเช่ารวมทั้งหมด)]
        //       ],
        //       conditionalRows: [
        //         { condition: this.newRental.ค่ามัดจำคิวรถ, label: 'ค่ามัดจำคิวรถ', value: this.formatCurrency(this.newRental.ค่ามัดจำคิวรถ) }
        //       ],
        //       finalRow: { label: 'รวมยอดชำระวันรับรถ', value: this.formatCurrency(this.newRental.รวมยอดชำระวันรับรถ), highlight: true }
        //     }
        //   ];

        //   // สร้าง HTML จากข้อมูลที่จัดกลุ่มไว้
        //   let html = `
        //     <div class="text-left">
        //       <h3 class="text-lg font-bold mb-3">โปรดตรวจสอบข้อมูลการเช่า</h3>
        //       <div class="space-y-4">
        //   `;

        //   // เพิ่มข้อมูลแต่ละกลุ่ม
        //   rentalData.forEach(group => {
        //     html += `
        //       <div class="mb-3">
        //         <div class="text-sm font-medium text-gray-500 mb-1">${group.title}</div>
        //         <div class="space-y-1 border-b pb-2">
        //     `;

        //     // เพิ่ม rows ปกติ
        //     group.rows.forEach(row => {
        //       html += createRow(row[0], row[1]);
        //     });

        //     // เพิ่ม extraNote (ถ้ามี)
        //     if (group.extraNote) {
        //       html += group.extraNote;
        //     }

        //     // เพิ่ม conditionalRows (ถ้ามี)
        //     if (group.conditionalRows) {
        //       group.conditionalRows.forEach(item => {
        //         if (item.condition) {
        //           html += createRow(item.label, item.value);
        //         }
        //       });
        //     }

        //     // เพิ่ม finalRow (ถ้ามี)
        //     if (group.finalRow) {
        //       html += createRow(group.finalRow.label, group.finalRow.value, group.finalRow.highlight);
        //     }

        //     html += `
        //         </div>
        //       </div>
        //     `;
        //   });

        //   html += `
        //       </div>
        //     </div>
        //   `;

        //   return html;
        // },




        async checkCarAvailability(rentalData, isEdit = false) {
          // เพิ่ม log เพื่อเช็คข้อมูลที่รับเข้ามา
          console.log("checkCarAvailability เริ่มทำงาน");
          console.log("rentalData:", rentalData);
          console.log("isEdit:", isEdit);
          console.log("config.ตรวจสอบคิวรถ:", this.config.ตรวจสอบคิวรถ);
          const sheetID = localStorage.getItem('sheetID') || '';
          // ตรวจสอบค่า "ตรวจสอบคิวรถ" จากการตั้งค่าระบบ
          if (this.config.ตรวจสอบคิวรถ === true) {
            // เตรียมข้อมูลสำหรับเรียกใช้ฟังก์ชัน checkCarBookingAvailability
            const currentCar = rentalData.รถ;

            // สร้างวันที่และเวลารับรถ
            const pickupDate = rentalData.วันที่เช่า;
            const pickupTime = rentalData.เวลารับรถ;
            const pickupDateTime = `${pickupDate}T${pickupTime}:00`;

            // สร้างวันที่และเวลาคืนรถ
            const returnDate = rentalData.วันที่คืน;
            const returnTime = rentalData.เวลาคืนรถ;
            const returnDateTime = `${returnDate}T${returnTime}:00`;

            // เพิ่ม log เพื่อเช็คค่าวันที่และเวลา
            console.log("ข้อมูลวันเวลา:");
            console.log("- currentCar:", currentCar);
            console.log("- pickupDate:", pickupDate);
            console.log("- pickupTime:", pickupTime);
            console.log("- pickupDateTime:", pickupDateTime);
            console.log("- returnDate:", returnDate);
            console.log("- returnTime:", returnTime);
            console.log("- returnDateTime:", returnDateTime);

            // ดึงค่า "ระยะเวลาเตรียมรถ" จากการตั้งค่าระบบ (แปลงเป็นตัวเลข) - หน่วยเป็นนาที
            const prepTimeMinutes = parseInt(this.config.ระยะเวลาเตรียมรถ) || 0;
            console.log("ระยะเวลาเตรียมรถ:", prepTimeMinutes, "นาที");

            // คำนวณวันที่เริ่มต้นโดยลบ "ระยะเวลาเตรียมรถ" จากวันที่รับรถ (คำนวณเป็นนาที)
            const pickupDateObj = new Date(pickupDateTime);
            const startDateObj = new Date(pickupDateObj);
            startDateObj.setMinutes(startDateObj.getMinutes() - prepTimeMinutes);

            // คำนวณวันที่สิ้นสุดโดยบวก "ระยะเวลาเตรียมรถ" กับวันที่คืนรถ (คำนวณเป็นนาที)
            const returnDateObj = new Date(returnDateTime);
            const endDateObj = new Date(returnDateObj);
            endDateObj.setMinutes(endDateObj.getMinutes() + prepTimeMinutes);

            // เพิ่ม log เพื่อเช็คค่า Date Objects
            console.log("Date Objects:");
            console.log("- pickupDateObj:", pickupDateObj);
            console.log("- startDateObj:", startDateObj, "(ลบ", prepTimeMinutes, "นาที)");
            console.log("- returnDateObj:", returnDateObj);
            console.log("- endDateObj:", endDateObj, "(บวก", prepTimeMinutes, "นาที)");

            // แปลงวันที่เป็นรูปแบบ ISO string
            const startDate = startDateObj.toISOString();
            const endDate = endDateObj.toISOString();
            console.log("- startDate (ISO):", startDate);
            console.log("- endDate (ISO):", endDate);

            // หมายเลขการจองที่กำลังแก้ไข (ใช้ในกรณีแก้ไข)
            const editingBookingNumber = isEdit ? rentalData.หมายเลขการจอง : null;
            console.log("- editingBookingNumber:", editingBookingNumber);

            try {
              console.log("เริ่มเรียกใช้ checkCarBookingAvailability");
              // เรียกใช้ฟังก์ชัน checkCarBookingAvailability
              const result = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler((response) => {
                    console.log("checkCarBookingAvailability response:", response);
                    resolve(response);
                  })
                  .withFailureHandler((error) => {
                    console.error("checkCarBookingAvailability error:", error);
                    reject(error);
                  })
                  .checkCarBookingAvailability(
                    currentCar,
                    pickupDateTime,
                    returnDateTime,
                    startDate,
                    endDate,
                    sheetID,
                    editingBookingNumber,
                    prepTimeMinutes  // เพิ่มพารามิเตอร์ระยะเวลาเตรียมรถ
                  );
              });

              console.log("ผลการตรวจสอบความพร้อมของรถ:", result);
              console.log("รถว่างหรือไม่:", result.available ? "ว่าง" : "ไม่ว่าง");

              // ตรวจสอบความพร้อมของรถ
              if (!result.available) {
                console.log("รถไม่ว่าง - แสดงข้อความเตือนพร้อมตัวเลือก");
                if (result.conflict) {
                  console.log("ข้อมูลการจองที่ซ้อนทับ:", result.conflict);
                }

                // กรณีรถไม่ว่าง แสดงข้อความเตือนพร้อมตัวเลือก
                const confirmResult = await Swal.fire({
                  title: 'รถไม่ว่างในช่วงเวลาดังกล่าว',
                  html: `
            <div class="text-left">
              <p>รถคันนี้ถูกจองในช่วงเวลาที่คุณต้องการแล้ว</p>
              ${result.conflict ? `
                <div class="bg-gray-100 p-3 my-2 rounded">
                  <p>รายละเอียดการจองที่ซ้อนทับ:</p>
                  <p>หมายเลขการจอง: <strong>${result.conflict.bookingNumber}</strong></p>
                  <p>ลูกค้า: <strong>${result.conflict.customer}</strong></p>
                  <p>วันรับรถ: <strong>${result.conflict.pickupDate}</strong> เวลา <strong>${result.conflict.pickupTime}</strong></p>
                  <p>วันคืนรถ: <strong>${result.conflict.returnDate}</strong> เวลา <strong>${result.conflict.returnTime}</strong></p>
                </div>
              ` : ''}
              <p class="mt-3 font-semibold">คุณต้องการดำเนินการอย่างไร?</p>
            </div>
          `,
                  icon: 'warning',
                  showDenyButton: true,
                  confirmButtonText: 'แก้ไขข้อมูล',
                  denyButtonText: 'ยืนยันการบันทึก',
                  showCancelButton: true,
                  cancelButtonText: 'ยกเลิก',
                  confirmButtonColor: '#3085d6',
                  denyButtonColor: '#dc3545'
                });

                console.log("ผู้ใช้เลือก:", confirmResult);

                if (confirmResult.isConfirmed) {
                  // ผู้ใช้เลือก "แก้ไขข้อมูล"
                  console.log("ผู้ใช้เลือก: แก้ไขข้อมูล");
                  return { continue: false, forceBook: false }; // กลับไปแก้ไขข้อมูลในฟอร์ม
                } else if (confirmResult.isDenied) {
                  // ผู้ใช้เลือก "ยืนยันการบันทึก" (บังคับจอง)
                  console.log("ผู้ใช้เลือก: ยืนยันการบันทึก (บังคับจอง)");

                  // แสดงข้อความยืนยันอีกครั้ง
                  const forceConfirm = await Swal.fire({
                    title: 'ยืนยันการบันทึก?',
                    text: 'การบันทึกจะทำให้เกิดการจองซ้อนทับกัน คุณแน่ใจหรือไม่?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#dc3545'
                  });

                  console.log("ผลการยืนยันบังคับจอง:", forceConfirm);

                  if (forceConfirm.isConfirmed) {
                    console.log("ผู้ใช้ยืนยันการบังคับจอง");
                    return {
                      continue: true,
                      forceBook: true,
                      bookingNumber: result.bookingNumber, // เพิ่มข้อมูลหมายเลขการจองที่ซ้อนทับ
                      conflict: result.conflict  // เพิ่มข้อมูลความขัดแย้ง (ถ้ามี)
                    };
                  } else {
                    console.log("ผู้ใช้ยกเลิกการบังคับจอง");
                    return { continue: false, forceBook: false }; // ยกเลิก
                  }
                } else {
                  // ผู้ใช้เลือก "ยกเลิก"
                  console.log("ผู้ใช้เลือก: ยกเลิก");
                  return { continue: false, forceBook: false }; // ยกเลิก
                }
              }

              // กรณีรถว่าง
              console.log("รถว่าง - ดำเนินการต่อไป");
              return { continue: true, forceBook: false };
            } catch (error) {
              // กรณีเกิดข้อผิดพลาดในการตรวจสอบ
              console.error("เกิดข้อผิดพลาดในการตรวจสอบความพร้อมของรถ:", error);

              // แสดง Dialog ให้ผู้ใช้เลือกว่าจะดำเนินการต่อหรือไม่
              const confirmResult = await Swal.fire({
                title: 'เกิดข้อผิดพลาดในการตรวจสอบความพร้อมของรถ',
                text: 'คุณต้องการดำเนินการต่อหรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ดำเนินการต่อ',
                cancelButtonText: 'ยกเลิก'
              });

              console.log("ผู้ใช้เลือกดำเนินการต่อแม้มีข้อผิดพลาด:", confirmResult.isConfirmed);
              return { continue: confirmResult.isConfirmed, forceBook: false };
            }
          } else {
            // กรณีไม่ต้องตรวจสอบคิวรถ
            console.log("ไม่มีการตรวจสอบคิวรถ (ตรวจสอบคิวรถ = false)");
            return { continue: true, forceBook: false };
          }
        },



        // ฟังก์ชันตรวจสอบการซ้ำ (Client)
        checkDuplicateBookingNumber() {
          return new Promise((resolve, reject) => {
            if (!this.newRental.หมายเลขการจอง) {
              // ถ้าไม่มีหมายเลขการจอง จะไม่มีการซ้ำ
              resolve(false);
              return;
            }

            this.isLoading = true;
            const sheetID = localStorage.getItem('sheetID') || '';

            google.script.run
              .withSuccessHandler(result => {
                this.isLoading = false;
                resolve(result === true);
              })
              .withFailureHandler(error => {
                this.isLoading = false;
                reject(error);
              })
              .checkBookingNumberExists(this.newRental.หมายเลขการจอง, sheetID);
          });
        },






        setSubmitButtonLoading() {
          this.isSubmitting = true;
        },

        // ฟังก์ชันสำหรับคืนสถานะปุ่มเป็นปกติ
        resetSubmitButton() {
          this.isSubmitting = false;
        },








        calculateRemainingHours() {
          try {
            if (!this.currentBookingDetails) return 0;
            if (!this.currentBookingDetails.startDate || !this.currentBookingDetails.endDate ||
              !this.currentBookingDetails.startTime || !this.currentBookingDetails.endTime) {
              return 0;
            }

            // แปลงวันที่จาก dd/mm/yyyy เป็น yyyy-mm-dd
            const startParts = this.currentBookingDetails.startDate.split('/');
            const endParts = this.currentBookingDetails.endDate.split('/');

            if (startParts.length !== 3 || endParts.length !== 3) return 0;

            // สร้าง Date objects
            const startDate = new Date(`${startParts[2]}-${startParts[1]}-${startParts[0]}T${this.currentBookingDetails.startTime}:00`);
            const endDate = new Date(`${endParts[2]}-${endParts[1]}-${endParts[0]}T${this.currentBookingDetails.endTime}:00`);

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return 0;

            // คำนวณความต่างในมิลลิวินาที
            const diffMs = endDate.getTime() - startDate.getTime();

            // แปลงเป็นชั่วโมง
            const diffHours = diffMs / (1000 * 60 * 60);

            // คำนวณชั่วโมงที่เหลือ
            const remainingHours = Math.floor(diffHours % 24);

            // ดึงค่าชั่วโมงที่คิดเพิ่ม
            const extraHoursThreshold = parseFloat(this.config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน) || 4;

            // ถ้าชั่วโมงเกินกว่าค่าที่กำหนด จะถูกคิดเป็น 1 วันเต็ม แสดงเป็น 0 ชั่วโมง
            return remainingHours > extraHoursThreshold ? 0 : remainingHours;
          } catch (e) {
            console.error("เกิดข้อผิดพลาดในการคำนวณชั่วโมงที่เหลือ:", e);
            return 0;
          }
        },







        // ========== เพิ่ม 3 ฟังก์ชันนี้เข้าไปใหม่ ==========

        // ฟังก์ชันหลักสำหรับเรียกคำนวณภาษีทั้งหมด
        calculateAllTaxes() {
          this.calculateVAT();
          this.calculateWHT();
        },

        // ฟังก์ชันสำหรับคำนวณ VAT และค่าเช่ารวมทั้งหมด
        calculateVAT() {
          const totalRent = parseFloat(this.newRental.totalRentWithoutVat) || 0;

          // ตรวจสอบว่าผู้ใช้เลือก "ใบกำกับภาษี" หรือไม่
          if (this.newRental.receiptType === 'tax_invoice') {
            this.newRental.vatAmount = totalRent * 0.07;
          } else {
            this.newRental.vatAmount = 0;
          }

          // ไม่ต้องอัพเดท newRental.ค่าเช่ารวมทั้งหมด เพราะเป็นฟิลด์ input
          // การแสดงผลจะคำนวณใน template โดยตรง
        },

        // ฟังก์ชันสำหรับคำนวณภาษีหัก ณ ที่จ่าย
        calculateWHT() {
          // ตรวจสอบว่าผู้ใช้เลือก "หัก ณ ที่จ่าย" หรือไม่
          if (this.newRental.wantsWHT) {
            // คำนวณฐานหัก ณ ที่จ่ายจากต้นทาง: ค่าเช่าพื้นฐาน + ค่าล่วงเวลา - ส่วนลด
            let baseAmount = (parseFloat(this.newRental.ค่าเช่าพื้นฐาน) || 0)
              + (parseFloat(this.newRental.ค่าล่วงเวลา) || 0)
              - (parseFloat(this.newRental.ส่วนลด) || 0);

            // เพิ่มค่าบริการเพิ่มเติมถ้าติ๊กให้รวมหัก ณ ที่จ่าย
            if (this.newRental.additionalServiceIncludeWHT === true) {
              baseAmount += parseFloat(this.newRental.ค่าบริการเพิ่มเติม) || 0;
            }

            // เพิ่มค่าคาร์ซีทถ้าติ๊กให้รวมหัก ณ ที่จ่าย
            if (this.newRental.carSeatIncludeWHT === true && this.newRental.ต้องการคาร์ซีท && (this.newRental.คาร์ซีทมีค่าบริการ === 'true' || this.newRental.คาร์ซีทมีค่าบริการ === true)) {
              baseAmount += parseFloat(this.newRental.ค่าคาร์ซีท) || 0;
            }

            // เพิ่มค่าประกันเสริมถ้าติ๊กให้รวมหัก ณ ที่จ่าย
            if (this.newRental.insuranceIncludeWHT === true && this.newRental.ต้องการประกันเสริม) {
              baseAmount += parseFloat(this.newRental.ค่าประกันเสริมรวม) || 0;
            }

            // เก็บฐานคำนวณ WHT ไว้แสดงผล
            this.newRental.whtBaseAmount = Math.round(baseAmount * 100) / 100;

            const percentage = parseFloat(this.newRental.whtPercentage) || 5;
            this.newRental.whtAmount = Math.round((baseAmount * percentage) / 100 * 100) / 100;
          } else {
            this.newRental.whtAmount = 0;
            this.newRental.whtBaseAmount = 0;
          }
        },

        // ฟังก์ชันคำนวณฐาน VAT ใหม่เมื่อเปลี่ยน checkbox
        recalculateVATBase() {
          if (this.newRental.wantsTaxInvoice) {
            // คำนวณจากต้นทาง: ค่าเช่าพื้นฐาน + ค่าล่วงเวลา - ส่วนลด
            let baseAmount = (parseFloat(this.newRental.ค่าเช่าพื้นฐาน) || 0)
              + (parseFloat(this.newRental.ค่าล่วงเวลา) || 0)
              - (parseFloat(this.newRental.ส่วนลด) || 0);

            // เพิ่มค่าบริการเพิ่มเติมถ้าติ๊กให้รวม VAT
            if (this.newRental.additionalServiceIncludeVAT === true) {
              baseAmount += parseFloat(this.newRental.ค่าบริการเพิ่มเติม) || 0;
            }

            // เพิ่มค่าคาร์ซีทถ้าติ๊กให้รวม VAT
            if (this.newRental.carSeatIncludeVAT === true && this.newRental.ต้องการคาร์ซีท && (this.newRental.คาร์ซีทมีค่าบริการ === 'true' || this.newRental.คาร์ซีทมีค่าบริการ === true)) {
              baseAmount += parseFloat(this.newRental.ค่าคาร์ซีท) || 0;
            }

            // เพิ่มค่าประกันเสริมถ้าติ๊กให้รวม VAT
            if (this.newRental.insuranceIncludeVAT === true && this.newRental.ต้องการประกันเสริม) {
              baseAmount += parseFloat(this.newRental.ค่าประกันเสริมรวม) || 0;
            }

            this.newRental.taxInvoiceAmountExVAT = Math.round(baseAmount * 100) / 100;
            this.calculateTaxInvoiceVAT();
          }
        },

        // ฟังก์ชันสำหรับจัดการเมื่อติ๊ก "ต้องการหัก ณ ที่จ่าย"
        toggleWHT() {
          if (this.newRental.wantsWHT) {
            // ใช้ค่าเริ่มต้นจาก config สำหรับ checkbox VAT/WHT
            if (this.config.carSeatIncludeWHT !== undefined) {
              this.newRental.carSeatIncludeWHT = this.config.carSeatIncludeWHT;
            }
            if (this.config.insuranceIncludeWHT !== undefined) {
              this.newRental.insuranceIncludeWHT = this.config.insuranceIncludeWHT;
            }

            // คำนวณหัก ณ ที่จ่าย
            this.calculateWHT();
          } else {
            // ยกเลิกการหัก ณ ที่จ่าย
            this.newRental.whtAmount = 0;
          }
          // อัปเดตยอดรวมชำระวันรับรถ
          this.calculateFinalAmount();
        },

        // ฟังก์ชันสำหรับจัดการเมื่อติ๊ก "ต้องการใบกำกับภาษี"
        toggleTaxInvoice() {
          if (this.newRental.wantsTaxInvoice) {
            // ใช้ค่าเริ่มต้นจาก config สำหรับ checkbox VAT/WHT
            if (this.config.carSeatIncludeVAT !== undefined) {
              this.newRental.carSeatIncludeVAT = this.config.carSeatIncludeVAT;
            }
            if (this.config.insuranceIncludeVAT !== undefined) {
              this.newRental.insuranceIncludeVAT = this.config.insuranceIncludeVAT;
            }

            // เมื่อติ๊ก คำนวณฐาน VAT จากรายการที่เลือก
            // คำนวณจากต้นทาง: ค่าเช่าพื้นฐาน + ค่าล่วงเวลา - ส่วนลด
            let baseAmount = (parseFloat(this.newRental.ค่าเช่าพื้นฐาน) || 0)
              + (parseFloat(this.newRental.ค่าล่วงเวลา) || 0)
              - (parseFloat(this.newRental.ส่วนลด) || 0);

            // เพิ่มค่าบริการเพิ่มเติมถ้าติ๊กให้รวม VAT
            if (this.newRental.additionalServiceIncludeVAT === true) {
              baseAmount += parseFloat(this.newRental.ค่าบริการเพิ่มเติม) || 0;
            }

            // เพิ่มค่าคาร์ซีทถ้าติ๊กให้รวม VAT
            if (this.newRental.carSeatIncludeVAT === true && this.newRental.ต้องการคาร์ซีท && (this.newRental.คาร์ซีทมีค่าบริการ === 'true' || this.newRental.คาร์ซีทมีค่าบริการ === true)) {
              baseAmount += parseFloat(this.newRental.ค่าคาร์ซีท) || 0;
            }

            // เพิ่มค่าประกันเสริมถ้าติ๊กให้รวม VAT
            if (this.newRental.insuranceIncludeVAT === true && this.newRental.ต้องการประกันเสริม) {
              baseAmount += parseFloat(this.newRental.ค่าประกันเสริมรวม) || 0;
            }

            this.newRental.taxInvoiceAmountExVAT = Math.round(baseAmount * 100) / 100;
            this.calculateTaxInvoiceVAT();
          } else {
            // เมื่อยกเลิก ล้างค่า VAT และคำนวณยอดใหม่ (ไม่แก้ไขค่าเช่ารวมทั้งหมด)
            this.newRental.taxInvoiceAmountExVAT = 0;
            this.newRental.taxInvoiceVATAmount = 0;
            this.newRental.taxInvoiceTotal = 0;
            this.calculateFinalAmount();
          }
        },

        // ฟังก์ชันสำหรับคำนวณ VAT 7% สำหรับใบกำกับภาษี
        calculateTaxInvoiceVAT() {
          // ป้องกันการวนลูป
          if (this._isUpdatingFromVAT) return;

          const amountExVAT = parseFloat(this.newRental.taxInvoiceAmountExVAT) || 0;
          const vatAmount = Math.round(amountExVAT * 0.07 * 100) / 100; // คำนวณ VAT 7% และปัดเศษ 2 ตำแหน่ง
          const total = Math.round((amountExVAT + vatAmount) * 100) / 100; // ยอดรวม VAT

          this.newRental.taxInvoiceVATAmount = vatAmount;
          this.newRental.taxInvoiceTotal = total;

          // ไม่อัพเดท "ค่าเช่ารวมทั้งหมด" เพราะใช้แสดงผลใน "สรุปภาพรวมค่าใช้จ่าย" แล้ว

          // 🕵️‍♂️ DEBUG LOG 3
          console.log('--- calculateTaxInvoiceVAT (สร้างใหม่) ---');
          console.log('จำนวนก่อน VAT (Input):', this.newRental.taxInvoiceAmountExVAT);
          console.log('คำนวณ VAT (vatAmount):', vatAmount);
          console.log('ยอดรวม VAT (total):', total);
          // 🕵️‍♂️ END DEBUG LOG 3

          // อัพเดทยอดชำระวันรับรถ
          this.calculateFinalAmount();
        },

        // ฟังก์ชันสำหรับจัดการเมื่อติ๊ก "ต้องการใบกำกับภาษี" (โหมดแก้ไข)
        toggleEditTaxInvoice() {
          if (this.editRentalData.wantsTaxInvoice) {
            // เมื่อติ๊ก คำนวณฐาน VAT จากรายการที่เลือก
            // คำนวณจากต้นทาง: ค่าเช่าพื้นฐาน + ค่าล่วงเวลา - ส่วนลด
            let baseAmount = (parseFloat(this.editRentalData.ค่าเช่าพื้นฐาน) || 0)
              + (parseFloat(this.editRentalData.ค่าล่วงเวลา) || 0)
              - (parseFloat(this.editRentalData.ส่วนลด) || 0);

            // เพิ่มค่าบริการเพิ่มเติมถ้าติ๊กให้รวม VAT
            if (this.editRentalData.additionalServiceIncludeVAT === true) {
              baseAmount += parseFloat(this.editRentalData.ค่าบริการเพิ่มเติม) || 0;
            }

            // เพิ่มค่าคาร์ซีทถ้าติ๊กให้รวม VAT
            if (this.editRentalData.carSeatIncludeVAT === true && this.editRentalData.ต้องการคาร์ซีท && (this.editRentalData.คาร์ซีทมีค่าบริการ === 'true' || this.editRentalData.คาร์ซีทมีค่าบริการ === true)) {
              baseAmount += parseFloat(this.editRentalData.ค่าคาร์ซีท) || 0;
            }

            // เพิ่มค่าประกันเสริมถ้าติ๊กให้รวม VAT
            if (this.editRentalData.insuranceIncludeVAT === true && this.editRentalData.ต้องการประกันเสริม) {
              baseAmount += parseFloat(this.editRentalData.ค่าประกันเสริมรวม) || 0;
            }

            this.editRentalData.taxInvoiceAmountExVAT = Math.round(baseAmount * 100) / 100;
            this.calculateEditTaxInvoiceVAT();
          } else {
            // เมื่อยกเลิก ล้างค่า VAT และคำนวณยอดใหม่ (ไม่แก้ไขค่าเช่ารวมทั้งหมด)
            this.editRentalData.taxInvoiceAmountExVAT = 0;
            this.editRentalData.taxInvoiceVATAmount = 0;
            this.editRentalData.taxInvoiceTotal = 0;
            this.calculateEditFinalAmount();
          }
        },

        // ฟังก์ชันสำหรับคำนวณ VAT 7% สำหรับใบกำกับภาษี (โหมดแก้ไข)
        calculateEditTaxInvoiceVAT() {
          const amountExVAT = parseFloat(this.editRentalData.taxInvoiceAmountExVAT) || 0;
          const vatAmount = Math.round(amountExVAT * 0.07 * 100) / 100; // คำนวณ VAT 7% และปัดเศษ 2 ตำแหน่ง
          const total = Math.round((amountExVAT + vatAmount) * 100) / 100; // ยอดรวม VAT

          this.editRentalData.taxInvoiceVATAmount = vatAmount;
          this.editRentalData.taxInvoiceTotal = total;

          // ไม่อัพเดท "ค่าเช่ารวมทั้งหมด" เพราะใช้แสดงผลใน "สรุปภาพรวมค่าใช้จ่าย" แล้ว

          // อัพเดทยอดชำระวันรับรถ
          this.calculateEditFinalAmount();
        },

        // ฟังก์ชันเปิด/ปิดการหัก ณ ที่จ่าย (โหมดแก้ไข)
        toggleEditWHT() {
          if (this.editRentalData.wantsWHT) {
            // คำนวณหัก ณ ที่จ่าย
            this.calculateEditWHT();
          } else {
            // ยกเลิกการหัก ณ ที่จ่าย
            this.editRentalData.whtAmount = 0;
          }
          // อัปเดตยอดรวมชำระวันรับรถ
          this.calculateEditFinalAmount();
        },

        // ฟังก์ชันสำหรับคำนวณภาษีหัก ณ ที่จ่าย (โหมดแก้ไข)
        calculateEditWHT() {
          // ตรวจสอบว่าผู้ใช้เลือก "หัก ณ ที่จ่าย" หรือไม่
          if (this.editRentalData.wantsWHT) {
            // คำนวณฐานหัก ณ ที่จ่ายจากต้นทาง: ค่าเช่าพื้นฐาน + ค่าล่วงเวลา - ส่วนลด
            let baseAmount = (parseFloat(this.editRentalData.ค่าเช่าพื้นฐาน) || 0)
              + (parseFloat(this.editRentalData.ค่าล่วงเวลา) || 0)
              - (parseFloat(this.editRentalData.ส่วนลด) || 0);

            // เพิ่มค่าบริการเพิ่มเติมถ้าติ๊กให้รวมหัก ณ ที่จ่าย
            if (this.editRentalData.additionalServiceIncludeWHT === true) {
              baseAmount += parseFloat(this.editRentalData.ค่าบริการเพิ่มเติม) || 0;
            }

            // เพิ่มค่าคาร์ซีทถ้าติ๊กให้รวมหัก ณ ที่จ่าย
            if (this.editRentalData.carSeatIncludeWHT === true && this.editRentalData.ต้องการคาร์ซีท && (this.editRentalData.คาร์ซีทมีค่าบริการ === 'true' || this.editRentalData.คาร์ซีทมีค่าบริการ === true)) {
              baseAmount += parseFloat(this.editRentalData.ค่าคาร์ซีท) || 0;
            }

            // เพิ่มค่าประกันเสริมถ้าติ๊กให้รวมหัก ณ ที่จ่าย
            if (this.editRentalData.insuranceIncludeWHT === true && this.editRentalData.ต้องการประกันเสริม) {
              baseAmount += parseFloat(this.editRentalData.ค่าประกันเสริมรวม) || 0;
            }

            // เก็บฐานคำนวณ WHT ไว้แสดงผล
            this.editRentalData.whtBaseAmount = Math.round(baseAmount * 100) / 100;

            const percentage = parseFloat(this.editRentalData.whtPercentage) || 5;
            this.editRentalData.whtAmount = Math.round((baseAmount * percentage) / 100 * 100) / 100;
          } else {
            this.editRentalData.whtAmount = 0;
            this.editRentalData.whtBaseAmount = 0;
          }
        },

        // ฟังก์ชันคำนวณฐาน VAT ใหม่สำหรับ modal แก้ไข
        recalculateEditVATBase() {
          if (this.editRentalData.wantsTaxInvoice) {
            // คำนวณจากต้นทาง: ค่าเช่าพื้นฐาน + ค่าล่วงเวลา - ส่วนลด
            let baseAmount = (parseFloat(this.editRentalData.ค่าเช่าพื้นฐาน) || 0)
              + (parseFloat(this.editRentalData.ค่าล่วงเวลา) || 0)
              - (parseFloat(this.editRentalData.ส่วนลด) || 0);

            // เพิ่มค่าบริการเพิ่มเติมถ้าติ๊กให้รวม VAT
            if (this.editRentalData.additionalServiceIncludeVAT === true) {
              baseAmount += parseFloat(this.editRentalData.ค่าบริการเพิ่มเติม) || 0;
            }

            // เพิ่มค่าคาร์ซีทถ้าติ๊กให้รวม VAT
            if (this.editRentalData.carSeatIncludeVAT === true && this.editRentalData.ต้องการคาร์ซีท && (this.editRentalData.คาร์ซีทมีค่าบริการ === 'true' || this.editRentalData.คาร์ซีทมีค่าบริการ === true)) {
              baseAmount += parseFloat(this.editRentalData.ค่าคาร์ซีท) || 0;
            }

            // เพิ่มค่าประกันเสริมถ้าติ๊กให้รวม VAT
            if (this.editRentalData.insuranceIncludeVAT === true && this.editRentalData.ต้องการประกันเสริม) {
              baseAmount += parseFloat(this.editRentalData.ค่าประกันเสริมรวม) || 0;
            }

            this.editRentalData.taxInvoiceAmountExVAT = Math.round(baseAmount * 100) / 100;
            this.calculateEditTaxInvoiceVAT();
          }
        },

        // ฟังก์ชันสำหรับคำนวณค่าคอมมิชชั่น
        calculateCommission() {
          if (!this.newRental.มีค่าคอมมิชชั่น) {
            this.newRental.ค่าคอมมิชชั่น = 0;
            return;
          }

          const selectedName = this.newRental.ค่าคอมมิชชั่นที่เลือก;
          const totalRental = parseFloat(this.newRental.ค่าเช่ารวมทั้งหมด) || 0;

          // ถ้าไม่ได้เลือกรูปแบบ (คือ "กำหนดเอง") ให้ผู้ใช้กรอกค่าเอง
          if (!selectedName) {
            return;
          }

          const commissionSetting = this.commissionList.find(item => item.ชื่อ === selectedName);

          if (!commissionSetting) {
            this.newRental.ค่าคอมมิชชั่น = 0;
            return;
          }

          let commission = 0;
          if (commissionSetting.รูปแบบ === 'fixed') {
            const rentalInfo = this.calculateRentalDaysWithHours(
              this.newRental.วันที่เช่า,
              this.newRental.วันที่คืน,
              this.newRental.เวลารับรถ,
              this.newRental.เวลาคืนรถ
            );

            // ตรวจสอบว่าได้ค่า rentalInfo ที่ถูกต้องหรือไม่
            if (!rentalInfo || typeof rentalInfo.days !== 'number' || isNaN(rentalInfo.days)) {
              console.error("calculateRentalDaysWithHours() ส่งค่ากลับมาไม่ถูกต้องใน calculateCommission:", rentalInfo);
              this.newRental.ค่าคอมมิชชั่น = 0;
              return;
            }

            commission = (parseFloat(commissionSetting.ค่าFixed) || 0) * rentalInfo.days;

          } else if (commissionSetting.รูปแบบ === 'percent+vat') {
            const percent = parseFloat(commissionSetting.ค่าเปอร์เซ็นต์) || 0;
            const vat = parseFloat(commissionSetting.vat) || 0;
            const baseCommission = (totalRental * percent) / 100;
            const vatAmount = (baseCommission * vat) / 100;
            commission = baseCommission + vatAmount;
          }

          // ตรวจสอบว่าไม่มี NaN ก่อน assign
          if (!isNaN(commission) && isFinite(commission)) {
            this.newRental.ค่าคอมมิชชั่น = commission.toFixed(2);
          } else {
            this.newRental.ค่าคอมมิชชั่น = 0;
          }
        },

        // ฟังก์ชันที่จะถูกเรียกเมื่อมีการเปลี่ยนแปลงค่าเช่ารวม หรือ ติ๊ก/ไม่ติ๊ก checkbox
        updateCommissionOnToggle() {
          // ถ้าไม่ติ๊ก ให้เคลียร์ค่าทั้งหมด
          if (!this.newRental.มีค่าคอมมิชชั่น) {
            this.newRental.ค่าคอมมิชชั่นที่เลือก = '';
            this.newRental.ค่าคอมมิชชั่น = 0;
          }
          this.calculateCommission();
        },


        commissionToggle() {
          // เปิด/ปิด คอมมิชชั่น (ใช้ logic เดิม)
          if (!this.newRental.มีค่าคอมมิชชั่น) {
            this.newRental.ค่าคอมมิชชั่นที่เลือก = '';
            this.newRental.ค่าคอมมิชชั่น = 0;
          }
          this.calculateCommission();
        },






        /**
         * คำนวณจำนวนวันเช่าโดยพิจารณาชั่วโมง (เวอร์ชันแก้ไข: จัดการรูปแบบเวลาจาก Google Sheet)
         */
        calculateRentalDaysWithHours(startDateStr, endDateStr, startTimeStr, endTimeStr) {
          try {
            // 🟡 1. แปลงวันที่เริ่มต้นและสิ้นสุดให้เป็น Date Object ที่ถูกต้อง
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            // 🟡 2. จัดการกับเวลา (Time) ที่อาจมีวันที่เป็นปี 1899
            // สร้างฟังก์ชัน Helper เพื่อสกัดเอาเฉพาะ "ชั่วโมง:นาที"
            const extractTime = (timeInput) => {
              if (!timeInput) return { hours: 0, minutes: 0 };

              // ลองแปลงเป็น Date Object
              const timeObj = new Date(timeInput);

              // ตรวจสอบว่า Date ที่ได้มาเป็นวันที่ถูกต้องหรือไม่ (getTime() จะไม่เป็น NaN)
              if (!isNaN(timeObj.getTime())) {
                // ถ้าแปลงได้สำเร็จ ให้ดึงค่าชั่วโมงและนาที
                return { hours: timeObj.getHours(), minutes: timeObj.getMinutes() };
              }

              // ถ้าแปลงเป็น Date ไม่ได้ (อาจมาในรูปแบบ 'HH:mm')
              // ให้แยกด้วย : แล้วแปลงเป็นตัวเลข
              if (typeof timeInput === 'string' && timeInput.includes(':')) {
                const parts = timeInput.split(':');
                return {
                  hours: parseInt(parts[0], 10) || 0,
                  minutes: parseInt(parts[1], 10) || 0
                };
              }

              // กรณีอื่นๆ ทั้งหมด ให้คืนค่าเป็น 0
              return { hours: 0, minutes: 0 };
            };

            const startTime = extractTime(startTimeStr);
            const endTime = extractTime(endTimeStr);

            // 🟡 3. สร้าง Date Object ที่สมบูรณ์โดยรวมวันที่และเวลาเข้าด้วยกัน
            const startDateTime = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), startTime.hours, startTime.minutes);
            const endDateTime = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), endTime.hours, endTime.minutes);

            // 🟢 4. คำนวณผลต่าง
            const diffInMs = endDateTime.getTime() - startDateTime.getTime();
            if (diffInMs < 0) return { days: 0, extraHours: 0, totalHours: 0 };

            const totalHours = diffInMs / (1000 * 60 * 60);

            // 🟢 5. คำนวณจำนวนวันเต็ม และชั่วโมงที่เหลือ
            const fullDays = Math.floor(totalHours / 24);
            const remainingHours = totalHours % 24;

            // 🟢 6. ตรวจสอบว่าต้องคิดเพิ่มเป็นอีก 1 วันหรือไม่
            const extraHoursThreshold = parseFloat(this.config.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน) || 4;

            if (remainingHours >= extraHoursThreshold) {
              // ถ้าชั่วโมงที่เหลือ >= threshold จะคิดเพิ่มเป็นอีก 1 วัน
              return {
                days: fullDays + 1,
                extraHours: 0, // ไม่มีชั่วโมงล่วงเวลา (คิดเป็นวันเต็มแล้ว)
                totalHours: totalHours,
                isFullDayCharge: true
              };
            } else {
              // ถ้าชั่วโมงที่เหลือ < threshold จะคิดค่าล่วงเวลารายชั่วโมง
              return {
                days: fullDays > 0 ? fullDays : 1, // อย่างน้อย 1 วัน
                extraHours: remainingHours,
                totalHours: totalHours,
                isFullDayCharge: false
              };
            }

          } catch (error) {
            console.error("เกิดข้อผิดพลาดใน calculateRentalDaysWithHours:", error);
            console.log({ startDateStr, endDateStr, startTimeStr, endTimeStr });
            return { days: 0, extraHours: 0, totalHours: 0 };
          }
        },




        // คำนวณค่าเช่ารวมทั้งหมด (สำหรับการสร้างใหม่)
        calculateTotalRental() {
          if (!this.newRental.วันที่เช่า || !this.newRental.วันที่คืน || !this.newRental.ราคา ||
            !this.newRental.เวลารับรถ || !this.newRental.เวลาคืนรถ) {

            // ถ้าข้อมูลไม่ครบ ให้รีเซ็ตค่า
            this.newRental.totalRentWithoutVat = 0;
            this.newRental.ค่าเช่ารวมทั้งหมด = '0';
            this.calculateAllTaxes();
            this.calculateCommission();
            this.calculateFinalAmount();
            return;
          }

          // 1. คำนวณจำนวนวันเช่า และชั่วโมงล่วงเวลา
          const rentalInfo = this.calculateRentalDaysWithHours(
            this.newRental.วันที่เช่า,
            this.newRental.วันที่คืน,
            this.newRental.เวลารับรถ,
            this.newRental.เวลาคืนรถ
          );

          // ตรวจสอบว่าได้ค่า rentalInfo ที่ถูกต้องหรือไม่
          if (!rentalInfo || typeof rentalInfo.days !== 'number' || isNaN(rentalInfo.days)) {
            console.error("calculateRentalDaysWithHours() ส่งค่ากลับมาไม่ถูกต้อง:", rentalInfo);
            this.newRental.totalRentWithoutVat = 0;
            this.newRental.ค่าเช่ารวมทั้งหมด = '0';
            this.calculateAllTaxes();
            this.calculateCommission();
            this.calculateFinalAmount();
            return;
          }

          // 2. คำนวณค่าเช่าพื้นฐาน (วัน × ราคาต่อวัน)
          const dailyRate = parseFloat(this.newRental.ราคา) || 0;
          const additionalFee = parseFloat(this.newRental.ค่าบริการเพิ่มเติม) || 0;
          const carSeatFee = (this.newRental.ต้องการคาร์ซีท && (this.newRental.คาร์ซีทมีค่าบริการ === 'true' || this.newRental.คาร์ซีทมีค่าบริการ === true)) ? (parseFloat(this.newRental.ค่าคาร์ซีท) || 0) : 0;
          const insuranceFee = this.newRental.ต้องการประกันเสริม ? (parseFloat(this.newRental.ค่าประกันเสริมรวม) || 0) : 0;
          let rentalBaseCost = dailyRate * rentalInfo.days;

          // 3. คำนวณค่าล่วงเวลา (ถ้ามี)
          let overtimeCost = 0;
          this.newRental.usingDefaultOvertimeRate = false; // รีเซ็ตค่า

          if (rentalInfo.extraHours > 0 && !rentalInfo.isFullDayCharge) {
            // หักชั่วโมงฟรีออกก่อน
            const freeOvertimeHours = parseFloat(this.config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน) || 0;
            const chargeableHours = Math.max(0, rentalInfo.extraHours - freeOvertimeHours);

            if (chargeableHours > 0) {
              // ดึงค่าล่วงเวลาจากรถ หรือใช้ค่าเริ่มต้นของระบบ
              const selectedCar = this.cars.find(car => car.ทะเบียน === this.newRental.ทะเบียนรถ);
              const carOvertimeRate = selectedCar?.ค่าล่วงเวลาต่อชั่วโมง;

              let overtimeRate;
              if (carOvertimeRate && parseFloat(carOvertimeRate) > 0) {
                // รถมีการตั้งค่าล่วงเวลาเอง
                overtimeRate = parseFloat(carOvertimeRate);
                this.newRental.usingDefaultOvertimeRate = false;
              } else {
                // ใช้ค่าเริ่มต้นจากระบบ หรือ 100 บาท
                overtimeRate = parseFloat(this.config.ค่าล่วงเวลาเริ่มต้น) || 100;
                this.newRental.usingDefaultOvertimeRate = true;
              }

              overtimeCost = chargeableHours * overtimeRate;
            }
          }

          // 4. รวมค่าเช่าทั้งหมด
          const totalBeforeDiscount = rentalBaseCost + overtimeCost + additionalFee + carSeatFee + insuranceFee;

          // 5. หักส่วนลดออก
          const discount = parseFloat(this.newRental.ส่วนลด) || 0;
          const totalBeforeTax = totalBeforeDiscount - discount;

          // 6. เก็บค่าต่างๆ ไว้ในตัวแปร
          // ตรวจสอบว่าไม่มีค่า NaN ก่อน assign
          if (!isNaN(totalBeforeTax) && isFinite(totalBeforeTax)) {
            this.newRental.totalRentWithoutVat = totalBeforeTax;
          }
          if (!isNaN(rentalInfo.days) && isFinite(rentalInfo.days)) {
            this.newRental.จำนวนวันเช่า = rentalInfo.days;
          }
          if (!isNaN(rentalBaseCost) && isFinite(rentalBaseCost)) {
            this.newRental.ค่าเช่าพื้นฐาน = rentalBaseCost;
          }
          if (!isNaN(overtimeCost) && isFinite(overtimeCost)) {
            this.newRental.ค่าล่วงเวลา = overtimeCost;
          }
          if (!isNaN(rentalInfo.extraHours) && isFinite(rentalInfo.extraHours)) {
            this.newRental.ชั่วโมงล่วงเวลา = rentalInfo.extraHours;
          }

          // 5. เรียกฟังก์ชันคำนวณภาษี (VAT และ WHT)
          this.calculateAllTaxes();

          // 6. อัพเดท ค่าเช่ารวมทั้งหมด (สำหรับ input field)
          if (!isNaN(totalBeforeTax) && isFinite(totalBeforeTax)) {
            this.newRental.ค่าเช่ารวมทั้งหมด = totalBeforeTax.toString();
          }

          // 6. เรียกฟังก์ชันคำนวณค่าคอมมิชชั่น และยอดชำระสุดท้าย
          this.calculateCommission();
          this.calculateFinalAmount();

          // 🕵️‍♂️ DEBUG LOG 1
          console.log('--- calculateTotalRental (สร้างใหม่) ---');
          console.log('ค่าเช่าพื้นฐาน:', rentalBaseCost);
          console.log('ค่าล่วงเวลา:', overtimeCost);
          console.log('ค่าบริการเพิ่มเติม:', additionalFee);
          console.log('ค่าคาร์ซีท:', carSeatFee);
          console.log('ค่าประกันเสริม:', insuranceFee);
          console.log('ส่วนลด:', discount);
          console.log('รวมก่อนภาษี (totalBeforeTax):', totalBeforeTax);
          console.log('ค่าเช่ารวมทั้งหมด (หลัง VAT ถ้ามี):', this.newRental.ค่าเช่ารวมทั้งหมด);
          // 🕵️‍♂️ END DEBUG LOG 1

        },

        // คำนวณรวมยอดชำระวันรับรถ (สำหรับการสร้างใหม่)
        calculateFinalAmount() {
          // ป้องกันการวนลูปจาก VAT
          if (this._isUpdatingFromVAT) return;

          // คำนวณค่าเช่ารวมทั้งหมดจากรายการจริง แทนการใช้ฟิลด์ input
          let totalRental = 0;
          // กรณีไม่มี VAT/WHT: รวมทุกอย่างตรงๆ
          totalRental = (parseFloat(this.newRental.ค่าเช่าพื้นฐาน) || 0)
            + (parseFloat(this.newRental.ค่าล่วงเวลา) || 0)
            + (parseFloat(this.newRental.ค่าบริการเพิ่มเติม) || 0)
            + (parseFloat(this.newRental.ค่าคาร์ซีท) || 0)
            + (parseFloat(this.newRental.ค่าประกันเสริมรวม) || 0)
            - (parseFloat(this.newRental.ส่วนลด) || 0);

          // บันทึกค่าเช่ารวมทั้งหมดที่คำนวณได้ (สำหรับส่งไป backend และแสดงผลเป็นยอดก่อนรวมภาษี)
          this.newRental.ค่าเช่ารวมทั้งหมด = totalRental.toFixed(2);

          // --- ส่วนที่เพิ่ม: คำนวณยอดสุทธิ (Net Total) เพื่อนำไปคิดยอดชำระวันรับรถ ---
          let netTotal = totalRental;

          if (this.newRental.wantsTaxInvoice || this.newRental.wantsWHT) {
            // ถ้ามี VAT ให้บวกเพิ่ม
            if (this.newRental.wantsTaxInvoice) {
              netTotal += (parseFloat(this.newRental.taxInvoiceVATAmount) || 0);
            }

            // ถ้ามี WHT ให้หักออก
            if (this.newRental.wantsWHT) {
              netTotal -= (parseFloat(this.newRental.whtAmount) || 0);
            }
          }

          // เก็บค่า Net Total ไว้สำหรับบันทึก
          this.newRental.netTotal = netTotal.toFixed(2);
          // ---------------------------------------------------------------------

          const deposit = parseFloat(this.newRental.ค่ามัดจำคิวรถ) || 0;
          const securityDeposit = parseFloat(this.newRental.เงินประกันความเสียหาย) || 0;

          // ใช้ netTotal (ยอดรวมภาษีแล้ว) ในการคำนวณยอดชำระวันรับรถ
          const finalAmount = Math.round((netTotal - deposit + securityDeposit) * 100) / 100;
          this.newRental.รวมยอดชำระวันรับรถ = finalAmount.toFixed(2);

          // 🕵️‍♂️ DEBUG LOG 4
          console.log('--- calculateFinalAmount (สร้างใหม่) ---');
          console.log('ค่าเช่ารวมทั้งหมด (totalRental):', totalRental);
          console.log('ค่ามัดจำคิวรถ (deposit):', deposit);
          console.log('เงินประกัน (securityDeposit):', securityDeposit);
          console.log('ยอดชำระวันรับรถ (finalAmount):', finalAmount);
          console.log('ค่าใน newRental (toFixed(2)):', this.newRental.รวมยอดชำระวันรับรถ);
          // 🕵️‍♂️ END DEBUG LOG 4
        },





        // คำนวณค่าเช่ารวมทั้งหมด (สำหรับการแก้ไข)
        calculateEditTotalRental() {
          if (!this.editRentalData.วันที่เช่า || !this.editRentalData.วันที่คืน || !this.editRentalData.ราคา ||
            !this.editRentalData.เวลารับรถ || !this.editRentalData.เวลาคืนรถ) {
            return;
          }

          // 1. คำนวณจำนวนวันเช่า และชั่วโมงล่วงเวลา
          const rentalInfo = this.calculateRentalDaysWithHours(
            this.editRentalData.วันที่เช่า,
            this.editRentalData.วันที่คืน,
            this.editRentalData.เวลารับรถ,
            this.editRentalData.เวลาคืนรถ
          );

          // ตรวจสอบว่าได้ค่า rentalInfo ที่ถูกต้องหรือไม่
          if (!rentalInfo || typeof rentalInfo.days !== 'number' || isNaN(rentalInfo.days)) {
            console.error("calculateRentalDaysWithHours() ส่งค่ากลับมาไม่ถูกต้อง:", rentalInfo);
            return; // หยุดการคำนวณ
          }

          // 2. คำนวณค่าเช่าพื้นฐาน (วัน × ราคาต่อวัน)
          const dailyRate = parseFloat(this.editRentalData.ราคา) || 0;
          const additionalFee = parseFloat(this.editRentalData.ค่าบริการเพิ่มเติม) || 0;
          const carSeatFee = (this.editRentalData.ต้องการคาร์ซีท && (this.editRentalData.คาร์ซีทมีค่าบริการ === 'true' || this.editRentalData.คาร์ซีทมีค่าบริการ === true)) ? (parseFloat(this.editRentalData.ค่าคาร์ซีท) || 0) : 0;
          const insuranceFee = this.editRentalData.ต้องการประกันเสริม ? (parseFloat(this.editRentalData.ค่าประกันเสริมรวม) || 0) : 0;
          let rentalBaseCost = dailyRate * rentalInfo.days;

          // 3. คำนวณค่าล่วงเวลา (ถ้ามี)
          let overtimeCost = 0;
          this.editRentalData.usingDefaultOvertimeRate = false; // รีเซ็ตค่า

          if (rentalInfo.extraHours > 0 && !rentalInfo.isFullDayCharge) {
            // หักชั่วโมงฟรีออกก่อน
            const freeOvertimeHours = parseFloat(this.config.จำนวนชั่วโมงล่วงเวลาที่ไม่คิดเงิน) || 0;
            const chargeableHours = Math.max(0, rentalInfo.extraHours - freeOvertimeHours);

            if (chargeableHours > 0) {
              // ดึงค่าล่วงเวลาจากรถ หรือใช้ค่าเริ่มต้นของระบบ
              const selectedCar = this.cars.find(car => car.ทะเบียน === this.editRentalData.ทะเบียนรถ);
              const carOvertimeRate = selectedCar?.ค่าล่วงเวลาต่อชั่วโมง;

              let overtimeRate;
              if (carOvertimeRate && parseFloat(carOvertimeRate) > 0) {
                // รถมีการตั้งค่าล่วงเวลาเอง
                overtimeRate = parseFloat(carOvertimeRate);
                this.editRentalData.usingDefaultOvertimeRate = false;
              } else {
                // ใช้ค่าเริ่มต้นจากระบบ หรือ 100 บาท
                overtimeRate = parseFloat(this.config.ค่าล่วงเวลาเริ่มต้น) || 100;
                this.editRentalData.usingDefaultOvertimeRate = true;
              }

              overtimeCost = chargeableHours * overtimeRate;
            }
          }

          // 4. รวมค่าเช่าทั้งหมด
          const totalBeforeDiscount = rentalBaseCost + overtimeCost + additionalFee + carSeatFee + insuranceFee;

          // 5. หักส่วนลดออก
          const discount = parseFloat(this.editRentalData.ส่วนลด) || 0;
          const totalRental = totalBeforeDiscount - discount;

          // 6. เก็บค่าต่างๆ ไว้ในตัวแปร
          // ⭐⭐ START: จุดที่แก้ไข (เพิ่ม 3 บรรทัดนี้) ⭐⭐
          if (!isNaN(rentalInfo.days) && isFinite(rentalInfo.days)) {
            this.editRentalData.จำนวนวันเช่า = rentalInfo.days;
          }
          // ⭐⭐ END: จุดที่แก้ไข ⭐⭐

          // ตรวจสอบว่าไม่มีค่า NaN ก่อน assign
          // ถ้ามี _hasTaxInvoiceTotal flag ให้ข้ามการคำนวณค่าเช่ารวมทั้งหมด (ใช้ค่าที่โหลดมาจาก taxInvoiceTotal)
          if (!isNaN(totalRental) && isFinite(totalRental) && !this.editRentalData._hasTaxInvoiceTotal) {
            // อัพเดท ค่าเช่ารวมทั้งหมด (สำหรับ input field) - ใช้ totalRental ที่คำนวณจากวันที่/เวลา
            this.editRentalData.ค่าเช่ารวมทั้งหมด = totalRental.toString();
          }
          // รีเซ็ต flag หลังจากใช้งานครั้งแรก เพื่อให้การแก้ไขครั้งต่อไปคำนวณใหม่ได้
          if (this.editRentalData._hasTaxInvoiceTotal) {
            this.editRentalData._hasTaxInvoiceTotal = false;
          }
          if (!isNaN(rentalBaseCost) && isFinite(rentalBaseCost)) {
            this.editRentalData.ค่าเช่าพื้นฐาน = rentalBaseCost;
          }
          if (!isNaN(overtimeCost) && isFinite(overtimeCost)) {
            this.editRentalData.ค่าล่วงเวลา = overtimeCost;
          }
          if (!isNaN(rentalInfo.extraHours) && isFinite(rentalInfo.extraHours)) {
            this.editRentalData.ชั่วโมงล่วงเวลา = rentalInfo.extraHours;
          }

          // 4. เรียกฟังก์ชันที่เกี่ยวข้องต่อ
          this.calculateEditCommission();
          this.calculateEditFinalAmount();

          // 🕵️‍♂️ DEBUG LOG 2
          console.log('--- calculateEditTotalRental (แก้ไข) ---');
          console.log('ค่าเช่าพื้นฐาน:', rentalBaseCost);
          console.log('ค่าล่วงเวลา:', overtimeCost);
          console.log('ค่าบริการเพิ่มเติม:', additionalFee);
          console.log('ค่าคาร์ซีท:', carSeatFee);
          console.log('ค่าประกันเสริม:', insuranceFee);
          console.log('ส่วนลด:', discount);
          console.log('รวมหลังหักส่วนลด (totalRental):', totalRental);
          console.log('ค่าเช่ารวมทั้งหมด (หลัง VAT ถ้ามี):', this.editRentalData.ค่าเช่ารวมทั้งหมด);
          // 🕵️‍♂️ END DEBUG LOG 2
        },

        // คำนวณจำนวนวันเช่า (สำหรับการแก้ไข)
        calculateEditRentalDays() {
          if (!this.editRentalData) return 0;
          if (!this.editRentalData.วันที่เช่า || !this.editRentalData.วันที่คืน ||
            !this.editRentalData.เวลารับรถ || !this.editRentalData.เวลาคืนรถ) {
            return 0;
          }

          try {
            const rentalInfo = this.calculateRentalDaysWithHours(
              this.editRentalData.วันที่เช่า,
              this.editRentalData.วันที่คืน,
              this.editRentalData.เวลารับรถ,
              this.editRentalData.เวลาคืนรถ
            );
            return rentalInfo.days || 0;
          } catch (e) {
            console.error("เกิดข้อผิดพลาดในการคำนวณจำนวนวัน:", e);
            return 0;
          }
        },

        // คำนวณชั่วโมงที่เหลือ (สำหรับการแก้ไข)
        calculateEditRemainingHours() {
          if (!this.editRentalData) return 0;
          if (!this.editRentalData.วันที่เช่า || !this.editRentalData.วันที่คืน ||
            !this.editRentalData.เวลารับรถ || !this.editRentalData.เวลาคืนรถ) {
            return 0;
          }

          try {
            const rentalInfo = this.calculateRentalDaysWithHours(
              this.editRentalData.วันที่เช่า,
              this.editRentalData.วันที่คืน,
              this.editRentalData.เวลารับรถ,
              this.editRentalData.เวลาคืนรถ
            );

            // ถ้าถูกคิดเป็น Full Day แล้ว จะไม่แสดงชั่วโมงที่เหลือ
            if (rentalInfo.isFullDayCharge) {
              return 0;
            }

            return Math.floor(rentalInfo.extraHours) || 0;
          } catch (e) {
            console.error("เกิดข้อผิดพลาดในการคำนวณชั่วโมงที่เหลือ:", e);
            return 0;
          }
        },

        // คำนวณรวมยอดชำระวันรับรถ (สำหรับการแก้ไข)
        calculateEditFinalAmount() {
          // ป้องกันการวนลูปจาก VAT
          if (this._isUpdatingEditFromVAT) return;

          // คำนวณค่าเช่ารวมทั้งหมดจากรายการจริง แทนการใช้ฟิลด์ input
          let totalRental = 0;
          // กรณีไม่มี VAT/WHT: รวมทุกอย่างตรงๆ
          totalRental = (parseFloat(this.editRentalData.ค่าเช่าพื้นฐาน) || 0)
            + (parseFloat(this.editRentalData.ค่าล่วงเวลา) || 0)
            + (parseFloat(this.editRentalData.ค่าบริการเพิ่มเติม) || 0)
            + (parseFloat(this.editRentalData.ค่าคาร์ซีท) || 0)
            + (parseFloat(this.editRentalData.ค่าประกันเสริมรวม) || 0)
            - (parseFloat(this.editRentalData.ส่วนลด) || 0);

          // บันทึกค่าเช่ารวมทั้งหมดที่คำนวณได้ (สำหรับส่งไป backend และแสดงผลเป็นยอดก่อนรวมภาษี)
          this.editRentalData.ค่าเช่ารวมทั้งหมด = totalRental.toFixed(2);

          // --- ส่วนที่เพิ่ม: คำนวณยอดสุทธิ (Net Total) เพื่อนำไปคิดยอดชำระวันรับรถ ---
          let netTotal = totalRental;

          if (this.editRentalData.wantsTaxInvoice || this.editRentalData.wantsWHT) {
            // ถ้ามี VAT ให้บวกเพิ่ม
            if (this.editRentalData.wantsTaxInvoice) {
              netTotal += (parseFloat(this.editRentalData.taxInvoiceVATAmount) || 0);
            }

            // ถ้ามี WHT ให้หักออก
            if (this.editRentalData.wantsWHT) {
              netTotal -= (parseFloat(this.editRentalData.whtAmount) || 0);
            }
          }

          // เก็บค่า Net Total ไว้สำหรับบันทึก
          this.editRentalData.netTotal = netTotal.toFixed(2);
          // ---------------------------------------------------------------------

          const deposit = parseFloat(this.editRentalData.ค่ามัดจำคิวรถ) || 0;
          const securityDeposit = parseFloat(this.editRentalData.เงินประกันความเสียหาย) || 0;
          // const discount = parseFloat(this.editRentalData.ส่วนลด) || 0; // ❌ ไม่ต้องใช้ส่วนลดที่นี่แล้ว

          // 🟡 ปรับสูตรคำนวณใหม่ ไม่ต้องหักส่วนลดซ้ำ
          // ใช้ netTotal (ยอดรวมภาษีแล้ว) ในการคำนวณยอดชำระวันรับรถ
          const finalAmount = Math.round((netTotal - deposit + securityDeposit) * 100) / 100;
          this.editRentalData.รวมยอดชำระวันรับรถ = finalAmount.toFixed(2);

          // ไม่จำเป็นต้องเรียก calculateEditCommission() ที่นี่อีก
          // this.calculateEditCommission();
        },



        // เพิ่มฟังก์ชันตรวจสอบความถูกต้องของฟอร์ม
        validateRentalForm() {
          // ตรวจสอบความถูกต้องของฟอร์ม
          const requiredFields = [
            { name: 'ช่องทางการจอง', value: this.newRental.ช่องทางการจอง },
            { name: 'หมายเลขการจอง', value: this.newRental.หมายเลขการจอง },
            { name: 'ชื่อลูกค้า', value: this.newRental.ชื่อลูกค้า },
            { name: 'รถ', value: this.newRental.รถ },
            { name: 'ทะเบียนรถ', value: this.newRental.ทะเบียนรถ },
            { name: 'วันที่เช่า', value: this.newRental.วันที่เช่า },
            { name: 'วันที่คืน', value: this.newRental.วันที่คืน },
            { name: 'เวลารับรถ', value: this.newRental.เวลารับรถ },
            { name: 'เวลาคืนรถ', value: this.newRental.เวลาคืนรถ },
            { name: 'ราคา', value: this.newRental.ราคา },

          ];

          // ตรวจสอบว่ามีฟิลด์ที่จำเป็นที่ไม่ได้กรอกหรือไม่
          const missingFields = requiredFields.filter(field => !field.value);

          if (missingFields.length > 0) {
            // แสดงข้อความแจ้งเตือนเมื่อมีฟิลด์ที่ไม่ได้กรอก
            const missingFieldNames = missingFields.map(field => field.name).join(', ');
            Swal.fire({
              title: 'กรุณากรอกข้อมูลให้ครบถ้วน',
              text: `กรุณากรอกข้อมูล: ${missingFieldNames}`,
              icon: 'error',
              confirmButtonText: 'ตกลง'
            });
            return false;
          }

          // ตรวจสอบว่าวันที่คืนต้องไม่มาก่อนวันที่เช่า
          const startDate = new Date(this.newRental.วันที่เช่า);
          const endDate = new Date(this.newRental.วันที่คืน);

          if (startDate > endDate) {
            Swal.fire({
              title: 'วันที่ไม่ถูกต้อง',
              text: 'วันที่คืนรถต้องไม่มาก่อนวันที่เช่า',
              icon: 'error',
              confirmButtonText: 'ตกลง'
            });
            return false;
          }

          return true;
        },






        // กรองรายการรถตามคำค้นหา
        get filteredCarsForCarTable() {
          if (!this.carSearchQuery) return this.cars;

          const query = this.carSearchQuery.toLowerCase();
          return this.cars.filter(car => {
            return
            car.ยี่ห้อ?.toLowerCase().includes(query) ||
              car.รุ่น?.toLowerCase().includes(query) ||
              car.ทะเบียน?.toLowerCase().includes(query) ||
              car.สี?.toLowerCase().includes(query) ||
              car.สถานะ?.toLowerCase().includes(query);
          });
        },





        // ฟังก์ชันอัปโหลด QR Code
        uploadQRCode(event) {
          const file = event.target.files[0];
          if (!file) return;

          // ตรวจสอบว่าเป็นไฟล์รูปภาพหรือไม่
          if (!file.type.match('image.*')) {
            this.qrCodeUploadStatus = "กรุณาเลือกไฟล์รูปภาพเท่านั้น";
            return;
          }

          // แสดงสถานะการอัปโหลด
          this.qrCodeUploadStatus = "กำลังอัปโหลด...";
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          // อ่านข้อมูลไฟล์เป็น base64
          const reader = new FileReader();
          reader.onload = (e) => {
            const base64Data = e.target.result.split(',')[1]; // เอาเฉพาะข้อมูล base64 หลัง comma

            // เรียกใช้ฟังก์ชัน Apps Script เพื่ออัปโหลดไฟล์
            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  this.config.URLรูปQRCode = result.fileUrl;
                  this.qrCodeUploadStatus = "อัปโหลดสำเร็จ";

                  // อัปเดตการตั้งค่าอัตโนมัติ
                  this.saveConfig();
                } else {
                  this.qrCodeUploadStatus = "อัปโหลดไม่สำเร็จ: " + result.message;
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.qrCodeUploadStatus = "เกิดข้อผิดพลาด: " + error;
                this.isLoading = false;
              })
              .uploadQRCodeImage(base64Data, file.name, this.config.IDโฟลเดอร์หลัก, sheetID);
          };
          reader.readAsDataURL(file);
        },

        // ฟังก์ชันลบรูป QR Code
        removeQRCode() {

          const sheetID = localStorage.getItem('sheetID') || '';
          // แสดงกล่องยืนยัน
          Swal.fire({
            title: 'ยืนยันการลบ',
            text: 'คุณต้องการลบรูป QR Code นี้ใช่หรือไม่?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              // ถ้ามี URL ของรูป QR Code ให้ลบไฟล์ใน Google Drive ด้วย
              if (this.config.URLรูปQRCode) {
                this.isLoading = true;

                // ดึง file ID จาก URL
                const fileId = this.extractFileIdFromUrl(this.config.URLรูปQRCode);

                if (fileId) {
                  google.script.run
                    .withSuccessHandler(result => {
                      if (result.success) {
                        this.config.URLรูปQRCode = "";
                        this.qrCodeUploadStatus = "";
                        this.showNotification('ลบรูป QR Code สำเร็จ');

                        // อัปเดตการตั้งค่า
                        this.saveConfig();
                      } else {
                        this.showNotification('ลบไฟล์ไม่สำเร็จ: ' + result.message, 'error');
                      }
                      this.isLoading = false;
                    })
                    .withFailureHandler(error => {
                      this.showNotification('ลบไฟล์ไม่สำเร็จ: ' + error, 'error');
                      this.isLoading = false;
                    })
                    .deleteFile(fileId, sheetID);
                } else {
                  // ถ้าไม่สามารถดึง file ID ได้ ก็เคลียร์ URL ออกแทน
                  this.config.URLรูปQRCode = "";
                  this.qrCodeUploadStatus = "";
                  this.isLoading = false;
                }
              } else {
                // ถ้าไม่มี URL อยู่แล้ว ก็เคลียร์ค่าเปล่าๆ
                this.config.URLรูปQRCode = "";
                this.qrCodeUploadStatus = "";
              }
            }
          });
        },


        showHandoverTutorialIfNeeded() {
          const tutorialKey = 'hasSeenHandoverTutorial';
          const hasSeenTutorial = localStorage.getItem(tutorialKey);

          // ถ้ายังไม่เคยเห็น tutorial หรือค่าเป็น 'false'
          if (!hasSeenTutorial) {
            Swal.fire({
              title: '✨ แนะนำฟีเจอร์ใหม่!',
              html: `
            <div class="text-left">
              <p class="mb-3">ตอนนี้คุณสามารถบันทึกการรับ-ส่งคืนรถ พร้อมถ่ายรูปและระบุตำแหน่ง GPS เพื่อเก็บเป็นหลักฐานได้แล้ว!</p>
              <img src="https://img2.pic.in.th/pic/howto.gif" alt="สาธิตการใช้งาน" class="rounded-lg shadow-md mx-auto mb-4 border">
              <p class="font-bold mb-2">วิธีใช้งาน:</p>
              <ul class="list-disc list-inside text-gray-700">
                <li>คลิกที่ปุ่ม <strong class="text-green-600">"บันทึกการส่งรถ"</strong> หรือ <strong class="text-orange-500">"บันทึกการคืนรถ"</strong> ในไทม์ไลน์รายการรับส่งรถ</li>
                <li>กรอกเลขไมล์และถ่ายรูปตามจุดต่างๆ</li>
                <li>กดบันทึก ข้อมูลจะถูกเก็บใน Google Driveทันที</li>
              </ul>
            </div>
          `,
              icon: 'info',
              width: '600px',
              confirmButtonText: 'รับทราบ',
              customClass: {
                title: 'text-2xl font-bold text-gray-800',
              }
            }).then(() => {
              // หลังจากผู้ใช้กด "รับทราบ" ให้บันทึกไว้ใน localStorage
              localStorage.setItem(tutorialKey, 'true');
              console.log('บันทึกสถานะการดู tutorial แล้ว');
            });
          }
        },



        // ฟังก์ชันจัดการเมื่อรูปภาพโหลดไม่สำเร็จ
        handleImageError(event) {
          console.error('ไม่สามารถโหลดรูปภาพได้:', this.config.URLรูปQRCode);
          // แสดง placeholder หรือข้อความแทน
          event.target.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 width%3D%22200%22 height%3D%22200%22 viewBox%3D%220 0 200 200%22%3E%3Crect fill%3D%22%23f8f9fa%22 width%3D%22200%22 height%3D%22200%22%2F%3E%3Ctext fill%3D%22%23999%22 font-family%3D%22sans-serif%22 font-size%3D%2220%22 dy%3D%220.35em%22 text-anchor%3D%22middle%22 x%3D%22100%22 y%3D%22100%22%3E%E0%B9%84%E0%B8%A1%E0%B9%88%E0%B8%AA%E0%B8%B2%E0%B8%A1%E0%B8%B2%E0%B8%A3%E0%B8%96%E0%B9%82%E0%B8%AB%E0%B8%A5%E0%B8%94%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B9%84%E0%B8%94%E0%B9%89%3C%2Ftext%3E%3C%2Fsvg%3E';

          // แจ้งเตือนผู้ใช้
          this.qrCodeUploadStatus = 'ไม่สามารถแสดงรูปภาพได้ โปรดลองอัปโหลดใหม่';

          // ถ้าต้องการให้ผู้ใช้ลองอัปโหลดใหม่ สามารถเคลียร์ URL ได้
          // this.config.URLรูปQRCode = '';
        },

        // ฟังก์ชันดึง file ID จาก URL ของ Google Drive
        extractFileIdFromUrl(url) {
          if (!url) return null;

          try {
            // รูปแบบ URL: https://drive.google.com/file/d/FILE_ID/view หรือ https://drive.google.com/open?id=FILE_ID
            const idRegex1 = /\/file\/d\/([^/]+)/; // สำหรับรูปแบบ /file/d/ID/view
            const idRegex2 = /[?&]id=([^&]+)/;    // สำหรับรูปแบบ ?id=ID

            let match = url.match(idRegex1);
            if (match && match[1]) return match[1];

            match = url.match(idRegex2);
            if (match && match[1]) return match[1];

            return null;
          } catch (e) {
            console.error("Error extracting file ID:", e);
            return null;
          }
        },



        // เพิ่มฟังก์ชันนี้
        // ฟังก์ชันเปลี่ยนโหมดการดู
        toggleViewMode() {
          this.viewMode = this.viewMode === 'table' ? 'calendar' : 'table';

          // บันทึกการตั้งค่าลงใน localStorage เพื่อจำค่าไว้
          localStorage.setItem('calendarViewMode', this.viewMode);

          // อัพเดตการแสดงผล
          if (this.viewMode === 'table') {
            this.updateBookingTable();
          } else {
            this.renderCalendarView();
          }
        },



        updateBookingTable() {
          this.isLoadingBookingTable = true;
          this.bookingData = {};
          const sheetID = localStorage.getItem('sheetID') || '';
          // เรียกใช้ API จาก Google Apps Script
          google.script.run
            .withSuccessHandler(result => {
              // บันทึกข้อมูล
              if (result && typeof result === 'object' && !Array.isArray(result)) {
                this.bookingData = result;

                // ใช้ setTimeout เพื่อรอให้ DOM อัปเดตก่อนจึงเรียกฟังก์ชันแสดงผล
                setTimeout(() => {
                  if (this.viewMode === 'table') {
                    this.renderBookingTable();
                  } else {
                    this.renderCalendarView();
                  }
                }, 100);
              } else {
                console.error("รูปแบบข้อมูลไม่ถูกต้อง:", result);
                this.bookingData = {};
              }

              this.isLoadingBookingTable = false;
            })
            .withFailureHandler(error => {
              console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลการจอง:", error);
              this.showNotification('โหลดข้อมูลการจองไม่สำเร็จ', 'error');
              this.bookingData = {};
              this.isLoadingBookingTable = false;
            })
            .getbookingData(this.selectedScheduleMonth, this.selectedScheduleYear, sheetID);
        },

        // สร้างตารางใหม่ด้วย JavaScript โดยตรง

        renderBookingTable() {
          // Render to new containers
          this.renderTimelineView();
          this.renderCardStackView();
        },

        // Timeline View for Desktop - ใช้ table เดิมก่อน
        renderTimelineView() {
          const container = document.getElementById('timelineView');
          if (!container) {
            console.error("ไม่พบ timelineView");
            return;
          }

          // สร้าง table ภายใน timelineView
          container.innerHTML = '<div class="overflow-x-auto"><table id="bookingTableDesktop" class="min-w-full divide-y divide-gray-200"></table></div>';
          const table = document.getElementById('bookingTableDesktop');

          if (!table) {
            console.error("ไม่พบตาราง bookingTableDesktop");
            return;
          }

          this.isCarNamesCollapsed = localStorage.getItem('carNamesCollapsed') === 'true';
          const daysInMonth = this.getDaysInMonth(this.selectedScheduleYear, this.selectedScheduleMonth);

          // ===== สร้างหัวตาราง =====
          let thead = table.querySelector('thead');
          if (!thead) {
            thead = document.createElement('thead');
            thead.className = 'bg-gray-100';
            table.insertBefore(thead, table.firstChild);
          }
          thead.innerHTML = '';

          const headerRow = document.createElement('tr');

          // สร้างหัวตารางสำหรับชื่อรถพร้อมปุ่มขยาย/หุบ
          const carNameHeader = document.createElement('th');
          carNameHeader.className = 'sticky left-0 bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-700 z-10';

          // สร้างปุ่มขยาย/หุบสำหรับคอลัมน์ชื่อรถ
          const toggleButton = document.createElement('button');
          toggleButton.className = 'mr-2 focus:outline-none';
          toggleButton.innerHTML = '<i class="fas fa-chevron-left"></i>'; // ไอคอนแสดงสถานะหุบ
          toggleButton.setAttribute('id', 'toggleCarNames');
          toggleButton.setAttribute('title', 'แสดง/ซ่อนชื่อรถ');

          // เพิ่ม Event listener สำหรับปุ่มขยาย/หุบ
          toggleButton.addEventListener('click', this.toggleCarNamesColumn.bind(this));

          // สร้าง span สำหรับข้อความหัวตาราง
          const headerText = document.createElement('span');
          headerText.textContent = 'ชื่อรถ';

          // เพิ่มปุ่มและข้อความเข้าด้วยกัน
          carNameHeader.appendChild(toggleButton);
          carNameHeader.appendChild(headerText);
          headerRow.appendChild(carNameHeader);

          for (let day = 1; day <= daysInMonth; day++) {
            const dayHeader = document.createElement('th');
            dayHeader.className = 'px-2 py-2 text-sm text-center font-semibold text-gray-700 border';
            dayHeader.textContent = day;
            headerRow.appendChild(dayHeader);
          }

          thead.appendChild(headerRow);

          // ===== สร้าง tbody ถ้ายังไม่มี =====
          let tbody = table.querySelector('tbody');
          if (!tbody) {
            tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            table.appendChild(tbody);
          }

          // ล้างข้อมูลเก่า
          tbody.innerHTML = '';

          // เช็คสถานะการซ่อน/แสดงคอลัมน์ชื่อรถ
          const isCarNamesCollapsed = this.isCarNamesCollapsed || false;

          // กำหนด class สำหรับเซลล์ชื่อรถตามสถานะ
          const carNameCellClass = isCarNamesCollapsed
            ? 'car-name-cell collapsed px-1 py-3 text-sm font-medium text-gray-900 sticky left-0 bg-white shadow-sm z-10 whitespace-nowrap'
            : 'car-name-cell px-4 py-3 text-sm font-medium text-gray-900 sticky left-0 bg-white shadow-sm z-10 whitespace-nowrap';

          for (const carName in this.bookingData) {
            const carBookings = this.bookingData[carName];
            const bookingRefs = Object.keys(carBookings);

            // คำนวณจำนวนวันเช่าของรถคันนี้
            let totalRentalDays = 0;
            for (const bookingNo in carBookings) {
              const booking = carBookings[bookingNo];
              if (booking.days) {
                totalRentalDays += booking.days.length;
              }
            }
            const availableDays = daysInMonth - totalRentalDays;

            if (bookingRefs.length === 0) {
              const emptyRow = document.createElement('tr');
              emptyRow.className = 'border-b';

              const carNameCell = document.createElement('td');
              carNameCell.className = carNameCellClass;

              // ถ้าหุบแล้ว แสดงเฉพาะไอคอนรถ
              if (isCarNamesCollapsed) {
                carNameCell.innerHTML = '<i class="fas fa-car text-blue-500"></i>';
                carNameCell.setAttribute('title', carName);
              } else {
                carNameCell.innerHTML = '<div class="font-medium">' + carName + '</div><div class="text-xs mt-1"><span class="text-blue-600 font-semibold">เช่า ' + totalRentalDays + ' วัน</span> | <span class="text-green-600 font-semibold">ว่าง ' + availableDays + ' วัน</span></div>';
              }

              emptyRow.appendChild(carNameCell);

              for (let day = 1; day <= daysInMonth; day++) {
                const emptyCell = document.createElement('td');
                emptyCell.className = 'border px-2 py-2 text-center text-sm';

                if (this.isToday2(day, this.selectedScheduleMonth, this.selectedScheduleYear)) {
                  emptyCell.classList.add('bg-green-100');
                } else if (this.isWeekend(day, this.selectedScheduleMonth, this.selectedScheduleYear)) {
                  emptyCell.classList.add('bg-red-50');
                }

                emptyRow.appendChild(emptyCell);
              }

              tbody.appendChild(emptyRow);
            } else {
              bookingRefs.forEach((bookingNo, index) => {
                const booking = carBookings[bookingNo];
                const bookingRow = document.createElement('tr');
                bookingRow.className = 'border-b';

                if (index === 0) {
                  const carNameCell = document.createElement('td');
                  carNameCell.className = carNameCellClass;

                  // ถ้าหุบแล้ว แสดงเฉพาะไอคอนรถ
                  if (isCarNamesCollapsed) {
                    carNameCell.innerHTML = '<i class="fas fa-car text-blue-500"></i>';
                    carNameCell.setAttribute('title', carName);
                  } else {
                    carNameCell.innerHTML = '<div class="font-medium">' + carName + '</div><div class="text-xs mt-1"><span class="text-blue-600 font-semibold">เช่า ' + totalRentalDays + ' วัน</span> | <span class="text-green-600 font-semibold">ว่าง ' + availableDays + ' วัน</span></div>';
                  }

                  if (bookingRefs.length > 1) {
                    carNameCell.rowSpan = bookingRefs.length;
                  }

                  bookingRow.appendChild(carNameCell);
                }

                let dayInBooking = false;
                let firstDayCell = null;
                let consecutiveDays = 0;

                for (let day = 1; day <= daysInMonth; day++) {
                  const bookingDay = booking.days.find(d => d.day === day);

                  if (bookingDay) {
                    if (bookingDay.isFirstDay || !dayInBooking) {
                      dayInBooking = true;
                      consecutiveDays = 1;

                      const bookingCell = document.createElement('td');
                      bookingCell.className = 'border px-2 py-2 text-center text-sm bg-blue-400 text-white cursor-pointer booking-cell';
                      bookingCell.setAttribute('data-booking-no', bookingNo);
                      bookingCell.setAttribute('data-car-name', carName);
                      bookingCell.textContent = bookingNo;

                      firstDayCell = bookingCell;
                      bookingRow.appendChild(bookingCell);
                    } else {
                      consecutiveDays++;

                      if (firstDayCell) {
                        const currentColspan = parseInt(firstDayCell.getAttribute('colspan') || 1);
                        firstDayCell.setAttribute('colspan', currentColspan + 1);
                      }
                    }
                  } else {
                    dayInBooking = false;
                    firstDayCell = null;

                    const emptyCell = document.createElement('td');
                    emptyCell.className = 'border px-2 py-2 text-center text-sm';

                    if (this.isWeekend(day, this.selectedScheduleMonth, this.selectedScheduleYear)) {
                      emptyCell.classList.add('bg-red-50');
                    }
                    if (this.isToday2(day, this.selectedScheduleMonth, this.selectedScheduleYear)) {
                      emptyCell.classList.add('bg-green-100');
                    }

                    bookingRow.appendChild(emptyCell);
                  }
                }

                tbody.appendChild(bookingRow);
              });
            }
          }

          // เพิ่ม event listener สำหรับเซลล์การจอง
          const bookingCells = document.querySelectorAll('.booking-cell');
          bookingCells.forEach(cell => {
            cell.addEventListener('click', () => {
              const bookingNo = cell.getAttribute('data-booking-no');
              const carName = cell.getAttribute('data-car-name');

              if (this.bookingData && this.bookingData[carName] && this.bookingData[carName][bookingNo]) {
                this.showBookingDetails(this.bookingData[carName][bookingNo]);
              } else {
                console.error("ไม่พบข้อมูลการจอง:", { bookingNo, carName });
                this.showNotification(`ไม่พบข้อมูลการจอง ${bookingNo}`, 'error');
              }
            });
          });
        },

        // Card Stack View for Mobile
        renderCardStackView() {
          const container = document.getElementById('cardStackView');
          if (!container) return;

          container.innerHTML = '';

          const allBookings = [];
          for (const carName in this.bookingData) {
            for (const bookingNo in this.bookingData[carName]) {
              const booking = this.bookingData[carName][bookingNo];
              const firstDay = booking.days.find(d => d.isFirstDay);
              const lastDay = booking.days[booking.days.length - 1];

              // Apply filter
              if (this.currentFilter !== 'all') {
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonth = today.getMonth() + 1;
                const currentYear = today.getFullYear();

                if (currentMonth !== parseInt(this.selectedScheduleMonth) || currentYear !== parseInt(this.selectedScheduleYear)) {
                  if (this.currentFilter === 'pickup_today' || this.currentFilter === 'return_today') continue;
                } else {
                  if (this.currentFilter === 'pickup_today' && (!firstDay || firstDay.day !== currentDay)) continue;
                  if (this.currentFilter === 'return_today' && (!lastDay || lastDay.day !== currentDay)) continue;
                }
                if (this.currentFilter === 'pending' && booking.status !== 'pending') continue;
              }

              allBookings.push({
                carName,
                bookingNo,
                booking,
                startDay: firstDay ? firstDay.day : booking.days[0].day,
                endDay: lastDay.day
              });
            }
          }

          allBookings.sort((a, b) => a.startDay - b.startDay);

          if (allBookings.length === 0) {
            container.innerHTML = '<div class="text-center py-12 bg-gray-50 rounded-xl"><i class="fas fa-calendar-times text-5xl text-gray-300 mb-4"></i><p class="text-gray-500 font-medium">ไม่พบการจองที่ตรงตามเงื่อนไข</p></div>';
            return;
          }

          allBookings.forEach(item => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow';

            const statusClass = item.booking.status === 'pending' ? 'bg-amber-500' : 'bg-green-500';
            const statusText = item.booking.status === 'pending' ? 'รอยืนยัน' : 'ยืนยันแล้ว';

            card.innerHTML = `
      <div class="p-4">
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
              <i class="fas fa-car text-blue-600"></i>
            </div>
            <div>
              <h4 class="font-bold text-gray-900">${item.carName}</h4>
              <p class="text-sm text-gray-500">${item.bookingNo}</p>
            </div>
          </div>
          <span class="${statusClass} text-white text-xs px-2 py-1 rounded-full">${statusText}</span>
        </div>

        <div class="bg-gray-50 rounded-lg p-3 mb-3">
          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center text-blue-600">
              <i class="fas fa-arrow-up mr-2"></i>
              <span>รับ: ${item.startDay}/${this.selectedScheduleMonth}</span>
            </div>
            <div class="text-gray-400">→</div>
            <div class="flex items-center text-green-600">
              <i class="fas fa-arrow-down mr-2"></i>
              <span>ส่ง: ${item.endDay}/${this.selectedScheduleMonth}</span>
            </div>
          </div>
          <div class="text-center mt-2">
            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
              ${item.booking.days.length} วัน
            </span>
          </div>
        </div>

        <div class="flex items-center text-sm text-gray-600 mb-3">
          <i class="fas fa-user mr-2 text-gray-400"></i>
          <span>${item.booking.customerName || 'ไม่ระบุชื่อ'}</span>
        </div>

        <button onclick="document.querySelector('[x-data]')._x_dataStack[0].showBookingDetails(document.querySelector('[x-data]')._x_dataStack[0].bookingData['${item.carName}']['${item.bookingNo}'])"
                class="w-full bg-blue-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
          <i class="fas fa-eye mr-1"></i> ดูรายละเอียด
        </button>
      </div>
    `;

            container.appendChild(card);
          });
        },

        // เพิ่มฟังก์ชันสำหรับการขยาย/หุบคอลัมน์ชื่อรถ
        toggleCarNamesColumn() {
          this.isCarNamesCollapsed = !this.isCarNamesCollapsed;

          // อัพเดทไอคอนปุ่ม
          const toggleButton = document.getElementById('toggleCarNames');
          if (toggleButton) {
            toggleButton.innerHTML = this.isCarNamesCollapsed
              ? '<i class="fas fa-chevron-right"></i>' // แสดงไอคอนขยาย
              : '<i class="fas fa-chevron-left"></i>'; // แสดงไอคอนหุบ
          }

          // อัพเดทความกว้างของคอลัมน์ชื่อรถ
          const carNameCells = document.querySelectorAll('.car-name-cell');
          carNameCells.forEach(cell => {
            if (this.isCarNamesCollapsed) {
              cell.classList.add('collapsed');
              cell.classList.remove('px-4');
              cell.classList.add('px-1');

              // เปลี่ยนการแสดงข้อมูลเป็นไอคอน
              const carName = cell.textContent;
              cell.innerHTML = '<i class="fas fa-car text-blue-500"></i>';
              cell.setAttribute('title', carName);
            } else {
              cell.classList.remove('collapsed');
              cell.classList.remove('px-1');
              cell.classList.add('px-4');

              // กลับไปแสดงข้อความชื่อรถตามปกติ
              const carName = cell.getAttribute('title');
              cell.textContent = carName;
            }
          });

          // บันทึกสถานะการแสดงผลลงใน localStorage (ถ้าต้องการให้จำค่าไว้)
          localStorage.setItem('carNamesCollapsed', this.isCarNamesCollapsed);
        },











        // แสดงรายละเอียดการจอง
        showBookingDetails(booking) {
          // ตรวจสอบว่า booking เป็น object และมีข้อมูลที่จำเป็น
          if (!booking || typeof booking !== 'object' || !booking.bookingNo) {
            console.error("ข้อมูลการจองไม่ถูกต้อง:", booking);
            this.showNotification('ข้อมูลการจองไม่ถูกต้องหรือไม่สมบูรณ์', 'error');
            return;
          }

          // console.log("แสดงรายละเอียดการจอง:", booking);
          this.currentBookingDetails = booking;
          this.showBookingDetailsModal = true;
        },


        // ฟังก์ชันแสดงรายละเอียดการจอง (ปรับปรุงเพิ่มเติม)
        // showBookingDetails(booking) {
        //   // สร้าง modal แสดงรายละเอียดการจอง
        //   const modalContent = document.createElement('div');
        //   modalContent.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        //   modalContent.id = 'bookingDetailModal';

        //   const modalDialog = document.createElement('div');
        //   modalDialog.className = 'bg-white rounded-lg shadow-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto';

        //   const modalHeader = document.createElement('div');
        //   modalHeader.className = 'flex justify-between items-center mb-4 border-b border-gray-200 pb-3';

        //   const modalTitle = document.createElement('h3');
        //   modalTitle.className = 'text-lg font-bold';
        //   modalTitle.textContent = 'รายละเอียดการจอง';

        //   const closeButton = document.createElement('button');
        //   closeButton.className = 'text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors';
        //   closeButton.innerHTML = '<i class="fas fa-times"></i>';
        //   closeButton.addEventListener('click', () => {
        //     document.getElementById('bookingDetailModal').remove();
        //   });

        //   modalHeader.appendChild(modalTitle);
        //   modalHeader.appendChild(closeButton);

        //   // แสดงข้อมูลการจอง
        //   const bookingInfo = document.createElement('div');
        //   bookingInfo.className = 'space-y-4';

        //   // ส่วนหัวของรายละเอียด
        //   const bookingHeader = document.createElement('div');
        //   bookingHeader.className = 'bg-violet-50 rounded-lg p-4 border-l-4 border-violet-500';

        //   // เลือกสีตามสถานะ
        //   let statusClass = 'bg-green-100 text-green-800';
        //   let statusText = 'ยืนยันแล้ว';

        //   if (booking.status === 'pending') {
        //     statusClass = 'bg-amber-100 text-amber-800';
        //     statusText = 'รอยืนยัน';
        //   }

        //   const bookingNumber = document.createElement('div');
        //   bookingNumber.className = 'flex justify-between items-center mb-2';

        //   const bookingId = document.createElement('div');
        //   bookingId.className = 'text-xl font-bold text-violet-700';
        //   bookingId.textContent = `หมายเลขการจอง: ${booking.bookingNo}`;

        //   const statusBadge = document.createElement('span');
        //   statusBadge.className = `px-2 py-1 rounded-full ${statusClass}`;
        //   statusBadge.textContent = statusText;

        //   bookingNumber.appendChild(bookingId);
        //   bookingNumber.appendChild(statusBadge);

        //   const customerName = document.createElement('div');
        //   customerName.className = 'text-gray-700';
        //   customerName.textContent = `ลูกค้า: ${booking.customerName || '-'}`;

        //   bookingHeader.appendChild(bookingNumber);
        //   bookingHeader.appendChild(customerName);

        //   // ส่วนรายละเอียดวันที่
        //   const daysSection = document.createElement('div');
        //   daysSection.className = 'bg-gray-50 rounded-lg p-4';

        //   const daysTitle = document.createElement('h4');
        //   daysTitle.className = 'font-medium text-gray-700 mb-2 flex items-center';
        //   daysTitle.innerHTML = '<i class="fas fa-calendar-alt text-blue-500 mr-2"></i> วันที่จอง';

        //   const daysList = document.createElement('div');
        //   daysList.className = 'space-y-2';

        //   // แสดงวันที่จอง
        //   if (booking.days && booking.days.length > 0) {
        //     booking.days.forEach(dayInfo => {
        //       const dayItem = document.createElement('div');
        //       dayItem.className = 'bg-white p-2 rounded border flex items-center';

        //       const isToday2 = this.isToday2(dayInfo.day, this.selectedScheduleMonth, this.selectedScheduleYear);
        //       if (isToday2) {
        //         dayItem.classList.add('border-green-500');
        //       }

        //       dayItem.innerHTML = `
        //         <i class="fas fa-calendar-day mr-2 ${isToday2 ? 'text-green-500' : 'text-gray-500'}"></i>
        //         <span>วันที่ ${dayInfo.day}/${this.selectedScheduleMonth}/${this.selectedScheduleYear}</span>
        //         ${isToday2 ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">วันนี้</span>' : ''}
        //       `;

        //       daysList.appendChild(dayItem);
        //     });
        //   } else {
        //     const noDays = document.createElement('div');
        //     noDays.className = 'text-gray-500 italic';
        //     noDays.textContent = 'ไม่มีข้อมูลวันที่';
        //     daysList.appendChild(noDays);
        //   }

        //   daysSection.appendChild(daysTitle);
        //   daysSection.appendChild(daysList);

        //   // เพิ่มปุ่มดำเนินการ
        //   const actionButtons = document.createElement('div');
        //   actionButtons.className = 'flex space-x-2 mt-4';

        //   const editButton = document.createElement('button');
        //   editButton.className = 'flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md flex items-center justify-center transition-colors';
        //   editButton.innerHTML = '<i class="fas fa-edit mr-2"></i> แก้ไข';

        //   const printButton = document.createElement('button');
        //   printButton.className = 'flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center justify-center transition-colors';
        //   printButton.innerHTML = '<i class="fas fa-print mr-2"></i> พิมพ์';

        //   actionButtons.appendChild(editButton);
        //   actionButtons.appendChild(printButton);

        //   // เพิ่มส่วนต่างๆ เข้าด้วยกัน
        //   bookingInfo.appendChild(bookingHeader);
        //   bookingInfo.appendChild(daysSection);
        //   bookingInfo.appendChild(actionButtons);

        //   modalDialog.appendChild(modalHeader);
        //   modalDialog.appendChild(bookingInfo);
        //   modalContent.appendChild(modalDialog);

        //   document.body.appendChild(modalContent);
        // },




        renderCalendarView() {
          // Render Agenda View for Mobile
          this.renderAgendaView();

          const calendarView = document.getElementById('calendarGrid');

          // ตรวจสอบว่า calendarView มีอยู่จริง
          if (!calendarView) {
            console.error("ไม่พบ element calendarGrid");
            return;
          }

          // ล้างข้อมูลเก่า
          calendarView.innerHTML = '';

          // สร้างหัวตาราง (วันในสัปดาห์) ด้วยสไตล์ที่ดีขึ้น
          const weekdays = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
          weekdays.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'text-center font-medium py-2 bg-gray-100 rounded-md text-gray-700';
            dayHeader.textContent = day;
            calendarView.appendChild(dayHeader);
          });

          // หาวันแรกของเดือน
          const firstDayOfMonth = new Date(this.selectedScheduleYear, this.selectedScheduleMonth - 1, 1);
          const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 = อาทิตย์, 1 = จันทร์, ...

          // สร้างช่องว่างสำหรับวันก่อนหน้าเดือนนี้ ด้วยการออกแบบที่ดีขึ้น
          for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'border border-gray-200 rounded-md p-2 min-h-24 bg-gray-50 opacity-50';
            calendarView.appendChild(emptyDay);
          }

          // จำนวนวันในเดือน
          const daysInMonth = this.getDaysInMonth(this.selectedScheduleYear, this.selectedScheduleMonth);

          // สร้างข้อมูลจำนวนการจองต่อวัน
          const bookingsPerDay = this.countBookingsPerDay(daysInMonth);

          // สร้างวันในปฏิทิน
          for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');

            // พื้นฐานสำหรับทุกวัน - เพิ่ม transition และ hover effects
            dayCell.className = 'border rounded-md p-3 min-h-28 relative transition-all duration-200 hover:shadow-md hover:border-violet-300 overflow-hidden';

            // ตรวจสอบว่าเป็นวันปัจจุบันหรือไม่
            const isCurrentDay = this.isToday2(day, this.selectedScheduleMonth, this.selectedScheduleYear);

            if (isCurrentDay) {
              // ปรับปรุงการแสดงวันปัจจุบัน
              dayCell.classList.add('bg-green-50');
              dayCell.classList.add('border-green-500');
              dayCell.classList.add('border-2');

              // เพิ่มป้ายวันนี้
              const todayBadge = document.createElement('div');
              todayBadge.className = 'absolute top-1 right-1 bg-green-500 text-white text-xs px-2 py-1 rounded-full';
              todayBadge.textContent = 'วันนี้';
              dayCell.appendChild(todayBadge);
            } else if (this.isWeekend(day, this.selectedScheduleMonth, this.selectedScheduleYear)) {
              dayCell.classList.add('bg-rose-50');

              // เพิ่มไอคอนเล็กๆ สำหรับวันหยุด
              const weekendIcon = document.createElement('div');
              weekendIcon.className = 'absolute top-1 right-1 text-rose-400 text-xs';
              weekendIcon.innerHTML = '<i class="fas fa-umbrella-beach"></i>';
              dayCell.appendChild(weekendIcon);
            }

            // สร้างหัวข้อวันที่ปรับปรุงแล้ว
            const dayHeader = document.createElement('div');
            dayHeader.className = 'font-bold text-lg flex justify-between items-center mb-2 z-10 relative';

            const dayNumber = document.createElement('span');
            dayNumber.textContent = day;
            dayNumber.className = isCurrentDay ? 'text-green-700' : '';
            dayHeader.appendChild(dayNumber);

            dayCell.appendChild(dayHeader);

            // เพิ่ม Heatmap สำหรับความเข้มข้นของการจอง
            if (bookingsPerDay[day] && bookingsPerDay[day].count > 0) {
              // กำหนดระดับความเข้มข้น
              const intensity = Math.min(bookingsPerDay[day].count / 5, 1); // สมมติว่า 5+ การจองคือความเข้มสูงสุด

              // เพิ่ม gradient overlay
              const gradient = document.createElement('div');
              gradient.className = 'absolute bottom-0 left-0 right-0 h-full z-0 opacity-15';

              // ปรับสีตามความเข้มข้น - จากอ่อนไปเข้ม
              if (bookingsPerDay[day].count <= 2) {
                gradient.classList.add('bg-violet-100');
              } else if (bookingsPerDay[day].count <= 4) {
                gradient.classList.add('bg-violet-200');
              } else {
                gradient.classList.add('bg-violet-300');
              }

              // ใส่ gradient ไว้หลังสุด เพื่อไม่ให้บังองค์ประกอบอื่น
              dayCell.insertBefore(gradient, dayCell.firstChild);
            }

            // ถ้ามีการจองในวันนี้
            if (bookingsPerDay[day] && bookingsPerDay[day].count > 0) {
              const bookingContainer = document.createElement('div');
              bookingContainer.className = 'mt-1 space-y-1.5 relative z-10';

              // แสดง 2 การจองแรกเท่านั้น - แสดงรายละเอียดย่อย
              for (let i = 0; i < Math.min(2, bookingsPerDay[day].bookings.length); i++) {
                const booking = bookingsPerDay[day].bookings[i];
                const bookingChip = document.createElement('div');

                // สีแตกต่างกันตามประเภทรถ
                let chipClass = 'bg-violet-100 text-violet-800';
                let carIcon = 'fa-car-side';

                // ตัวอย่างการกำหนดสีตามประเภทรถ (คุณสามารถปรับได้ตามข้อมูล)
                if (booking.carName.includes('SUV')) {
                  chipClass = 'bg-blue-100 text-blue-800';
                  carIcon = 'fa-truck';
                } else if (booking.carName.includes('Sport')) {
                  chipClass = 'bg-red-100 text-red-800';
                  carIcon = 'fa-car';
                }

                // ถ้าสถานะเป็น pending ให้ใช้สีเหลือง
                if (booking.booking.status === 'pending') {
                  chipClass = 'bg-amber-100 text-amber-800';
                }

                bookingChip.className = `text-xs px-2 py-1.5 rounded ${chipClass} flex items-center`;
                bookingChip.innerHTML = `
          <i class="fas ${carIcon} mr-1.5"></i>
          <span class="truncate">${booking.booking.bookingNo || 'ไม่ระบุ'}</span>
        `;

                bookingChip.style.cursor = 'pointer';
                bookingChip.addEventListener('click', () => {
                  this.showBookingDetails(booking.booking);
                });

                bookingContainer.appendChild(bookingChip);
              }

              // ถ้ามีการจองมากกว่า 2 รายการ ให้แสดงปุ่ม "ดูเพิ่มเติม"
              if (bookingsPerDay[day].bookings.length > 2) {
                const moreButton = document.createElement('div');
                moreButton.className = 'text-xs text-center text-violet-600 font-medium py-1 bg-violet-50 rounded hover:bg-violet-100 cursor-pointer';
                moreButton.textContent = `+ อีก ${bookingsPerDay[day].bookings.length - 2} การจอง`;

                moreButton.addEventListener('click', () => {

                  this.showDayBookings(day, bookingsPerDay[day].bookings);
                });

                bookingContainer.appendChild(moreButton);
              }

              dayCell.appendChild(bookingContainer);
            }

            // เพิ่ม click event สำหรับแสดงรายละเอียดวัน (desktop)
            dayCell.style.cursor = 'pointer';
            const currentDay = day;
            dayCell.addEventListener('click', (e) => {
              // ไม่ทำงานถ้าคลิกที่ booking chip
              if (e.target.closest('.text-xs')) return;
              this.updateDayDetailsPanel(currentDay);
            });

            calendarView.appendChild(dayCell);
          }
        },



        // Agenda View for Mobile
        updateDayDetailsPanel(day) {
          const panel = document.getElementById('dayDetailContent');
          if (!panel) return;

          const daysInMonth = this.getDaysInMonth(this.selectedScheduleYear, this.selectedScheduleMonth);
          const bookingsPerDay = this.countBookingsPerDay(daysInMonth);

          if (!bookingsPerDay[day] || bookingsPerDay[day].count === 0) {
            panel.innerHTML = '<div class="text-center py-8"><i class="fas fa-calendar-check text-4xl text-gray-300 mb-3"></i><p class="text-gray-500">ไม่มีการจองในวันนี้</p><p class="text-sm text-gray-400 mt-2">วันที่ ' + day + '/' + this.selectedScheduleMonth + '/' + this.selectedScheduleYear + '</p></div>';
            return;
          }

          let pickupCount = 0;
          let returnCount = 0;
          const pickupList = [];
          const returnList = [];
          const ongoingList = [];

          bookingsPerDay[day].bookings.forEach(item => {
            const isFirstDay = item.booking.days.some(d => d.day === day && d.isFirstDay);
            const isLastDay = item.booking.days[item.booking.days.length - 1].day === day;

            if (isFirstDay) {
              pickupCount++;
              pickupList.push(item);
            } else if (isLastDay) {
              returnCount++;
              returnList.push(item);
            } else {
              ongoingList.push(item);
            }
          });

          let html = '<div class="bg-white rounded-lg p-3 mb-3 border"><p class="text-sm font-medium text-gray-600">วันที่ ' + day + '/' + this.selectedScheduleMonth + '/' + this.selectedScheduleYear + '</p><p class="text-2xl font-bold text-gray-800">' + bookingsPerDay[day].count + ' การจอง</p></div>';

          if (pickupList.length > 0) {
            html += '<div class="mb-4"><h5 class="text-sm font-semibold text-blue-700 mb-2 flex items-center"><i class="fas fa-arrow-up mr-2"></i> รับรถ (' + pickupList.length + ')</h5><div class="space-y-2">';
            pickupList.forEach(item => {
              html += '<div class="bg-blue-50 rounded-lg p-3 cursor-pointer hover:bg-blue-100 transition-colors" onclick="document.querySelector(\'[x-data]\')._x_dataStack[0].showBookingDetails(document.querySelector(\'[x-data]\')._x_dataStack[0].bookingData[\'' + item.carName + '\'][\'' + item.booking.bookingNo + '\'])"><p class="font-medium text-blue-900">' + item.carName + '</p><p class="text-sm text-blue-700">' + item.booking.bookingNo + '</p><p class="text-xs text-blue-600">' + (item.booking.customerName || '-') + '</p></div>';
            });
            html += '</div></div>';
          }

          if (returnList.length > 0) {
            html += '<div class="mb-4"><h5 class="text-sm font-semibold text-green-700 mb-2 flex items-center"><i class="fas fa-arrow-down mr-2"></i> ส่งคืน (' + returnList.length + ')</h5><div class="space-y-2">';
            returnList.forEach(item => {
              html += '<div class="bg-green-50 rounded-lg p-3 cursor-pointer hover:bg-green-100 transition-colors" onclick="document.querySelector(\'[x-data]\')._x_dataStack[0].showBookingDetails(document.querySelector(\'[x-data]\')._x_dataStack[0].bookingData[\'' + item.carName + '\'][\'' + item.booking.bookingNo + '\'])"><p class="font-medium text-green-900">' + item.carName + '</p><p class="text-sm text-green-700">' + item.booking.bookingNo + '</p><p class="text-xs text-green-600">' + (item.booking.customerName || '-') + '</p></div>';
            });
            html += '</div></div>';
          }

          if (ongoingList.length > 0) {
            html += '<div class="mb-4"><h5 class="text-sm font-semibold text-purple-700 mb-2 flex items-center"><i class="fas fa-car-side mr-2"></i> กำลังเช่า (' + ongoingList.length + ')</h5><div class="space-y-2">';
            ongoingList.forEach(item => {
              html += '<div class="bg-purple-50 rounded-lg p-3 cursor-pointer hover:bg-purple-100 transition-colors" onclick="document.querySelector(\'[x-data]\')._x_dataStack[0].showBookingDetails(document.querySelector(\'[x-data]\')._x_dataStack[0].bookingData[\'' + item.carName + '\'][\'' + item.booking.bookingNo + '\'])"><p class="font-medium text-purple-900">' + item.carName + '</p><p class="text-sm text-purple-700">' + item.booking.bookingNo + '</p><p class="text-xs text-purple-600">' + (item.booking.customerName || '-') + '</p></div>';
            });
            html += '</div></div>';
          }

          panel.innerHTML = html;
        },

        renderAgendaView() {
          const container = document.getElementById('agendaView');
          if (!container) return;

          container.innerHTML = '';

          const daysInMonth = this.getDaysInMonth(this.selectedScheduleYear, this.selectedScheduleMonth);
          const bookingsPerDay = this.countBookingsPerDay(daysInMonth);

          const daysWithBookings = [];
          for (let day = 1; day <= daysInMonth; day++) {
            if (bookingsPerDay[day] && bookingsPerDay[day].count > 0) {
              daysWithBookings.push(day);
            }
          }

          if (daysWithBookings.length === 0) {
            container.innerHTML = '<div class="text-center py-12 bg-gray-50 rounded-xl"><i class="fas fa-calendar-times text-5xl text-gray-300 mb-4"></i><p class="text-gray-500 font-medium">ไม่มีการจองในเดือนนี้</p></div>';
            return;
          }

          daysWithBookings.forEach(day => {
            const dayData = bookingsPerDay[day];
            const isCurrentDay = this.isToday2(day, this.selectedScheduleMonth, this.selectedScheduleYear);
            const isWeekend = this.isWeekend(day, this.selectedScheduleMonth, this.selectedScheduleYear);

            const daySection = document.createElement('div');
            daySection.className = 'bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden';

            let headerClass = 'p-4 ';
            if (isCurrentDay) {
              headerClass += 'bg-gradient-to-r from-green-500 to-green-600 text-white';
            } else if (isWeekend) {
              headerClass += 'bg-gradient-to-r from-rose-100 to-rose-200 text-rose-800';
            } else {
              headerClass += 'bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800';
            }

            const dayNames = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];
            const date = new Date(this.selectedScheduleYear, this.selectedScheduleMonth - 1, day);
            const dayName = dayNames[date.getDay()];

            const header = document.createElement('div');
            header.className = headerClass;
            header.innerHTML = '<div class="flex items-center justify-between"><div><p class="text-2xl font-bold">' + day + '</p><p class="text-sm opacity-90">' + dayName + '</p></div><div class="text-right"><p class="text-lg font-semibold">' + dayData.count + ' การจอง</p>' + (isCurrentDay ? '<span class="text-xs bg-white bg-opacity-30 px-2 py-1 rounded-full">วันนี้</span>' : '') + '</div></div>';
            daySection.appendChild(header);

            const bookingsList = document.createElement('div');
            bookingsList.className = 'p-3 space-y-2';

            dayData.bookings.forEach(item => {
              const isFirstDay = item.booking.days.some(d => d.day === day && d.isFirstDay);
              const isLastDay = item.booking.days[item.booking.days.length - 1].day === day;

              let bgColor = 'bg-purple-50';
              let textColor = 'text-purple-900';
              let label = 'กำลังเช่า';
              let icon = 'fa-car-side';

              if (isFirstDay) {
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-900';
                label = 'รับรถ';
                icon = 'fa-arrow-up';
              }
              if (isLastDay) {
                bgColor = 'bg-green-50';
                textColor = 'text-green-900';
                label = 'ส่งคืน';
                icon = 'fa-arrow-down';
              }

              const bookingItem = document.createElement('div');
              bookingItem.className = bgColor + ' rounded-lg p-3 cursor-pointer hover:shadow-md transition-all';
              bookingItem.innerHTML = '<div class="flex items-center justify-between"><div class="flex items-center"><i class="fas ' + icon + ' mr-2 ' + textColor + '"></i><div><p class="font-medium ' + textColor + '">' + item.carName + '</p><p class="text-xs text-gray-600">' + (item.booking.customerName || '-') + '</p></div></div><div class="text-right"><span class="text-xs font-medium ' + textColor + '">' + label + '</span><p class="text-xs text-gray-500">' + item.booking.bookingNo + '</p></div></div>';
              bookingItem.addEventListener('click', () => {
                this.showBookingDetails(item.booking);
              });
              bookingsList.appendChild(bookingItem);
            });

            daySection.appendChild(bookingsList);
            container.appendChild(daySection);
          });
        },



        showDayBookings(day, bookings) {
          // สร้าง modal แสดงรายการจองในวันนี้
          const modalContent = document.createElement('div');
          modalContent.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          modalContent.id = 'dayBookingsModal';

          const modalDialog = document.createElement('div');
          modalDialog.className = 'bg-white rounded-lg shadow-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto';

          const modalHeader = document.createElement('div');
          modalHeader.className = 'flex justify-between items-center mb-4';

          const modalTitle = document.createElement('h3');
          modalTitle.className = 'text-lg font-bold';
          modalTitle.textContent = `การจองวันที่ ${day}/${this.selectedScheduleMonth}/${this.selectedScheduleYear}`;

          const closeButton = document.createElement('button');
          closeButton.className = 'text-gray-500 hover:text-gray-700';
          closeButton.innerHTML = '<i class="fas fa-times"></i>';
          closeButton.addEventListener('click', () => {
            document.getElementById('dayBookingsModal').remove();
          });

          modalHeader.appendChild(modalTitle);
          modalHeader.appendChild(closeButton);

          const bookingsList = document.createElement('div');
          bookingsList.className = 'space-y-3';

          // สร้างรายการการจอง
          bookings.forEach(bookingItem => {
            const bookingCard = document.createElement('div');
            bookingCard.className = 'border rounded-md p-3 hover:bg-blue-50 cursor-pointer';

            const bookingHeader = document.createElement('div');
            bookingHeader.className = 'font-medium text-blue-700';
            bookingHeader.textContent = `หมายเลขการจอง: ${bookingItem.bookingNo}`;

            const bookingCar = document.createElement('div');
            bookingCar.className = 'text-sm';
            bookingCar.textContent = `รถ: ${bookingItem.carName}`;

            const bookingCustomer = document.createElement('div');
            bookingCustomer.className = 'text-sm';
            bookingCustomer.textContent = `ลูกค้า: ${bookingItem.booking.customerName || '-'}`;

            bookingCard.appendChild(bookingHeader);
            bookingCard.appendChild(bookingCar);
            bookingCard.appendChild(bookingCustomer);

            // เพิ่ม event listener เมื่อคลิกที่รายการจอง
            bookingCard.addEventListener('click', () => {
              document.getElementById('dayBookingsModal').remove();
              this.showBookingDetails(bookingItem.booking);
            });

            bookingsList.appendChild(bookingCard);
          });

          modalDialog.appendChild(modalHeader);
          modalDialog.appendChild(bookingsList);
          modalContent.appendChild(modalDialog);

          document.body.appendChild(modalContent);
        },





        // ฟังก์ชันนับจำนวนการจองต่อวัน - ส่วนนี้คงไว้ใกล้เคียงเดิมแต่เพิ่มการเก็บข้อมูลสถานะ
        countBookingsPerDay(daysInMonth) {
          const bookingsPerDay = {};

          // เตรียมโครงสร้างข้อมูล
          for (let day = 1; day <= daysInMonth; day++) {
            bookingsPerDay[day] = {
              count: 0,
              bookings: [],
              // เพิ่มการเก็บข้อมูลสรุปตามประเภทรถ
              carTypes: {
                sedan: 0,
                suv: 0,
                sport: 0,
                other: 0
              }
            };
          }

          // วนลูปนับการจองต่อวัน
          for (const carName in this.bookingData) {
            const carBookings = this.bookingData[carName];

            // กำหนดประเภทรถ
            let carType = 'other';
            if (carName.toLowerCase().includes('suv')) carType = 'suv';
            else if (carName.toLowerCase().includes('sport')) carType = 'sport';
            else if (carName.toLowerCase().includes('เก๋ง') ||
              carName.toLowerCase().includes('sedan')) carType = 'sedan';

            for (const bookingNo in carBookings) {
              const booking = carBookings[bookingNo];

              if (booking.days && booking.days.length > 0) {
                booking.days.forEach(dayInfo => {
                  const day = dayInfo.day;

                  if (bookingsPerDay[day]) {
                    bookingsPerDay[day].count++;
                    bookingsPerDay[day].carTypes[carType]++;
                    bookingsPerDay[day].bookings.push({
                      bookingNo: booking.bookingNo,
                      carName: carName,
                      carType: carType,
                      booking: booking
                    });
                  }
                });
              }
            }
          }

          return bookingsPerDay;
        },















        shouldRenderBooking(bookings, day) {
          // แสดงเซลล์ถ้ามีการจองในวันนี้ และเป็นวันแรกของการจองในเดือนนี้ หรือวันก่อนหน้าไม่มีการจองหรือเป็นการจองคนละหมายเลข
          return bookings && bookings[day] &&
            (!bookings[day - 1] || bookings[day - 1].bookingNo !== bookings[day].bookingNo);
        },


        shouldSkipRender(bookings, day) {
          // ข้ามการแสดงเซลล์ถ้าเป็นวันต่อเนื่องของการจองเดียวกัน (ไม่ใช่วันแรก)
          return bookings && bookings[day] &&
            bookings[day - 1] && bookings[day - 1].bookingNo === bookings[day].bookingNo;
        },


        shouldRenderEmpty(bookings, day) {
          // แสดงเซลล์ว่างถ้าไม่มีการจอง หรือเป็นวันต่อเนื่องของการจองเดียวกัน
          return !bookings || !bookings[day] ||
            (bookings[day - 1] && bookings[day - 1].bookingNo === bookings[day].bookingNo);
        },

        // ฟังก์ชันนับจำนวนวันที่ต่อเนื่องกันของการจอง
        getConsecutiveDays(bookings, startDay) {
          if (!bookings || !bookings[startDay]) return 1;

          const bookingNo = bookings[startDay].bookingNo;
          let count = 1;
          let day = startDay + 1;

          // นับจำนวนวันที่ต่อเนื่องกันสำหรับหมายเลขการจองเดียวกัน
          const daysInMonth = this.getDaysInMonth(this.selectedScheduleYear, this.selectedScheduleMonth);

          while (day <= daysInMonth && bookings[day] && bookings[day].bookingNo === bookingNo) {
            count++;
            day++;
          }

          return count;
        },

        // เพิ่มฟังก์ชันสำหรับเตรียมข้อมูลตาราง
        // เพิ่มฟังก์ชันสำหรับเตรียมข้อมูลตาราง (ปรับปรุงใหม่)
        prepareTableData() {
          const result = [];
          const daysInMonth = this.getDaysInMonth(this.selectedScheduleYear, this.selectedScheduleMonth);

          // วนลูปสำหรับแต่ละรถ
          for (const [carName, days] of Object.entries(this.bookingData)) {
            const rowData = { carName, cells: [] };

            // ตรวจสอบทุกวันในเดือน
            for (let day = 1; day <= daysInMonth; day++) {
              // ถ้ามีการจองในวันนี้
              if (days[day]) {
                const booking = days[day];

                // ตรวจสอบว่าเป็นวันแรกของการจองหรือไม่
                if (!days[day - 1] || days[day - 1].bookingNo !== booking.bookingNo) {
                  // คำนวณจำนวนวันที่ต่อเนื่องกัน
                  let consecutiveDays = 1;
                  let nextDay = day + 1;

                  while (nextDay <= daysInMonth && days[nextDay] && days[nextDay].bookingNo === booking.bookingNo) {
                    consecutiveDays++;
                    nextDay++;
                  }

                  // เพิ่มเซลล์การจอง
                  rowData.cells.push({
                    type: 'booking',
                    day: day,
                    colspan: consecutiveDays,
                    data: booking
                  });
                } else {
                  // วันนี้เป็นวันต่อเนื่องของการจองก่อนหน้า ไม่ต้องแสดงเซลล์ใหม่
                  rowData.cells.push({ type: 'skip' });
                }
              } else {
                // วันที่ไม่มีการจอง
                rowData.cells.push({
                  type: 'empty',
                  day: day,
                  colspan: 1,
                  isWeekend: this.isWeekend(day, this.selectedScheduleMonth, this.selectedScheduleYear),
                  isToday: this.isToday(day, this.selectedScheduleMonth, this.selectedScheduleYear)
                });
              }
            }

            result.push(rowData);
          }

          return result;
        },

        // คำนวณจำนวนวันที่เช่า
        calculateRentalDays() {
          if (!this.currentBookingDetails) return 0;
          if (!this.currentBookingDetails.startDate || !this.currentBookingDetails.endDate ||
            !this.currentBookingDetails.startTime || !this.currentBookingDetails.endTime) {
            return 0;
          }

          try {
            // แปลงวันที่จาก dd/mm/yyyy เป็น yyyy-mm-dd
            const startParts = this.currentBookingDetails.startDate.split('/');
            const endParts = this.currentBookingDetails.endDate.split('/');

            if (startParts.length !== 3 || endParts.length !== 3) return 1;

            const startDateStr = `${startParts[2]}-${startParts[1]}-${startParts[0]}`;
            const endDateStr = `${endParts[2]}-${endParts[1]}-${endParts[0]}`;

            // ใช้ฟังก์ชันคำนวณที่สร้างขึ้นใหม่ และคืนค่าเฉพาะจำนวนวัน
            const rentalInfo = this.calculateRentalDaysWithHours(
              startDateStr,
              endDateStr,
              this.currentBookingDetails.startTime,
              this.currentBookingDetails.endTime
            );
            return rentalInfo.days || 0;
          } catch (e) {
            console.error("เกิดข้อผิดพลาดในการคำนวณจำนวนวัน:", e);
            return 1; // คืนค่าเริ่มต้น
          }
        },

        // รับชื่อเดือน
        getMonthName(month) {
          // แปลง month เป็นตัวเลขเพื่อให้แน่ใจว่าการเปรียบเทียบถูกต้อง
          const monthNumber = parseInt(month);

          // ค้นหา object ของเดือนที่ตรงกับ monthNumber
          const monthObject = this.monthNames.find(m => m.value === monthNumber);

          // ถ้าเจอให้คืนค่า name, ถ้าไม่เจอให้คืนค่าว่าง
          return monthObject ? monthObject.name : '';
        },

        // รับจำนวนวันในเดือน
        getDaysInMonth(year, month) {
          return new Date(year, month, 0).getDate();
        },

        // ตรวจสอบว่าเป็นวันหยุดสุดสัปดาห์หรือไม่
        isWeekend(day, month, year) {
          const date = new Date(year, month - 1, day);
          const dayOfWeek = date.getDay();
          return dayOfWeek === 0 || dayOfWeek === 6; // 0 = วันอาทิตย์, 6 = วันเสาร์
        },

        // ตรวจสอบว่าเป็นวันนี้หรือไม่
        // เพิ่มหรือแก้ไขฟังก์ชัน isToday ให้ทำงานถูกต้อง
        isToday(day, month, year) {
          const today = new Date();

          // ต้องแปลงเป็น string เพื่อให้แน่ใจว่าเปรียบเทียบในรูปแบบเดียวกัน
          const currentDay = today.getDate();
          const currentMonth = today.getMonth() + 1;
          const currentYear = today.getFullYear();

          // ใช้การเปรียบเทียบแบบสตริกต์ (===) และแปลงทุกค่าเป็น number
          const result = (Number(day) === currentDay) &&
            (Number(month) === currentMonth) &&
            (Number(year) === currentYear);

          console.log(`เปรียบเทียบ isToday: ${day}/${month}/${year} กับ ${currentDay}/${currentMonth}/${currentYear} = ${result}`);

          return result;
        },





        // รับจำนวนวันในเดือน
        getDaysInMonth(year, month) {
          return new Date(year, month, 0).getDate();
        },

        // คำนวณสถิติการใช้งานรถแต่ละคัน
        calculateCarUsageStats() {
          console.log('=== calculateCarUsageStats called ===');
          console.log('cars:', this.cars);
          console.log('rentals:', this.rentals);

          if (!this.cars || !Array.isArray(this.cars) || this.cars.length === 0) {
            console.log('No cars data available');
            this.carUsageStats = [];
            return;
          }

          const today = new Date();
          const currentMonth = today.getMonth() + 1;
          const currentYear = today.getFullYear();
          const daysInMonth = this.getDaysInMonth(currentYear, currentMonth);

          console.log('Current month:', currentMonth, 'Year:', currentYear, 'Days in month:', daysInMonth);

          const stats = [];

          // วนรอบรถทุกคัน
          this.cars.forEach(car => {
            const licensePlate = car.ทะเบียน || car.licensePlate || car.name || 'Unknown';
            const brand = car.ยี่ห้อ || car.brand || '';
            const model = car.รุ่น || car.model || '';
            const displayName = [brand, model, licensePlate].filter(x => x).join(' ');
            let rentalDays = 0;

            // นับวันเช่าจาก rentals
            if (this.rentals && Array.isArray(this.rentals)) {
              this.rentals.forEach(rental => {
                const rentalCarName = rental.รถ || rental.car || '';

                // ตรวจสอบว่าเป็นรถคันเดียวกันหรือไม่ (ใช้ทะเบียนในการเปรียบเทียบ)
                if (rentalCarName.includes(licensePlate) || licensePlate.includes(rentalCarName)) {
                  // แปลงวันที่จากรูปแบบ DD/MM/YYYY
                  const startDateStr = rental.วันรับรถ || rental.startDate || '';
                  const endDateStr = rental.วันคืนรถ || rental.endDate || '';

                  if (startDateStr && endDateStr) {
                    const startParts = startDateStr.split('/');
                    const endParts = endDateStr.split('/');

                    if (startParts.length === 3 && endParts.length === 3) {
                      const startDate = new Date(parseInt(startParts[2]), parseInt(startParts[1]) - 1, parseInt(startParts[0]));
                      const endDate = new Date(parseInt(endParts[2]), parseInt(endParts[1]) - 1, parseInt(endParts[0]));

                      // นับเฉพาะวันในเดือนปัจจุบัน
                      const monthStart = new Date(currentYear, currentMonth - 1, 1);
                      const monthEnd = new Date(currentYear, currentMonth, 0);

                      const effectiveStart = startDate < monthStart ? monthStart : startDate;
                      const effectiveEnd = endDate > monthEnd ? monthEnd : endDate;

                      if (effectiveStart <= effectiveEnd) {
                        const days = Math.ceil((effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24)) + 1;
                        rentalDays += days;
                      }
                    }
                  }
                }
              });
            }

            const availableDays = Math.max(0, daysInMonth - rentalDays);

            stats.push({
              name: displayName,
              rentalDays: rentalDays,
              availableDays: availableDays
            });
          });

          // เรียงตามวันเช่ามากสุด
          stats.sort((a, b) => b.rentalDays - a.rentalDays);

          console.log('carUsageStats calculated:', stats);
          this.carUsageStats = stats;
        },

        // ไปยังเดือนและปีปัจจุบัน
        goToToday() {
          const now = new Date();
          this.selectedScheduleMonth = now.getMonth() + 1;
          this.selectedScheduleYear = now.getFullYear();
          this.updateBookingTable();
        },





        // ฟังก์ชันอัปโหลดรูปโลโก้ร้าน
        uploadLogo(event) {
          const file = event.target.files[0];
          if (!file) return;

          // ตรวจสอบว่าเป็นไฟล์รูปภาพหรือไม่
          if (!file.type.match('image.*')) {
            this.logoUploadStatus = "กรุณาเลือกไฟล์รูปภาพเท่านั้น";
            return;
          }

          // แสดงสถานะการอัปโหลด
          this.logoUploadStatus = "กำลังอัปโหลด...";
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          // อ่านข้อมูลไฟล์เป็น base64
          const reader = new FileReader();
          reader.onload = (e) => {
            const base64Data = e.target.result.split(',')[1]; // เอาเฉพาะข้อมูล base64 หลัง comma

            // เรียกใช้ฟังก์ชัน Apps Script เพื่ออัปโหลดไฟล์
            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  this.config.URLรูปโลโก้ร้าน = result.fileUrl;
                  this.logoUploadStatus = "อัปโหลดสำเร็จ";

                  // อัปเดตการตั้งค่าอัตโนมัติ
                  this.saveConfig();
                } else {
                  this.logoUploadStatus = "อัปโหลดไม่สำเร็จ: " + result.message;
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.logoUploadStatus = "เกิดข้อผิดพลาด: " + error;
                this.isLoading = false;
              })
              .uploadLogoImage(base64Data, file.name, this.config.IDโฟลเดอร์หลัก, sheetID);
          };
          reader.readAsDataURL(file);
        },

        // ฟังก์ชันลบรูปโลโก้ร้าน
        removeLogo() {
          const sheetID = localStorage.getItem('sheetID') || '';
          // แสดงกล่องยืนยัน
          Swal.fire({
            title: 'ยืนยันการลบ',
            text: 'คุณต้องการลบรูปโลโก้ร้านนี้ใช่หรือไม่?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              // ถ้ามี URL ของรูปโลโก้ร้าน ให้ลบไฟล์ใน Google Drive ด้วย
              if (this.config.URLรูปโลโก้ร้าน) {
                this.isLoading = true;

                // ดึง file ID จาก URL
                const fileId = this.extractFileIdFromUrl(this.config.URLรูปโลโก้ร้าน);

                if (fileId) {
                  google.script.run
                    .withSuccessHandler(result => {
                      if (result.success) {
                        this.config.URLรูปโลโก้ร้าน = "";
                        this.logoUploadStatus = "";
                        this.showNotification('ลบรูปโลโก้ร้านสำเร็จ');

                        // อัปเดตการตั้งค่า
                        this.saveConfig();
                      } else {
                        this.showNotification('ลบไฟล์ไม่สำเร็จ: ' + result.message, 'error');
                      }
                      this.isLoading = false;
                    })
                    .withFailureHandler(error => {
                      this.showNotification('ลบไฟล์ไม่สำเร็จ: ' + error, 'error');
                      this.isLoading = false;
                    })
                    .deleteFile(fileId, sheetID);
                } else {
                  // ถ้าไม่สามารถดึง file ID ได้ ก็เคลียร์ URL ออกแทน
                  this.config.URLรูปโลโก้ร้าน = "";
                  this.logoUploadStatus = "";
                  this.isLoading = false;
                }
              } else {
                // ถ้าไม่มี URL อยู่แล้ว ก็เคลียร์ค่าเปล่าๆ
                this.config.URLรูปโลโก้ร้าน = "";
                this.logoUploadStatus = "";
              }
            }
          });
        },

        // ==================== LINE Bot Functions ====================

        // ฟังก์ชันโหลด Secret ID จาก Master Sheet
        loadLineBotSecretID() {
          console.log('🔵 [LINE Bot] เริ่มโหลด Secret ID...');
          const sheetID = localStorage.getItem('sheetID') || '';
          console.log('🔵 [LINE Bot] SheetID:', sheetID);

          if (!sheetID) {
            console.error('❌ [LINE Bot] ไม่พบ sheetID');
            return;
          }

          console.log('🔵 [LINE Bot] กำลังเรียก getLineBotSecretID()...');
          google.script.run
            .withSuccessHandler(result => {
              console.log('✅ [LINE Bot] ได้ผลลัพธ์จาก getLineBotSecretID:', result);
              if (result.success) {
                this.config.LINEBotSecretID = result.secretID || '';
                console.log('✅ [LINE Bot] Secret ID ที่โหลดได้:', this.config.LINEBotSecretID);
              } else {
                this.config.LINEBotSecretID = '';
                console.warn('⚠️ [LINE Bot] ไม่พบ Secret ID ในระบบ');
              }
            })
            .withFailureHandler(error => {
              console.error('❌ [LINE Bot] Error loading Secret ID:', error);
              this.config.LINEBotSecretID = '';
            })
            .getLineBotSecretID(sheetID);
        },

        // ฟังก์ชันสุ่ม Secret ID สำหรับ LINE Bot (6 หลัก)
        generateLineBotSecret() {
          const characters = '0123456789'; // เปลี่ยนให้มีแค่ตัวเลข
          let secret = '';
          for (let i = 0; i < 6; i++) {
            secret += characters.charAt(Math.floor(Math.random() * characters.length));
          }
          this.config.LINEBotSecretID = secret;

          // บันทึกไปที่ Master Sheet ทันที
          const sheetID = localStorage.getItem('sheetID') || '';
          this.isLoading = true;

          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;
              if (result.success) {
                this.showNotification('สุ่มและบันทึก Secret ID สำเร็จ: ' + secret, 'success');
              } else {
                this.showNotification('สุ่ม Secret ID สำเร็จแต่บันทึกไม่สำเร็จ: ' + result.message, 'warning');
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
            })
            .updateLineBotSecretID(sheetID, secret);
        },

        // ฟังก์ชันโหลดรายการผู้ใช้ LINE Bot
        loadLineBotUsers() {
          console.log('🟢 [LINE Bot] เริ่มโหลดรายการผู้ใช้...');
          const sheetID = localStorage.getItem('sheetID') || '';
          console.log('🟢 [LINE Bot] SheetID:', sheetID);

          if (!sheetID) {
            console.error('❌ [LINE Bot] ไม่พบ sheetID');
            return;
          }

          // ตรวจสอบว่า google.script พร้อมใช้งานหรือไม่
          if (typeof google === 'undefined' || typeof google.script === 'undefined') {
            console.error('❌ [LINE Bot] Google Apps Script API ยังไม่พร้อม');
            this.linebotUsers = [];
            return;
          }

          // โหลด Secret ID ด้วย
          console.log('🟢 [LINE Bot] กำลังโหลด Secret ID ด้วย...');
          this.loadLineBotSecretID();

          // โหลดรายการผู้ใช้
          console.log('🟢 [LINE Bot] กำลังเรียก getLineBotUsers()...');
          google.script.run
            .withSuccessHandler(users => {
              console.log('✅ [LINE Bot] ได้ผลลัพธ์จาก getLineBotUsers:', users);
              console.log('✅ [LINE Bot] ชนิดข้อมูล:', typeof users);
              console.log('✅ [LINE Bot] เป็น Array หรือไม่:', Array.isArray(users));

              if (users && Array.isArray(users)) {
                this.linebotUsers = users;
                console.log('✅ [LINE Bot] จำนวนผู้ใช้ที่โหลดได้:', users.length, 'คน');
                console.log('✅ [LINE Bot] รายชื่อผู้ใช้:', this.linebotUsers);

                // ตรวจสอบรายละเอียดของแต่ละ user
                users.forEach((user, index) => {
                  console.log(`🔍 [LINE Bot] User[${index}]:`, JSON.stringify(user));
                  console.log(`🔍 [LINE Bot] User[${index}].LineUserID:`, user.LineUserID);
                  console.log(`🔍 [LINE Bot] User[${index}].UserName:`, user.UserName);
                  console.log(`🔍 [LINE Bot] User[${index}].SheetID:`, user.SheetID);
                  console.log(`🔍 [LINE Bot] User[${index}] - ประเภทของ UserName:`, typeof user.UserName);
                  console.log(`🔍 [LINE Bot] User[${index}] - UserName ว่างหรือไม่:`, !user.UserName);
                });
              } else {
                this.linebotUsers = [];
                console.warn('⚠️ [LINE Bot] ไม่พบผู้ใช้ หรือ format ข้อมูลไม่ถูกต้อง');
              }
            })
            .withFailureHandler(error => {
              console.error('❌ [LINE Bot] Error loading LINE Bot users:', error);
              this.showNotification('ไม่สามารถโหลดรายการผู้ใช้ LINE Bot ได้: ' + error, 'error');
              this.linebotUsers = [];
            })
            .getLineBotUsers(sheetID);
        },

        // ฟังก์ชันลบผู้ใช้ LINE Bot
        deleteLineBotUser(lineUserId) {
          const sheetID = localStorage.getItem('sheetID') || '';

          Swal.fire({
            title: 'ยืนยันการลบผู้ใช้',
            text: 'คุณต้องการลบผู้ใช้ LINE Bot นี้ใช่หรือไม่?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isLoading = true;

              google.script.run
                .withSuccessHandler(result => {
                  this.isLoading = false;
                  if (result.success) {
                    this.showNotification('ลบผู้ใช้สำเร็จ', 'success');
                    // โหลดรายการใหม่
                    this.loadLineBotUsers();
                  } else {
                    this.showNotification('ลบผู้ใช้ไม่สำเร็จ: ' + result.message, 'error');
                  }
                })
                .withFailureHandler(error => {
                  this.isLoading = false;
                  this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                })
                .deleteLineBotUser(lineUserId, sheetID);
            }
          });
        },

        // ฟังก์ชันจัดรูปแบบวันที่
        formatDate(dateStr) {
          if (!dateStr) return '-';

          try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear() + 543; // แปลงเป็น พ.ศ.
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}/${month}/${year} ${hours}:${minutes}`;
          } catch (e) {
            return dateStr;
          }
        },

        // ==================== End LINE Bot Functions ====================

        async createSummaryText(rentalData) {
          // แสดง log ข้อมูลรายการเช่าเบื้องต้น
          // console.log("ข้อมูลรายการเช่าต้นฉบับ:", {
          //     วันที่เช่า: rentalData.วันที่เช่า,
          //     เวลารับรถ: rentalData.เวลารับรถ,
          //     วันที่คืน: rentalData.วันที่คืน,
          //     เวลาคืนรถ: rentalData.เวลาคืนรถ
          // });

          // ตรวจสอบว่ามีเทมเพลตข้อความหรือไม่
          if (!this.config.summaryMessageTemplate) {
            // โหลดค่าเริ่มต้นจาก Google Apps Script
            try {
              const sheetID = localStorage.getItem('sheetID') || '';
              const defaultTemplate = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .getDefaultSummaryTemplate(sheetID);
              });
              this.config.summaryMessageTemplate = defaultTemplate;
            } catch (error) {
              console.error('Error loading default template:', error);
              // ใช้ค่าเริ่มต้นแบบฮาร์ดโค้ด (ถ้าจำเป็น)
              this.config.summaryMessageTemplate = `[[rental_summary_title]]
[[booking_number]]: {{หมายเลขการจอง}}
[[document_date]]: {{วันที่เวลาปัจจุบัน}}

[[customer_info]]
[[customer_name]]: {{ชื่อลูกค้า}}
[[phone_number]]: {{เบอร์โทรศัพท์}}

[[car_info]]
[[car_model]]: {{รถ}}
[[license_plate]]: {{ทะเบียนรถ}}

[[rental_period]]
[[pickup_date]]: {{วันที่เช่า}} [[time]]: {{เวลารับรถ}}
[[return_date]]: {{วันที่คืน}} [[time]]: {{เวลาคืนรถ}}
[[rental_days]]: {{จำนวนวัน}}
[[extra_hours_info]]
[[overtime_hours]]: {{ชั่วโมงล่วงเวลา}}
[[overtime_fee]]: {{ค่าล่วงเวลา}}
[[car_seat_fee]]: {{ค่าคาร์ซีท}}
[[additional_insurance_fee]]: {{ค่าประกันเสริมรวม}}
[[insurance_days]]: {{จำนวนวันประกันเสริม}}

[[pickup_location]]: {{สถานที่รับรถ}}
[[return_location]]: {{สถานที่คืนรถ}}

[[payment_info]]
[[daily_rate]]: {{ราคาต่อวัน}}
[[total_rental]]: {{ค่าเช่ารวมทั้งหมด}}
[[booking_deposit]]: {{ค่ามัดจำคิวรถ}}
[[security_deposit]]: {{เงินประกันความเสียหาย}}
[[additional_service]]: {{ค่าบริการเพิ่มเติม}}
[[total_amount]]: {{รวมยอดชำระวันรับรถ}}

[[payment_method]]
[[bank_name]]: {{ชื่อธนาคาร}}
[[account_number]]: {{หมายเลขบัญชีธนาคาร}}
[[account_name]]: {{ชื่อบัญชี}}

[[rental_contract]]: {{ลิงก์สัญญาเช่า}}

[[issued_by]]: {{ชื่อบริษัท}}`;
            }
          }

          try {
            // เรียกใช้ generateSummary เพื่อสร้างข้อความสรุป
            const summaryText = this.generateSummary(rentalData);

            return summaryText; // Return ข้อความที่ได้จาก generateSummary
          } catch (error) {
            console.error('Error creating summary:', error);
            return "เกิดข้อผิดพลาดในการสร้างข้อความสรุป"; // หรือข้อความแสดงข้อผิดพลาดที่เหมาะสม
          }
        },



        // 3. ฟังก์ชันจัดการการคัดลอกข้อความสรุป
        async copySummaryForRental(rentalData) { // เพิ่ม rentalData เป็น Parameter
          try {
            this.showNotification('กำลังสร้างข้อความสรุป...', 'info');

            // สร้างข้อความสรุป
            const summaryText = await this.createSummaryText(rentalData);

            // สร้าง textarea ชั่วคราวเพื่อคัดลอกข้อความ
            const textarea = document.createElement('textarea');
            textarea.value = summaryText;
            // console.log('ข้อความสรุปก่อนคัดลอก:', summaryText);
            textarea.style.position = 'fixed';
            textarea.style.left = '0';
            textarea.style.top = '0';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);

            // เลือกข้อความและคัดลอกไปยังคลิปบอร์ด
            textarea.select();
            let copySuccess = false;

            try {
              copySuccess = document.execCommand('copy');
            } catch (err) {
              console.error('ไม่สามารถใช้ execCommand เพื่อคัดลอก:', err);
            }

            // ลบ textarea ชั่วคราว
            document.body.removeChild(textarea);

            // แสดงข้อความแจ้งเตือน
            if (copySuccess) {
              this.showNotification('คัดลอกข้อความสรุปไปยังคลิปบอร์ดแล้ว', 'success');
            } else {
              // ถ้าไม่สามารถคัดลอกได้ด้วย execCommand ลองใช้ Clipboard API
              if (navigator.clipboard && window.isSecureContext) {
                try {
                  await navigator.clipboard.writeText(summaryText);
                  this.showNotification('คัดลอกข้อความสรุปไปยังคลิปบอร์ดแล้ว', 'success');
                  return;
                } catch (err) {
                  console.error('ไม่สามารถใช้ Clipboard API:', err);
                }
              }

              // ถ้าทั้งสองวิธีล้มเหลว ให้แสดงข้อความในกล่องแจ้งเตือน
              Swal.fire({
                title: 'ข้อความสรุปรายการเช่า',
                html: `
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">ไม่สามารถคัดลอกอัตโนมัติได้ กรุณาคัดลอกข้อความด้านล่าง:</p>
                    <textarea id="summary-text-area" class="w-full h-64 p-2 border rounded text-sm">${summaryText}</textarea>
                </div>
                <button id="manual-copy-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    <i class="fas fa-copy mr-2"></i>คัดลอกข้อความ
                </button>
                `,
                showConfirmButton: true,
                confirmButtonText: 'ปิด',
                width: '80%',
                didOpen: () => {
                  const copyBtn = document.getElementById('manual-copy-btn');
                  const textArea = document.getElementById('summary-text-area');

                  if (copyBtn && textArea) {
                    copyBtn.addEventListener('click', () => {
                      textArea.select();
                      document.execCommand('copy');
                      Swal.showValidationMessage('คัดลอกข้อความแล้ว!');
                      setTimeout(() => Swal.resetValidationMessage(), 2000);
                    });
                  }
                }
              });
            }
          } catch (error) {
            console.error('Error creating or copying summary:', error);
            this.showNotification('ไม่สามารถสร้างหรือคัดลอกข้อความสรุปได้', 'error');

            // แสดงข้อความแจ้งข้อผิดพลาด
            Swal.fire({
              title: 'เกิดข้อผิดพลาด',
              text: 'ไม่สามารถสร้างหรือคัดลอกข้อความสรุปได้',
              icon: 'error'
            });
          }
        },


        loadTranslations() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.translations = result.data || {};
                // console.log("โหลดข้อมูลคำแปลสำเร็จ", Object.keys(this.translations).length, "รายการ");
              } else {
                console.error("โหลดข้อมูลคำแปลไม่สำเร็จ:", result.message);
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลคำแปล:", error);
              this.isLoading = false;
            })
            .getTranslations(sheetID);
        },

        syncSummaryTranslationKeys() {
          const sheetID = localStorage.getItem('sheetID') || '';
          if (!sheetID) {
            console.warn("ไม่พบ sheetID สำหรับการซิงค์คีย์แปลภาษา");
            return;
          }

          // console.log("กำลังซิงค์คีย์แปลภาษาสำหรับสรุปการเช่า...");

          // ซิงค์คีย์แปลภาษา
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                // console.log("ซิงค์คีย์แปลภาษาสำเร็จ:", result.message);
                if (result.addedCount > 0) {
                  console.log(`เพิ่มคีย์ใหม่ ${result.addedCount} รายการ`);
                  // โหลดข้อมูล translations ใหม่หลังจาก sync
                  this.loadTranslations();
                }
              } else {
                console.error("ซิงค์คีย์แปลภาษาไม่สำเร็จ:", result.message);
              }
            })
            .withFailureHandler(error => {
              console.error("เกิดข้อผิดพลาดในการซิงค์คีย์แปลภาษา:", error);
            })
            .syncSummaryTranslationKeys(sheetID);
        },


        translate(key, lang, ...params) {
          const language = lang || this.newRental.ภาษาสัญญาเช่า || 'th';
          const keyWithBrackets = `[[${key}]]`; // สร้าง key ที่มี [[ ]] ครอบ

          console.log(`[translate] key: ${key}, keyWithBrackets: ${keyWithBrackets}, language: ${language}`);

          let translatedText = '';
          if (this.translations && this.translations[keyWithBrackets] && this.translations[keyWithBrackets][language]) {
            translatedText = this.translations[keyWithBrackets][language];
            console.log(`[translate] พบคำแปล (ตรงภาษา): ${translatedText}`);
          } else if (this.translations && this.translations[keyWithBrackets] && this.translations[keyWithBrackets]['th']) {
            translatedText = this.translations[keyWithBrackets]['th'];
            console.log(`[translate] พบคำแปล (ภาษาไทย): ${translatedText}`);
          } else {
            console.log(`[translate] ไม่พบคำแปล`);
            return key;
          }

          if (params && params.length > 0) {
            params.forEach((param, index) => {
              translatedText = translatedText.replace(`{${index}}`, param);
            });
            console.log(`[translate] หลังแทนที่พารามิเตอร์: ${translatedText}`);
          }

          return translatedText;
        },






        loadTranslationKeys() {
          this.isLoading = true;
          // console.log("กำลังโหลดรายการคีย์แปลภาษา...");

          // กำหนดค่าเริ่มต้นให้ currentTranslation เมื่อเริ่มโหลดรายการคีย์
          this.currentTranslation = this.createEmptyTranslation();
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(result => {
              if (result && Array.isArray(result)) {
                this.translationKeys = result;
                // console.log("โหลดรายการคีย์สำเร็จ:", result.length, "รายการ");

                // สร้างคีย์ใหม่หลังจากโหลดรายการคีย์เสร็จ
                this.generateNewTranslationKey();

                // ถ้าไม่มีคีย์ที่ถูกเลือกอยู่ ให้เลือกคีย์แรกโดยอัตโนมัติ (ถ้ามี)
                if (!this.selectedTranslationKey && this.translationKeys.length > 0) {
                  this.selectedTranslationKey = this.translationKeys[0];
                  this.loadTranslationKey();
                }
              } else {
                console.warn("โหลดรายการคีย์ไม่สำเร็จหรือไม่มีข้อมูล:", result);
                this.translationKeys = [];
                // ไม่ต้องแสดงแจ้งเตือนถ้าไม่มีข้อมูล เพราะอาจเป็นกรณีปกติ
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("โหลดรายการคีย์ไม่สำเร็จ:", error);
              this.showNotification('โหลดรายการคีย์ไม่สำเร็จ: ' + error, 'error');
              this.translationKeys = [];
              this.isLoading = false;
            })
            .getTranslationKeys(sheetID);
        },

        // ฟังก์ชันสำหรับโหลดข้อมูลแปลของคีย์ที่เลือก
        loadTranslationKey() {
          if (!this.selectedTranslationKey) {
            // ถ้าไม่มีคีย์ที่เลือก ให้ใช้ค่าเริ่มต้น (แทนที่จะเป็น null)
            this.currentTranslation = this.createEmptyTranslation();
            return;
          }

          this.isLoading = true;
          // console.log("กำลังโหลดข้อมูลคีย์:", this.selectedTranslationKey);

          this.currentTranslation = this.createEmptyTranslation();
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result) {
                // console.log("โหลดข้อมูลคีย์สำเร็จ:", result);
                this.currentTranslation = result;
              } else {
                console.warn("ไม่พบข้อมูลคีย์ที่เลือก:", this.selectedTranslationKey);
                this.currentTranslation = this.createEmptyTranslation();
                this.showNotification('ไม่พบข้อมูลแปลภาษาสำหรับคีย์นี้', 'warning');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("โหลดข้อมูลคีย์ไม่สำเร็จ:", error);
              this.showNotification('โหลดข้อมูลแปลภาษาไม่สำเร็จ: ' + error, 'error');
              this.currentTranslation = this.createEmptyTranslation();
              this.isLoading = false;
            })
            .getTranslationByKey(this.selectedTranslationKey, sheetID);
        },

        // ฟังก์ชันสร้างออบเจ็กต์แปลภาษาเปล่า
        createEmptyTranslation() {
          return {
            th: '', en: '', 'zh-CN': '', ko: '', ru: '', ms: '', ja: '', he: '', fr: '', tr: '',
            es: '', it: '', lo: '', my: '', vi: '', de: '', 'zh-TW': '', id: ''
          };
        },

        // ฟังก์ชันสร้างคีย์ใหม่
        generateNewTranslationKey() {
          if (this.translationKeys.length === 0) {
            this.newTranslationKey = '[[TRANSLATION_1]]';
            return;
          }

          // ค้นหาค่าตัวเลขสูงสุดจากคีย์ที่มีอยู่
          let maxNumber = 0;

          this.translationKeys.forEach(key => {
            const match = key.match(/\[\[TRANSLATION_(\d+)\]\]/);
            if (match && match[1]) {
              const num = parseInt(match[1], 10);
              if (!isNaN(num) && num > maxNumber) {
                maxNumber = num;
              }
            }
          });

          // สร้างคีย์ใหม่โดยเพิ่มค่าตัวเลขขึ้น 1
          this.newTranslationKey = `[[TRANSLATION_${maxNumber + 1}]]`;

          // รีเซ็ตฟอร์มแปลภาษาใหม่
          this.newTranslation = this.createEmptyTranslation();
        },

        // ฟังก์ชันแปลภาษาอัตโนมัติ
        translateAll(mode) {
          // กำหนดข้อความต้นฉบับและภาษาปลายทาง
          const sourceText = mode === 'edit' ? this.currentTranslation.th : this.newTranslation.th;

          if (!sourceText) {
            this.showNotification('กรุณากรอกข้อความภาษาไทยก่อน', 'error');
            return;
          }

          // รายการภาษาปลายทาง
          const targetLanguages = [
            'en', 'zh-CN', 'ko', 'ru', 'ms', 'ja', 'he', 'fr', 'tr',
            'es', 'it', 'lo', 'my', 'vi', 'de', 'zh-TW', 'id'
          ];

          // แสดงการโหลด
          this.isLoading = true;
          this.isTranslating = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          // เรียก API แปลภาษา
          google.script.run
            .withSuccessHandler(result => {
              if (result && typeof result === 'object') {
                // อัปเดตการแปลภาษา
                if (mode === 'edit') {
                  targetLanguages.forEach(lang => {
                    if (result[lang]) {
                      this.currentTranslation[lang] = result[lang];
                    }
                  });
                } else {
                  targetLanguages.forEach(lang => {
                    if (result[lang]) {
                      this.newTranslation[lang] = result[lang];
                    }
                  });
                }

                this.showNotification('แปลภาษาอัตโนมัติสำเร็จ', 'success');
              } else {
                this.showNotification('แปลภาษาไม่สำเร็จ', 'error');
              }
              this.isLoading = false;
              this.isTranslating = false;
            })
            .withFailureHandler(error => {
              this.showNotification('แปลภาษาไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
              this.isTranslating = false;
            })
            .translateText(sourceText, targetLanguages, sheetID);
        },

        // ฟังก์ชันบันทึกการแปลภาษา
        saveTranslation(mode) {
          const translationData = mode === 'edit' ? this.currentTranslation : this.newTranslation;
          const translationKey = mode === 'edit' ? this.selectedTranslationKey : this.newTranslationKey;
          const sheetID = localStorage.getItem('sheetID') || '';
          if (!translationData.th) {
            this.showNotification('กรุณากรอกข้อความภาษาไทยก่อน', 'error');
            return;
          }

          // แสดงข้อความยืนยัน
          Swal.fire({
            title: mode === 'edit' ? 'ยืนยันการบันทึกแก้ไข' : 'ยืนยันการสร้างคำแปลใหม่',
            text: mode === 'edit' ?
              `คุณต้องการบันทึกการแก้ไขคำแปลสำหรับคีย์ ${translationKey} ใช่หรือไม่?` :
              `คุณต้องการสร้างคำแปลใหม่ด้วยคีย์ ${translationKey} ใช่หรือไม่?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ใช่, บันทึกเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isLoading = true;

              if (mode === 'edit') {
                // บันทึกการแก้ไข
                google.script.run
                  .withSuccessHandler(result => {
                    if (result.success) {
                      this.showNotification('บันทึกการแก้ไขคำแปลสำเร็จ', 'success');
                      // โหลดข้อมูลใหม่หลังบันทึก
                      this.loadTranslationKey();
                    } else {
                      this.showNotification('บันทึกการแก้ไขคำแปลไม่สำเร็จ: ' + result.message, 'error');
                    }
                    this.isLoading = false;
                  })
                  .withFailureHandler(error => {
                    this.showNotification('บันทึกการแก้ไขคำแปลไม่สำเร็จ: ' + error, 'error');
                    this.isLoading = false;
                  })
                  .updateTranslation(translationKey, translationData, sheetID);
              } else {
                // สร้างคำแปลใหม่
                google.script.run
                  .withSuccessHandler(result => {
                    if (result.success) {
                      this.showNotification('สร้างคำแปลใหม่สำเร็จ', 'success');

                      // โหลดรายการคีย์ใหม่
                      this.loadTranslationKeys();

                      // รีเซ็ตฟอร์ม
                      this.newTranslation = this.createEmptyTranslation();
                    } else {
                      this.showNotification('สร้างคำแปลใหม่ไม่สำเร็จ: ' + result.message, 'error');
                    }
                    this.isLoading = false;
                  })
                  .withFailureHandler(error => {
                    this.showNotification('สร้างคำแปลใหม่ไม่สำเร็จ: ' + error, 'error');
                    this.isLoading = false;
                  })
                  .addNewTranslation(translationKey, translationData, sheetID);
              }
            }
          });
        },


        openLicenseRenewalModal() {
          // รีเซ็ตค่าเริ่มต้น
          this.selectedRenewalPlan = '';
          this.showPaymentInfo = false;
          this.slipFile = null;
          this.slipPreviewUrl = null;
          this.activeTab = 'plans';

          // เปิด Modal
          this.showLicenseRenewalModal = true;

          // ดึงค่า sheetID และ storeSID จาก localStorage
          const sheetID = localStorage.getItem('sheetID');
          const storeSID = localStorage.getItem('storeSID');

          // ถ้าไม่มีข้อมูล sheetID หรือ storeSID ให้แสดงข้อความแจ้งเตือน
          if (!sheetID || !storeSID) {
            console.error('ไม่พบข้อมูล sheetID หรือ storeSID ใน localStorage');
            return;
          }

          // ตรวจสอบสถานะ license อีกครั้งเพื่อความแน่ใจ แต่ไม่ปิด modal
          google.script.run
            .withSuccessHandler(result => {
              // อัพเดทข้อมูล license ทั้งหมด แต่ไม่ปิด modal
              this.licenseExpireDate = result.expireDate;
              this.licenseDaysRemaining = result.daysToExpiration || 0;
              this.licenseExpired = (result.valid) ? false : true;

              // อัพเดท localStorage
              localStorage.setItem('licenseExpireDate', result.expireDate);
              localStorage.setItem('licenseNearExpiration', result.nearExpiration || 'false');
              localStorage.setItem('licenseExpired', (result.valid) ? 'false' : 'true');
              localStorage.setItem('licenseDaysRemaining', (result.daysToExpiration || 0).toString());

              // อัพเดท storeSID และ sheetID
              if (result.storeSID) localStorage.setItem('storeSID', result.storeSID);
              if (result.sheetID) localStorage.setItem('sheetID', result.sheetID);
            })
            .withFailureHandler(error => {
              console.error('Error checking license status:', error);
            })
            .checkLicenseStatus(sheetID, storeSID);
        },



        // แก้ไขฟังก์ชันปิด Modal ต่ออายุ
        closeLicenseRenewalModal() {
          this.showLicenseRenewalModal = false;

          // ถ้า license หมดอายุ ให้กลับไปที่หน้า login
          if (this.licenseExpired) {
            this.isLoggedIn = false;
          }
        },

        // ฟังก์ชันคัดลอกข้อความไปยังคลิปบอร์ด
        // copyToClipboard(elementId) {
        //   const element = document.getElementById(elementId);
        //   element.select();
        //   document.execCommand('copy');

        //   // แสดงข้อความแจ้งเตือน
        //   Swal.fire({
        //     title: 'คัดลอกแล้ว',
        //     text: 'คัดลอกข้อมูลไปยังคลิปบอร์ดแล้ว',
        //     icon: 'success',
        //     timer: 1500,
        //     showConfirmButton: false
        //   });
        // },

        // ฟังก์ชันจัดการการอัพโหลดสลิป
        handleSlipUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          if (!file.type.startsWith('image/')) {
            Swal.fire({
              title: 'ไฟล์ไม่ถูกต้อง',
              text: 'กรุณาอัพโหลดไฟล์รูปภาพเท่านั้น',
              icon: 'error'
            });
            return;
          }

          if (file.size > 10 * 1024 * 1024) { // ขนาดเกิน 10MB
            Swal.fire({
              title: 'ไฟล์มีขนาดใหญ่เกินไป',
              text: 'กรุณาอัพโหลดไฟล์ขนาดไม่เกิน 10MB',
              icon: 'error'
            });
            return;
          }

          this.slipFile = file;

          // สร้าง URL สำหรับแสดงตัวอย่างรูปภาพ
          this.slipPreviewUrl = URL.createObjectURL(file);
        },



        // ฟังก์ชันส่งข้อมูลการต่ออายุ
        // ฟังก์ชันส่งข้อมูลการต่ออายุ
        async submitRenewalPayment() {
          if (!this.slipFile || !this.selectedRenewalPlan) {
            this.showNotification('กรุณาเลือกแผนและอัพโหลดสลิปโอนเงิน', 'error');
            return;
          }

          // เปลี่ยนสถานะเป็นกำลังส่งข้อมูล
          this.isLoading = true;
          console.log('เงื่อนไขครบถ้วน กำลังดำเนินการส่งข้อมูลต่ออายุ...');

          // ดึง storeSID จาก localStorage
          const storeSID = localStorage.getItem('storeSID') || '';

          // เตรียมข้อมูลสำหรับส่ง
          const renewalData = {
            plan: this.selectedRenewalPlan,
            storeSID: storeSID, // ใช้ค่าจาก localStorage โดยตรง
            email: this.currentUser.email || '',
            renewalDate: new Date().toISOString()
          };

          // แปลงไฟล์สลิปเป็น Base64
          if (this.slipFile) {
            try {
              const arrayBuffer = await this.slipFile.arrayBuffer();
              const uint8Array = new Uint8Array(arrayBuffer);
              let binary = '';
              for (let i = 0; i < uint8Array.byteLength; i++) {
                binary += String.fromCharCode(uint8Array[i]);
              }
              renewalData.base64File = btoa(binary);
              renewalData.fileName = this.slipFile.name;
              renewalData.fileType = this.slipFile.type;
              console.log('แปลงไฟล์สลิปเป็น Base64 สำเร็จ');
            } catch (e) {
              console.error('Error converting file to Base64:', e);
              Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถอ่านไฟล์สลิปได้ กรุณาลองใหม่'
              });
              this.isLoading = false;
              return;
            }
          } else {
            console.warn('ไม่มีไฟล์สลิปแนบ!');
            this.isLoading = false;
            return;
          }

          // ส่งข้อมูลไปยังเซิร์ฟเวอร์
          google.script.run
            .withSuccessHandler(result => {
              console.log('submitLicenseRenewal Success:', result);
              this.isLoading = false;

              if (result.success) {
                // อัพเดตข้อมูล license
                this.licenseExpired = false;
                this.licenseExpireDate = result.expireDate;
                this.licenseDaysRemaining = result.daysToExpiration || 0;

                // อัพเดท localStorage ให้ครบถ้วน
                localStorage.setItem('licenseExpireDate', result.expireDate);
                localStorage.setItem('licenseExpired', 'false');
                localStorage.setItem('licenseDaysRemaining', (result.daysToExpiration || 0).toString());
                localStorage.setItem('licenseNearExpiration', 'false');

                // แสดงข้อความสำเร็จแบบกระชับ
                Swal.fire({
                  icon: 'success',
                  title: 'แจ้งชำระเงินสำเร็จ',
                  text: 'ได้รับข้อมูลการต่ออายุเรียบร้อยแล้ว ทางร้านจะรีบดำเนินการให้เร็วที่สุด',
                  confirmButtonText: 'ปิด'
                });

                // ปิด Modal
                this.closeLicenseRenewalModal();
              } else {
                this.showNotification('ต่ออายุ License ไม่สำเร็จ: ' + result.message, 'error');
              }
            })
            .withFailureHandler(error => {
              console.error('submitLicenseRenewal Failed:', error);
              this.isLoading = false;
              this.showNotification('เกิดข้อผิดพลาดในการต่ออายุ License: ' + error, 'error');
            })
            .submitLicenseRenewal(renewalData);
        },





        loadKeyInfoForDeletion() {
          if (!this.selectedKeyToDelete) {
            // console.log("ไม่ได้เลือกคีย์ที่จะลบ");
            this.keyInfoForDeletion = {
              loaded: false,
              thTranslation: '',
              enTranslation: '',
              translationCount: 0
            };
            return;
          }

          // console.log("กำลังโหลดข้อมูลคีย์สำหรับลบ:", this.selectedKeyToDelete);
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              // console.log("โหลดข้อมูลคีย์สำเร็จ:", result);
              if (result) {
                // นับจำนวนภาษาที่มีคำแปล
                let translationCount = 0;
                for (const lang in result) {
                  if (result[lang] && result[lang].trim() !== '') {
                    translationCount++;
                  }
                }

                this.keyInfoForDeletion = {
                  loaded: true,
                  thTranslation: result.th || '',
                  enTranslation: result.en || '',
                  translationCount: translationCount
                };
              } else {
                console.warn("ไม่พบข้อมูลคีย์ที่เลือก");
                this.keyInfoForDeletion = {
                  loaded: true,
                  thTranslation: '(ไม่พบข้อมูล)',
                  enTranslation: '(ไม่พบข้อมูล)',
                  translationCount: 0
                };
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("โหลดข้อมูลคีย์ไม่สำเร็จ:", error);
              this.showNotification('โหลดข้อมูลคีย์ไม่สำเร็จ: ' + error, 'error');
              this.keyInfoForDeletion = {
                loaded: false,
                thTranslation: '',
                enTranslation: '',
                translationCount: 0
              };
              this.isLoading = false;
            })
            .getTranslationByKey(this.selectedKeyToDelete, sheetID);
        },

        // ฟังก์ชันยืนยันการลบคีย์
        confirmDeleteKey() {
          if (!this.selectedKeyToDelete) {
            this.showNotification('กรุณาเลือกคีย์ที่ต้องการลบ', 'error');
            return;
          }

          const keyToDelete = this.selectedKeyToDelete;
          const thTranslation = this.keyInfoForDeletion.thTranslation || '(ไม่มีข้อมูล)';

          // แสดงหน้าต่างยืนยันการลบ
          Swal.fire({
            title: 'ยืนยันการลบคีย์',
            html: `
      <div class="text-left">
        <p>คุณกำลังจะลบคีย์:</p>
        <p class="font-bold mt-2">${keyToDelete}</p>
        <p class="mt-2">คำแปลภาษาไทย:</p>
        <p class="bg-gray-100 p-2 rounded mt-1">${thTranslation}</p>
        <p class="text-red-600 mt-4">การลบจะไม่สามารถกู้คืนได้ คุณแน่ใจหรือไม่?</p>
      </div>
    `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              // เรียกฟังก์ชันลบคีย์
              this.deleteTranslationKey(keyToDelete);
            }
          });
        },

        // ฟังก์ชันลบคีย์แปลภาษา
        deleteTranslationKey(key) {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('ลบคีย์สำเร็จ', 'success');

                // รีเซ็ตค่า
                this.selectedKeyToDelete = '';
                this.keyInfoForDeletion = {
                  loaded: false,
                  thTranslation: '',
                  enTranslation: '',
                  translationCount: 0
                };

                // โหลดรายการคีย์ใหม่
                this.loadTranslationKeys();
              } else {
                this.showNotification('ลบคีย์ไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('ลบคีย์ไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .deleteTranslationKey(key, sheetID);
        },







        // ฟังก์ชันแจ้งเตือน


        // ฟังก์ชันเปิดฟอร์มสร้างการแจ้งเตือนใหม่
        openMaintenanceForm() {
          this.maintenanceEditMode = false;
          this.maintenanceModalTitle = 'สร้างการแจ้งเตือนใหม่';
          this.isCustomMaintenanceType = false;

          // รีเซ็ตค่าเริ่มต้น
          this.currentMaintenance = {
            รถ: '',
            ประเภทการแจ้งเตือน: '',
            รูปแบบการแจ้งเตือน: 'ครั้งเดียว',
            วันที่แจ้งเตือน: this.getThaiDate2(), // ใช้วันที่ปัจจุบันเป็นค่าเริ่มต้น
            วันที่ในเดือน: 1,
            ระยะทางเป้าหมาย: 0,
            ระยะทางปัจจุบัน: 0,
            หมายเหตุ: '',
            สถานะ: 'Active',
            ทำรายการแล้ว: false
          };

          this.showMaintenanceModal = true;
        },



        // ฟังก์ชันปิด Modal การแจ้งเตือน
        closeMaintenanceModal() {
          this.showMaintenanceModal = false;
        },





        // ฟังก์ชันตรวจสอบความถูกต้องของฟอร์ม
        validateMaintenanceForm() {
          const maintenance = this.currentMaintenance;

          // ตรวจสอบข้อมูลทั่วไป
          if (!maintenance.รถ || !maintenance.ประเภทการแจ้งเตือน || !maintenance.รูปแบบการแจ้งเตือน) {
            this.showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
            return false;
          }

          // ตรวจสอบข้อมูลตามรูปแบบการแจ้งเตือน
          if (maintenance.รูปแบบการแจ้งเตือน === 'ครั้งเดียว' && !maintenance.วันที่แจ้งเตือน) {
            this.showNotification('กรุณาระบุวันที่แจ้งเตือน', 'error');
            return false;
          }

          if (maintenance.รูปแบบการแจ้งเตือน === 'ทุกเดือน') {
            const day = parseInt(maintenance.วันที่ในเดือน);
            if (isNaN(day) || day < 1 || day > 28) {
              this.showNotification('กรุณาระบุวันที่ในเดือนระหว่าง 1-28', 'error');
              return false;
            }
          }

          if (maintenance.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด') {
            const target = parseFloat(maintenance.ระยะทางเป้าหมาย);
            const current = parseFloat(maintenance.ระยะทางปัจจุบัน);

            if (isNaN(target) || target <= 0) {
              this.showNotification('กรุณาระบุระยะทางเป้าหมายที่มากกว่า 0', 'error');
              return false;
            }

            if (isNaN(current) || current < 0) {
              this.showNotification('กรุณาระบุระยะทางปัจจุบันที่ถูกต้อง', 'error');
              return false;
            }
          }

          return true;
        },

        // ฟังก์ชันทำเครื่องหมายว่าเสร็จสิ้น
        markAsCompleted(maintenance) {
          if (maintenance.ทำรายการแล้ว) {
            return; // ถ้าทำเสร็จแล้ว ไม่ต้องทำอะไร
          }
          const sheetID = localStorage.getItem('sheetID') || '';
          Swal.fire({
            title: 'ยืนยันการทำรายการ',
            text: `คุณต้องการทำเครื่องหมายว่ารายการ "${maintenance.ประเภทการแจ้งเตือน}" เสร็จสิ้นแล้วใช่หรือไม่?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10B981',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'ใช่, ทำเครื่องหมายเสร็จสิ้น',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isLoading = true;

              // สร้างข้อมูลอัพเดต
              const updateData = {
                id: maintenance.id,
                ทำรายการแล้ว: true,
                ทำรายการเมื่อ: new Date().toLocaleString('th-TH')
              };

              google.script.run
                .withSuccessHandler(result => {
                  if (result.success) {
                    this.showNotification('อัพเดตสถานะเสร็จสิ้น');
                    this.loadMaintenance(); // โหลดข้อมูลใหม่
                  } else {
                    this.showNotification('อัพเดตสถานะไม่สำเร็จ: ' + result.message, 'error');
                  }
                  this.isLoading = false;
                })
                .withFailureHandler(error => {
                  this.showNotification('อัพเดตสถานะไม่สำเร็จ: ' + error, 'error');
                  this.isLoading = false;
                })
                .markMaintenanceAsCompleted(updateData, sheetID);
            }
          });
        },

        // ฟังก์ชันลบการแจ้งเตือน
        deleteMaintenance(maintenanceId) {
          const sheetID = localStorage.getItem('sheetID') || '';
          Swal.fire({
            title: 'ยืนยันการลบ',
            text: 'คุณต้องการลบรายการแจ้งเตือนนี้ใช่หรือไม่?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isLoading = true;

              google.script.run
                .withSuccessHandler(result => {
                  if (result.success) {
                    this.showNotification('ลบรายการแจ้งเตือนสำเร็จ');
                    this.loadMaintenance(); // โหลดข้อมูลใหม่
                  } else {
                    this.showNotification('ลบรายการแจ้งเตือนไม่สำเร็จ: ' + result.message, 'error');
                  }
                  this.isLoading = false;
                })
                .withFailureHandler(error => {
                  this.showNotification('ลบรายการแจ้งเตือนไม่สำเร็จ: ' + error, 'error');
                  this.isLoading = false;
                })
                .deleteMaintenance(maintenanceId, sheetID);
            }
          });
        },









        // อัพเดตรายการแจ้งเตือนที่ใกล้จะถึง (ปรับปรุงการเรียงลำดับ)
        updateUpcomingMaintenance() {
          if (!this.maintenance || !Array.isArray(this.maintenance)) {
            this.upcomingMaintenance = [];
            return;
          }

          const now = new Date();
          const nextWeek = new Date();
          nextWeek.setDate(now.getDate() + 7);

          // สร้างวันที่สำหรับวันนี้โดยไม่สนใจเวลา
          const todayWithoutTime = new Date(now.getFullYear(), now.getMonth(), now.getDate());

          // สร้างวันที่สำหรับอีก 7 วันข้างหน้าโดยไม่สนใจเวลา
          const nextWeekWithoutTime = new Date(nextWeek.getFullYear(), nextWeek.getMonth(), nextWeek.getDate());

          this.upcomingMaintenance = this.maintenance.filter(item => {
            if (item.ทำรายการแล้ว) return false;

            if (item.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
              try {
                let alertDate;

                if (typeof item.วันที่แจ้งเตือน === 'string') {
                  if (item.วันที่แจ้งเตือน.includes('/')) {
                    // รูปแบบ dd/mm/yyyy
                    const parts = item.วันที่แจ้งเตือน.split('/');
                    if (parts.length === 3) {
                      alertDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                    }
                  } else if (item.วันที่แจ้งเตือน.includes('-')) {
                    // รูปแบบYYYY-mm-dd
                    const parts = item.วันที่แจ้งเตือน.split('-');
                    if (parts.length === 3) {
                      alertDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    }
                  }
                }

                if (alertDate && !isNaN(alertDate.getTime())) {
                  // สร้างวันที่แจ้งเตือนโดยไม่สนใจเวลา
                  const alertDateWithoutTime = new Date(alertDate.getFullYear(), alertDate.getMonth(), alertDate.getDate());
                  return alertDateWithoutTime <= nextWeekWithoutTime && alertDateWithoutTime >= todayWithoutTime;
                }
                return false;

              } catch (e) {
                console.error("ไม่สามารถแปลงวันที่ได้:", e);
                return false;
              }
            } else if (item.รูปแบบการแจ้งเตือน === 'ทุกเดือน') {
              // ตรวจสอบว่าวันที่ในเดือนนี้หรือเดือนหน้าจะถึงภายใน 7 วันหรือไม่
              const currentMonth = now.getMonth();
              const currentYear = now.getFullYear();
              const dayOfMonth = parseInt(item.วันที่ในเดือน);

              if (isNaN(dayOfMonth)) return false;

              // ตรวจสอบวันที่ในเดือนปัจจุบัน
              const dateThisMonth = new Date(currentYear, currentMonth, dayOfMonth);
              const dateThisMonthWithoutTime = new Date(dateThisMonth.getFullYear(), dateThisMonth.getMonth(), dateThisMonth.getDate());

              if (dateThisMonthWithoutTime >= todayWithoutTime && dateThisMonthWithoutTime <= nextWeekWithoutTime) return true;

              // ตรวจสอบวันที่ในเดือนถัดไป
              const dateNextMonth = new Date(currentYear, currentMonth + 1, dayOfMonth);
              const dateNextMonthWithoutTime = new Date(dateNextMonth.getFullYear(), dateNextMonth.getMonth(), dateNextMonth.getDate());
              return dateNextMonthWithoutTime <= nextWeekWithoutTime;
            } else if (item.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด') {
              // ตรวจสอบว่าระยะทางปัจจุบันใกล้ถึงเป้าหมายหรือไม่ (ภายใน 500 กม.)
              const targetMileage = parseFloat(item.ระยะทางเป้าหมาย);
              const currentMileage = parseFloat(item.ระยะทางปัจจุบัน);

              if (isNaN(targetMileage) || isNaN(currentMileage)) return false;

              return (targetMileage - currentMileage) <= 500;
            }

            return false;
          });

          // เรียงลำดับใหม่ตามความเร่งด่วนและวันที่
          this.upcomingMaintenance.sort((a, b) => {
            // 1. เรียงตามความเร่งด่วนก่อนเป็นอันดับแรก
            const aUrgent = this.isUrgent(a);
            const bUrgent = this.isUrgent(b);

            if (aUrgent && !bUrgent) return -1;
            if (!aUrgent && bUrgent) return 1;

            // 2. ถ้าความเร่งด่วนเท่ากัน ให้เรียงตามระยะเวลา

            // 2.1 รายการวันนี้มาก่อนเสมอ
            const aIsToday = this.formatAlertTime(a) === 'วันนี้';
            const bIsToday = this.formatAlertTime(b) === 'วันนี้';

            if (aIsToday && !bIsToday) return -1;
            if (!aIsToday && bIsToday) return 1;

            // 2.2 รายการพรุ่งนี้มาก่อนรายการที่ไกลกว่า
            const aIsTomorrow = this.formatAlertTime(a) === 'พรุ่งนี้';
            const bIsTomorrow = this.formatAlertTime(b) === 'พรุ่งนี้';

            if (aIsTomorrow && !bIsTomorrow && !bIsToday) return -1;
            if (!aIsTomorrow && bIsTomorrow && !aIsToday) return 1;

            // 2.3 สำหรับรายการที่มีจำนวนวัน ให้เรียงตามจำนวนวัน
            if (a.รูปแบบการแจ้งเตือน === 'ครั้งเดียว' && b.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
              try {
                // สร้างวัตถุ Date จากวันที่แจ้งเตือน
                let dateA = null, dateB = null;

                if (a.วันที่แจ้งเตือนแบบวัตถุ instanceof Date) {
                  dateA = a.วันที่แจ้งเตือนแบบวัตถุ;
                }

                if (b.วันที่แจ้งเตือนแบบวัตถุ instanceof Date) {
                  dateB = b.วันที่แจ้งเตือนแบบวัตถุ;
                }

                if (dateA && dateB) {
                  return dateA.getTime() - dateB.getTime();
                }
              } catch (e) {
                console.error("ไม่สามารถเปรียบเทียบวันที่ได้:", e);
              }
            }

            // 2.4 สำหรับรายการทุกเดือน ให้เรียงตามวันที่ในเดือน
            if (a.รูปแบบการแจ้งเตือน === 'ทุกเดือน' && b.รูปแบบการแจ้งเตือน === 'ทุกเดือน') {
              const dayA = parseInt(a.วันที่ในเดือน);
              const dayB = parseInt(b.วันที่ในเดือน);

              if (!isNaN(dayA) && !isNaN(dayB)) {
                return dayA - dayB;
              }
            }

            // 2.5 สำหรับรายการตามระยะทาง ให้เรียงตามระยะทางที่เหลือ
            if (a.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด' && b.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด') {
              const remainingA = a.ระยะทางเป้าหมาย - a.ระยะทางปัจจุบัน;
              const remainingB = b.ระยะทางเป้าหมาย - b.ระยะทางปัจจุบัน;

              return remainingA - remainingB;
            }

            // 3. ถ้ายังเทียบไม่ได้ ให้ใช้ประเภทการแจ้งเตือน
            return a.ประเภทการแจ้งเตือน.localeCompare(b.ประเภทการแจ้งเตือน);
          });
        },


        // ฟังก์ชันสำหรับจัดรูปแบบเวลาแจ้งเตือน (แก้ไขแล้ว)
        formatAlertTime(alert) {
          if (!alert) return '';

          const now = new Date();

          if (alert.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
            try {
              let alertDate;

              // แปลงวันที่เป็นรูปแบบมาตรฐาน
              if (typeof alert.วันที่แจ้งเตือน === 'string') {
                if (alert.วันที่แจ้งเตือน.includes('-')) {
                  // รูปแบบ YYYY-MM-DD
                  const parts = alert.วันที่แจ้งเตือน.split('-');
                  if (parts.length === 3) {
                    alertDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                  }
                } else if (alert.วันที่แจ้งเตือน.includes('/')) {
                  // แปลงจาก dd/mm/yyyy เป็น YYYY-MM-DD
                  const parts = alert.วันที่แจ้งเตือน.split('/');
                  if (parts.length === 3) {
                    alertDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                  }
                }
              } else if (alert.วันที่แจ้งเตือนแบบวัตถุ instanceof Date) {
                alertDate = alert.วันที่แจ้งเตือนแบบวัตถุ;
              } else if (alert.วันที่แจ้งเตือน instanceof Date) {
                alertDate = alert.วันที่แจ้งเตือน;
              }

              if (!alertDate || isNaN(alertDate.getTime())) {
                return alert.วันที่แจ้งเตือน || '-';
              }

              // ถ้าวันที่เดียวกัน
              if (alertDate.toDateString() === now.toDateString()) {
                return 'วันนี้';
              }

              // ถ้าวันพรุ่งนี้
              const tomorrow = new Date();
              tomorrow.setDate(now.getDate() + 1);
              if (alertDate.toDateString() === tomorrow.toDateString()) {
                return 'พรุ่งนี้';
              }

              // ถ้าเมื่อวาน
              const yesterday = new Date();
              yesterday.setDate(now.getDate() - 1);
              if (alertDate.toDateString() === yesterday.toDateString()) {
                return 'เมื่อวาน';
              }

              // คำนวณจำนวนวันที่เหลือ
              const diffTime = alertDate.getTime() - now.getTime();
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              if (diffDays > 0) {
                return `อีก ${diffDays} วัน`;
              } else if (diffDays < 0) {
                return `เลยกำหนด ${Math.abs(diffDays)} วัน`;
              }
            } catch (e) {
              console.error("ไม่สามารถแปลงวันที่ได้:", e);
              return alert.วันที่แจ้งเตือน || '-';
            }
          } else if (alert.รูปแบบการแจ้งเตือน === 'ทุกเดือน') {
            const dayOfMonth = parseInt(alert.วันที่ในเดือน);
            if (isNaN(dayOfMonth)) return '-';

            // สร้างวันที่จากวันที่ในเดือนปัจจุบัน โดยตัดเวลาออก
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentDay = now.getDate();

            // เปรียบเทียบโดยตรงกับวันที่ปัจจุบัน
            if (dayOfMonth === currentDay) {
              return 'วันนี้';
            } else if (dayOfMonth < currentDay) {
              // กรณีที่วันที่ในเดือนผ่านไปแล้ว
              return `เลยกำหนด ${currentDay - dayOfMonth} วัน`;
            } else {
              // กรณีที่วันที่ในเดือนยังมาไม่ถึง
              return `อีก ${dayOfMonth - currentDay} วัน`;
            }
          } else if (alert.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด') {
            const targetMileage = parseFloat(alert.ระยะทางเป้าหมาย);
            const currentMileage = parseFloat(alert.ระยะทางปัจจุบัน);

            if (isNaN(targetMileage) || isNaN(currentMileage)) return '-';

            if (currentMileage >= targetMileage) {
              const over = Math.round(currentMileage - targetMileage);
              return `เกินระยะ ${over} กม.`;
            }

            const remaining = Math.round(targetMileage - currentMileage);
            return `อีก ${remaining} กม.`;
          }

          return '-';
        },

        // ฟังก์ชันสำหรับรับวันที่ในรูปแบบ yyyy-mm-dd
        getThaiDate2() {
          const today = new Date();
          const year = today.getFullYear();
          const month = (today.getMonth() + 1).toString().padStart(2, '0');
          const day = today.getDate().toString().padStart(2, '0');
          return `${year}-${month}-${day}`;
        },

        // ฟังก์ชันตรวจสอบว่าการแจ้งเตือนเป็นแบบเร่งด่วนหรือไม่ (ปรับปรุงแล้ว)
        isUrgent(maintenance) {
          if (!maintenance) return false;

          const now = new Date();

          if (maintenance.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
            try {
              let alertDate;

              // รองรับเฉพาะรูปแบบวันที่ YYYY-MM-DD (มาตรฐาน)
              if (typeof maintenance.วันที่แจ้งเตือน === 'string') {
                if (maintenance.วันที่แจ้งเตือน.includes('-')) {
                  const parts = maintenance.วันที่แจ้งเตือน.split('-');
                  if (parts.length === 3) {
                    alertDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                  }
                } else if (maintenance.วันที่แจ้งเตือน.includes('/')) {
                  // แปลงจาก dd/mm/yyyy เป็น YYYY-MM-DD
                  const parts = maintenance.วันที่แจ้งเตือน.split('/');
                  if (parts.length === 3) {
                    alertDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                  }
                }
              } else if (maintenance.วันที่แจ้งเตือน instanceof Date) {
                alertDate = maintenance.วันที่แจ้งเตือน;
              }

              if (!alertDate || isNaN(alertDate.getTime())) {
                return false;
              }

              // ถ้าวันที่แจ้งเตือนผ่านไปแล้ว หรือเหลือไม่เกิน 2 วัน ถือว่าเร่งด่วน
              const twoDaysFromNow = new Date();
              twoDaysFromNow.setDate(now.getDate() + 2);
              return alertDate <= twoDaysFromNow;
            } catch (e) {
              console.error("ไม่สามารถแปลงวันที่ได้:", e);
              return false;
            }
          } else if (maintenance.รูปแบบการแจ้งเตือน === 'ทุกเดือน') {
            // ตรวจสอบว่าวันที่ในเดือนนี้จะถึงภายใน 2 วันหรือไม่ หรือผ่านไปแล้ว
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const dayOfMonth = parseInt(maintenance.วันที่ในเดือน);

            if (isNaN(dayOfMonth)) return false;

            // สร้างวันที่จากวันที่ในเดือนปัจจุบัน
            const dateThisMonth = new Date(currentYear, currentMonth, dayOfMonth);

            // ถ้าวันที่ผ่านไปแล้ว แต่ยังอยู่ในเดือนเดียวกัน หรือ เหลือไม่เกิน 2 วัน
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setDate(now.getDate() + 2);

            // เร่งด่วนถ้า: 1) วันที่ในเดือนนี้ผ่านไปแล้ว หรือ 2) จะถึงภายใน 2 วัน
            if (dateThisMonth < now && dateThisMonth.getMonth() === now.getMonth()) return true;
            return dateThisMonth <= twoDaysFromNow && dateThisMonth >= now;
          } else if (maintenance.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด') {
            // ตรวจสอบว่าระยะทางปัจจุบันใกล้ถึงหรือเกินเป้าหมายหรือไม่
            const targetMileage = parseFloat(maintenance.ระยะทางเป้าหมาย);
            const currentMileage = parseFloat(maintenance.ระยะทางปัจจุบัน);

            if (isNaN(targetMileage) || isNaN(currentMileage)) return false;

            // ถ้าระยะทางปัจจุบันเกินเป้าหมายหรือเหลือไม่เกิน 100 กม. ถือว่าเร่งด่วน
            return (targetMileage - currentMileage) <= 100 || currentMileage >= targetMileage;
          }

          return false;
        },

        // ฟังก์ชัน loadMaintenance ที่ปรับปรุงแล้ว
        loadMaintenance() {
          this.isLoading = true;
          // console.log("[Client] กำลังโหลดข้อมูลการแจ้งเตือน...");
          const sheetID = localStorage.getItem('sheetID') || '';
          // เคลียร์ข้อมูลเดิมเพื่อป้องกันการแสดงข้อมูลที่ไม่ถูกต้องหากเกิดข้อผิดพลาด
          this.maintenance = [];
          this.upcomingMaintenance = [];

          google.script.run
            .withSuccessHandler(result => {
              // console.log("[Debug] ได้รับข้อมูลจาก server:", result);

              if (result && result.success) {
                // ประมวลผลข้อมูลวันที่ให้ถูกต้อง
                if (result.data && Array.isArray(result.data)) {
                  result.data.forEach(item => {
                    // แปลงวันที่ให้เป็นรูปแบบมาตรฐาน YYYY-MM-DD
                    if (item.วันที่แจ้งเตือน && typeof item.วันที่แจ้งเตือน === 'string') {
                      // เก็บข้อมูลเดิมไว้เพื่อใช้ในการแสดงผล
                      item.วันที่แจ้งเตือนแบบข้อความ = item.วันที่แจ้งเตือน;

                      // แปลงเป็นรูปแบบมาตรฐาน YYYY-MM-DD
                      if (item.วันที่แจ้งเตือน.includes('/')) {
                        // แปลงจาก dd/mm/yyyy เป็น yyyy-mm-dd
                        const parts = item.วันที่แจ้งเตือน.split('/');
                        if (parts.length === 3) {
                          item.วันที่แจ้งเตือน = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        }
                      } else if (item.วันที่แจ้งเตือน.includes('T')) {
                        // ตัดเวลาออกจาก ISO date
                        item.วันที่แจ้งเตือน = item.วันที่แจ้งเตือน.split('T')[0];
                      }

                      // แปลงเป็นวัตถุ Date สำหรับการคำนวณ
                      try {
                        item.วันที่แจ้งเตือนแบบวัตถุ = new Date(item.วันที่แจ้งเตือน);
                      } catch (e) {
                        console.error(`[Client] ไม่สามารถแปลงวันที่ได้: ${item.วันที่แจ้งเตือน}`, e);
                      }
                    }

                    // แปลงค่าอื่นๆ ตามความจำเป็น
                    // แปลงตัวเลขที่เป็นสตริงเป็นตัวเลข
                    if (item.วันที่ในเดือน && typeof item.วันที่ในเดือน === 'string') {
                      item.วันที่ในเดือน = parseInt(item.วันที่ในเดือน);
                    }
                    if (item.ระยะทางเป้าหมาย && typeof item.ระยะทางเป้าหมาย === 'string') {
                      item.ระยะทางเป้าหมาย = parseFloat(item.ระยะทางเป้าหมาย);
                    }
                    if (item.ระยะทางปัจจุบัน && typeof item.ระยะทางปัจจุบัน === 'string') {
                      item.ระยะทางปัจจุบัน = parseFloat(item.ระยะทางปัจจุบัน);
                    }

                    // แปลงค่าบูลีน
                    if (item.ทำรายการแล้ว !== undefined) {
                      item.ทำรายการแล้ว = Boolean(item.ทำรายการแล้ว);
                    }
                  });
                }

                // บันทึกข้อมูลที่ได้
                this.maintenance = result.data || [];
                // console.log(`[Client] โหลดข้อมูลการแจ้งเตือนสำเร็จ ${this.maintenance.length} รายการ`);

                // กรองการแจ้งเตือนที่กำลังจะถึงและยังไม่ได้ทำเครื่องหมายว่าเสร็จสิ้น
                this.updateUpcomingMaintenance();
              } else {
                console.error("[Client] โหลดข้อมูลการแจ้งเตือนไม่สำเร็จ:", result ? result.message : "ไม่มีข้อมูลจากเซิร์ฟเวอร์");
                this.showNotification('โหลดข้อมูลการแจ้งเตือนไม่สำเร็จ: ' + (result && result.message ? result.message : "ไม่พบการตอบกลับจากเซิร์ฟเวอร์"), 'error');

                // เคลียร์ข้อมูลเพื่อป้องกันการแสดงข้อมูลที่ไม่ถูกต้อง
                this.maintenance = [];
                this.upcomingMaintenance = [];
              }

              this.isLoading = false;
            })
            .withFailureHandler(error => {
              console.error("[Client] เกิดข้อผิดพลาดในการโหลดข้อมูลการแจ้งเตือน:", error);

              // พยายามแสดงข้อความข้อผิดพลาดที่มีความหมาย
              let errorMessage = "ไม่พบการตอบกลับจากเซิร์ฟเวอร์";

              if (error) {
                if (typeof error === 'object') {
                  try {
                    errorMessage = JSON.stringify(error);
                  } catch (e) {
                    errorMessage = "เกิดข้อผิดพลาดที่ไม่สามารถแสดงรายละเอียดได้";
                  }
                } else if (typeof error === 'string') {
                  errorMessage = error;
                }
              }

              this.showNotification('โหลดข้อมูลการแจ้งเตือนไม่สำเร็จ: ' + errorMessage, 'error');

              // เคลียร์ข้อมูลเพื่อป้องกันการแสดงข้อมูลที่ไม่ถูกต้อง
              this.maintenance = [];
              this.upcomingMaintenance = [];
              this.isLoading = false;
            })
            .getAllMaintenance(sheetID);
        },

        // ฟังก์ชันแก้ไขการแจ้งเตือน (ปรับปรุงแล้ว) เปลี่ยนน้ำมันเครื่อง
        editMaintenance(maintenance) {
          this.maintenanceEditMode = true;
          this.maintenanceModalTitle = 'แก้ไขการแจ้งเตือน';
          this.isCustomMaintenanceType = !['จ่ายค่างวด', 'ต่อ พ.ร.บ.และภาษี', 'ต่อประกัน', 'เข้าศูนย์', 'สลับยาง', 'เปลี่ยนน้ำมันเครื่อง'].includes(maintenance.ประเภทการแจ้งเตือน);

          // คัดลอกข้อมูลสำหรับการแก้ไข
          this.currentMaintenance = JSON.parse(JSON.stringify(maintenance));

          // จัดการรูปแบบวันที่ให้เป็นมาตรฐาน YYYY-MM-DD
          if (maintenance.วันที่แจ้งเตือน && maintenance.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
            try {
              if (typeof maintenance.วันที่แจ้งเตือน === 'string') {
                if (maintenance.วันที่แจ้งเตือน.includes('/')) {
                  // แปลงจาก dd/mm/yyyy เป็น yyyy-mm-dd
                  const parts = maintenance.วันที่แจ้งเตือน.split('/');
                  if (parts.length === 3) {
                    this.currentMaintenance.วันที่แจ้งเตือน = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                  }
                } else if (maintenance.วันที่แจ้งเตือน.includes('T')) {
                  // แปลงจาก ISO datetime เป็น yyyy-mm-dd
                  this.currentMaintenance.วันที่แจ้งเตือน = maintenance.วันที่แจ้งเตือน.split('T')[0];
                }
              } else if (maintenance.วันที่แจ้งเตือน instanceof Date) {
                // แปลงจาก Date object เป็น yyyy-mm-dd
                const year = maintenance.วันที่แจ้งเตือน.getFullYear();
                const month = (maintenance.วันที่แจ้งเตือน.getMonth() + 1).toString().padStart(2, '0');
                const day = maintenance.วันที่แจ้งเตือน.getDate().toString().padStart(2, '0');
                this.currentMaintenance.วันที่แจ้งเตือน = `${year}-${month}-${day}`;
              }
            } catch (e) {
              console.error("ไม่สามารถแปลงวันที่ได้:", e);
              this.currentMaintenance.วันที่แจ้งเตือน = this.getThaiDate2();
            }
          }

          this.showMaintenanceModal = true;
        },

        // ฟังก์ชันบันทึกการแจ้งเตือน (ปรับปรุงแล้ว)
        saveMaintenance() {
          if (!this.validateMaintenanceForm()) {
            return;
          }

          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          const maintenanceData = { ...this.currentMaintenance };

          // ใช้รูปแบบวันที่มาตรฐาน YYYY-MM-DD
          maintenanceData.อัพเดตล่าสุด = this.getThaiDate2();

          if (this.maintenanceEditMode) {
            google.script.run
              .withSuccessHandler(result => {
                if (result && result.success) {
                  this.showNotification('อัพเดตการแจ้งเตือนสำเร็จ');
                  this.loadMaintenance();
                  this.closeMaintenanceModal();
                } else {
                  const errorMsg = result ? result.message || 'ไม่ทราบสาเหตุ' : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์';
                  this.showNotification('อัพเดตการแจ้งเตือนไม่สำเร็จ: ' + errorMsg, 'error');
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.showNotification('อัพเดตการแจ้งเตือนไม่สำเร็จ: ' + (error || 'ไม่ทราบสาเหตุ'), 'error');
                this.isLoading = false;
              })
              .updateMaintenance(maintenanceData.id, maintenanceData, sheetID);
          } else {
            maintenanceData.สร้างเมื่อ = this.getThaiDate2();

            google.script.run
              .withSuccessHandler(result => {
                if (result && result.success) {
                  this.showNotification('สร้างการแจ้งเตือนสำเร็จ');
                  this.loadMaintenance();
                  this.closeMaintenanceModal();
                } else {
                  const errorMsg = result ? result.message || 'ไม่ทราบสาเหตุ' : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์';
                  this.showNotification('สร้างการแจ้งเตือนไม่สำเร็จ: ' + errorMsg, 'error');
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.showNotification('สร้างการแจ้งเตือนไม่สำเร็จ: ' + (error || 'ไม่ทราบสาเหตุ'), 'error');
                this.isLoading = false;
              })
              .addNewMaintenance(maintenanceData, sheetID);
          }
        },

        // ฟังก์ชัน getLocalDateString ที่แปลงวันที่เป็นรูปแบบ YYYY-MM-DD
        getLocalDateString(date = new Date()) {
          const year = date.getFullYear();
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          return `${year}-${month}-${day}`;
        },

        // ฟังก์ชัน formatMaintenanceDate ที่ปรับปรุงแล้ว
        formatMaintenanceDate(item) {
          if (!item) return '-';

          const now = new Date();
          const currentDay = now.getDate();
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();

          if (item.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
            // ใช้เฉพาะรูปแบบ YYYY-MM-DD
            if (typeof item.วันที่แจ้งเตือน === 'string' && item.วันที่แจ้งเตือน.includes('-')) {
              const parts = item.วันที่แจ้งเตือน.split('-');
              if (parts.length === 3) {
                const alertDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                const isToday =
                  alertDate.getDate() === currentDay &&
                  alertDate.getMonth() === currentMonth &&
                  alertDate.getFullYear() === currentYear;
                const formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
                return isToday ? `${formattedDate} <span class="text-green-500">(ถึงกำหนดวันนี้)</span>` : formattedDate;
              }
            }
            return item.วันที่แจ้งเตือน || '-';
          } else if (item.รูปแบบการแจ้งเตือน === 'ทุกเดือน') {
            const day = parseInt(item.วันที่ในเดือน);
            if (isNaN(day)) return '-';

            const dueDateThisMonth = new Date(currentYear, currentMonth, day);
            const isToday =
              dueDateThisMonth.getDate() === currentDay &&
              dueDateThisMonth.getMonth() === currentMonth &&
              dueDateThisMonth.getFullYear() === currentYear;

            const formattedDate = `วันที่ ${day} ของทุกเดือน`;
            return isToday ? `${formattedDate} <span class="text-green-500">(ถึงกำหนดวันนี้)</span>` : formattedDate;
          } else if (item.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด') {
            const target = parseFloat(item.ระยะทางเป้าหมาย);
            const current = parseFloat(item.ระยะทางปัจจุบัน);

            if (isNaN(target) || isNaN(current)) return '-';

            const remaining = Math.max(0, Math.round(target - current));

            if (current >= target) {
              return `<span class="text-red-600 font-semibold">ถึงกำหนดแล้ว!</span>`;
            }

            return `${Math.round(current).toLocaleString()} / ${Math.round(target).toLocaleString()} กม.<br><span class="text-sm text-gray-500">เหลืออีก ${remaining.toLocaleString()} กม.</span>`;
          }

          return '-';
        },




        // ฟังก์ชันสำหรับเลือกไอคอนตามประเภทการแจ้งเตือน
        getMaintenanceIcon(type) {
          switch (type) {
            case 'จ่ายค่างวด':
              return 'fas fa-money-bill-wave';
            case 'ต่อ พ.ร.บ.และภาษี':
              return 'fas fa-file-invoice-dollar';
            case 'ต่อประกัน':
              return 'fas fa-shield-alt';
            case 'เข้าศูนย์':
              return 'fas fa-tools';
            case 'สลับยาง':
              return 'fas fa-sync-alt';
            case 'เปลี่ยนน้ำมันเครื่อง':
              return 'fas fa-oil-can';
            default:
              return 'fas fa-wrench';
          }
        },


        // คำนวณระยะเวลาที่เหลือก่อนถึงการบำรุงรักษา
        getRemainingTime(maintenance) {
          if (!maintenance) return { days: 0, isOverdue: false };

          const now = new Date();

          if (maintenance.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
            try {
              let alertDate;

              // ตรวจสอบรูปแบบวันที่ และแปลงให้เป็น Date
              if (typeof maintenance.วันที่แจ้งเตือน === 'string') {
                if (maintenance.วันที่แจ้งเตือน.includes('/')) {
                  // รูปแบบ dd/mm/yyyy
                  const parts = maintenance.วันที่แจ้งเตือน.split('/');
                  if (parts.length === 3) {
                    alertDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                  }
                } else if (maintenance.วันที่แจ้งเตือน.includes('-')) {
                  // รูปแบบ yyyy-mm-dd
                  const parts = maintenance.วันที่แจ้งเตือน.split('-');
                  if (parts.length === 3) {
                    alertDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                  }
                }
              } else if (maintenance.วันที่แจ้งเตือน instanceof Date) {
                alertDate = maintenance.วันที่แจ้งเตือน;
              }

              if (alertDate && !isNaN(alertDate.getTime())) {
                const diffTime = alertDate.getTime() - now.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return { days: Math.abs(diffDays), isOverdue: diffDays < 0 };
              }
            } catch (e) {
              console.error("ไม่สามารถคำนวณระยะเวลาได้:", e, maintenance);
            }
          } else if (maintenance.รูปแบบการแจ้งเตือน === 'ทุกเดือน') {
            const dayOfMonth = parseInt(maintenance.วันที่ในเดือน);
            if (!isNaN(dayOfMonth)) {
              const currentMonth = now.getMonth();
              const currentYear = now.getFullYear();
              const dateThisMonth = new Date(currentYear, currentMonth, dayOfMonth);

              // ถ้าวันที่ในเดือนนี้ผ่านไปแล้ว ให้คำนวณเป็นเวลาที่เลยมา
              if (dateThisMonth < now) {
                const diffTime = now.getTime() - dateThisMonth.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return { days: diffDays, isOverdue: true };
              }

              // คำนวณจำนวนวันที่เหลือในเดือนนี้
              const diffTime = dateThisMonth.getTime() - now.getTime();
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              return { days: diffDays, isOverdue: false };
            }
          } else if (maintenance.รูปแบบการแจ้งเตือน === 'ตามระยะทางที่กำหนด') {
            const targetMileage = parseFloat(maintenance.ระยะทางเป้าหมาย);
            const currentMileage = parseFloat(maintenance.ระยะทางปัจจุบัน);

            if (!isNaN(targetMileage) && !isNaN(currentMileage)) {
              if (currentMileage >= targetMileage) {
                return { kilometers: Math.round(currentMileage - targetMileage), isOverdue: true };
              }
              return { kilometers: Math.round(targetMileage - currentMileage), isOverdue: false };
            }
          }

          return { days: 0, isOverdue: false };
        },





        // กรองรายการแจ้งเตือนตามคำค้นหาและสถานะ
        get filteredMaintenance() {
          if (!this.maintenance || !Array.isArray(this.maintenance)) {
            return [];
          }

          let filteredList = this.maintenance;

          // กรองตามคำค้นหา
          if (this.maintenanceSearchQuery) {
            const query = this.maintenanceSearchQuery.toLowerCase();
            filteredList = filteredList.filter(item => {
              return (
                (item.รถ && item.รถ.toLowerCase().includes(query)) ||
                (item.ประเภทการแจ้งเตือน && item.ประเภทการแจ้งเตือน.toLowerCase().includes(query)) ||
                (item.หมายเหตุ && item.หมายเหตุ.toLowerCase().includes(query))
              );
            });
          }

          // กรองตามสถานะ
          if (this.maintenanceStatusFilter !== 'all') {
            filteredList = filteredList.filter(item => {
              if (this.maintenanceStatusFilter === 'active') {
                return !item.ทำรายการแล้ว;
              } else {
                return item.ทำรายการแล้ว;
              }
            });
          }

          // เรียงลำดับ: ด่วน -> กำลังจะถึง -> ปกติ -> เสร็จสิ้น
          return filteredList.sort((a, b) => {
            // รายการที่ยังไม่เสร็จสิ้นมาก่อน
            if (!a.ทำรายการแล้ว && b.ทำรายการแล้ว) return -1;
            if (a.ทำรายการแล้ว && !b.ทำรายการแล้ว) return 1;

            // ถ้าสถานะเหมือนกัน ให้รายการที่เร่งด่วนมาก่อน
            if (!a.ทำรายการแล้ว && !b.ทำรายการแล้ว) {
              const aUrgent = this.isUrgent(a);
              const bUrgent = this.isUrgent(b);

              if (aUrgent && !bUrgent) return -1;
              if (!aUrgent && bUrgent) return 1;
            }

            // ถ้ายังเรียงไม่ได้ให้เรียงตามวันที่แจ้งเตือน (สำหรับแบบครั้งเดียว)
            if (a.รูปแบบการแจ้งเตือน === 'ครั้งเดียว' && b.รูปแบบการแจ้งเตือน === 'ครั้งเดียว') {
              try {
                const partsA = a.วันที่แจ้งเตือน.split('/');
                const partsB = b.วันที่แจ้งเตือน.split('/');

                if (partsA.length === 3 && partsB.length === 3) {
                  const dateA = new Date(parseInt(partsA[2]), parseInt(partsA[1]) - 1, parseInt(partsA[0]));
                  const dateB = new Date(parseInt(partsB[2]), parseInt(partsB[1]) - 1, parseInt(partsB[0]));

                  return dateA - dateB;
                }
              } catch (e) {
                console.error("ไม่สามารถเปรียบเทียบวันที่ได้:", e);
              }
            }

            // เรียงตามประเภทการแจ้งเตือน
            return (a.ประเภทการแจ้งเตือน || '').localeCompare(b.ประเภทการแจ้งเตือน || '');
          });
        },


        get filteredCarMaintenance() {
          if (!this.maintenance || !Array.isArray(this.maintenance)) {
            return [];
          }

          let filteredList = this.maintenance;

          // คำค้นหา
          if (this.carMaintenanceSearchQuery) {
            const query = this.carMaintenanceSearchQuery.toLowerCase();
            filteredList = filteredList.filter(item => {
              return (
                (item.รถ && item.รถ.toLowerCase().includes(query)) ||
                (item.ประเภทการแจ้งเตือน && item.ประเภทการแจ้งเตือน.toLowerCase().includes(query)) ||
                (item.หมายเหตุ && item.หมายเหตุ.toLowerCase().includes(query))
              );
            });
          }

          // ฟิลเตอร์สถานะ
          if (this.carMaintenanceStatusFilter !== 'all') {
            filteredList = filteredList.filter(item => {
              const today = new Date();
              const targetMileage = item["ระยะทางเป้าหมาย"];
              const currentMileage = item["ระยะทางปัจจุบัน"];

              // ตรวจสอบการเลยกำหนดตามระยะทาง
              const isOverdueByMileage = item["รูปแบบการแจ้งเตือน"] === "ตามระยะทางที่กำหนด" &&
                currentMileage >= targetMileage &&
                !item.ทำรายการแล้ว;

              // ตรวจสอบการเลยกำหนดตามวันที่
              let isOverdueByDate = false;

              if (item["รูปแบบการแจ้งเตือน"] === "ครั้งเดียว" && item.วันที่แจ้งเตือน) {
                // แปลงวันที่แจ้งเตือนเป็นวัตถุ Date
                let alertDate;
                if (typeof item.วันที่แจ้งเตือน === 'string') {
                  if (item.วันที่แจ้งเตือน.includes('-')) {
                    // รูปแบบ YYYY-MM-DD
                    const parts = item.วันที่แจ้งเตือน.split('-');
                    if (parts.length === 3) {
                      alertDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    }
                  } else if (item.วันที่แจ้งเตือน.includes('/')) {
                    // รูปแบบ dd/mm/yyyy
                    const parts = item.วันที่แจ้งเตือน.split('/');
                    if (parts.length === 3) {
                      alertDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                    }
                  }
                } else if (item.วันที่แจ้งเตือนแบบวัตถุ instanceof Date) {
                  alertDate = item.วันที่แจ้งเตือนแบบวัตถุ;
                } else if (item.วันที่แจ้งเตือน instanceof Date) {
                  alertDate = item.วันที่แจ้งเตือน;
                }

                // ตัดเวลาออกจากวันที่ปัจจุบันและวันที่แจ้งเตือนเพื่อเปรียบเทียบเฉพาะวันที่
                const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                if (alertDate && !isNaN(alertDate.getTime())) {
                  const alertDateWithoutTime = new Date(alertDate.getFullYear(), alertDate.getMonth(), alertDate.getDate());
                  isOverdueByDate = alertDateWithoutTime < todayWithoutTime && !item.ทำรายการแล้ว;
                }
              } else if (item["รูปแบบการแจ้งเตือน"] === "ทุกเดือน" && item.วันที่ในเดือน) {
                // ตรวจสอบการเลยกำหนดสำหรับการแจ้งเตือนรายเดือน
                const dayOfMonth = parseInt(item.วันที่ในเดือน);
                if (!isNaN(dayOfMonth)) {
                  const currentDay = today.getDate();
                  isOverdueByDate = dayOfMonth < currentDay && !item.ทำรายการแล้ว;
                }
              }

              // รวมเงื่อนไขการเลยกำหนดทั้งหมด
              const isOverdue = isOverdueByMileage || isOverdueByDate;

              if (this.carMaintenanceStatusFilter === 'active') {
                return !item.ทำรายการแล้ว && !isOverdue;
              } else if (this.carMaintenanceStatusFilter === 'completed') {
                return item.ทำรายการแล้ว;
              } else if (this.carMaintenanceStatusFilter === 'overdue') {
                // เลือกกรองทั้งที่เลยกำหนดตามวันที่และระยะทาง
                return isOverdue;
              }

              return false;
            });
          }

          return filteredList;
        },

        isOverdue(item) {
          const today = new Date();
          const notifyDate = item["วันที่แจ้งเตือน"] ? new Date(item["วันที่แจ้งเตือน"]) : null;
          return notifyDate && notifyDate < today;
        },

        getStatusText(item) {
          const today = new Date();
          const currentDay = today.getDate();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();

          const targetMileage = item["ระยะทางเป้าหมาย"];
          const currentMileage = item["ระยะทางปัจจุบัน"];

          // ตรวจสอบสถานะเสร็จสิ้น
          if (item.ทำรายการแล้ว) {
            return "เสร็จสิ้น";
          }

          if (item["รูปแบบการแจ้งเตือน"] === "ตามระยะทางที่กำหนด") {
            if (currentMileage < targetMileage) {
              return "รอดำเนินการ";
            } else if (currentMileage >= targetMileage) {
              return "เลยกำหนด";
            }
          } else if (item["รูปแบบการแจ้งเตือน"] === "ครั้งเดียว") {
            const notifyDate = item["วันที่แจ้งเตือน"] ? new Date(item["วันที่แจ้งเตือน"]) : null;

            if (notifyDate) {
              const isToday =
                notifyDate.getDate() === currentDay &&
                notifyDate.getMonth() === currentMonth &&
                notifyDate.getFullYear() === currentYear;

              if (isToday) {
                return "รอดำเนินการ";
              } else if (this.isOverdue(item)) {
                return "เลยกำหนด";
              } else {
                return "รอดำเนินการ"; // สำหรับวันที่ในอนาคต
              }
            } else {
              return "รอดำเนินการ"; // กรณีไม่มีวันที่แจ้งเตือน
            }
          } else if (item["รูปแบบการแจ้งเตือน"] === "ทุกเดือน") {
            const dayOfMonth = parseInt(item["วันที่ในเดือน"]);

            if (!isNaN(dayOfMonth)) {
              const dueDateThisMonth = new Date(currentYear, currentMonth, dayOfMonth);

              const isToday =
                dueDateThisMonth.getDate() === currentDay &&
                dueDateThisMonth.getMonth() === currentMonth &&
                dueDateThisMonth.getFullYear() === currentYear;

              const isOverdueMonthly = dueDateThisMonth < today;

              if (isToday) {
                return "รอดำเนินการ";
              } else if (isOverdueMonthly) {
                return "เลยกำหนด";
              } else {
                return "รอดำเนินการ"; // สำหรับวันที่ในเดือนถัดไป หรือยังไม่ถึงของเดือนนี้
              }
            } else {
              return "รอดำเนินการ"; // กรณีไม่มีวันที่ในเดือน
            }
          }

          return "รอดำเนินการ"; // กรณีอื่นๆ
        },


        // ใช้ computed properties
        get completedCount() {
          if (!this.maintenance || !Array.isArray(this.maintenance)) {
            return 0;
          }
          return this.maintenance.filter(item => item.ทำรายการแล้ว).length;
        },

        get pendingCount() {
          if (!this.maintenance || !Array.isArray(this.maintenance)) {
            return 0;
          }
          return this.maintenance.filter(item => !item.ทำรายการแล้ว && !this.isOverdue(item)).length;
        },

        get overdueCount() {
          if (!this.maintenance || !Array.isArray(this.maintenance)) {
            return 0;
          }
          return this.maintenance.filter(item => !item.ทำรายการแล้ว && this.isOverdue(item)).length;
        },



        // ฟังก์ชั่นค้นหาใหม่

        // ฟังก์ชัน autocomplete
        getSuggestions() {
          if (!this.advancedSearchQuery || this.advancedSearchQuery.trim() === '') {
            this.searchSuggestions = [];
            this.showSuggestions = false;
            return;
          }

          const query = this.advancedSearchQuery.toUpperCase();
          this.showSuggestions = true;

          // ใช้ประวัติการค้นหาเป็นข้อเสนอแนะ
          this.searchSuggestions = this.searchHistory
            .filter(item => item.toUpperCase().includes(query))
            .slice(0, 5);
        },

        selectSuggestion(suggestion) {
          this.advancedSearchQuery = suggestion;
          this.showSuggestions = false;
          this.performAdvancedSearch();
        },

        handleKeyNavigation(event) {
          if (!this.showSuggestions) return;

          if (event.key === 'ArrowDown') {
            event.preventDefault();
            this.activeSuggestionIndex = Math.min(this.activeSuggestionIndex + 1, this.searchSuggestions.length - 1);
          } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            this.activeSuggestionIndex = Math.max(this.activeSuggestionIndex - 1, -1);
          } else if (event.key === 'Enter' && this.activeSuggestionIndex >= 0) {
            event.preventDefault();
            this.selectSuggestion(this.searchSuggestions[this.activeSuggestionIndex]);
          } else if (event.key === 'Escape') {
            this.showSuggestions = false;
          }
        },

        saveSearchToHistory() {
          const query = this.advancedSearchQuery.trim();
          if (query && !this.searchHistory.includes(query)) {
            this.searchHistory = [query, ...this.searchHistory].slice(0, 10); // เก็บ 10 รายการล่าสุด

            // บันทึกลงใน localStorage ถ้าต้องการเก็บข้อมูลถาวร
            if (typeof localStorage !== 'undefined') {
              localStorage.setItem('searchHistory', JSON.stringify(this.searchHistory));
            }
          }
        },

        loadSearchHistory() {
          if (typeof localStorage !== 'undefined') {
            const history = localStorage.getItem('searchHistory');
            if (history) {
              try {
                this.searchHistory = JSON.parse(history);
              } catch (e) {
                console.error('ไม่สามารถโหลดประวัติการค้นหาได้', e);
              }
            }
          }
        },

        // ฟังก์ชันไฮไลท์คำค้นหา
        highlightMatch(text, query) {
          if (!query || !text) return text;

          // แปลงเป็นข้อความเพื่อให้แน่ใจว่าเป็นสตริง
          const textStr = String(text);
          const queryStr = String(query).toUpperCase();

          // ตรวจสอบว่าข้อความมีคำค้นหาหรือไม่
          if (textStr.toUpperCase().includes(queryStr)) {
            // สร้าง regex ที่ไม่สนใจตัวพิมพ์ใหญ่เล็ก
            const regex = new RegExp(`(${this.escapeRegExp(queryStr)})`, 'gi');

            // แทนที่ด้วย span ที่มีการไฮไลท์
            const highlighted = textStr.replace(regex, '<span class="bg-yellow-200 font-semibold">$1</span>');

            // ส่งกลับเป็น HTML ที่ปลอดภัย
            return highlighted;
          }

          return text;
        },

        escapeRegExp(string) {
          return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        },

        // ปรับปรุงฟังก์ชันค้นหา
        performAdvancedSearch() {
          if (!this.advancedSearchQuery || this.advancedSearchQuery.trim() === '') {
            this.showNotification('กรุณาระบุคำค้นหา', 'warning');
            return;
          }

          this.advancedSearchQuery = this.advancedSearchQuery.toUpperCase();
          console.log('กำลังค้นหาด้วยคำค้นหา:', this.advancedSearchQuery);

          this.isSearching = true;
          this.isAdvancedSearchActive = true;
          this.searchStatus = 'searching';
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(resultStr => {
              let result;
              try {
                result = JSON.parse(resultStr);
              } catch (e) {
                console.error('ไม่สามารถแปลง JSON ได้:', e);
                this.showNotification('เกิดข้อผิดพลาดในการประมวลผลผลลัพธ์', 'error');
                this.isSearching = false;
                this.searchStatus = 'error';
                return;
              }

              if (result && result.success) {
                this.advancedSearchResults = result.data || [];
                // เก็บข้อมูลดิบสำหรับการกรอง
                this.rawSearchResults = [...this.advancedSearchResults];

                console.log('ผลการค้นหา:', this.advancedSearchResults);

                this.searchStatus = 'success';

                if (this.advancedSearchResults.length === 0) {
                  this.showNotificationForSearch(`ไม่พบข้อมูลที่ตรงกับคำค้นหา "${this.advancedSearchQuery}"`, 'info');
                } else {
                  this.showNotificationForSearch(`พบ ${this.advancedSearchResults.length} รายการที่ตรงกับคำค้นหา`, 'success');
                }
              } else {
                console.error('ผลการค้นหาผิดพลาด:', result);
                this.showNotification('เกิดข้อผิดพลาด: ' + (result?.message || 'ไม่ทราบสาเหตุ'), 'error');
                this.advancedSearchResults = [];
                this.searchStatus = 'error';
              }

              this.isSearching = false;
            })
            .withFailureHandler(error => {
              console.error('ข้อผิดพลาดในการค้นหา:', error);
              this.showNotification('เกิดข้อผิดพลาดในการค้นหา: ' + error, 'error');
              this.advancedSearchResults = [];
              this.isSearching = false;
              this.searchStatus = 'error';
            })
            .searchBookingsAdvanced(this.advancedSearchQuery.trim(), sheetID);
        },

        // ฟังก์ชันสำหรับค้นหาด้วยตัวกรองขั้นสูง
        performAdvancedFilterSearch() {
          this.isSearching = true;
          this.isAdvancedSearchActive = true;
          this.searchStatus = 'searching';

          console.log('กำลังค้นหาด้วยตัวกรองขั้นสูง:', this.advancedFilters);
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(resultStr => {
              let result;
              try {
                result = JSON.parse(resultStr);
              } catch (e) {
                console.error('ไม่สามารถแปลง JSON ได้:', e);
                this.showNotification('เกิดข้อผิดพลาดในการประมวลผลผลลัพธ์', 'error');
                this.isSearching = false;
                this.searchStatus = 'error';
                return;
              }

              if (result && result.success) {
                this.advancedSearchResults = result.data || [];
                this.rawSearchResults = [...this.advancedSearchResults];
                console.log('ผลการค้นหา:', this.advancedSearchResults);

                this.searchStatus = 'success';

                if (this.advancedSearchResults.length === 0) {
                  this.showNotificationForSearch('ไม่พบข้อมูลที่ตรงกับเงื่อนไขที่ระบุ', 'info');
                } else {
                  this.showNotificationForSearch(`พบ ${this.advancedSearchResults.length} รายการที่ตรงกับเงื่อนไข`, 'success');
                }
              } else {
                console.error('ผลการค้นหาผิดพลาด:', result);
                this.showNotification('เกิดข้อผิดพลาด: ' + (result?.message || 'ไม่ทราบสาเหตุ'), 'error');
                this.advancedSearchResults = [];
                this.searchStatus = 'error';
              }

              this.isSearching = false;
            })
            .withFailureHandler(error => {
              console.error('ข้อผิดพลาดในการค้นหา:', error);
              this.showNotification('เกิดข้อผิดพลาดในการค้นหา: ' + error, 'error');
              this.advancedSearchResults = [];
              this.isSearching = false;
              this.searchStatus = 'error';
            })
            .searchBookingsWithFilters(this.advancedFilters, sheetID);
        },

        resetAdvancedFilters() {
          this.advancedFilters = {
            customerInfo: '',
            carInfo: '',
            startDate: '',
            endDate: '',
            status: '',
            sortBy: 'date_desc'
          };
        },

        // ฟังก์ชันเรียงลำดับและกรอง
        sortResults(field) {
          // ถ้าคลิกที่ฟิลด์เดิม ให้สลับทิศทางการเรียง
          if (this.sortField === field) {
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            // ถ้าคลิกฟิลด์ใหม่ ให้ตั้งค่าฟิลด์ใหม่และเรียงจากน้อยไปมาก
            this.sortField = field;
            this.sortDirection = 'asc';
          }

          // สร้างเอฟเฟกต์ animation ขณะเรียงลำดับ
          this.isReordering = true;

          // เรียงลำดับข้อมูล
          this.advancedSearchResults = [...this.advancedSearchResults].sort((a, b) => {
            let valA = a[field];
            let valB = b[field];

            // กรณีพิเศษสำหรับวันที่
            if (field === 'วันที่เช่า') {
              valA = new Date(valA);
              valB = new Date(valB);
            }

            // กรณีเป็นตัวเลข
            if (!isNaN(valA) && !isNaN(valB)) {
              valA = Number(valA);
              valB = Number(valB);
            }

            // การเปรียบเทียบ
            if (valA < valB) return this.sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return this.sortDirection === 'asc' ? 1 : -1;
            return 0;
          });

          // ปิดเอฟเฟกต์ animation หลังจากเรียงลำดับเสร็จ
          setTimeout(() => {
            this.isReordering = false;
          }, 300);

          // แสดงการแจ้งเตือน
          this.showNotificationForSearch(`เรียงลำดับตาม ${field} ${this.sortDirection === 'asc' ? 'จากน้อยไปมาก' : 'จากมากไปน้อย'}`, 'info');
        },

        // ตัวกรองด่วน
        applyQuickFilters() {
          // ตรวจสอบว่ามีการใช้ตัวกรองหรือไม่
          const isAnyFilterActive = Object.values(this.quickFilters).some(val => val !== '');
          this.isQuickFilterActive = isAnyFilterActive;

          // ถ้าไม่มีการกรอง ให้แสดงผลลัพธ์ทั้งหมด
          if (!isAnyFilterActive) {
            this.advancedSearchResults = [...this.rawSearchResults];
            return;
          }

          // กรองผลลัพธ์
          this.advancedSearchResults = this.rawSearchResults.filter(item => {
            // ตรวจสอบทุกเงื่อนไขการกรอง
            return Object.entries(this.quickFilters).every(([field, filterValue]) => {
              // ถ้าไม่มีค่าตัวกรอง ให้ผ่านเงื่อนไขนี้
              if (!filterValue) return true;

              // ถ้าไม่มีค่าในฟิลด์นี้ ให้ไม่ผ่านเงื่อนไข
              if (!item[field]) return false;

              // กรณีพิเศษสำหรับวันที่
              if (field === 'วันที่เช่า') {
                const itemDate = new Date(item[field]);
                const filterDate = new Date(filterValue);

                // เปรียบเทียบเฉพาะวันที่ (ไม่รวมเวลา)
                return itemDate.toDateString() === filterDate.toDateString();
              }

              // กรองแบบปกติ (ค้นหาข้อความย่อย)
              return String(item[field]).toUpperCase().includes(String(filterValue).toUpperCase());
            });
          });

          // แสดงการแจ้งเตือน
          this.showNotificationForSearch(`กรองผลลัพธ์แล้ว ${this.advancedSearchResults.length} จาก ${this.rawSearchResults.length} รายการ`, 'info');
        },

        clearQuickFilters() {
          // รีเซ็ตค่าตัวกรอง
          Object.keys(this.quickFilters).forEach(key => {
            this.quickFilters[key] = '';
          });

          // แสดงผลลัพธ์ทั้งหมด
          this.advancedSearchResults = [...this.rawSearchResults];
          this.isQuickFilterActive = false;

          // แสดงการแจ้งเตือน
          this.showNotificationForSearch('ล้างตัวกรองแล้ว', 'info');
        },


        // แก้ไขฟังก์ชัน getCalendarDays()
        getCalendarDays() {
          try {
            const year = this.currentCalendarDate.getFullYear();
            const month = this.currentCalendarDate.getMonth();

            // วันแรกของเดือน
            const firstDay = new Date(year, month, 1);

            // วันสุดท้ายของเดือน
            const lastDay = new Date(year, month + 1, 0);

            // วันในสัปดาห์ของวันแรก (0 = อาทิตย์, 6 = เสาร์)
            const firstDayOfWeek = firstDay.getDay();

            // จำนวนวันในเดือน
            const daysInMonth = lastDay.getDate();

            // สร้างอาร์เรย์ของวันทั้งหมดที่จะแสดงในปฏิทิน
            const days = [];

            // วันจากเดือนก่อนหน้า
            const prevMonth = new Date(year, month, 0);
            const daysInPrevMonth = prevMonth.getDate();

            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
              const date = new Date(year, month - 1, daysInPrevMonth - i);
              days.push({
                date,
                isCurrentMonth: false
              });
            }

            // วันในเดือนปัจจุบัน
            for (let i = 1; i <= daysInMonth; i++) {
              const date = new Date(year, month, i);
              days.push({
                date,
                isCurrentMonth: true
              });
            }

            // คำนวณวันเพิ่มเติมที่ต้องการเพื่อให้ครบตาราง
            const remainingDays = 42 - days.length;

            // วันจากเดือนถัดไป
            for (let i = 1; i <= remainingDays; i++) {
              const date = new Date(year, month + 1, i);
              days.push({
                date,
                isCurrentMonth: false
              });
            }

            return days;
          } catch (e) {
            console.error('เกิดข้อผิดพลาดในการสร้างปฏิทิน:', e);
            return []; // คืนค่าเป็นอาร์เรย์ว่าง
          }
        },

        // แก้ไขฟังก์ชัน getRentalsOnDate()
        getRentalsOnDate(date) {
          // ตรวจสอบค่า date ที่รับเข้ามา
          if (!date || typeof date.getDate !== 'function') {
            return [];
          }

          // กรองรายการที่อยู่ในช่วงวันที่กำหนด
          return this.advancedSearchResults.filter(rental => {
            if (!rental.วันที่เช่า || !rental.วันที่คืน) {
              return false;
            }

            try {
              // แปลงข้อมูลวันที่เป็นวัตถุ Date
              const startDate = rental.วันที่เช่า instanceof Date ?
                rental.วันที่เช่า : new Date(rental.วันที่เช่า);

              const endDate = rental.วันที่คืน instanceof Date ?
                rental.วันที่คืน : new Date(rental.วันที่คืน);

              // ตรวจสอบความถูกต้องของวันที่
              if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return false;
              }

              // ปรับวันที่ให้ไม่มีเวลา
              const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
              const adjustedStartDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
              const adjustedEndDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

              // ตรวจสอบว่าวันที่ที่กำหนดอยู่ระหว่างวันที่เริ่มต้นและวันที่สิ้นสุด
              return adjustedStartDate <= checkDate && adjustedEndDate >= checkDate;
            } catch (e) {
              console.error('เกิดข้อผิดพลาดในการเปรียบเทียบวันที่:', e, rental);
              return false;
            }
          });
        },

        // แก้ไขฟังก์ชัน getRentalTimeOrStatus()
        getRentalTimeOrStatus(rental, date) {
          if (!rental.วันที่เช่า) return rental.รถ || 'ไม่ระบุ';
          if (!date || typeof date.getDate !== 'function') return rental.รถ || 'ไม่ระบุ';

          try {
            // แปลงวันที่เช่าให้เป็นวัตถุ Date
            const startDate = rental.วันที่เช่า instanceof Date ?
              rental.วันที่เช่า : new Date(rental.วันที่เช่า);

            // ตรวจสอบความถูกต้องของวันที่
            if (isNaN(startDate.getTime())) {
              return rental.รถ || 'ไม่ระบุ';
            }

            // เปรียบเทียบเฉพาะวันที่ (ไม่รวมเวลา)
            const isSameDate = (date1, date2) => {
              return date1.getDate() === date2.getDate() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getFullYear() === date2.getFullYear();
            };

            if (isSameDate(date, startDate)) {
              // ถ้าเป็นวันแรกของการเช่า
              return `${rental.เวลารับรถ || '00:00'} ${rental.รถ || 'ไม่ระบุ'}`;
            } else {
              // ถ้าเป็นวันอื่นๆ ในช่วงเช่า
              return rental.รถ || 'ไม่ระบุ';
            }
          } catch (e) {
            console.error('เกิดข้อผิดพลาดในการแสดงสถานะ:', e, rental);
            return rental.รถ || 'ไม่ระบุ';
          }
        },

        // แก้ไขฟังก์ชัน getActiveRentals()
        getActiveRentals() {
          const today = new Date();

          return this.advancedSearchResults.filter(rental => {
            if (!rental.วันที่เช่า || !rental.วันที่คืน) return false;

            try {
              // แปลงข้อมูลวันที่เป็นวัตถุ Date
              const startDate = rental.วันที่เช่า instanceof Date ?
                rental.วันที่เช่า : new Date(rental.วันที่เช่า);

              const endDate = rental.วันที่คืน instanceof Date ?
                rental.วันที่คืน : new Date(rental.วันที่คืน);

              // ตรวจสอบความถูกต้องของวันที่
              if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return false;
              }

              return startDate <= today && endDate >= today;
            } catch (e) {
              console.error('เกิดข้อผิดพลาดในการตรวจสอบการเช่าที่กำลังใช้งาน:', e, rental);
              return false;
            }
          });
        },

        // แก้ไขฟังก์ชัน getUpcomingRentals()
        getUpcomingRentals() {
          const today = new Date();

          return this.advancedSearchResults.filter(rental => {
            if (!rental.วันที่เช่า) return false;

            try {
              // แปลงข้อมูลวันที่เป็นวัตถุ Date
              const startDate = rental.วันที่เช่า instanceof Date ?
                rental.วันที่เช่า : new Date(rental.วันที่เช่า);

              // ตรวจสอบความถูกต้องของวันที่
              if (isNaN(startDate.getTime())) {
                return false;
              }

              return startDate > today;
            } catch (e) {
              console.error('เกิดข้อผิดพลาดในการตรวจสอบการเช่าที่กำลังจะมาถึง:', e, rental);
              return false;
            }
          });
        },

        // แก้ไขฟังก์ชัน getCompletedRentals()
        getCompletedRentals() {
          const today = new Date();

          return this.advancedSearchResults.filter(rental => {
            if (!rental.วันที่คืน) return false;

            try {
              // แปลงข้อมูลวันที่เป็นวัตถุ Date
              const endDate = rental.วันที่คืน instanceof Date ?
                rental.วันที่คืน : new Date(rental.วันที่คืน);

              // ตรวจสอบความถูกต้องของวันที่
              if (isNaN(endDate.getTime())) {
                return false;
              }

              return endDate < today;
            } catch (e) {
              console.error('เกิดข้อผิดพลาดในการตรวจสอบการเช่าที่เสร็จสิ้น:', e, rental);
              return false;
            }
          });
        },


        // ฟังก์ชันสำหรับแสดงข้อความสถานะการเช่า
        getRentalStatusText(bookingItem) {
          if (!bookingItem) return 'ไม่ระบุวันที่';
          if (!bookingItem.วันที่เช่า || !bookingItem.วันที่คืน) return 'ไม่ระบุวันที่';

          try {
            const today = new Date();
            const startDate = this.parseDateString(bookingItem.วันที่เช่า);
            const endDate = this.parseDateString(bookingItem.วันที่คืน);

            if (!startDate || !endDate) return 'ไม่ระบุวันที่';

            if (startDate <= today && endDate >= today) {
              const daysLeft = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
              return `กำลังใช้งาน (อีก ${daysLeft} วัน)`;
            } else if (startDate > today) {
              const daysToStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
              return `อีก ${daysToStart} วัน`;
            } else {
              return 'เสร็จสิ้นแล้ว';
            }
          } catch (e) {
            console.error('เกิดข้อผิดพลาดในการแสดงข้อความสถานะ:', e);
            return 'ไม่ระบุวันที่';
          }
        },

        // เรียงลำดับการเช่าตามวันที่
        getSortedRentalsByDate() {
          // ตรวจสอบว่ามีฟังก์ชัน getCurrentViewResults หรือไม่
          let resultsToSort = [];

          // ถ้ามีฟังก์ชัน getCurrentViewResults
          if (typeof this.getCurrentViewResults === 'function') {
            resultsToSort = this.getCurrentViewResults();
          }
          // ถ้าไม่มีให้ใช้ advancedSearchResults โดยตรง
          else if (this.advancedSearchResults && this.advancedSearchResults.length > 0) {
            // คัดกรองตาม currentView ถ้ามี
            if (this.currentView === 'active') {
              resultsToSort = this.advancedSearchResults.filter(item => this.isActiveRental(item));
            } else if (this.currentView === 'upcoming') {
              resultsToSort = this.advancedSearchResults.filter(item => this.isUpcomingRental(item));
            } else if (this.currentView === 'completed') {
              resultsToSort = this.advancedSearchResults.filter(item => this.isCompletedRental(item));
            } else {
              resultsToSort = [...this.advancedSearchResults];
            }
          }

          // เรียงลำดับตามวันที่เช่า
          return [...resultsToSort].sort((a, b) => {
            try {
              const dateA = this.parseDateString(a.วันที่เช่า);
              const dateB = this.parseDateString(b.วันที่เช่า);

              if (!dateA || !dateB) return 0;

              return dateA - dateB;
            } catch (e) {
              console.error('เกิดข้อผิดพลาดในการเรียงลำดับ:', e);
              return 0;
            }
          });
        },

        // ฟังก์ชันดึงรายการตามมุมมอง (ถ้ายังไม่มี)
        getCurrentViewResults() {
          if (this.currentView === 'active') {
            return this.advancedSearchResults.filter(item => this.isActiveRental(item));
          } else if (this.currentView === 'upcoming') {
            return this.advancedSearchResults.filter(item => this.isUpcomingRental(item));
          } else if (this.currentView === 'completed') {
            return this.advancedSearchResults.filter(item => this.isCompletedRental(item));
          }

          return this.advancedSearchResults;
        },


        calculateRentalDaysForDisplay(bookingItem) {
          return this.calculateRentalDaysForTimeline(bookingItem) + ' วัน';
        },


        calculateRentalDaysForTimeline(bookingItem) {
          if (!bookingItem) return 0;
          if (!bookingItem.วันที่เช่า || !bookingItem.วันที่คืน) {
            return 0;
          }

          try {
            // แปลงวันที่ตามรูปแบบที่ได้รับ
            let startDateStr = bookingItem.วันที่เช่า;
            let endDateStr = bookingItem.วันที่คืน;

            // ถ้าเป็นวันที่ในรูปแบบ dd/MM/yyyy ให้แปลงเป็น yyyy-MM-dd
            if (typeof startDateStr === 'string' && startDateStr.includes('/')) {
              const startParts = startDateStr.split('/');
              if (startParts.length === 3) {
                startDateStr = `${startParts[2]}-${startParts[1]}-${startParts[0]}`;
              }
            }

            if (typeof endDateStr === 'string' && endDateStr.includes('/')) {
              const endParts = endDateStr.split('/');
              if (endParts.length === 3) {
                endDateStr = `${endParts[2]}-${endParts[1]}-${endParts[0]}`;
              }
            }

            // ถ้ามีข้อมูลเวลาและฟังก์ชัน calculateRentalDaysWithHours
            if (typeof this.calculateRentalDaysWithHours === 'function' &&
              bookingItem.เวลารับรถ && bookingItem.เวลาคืนรถ) {
              const rentalInfo = this.calculateRentalDaysWithHours(
                startDateStr,
                endDateStr,
                bookingItem.เวลารับรถ,
                bookingItem.เวลาคืนรถ
              );
              return rentalInfo.days || 1;
            }

            // คำนวณแบบไม่มีเวลา
            const startDate = this.parseDateString(startDateStr);
            const endDate = this.parseDateString(endDateStr);

            if (!startDate || !endDate) return 1;

            // คำนวณจำนวนวัน
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays || 1; // ถ้าได้ 0 ให้คืนค่า 1 วัน
          } catch (e) {
            console.error('เกิดข้อผิดพลาดในการคำนวณจำนวนวัน:', e);
            return 1; // คืนค่า 1 วันเป็นค่าเริ่มต้น
          }
        },


        // ฟังก์ชันตรวจสอบสถานะการเช่า
        isActiveRental(bookingItem) {
          if (!bookingItem) return false;
          if (!bookingItem.วันที่เช่า || !bookingItem.วันที่คืน) return false;

          try {
            const today = new Date();
            const startDate = this.parseDateString(bookingItem.วันที่เช่า);
            const endDate = this.parseDateString(bookingItem.วันที่คืน);

            if (!startDate || !endDate) return false;

            return startDate <= today && endDate >= today;
          } catch (e) {
            console.error('เกิดข้อผิดพลาด:', e);
            return false;
          }
        },

        isUpcomingRental(bookingItem) {
          if (!bookingItem) return false;
          if (!bookingItem.วันที่เช่า) return false;

          try {
            const today = new Date();
            const startDate = this.parseDateString(bookingItem.วันที่เช่า);

            if (!startDate) return false;

            return startDate > today;
          } catch (e) {
            console.error('เกิดข้อผิดพลาด:', e);
            return false;
          }
        },

        isCompletedRental(bookingItem) {
          if (!bookingItem) return false;
          if (!bookingItem.วันที่คืน) return false;

          try {
            const today = new Date();
            const endDate = this.parseDateString(bookingItem.วันที่คืน);

            if (!endDate) return false;

            return endDate < today;
          } catch (e) {
            console.error('เกิดข้อผิดพลาด:', e);
            return false;
          }
        },



        renderBookingForecastChart() {
          const chartEl = document.getElementById('bookingForecastChart');
          if (!chartEl) return;

          // ทำลายกราฟเก่าทิ้งก่อนวาดใหม่
          if (this.bookingForecastChartInstance) {
            this.bookingForecastChartInstance.destroy();
          }

          const options = {
            series: [{
              name: 'จำนวนรถที่ถูกจอง',
              data: this.bookingForecastData.map(item => item.count) // ดึงข้อมูลจำนวนรถ
            }],
            chart: {
              type: 'bar',
              height: 250,
              toolbar: { show: false }
            },
            plotOptions: {
              bar: {
                borderRadius: 4,
                dataLabels: { position: 'top' },
              }
            },
            dataLabels: {
              enabled: true,
              offsetY: -20,
              style: {
                fontSize: '12px',
                colors: ["#304758"]
              }
            },
            xaxis: {
              categories: this.bookingForecastData.map(item => item.date || item.label || ''),
              labels: {
                formatter: function (value) {
                  // ในจอเล็ก (< 640px) แสดงแค่วันที่ เช่น "1 ม.ค." -> "1"
                  if (window.innerWidth < 640) {
                    return value.split(' ')[0]; // แยกเอาแค่เลขวันที่
                  }
                  return value; // จอใหญ่แสดงเต็ม
                },
                style: {
                  fontFamily: 'Prompt, sans-serif'
                }
              }
            },
            yaxis: {
              title: { text: 'จำนวนรถ (คัน)' },
              min: 0,
              tickAmount: 3, // จะแสดง 0, 1, 2, 3
              labels: {
                formatter: (val) => { return parseInt(val) },
                style: {
                  fontFamily: 'Prompt, sans-serif'
                }
              }
            },
            colors: ['#3b82f6'], // สีน้ำเงิน
            tooltip: {
              y: {
                formatter: (val) => { return val + " คัน" }
              }
            }
          };

          this.bookingForecastChartInstance = new ApexCharts(chartEl, options);
          this.bookingForecastChartInstance.render();
        },


        getRentalStatusClass(rental) {
          if (!rental.วันที่เช่า || !rental.วันที่คืน) return 'border-gray-200 bg-gray-50';

          const today = new Date();
          const startDate = new Date(rental.วันที่เช่า);
          const endDate = new Date(rental.วันที่คืน);

          if (startDate <= today && endDate >= today) {
            return 'border-green-200 bg-green-50'; // กำลังใช้งาน
          } else if (startDate > today) {
            return 'border-blue-200 bg-blue-50'; // กำลังจะมาถึง
          } else {
            return 'border-gray-200 bg-gray-50'; // เสร็จสิ้นแล้ว
          }
        },

        getRentalStatusDotClass(rental) {
          if (!rental.วันที่เช่า || !rental.วันที่คืน) return 'bg-gray-500';

          const today = new Date();
          const startDate = new Date(rental.วันที่เช่า);
          const endDate = new Date(rental.วันที่คืน);

          if (startDate <= today && endDate >= today) {
            return 'bg-green-500'; // กำลังใช้งาน
          } else if (startDate > today) {
            return 'bg-blue-500'; // กำลังจะมาถึง
          } else {
            return 'bg-gray-500'; // เสร็จสิ้นแล้ว
          }
        },

        getRentalStatusTextClass(rental) {
          if (!rental.วันที่เช่า || !rental.วันที่คืน) return 'text-gray-600';

          const today = new Date();
          const startDate = new Date(rental.วันที่เช่า);
          const endDate = new Date(rental.วันที่คืน);

          if (startDate <= today && endDate >= today) {
            return 'text-green-600'; // กำลังใช้งาน
          } else if (startDate > today) {
            return 'text-blue-600'; // กำลังจะมาถึง
          } else {
            return 'text-gray-600'; // เสร็จสิ้นแล้ว
          }
        },


        parseDateString(dateStr) {
          if (!dateStr) return null;

          // ถ้าเป็น Date object อยู่แล้ว
          if (dateStr instanceof Date) return dateStr;

          try {
            // ลองแปลงตรงๆ
            const date = new Date(dateStr);

            // ตรวจสอบว่าเป็นวันที่ที่ถูกต้อง
            if (!isNaN(date.getTime())) {
              return date;
            }

            // ถ้าเป็นรูปแบบ dd/MM/yyyy
            if (dateStr.includes('/')) {
              const parts = dateStr.split('/');
              if (parts.length === 3) {
                // วันที่ไทยใช้รูปแบบ dd/MM/yyyy
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // เดือนใน JavaScript เริ่มจาก 0
                const year = parseInt(parts[2], 10);

                const newDate = new Date(year, month, day);
                if (!isNaN(newDate.getTime())) {
                  return newDate;
                }
              }
            }

            // ถ้าเป็นรูปแบบ yyyy-MM-dd
            if (dateStr.includes('-')) {
              const parts = dateStr.split('-');
              if (parts.length === 3) {
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // เดือนใน JavaScript เริ่มจาก 0
                const day = parseInt(parts[2], 10);

                const newDate = new Date(year, month, day);
                if (!isNaN(newDate.getTime())) {
                  return newDate;
                }
              }
            }

            // ยังไม่สามารถแปลงได้
            console.error('ไม่สามารถแปลงวันที่: ' + dateStr);
            return null;
          } catch (e) {
            console.error('เกิดข้อผิดพลาดในการแปลงวันที่:', e, dateStr);
            return null;
          }
        },


        // ฟังก์ชันสำหรับปฏิทิน
        formatMonthYear(date) {
          return date.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
        },

        prevMonth() {
          const date = new Date(this.currentCalendarDate);
          date.setMonth(date.getMonth() - 1);
          this.currentCalendarDate = date;
        },

        nextMonth() {
          const date = new Date(this.currentCalendarDate);
          date.setMonth(date.getMonth() + 1);
          this.currentCalendarDate = date;
        },



        isToday(date) {
          if (!date || typeof date.getDate !== 'function') {
            // ถ้า date ไม่ใช่ Date object ที่ถูกต้อง
            return false;
          }

          const today = new Date();
          return date.getDate() === today.getDate() &&
            date.getMonth() === today.getMonth() &&
            date.getFullYear() === today.getFullYear();
        },


        scrollToResultsAfterSearch() {
          // รอให้การค้นหาเสร็จและผลลัพธ์ถูกแสดงออกมาก่อน
          setTimeout(() => {
            const resultsElement = document.getElementById('searchResults');
            if (resultsElement) {
              // เลื่อนไปที่ส่วนผลการค้นหา
              resultsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 500); // รอ 500ms เพื่อให้แน่ใจว่า DOM ได้อัพเดทแล้ว
        },

        clearCustomerSearchResults() {
          this.customerSearchResults = [];
        },



        showNotificationForSearch(message, type = 'info') {
          // ใช้การแจ้งเตือนแบบไม่รบกวน แทนที่ swal.fire
          // เช่น แสดงข้อความเล็กๆ ด้านล่าง หรือ toast notification

          // ตัวอย่างแบบง่าย:
          const notificationElement = document.getElementById('search-notification');
          if (notificationElement) {
            notificationElement.textContent = message;
            notificationElement.className = `notification notification-${type}`;
            notificationElement.style.display = 'block';

            // ซ่อนการแจ้งเตือนหลังจาก 3 วินาที
            setTimeout(() => {
              notificationElement.style.display = 'none';
            }, 3000);
          }

          // ถ้าต้องการใช้ SweetAlert แต่ไม่รบกวนการพิมพ์
          // ให้แสดงเฉพาะเมื่อจำเป็นจริงๆ เท่านั้น เช่น มีข้อผิดพลาดสำคัญ
          if (type === 'error') {
            Swal.fire({
              title: 'เกิดข้อผิดพลาด',
              text: message,
              icon: 'error',
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000
            });
          }
        },


        // เพิ่มฟังก์ชัน handleFilterInput แทนที่จะเรียก applyQuickFilters โดยตรง
        handleFilterInput(field, event) {
          // ยกเลิก timeout เดิม (ถ้ามี)
          if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
          }

          // รอ 500ms ก่อนทำการค้นหา
          this.searchTimeout = setTimeout(() => {
            // ตรวจสอบความยาวของข้อความ
            if (event.target.value.length >= 2 || event.target.value.length === 0) {
              this.applyQuickFilters();
            }
          }, 500);
        },



        getRentalCalendarClass(rental) {
          if (!rental.วันที่เช่า || !rental.วันที่คืน) return 'bg-gray-200 text-gray-800';

          const today = new Date();
          const startDate = new Date(rental.วันที่เช่า);
          const endDate = new Date(rental.วันที่คืน);

          if (startDate <= today && endDate >= today) {
            return 'bg-green-200 text-green-800'; // กำลังใช้งาน
          } else if (startDate > today) {
            return 'bg-blue-200 text-blue-800'; // กำลังจะมาถึง
          } else {
            return 'bg-gray-200 text-gray-800'; // เสร็จสิ้นแล้ว
          }
        },


        // ค้นหารถว่าง


        loadInitialCars() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          // Call the Google Apps Script function to get all cars
          google.script.run
            .withSuccessHandler((cars) => {
              this.allCars = cars;
              this.isLoading = false;
            })
            .withFailureHandler((error) => {
              console.error('Error loading cars:', error);
              this.isLoading = false;
              this.showToastMessage('เกิดข้อผิดพลาด: ' + error);
            })
            .getAvailableCars(sheetID);
        },

        searchAvailableCars() {
          // Validate inputs
          if (!this.pickupDate || !this.pickupTime || !this.returnDate || !this.returnTime) {
            this.showToastMessage('กรุณากรอกข้อมูลให้ครบถ้วน');
            return;
          }

          // Validate dates
          const pickupDateTime = new Date(this.pickupDate + 'T' + this.pickupTime + ':00');
          const returnDateTime = new Date(this.returnDate + 'T' + this.returnTime + ':00');

          if (returnDateTime <= pickupDateTime) {
            this.showToastMessage('วันที่และเวลาคืนรถต้องมากกว่าวันที่และเวลารับรถ');
            return;
          }

          this.isLoading = true;
          this.searchPerformed = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          // Call the Google Apps Script function
          google.script.run
            .withSuccessHandler((result) => {
              this.availableCars = result.availableCars;
              this.isLoading = false;

              // Reset filters when new search is performed
              this.brandFilter = '';
              this.modelFilter = '';
            })
            .withFailureHandler((error) => {
              console.error('Error searching cars:', error);
              this.isLoading = false;
              this.showToastMessage('เกิดข้อผิดพลาด: ' + error);
            })
            .findAvailableCars(
              this.pickupDate,
              this.pickupTime,
              this.returnDate,
              this.returnTime,
              parseInt(this.prepTime),
              sheetID
            );
        },

        copySummary() {
          const summary = this.generateSummaryText();

          // Use the Clipboard API
          navigator.clipboard.writeText(summary)
            .then(() => {
              this.showToastMessage('คัดลอกข้อความสรุปเรียบร้อยแล้ว');
            })
            .catch((error) => {
              console.error('Error copying to clipboard:', error);
              this.showToastMessage('ไม่สามารถคัดลอกข้อความ: ' + error);

              // Fallback for browsers that don't support clipboard API
              this.copyToClipboardFallback(summary);
            });
        },

        copyToClipboardFallback(text) {
          // Create a temporary textarea element
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = 0;
          document.body.appendChild(textarea);

          // Select and copy the text
          textarea.select();

          try {
            const successful = document.execCommand('copy');
            if (successful) {
              this.showToastMessage('คัดลอกข้อความสรุปเรียบร้อยแล้ว');
            } else {
              this.showToastMessage('ไม่สามารถคัดลอกข้อความ');
            }
          } catch (err) {
            console.error('Fallback: Error copying text to clipboard', err);
            this.showToastMessage('ไม่สามารถคัดลอกข้อความ');
          }

          // Remove the temporary element
          document.body.removeChild(textarea);
        },

        // generateSummaryText() {
        //   // Create a summary of available cars
        //   const cars = this.filteredCars;

        //   let summary = `?? รายงานสรุปรถว่าง ??\n`;
        //   summary += `?? วันที่และเวลาที่ค้นหา: ${new Date().toLocaleString('th-TH')}\n\n`;

        //   summary += `?? ช่วงเวลาที่ค้นหา:\n`;
        //   summary += `?? วันรับรถ: ${this.formatDateTime(this.pickupDate, this.pickupTime)}\n`;
        //   summary += `?? วันคืนรถ: ${this.formatDateTime(this.returnDate, this.returnTime)}\n`;
        //   summary += `?? ระยะเวลาเตรียมรถ: ${this.formatPrepTime(this.prepTime)}\n\n`;

        //   summary += `?? พบรถว่างทั้งหมด ${cars.length} คัน\n\n`;

        //   if (cars.length > 0) {
        //     summary += `?? รายชื่อรถที่ว่าง:\n`;

        //     cars.forEach((car, index) => {
        //       summary += `${index + 1}. ${car.ยี่ห้อ} ${car.รุ่น} (${car.ทะเบียน}) สี${car.สี} - ${this.formatCurrency(car.ราคาเช่าต่อวัน)}/วัน\n`;
        //     });
        //   } else {
        //     summary += `? ไม่พบรถว่างตามเงื่อนไขที่กำหนด\n`;
        //   }

        //   return summary;
        // },


        generateSummaryText() {
          const cars = this.filteredCars; // Use filtered cars for the list

          let summary = `🚘 รายงานสรุปรถว่าง 🚘\n`;
          summary += `📅 วันที่สร้าง: ${new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}\n\n`; // Use Thai locale and timezone

          summary += `🔍 ช่วงเวลาที่ค้นหา\n\n`;
          summary += `➡️ วันรับรถ: ${this.formatDateTime(this.pickupDate, this.pickupTime)}\n`;
          summary += `⬅️ วันคืนรถ: ${this.formatDateTime(this.returnDate, this.returnTime)}\n`;
          summary += `⏱️ ระยะเวลาเตรียมรถ: ${this.formatPrepTime(this.prepTime)}\n\n`;

          summary += `🚘 รายการรถว่างทั้งหมด ${this.availableCars.length} คัน\n`; // Show total found before filtering

          if (this.brandFilter || this.modelFilter) {
            summary += `✅ กรองผลลัพธ์เหลือ ${cars.length} คัน\n`;
            if (this.brandFilter) summary += `   - ยี่ห้อ: ${this.brandFilter}\n`;
            if (this.modelFilter) summary += `   - รุ่น: ${this.modelFilter}\n`;
            summary += '\n';
          } else if (this.availableCars.length > 0) {
            summary += `\n`; // Add newline if no filters applied but cars found
          }


          if (cars.length > 0) {
            summary += `🎉 รายการรถที่กรองแล้ว\n`;
            cars.forEach((car, index) => {
              summary += `${index + 1}. ${car.ยี่ห้อ} ${car.รุ่น} (${car.ทะเบียน}) สี${car.สี} - ${this.formatCurrency(car.ราคาเช่าต่อวัน)}/วัน\n`;
            });
          } else if (this.availableCars.length > 0 && cars.length === 0) {
            summary += `❌ ไม่มีรถที่ตรงกับตัวกรอง (${this.brandFilter ? 'ยี่ห้อ: ' + this.brandFilter : ''} ${this.modelFilter ? 'รุ่น: ' + this.modelFilter : ''})\n`;
          }
          else {
            summary += `❌ ไม่พบรถว่างตามเงื่อนไขในช่วงเวลาที่ระบุ\n`;
          }

          return summary.trim(); // Trim trailing whitespace
        },


        showToastMessage(message) {
          this.toastMessage = message;
          this.showToast = true;

          // Auto-hide toast after 3 seconds
          setTimeout(() => {
            this.showToast = false;
          }, 3000);
        },

        formatDateTime(date, time) {
          if (!date || !time) return '';

          try {
            const dateObj = new Date(date + 'T' + time);
            return dateObj.toLocaleString('th-TH', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (e) {
            console.error('Error formatting date time:', e);
            return date + ' ' + time;
          }
        },

        formatCurrency(value) {
          if (!value) return '฿0';
          return '฿' + parseInt(value).toLocaleString('th-TH');
        },

        formatPrepTime(minutes) {
          const mins = parseInt(minutes);
          if (mins === 0) return 'ไม่มี';
          if (mins < 60) return `${mins} นาที`;
          return `${mins / 60} ชั่วโมง`;
        },

        // Computed properties
        get brands() {
          const uniqueBrands = [...new Set(
            this.availableCars.map(car => car.ยี่ห้อ ? String(car.ยี่ห้อ).trim() : '')
          )];
          const nonEmptyBrands = uniqueBrands.filter(brand => brand.length > 0);
          return nonEmptyBrands.sort();
        },

        get filteredModels() {
          // Using Option 2: Show all models if no brand selected
          let modelsToProcess = [];
          if (!this.brandFilter) {
            modelsToProcess = this.availableCars.map(car => car.รุ่น ? String(car.รุ่น).trim() : '');
          } else {
            modelsToProcess = this.availableCars
              .filter(car => car.ยี่ห้อ && String(car.ยี่ห้อ).trim() === this.brandFilter)
              .map(car => car.รุ่น ? String(car.รุ่น).trim() : '');
          }
          const uniqueModelsSet = new Set(modelsToProcess);
          const uniqueModelsArray = [...uniqueModelsSet].filter(model => model.length > 0);
          return uniqueModelsArray.sort();
        },

        get filteredCars() {
          return this.availableCars.filter(car => {
            const carBrandTrimmed = car.ยี่ห้อ ? String(car.ยี่ห้อ).trim() : '';
            if (this.brandFilter && carBrandTrimmed !== this.brandFilter) {
              return false;
            }

            const carModelTrimmed = car.รุ่น ? String(car.รุ่น).trim() : '';
            if (this.modelFilter && carModelTrimmed !== this.modelFilter) {
              return false;
            }

            const carTypeTrimmed = car.ประเภท ? String(car.ประเภท).trim() : '';
            if (this.typeFilter && carTypeTrimmed !== this.typeFilter) {
              return false;
            }

            return true;
          });
        },




        get carTypes() {
          const uniqueTypes = [...new Set(
            this.availableCars.map(car => car.ประเภท ? String(car.ประเภท).trim() : '')
          )];
          const nonEmptyTypes = uniqueTypes.filter(type => type.length > 0);
          return nonEmptyTypes.sort();
        },

        async shareSummary() {
          const summary = this.generateSummaryText();
          if (navigator.share) {
            try {
              await navigator.share({
                title: 'รายงานสรุปรถว่าง',
                text: summary,
              });
              this.showToastMessage('แชร์ข้อความสรุปเรียบร้อยแล้ว');
            } catch (err) {
              console.error('Error sharing:', err);
              this.showToastMessage('ไม่สามารถแชร์ข้อความ: ' + err.message);
            }
          } else {
            this.showToastMessage('อุปกรณ์ไม่รองรับฟีเจอร์แชร์');
          }
        },




        parseTimeString(timeStr) {
          if (!timeStr) return new Date(0); // ค่าเริ่มต้นถ้าไม่มีเวลา

          try {
            // ถ้าเป็นรูปแบบ HH:MM
            if (timeStr.includes(':')) {
              const [hours, minutes] = timeStr.split(':').map(Number);

              // สร้าง Date object ด้วยวันที่ปัจจุบันและเวลาที่กำหนด
              const date = new Date();
              date.setHours(hours, minutes, 0, 0);
              return date;
            }
          } catch (e) {
            console.error("ไม่สามารถแปลงเวลาได้:", e);
          }

          return new Date(0); // ค่าเริ่มต้นถ้าแปลงไม่สำเร็จ
        },




        // ฟังก์ชันแชร์ข้อความสรุป


        // shouldShowCurrentTime(item, index) {
        //   if (!this.isToday(this.selectedScheduleDate)) return false;

        //   const allItems = this.getAllScheduleItemsSortedByTime();

        //   // ถ้ารายการแรก และยังไม่ถึงเวลานี้  แสดงก่อนรายการนี้
        //   if (index === 0) {
        //     return !this.isTimePassed(item.เวลา);
        //   }

        //   // ถ้าระหว่างสองรายการ  เวลาปัจจุบันอยู่ระหว่าง previousItem กับ item นี้
        //   const prevItem = allItems[index - 1];
        //   return this.isTimePassed(prevItem.เวลา) && !this.isTimePassed(item.เวลา);
        // },


        // ฟังก์ชันตรวจสอบว่าควรแสดงเวลาปัจจุบันก่อนรายการแรกหรือไม่
        shouldShowCurrentTime(item, index) {
          if (!this.isToday(this.selectedScheduleDate)) return false;

          // ถ้าเป็นรายการแรก ไม่แสดงเวลาปัจจุบัน เพราะมีฟังก์ชัน shouldShowCurrentTimeBeforeFirstItem แล้ว
          if (index === 0) return false;

          // ถ้าระหว่างสองรายการ  เวลาปัจจุบันอยู่ระหว่าง previousItem กับ item นี้
          const allItems = this.getAllScheduleItemsSortedByTime();
          const prevItem = allItems[index - 1];
          return this.isTimePassed(prevItem.เวลา) && !this.isTimePassed(item.เวลา);
        },


        shouldShowCurrentTimeBeforeFirstItem() {
          // ตรวจสอบว่าเป็นวันนี้หรือไม่
          if (!this.isToday(this.selectedScheduleDate)) return false;

          // ตรวจสอบว่ามีรายการหรือไม่
          const allItems = this.getAllScheduleItemsSortedByTime();
          if (allItems.length === 0) return true; // ถ้าไม่มีรายการเลย ให้แสดงเวลาปัจจุบัน

          // ตรวจสอบว่าเวลาปัจจุบันมาก่อนเวลาของรายการแรกหรือไม่
          const firstItem = allItems[0];
          return !this.isTimePassed(firstItem.เวลา);
        },


        getAllScheduleItemsSortedByTime() {
          // รวมรายการทั้งหมด
          const allItems = [...this.filteredPickups, ...this.filteredReturns];

          // เพิ่มข้อมูลสถานะ (สมมติว่าเป็นวันนี้)
          allItems.forEach(item => {
            // เพิ่มสถานะเสร็จสิ้นแล้วถ้าเวลาผ่านไปแล้ว
            if (this.isToday(this.selectedScheduleDate) && this.isTimePassed(item.เวลา)) {
              item.สถานะ = 'เสร็จสิ้นแล้ว';
            } else {
              item.สถานะ = '';
            }
          });

          // เรียงลำดับตามเวลา (เวลาที่ใกล้ที่สุดอยู่บนสุด)
          return allItems.sort((a, b) => {
            // แปลงเวลาเป็น Date object สำหรับเปรียบเทียบ
            const timeA = this.parseTimeString(a.เวลา);
            const timeB = this.parseTimeString(b.เวลา);

            // เรียงจากน้อยไปมาก (เวลาน้อยสุดอยู่บนสุด)
            return timeA - timeB;
          });
        },

        // ฟังก์ชันตรวจสอบว่าเวลาผ่านไปแล้วหรือไม่
        isTimePassed(timeStr) {
          if (!timeStr) return false;

          try {
            const now = new Date();
            const nowHours = now.getHours();
            const nowMinutes = now.getMinutes();

            // แปลงเวลาจากสตริง HH:MM เป็นตัวเลข
            const [hours, minutes] = timeStr.split(':').map(Number);

            // เปรียบเทียบเวลา
            if (nowHours > hours) return true;
            if (nowHours === hours && nowMinutes >= minutes) return true;

            return false;
          } catch (e) {
            console.error("ไม่สามารถเปรียบเทียบเวลาได้:", e);
            return false;
          }
        },

        // ฟังก์ชันตรวจสอบว่าควรแสดงเวลาปัจจุบันระหว่างรายการหรือไม่



        // วิธีสำรองสำหรับคัดลอกข้อความ
        fallbackCopyToClipboard(text) {
          try {
            // สร้าง textarea ชั่วคราว
            const textArea = document.createElement('textarea');
            textArea.value = text;

            // ทำให้ textarea มองไม่เห็น
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);

            // เลือกข้อความและคัดลอก
            textArea.focus();
            textArea.select();
            const successful = document.execCommand('copy');

            // ลบ textarea
            document.body.removeChild(textArea);

            // แจ้งเตือน
            if (successful) {
              this.showNotification('คัดลอกข้อความไปยังคลิปบอร์ดแล้ว', 'success');
            } else {
              this.showNotification('ไม่สามารถคัดลอกข้อความได้', 'error');
            }
          } catch (err) {
            console.error('ไม่สามารถคัดลอกข้อความได้: ', err);
            this.showNotification('ไม่สามารถคัดลอกข้อความได้', 'error');
          }
        },


        copyTodayScheduleSummary() {
          const summary = this.generateTodayScheduleSummary();

          if (navigator.clipboard) {
            navigator.clipboard.writeText(summary)
              .then(() => {
                this.showNotification('คัดลอกข้อมูลรายการรับส่งรถวันนี้แล้ว', 'success');
              })
              .catch(err => {
                console.error('ไม่สามารถคัดลอกข้อความได้: ', err);
                this.fallbackCopyToClipboard(summary);
              });
          } else {
            this.fallbackCopyToClipboard(summary);
          }
        },


        generateTodayScheduleSummary() {
          const today = this.formatDate(new Date());
          const pickupCount = this.todayPickups.length;
          const returnCount = this.todayReturns.length;

          let summary = `📅 รายการรับส่งรถวันที่ ${today}\n\n`;

          // สรุปจำนวน
          summary += `🚗 รับรถ: ${pickupCount} คัน\n`;
          summary += `🚙 คืนรถ: ${returnCount} คัน\n\n`;

          // รายละเอียดการรับรถ
          if (pickupCount > 0) {
            summary += `📋 รายการรับรถ:\n`;
            this.todayPickups.forEach((item, index) => {
              summary += `${index + 1}. #${item.หมายเลขการจอง} ${item.รถ}\n`;
              summary += `   ⏰ ${this.formatTime(item.เวลา)} น.\n`;
              if (item.สถานที่รับรถ) {
                summary += `   🗺️ ${item.สถานที่รับรถ}\n`;
              }
              summary += '\n';
            });
          }

          // รายละเอียดการคืนรถ
          if (returnCount > 0) {
            summary += `📋 รายการคืนรถ:\n`;
            this.todayReturns.forEach((item, index) => {
              summary += `${index + 1}. #${item.หมายเลขการจอง} ${item.รถ}\n`;
              summary += `   ⏰ ${this.formatTime(item.เวลา)} น.\n`;
              if (item.สถานที่คืนรถ) {
                summary += `   🗺️ ${item.สถานที่คืนรถ}\n`;
              }
              summary += '\n';
            });
          }

          return summary;
        },







        async shareTodayScheduleSummary() {
          const summary = this.generateTodayScheduleSummary();
          const shareTitle = `รายการรับส่งรถวันที่ ${this.formatDate(new Date())}`;

          if (navigator.share) { // ตรวจสอบว่า Web Share API พร้อมใช้งานหรือไม่
            try {
              await navigator.share({
                title: shareTitle,
                text: summary,
                // url: 'https://your-website.com' // สามารถใส่ URL เพิ่มเติมได้ (ถ้ามี)
              });
              this.showNotification('แชร์ข้อมูลสำเร็จ', 'success');
            } catch (err) {
              // ตรวจสอบ error name เพื่อดูว่าผู้ใช้ยกเลิกหรือไม่
              if (err.name !== 'AbortError') {
                console.error('เกิดข้อผิดพลาดในการแชร์: ', err);
                this.showNotification(`เกิดข้อผิดพลาดในการแชร์: ${err.message}`, 'error');
              } else {
                // console.log('ผู้ใช้ยกเลิกการแชร์');
                // ไม่ต้องแสดง notification ถ้าผู้ใช้แค่กดยกเลิกเอง
              }
            }
          } else {
            // ถ้า Web Share API ไม่รองรับ ให้แจ้งผู้ใช้
            console.warn('Web Share API is not supported in this browser.');
            this.showNotification('การแชร์ไม่รองรับบนเบราว์เซอร์นี้ ลองคัดลอกข้อมูลแทน', 'warning');
            // อาจจะเรียก copyTodayScheduleSummary() ให้เลยก็ได้ แต่แจ้งเตือนจะดีกว่า
            // this.copyTodayScheduleSummary();
          }
        },








        // ฟังก์ชันดึงเวลาปัจจุบัน
        getCurrentTime() {
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          return `${hours}:${minutes}`;
        },

        // ฟังก์ชันตรวจสอบว่ารายการกำลังจะถึงหรือไม่
        isItemUpcoming(item) {
          // ตรวจสอบว่าเป็นวันนี้หรือไม่ และยังไม่ถึงเวลา
          return this.isToday(this.selectedScheduleDate) &&
            !this.isTimePassed(item.เวลา) &&
            item.สถานะ !== 'เสร็จสิ้นแล้ว';
        },





        // ฟังก์ชัน getRentalDays - คำนวณจำนวนวันเช่า
        getRentalDays(rental) {
          if (!rental || !rental.วันที่เช่า || !rental.วันที่คืน) return 1;

          try {
            const startDate = new Date(rental.วันที่เช่า);
            const endDate = new Date(rental.วันที่คืน);

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return 1;

            // คำนวณจำนวนวันจากผลต่างของวันที่
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays > 0 ? diffDays : 1;
          } catch (e) {
            console.error("เกิดข้อผิดพลาดในการคำนวณจำนวนวัน:", e);
            return 1;
          }
        },

        // ฟังก์ชันสร้าง todayActiveRentals - รายการเช่าที่กำลังดำเนินการวันนี้
        loadTodayActiveRentals() {
          // ตรวจสอบว่ามีข้อมูลการเช่าหรือไม่
          if (!this.rentals || !Array.isArray(this.rentals)) {
            console.warn("ไม่สามารถโหลด todayActiveRentals เนื่องจากไม่มีข้อมูลการเช่า");
            this.todayActiveRentals = [];
            return;
          }

          try {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // ตั้งเวลาเป็นต้นวัน

            this.todayActiveRentals = this.rentals.filter(rental => {
              try {
                if (!rental.วันที่เช่า || !rental.วันที่คืน) return false;

                // แปลงวันที่จาก ISO string เป็น Date
                let startDate, endDate;

                try {
                  startDate = new Date(rental.วันที่เช่า);
                  startDate.setHours(0, 0, 0, 0);

                  endDate = new Date(rental.วันที่คืน);
                  endDate.setHours(23, 59, 59, 999);
                } catch (dateError) {
                  console.error("ไม่สามารถแปลงวันที่ได้:", dateError);
                  return false;
                }

                // รถที่อยู่ในช่วงเช่า (วันเริ่มต้น <= วันนี้ <= วันสิ้นสุด)
                return startDate <= today && today <= endDate;
              } catch (itemError) {
                console.error("เกิดข้อผิดพลาดในการตรวจสอบรายการเช่า:", itemError);
                return false;
              }
            });

            // เรียงลำดับตามวันที่คืน (รายการที่ใกล้คืนมาก่อน)
            this.todayActiveRentals.sort((a, b) => {
              const dateA = new Date(a.วันที่คืน);
              const dateB = new Date(b.วันที่คืน);
              return dateA - dateB;
            });

            // console.log(`โหลด todayActiveRentals สำเร็จ: ${this.todayActiveRentals.length} รายการ`);
          } catch (error) {
            console.error("เกิดข้อผิดพลาดใน loadTodayActiveRentals:", error);
            this.todayActiveRentals = []; // กำหนดเป็นอาร์เรย์ว่างในกรณีเกิดข้อผิดพลาด
          }
        },




        // แก้ไขฟังก์ชัน loadAvailableCarsToday เพื่อใช้ฟังก์ชันกลาง
        loadAvailableCarsToday() {
          try {
            // ใช้ฟังก์ชันกลางเพื่อดึงรายการรถว่างในวันนี้
            this.availableCarsToday = this.getAvailableCars();
            // this.debugCarData(); 

            // console.log(`โหลด availableCarsToday สำเร็จ: พบรถว่าง ${this.availableCarsToday.length} คัน`);
          } catch (error) {
            console.error("เกิดข้อผิดพลาดใน loadAvailableCarsToday:", error);
            this.availableCarsToday = [];
          }
        },




        // เพิ่มเมธอดสำหรับอัปเดตข้อมูลทั้งหมด
        updateAllData() {
          // อัปเดตข้อมูลรถว่าง
          this.availableCarsToday = this.getAvailableCars();

          // อัปเดตสถิติ
          this.calculateStats();

          // อัปเดตข้อมูลอื่นๆ ที่เกี่ยวข้อง
        },












        // เพิ่มฟังก์ชันกลางสำหรับจัดการข้อมูลรถ
        // เพิ่มฟังก์ชันเหล่านี้ในออบเจกต์หลักของแอปพลิเคชัน

        // 1. ฟังก์ชันสำหรับสร้าง Map ของรถที่ถูกเช่าในวันที่ระบุ
        getRentedCarsMap(date = null) {
          // ถ้าไม่ระบุวันที่ ใช้วันปัจจุบัน
          const targetDate = date || new Date();
          targetDate.setHours(0, 0, 0, 0); // ตั้งเวลาเป็นต้นวัน

          const rentedCarMap = {};

          // ตรวจสอบว่ามีข้อมูลรายการเช่า
          if (!this.rentals || !Array.isArray(this.rentals)) {
            return rentedCarMap;
          }

          // วนลูปตรวจสอบรายการเช่าทั้งหมด
          this.rentals.forEach(rental => {
            if (!rental || !rental.รถ || !rental.วันที่เช่า || !rental.วันที่คืน) return;

            try {
              // แปลงวันที่จาก ISO string เป็น Date
              const startDate = new Date(rental.วันที่เช่า);
              startDate.setHours(0, 0, 0, 0);

              const endDate = new Date(rental.วันที่คืน);
              endDate.setHours(23, 59, 59, 999);

              // ตรวจสอบว่ารถถูกเช่าในวันที่ระบุหรือไม่
              if (startDate <= targetDate && targetDate <= endDate) {
                // เก็บข้อมูลรถในหลายรูปแบบเพื่อให้การตรวจสอบแม่นยำยิ่งขึ้น

                // ทะเบียนรถ (ถ้ามี)
                if (rental.ทะเบียนรถ) {
                  rentedCarMap[rental.ทะเบียนรถ.trim()] = true;
                }

                // ชื่อรถเต็ม
                const carName = rental.รถ.trim();
                rentedCarMap[carName] = true;

                // กรณีที่ชื่อรถมีทะเบียนในวงเล็บ เช่น "MG ZS (7211)"
                const regMatch = carName.match(/\(([^)]+)\)/);
                if (regMatch && regMatch[1]) {
                  rentedCarMap[regMatch[1].trim()] = true;
                }
              }
            } catch (e) {
              console.error("ข้อผิดพลาดในการประมวลผลรายการเช่า:", e);
            }
          });

          return rentedCarMap;
        },

        // 2. ฟังก์ชันสำหรับตรวจสอบรถว่างในวันที่ระบุ
        getAvailableCars(date = null) {
          // ถ้าไม่ระบุวันที่ ใช้วันปัจจุบัน
          const targetDate = date || new Date();

          // ตรวจสอบว่ามีข้อมูลรถ
          if (!this.cars || !Array.isArray(this.cars) || this.cars.length === 0) {
            return [];
          }

          // สร้าง Map ของรถที่ถูกเช่าในวันที่ระบุ
          const rentedCarMap = this.getRentedCarsMap(targetDate);

          // กรองรถที่ว่างให้เช่า
          const availableCars = this.cars.filter(car => {
            if (!car || car.สถานะ !== 'พร้อมให้เช่า') return false;

            // สร้าง key หลายแบบเพื่อตรวจสอบ
            const carFullName = `${car.ยี่ห้อ} ${car.รุ่น}`.trim();
            const carRegistration = car.ทะเบียน ? car.ทะเบียน.trim() : '';

            // ตรวจสอบว่ารถไม่ได้ถูกเช่าอยู่
            return !rentedCarMap[carFullName] &&
              !rentedCarMap[carRegistration];
          });

          // เรียงลำดับตามยี่ห้อและรุ่น
          return availableCars.sort((a, b) => {
            if (!a || !b) return 0;
            if (a.ยี่ห้อ !== b.ยี่ห้อ) {
              return a.ยี่ห้อ.localeCompare(b.ยี่ห้อ);
            }
            return a.รุ่น.localeCompare(b.รุ่น);
          });
        },

        // 3. ฟังก์ชันสำหรับนับจำนวนรถว่าง
        // เพิ่ม log ในฟังก์ชันต่างๆ เพื่อตรวจสอบการทำงาน
        getAvailableCarsCount() {
          const count = this.getAvailableCars().length;
          // console.log(`getAvailableCarsCount: นับรถว่างได้ ${count} คัน`);
          return count;
        },

        generateTodayRentalsSummary() {
          const today = this.formatDate(new Date());
          const activeCount = this.todayActiveRentals.length;

          let summary = `📅 รายการเช่ารถที่กำลังดำเนินการวันที่ ${today}\n\n`;
          summary += `🚗 รถที่กำลังเช่าทั้งหมด: ${activeCount} คัน\n\n`;

          if (activeCount > 0) {
            summary += `📋 รายละเอียด:\n`;
            this.todayActiveRentals.forEach((item, index) => {
              summary += `${index + 1}. ${item.รถ} (${item.ทะเบียนรถ || 'ไม่ระบุทะเบียน'})\n`;
              summary += `   👤 ลูกค้า: ${item.ชื่อลูกค้า || 'ไม่ระบุชื่อ'}\n`;
              summary += `   🔢 #${item.หมายเลขการจอง || 'ไม่ระบุ'}\n`;
              summary += `   📆 วันที่: ${this.formatDate(item.วันที่เช่า)} - ${this.formatDate(item.วันที่คืน)}\n`;
              summary += `   ⏱️ ระยะเวลา: ${this.getRentalDays(item)} วัน\n`;
              if (item.สถานที่คืนรถ) {
                summary += `   🗺️ สถานที่คืนรถ: ${item.สถานที่คืนรถ}\n`;
              }
              summary += '\n';
            });
          } else {
            summary += `❌ ไม่มีรายการเช่ารถที่กำลังดำเนินการในวันนี้\n`;
          }

          return summary;
        },

        // ฟังก์ชันสร้างข้อความสรุปรถว่างวันนี้
        generateAvailableCarsSummary() {
          const today = this.formatDate(new Date());
          const availableCount = this.availableCarsToday.length;
          const totalCount = this.rentalStats.totalCars || 0;

          let summary = `📅 รายการรถว่างวันที่ ${today}\n\n`;
          summary += `🚗 รถว่างวันนี้: ${availableCount} จากทั้งหมด ${totalCount} คัน\n\n`;

          if (availableCount > 0) {
            summary += `📋 รายละเอียด:\n`;
            this.availableCarsToday.forEach((car, index) => {
              summary += `${index + 1}. ${car.ยี่ห้อ} ${car.รุ่น} (${car.ทะเบียน || 'ไม่ระบุทะเบียน'})\n`;
              summary += `   🎨 สี: ${car.สี || 'ไม่ระบุ'}\n`;
              summary += `   💰 ราคา: ${this.formatCurrency(car.ราคาเช่าต่อวัน)}/วัน\n`;
              // summary += `   🔧 ประเภท: ${car.ประเภท || 'ไม่ระบุ'}\n`;
              summary += '\n';
            });
          } else {
            summary += `❌ ไม่มีรถว่างให้เช่าในวันนี้\n`;
          }

          return summary;
        },



        // ฟังก์ชันคัดลอกข้อความสรุปรายการเช่าวันนี้
        copyTodayRentalsSummary() {
          const summary = this.generateTodayRentalsSummary();

          if (navigator.clipboard) {
            navigator.clipboard.writeText(summary)
              .then(() => {
                this.showNotification('คัดลอกข้อมูลรายการเช่าวันนี้แล้ว', 'success');
              })
              .catch(err => {
                console.error('ไม่สามารถคัดลอกข้อความได้: ', err);
                this.fallbackCopyToClipboard(summary);
              });
          } else {
            this.fallbackCopyToClipboard(summary);
          }
        },

        // ฟังก์ชันแชร์ข้อความสรุปรายการเช่าวันนี้
        async shareTodayRentalsSummary() {
          const summary = this.generateTodayRentalsSummary();
          const shareTitle = `รายการเช่ารถวันที่ ${this.formatDate(new Date())}`;

          if (navigator.share) {
            try {
              await navigator.share({
                title: shareTitle,
                text: summary
              });
              this.showNotification('แชร์ข้อมูลสำเร็จ', 'success');
            } catch (err) {
              if (err.name !== 'AbortError') {
                console.error('เกิดข้อผิดพลาดในการแชร์: ', err);
                this.showNotification(`เกิดข้อผิดพลาดในการแชร์: ${err.message}`, 'error');
              }
            }
          } else {
            this.showNotification('การแชร์ไม่รองรับบนเบราว์เซอร์นี้ ลองคัดลอกข้อมูลแทน', 'warning');
          }
        },

        // ฟังก์ชันคัดลอกข้อความสรุปรถว่างวันนี้
        copyAvailableCarsSummary() {
          const summary = this.generateAvailableCarsSummary();

          if (navigator.clipboard) {
            navigator.clipboard.writeText(summary)
              .then(() => {
                this.showNotification('คัดลอกข้อมูลรถว่างวันนี้แล้ว', 'success');
              })
              .catch(err => {
                console.error('ไม่สามารถคัดลอกข้อความได้: ', err);
                this.fallbackCopyToClipboard(summary);
              });
          } else {
            this.fallbackCopyToClipboard(summary);
          }
        },

        // ฟังก์ชันแชร์ข้อความสรุปรถว่างวันนี้
        async shareAvailableCarsSummary() {
          const summary = this.generateAvailableCarsSummary();
          const shareTitle = `รถว่างวันที่ ${this.formatDate(new Date())}`;

          if (navigator.share) {
            try {
              await navigator.share({
                title: shareTitle,
                text: summary
              });
              this.showNotification('แชร์ข้อมูลสำเร็จ', 'success');
            } catch (err) {
              if (err.name !== 'AbortError') {
                console.error('เกิดข้อผิดพลาดในการแชร์: ', err);
                this.showNotification(`เกิดข้อผิดพลาดในการแชร์: ${err.message}`, 'error');
              }
            }
          } else {
            this.showNotification('การแชร์ไม่รองรับบนเบราว์เซอร์นี้ ลองคัดลอกข้อมูลแทน', 'warning');
          }
        },


        // ประกาศ



        // จัดการผลลัพธ์เมื่อดึงข้อมูลสำเร็จ
        handleSuccess(result) {
          this.loading = false;

          if (result.error) {
            this.error = `เกิดข้อผิดพลาด: ${result.error}`;
            return;
          }

          this.announcements = result;

          // แยกประกาศตามประเภท
          this.importantAnnouncements = this.announcements.filter(item => item.type === 'important');
          this.generalAnnouncements = this.announcements.filter(item => item.type === 'general');
        },

        // จัดการกรณีเกิดข้อผิดพลาด
        handleError(error) {
          this.loading = false;
          this.error = `เกิดข้อผิดพลาด: ${error.message || error}`;
          console.error('Error:', error);
        },

        // เปิด Modal แสดงรายละเอียด
        openModal(announcement) {
          this.selectedAnnouncement = announcement;
          this.isModalOpen = true;
          document.body.classList.add('overflow-hidden'); // ป้องกันการเลื่อนหน้าเว็บขณะเปิด Modal
        },

        // ปิด Modal
        closeModal() {
          this.isModalOpen = false;
          document.body.classList.remove('overflow-hidden');
        },



        // เปิดรายละเอียดจาก Modal แสดงประกาศทั้งหมด
        openDetailFromAll(announcement) {
          this.closeAllAnnouncementsModal();
          setTimeout(() => {
            this.openModal(announcement);
          }, 300); // รอให้ modal ปิดก่อนแล้วค่อยเปิด modal ใหม่
        },

        // ตรวจสอบว่าเป็นประกาศใหม่หรือไม่ (7 วันล่าสุด)
        isNewAnnouncement(announcement) {
          if (!announcement.startDate) return false;

          const startDate = new Date(announcement.startDate);
          const today = new Date();
          const diffTime = Math.abs(today - startDate);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          return diffDays <= 7; // ถือว่าใหม่ถ้าประกาศในช่วง 7 วันที่ผ่านมา
        },

        // ฟังก์ชันฟอร์แมตวันที่เป็นรูปแบบไทย
        formatDateForAnnouncement(dateString) {
          if (!dateString) return '';

          const options = { day: 'numeric', month: 'short', year: 'numeric' };
          const date = new Date(dateString);

          // เพิ่ม พ.ศ. +543 ปี
          const thaiYear = date.getFullYear() + 543;

          // ฟอร์แมตวันและเดือน
          const formattedDate = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });

          return `${formattedDate} ${thaiYear}`;
        },

        // จัการสิทธิ์


        // เพิ่มฟังก์ชันสำหรับจัดการสวิตช์
        togglePermission(permissionKey) {
          // กลับค่าปัจจุบัน
          this.userPermissions[permissionKey] = !this.userPermissions[permissionKey];

          // แสดงค่าปัจจุบันใน console เพื่อตรวจสอบ
          console.log(`เปลี่ยนสิทธิ์ ${permissionKey} เป็น:`, this.userPermissions[permissionKey]);

          // ถ้าต้องการบันทึกทันที ให้เปิดใช้บรรทัดนี้
          // this.saveUserPermissions();
        },



        saveUserPermissionWithNotification(permissionKey) {
          this.notificationMessage = '';
          this.notificationType = '';
          if (this.notificationTimeout) {
            clearTimeout(this.notificationTimeout);
            this.notificationTimeout = null;
          }

          // แสดงข้อความ "กำลังบันทึก..."
          this.notificationMessage = `กำลังบันทึกสิทธิ์ ${permissionKey}...`;
          this.notificationType = 'info';
          const sheetID = localStorage.getItem('sheetID') || '';
          // อัปเดต rolePermissions['user'] ด้วยค่าจาก userPermissions
          if (this.rolePermissions && this.rolePermissions['user']) {
            this.rolePermissions['user'][permissionKey] = this.userPermissions[permissionKey];
          }

          // บันทึกทั้ง userPermissions (แบบเดิม) และ rolePermissions (แบบใหม่)
          const saveData = {
            userPermissions: this.userPermissions,
            rolePermissions: this.rolePermissions
          };

          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.notificationMessage = `บันทึกสิทธิ์ ${permissionKey} เรียบร้อยแล้ว`;
                this.notificationType = 'success';
              } else {
                this.notificationMessage = `บันทึกสิทธิ์ ${permissionKey} ไม่สำเร็จ: ${result.message || 'ข้อผิดพลาดไม่ทราบสาเหตุ'}`;
                this.notificationType = 'error';
                // กลับค่าเดิม
                this.userPermissions[permissionKey] = !this.userPermissions[permissionKey];
                if (this.rolePermissions && this.rolePermissions['user']) {
                  this.rolePermissions['user'][permissionKey] = this.userPermissions[permissionKey];
                }
              }
              this.notificationTimeout = setTimeout(() => { // ตั้งเวลาซ่อนข้อความ
                this.notificationMessage = '';
                this.notificationType = '';
              }, 3000);
            })
            .withFailureHandler(error => {
              console.error("เกิดข้อผิดพลาด:", error);
              this.notificationMessage = `เกิดข้อผิดพลาดในการบันทึก: ${error}`;
              this.notificationType = 'error';
              // กลับค่าเดิม
              this.userPermissions[permissionKey] = !this.userPermissions[permissionKey];
              if (this.rolePermissions && this.rolePermissions['user']) {
                this.rolePermissions['user'][permissionKey] = this.userPermissions[permissionKey];
              }
              this.notificationTimeout = setTimeout(() => { // ตั้งเวลาซ่อนข้อความ
                this.notificationMessage = '';
                this.notificationType = '';
              }, 3000);
            })
            .savePermissions(saveData, sheetID);
        },




        // คำนวณสถานะปุ่มลงทะเบียน
        get canSubmitRegistration() {
          return this.isValidEmail &&
            this.newUserInfo.email.length > 0 &&
            this.newUserInfo.password.length >= 6 &&
            this.newUserInfo.phoneNumber.length > 0 &&
            this.newUserInfo.storeName.length > 0 &&
            this.slipFile !== null;
        },

        // เปิด Modal ลงทะเบียน
        openRegisterServiceModal() {
          // รีเซ็ตค่าเริ่มต้น
          this.selectedServicePlan = '';
          this.showPaymentFormInfo = false;
          this.slipFile = null;
          this.slipPreviewUrl = null;
          this.activeTab = 'plans';

          // เตรียมข้อมูลผู้ใช้ใหม่
          this.newUserInfo = {
            email: '',
            password: '',
            phoneNumber: '',
            storeName: ''
          };

          // เปิด Modal
          this.showRegisterServiceModal = true;
        },

        // ปิด Modal ลงทะเบียน
        closeRegisterServiceModal() {
          this.showRegisterServiceModal = false;
        },

        // ตรวจสอบรูปแบบอีเมล Gmail
        validateEmail() {
          const emailRegex = /@gmail\.com$/i;
          this.isValidEmail = emailRegex.test(this.newUserInfo.email);
        },

        // คัดลอกข้อมูลไปยัง Clipboard
        copyToClipboard(elementId) {
          const element = document.getElementById(elementId);
          element.select();
          document.execCommand('copy');

          // แสดงการแจ้งเตือนว่าคัดลอกสำเร็จ
          this.showToast = true;
          this.toastMessage = 'คัดลอกข้อมูลสำเร็จ';

          setTimeout(() => {
            this.showToast = false;
          }, 2000);
        },






        // จัดการไฟล์อัพโหลดสลิป
        handleRegisterSlipUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          // ตรวจสอบขนาดไฟล์
          if (file.size > 10 * 1024 * 1024) { // 10MB
            alert('ไฟล์มีขนาดใหญ่เกินไป กรุณาอัพโหลดไฟล์ขนาดไม่เกิน 10MB');
            return;
          }

          this.slipFile = file;

          // สร้าง URL สำหรับแสดงตัวอย่างรูปภาพ
          this.slipPreviewUrl = URL.createObjectURL(file);
        },



        async submitRegistration() {
          if (!this.canSubmitRegistration) {
            console.log('เงื่อนไขการส่งข้อมูลยังไม่ครบถ้วน ไม่สามารถลงทะเบียนได้');
            return;
          }

          // เปลี่ยนสถานะเป็นกำลังส่งข้อมูล
          this.isSubmitting = true;
          console.log('เงื่อนไขครบถ้วน กำลังดำเนินการส่งข้อมูลลงทะเบียน...');

          // เตรียมข้อมูล text field
          const registrationData = {
            email: this.newUserInfo.email,
            password: this.newUserInfo.password,
            phoneNumber: this.newUserInfo.phoneNumber,
            storeName: this.newUserInfo.storeName,
            plan: this.selectedServicePlan,
            registrationDate: new Date().toISOString()
          };

          // ถ้ามีสลิป ให้แปลงเป็น Base64
          if (this.slipFile) {
            try {
              const arrayBuffer = await this.slipFile.arrayBuffer();
              const uint8Array = new Uint8Array(arrayBuffer);
              let binary = '';
              for (let i = 0; i < uint8Array.byteLength; i++) {
                binary += String.fromCharCode(uint8Array[i]);
              }
              registrationData.base64File = btoa(binary);
              registrationData.fileName = this.slipFile.name;
              registrationData.fileType = this.slipFile.type;
              console.log('แปลงไฟล์สลิปเป็น Base64 สำเร็จ');
            } catch (e) {
              console.error('Error converting file to Base64:', e);
              Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถอ่านไฟล์สลิปได้ กรุณาลองใหม่'
              });
              this.isSubmitting = false;
              return;
            }
          } else {
            console.warn('ไม่มีไฟล์สลิปแนบ!');
          }

          // ส่งเป็น plain object (ไม่มี FormData อีกต่อไป)
          google.script.run
            .withSuccessHandler(result => {
              console.log('saveRegistration Success:', result);
              Swal.fire({
                icon: 'success',
                title: 'แจ้งชำระเงินสำเร็จ',
                html: `
          <div style="text-align: center;">
            โปรดแอดไลน์ของเรา และแจ้ง email ที่ท่านลงทะเบียนให้เราทราบ ขอบคุณครับ<br>
            <div style="display: flex; justify-content: center; margin-top: 10px;">
              <a href="https://lin.ee/HGQIu1U">
                <img src="https://scdn.line-apps.com/n/line_add_friends/btn/th.png" alt="เพิ่มเพื่อน" height="36" border="0">
              </a>
            </div>
            <div style="margin-top: 15px;">
              <img src="https://qr-official.line.me/gs/M_295lvpai_BW.png?oat_content=qr" alt="Line QR Code" style="width: 120px; height: 120px; margin: 0 auto;">
            </div>
          </div>
        `,
                confirmButtonText: 'ปิด'
              });

              this.closeRegisterServiceModal();
              this.isRegistered = true;
              localStorage.setItem('isRegistered', 'true');
              this.isSubmitting = false;
            })
            .withFailureHandler(error => {
              console.error('saveRegistration Failed:', error);
              Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาดในการลงทะเบียน',
                text: error.message
              });
              this.isSubmitting = false;
            })
            .saveRegistration(registrationData);
        },








        // ตรวจสอบสถานะการลงทะเบียนเมื่อโหลดหน้า
        checkRegistrationStatus() {
          // ตรวจสอบจาก localStorage ว่าได้ลงทะเบียนแล้วหรือไม่
          const registrationStatus = localStorage.getItem('isRegistered');
          if (registrationStatus === 'true') {
            this.isRegistered = true;
          }

          // ตรวจสอบว่าเคยปิดโปรโมชั่นแล้วหรือไม่
          const promotionDismissed = localStorage.getItem('dismissedPromotion');
          if (promotionDismissed === 'true') {
            this.dismissedPromotion = true;
          }
        },

        // ฟังก์ชันปิดโปรโมชั่น
        dismissPromotion() {
          this.dismissedPromotion = true;
          localStorage.setItem('dismissedPromotion', 'true');
        },


        // จัดการสิทธิ์





        // ดึงชื่อกลุ่มที่แสดงจากรหัสกลุ่ม
        getGroupName(roleId) {
          return this.roleNames[roleId] || roleId;
        },

        // ดึงคำอธิบายกลุ่มจากรหัสกลุ่ม
        getGroupDescription(roleId) {
          return this.roleDescriptions[roleId] || '';
        },

        // นับจำนวนผู้ใช้ในกลุ่ม
        countUsersByRole(roleId) {
          return this.users.filter(user => user.role === roleId).length;
        },

        // แก้ไขกลุ่ม
        editRole(roleId) {
          this.currentEditingRole = roleId;

          // ตรวจสอบว่ามีข้อมูลครบหรือไม่
          if (!this.roleNames[roleId]) {
            this.roleNames[roleId] = roleId;
          }

          if (!this.roleDescriptions[roleId]) {
            this.roleDescriptions[roleId] = '';
          }

          // เลื่อนไปที่ส่วนการแก้ไข
          this.$nextTick(() => {
            document.getElementById('role-management').scrollIntoView({ behavior: 'smooth' });
          });
        },

        // ยกเลิกการแก้ไขกลุ่ม
        cancelEditRole() {
          this.currentEditingRole = '';
        },

        checkRolePermission(role, permission) {
          if (!role || !this.rolePermissions || !this.rolePermissions[role]) {
            return false;
          }
          return this.rolePermissions[role][permission] === true;
        },

        // เปลี่ยนสถานะสิทธิ์ของกลุ่มที่กำลังแก้ไข
        toggleRolePermission(permissionKey) {
          // ตรวจสอบว่ามีการเลือกกลุ่มหรือไม่
          if (!this.currentEditingRole) {
            this.showNotification('กรุณาเลือกกลุ่มที่ต้องการแก้ไข', 'error');
            return;
          }

          // สร้างโครงสร้างข้อมูลหากยังไม่มี
          if (!this.rolePermissions[this.currentEditingRole]) {
            this.rolePermissions[this.currentEditingRole] = {};
          }

          // กำหนดค่าเริ่มต้นหากยังไม่มีการกำหนด
          if (this.rolePermissions[this.currentEditingRole][permissionKey] === undefined) {
            this.rolePermissions[this.currentEditingRole][permissionKey] = false;
          }

          // สลับค่า
          this.rolePermissions[this.currentEditingRole][permissionKey] = !this.rolePermissions[this.currentEditingRole][permissionKey];

          // ถ้ากำลังแก้ไขกลุ่ม 'user' ให้อัปเดต userPermissions ด้วย
          if (this.currentEditingRole === 'user') {
            this.userPermissions[permissionKey] = this.rolePermissions['user'][permissionKey];
          }
        },

        // บันทึกการแก้ไขสิทธิ์ของกลุ่ม
        saveRolePermissions() {
          this.saveRoleData();
          this.showNotification(`บันทึกสิทธิ์ของกลุ่ม "${this.getGroupName(this.currentEditingRole)}" เรียบร้อยแล้ว`, 'success');
        },

        // แสดงหน้าต่างยืนยันการลบกลุ่ม
        confirmDeleteRole(roleId) {
          // ตรวจสอบว่ามีผู้ใช้อยู่ในกลุ่มหรือไม่
          const usersInRole = this.countUsersByRole(roleId);

          if (usersInRole > 0) {
            this.showNotification(`ไม่สามารถลบกลุ่มได้เนื่องจากมีผู้ใช้ ${usersInRole} คนอยู่ในกลุ่มนี้`, 'error');
            return;
          }

          this.roleToDelete = roleId;
          this.showDeleteRoleModal = true;
        },

        // ลบกลุ่ม
        deleteRole() {
          if (this.roleToDelete === 'admin' || this.roleToDelete === 'user') {
            this.showNotification('ไม่สามารถลบกลุ่มหลักของระบบได้', 'error');
            this.showDeleteRoleModal = false;
            return;
          }

          // ลบข้อมูลกลุ่ม
          delete this.rolePermissions[this.roleToDelete];
          delete this.roleNames[this.roleToDelete];
          delete this.roleDescriptions[this.roleToDelete];

          // บันทึกข้อมูล
          this.saveRoleData();

          this.showNotification(`ลบกลุ่ม "${this.getGroupName(this.roleToDelete)}" เรียบร้อยแล้ว`, 'success');
          this.showDeleteRoleModal = false;
          this.roleToDelete = '';
        },

        // เพิ่มกลุ่มใหม่
        addNewRole() {
          if (!this.newRoleId) {
            this.showNotification('กรุณาระบุรหัสกลุ่ม', 'warning');
            return;
          }

          // ตรวจสอบรูปแบบรหัสกลุ่ม
          if (!/^[a-z0-9-]+$/.test(this.newRoleId)) {
            this.showNotification('รหัสกลุ่มต้องประกอบด้วยตัวอักษรภาษาอังกฤษพิมพ์เล็ก ตัวเลข หรือเครื่องหมาย - เท่านั้น', 'warning');
            return;
          }

          // ตรวจสอบว่ามีกลุ่มนี้อยู่แล้วหรือไม่
          if (this.rolePermissions[this.newRoleId]) {
            this.showNotification('มีกลุ่มผู้ใช้นี้อยู่แล้ว', 'warning');
            return;
          }

          if (!this.newRoleName) {
            this.showNotification('กรุณาระบุชื่อกลุ่มที่แสดง', 'warning');
            return;
          }

          // สร้างสิทธิ์เริ่มต้นตามต้นแบบที่เลือก
          let defaultPermissions = {};

          if (this.newRoleTemplate === 'empty') {
            // สร้างกลุ่มว่างเปล่า (ไม่มีสิทธิ์ใดๆ)
            defaultPermissions = {
              'company-info': false,
              'payment-settings': false,
              'booking-settings': false,
              'location-settings': false,
              'summary-message-settings': false,
              'translation-settings': false,
              'blacklist-management': false,
              'license-info': false,
              'page-summary': false,
              'page-bookings': false,
              'page-schedule': false,
              'page-newRental': false,
              'page-finance': false,
              'commission-settings': false,
              'page-cars': false,
              'page-config': false
            };
          } else if (this.newRoleTemplate === 'full') {
            // สร้างกลุ่มที่มีสิทธิ์ครบถ้วน (เหมือน admin แต่ไม่ใช่ admin)
            defaultPermissions = {
              'company-info': true,
              'payment-settings': true,
              'booking-settings': true,
              'location-settings': true,
              'summary-message-settings': true,
              'translation-settings': true,
              'blacklist-management': true,
              'license-info': true,
              'page-finance': true,
              'commission-settings': true,
              'page-summary': true,
              'page-bookings': true,
              'page-schedule': true,
              'page-newRental': true,
              'page-cars': true,
              'page-config': true
            };
          } else if (this.newRoleTemplate === 'basic') {
            // สร้างกลุ่มที่มีสิทธิ์พื้นฐาน
            defaultPermissions = {
              'company-info': true,
              'payment-settings': false,
              'booking-settings': true,
              'location-settings': true,
              'summary-message-settings': true,
              'translation-settings': false,
              'blacklist-management': false,
              'license-info': false,
              'page-summary': true,
              'page-bookings': true,
              'page-schedule': true,
              'page-finance': true,
              'page-newRental': true,
              'page-cars': true,
              'page-config': true
            };
          } else if (this.rolePermissions[this.newRoleTemplate]) {
            // คัดลอกจากกลุ่มที่มีอยู่
            defaultPermissions = { ...this.rolePermissions[this.newRoleTemplate] };
          }

          // เพิ่มกลุ่มใหม่
          this.rolePermissions[this.newRoleId] = defaultPermissions;
          this.roleNames[this.newRoleId] = this.newRoleName;
          this.roleDescriptions[this.newRoleId] = this.newRoleDescription || '';

          // เก็บค่าชื่อกลุ่มไว้แสดงข้อความ
          const addedRoleName = this.newRoleName;

          // บันทึกข้อมูล
          this.saveRoleData();

          // รีเซ็ตฟอร์ม
          this.newRoleId = '';
          this.newRoleName = '';
          this.newRoleDescription = '';
          this.newRoleTemplate = 'empty';
          this.showAddRoleModal = false;

          // ใช้ตัวแปรชั่วคราวที่เก็บไว้แสดงข้อความ
          this.showNotification(`เพิ่มกลุ่ม "${addedRoleName}" เรียบร้อยแล้ว`, 'success');
        },



        loadRoleData() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.rolePermissions) {
                this.rolePermissions = result.rolePermissions;
              } else {
                // กำหนดค่าเริ่มต้นหากไม่มีข้อมูล
                this.rolePermissions = {
                  'admin': {
                    // สิทธิ์เข้าถึงหน้าต่างๆ
                    'page-summary': true,
                    'page-bookings': true,
                    'page-schedule': true,
                    'page-newRental': true,
                    'page-cars': true,
                    'page-config': true,
                    // สิทธิ์อื่นๆ ที่มีอยู่เดิม
                    'company-info': true,
                    'payment-settings': true,
                    'booking-settings': true,
                    'location-settings': true,
                    'summary-message-settings': true,
                    'translation-settings': true,
                    'blacklist-management': true,
                    'license-info': true,
                    'user-management': true,
                    'role-management': true
                  },
                  'user': this.userPermissions || {
                    // สิทธิ์เข้าถึงหน้าต่างๆ
                    'page-summary': true,
                    'page-bookings': true,
                    'page-schedule': true,
                    'page-newRental': true,
                    'page-cars': true,
                    'page-config': true,
                    // สิทธิ์อื่นๆ
                    'company-info': true,
                    'payment-settings': true,
                    'booking-settings': true,
                    'location-settings': true,
                    'summary-message-settings': true,
                    'translation-settings': false,
                    'blacklist-management': false,
                    'license-info': false,
                    'user-management': false,
                    'role-management': false
                  }
                };
              }

              if (result.roleNames) {
                this.roleNames = result.roleNames;
              } else {
                // กำหนดค่าเริ่มต้นหากไม่มีข้อมูล
                this.roleNames = {
                  'admin': 'ผู้ดูแลระบบ',
                  'user': 'ผู้ใช้งานทั่วไป'
                };
              }

              if (result.roleDescriptions) {
                this.roleDescriptions = result.roleDescriptions;
              } else {
                // กำหนดค่าเริ่มต้นหากไม่มีข้อมูล
                this.roleDescriptions = {
                  'admin': 'มีสิทธิ์เข้าถึงทุกส่วนของระบบ',
                  'user': 'มีสิทธิ์เข้าถึงเฉพาะส่วนที่กำหนด'
                };
              }

              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('โหลดข้อมูลกลุ่มผู้ใช้ไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .getRoleData(sheetID);
        },



        hasPermission(permission) {
          // admin มีสิทธิ์ทุกอย่างเสมอ
          if (this.currentUser.role === 'admin') {
            return true;
          }

          // ตรวจสอบสิทธิ์จาก rolePermissions
          if (this.rolePermissions[this.currentUser.role] &&
            this.rolePermissions[this.currentUser.role][permission] !== undefined) {
            return this.rolePermissions[this.currentUser.role][permission];
          }

          // กรณีไม่พบข้อมูลสิทธิ์ ใช้ค่าจาก userPermissions เดิม (สำหรับการย้ายไประบบใหม่)
          if (this.userPermissions[permission] !== undefined) {
            return this.userPermissions[permission];
          }

          // กรณีไม่พบข้อมูลสิทธิ์ ให้ปฏิเสธ
          return false;
        },



        openBlankContractModal() {
          this.blankContract = {
            templateName: 'Template_สัญญาเช่า_รถยนต์',
            language: 'th'
          };
          this.isGeneratingBlankContract = false; // ตรวจสอบว่าตั้งค่าเป็น false
          this.blankContractSuccessState = null; // รีเซ็ตสถานะผลลัพธ์ทุกครั้งที่เปิด
          this.showBlankContractModal = true;
        },

        // แก้ไขฟังก์ชันนี้
        generateBlankContract() {
          this.isGeneratingBlankContract = true; // เริ่มแสดงอนิเมชั่น
          this.blankContractSuccessState = null; // ล้างผลลัพธ์เก่า
          const sheetID = localStorage.getItem('sheetID') || '';

          // สร้างหมายเลขอ้างอิง
          const timestamp = new Date().getTime();
          const randomStr = Math.random().toString(36).substring(2, 8);
          const blankContractRef = `BLANK_${timestamp}_${randomStr}`;

          google.script.run
            .withSuccessHandler(result => {
              // ไม่ปิด Modal แต่เปลี่ยนไปแสดงผลลัพธ์แทน
              this.isGeneratingBlankContract = false; // หยุดแสดงอนิเมชั่น
              this.blankContractSuccessState = result; // เก็บผลลัพธ์เพื่อแสดงในหน้าต่างเดิม
            })
            .withFailureHandler(error => {
              this.isGeneratingBlankContract = false; // หยุดแสดงอนิเมชั่น
              // แสดงผลลัพธ์เป็นข้อผิดพลาด
              this.blankContractSuccessState = {
                success: false,
                message: 'เกิดข้อผิดพลาด: ' + error,
                pdfUrl: null
              };
            })
            .generateBlankContract(
              blankContractRef,
              this.blankContract.templateName,
              this.blankContract.language,
              sheetID
            );
        },

        // เพิ่มฟังก์ชันใหม่นี้เข้าไป
        resetBlankContractForm() {
          this.blankContractSuccessState = null; // กลับไปแสดงหน้าฟอร์ม
          this.blankContract = { // รีเซ็ตค่าในฟอร์ม
            templateName: 'Template_สัญญาเช่า_รถยนต์',
            language: 'th'
          };
          this.isGeneratingBlankContract = false;
        },




        // ฟังก์ชันภายในสำหรับสร้าง PDF (แยกออกมาจาก generateDailySchedulePDF)

        showPdfOptionsModal(isDailyReport = false) {
          this.pdfIsDailyReport = isDailyReport;

          // For monthly reports, show column options
          if (!isDailyReport) {
            // Default select all columns when opening the modal
            this.selectedColumns = this.availableColumns.map(col => col.key);
          }

          this.isPdfGenerated = false;
          this.showColumnSelectionModal = true;
        },



        // 2. เพิ่มฟังก์ชันเริ่มสร้าง PDF รายวันเมื่อผู้ใช้กดปุ่มยืนยัน

        // 3. อัพเดตฟังก์ชัน closeColumnSelectionModal
        closeColumnSelectionModal() {
          this.showColumnSelectionModal = false;
          this.isPdfGenerated = false;
          this.isPdfGenerating = false;
          this.pdfLoadingProgress = 10;
          this.pdfIsDailyReport = false;
          this.isDailyReportMode = false; // รีเซ็ตค่า
        },


        // Method to confirm and start PDF generation
        confirmExportPDF() {
          if (this.selectedColumns.length === 0) {
            // แสดงข้อความแจ้งเตือนในหน้าจอโมดัล
            const errorDiv = document.createElement('div');
            errorDiv.className = 'p-3 mb-4 text-sm rounded-md bg-red-100 text-red-700';
            errorDiv.textContent = 'กรุณาเลือกอย่างน้อย 1 คอลัมน์';

            // แทรกข้อความแจ้งเตือนก่อนรายการช็อคบ็อกซ์
            const checkboxContainer = this.$el.querySelector('.grid');
            checkboxContainer.parentNode.insertBefore(errorDiv, checkboxContainer);

            // ลบข้อความแจ้งเตือนหลังจาก 3 วินาที
            setTimeout(() => {
              if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
              }
            }, 3000);

            return;
          }

          this.isPdfGenerating = true;
          this.generateBookingListPDF();
        },

        // Method to generate bookingList data with only selected columns
        getBookingListData() {
          const bookingList = [];

          // ตรวจสอบว่ามีข้อมูลการจองหรือไม่
          if (!this.bookingData || Object.keys(this.bookingData).length === 0) {
            console.log("ไม่พบข้อมูลการจอง");
            return [];
          }

          // วนลูปข้อมูลการจองที่มีอยู่ของเดือนที่เลือก
          for (const carName in this.bookingData) {
            const carBookings = this.bookingData[carName];

            // วนลูปแต่ละการจอง
            for (const bookingNo in carBookings) {
              const booking = carBookings[bookingNo];

              // เพิ่มข้อมูลการจองในรูปแบบที่ต้องการสำหรับตาราง PDF
              bookingList.push({
                bookingNo: booking.bookingNo || bookingNo,
                carName: carName,
                pickupDate: booking.startDate || '-',
                pickupTime: booking.startTime || '-',
                pickupLocation: booking.pickupLocation || '-',
                returnDate: booking.endDate || '-',
                returnTime: booking.endTime || '-',
                returnLocation: booking.returnLocation || '-',
                customerName: booking.customerName || '-',
                customerPhone: booking.customerPhone || '-'
              });
            }
          }

          return bookingList;
        },

        // Updated method to generate PDF with selected columns and show results in modal
        generateBookingListPDF() {
          // ดึงข้อมูลการจอง - เก็บเป็นตัวแปรก่อนเพื่อส่งไปยังฟังก์ชัน Google Apps Script
          const bookingList = this.getBookingListData();
          const month = this.getMonthName(this.selectedScheduleMonth);
          const year = this.selectedScheduleYear;
          const sheetID = localStorage.getItem('sheetID') || '';

          // ข้อมูลคอลัมน์ที่เลือก
          const selectedColumnInfo = this.availableColumns
            .filter(col => this.selectedColumns.includes(col.key))
            .map(col => ({
              key: col.key,
              label: col.label
            }));

          // อัปเดตสถานะการโหลด
          this.pdfLoadingStep = 'กำลังเตรียมข้อมูล...';
          this.pdfLoadingProgress = 10;

          // อัปเดตสถานะตามขั้นตอน
          setTimeout(() => {
            this.pdfLoadingProgress = 25;
            this.pdfLoadingStep = 'กำลังสร้างตาราง...';
          }, 500);

          setTimeout(() => {
            this.pdfLoadingStep = 'กำลังสร้างเอกสาร PDF...';
            this.pdfLoadingProgress = 50;
          }, 1500);

          setTimeout(() => {
            this.pdfLoadingProgress = 75;
            this.pdfLoadingStep = 'กำลังบันทึกเอกสาร...';
          }, 3000);

          // ส่งคำขอไปยัง Google Apps Script เพื่อสร้าง PDF
          google.script.run
            .withSuccessHandler((pdfUrl) => {
              // อัปเดตสถานะ
              this.pdfLoadingProgress = 100;
              this.pdfLoadingStep = 'การสร้าง PDF สำเร็จ!';

              // ให้ผู้ใช้เห็นการโหลดเสร็จสมบูรณ์ก่อนแสดงผลลัพธ์
              setTimeout(() => {
                // เก็บ URL สำหรับแสดงในโมดัล
                this.generatedPdfUrl = pdfUrl;
                this.isPdfGenerating = false;
                this.isPdfGenerated = true;

                // เปิดไฟล์ PDF ในแท็บใหม่
                const link = document.createElement('a');
                link.href = pdfUrl;
                link.target = '_blank';
                link.click();
              }, 700);
            })
            .withFailureHandler((error) => {
              console.error('เกิดข้อผิดพลาดในการสร้าง PDF:', error);
              this.isPdfGenerating = false;

              // แสดงข้อความแจ้งเตือนในโมดัล
              const errorDiv = document.createElement('div');
              errorDiv.className = 'p-4 mb-4 text-sm rounded-md bg-red-100 text-red-700';
              errorDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> เกิดข้อผิดพลาดในการสร้าง PDF: ${error}`;

              // แทรกข้อความแจ้งเตือนในโมดัล
              const modalContent = this.$el.querySelector('.animate-fade-in-up');
              if (modalContent) {
                const firstChild = modalContent.firstChild;
                modalContent.insertBefore(errorDiv, firstChild);

                // เปลี่ยนข้อความหัวเรื่องโมดัล
                const modalTitle = modalContent.querySelector('h3');
                if (modalTitle) {
                  modalTitle.textContent = 'เกิดข้อผิดพลาด';
                }

                // แสดงปุ่มปิด
                const closeButton = document.createElement('button');
                closeButton.className = 'px-4 py-2 mt-4 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors';
                closeButton.textContent = 'ปิด';
                closeButton.addEventListener('click', () => this.closeColumnSelectionModal());
                errorDiv.appendChild(closeButton);
              }
            })
            .createBookingListToPDF(bookingList, month, year, sheetID, selectedColumnInfo);
        },




        // ปรับปรุงฟังก์ชันแชร์ลิงก์ PDF
        sharePdfLink() {
          // ตรวจสอบว่ามี URL หรือไม่
          if (!this.generatedPdfUrl) {
            console.error('ไม่พบ URL ของไฟล์ PDF');
            return;
          }

          // สร้างข้อความสำหรับการแชร์ที่มีวันที่
          let shareTitle, shareText;

          if (this.pdfIsDailyReport) {
            // กรณีเป็นตารางรายวัน
            const formattedDate = this.formatDate(this.selectedScheduleDate);
            shareTitle = `ไฟล์PDF ตารางรับส่งรถวันที่ ${formattedDate}`;
            shareText = `ไฟล์PDF ตารางรับส่งรถวันที่ ${formattedDate}`;
          } else {
            // กรณีเป็นตารางรายเดือน
            const month = this.getMonthName(this.selectedScheduleMonth);
            const year = this.selectedScheduleYear;
            shareTitle = `ไฟล์PDF ตารางรับส่งรถเดือน ${month} ${year}`;
            shareText = `ไฟล์PDF ตารางรับส่งรถเดือน ${month} ${year}`;
          }

          // ตรวจสอบการรองรับ Web Share API
          if (navigator.share) {
            // ใช้ Web Share API (รองรับในมือถือและเบราว์เซอร์สมัยใหม่)
            navigator.share({
              title: shareTitle,
              text: shareText,
              url: this.generatedPdfUrl
            })
              .then(() => console.log('แชร์สำเร็จ'))
              .catch((error) => console.error('การแชร์ไม่สำเร็จ:', error));
          } else {
            // ทางเลือกสำหรับเบราว์เซอร์ที่ไม่รองรับ Web Share API
            // คัดลอกลิงก์ไปยังคลิปบอร์ด
            const textArea = document.createElement('textarea');
            textArea.value = this.generatedPdfUrl;
            // ซ่อน text area
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
              const successful = document.execCommand('copy');
              if (successful) {
                // แสดงข้อความแจ้งเตือนว่าคัดลอกสำเร็จแล้ว
                this.showCopySuccessMessage(shareText);
              } else {
                console.error('ไม่สามารถคัดลอกลิงก์ได้');
              }
            } catch (err) {
              console.error('ไม่สามารถคัดลอกลิงก์ได้: ', err);
            }

            document.body.removeChild(textArea);
          }
        },

        // ปรับปรุงฟังก์ชันแสดงข้อความแจ้งเตือนเมื่อคัดลอกสำเร็จ
        showCopySuccessMessage(messageText = 'ลิงก์ PDF') {
          // ตรวจสอบว่ามีการแจ้งเตือนอยู่แล้วหรือไม่
          const existingAlert = document.querySelector('.copy-alert');
          if (existingAlert) {
            document.body.removeChild(existingAlert);
          }

          // สร้างการแจ้งเตือน
          const alertDiv = document.createElement('div');
          alertDiv.className = 'copy-alert fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fadeIn';
          alertDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i>คัดลอกลิงก์ ${messageText} แล้ว`;

          // เพิ่มสไตล์ animation
          const style = document.createElement('style');
          style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out forwards;
    }
    .animate-fadeOut {
      animation: fadeOut 0.3s ease-out forwards;
    }
  `;
          document.head.appendChild(style);

          // เพิ่มการแจ้งเตือนลงในเพจ
          document.body.appendChild(alertDiv);

          // ลบการแจ้งเตือนหลังจาก 3 วินาที
          setTimeout(() => {
            alertDiv.classList.remove('animate-fadeIn');
            alertDiv.classList.add('animate-fadeOut');

            setTimeout(() => {
              if (alertDiv.parentNode) {
                document.body.removeChild(alertDiv);
              }
            }, 300);
          }, 3000);
        },



        // ⭐⭐ ฟังก์ชันสำหรับ Benchmark
        async runBenchmark(version) {
          const isOriginal = version === 'original';
          const resultsKey = isOriginal ? 'benchmarkResults_original' : 'benchmarkResults_optimized';
          const loadingKey = isOriginal ? 'isBenchmarking_original' : 'isBenchmarking_optimized';

          this[loadingKey] = true;
          this[resultsKey] = [];

          const sheetID = localStorage.getItem('sheetID') || '';
          if (!sheetID) {
            this.showNotification('ไม่พบ Sheet ID', 'error');
            this[loadingKey] = false;
            return;
          }

          for (let i = 1; i <= 3; i++) {
            const clientStartTime = performance.now();
            try {
              // ใช้เงื่อนไขเพื่อเรียกฟังก์ชันที่ถูกต้อง
              let runPromise;
              if (isOriginal) {
                runPromise = new Promise((resolve, reject) => {
                  google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getSummaryData_Original(sheetID);
                });
              } else {
                runPromise = new Promise((resolve, reject) => {
                  google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getSummaryData(sheetID); // เรียกฟังก์ชันใหม่
                });
              }

              await runPromise; // รอให้การเรียกทำงานเสร็จ

              const clientEndTime = performance.now();
              const duration = clientEndTime - clientStartTime;
              this[resultsKey].push({ run: i, duration: duration });

            } catch (e) {
              console.error(`Benchmark run ${i} failed for ${version}:`, e);
              this[resultsKey].push({ run: i, duration: 'Error' });
              break;
            }
          }

          this[loadingKey] = false;
        },



        // ฟังก์ชันสำหรับโหลดข้อมูลสรุปทั้งหมดสำหรับหน้า Dashboard
        loadSummaryData() {
          // 1. ตั้งสถานะเป็น "กำลังโหลด" เพื่อแสดงผลใน UI
          this.isLoading = true;
          console.log("[Client] กำลังเรียกใช้ getSummaryData (เวอร์ชันปรับปรุงแล้ว)...");

          // 2. ดึง sheetID จาก localStorage
          const sheetID = localStorage.getItem('sheetID') || '';
          if (!sheetID) {
            this.showNotification('ไม่พบ Sheet ID กรุณาเข้าสู่ระบบใหม่', 'error');
            this.isLoading = false;
            return;
          }

          // 3. เรียกใช้ฟังก์ชันใน Google Apps Script
          google.script.run
            .withSuccessHandler(result => {
              // 4. เมื่อได้รับข้อมูลสำเร็จ
              console.log("[Client] ได้รับข้อมูลสรุปสำเร็จ:", result);

              if (result) {
                // 5. อัปเดตข้อมูลในส่วนต่างๆ ของแอปพลิเคชัน
                this.rentalStats = result.rentalStats || {};
                this.availableCarsToday = result.availableCarsToday || [];
                this.todayActiveRentals = result.todayActiveRentals || [];
                this.todayPickups = result.todayPickups || [];
                this.todayReturns = result.todayReturns || [];
                this.upcomingMaintenance = result.upcomingMaintenance || [];
                this.bookingForecastData = result.bookingForecast || [];
                this.carUsageStats = result.carUsageStats || [];  // รับข้อมูลสถิติการใช้งานรถจาก backend

                this.pendingVehicleStats = result.pendingVehicleStats || { total: 0, todayPickup: 0, tomorrowPickup: 0, urgent: 0, upcoming: 0 };

                // 6. โหลดข้อมูล Locations (ยังคงต้องเรียกแยกถ้าไม่ได้รวมใน getSummaryData)
                this.loadLocations();

                // 7. ใช้ $nextTick เพื่อรอให้ DOM อัปเดตก่อนที่จะวาดกราฟ
                this.$nextTick(() => {
                  this.renderSummaryCharts();
                  this.renderBookingForecastChart();
                });
              } else {
                this.showNotification('ไม่สามารถโหลดข้อมูลสรุปได้', 'error');
              }

              // 8. ปิดสถานะ "กำลังโหลด"
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              // 9. กรณีเกิดข้อผิดพลาด
              console.error("[Client] ไม่สามารถโหลดข้อมูลสรุปได้:", error);
              this.showNotification('โหลดข้อมูลสรุปไม่สำเร็จ: ' + (error.message || error), 'error');
              this.isLoading = false;
            })
            .getSummaryData(sheetID); // เรียกใช้ฟังก์ชันที่ปรับปรุงแล้ว
        },




        // คำนวณสรุปยอด
        get financeSummary() {
          const totalRevenue = this.financeData.revenues.reduce((sum, item) => sum + item.amount, 0);
          const totalExpense = this.financeData.expenses.reduce((sum, item) => sum + item.amount, 0);
          const netProfit = totalRevenue - totalExpense;
          return { totalRevenue, totalExpense, netProfit };
        },



        loadFinancialData() {
          this.isLoadingFinance = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.financeData = result.data;
                this.renderAllFinanceCharts(); // เรียกฟังก์ชัน render กราฟทั้งหมด
              } else {
                this.showNotification('โหลดข้อมูลการเงินไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoadingFinance = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูลการเงิน: ' + error, 'error');
              this.isLoadingFinance = false;
            })
            .getFinancialData(sheetID, this.selectedFinanceYear, this.selectedFinanceMonth);
        },

        // (เพิ่มฟังก์ชันใหม่ทั้งหมดด้านล่างนี้)

        renderAllFinanceCharts() {
          this.renderMonthlyRevenueExpenseBarChart();
          this.renderExpenseCategoryPieChart(); // <-- แก้ไขตรงนี้
          this.renderCarProfitabilityChart();   // <-- เพิ่มบรรทัดนี้
        },


        // เพิ่ม 2 ฟังก์ชันนี้เข้าไปใน app() object

        renderExpenseCategoryPieChart() {
          if (this.expenseCategoryChart) {
            this.expenseCategoryChart.destroy();
          }
          const chartEl = document.getElementById('expenseCategoryChart');
          if (!chartEl) return;

          const chartData = this.financeData.expenseByCategory || {};
          const labels = Object.keys(chartData);
          const series = Object.values(chartData);

          if (series.length > 0 && series.some(val => val > 0)) {
            const options = {
              series: series,
              chart: { type: 'donut', height: 350 },
              labels: labels,
              responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }],
              plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'รวมรายจ่าย' } } } } },
              dataLabels: { enabled: true, formatter: (val) => `${Math.round(val)}%` },
              legend: { position: 'bottom', fontFamily: 'Prompt, sans-serif' },
              tooltip: { y: { formatter: (val) => "฿" + val.toLocaleString('th-TH') } }
            };
            this.expenseCategoryChart = new ApexCharts(chartEl, options);
            this.expenseCategoryChart.render();
          } else {
            chartEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">ไม่มีข้อมูลรายจ่ายในเดือนนี้</div>`;
          }
        },



        renderCarProfitabilityChart() {
          if (this.carProfitabilityChart) {
            this.carProfitabilityChart.destroy();
          }
          const chartEl = document.getElementById('carProfitabilityChart');
          if (!chartEl) return;

          const chartData = this.financeData.profitByCar || {};
          const filteredData = Object.entries(chartData).filter(([car, data]) => data.revenue > 0 || data.expense > 0);

          if (filteredData.length > 0) {
            const categories = filteredData.map(item => item[0]);
            const revenues = filteredData.map(item => item[1].revenue);
            const expenses = filteredData.map(item => item[1].expense);

            const options = {
              series: [{
                name: 'รายรับ',
                data: revenues
              }, {
                name: 'รายจ่าย',
                data: expenses
              }],
              chart: {
                type: 'bar',
                height: 350,
                toolbar: { show: true }
              },
              plotOptions: {
                bar: {
                  horizontal: false, // <-- 1. เปลี่ยนเป็น false เพื่อเป็นกราฟแนวตั้ง
                  columnWidth: '60%',
                  borderRadius: 5
                }
              },
              dataLabels: {
                enabled: true,
                offsetY: -20, // <-- 2. เปลี่ยนเป็น offsetY เพื่อให้ป้ายอยู่เหนือกราฟ
                style: {
                  fontSize: '12px',
                  colors: ["#304758"]
                },
                formatter: (val) => val > 0 ? val.toLocaleString('th-TH') : ''
              },
              stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
              },
              xaxis: { // <-- 3. แกน X คือชื่อรถ
                categories: categories,
                labels: {
                  style: {
                    fontFamily: 'Prompt, sans-serif'
                  }
                }
              },
              yaxis: { // <-- 4. แกน Y คือจำนวนเงิน
                title: { text: 'จำนวนเงิน (บาท)' },
                labels: {
                  formatter: (val) => val.toLocaleString('th-TH')
                }
              },
              fill: { opacity: 1 },
              legend: {
                position: 'top',
                horizontalAlign: 'center'
              },
              colors: ['#22c55e', '#ef4444'], // สีเขียวสำหรับรายรับ, สีแดงสำหรับรายจ่าย
              tooltip: {
                y: {
                  formatter: (val) => "฿" + val.toLocaleString('th-TH')
                }
              }
            };
            this.carProfitabilityChart = new ApexCharts(chartEl, options);
            this.carProfitabilityChart.render();
          } else {
            chartEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">ไม่มีข้อมูลรายรับ-รายจ่ายรายคันในเดือนนี้</div>`;
          }
        },



        renderMonthlyRevenueExpenseBarChart() {
          if (this.monthlyRevenueExpenseBarChart) {
            this.monthlyRevenueExpenseBarChart.destroy();
          }

          const totalRevenue = this.financeSummary.totalRevenue || 0;
          const totalExpense = this.financeSummary.totalExpense || 0;

          const options = {
            series: [{
              name: 'ยอดรวม',
              data: [totalRevenue, totalExpense]
            }],
            chart: {
              type: 'bar',
              height: 350,
              toolbar: { show: false }
            },
            plotOptions: {
              bar: {
                columnWidth: '45%',
                distributed: true,
                borderRadius: 5,
              }
            },
            dataLabels: {
              enabled: false
            },
            legend: {
              show: false
            },
            xaxis: {
              categories: ['รายรับ', 'รายจ่าย'],
              labels: {
                formatter: (val, index) => {
                  const values = [this.financeSummary?.totalRevenue, this.financeSummary?.totalExpense];
                  if (index >= 0 && index < values.length && typeof values[index] === 'number') {
                    return `${val}\n฿${values[index].toLocaleString('th-TH')}`;
                  }
                  return val;
                },
                style: {
                  colors: ['#16a34a', '#dc2626'],
                  fontSize: '14px',
                  fontWeight: 'bold',
                  whiteSpace: 'pre-wrap'
                }
              }
            },
            yaxis: {
              labels: {
                formatter: (val) => val.toLocaleString('th-TH') + ' ฿'
              }
            },
            colors: ['#22c55e', '#ef4444']
          };

          const chartEl = document.getElementById('monthlyRevenueExpenseBarChart');
          if (chartEl) {
            if (totalRevenue > 0 || totalExpense > 0) {
              this.monthlyRevenueExpenseBarChart = new ApexCharts(chartEl, options);
              this.monthlyRevenueExpenseBarChart.render();
            } else {
              chartEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">ไม่มีข้อมูลสำหรับเดือนนี้</div>`;
            }
          }
        },





        renderExpenseCategoryPieChart() {
          const chartData = this.financeData.expenseByCategory || {};
          const labels = Object.keys(chartData);
          const series = Object.values(chartData);

          const options = {
            series: series,
            chart: { type: 'donut', height: 350 },
            labels: labels,
            responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }],
            plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'รวมรายจ่าย' } } } } },
            dataLabels: { enabled: true, formatter: (val) => `${Math.round(val)}%` },
            legend: { position: 'bottom' }
          };

          if (this.expenseCategoryChart) this.expenseCategoryChart.destroy();
          const chartEl = document.getElementById('expenseCategoryChart');
          if (chartEl) {
            this.expenseCategoryChart = new ApexCharts(chartEl, options);
            this.expenseCategoryChart.render();
          }
        },

        renderRevenueByCarBarChart() {
          if (this.revenueByCarChart) {
            this.revenueByCarChart.destroy();
          }

          const chartData = this.financeData.revenueByCar || {};
          const sortedData = Object.entries(chartData)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

          const categories = sortedData.map(item => item[0]);
          const seriesData = sortedData.map(item => item[1]);

          const chartEl = document.getElementById('revenueByCarChart');
          if (chartEl) {
            if (sortedData.length > 0) {
              const options = {
                series: [{ name: 'รายได้', data: seriesData }],
                chart: { type: 'bar', height: 350, toolbar: { show: false } },
                plotOptions: { bar: { borderRadius: 4, horizontal: true, } },
                dataLabels: {
                  enabled: true,
                  formatter: (val) => val.toLocaleString('th-TH') + "฿",
                  offsetX: 40,
                  style: {
                    colors: ['#fefffa']
                  }
                },
                xaxis: { categories: categories },
                colors: ['#4f46e5'] // สีม่วง Indigo
              };
              this.revenueByCarChart = new ApexCharts(chartEl, options);
              this.revenueByCarChart.render();
            } else {
              // แสดงข้อความเมื่อไม่มีข้อมูล
              chartEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">ไม่มีข้อมูลรายได้จากรถในเดือนนี้</div>`;
            }
          }
        },

        openAddFinanceModal() {
          this.newFinancialRecord = {
            วันที่: new Date().toISOString().split('T')[0], // วันที่วันนี้
            linkType: 'booking',
            หมายเลขการจอง: '',
            รถที่เกี่ยวข้อง: '',
            รายการ: '',
            ประเภท: 'รายจ่าย',
            จำนวนเงิน: ''
          };
          this.showAddFinanceModal = true;
        },

        openEditFinanceModal(record) {
          this.editingFinancialRecord = {
            ...record,
            วันที่: this.formatDateForInput(record.วันที่)
          };
          this.showEditFinanceModal = true;
        },


        formatDateForInput(dateStr) {
          const date = new Date(dateStr);
          if (isNaN(date)) return '';
          const yyyy = date.getFullYear();
          const mm = String(date.getMonth() + 1).padStart(2, '0');
          const dd = String(date.getDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
        },




        closeFinanceModal() {
          this.showAddFinanceModal = false;
          this.showEditFinanceModal = false;
        },

        saveNewFinancialRecord() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('บันทึกรายการสำเร็จ');
                this.loadFinancialData(); // << เพิ่มบรรทัดนี้เพื่อโหลดข้อมูลและกราฟใหม่
                this.closeFinanceModal();
              } else {
                this.showNotification(result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .addManualFinancialRecord(sheetID, this.newFinancialRecord);
        },

        updateFinancialRecord() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('อัปเดตรายการสำเร็จ');
                this.searchFinance(); // ค้นหาใหม่เพื่อรีเฟรช
                this.loadFinancialData(); // รีเฟรชข้อมูลสรุปและกราฟ
                this.closeFinanceModal();
              } else {
                this.showNotification(result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .updateFinancialRecord(sheetID, this.editingFinancialRecord.id, this.editingFinancialRecord);
        },

        searchFinance() {
          this.isLoadingFinance = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(result => {
              console.log('📦 result:', result);  // debug ตรงนี้
              if (result && result.success && Array.isArray(result.data)) {
                this.financeSearchResults = result.data;
              } else {
                this.financeSearchResults = [];
                this.showNotification('ไม่พบข้อมูล', 'info');
              }
              this.isLoadingFinance = false;
            })
            .withFailureHandler(error => {
              this.financeSearchResults = [];
              this.isLoadingFinance = false;
              this.showNotification('เกิดข้อผิดพลาดในการค้นหา: ' + error.message, 'error');
            })
            .searchFinancialRecords(sheetID, this.searchFinanceType, this.searchFinanceQuery);
        },

        confirmDeleteFinancialRecord(recordId) {
          Swal.fire({
            title: 'ยืนยันการลบ',
            text: "คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.deleteFinancialRecord(recordId);
            }
          });
        },

        deleteFinancialRecord(recordId) {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('ลบรายการสำเร็จ');
                this.searchFinance(); // ค้นหาใหม่
                this.loadFinancialData(); // รีเฟรชข้อมูลสรุป
              } else {
                this.showNotification(result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .deleteFinancialRecord(sheetID, recordId);
        },



        loadCommissionList() {
          // เช็ค Memory Cache ก่อน - ถ้ามีข้อมูลแล้วไม่ต้องโหลดซ้ำ
          if (this.commissionList && this.commissionList.length > 0) {
            console.log("[Debug] ใช้ commissionList จาก memory cache:", this.commissionList.length, "รายการ");
            return;
          }

          // เช็ค Local Storage Cache
          const cachedData = localStorage.getItem('commissionListCache');
          const cacheTime = localStorage.getItem('commissionListCacheTime');
          const ONE_HOUR = 60 * 60 * 1000; // 1 ชั่วโมง

          if (cachedData && cacheTime) {
            const elapsed = Date.now() - parseInt(cacheTime, 10);
            if (elapsed < ONE_HOUR) {
              try {
                this.commissionList = JSON.parse(cachedData);
                console.log("[Debug] ใช้ commissionList จาก localStorage cache:", this.commissionList.length, "รายการ");
                return;
              } catch (e) {
                console.warn("[Debug] localStorage cache ไม่สามารถ parse ได้, โหลดใหม่");
              }
            }
          }

          console.log("[Debug] กำลังโหลด commissionList จาก config");

          if (!this.config || !this.config["ค่าคอมมิชชั่นหลายรายการ"]) {
            this.commissionList = [];
            console.log("[Debug] ไม่มีข้อมูลคอมมิชชั่นใน config");
            return;
          }

          try {
            this.commissionList = JSON.parse(this.config["ค่าคอมมิชชั่นหลายรายการ"]);
            console.log("[Debug] โหลด commissionList สำเร็จ:", this.commissionList);

            // บันทึกลง Local Storage Cache
            localStorage.setItem('commissionListCache', JSON.stringify(this.commissionList));
            localStorage.setItem('commissionListCacheTime', Date.now().toString());
          } catch (e) {
            console.error("❌ ไม่สามารถแปลงค่าคอมมิชชั่นจาก config ได้", e);
            this.commissionList = [];
          }
        },

        addCommissionItem() {
          this.commissionList.push({ ...this.newCommission });
          this.newCommission = {
            ชื่อ: '',
            รูปแบบ: 'fixed',
            ค่าFixed: '',
            ค่าเปอร์เซ็นต์: '',
            vat: ''
          };
        },

        formatCommissionDetail(item) {
          if (item.รูปแบบ === 'fixed') {
            return `ค่าคอมตายตัว ${item.ค่าFixed} บาท/วัน`;
          } else if (item.รูปแบบ === 'percent+vat') {
            return `ค่าคอม ${item.ค่าเปอร์เซ็นต์}% + Vat ${item.vat || 0}%`;
          }
          return '';
        },

        saveCommissionConfig() {
          this.config["ค่าคอมมิชชั่นหลายรายการ"] = JSON.stringify(this.commissionList);

          google.script.run
            .withSuccessHandler(() => {
              alert('บันทึกค่าคอมมิชชั่นสำเร็จ');
              // อัปเดต Local Storage Cache
              localStorage.setItem('commissionListCache', JSON.stringify(this.commissionList));
              localStorage.setItem('commissionListCacheTime', Date.now().toString());
            })
            .updateSystemConfig({ config: this.config }, this.sheetID);
        },



        searchCars() {
          if (this.newBookingcarSearchQuery.trim() === '') {
            this.filteredCarOptions = [];
            return;
          }

          const query = this.newBookingcarSearchQuery.toLowerCase();
          this.filteredCarOptions = this.carOptions.filter(car =>
            car.toLowerCase().includes(query)
          );
        },

        selectCarFromSearch(car) {
          this.newRental.รถ = car;
          this.populateCarDetails();
          this.newBookingcarSearchQuery = '';
          this.showCarSearchResults = false;
          this.filteredCarOptions = [];
        },




        handleFileUpload(event, fileType) {
          const file = event.target.files[0];
          if (!file) {
            this.removeFile(fileType);
            return;
          }
          // เก็บไฟล์
          this.newRental[fileType + 'File'] = file;
          // สร้าง URL สำหรับ preview
          this.newRental[fileType + 'PreviewUrl'] = URL.createObjectURL(file);

          // Reset สถานะ OCR ถ้ามีการเลือกไฟล์ใหม่
          if (fileType === 'idCard') this.idCardProcessStatus = '';
          if (fileType === 'drivingLicense') this.drivingLicenseProcessStatus = '';
        },

        removeFile(fileType) {
          this.newRental[fileType + 'File'] = null;
          this.newRental[fileType + 'PreviewUrl'] = '';

          // เคลียร์สถานะ OCR ด้วย
          if (fileType === 'idCard') this.idCardProcessStatus = '';
          if (fileType === 'drivingLicense') this.drivingLicenseProcessStatus = '';
        },

        // แปลงไฟล์เป็น Base64
        fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
          });
        },

        async extractIdCardData() {
          if (!this.newRental.idCardFile) {
            this.showNotification('กรุณาเลือกรูปบัตรประชาชนก่อน', 'warning');
            return;
          }

          this.isIdCardProcessing = true;
          this.idCardProcessStatus = 'กำลังประมวลผล...';

          try {
            const base64String = await this.fileToBase64(this.newRental.idCardFile);
            const fileType = this.newRental.idCardFile.type;

            google.script.run
              .withSuccessHandler(result => {
                this.isIdCardProcessing = false;
                if (result && !result.error) {
                  this.idCardProcessStatus = 'ดึงข้อมูลสำเร็จ! โปรดตรวจสอบความถูกต้อง';
                  // Update UI with result
                  if (result.th_name) {
                    this.newRental.ชื่อลูกค้า = result.th_name.replace(/คำนำหน้า|นาย|นาง|นางสาว|เด็กชาย|เด็กหญิง/g, '').trim();
                  }
                  if (result.id_number) {
                    this.newRental.เลขบัตรประชาชน = result.id_number.replace(/\s/g, '');
                    this.checkIdCardHistory({ target: { value: this.newRental.เลขบัตรประชาชน } });
                  }
                  if (result.address) {
                    this.newRental.ที่อยู่ลูกค้า = result.address;
                  }
                } else {
                  this.idCardProcessStatus = 'ไม่สำเร็จ: ไม่พบข้อมูลในภาพ';
                  console.error('OCR Error:', result);
                }
              })
              .withFailureHandler(error => {
                this.isIdCardProcessing = false;
                this.idCardProcessStatus = 'ไม่สำเร็จ: เกิดข้อผิดพลาด';
                console.error('OCR Failure:', error);
              })
              .processIDImage(base64String, fileType);

          } catch (error) {
            this.isIdCardProcessing = false;
            this.idCardProcessStatus = 'ไม่สำเร็จ: เกิดข้อผิดพลาดในการอ่านไฟล์';
            console.error('File Read Error:', error);
          }
        },




        openLargeImagePreview(imageUrl) {
          if (imageUrl) {
            this.largePreviewImageUrl = imageUrl;
            this.showImagePreviewModal = true;
          }
        },



        async extractDrivingLicenseData() {
          if (!this.newRental.drivingLicenseFile) {
            this.showNotification('กรุณาเลือกรูปใบขับขี่ก่อน', 'warning');
            return;
          }

          this.isDrivingLicenseProcessing = true;
          this.drivingLicenseProcessStatus = 'กำลังประมวลผล...';

          try {
            const base64String = await this.fileToBase64(this.newRental.drivingLicenseFile);
            const fileName = this.newRental.drivingLicenseFile.name;

            google.script.run
              .withSuccessHandler(text => {
                this.isDrivingLicenseProcessing = false;
                if (text && text !== 'ไม่พบข้อมูลที่ต้องการ' && !text.includes('เกิดข้อผิดพลาด')) {
                  this.drivingLicenseProcessStatus = 'ดึงข้อมูลสำเร็จ!';
                  this.newRental.หมายเลขใบขับขี่ = text;
                } else {
                  this.drivingLicenseProcessStatus = 'ไม่สำเร็จ: ' + text;
                }
              })
              .withFailureHandler(error => {
                this.isDrivingLicenseProcessing = false;
                this.drivingLicenseProcessStatus = 'ไม่สำเร็จ: เกิดข้อผิดพลาด';
                console.error('OCR Failure:', error);
              })
              .getTextFromImage(base64String, fileName);

          } catch (error) {
            this.isDrivingLicenseProcessing = false;
            this.drivingLicenseProcessStatus = 'ไม่สำเร็จ: เกิดข้อผิดพลาดในการอ่านไฟล์';
            console.error('File Read Error:', error);
          }
        },




        toggleUnspecifiedMode() {
          // สลับค่า mode
          this.unspecifiedVehicleMode = !this.unspecifiedVehicleMode;

          // ถ้าเปิดโหมดไม่ระบุรถ ให้ดึงค่าจาก config
          if (this.unspecifiedVehicleMode) {
            this.setDefaultValuesForUnspecifiedMode();
          } else {
            // ถ้าปิดโหมด ให้เคลียร์ชื่อรถที่พิมพ์
            this.unspecifiedVehicleName = '';

            // รีเซ็ตค่าต่างๆ กลับเป็นเดิม (ถ้าต้องการ)
            this.newRental.รถ = '';
            this.newRental.ทะเบียนรถ = '';
          }
        },

        // Method สำหรับตั้งค่าเริ่มต้นเมื่อเปิดโหมดไม่ระบุรถ
        setDefaultValuesForUnspecifiedMode() {
          try {
            // ตรวจสอบว่ามี config หรือไม่
            if (!this.config) {
              console.warn('ไม่พบข้อมูล config สำหรับตั้งค่าเริ่มต้น');
              return;
            }

            // ตั้งค่าเงินประกันความเสียหาย
            if (this.config.เงินประกันความเสียหายเริ่มต้น !== undefined &&
              this.config.เงินประกันความเสียหายเริ่มต้น !== null &&
              this.config.เงินประกันความเสียหายเริ่มต้น !== '') {

              this.newRental.เงินประกันความเสียหาย = this.config.เงินประกันความเสียหายเริ่มต้น.toString();
              console.log('ตั้งค่าเงินประกันความเสียหาย:', this.config.เงินประกันความเสียหายเริ่มต้น);
            }

            // ตั้งค่าค่ามัดจำคิวรถ
            if (this.config.ค่ามัดจำคิวรถเริ่มต้น !== undefined &&
              this.config.ค่ามัดจำคิวรถเริ่มต้น !== null &&
              this.config.ค่ามัดจำคิวรถเริ่มต้น !== '') {

              this.newRental.ค่ามัดจำคิวรถ = this.config.ค่ามัดจำคิวรถเริ่มต้น.toString();
              console.log('ตั้งค่าค่ามัดจำคิวรถ:', this.config.ค่ามัดจำคิวรถเริ่มต้น);
            }

            // คำนวณยอดรวมใหม่หลังจากที่ตั้งค่าเสร็จ
            // ใช้ setTimeout เพื่อให้ Alpine.js อัปเดต DOM ก่อน
            setTimeout(() => {
              if (typeof this.calculateFinalAmount === 'function') {
                this.calculateFinalAmount();
                console.log('คำนวณยอดรวมใหม่เสร็จแล้ว');
              }
            }, 100);

            // แสดงข้อความแจ้งให้ผู้ใช้ทราบ
            if (typeof this.showNotification === 'function') {
              this.showNotification('ตั้งค่าเริ่มต้นสำหรับโหมดไม่ระบุรถเรียบร้อยแล้ว', 'success');
            }

          } catch (error) {
            console.error('เกิดข้อผิดพลาดในการตั้งค่าเริ่มต้น:', error);
            if (typeof this.showNotification === 'function') {
              this.showNotification('เกิดข้อผิดพลาดในการตั้งค่าเริ่มต้น', 'error');
            }
          }
        },



        /**
         * โหลดสถิติรายการรอหารถ - เวอร์ชัน Debug
         */
        loadPendingVehicleStats() {
          console.log('🔄 Loading pending vehicle stats...');

          const sheetID = localStorage.getItem('sheetID') || '';
          console.log('📋 Sheet ID:', sheetID);

          if (!sheetID) {
            console.error('❌ No sheet ID found');
            this.pendingVehicleStats = {
              total: 0,
              todayPickup: 0,
              tomorrowPickup: 0,
              urgent: 0,
              upcoming: 0
            };
            return;
          }

          console.log('📡 Calling getPendingVehicleStats with sheetID:', sheetID);

          google.script.run
            .withSuccessHandler(result => {
              console.log('✅ Success handler called');
              console.log('📥 Raw result:', result);
              console.log('🔍 Result type:', typeof result);
              console.log('🔍 Result null check:', result === null);
              console.log('🔍 Result undefined check:', result === undefined);

              if (result !== null && result !== undefined) {
                console.log('📊 Result has success property:', 'success' in result);
                console.log('📊 Result.success value:', result.success);

                if (result.success) {
                  this.pendingVehicleStats = result.stats;
                  console.log('✅ Pending vehicle stats loaded:', result.stats);
                } else {
                  console.error('❌ Failed to load pending vehicle stats:', result.message);
                  this.pendingVehicleStats = {
                    total: 0,
                    todayPickup: 0,
                    tomorrowPickup: 0,
                    urgent: 0,
                    upcoming: 0
                  };
                }
              } else {
                console.error('❌ Result is null or undefined');
                this.pendingVehicleStats = {
                  total: 0,
                  todayPickup: 0,
                  tomorrowPickup: 0,
                  urgent: 0,
                  upcoming: 0
                };
              }
            })
            .withFailureHandler(error => {
              console.error('💥 Failure handler called');
              console.error('❌ Error loading pending vehicle stats:', error);
              console.error('❌ Error type:', typeof error);
              console.error('❌ Error details:', JSON.stringify(error));

              this.pendingVehicleStats = {
                total: 0,
                todayPickup: 0,
                tomorrowPickup: 0,
                urgent: 0,
                upcoming: 0
              };
            })
            .getPendingVehicleStats(sheetID);

          console.log('📡 Function call initiated');
        },



        loadPendingVehicleBookings() {
          console.log('Loading pending vehicle bookings...');
          this.isLoading = true;

          const sheetID = localStorage.getItem('sheetID') || '';
          if (!sheetID) {
            this.showNotification('ไม่พบรหัสชีท', 'error');
            this.isLoading = false;
            return;
          }

          google.script.run
            .withSuccessHandler(result => {
              this.isLoading = false;
              // เพิ่ม null check
              if (result && result.success) {
                this.pendingVehicleBookings = result.bookings;
                this.showPendingVehicleModal = true;
                console.log(`Loaded ${result.count} pending vehicle bookings`);
              } else {
                this.showNotification('ไม่สามารถโหลดรายการรอหารถได้: ' + (result ? result.message : 'ไม่ได้รับข้อมูล'), 'error');
              }
            })
            .withFailureHandler(error => {
              this.isLoading = false;
              this.showNotification('เกิดข้อผิดพลาดในการโหลดรายการรอหารถ', 'error');
              console.error('Error loading pending vehicle bookings:', error);
            })
            .getPendingVehicleBookings(sheetID);
        },

        /**
         * ปิด Modal รายการรอหารถ
         */
        closePendingVehicleModal() {
          this.showPendingVehicleModal = false;
          setTimeout(() => {
            this.pendingVehicleBookings = [];
          }, 300); // รอให้ modal ปิดเสร็จ
          this.loadPendingVehicleStats();
        },

        /**
         * เปิด Modal สำหรับระบุรถ
         */
        openAssignVehicleModal(booking) {
          console.log('Opening vehicle assignment for:', booking.หมายเลขการจอง);

          // ปิด Modal รายการรอหารถก่อน
          this.showPendingVehicleModal = false;

          // เตรียมข้อมูล
          this.currentAssignBooking = booking;

          // Reset form data พร้อมข้อมูลเริ่มต้น
          this.partnerCarData = {
            fullCarName: booking.รถ || '', // เติมชื่อรถที่ลูกค้าต้องการเป็นค่าเริ่มต้น
            licensePlate: '',
            actualRevenue: 0,
            deliveryMethod: 'ส่งเอง',
            returnMethod: 'รับคืนเอง',
            additionalNotes: '',
            // ใช้ข้อมูลสถานที่เดิมเป็นค่าเริ่มต้น
            pickupLocation: booking.สถานที่รับรถ || '',
            returnLocation: booking.สถานที่คืนรถ || ''
          };

          // รีเซ็ตขั้นตอน
          this.assignmentStep = 1;
          this.contractLanguage = 'th'; // ค่าเริ่มต้น
          this.isProcessingAssignment = false;

          // เปิด Modal ระบุรถ (delay เล็กน้อยเพื่อ smooth transition)
          setTimeout(() => {
            this.showAssignVehicleModal = true;
          }, 300);
        },

        /**
         * ปิด Modal ระบุรถ
         */
        closeAssignVehicleModal() {
          this.showAssignVehicleModal = false;
          this.currentAssignBooking = null;
          this.assignmentStep = 1; // รีเซ็ตขั้นตอนกลับไปขั้นตอนที่ 1

          // รีเซ็ตข้อมูลฟอร์ม
          this.partnerCarData = {
            fullCarName: '',
            licensePlate: '',
            actualRevenue: 0,
            deliveryMethod: 'ส่งเอง',
            returnMethod: 'รับคืนเอง',
            additionalNotes: '',
            pickupLocation: '',
            returnLocation: ''
          };

          // รีเซ็ตสถานะการประมวลผล
          this.isProcessingAssignment = false;

          // เปิด Modal รายการรอหารถกลับมา (หลังจาก delay เล็กน้อย)
          setTimeout(() => {
            this.showPendingVehicleModal = true;
            this.loadPendingVehicleBookings(); // รีเฟรชข้อมูล
          }, 300);
        },



        nextAssignmentStep() {
          if (this.canProceedToNextStep()) {
            this.assignmentStep++;
          }
        },

        prevAssignmentStep() {
          if (this.assignmentStep > 1) {
            this.assignmentStep--;
          }
        },

        canProceedToNextStep() {
          switch (this.assignmentStep) {
            case 1: // ขั้นตอนระบุข้อมูลรถ
              return this.partnerCarData.fullCarName.trim() !== '' &&
                this.partnerCarData.licensePlate.trim() !== '' &&
                this.partnerCarData.actualRevenue > 0;
            case 2: // ขั้นตอนการส่ง-รับรถ
              return this.partnerCarData.deliveryMethod !== '' &&
                this.partnerCarData.returnMethod !== '';
            default:
              return true;
          }
        },


        async createAssignedVehicleContract() {
          this.isProcessingAssignment = true;

          try {
            // ตรวจสอบข้อมูลที่จำเป็น
            if (!this.partnerCarData.fullCarName.trim()) {
              this.showNotification('❌ กรุณากรอกชื่อรถเต็ม', 'error');
              return;
            }

            if (!this.partnerCarData.licensePlate.trim()) {
              this.showNotification('❌ กรุณากรอกป้ายทะเบียนรถ', 'error');
              return;
            }

            if (!this.partnerCarData.actualRevenue || this.partnerCarData.actualRevenue <= 0) {
              this.showNotification('❌ กรุณากรอกรายได้สุทธิที่ถูกต้อง', 'error');
              return;
            }

            // สร้างรูปแบบ "ชื่อรถ (ป้ายทะเบียน)" สำหรับบันทึกในชีท
            const carWithLicensePlate = this.partnerCarData.licensePlate.trim()
              ? `${this.partnerCarData.fullCarName.trim()} (${this.partnerCarData.licensePlate.trim()})`
              : this.partnerCarData.fullCarName.trim();

            // รวมข้อมูลการจองกับข้อมูลรถที่ระบุ
            const completeData = {
              ...this.currentAssignBooking,

              // ข้อมูลรถ - รูปแบบใหม่
              รถ: carWithLicensePlate,  // ✅ รูปแบบ "ชื่อรถ (ป้ายทะเบียน)"
              ทะเบียนรถ: this.partnerCarData.licensePlate.trim(),
              รายได้สุทธิ: this.partnerCarData.actualRevenue,

              // ข้อมูลการส่ง-รับรถ
              วิธีการส่งรถ: this.partnerCarData.deliveryMethod,
              วิธีการรับคืน: this.partnerCarData.returnMethod,
              หมายเหตุเพิ่มเติม: this.partnerCarData.additionalNotes || '',

              // ข้อมูลสถานที่ - จะใช้ค่าใหม่ถ้ามีการแก้ไข หรือค่าเดิมถ้าไม่แก้ไข
              สถานที่รับรถ: this.partnerCarData.pickupLocation?.trim() || this.currentAssignBooking.สถานที่รับรถ,
              สถานที่คืนรถ: this.partnerCarData.returnLocation?.trim() || this.currentAssignBooking.สถานที่คืนรถ,

              // ข้อมูลสถานะและเวลา
              สถานะ: 'จอง',
              วันที่ระบุรถ: new Date().toISOString()
            };

            // แสดงข้อมูลที่จะส่งไป (สำหรับ debug)
            console.log('📝 Complete data to be sent:', {
              หมายเลขการจอง: completeData.หมายเลขการจอง,
              รถ: completeData.รถ,
              ทะเบียนรถ: completeData.ทะเบียนรถ,
              รายได้สุทธิ: completeData.รายได้สุทธิ,
              สถานที่รับรถ: completeData.สถานที่รับรถ,
              สถานที่คืนรถ: completeData.สถานที่คืนรถ,
              วิธีการส่งรถ: completeData.วิธีการส่งรถ,
              วิธีการรับคืน: completeData.วิธีการรับคืน
            });

            const sheetID = localStorage.getItem('sheetID') || '';
            if (!sheetID) {
              this.showNotification('❌ ไม่พบรหัสชีท กรุณาเข้าสู่ระบบใหม่', 'error');
              return;
            }

            // เรียก Google Apps Script
            const result = await new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .assignVehicleAndCreateContract(completeData, this.contractLanguage, sheetID);
            });

            if (result && result.success) {
              // แสดงข้อความสำเร็จพร้อมรายละเอียด
              let successMessage = '✅ ระบุรถและสร้างสัญญาเช่าเสร็จสิ้น!';
              if (result.contractUrl) {
                successMessage += '\n📄 สัญญาเช่าถูกสร้างแล้ว';
              }
              if (result.contractLanguage) {
                successMessage += `\n🌐 ภาษาสัญญา: ${result.contractLanguage === 'th' ? 'ไทย' : 'English'}`;
              }

              this.showNotification(successMessage, 'success');

              // ปิด modal และรีเซ็ตข้อมูล
              this.closeAssignVehicleModal();

              // โหลดข้อมูลสถิติใหม่
              this.loadSummaryData();

              // ถ้ามี URL สัญญา ให้เปิดในแท็บใหม่
              if (result.contractUrl) {
                setTimeout(() => {
                  if (confirm('ต้องการเปิดสัญญาเช่าที่สร้างใหม่หรือไม่?')) {
                    window.open(result.contractUrl, '_blank');
                  }
                }, 1000);
              }

            } else {
              const errorMessage = result?.message || 'ไม่ทราบสาเหตุ';
              this.showNotification('❌ เกิดข้อผิดพลาด: ' + errorMessage, 'error');
              console.error('Assignment failed:', result);
            }

          } catch (error) {
            console.error('❌ Error in createAssignedVehicleContract:', error);

            // แสดงข้อความข้อผิดพลาดที่เข้าใจง่าย
            let errorMessage = 'เกิดข้อผิดพลาดในการระบุรถ';
            if (error.message) {
              errorMessage += ': ' + error.message;
            }

            // ถ้าเป็น network error
            if (error.message && error.message.includes('network')) {
              errorMessage = 'เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาตรวจสอบอินเทอร์เน็ต';
            }

            // ถ้าเป็น timeout error  
            if (error.message && error.message.includes('timeout')) {
              errorMessage = 'การดำเนินการใช้เวลานานเกินไป กรุณาลองใหม่อีกครั้ง';
            }

            this.showNotification('❌ ' + errorMessage, 'error');

          } finally {
            // รีเซ็ตสถานะการประมวลผล
            this.isProcessingAssignment = false;
          }
        },





        /**
         * ฟังก์ชันคำนวณจำนวนวันก่อนรับรถ - ใช้ข้อมูลที่คำนวณมาแล้ว
         */
        getDaysUntilPickup(booking) {
          // ใช้ข้อมูลที่คำนวณมาจาก GS แล้ว
          if (booking && typeof booking.จำนวนวันที่เหลือ === 'number') {
            return booking.จำนวนวันที่เหลือ;
          }

          // สำรองเผื่อข้อมูลไม่มี (แต่ไม่น่าเกิด)
          if (!booking || !booking.วันที่เช่าISO) return 999;

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const pickup = new Date(booking.วันที่เช่าISO);
          pickup.setHours(0, 0, 0, 0);

          const diffTime = pickup.getTime() - today.getTime();
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          return diffDays;
        },

        /**
         * ฟังก์ชันแสดงสี badge ตามความเร่งด่วน - ใช้สถานะที่คำนวณมาแล้ว
         */
        getUrgencyClass(booking) {
          if (!booking) return 'bg-gray-100 text-gray-800';

          // ใช้สถานะความเร่งด่วนที่คำนวณมาแล้ว
          if (booking.สถานะความเร่งด่วน) {
            switch (booking.สถานะความเร่งด่วน) {
              case 'วันนี้':
                return 'bg-red-100 text-red-800';
              case 'พรุ่งนี้':
                return 'bg-orange-100 text-orange-800';
              case 'เร่งด่วน':
                return 'bg-yellow-100 text-yellow-800';
              default:
                return 'bg-green-100 text-green-800';
            }
          }

          // สำรอง: ใช้จำนวนวันที่เหลือ
          const daysUntil = this.getDaysUntilPickup(booking);
          if (daysUntil === 0) return 'bg-red-100 text-red-800';
          if (daysUntil === 1) return 'bg-orange-100 text-orange-800';
          if (daysUntil <= 2) return 'bg-yellow-100 text-yellow-800';
          return 'bg-green-100 text-green-800';
        },

        /**
         * ฟังก์ชันแสดงข้อความสถานะ
         */
        getUrgencyText(booking) {
          if (!booking) return '';

          if (booking.สถานะความเร่งด่วน) {
            return booking.สถานะความเร่งด่วน;
          }

          // สำรอง
          const daysUntil = this.getDaysUntilPickup(booking);
          if (daysUntil === 0) return 'วันนี้';
          if (daysUntil === 1) return 'พรุ่งนี้';
          if (daysUntil <= 2) return 'เร่งด่วน';
          return `อีก ${daysUntil} วัน`;
        },

        /**
         * ฟังก์ชันรูปแบบการแสดงวันที่ - ใช้ข้อมูลที่แปลงมาแล้ว
         */
        formatThaiDate(dateString) {
          // ถ้าเป็นรูปแบบไทยแล้วใช้เลย
          if (dateString && dateString.includes('/')) {
            return dateString;
          }

          // ถ้าเป็น ISO format ให้แปลง
          if (!dateString) return '';

          try {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });
          } catch (e) {
            return dateString;
          }
        },

        /**
         * ฟังก์ชันจัดกลุ่มรายการตามสถานะ
         */
        getGroupedBookings() {
          if (!this.pendingVehicleBookings || this.pendingVehicleBookings.length === 0) {
            return { วันนี้: [], พรุ่งนี้: [], เร่งด่วน: [], ปกติ: [] };
          }

          const groups = { วันนี้: [], พรุ่งนี้: [], เร่งด่วน: [], ปกติ: [] };

          this.pendingVehicleBookings.forEach(booking => {
            const status = booking.สถานะความเร่งด่วน || 'ปกติ';
            if (groups[status]) {
              groups[status].push(booking);
            } else {
              groups.ปกติ.push(booking);
            }
          });

          return groups;
        },



        calculateRentalDurationForDisplay() {
          try {
            // ตรวจสอบข้อมูลที่จำเป็น
            if (!this.newRental.วันที่เช่า || !this.newRental.วันที่คืน ||
              !this.newRental.เวลารับรถ || !this.newRental.เวลาคืนรถ) {
              return {
                rentalDays: 0,
                remainingHours: 0,
                rentalPeriodText: '',
                extraHoursNote: '',
                showExtraHoursWarning: false
              };
            }

            // สร้าง Date objects
            const startDate = new Date(`${this.newRental.วันที่เช่า}T${this.newRental.เวลารับรถ}:00`);
            const endDate = new Date(`${this.newRental.วันที่คืน}T${this.newRental.เวลาคืนรถ}:00`);

            // ตรวจสอบความถูกต้องของวันที่
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
              return {
                rentalDays: 0,
                remainingHours: 0,
                rentalPeriodText: 'ข้อมูลวันที่ไม่ถูกต้อง',
                extraHoursNote: '',
                showExtraHoursWarning: false
              };
            }

            // ตรวจสอบว่าวันคืนต้องมาหลังวันเช่า
            if (endDate <= startDate) {
              return {
                rentalDays: 0,
                remainingHours: 0,
                rentalPeriodText: 'วันที่คืนต้องมาหลังวันที่เช่า',
                extraHoursNote: '',
                showExtraHoursWarning: false
              };
            }

            // คำนวณความต่างในชั่วโมง
            const diffMs = endDate.getTime() - startDate.getTime();
            const diffHours = diffMs / (1000 * 60 * 60);

            // คำนวณจำนวนวันเต็มและชั่วโมงที่เหลือ
            const diffDays = Math.floor(diffHours / 24);
            const remainingHours = Math.floor(diffHours % 24);

            // ดึงค่าชั่วโมงที่คิดเพิ่ม
            const extraHoursThreshold = parseFloat(this.config?.จำนวนชั่วโมงคิดเพิ่มเป็นหนึ่งวัน) || 4;

            // คำนวณจำนวนวันที่ต้องจ่าย
            let rentalDays = diffDays;
            let showExtraHoursWarning = false;

            if (remainingHours > extraHoursThreshold) {
              rentalDays += 1;
              showExtraHoursWarning = true;
            }

            // ถ้าเป็นศูนย์วัน ให้นับเป็น 1 วัน
            rentalDays = Math.max(1, rentalDays);

            // สร้างข้อความแสดงระยะเวลาเช่า
            let rentalPeriodText = `${rentalDays} วัน`;
            if (remainingHours > 0 && remainingHours <= extraHoursThreshold) {
              rentalPeriodText += ` ${remainingHours} ชั่วโมง`;
            }

            // สร้างข้อความหมายเหตุ
            let extraHoursNote = '';
            if (showExtraHoursWarning && extraHoursThreshold > 0) {
              extraHoursNote = `เกิน ${extraHoursThreshold} ชั่วโมง คิดเพิ่มเป็น 1 วัน`;
            }

            return {
              rentalDays,
              remainingHours,
              rentalPeriodText,
              extraHoursNote,
              showExtraHoursWarning,
              totalHours: Math.round(diffHours * 100) / 100 // ปัดทศนิยม 2 ตำแหน่ง
            };

          } catch (error) {
            console.error("เกิดข้อผิดพลาดในการคำนวณระยะเวลาเช่า:", error);
            return {
              rentalDays: 0,
              remainingHours: 0,
              rentalPeriodText: 'เกิดข้อผิดพลาดในการคำนวณ',
              extraHoursNote: '',
              showExtraHoursWarning: false
            };
          }
        },

        // ฟังก์ชันอัปเดตการแสดงผล
        updateRentalDurationDisplay() {
          const duration = this.calculateRentalDurationForDisplay();

          // อัปเดต DOM elements
          const durationElement = document.getElementById('rental-duration-display');
          const noteElement = document.getElementById('rental-duration-note');

          if (durationElement) {
            durationElement.textContent = duration.rentalPeriodText;

            // เปลี่ยนสีตามสถานะ
            if (duration.showExtraHoursWarning) {
              durationElement.className = 'text-orange-600 font-bold text-lg md:text-xl';
            } else if (duration.rentalPeriodText.includes('ข้อผิดพลาด') || duration.rentalPeriodText.includes('ไม่ถูกต้อง')) {
              durationElement.className = 'text-red-600 font-bold text-lg md:text-xl';
            } else {
              durationElement.className = 'text-green-600 font-bold text-lg md:text-xl';
            }
          }

          if (noteElement) {
            if (duration.extraHoursNote) {
              noteElement.textContent = duration.extraHoursNote;
              noteElement.style.display = 'block';
              noteElement.className = 'text-xs text-orange-600 mt-1 bg-orange-100 px-2 py-1 rounded-full';
            } else {
              noteElement.style.display = 'none';
            }
          }
        },

        // ฟังก์ชันตั้งค่า listeners สำหรับการอัปเดตแบบ Real-time
        setupRentalDurationListeners() {
          // สร้าง debounced function เพื่อลดการเรียกใช้งานบ่อยเกินไป
          let timeoutId;
          const debouncedUpdate = () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
              this.updateRentalDurationDisplay();
            }, 300); // รอ 300ms หลังจากผู้ใช้หยุดพิมพ์
          };

          // เพิ่ม event listeners ให้กับ input fields
          const fieldsToWatch = [
            'วันที่เช่า',
            'วันที่คืน',
            'เวลารับรถ',
            'เวลาคืนรถ'
          ];

          fieldsToWatch.forEach(field => {
            this.$watch(`newRental.${field}`, () => {
              debouncedUpdate();
            });
          });
        },

        // ฟังก์ชันเริ่มต้นสำหรับหน้าสร้างรายการเช่าใหม่
        initNewRentalPage() {
          // เรียกใช้เมื่อเข้าหน้าสร้างรายการเช่าใหม่
          this.setupRentalDurationListeners();
          this.updateRentalDurationDisplay();
        },



        getRentalItemClass(item) {
          if (!item || !item.สถานะ) {
            return 'bg-green-50 border-green-100';
          }

          const status = item.สถานะ.toLowerCase().trim();

          switch (status) {
            case 'รอหารถ':
              return 'bg-orange-50 border-orange-200';
            case 'กำลังดำเนินการ':
            case 'กำลังเช่า':
            case 'จอง':
              return 'bg-green-50 border-green-100';
            case 'เสร็จสิ้น':
            case 'คืนแล้ว':
              return 'bg-blue-50 border-blue-100';
            case 'ยกเลิก':
              return 'bg-red-50 border-red-100';
            case 'รอยืนยัน':
              return 'bg-yellow-50 border-yellow-100';
            default:
              return 'bg-gray-50 border-gray-100';
          }
        },

        getStatusBadgeClass(item) {
          if (!item || !item.สถานะ) {
            return 'bg-green-100 text-green-800';
          }

          const status = item.สถานะ.toLowerCase().trim();

          switch (status) {
            case 'รอหารถ':
              return 'bg-orange-100 text-orange-800';
            case 'กำลังดำเนินการ':
            case 'กำลังเช่า':
            case 'จอง':
              return 'bg-green-100 text-green-800';
            case 'เสร็จสิ้น':
            case 'คืนแล้ว':
              return 'bg-blue-100 text-blue-800';
            case 'ยกเลิก':
              return 'bg-red-100 text-red-800';
            case 'รอยืนยัน':
              return 'bg-yellow-100 text-yellow-800';
            default:
              return 'bg-gray-100 text-gray-800';
          }
        },

        getDateIconClass(item) {
          if (!item || !item.สถานะ) {
            return 'fas fa-calendar text-green-500';
          }

          const status = item.สถานะ.toLowerCase().trim();

          switch (status) {
            case 'รอหารถ':
              return 'fas fa-clock text-orange-500';
            case 'กำลังดำเนินการ':
            case 'กำลังเช่า':
            case 'จอง':
              return 'fas fa-calendar text-green-500';
            case 'เสร็จสิ้น':
            case 'คืนแล้ว':
              return 'fas fa-check-circle text-blue-500';
            case 'ยกเลิก':
              return 'fas fa-times-circle text-red-500';
            case 'รอยืนยัน':
              return 'fas fa-exclamation-circle text-yellow-500';
            default:
              return 'fas fa-calendar text-gray-500';
          }
        },

        getDurationTextClass(item) {
          if (!item || !item.สถานะ) {
            return 'text-green-600';
          }

          const status = item.สถานะ.toLowerCase().trim();

          switch (status) {
            case 'รอหารถ':
              return 'text-orange-600';
            case 'กำลังดำเนินการ':
            case 'กำลังเช่า':
            case 'จอง':
              return 'text-green-600';
            case 'เสร็จสิ้น':
            case 'คืนแล้ว':
              return 'text-blue-600';
            case 'ยกเลิก':
              return 'text-red-600';
            case 'รอยืนยัน':
              return 'text-yellow-600';
            default:
              return 'text-gray-600';
          }
        },



        checkAndShowTutorial() {
          const hasSeenTutorial = localStorage.getItem('hasSeenUnspecifiedVehicleTutorial');
          if (!hasSeenTutorial) {
            // แสดง tutorial หลังจาก delay เล็กน้อย
            setTimeout(() => {
              this.showTutorial = true;
            }, 500);
            return true; // แสดงแล้ว
          }
          return false; // ไม่แสดง
        },

        // ฟังก์ชันสำหรับบังคับแสดง tutorial (สำหรับทดสอบ)
        forcShowTutorial() {
          this.currentStep = 1;
          this.showTutorial = true;
        },

        closeTutorial() {
          this.showTutorial = false;
          // บันทึกว่าเคยดู tutorial แล้ว
          localStorage.setItem('hasSeenUnspecifiedVehicleTutorial', 'true');
          localStorage.setItem('tutorialCompletedAt', new Date().toISOString());
        },

        completeTutorial() {
          this.showTutorial = false;
          // บันทึกว่าดู tutorial ครบแล้ว
          localStorage.setItem('hasSeenUnspecifiedVehicleTutorial', 'true');
          localStorage.setItem('tutorialCompletedAt', new Date().toISOString());
          localStorage.setItem('tutorialCompletedFully', 'true');

          // แสดงข้อความยินดี
          if (typeof this.showNotification === 'function') {
            this.showNotification('🎉 ยินดีต้อนรับสู่ฟีเจอร์ใหม่! พร้อมเพิ่มยอดขายแล้ว', 'success');
          }
        },



        loadCompleteOnlineBookingData() {
          console.log('🔄 Loading complete online booking data...');
          this.isLoadingCompleteData = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                // กำหนดค่าข้อมูลทั้งหมดจากผลลัพธ์
                this.onlineBookingSystemEnabled = result.systemStatus;
                this.vehiclesOnlineBookingList = result.allVehicles;
                this.availableVehiclesForPricing = result.activeVehicles;
                this.priceRulesConfiguration = result.pricingRules;
                this.vehicleGroupsForPricing = result.vehicleGroups;
                this.thaiHolidays = result.holidays;

                console.log('✅ Complete online booking data loaded successfully');
                this.showNotification('โหลดข้อมูลทั้งหมดเรียบร้อย', 'success');

                // โหลดรายการเช่าออนไลน์แยกต่างหาก
                this.loadOnlineRentalsData();
              } else {
                this.showNotification('โหลดข้อมูลไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoadingCompleteData = false;
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoadingCompleteData = false;
              console.error('❌ Error loading complete data:', error);
            })
            .getCompleteOnlineBookingManagementData(sheetID);
        },

        /**
         * โหลดข้อมูลเฉพาะส่วน "รายชื่อรถที่เปิดให้จองออนไลน์"
         */
        loadAllVehiclesWithOnlineStatus() {
          this.isLoadingVehiclesOnlineList = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.vehiclesOnlineBookingList = result.vehicles;
                console.log('✅ Loaded vehicles with online status:', result.vehicles.length);
              } else {
                this.showNotification('โหลดข้อมูลรถไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoadingVehiclesOnlineList = false;
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoadingVehiclesOnlineList = false;
            })
            .getAllVehiclesWithOnlineBookingStatus(sheetID);
        },

        /**
         * โหลดข้อมูลเฉพาะส่วน "ตั้งค่ากฎราคา"
         */
        loadActiveVehiclesForPricing() {
          this.isLoadingPricingVehicles = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.availableVehiclesForPricing = result.vehicles;
                this.priceRulesConfiguration = result.rules;
                this.vehicleGroupsForPricing = result.groups;
                this.thaiHolidays = result.holidays;
                console.log('✅ Loaded pricing management data');
              } else {
                this.showNotification('โหลดข้อมูลการตั้งราคาไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoadingPricingVehicles = false;
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoadingPricingVehicles = false;
            })
            .getPricingRulesManagementData(sheetID);
        },

        /**
         * โหลดรายการเช่าออนไลน์
         */
        loadOnlineRentalsData() {
          this.isLoadingRentals = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          console.log('🔄 Loading online rentals data...');

          // ตั้ง timeout
          const timeoutId = setTimeout(() => {
            console.log('⏰ Request timeout for online rentals');
            this.showNotification('การโหลดรายการเช่าใช้เวลานานเกินไป', 'error');
            this.isLoadingRentals = false;
          }, 30000);

          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);

              console.log('✅ Online rentals loaded:', result);

              if (result && result.success) {
                this.onlineRentals = result.rentals || [];
                console.log(`✅ Loaded ${this.onlineRentals.length} online rentals`);

                if (result.warning) {
                  this.showNotification(result.warning, 'warning');
                }
              } else {
                this.showNotification('โหลดรายการเช่าออนไลน์ไม่สำเร็จ: ' + (result?.message || 'ไม่ทราบสาเหตุ'), 'error');
              }

              this.isLoadingRentals = false;
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);

              console.error('❌ Error loading online rentals:', error);
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoadingRentals = false;
            })
            .getOnlineBookingRentals(sheetID);
        },

        // === ฟังก์ชั่นจัดการสถานะระบบออนไลน์ ===

        /**
         * เปิด/ปิดระบบจองออนไลน์
         */
        toggleOnlineBookingSystem() {
          if (this.isUpdatingSystemStatus) return;

          this.isUpdatingSystemStatus = true;
          const newStatus = !this.onlineBookingSystemEnabled;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.onlineBookingSystemEnabled = newStatus;
                this.showNotification(result.message, 'success');
                console.log(`✅ System status updated: ${newStatus ? 'เปิด' : 'ปิด'}`);
              } else {
                this.showNotification('เปลี่ยนสถานะระบบไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isUpdatingSystemStatus = false;
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isUpdatingSystemStatus = false;
            })
            .updateOnlineBookingSystemStatus(sheetID, newStatus);
        },

        // === ฟังก์ชั่นจัดการรถและสถานะออนไลน์ ===

        /**
         * เปิด/ปิดสถานะจองออนไลน์ของรถ
         */
        toggleVehicleOnlineBookingStatus(vehicleCode, currentStatus) {
          if (this.vehicleOnlineStatusUpdating) return;

          this.vehicleOnlineStatusUpdating = vehicleCode;
          const newStatus = !currentStatus;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                // อัพเดทข้อมูลในตัวแปรท้องถิ่น
                const vehicle = this.vehiclesOnlineBookingList.find(v => v.รหัสรถ === vehicleCode);
                if (vehicle) {
                  vehicle.เปิดจองออนไลน์ = newStatus;
                }
                this.showNotification(result.message, 'success');
                console.log(`✅ Vehicle ${vehicleCode} status updated: ${newStatus ? 'เปิด' : 'ปิด'}`);

                // รีเฟรชรายการรถสำหรับตั้งราคาถ้าจำเป็น
                if (this.availableVehiclesForPricing.length > 0) {
                  this.loadActiveVehiclesForPricing();
                }
              } else {
                this.showNotification('เปลี่ยนสถานะรถไม่สำเร็จ: ' + result.message, 'error');
              }
              this.vehicleOnlineStatusUpdating = null;
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.vehicleOnlineStatusUpdating = null;
            })
            .updateVehicleOnlineBookingStatus(sheetID, vehicleCode, newStatus);
        },

        // === ฟังก์ชั่นจัดการกลุ่มรถ ===

        /**
         * เปิด Modal จัดการกลุ่มรถใหม่
         */
        openVehicleGroupManagementModal() {
          this.loadUngroupedVehiclesForSelection();
          this.vehicleGroupManagementModal = true;
          this.vehicleGroupFormData = {
            id: null,
            name: '',
            description: '',
            selectedVehicleCodes: []
          };
        },

        /**
         * โหลดรถที่ยังไม่ได้จัดกลุ่ม
         */
        loadUngroupedVehiclesForSelection() {
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.ungroupedVehiclesForSelection = result.vehicles;
                console.log('✅ Loaded ungrouped vehicles:', result.vehicles.length);
              } else {
                this.showNotification('โหลดรถที่ยังไม่ได้จัดกลุ่มไม่สำเร็จ: ' + result.message, 'error');
              }
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
            })
            .getUngroupedVehiclesForSelection(sheetID);
        },

        /**
         * สร้างกลุ่มรถใหม่
         */

        createVehicleGroup() {
          if (!this.vehicleGroupFormData.name.trim()) {
            this.showNotification('กรุณาระบุชื่อกลุ่มรถ', 'warning');
            return;
          }
          if (this.vehicleGroupFormData.selectedVehicleCodes.length === 0) {
            this.showNotification('กรุณาเลือกรถอย่างน้อย 1 คัน', 'warning');
            return;
          }

          // 🔽 เพิ่ม Swal.fire เพื่อยืนยันการสร้าง
          Swal.fire({
            title: 'ยืนยันการสร้างกลุ่ม',
            text: `คุณต้องการสร้างกลุ่มใหม่ชื่อ "${this.vehicleGroupFormData.name}" ใช่หรือไม่?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ใช่, สร้างกลุ่ม',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isUpdatingVehicleGroup = true;
              const sheetID = localStorage.getItem('sheetID') || '';

              google.script.run
                .withSuccessHandler((result) => {
                  if (result.success) {
                    this.vehicleGroupsForPricing.push(result.groupData);
                    this.vehicleGroupManagementModal = false;
                    this.showNotification(result.message, 'success');
                    this.loadUngroupedVehiclesForSelection();
                  } else {
                    this.showNotification('สร้างกลุ่มรถไม่สำเร็จ: ' + result.message, 'error');
                  }
                  this.isUpdatingVehicleGroup = false;
                })
                .withFailureHandler((error) => {
                  this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                  this.isUpdatingVehicleGroup = false;
                })
                .createNewVehicleGroupByCode(sheetID, this.vehicleGroupFormData);
            }
          });
        },


        /**
         * เปิด Modal แก้ไขกลุ่มรถ
         */
        openVehicleGroupEditModal(group) {
          this.currentEditingVehicleGroup = { ...group };
          this.vehicleGroupEditingModal = true;
        },




        // === ฟังก์ชั่นจัดการกลุ่มรถ (แก้ไขแล้ว) ===
        deleteVehicleGroup(groupId) {
          // 🔽 เปลี่ยนจาก confirm() มาใช้ Swal.fire()
          Swal.fire({
            title: 'ยืนยันการลบกลุ่มรถ',
            text: "คุณแน่ใจหรือไม่ที่จะลบกลุ่มนี้? การดำเนินการนี้ไม่สามารถย้อนกลับได้",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            // โค้ดจะทำงานต่อเมื่อผู้ใช้กด "ใช่, ลบเลย!" เท่านั้น
            if (result.isConfirmed) {
              const sheetID = localStorage.getItem('sheetID') || '';

              google.script.run
                .withSuccessHandler((result) => {
                  if (result.success) {
                    this.vehicleGroupsForPricing = this.vehicleGroupsForPricing.filter(g => g.id !== groupId);
                    if (this.selectedGroupId === groupId) this.selectedGroupId = '';
                    this.showNotification(result.message, 'success');
                    this.loadUngroupedVehiclesForSelection(); // รีเฟรชรายการรถที่ยังไม่ได้จัดกลุ่ม
                    console.log(`✅ Vehicle group ${groupId} deleted`);
                  } else {
                    this.showNotification('ลบกลุ่มรถไม่สำเร็จ: ' + result.message, 'error');
                  }
                })
                .withFailureHandler((error) => {
                  this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                })
                .deleteVehicleGroupByCode(sheetID, groupId);
            }
          });
        },

        // === ฟังก์ชั่นจัดการกฎราคา (แก้ไขแล้ว) ===
        deletePricingRule(ruleId) {
          // 🔽 เปลี่ยนจาก confirm() มาใช้ Swal.fire()
          Swal.fire({
            title: 'ยืนยันการลบกฎราคา',
            text: "คุณแน่ใจหรือไม่ที่จะลบกฎราคานี้?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            // โค้ดจะทำงานต่อเมื่อผู้ใช้กด "ใช่, ลบเลย!" เท่านั้น
            if (result.isConfirmed) {
              const sheetID = localStorage.getItem('sheetID') || '';

              google.script.run
                .withSuccessHandler((result) => {
                  if (result.success) {
                    this.priceRulesConfiguration = this.priceRulesConfiguration.filter(r => r.ruleId !== ruleId);
                    this.showNotification(result.message, 'success');
                    console.log(`✅ Pricing rule ${ruleId} deleted`);
                  } else {
                    this.showNotification('ลบกฎราคาไม่สำเร็จ: ' + result.message, 'error');
                  }
                })
                .withFailureHandler((error) => {
                  this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                })
                .deletePricingRuleConfiguration(sheetID, ruleId);
            }
          });
        },

        // === ฟังก์ชั่นจัดการรถในกลุ่ม (แก้ไขแล้ว) ===
        removeVehicleFromCurrentGroup(vehicleCode) {
          // 🔽 เปลี่ยนจาก confirm() มาใช้ Swal.fire()
          Swal.fire({
            title: 'ยืนยันการนำรถออกจากกลุ่ม',
            text: "คุณแน่ใจหรือไม่ที่จะนำรถคันนี้ออกจากกลุ่ม?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, นำออก!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            // โค้ดจะทำงานต่อเมื่อผู้ใช้กด "ใช่, นำออก!" เท่านั้น
            if (result.isConfirmed) {
              const sheetID = localStorage.getItem('sheetID') || '';

              google.script.run
                .withSuccessHandler((result) => {
                  if (result.success) {
                    this.currentEditingVehicleGroup.vehicleCodes =
                      this.currentEditingVehicleGroup.vehicleCodes.filter(code => code !== vehicleCode);
                    this.showNotification(result.message, 'success');
                    console.log(`✅ Vehicle ${vehicleCode} removed from group`);
                  } else {
                    this.showNotification('ลบรถไม่สำเร็จ: ' + result.message, 'error');
                  }
                })
                .withFailureHandler((error) => {
                  this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                })
                .removeVehicleFromGroupByCode(sheetID, this.currentEditingVehicleGroup.id, vehicleCode);
            }
          });
        },

        /**
         * อัพเดทข้อมูลกลุ่มรถ
         */

        updateVehicleGroupData() {
          if (this.currentEditingVehicleGroup.vehicleCodes.length === 0) {
            this.showNotification('กลุ่มต้องมีรถอย่างน้อย 1 คัน', 'warning');
            return;
          }

          // 🔽 เพิ่ม Swal.fire เพื่อยืนยันการอัพเดท
          Swal.fire({
            title: 'ยืนยันการบันทึก',
            text: `คุณต้องการบันทึกการเปลี่ยนแปลงของกลุ่ม "${this.currentEditingVehicleGroup.name}" ใช่หรือไม่?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ใช่, บันทึก',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.isUpdatingVehicleGroup = true;
              const sheetID = localStorage.getItem('sheetID') || '';

              google.script.run
                .withSuccessHandler((result) => {
                  if (result.success) {
                    const groupIndex = this.vehicleGroupsForPricing.findIndex(g => g.id === this.currentEditingVehicleGroup.id);
                    if (groupIndex !== -1) {
                      this.vehicleGroupsForPricing[groupIndex] = { ...this.currentEditingVehicleGroup };
                    }

                    this.vehicleGroupEditingModal = false;
                    this.showNotification(result.message, 'success');
                    this.loadUngroupedVehiclesForSelection();
                  } else {
                    this.showNotification('อัพเดทกลุ่มรถไม่สำเร็จ: ' + result.message, 'error');
                  }
                  this.isUpdatingVehicleGroup = false;
                })
                .withFailureHandler((error) => {
                  this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                  this.isUpdatingVehicleGroup = false;
                })
                .updateVehicleGroupByCode(sheetID, this.currentEditingVehicleGroup.id, this.currentEditingVehicleGroup.vehicleCodes);
            }
          });
        },



        // === ฟังก์ชั่นเสริม ===

        /**
         * ดึงข้อมูลวันหยุดไทย (ใช้ตัวแปรเฉพาะ Online Booking)
         */
        fetchHolidays() {
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.thaiHolidays = result.holidays;
                console.log(`✅ Thai holidays loaded for year ${this.onlineBookingYear}`);
              }
            })
            .withFailureHandler((error) => {
              console.error('❌ Error loading holidays:', error);
            })
            .getThaiHolidaysList(sheetId, this.onlineBookingYear);
        },

        /**
         * แสดงการแจ้งเตือน
         */


        /**
         * เริ่มต้นระบบจัดการการจองออนไลน์
         */
        initOnlineBookingSystem() {
          console.log('🚀 Initializing Online Booking System...');

          // ป้องกันการทำงานของฟังก์ชั่นที่ไม่เกี่ยวข้อง
          if (this.currentPage !== 'onlinebooking') {
            console.log('⚠️ Not in online booking page, skipping initialization');
            return;
          }

          // ตั้งค่าเริ่มต้น
          this.pricingMode = 'single';
          this.selectedCarId = '';
          this.selectedGroupId = '';
          this.onlineBookingYear = new Date().getFullYear();
          this.onlineBookingMonth = new Date().getMonth();

          // โหลดข้อมูลทั้งหมด
          this.loadCompleteOnlineBookingData();

          console.log('✅ Online Booking System initialized');
        },

        /**
         * เปลี่ยนโหมดการตั้งราคา (รายคัน/กลุ่ม) พร้อมล้างการเลือก
         */
        switchPricingMode(newMode) {
          if (this.pricingMode === newMode) return;

          // ล้างการเลือกเดิม
          this.selectedCarId = '';
          this.selectedGroupId = '';
          this.clearDateSelection();

          // เปลี่ยนโหมด
          this.pricingMode = newMode;

          console.log(`🔄 Switched to ${newMode} mode`);
        },

        /**
         * รีเซ็ตฟอร์มกลุ่มรถ
         */
        resetVehicleGroupForm() {
          this.vehicleGroupFormData = {
            id: null,
            name: '',
            description: '',
            selectedVehicleCodes: []
          };
        },

        /**
         * ตรวจสอบว่ารถอยู่ในกลุ่มหรือไม่
         */
        isVehicleInGroup(vehicleCode) {
          return this.vehicleGroupsForPricing.some(group =>
            group.vehicleCodes.includes(vehicleCode)
          );
        },

        /**
         * ดึงชื่อกลุ่มที่รถอยู่
         */
        getVehicleGroupName(vehicleCode) {
          const group = this.vehicleGroupsForPricing.find(group =>
            group.vehicleCodes.includes(vehicleCode)
          );
          return group ? group.name : '';
        },

        /**
         * ป้องกัน Error จากฟังก์ชั่นที่ไม่เกี่ยวข้องกับ Online Booking
         */
        renderRevenueChart() {
          // ป้องกัน error ในหน้า online booking
          if (this.currentPage === 'onlinebooking') {
            console.log('⚠️ renderRevenueChart called in online booking page - ignoring');
            return;
          }

          // ตรวจสอบว่ามี element อยู่จริง
          const chartElement = document.getElementById('revenueChart');
          if (!chartElement) {
            console.log('⚠️ revenueChart element not found - skipping chart render');
            return;
          }

          // เรียกใช้ฟังก์ชั่นเดิม (ถ้ามี)
          if (typeof this.originalRenderRevenueChart === 'function') {
            this.originalRenderRevenueChart();
          }
        },

        /**
         * ป้องกัน Error จากฟังก์ชั่น chart อื่นๆ
         */
        safeChartRender(chartFunction, elementId) {
          // ป้องกัน error ในหน้า online booking
          if (this.currentPage === 'onlinebooking') {
            console.log(`⚠️ ${chartFunction} called in online booking page - ignoring`);
            return;
          }

          // ตรวจสอบว่ามี element อยู่จริง
          const element = document.getElementById(elementId);
          if (!element) {
            console.log(`⚠️ ${elementId} element not found - skipping chart render`);
            return;
          }

          return true; // ปลอดภัยที่จะสร้างกราฟ
        },

        // === ฟังก์ชั่นปฏิทินและการจัดการวันที่ ===

        /**
         * คลิกเลือกวันที่ในปฏิทิน
         */
        handleDateClick(date) {
          if (!date || !this.calendarDays.find(d => d.date.getTime() === date.getTime()).isCurrentMonth) return;

          if (!this.onlineBookingDateRange.start) {
            this.onlineBookingDateRange.start = date;
          } else if (!this.onlineBookingDateRange.end) {
            if (date < this.onlineBookingDateRange.start) {
              this.onlineBookingDateRange.end = this.onlineBookingDateRange.start;
              this.onlineBookingDateRange.start = date;
            } else {
              this.onlineBookingDateRange.end = date;
            }
          } else {
            this.clearDateSelection();
            this.onlineBookingDateRange.start = date;
          }
        },

        /**
         * ล้างการเลือกวันที่
         */
        clearDateSelection() {
          this.onlineBookingDateRange = { start: null, end: null };
          this.ruleForm = { price: '', description: '' };
        },

        /**
         * แปลงวันที่เป็น ISO format
         */
        formatDateISO(date) {
          if (!date) return '';
          return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        },

        /**
         * แปลงวันที่สำหรับแสดงผล
         */
        formatDate(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
          return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        },





        formatAndCombineDateTime(datePart, timePart) {
          // 1. ต้องมีข้อมูลวันที่เป็นอย่างน้อย
          if (!datePart) return 'ไม่มีข้อมูล';

          const date = new Date(datePart);
          let hours = 0;
          let minutes = 0;

          // 2. ตรวจสอบและจัดการข้อมูลเวลาอย่างปลอดภัย
          if (timePart) {
            // === จุดแก้ไขสำคัญ: แปลง timePart ให้เป็น String ก่อนเสมอ ===
            const timeString = String(timePart);

            // A: ถ้าเป็น ISO String เต็มรูปแบบ (มีตัว T และ Z)
            if (timeString.includes('T') && timeString.includes('Z')) {
              const timeAsDate = new Date(timeString);
              hours = timeAsDate.getHours();
              minutes = timeAsDate.getMinutes();
            }
            // B: ถ้าเป็นรูปแบบที่มีเครื่องหมาย ":" (ครอบคลุม "HH:MM" และ "HH:MM:SS")
            else if (timeString.includes(':')) {
              const parts = timeString.split(':');
              hours = parseInt(parts[0], 10) || 0;
              minutes = parseInt(parts[1], 10) || 0;
            }
          }
          // หากไม่มี timePart หรือรูปแบบไม่ถูกต้อง เวลาจะเป็น 00:00 (ปลอดภัย ไม่ Error)

          // 3. ตั้งค่าเวลาที่ดึงมาได้ลงในวันที่หลัก
          date.setHours(hours, minutes, 0, 0);

          // 4. จัดรูปแบบและส่งค่ากลับ
          return date.toLocaleString('th-TH', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
        },


        /**
         * ดึง CSS classes สำหรับวันในปฏิทิน (เพิ่มการจัดการวันหยุด)
         */
        getDayClasses(day) {
          let classes = 'border border-transparent cursor-pointer p-2 text-center relative ';

          if (!day.isCurrentMonth) {
            classes += 'text-gray-300';
          } else {
            const dateStr = this.formatDateISO(day.date);
            const rangeStartStr = this.formatDateISO(this.onlineBookingDateRange.start);
            const rangeEndStr = this.formatDateISO(this.onlineBookingDateRange.end);

            // สีสำหรับวันที่เลือก (มีความสำคัญสูงสุด)
            if (this.onlineBookingDateRange.start && !this.onlineBookingDateRange.end && dateStr === rangeStartStr) {
              classes += 'bg-indigo-600 text-white font-bold rounded shadow-lg ring-2 ring-indigo-300';
            } else if (this.onlineBookingDateRange.start && this.onlineBookingDateRange.end) {
              if (dateStr >= rangeStartStr && dateStr <= rangeEndStr) {
                classes += 'bg-indigo-200 text-indigo-800';
              }
              if (dateStr === rangeStartStr || dateStr === rangeEndStr) {
                classes += ' bg-indigo-600 text-white font-bold rounded shadow-lg ring-2 ring-indigo-300';
              }
            }
            // สีสำหรับวันหยุดนักขัตฤกษ์ (เมื่อไม่ได้เลือก)
            else if (day.isHoliday) {
              classes += 'bg-red-100 text-red-800 border border-red-300 rounded font-medium shadow-sm';
            }
            // สีสำหรับวันที่มีราคาตั้งไว้
            else if (day.price) {
              classes += 'bg-green-100 text-green-800 border border-green-300 rounded';
            }
            // วันปกติ
            else {
              classes += 'hover:bg-indigo-50 rounded transition-colors';
            }
          }
          return classes;
        },

        /**
         * ตรวจสอบว่ากฎราคาใช้ได้กับวันที่นี้หรือไม่
         */
        isRuleApplicable(rule, dateStr) {
          if (dateStr < rule.startDate || dateStr > rule.endDate) return false;

          if (this.pricingMode === 'single') {
            return rule.vehicleCode === this.selectedCarId;
          }

          if (this.pricingMode === 'group') {
            const group = this.vehicleGroupsForPricing.find(g => g.id === this.selectedGroupId);
            return group && group.vehicleCodes.includes(rule.vehicleCode);
          }

          return false;
        },

        /**
         * ดึงชื่อวันหยุดสำหรับวันที่นั้น
         */
        getHolidayName(date) {
          const dateStr = this.formatDateISO(date);
          const holiday = this.thaiHolidays.find(h => h.date === dateStr);
          return holiday ? holiday.name : '';
        },

        /**
         * ตั้งราคาพิเศษสำหรับวันหยุดอัตโนมัติ
         */
        setHolidayPricingMode(enabled) {
          this.autoHolidayPricing = enabled;
          if (enabled && !this.holidayPriceMultiplier) {
            this.holidayPriceMultiplier = 1.5; // เพิ่มราคา 50% ในวันหยุด
          }
        },

        /**
         * คำนวณราคาอัตโนมัติสำหรับวันหยุด (ถ้าเปิดใช้งาน)
         */
        getAutoHolidayPrice(date, basePrice) {
          if (!this.autoHolidayPricing || !basePrice) return basePrice;

          const dateStr = this.formatDateISO(date);
          const isHoliday = this.thaiHolidays.some(h => h.date === dateStr);

          if (isHoliday) {
            return Math.round(basePrice * (this.holidayPriceMultiplier || 1.5));
          }

          return basePrice;
        },

        /**
         * ดึงชื่อรถจาก vehicle code
         */
        getCarName(vehicleCode) {
          const vehicle = this.availableVehiclesForPricing.find(v => v.รหัสรถ === vehicleCode);
          return vehicle ? vehicle.ชื่อรถเต็ม : vehicleCode;
        },

        /**
         * บันทึกกฎราคา
         */
        saveNewPricingRules() {
          const sheetID = localStorage.getItem('sheetID') || '';

          if (!this.isFormEnabled || !this.ruleForm.price) {
            this.showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
            return;
          }

          if (!this.onlineBookingDateRange.end) {
            this.onlineBookingDateRange.end = this.onlineBookingDateRange.start;
          }

          const ruleObjects = [];
          const baseRule = {
            startDate: this.formatDateISO(this.onlineBookingDateRange.start),
            endDate: this.formatDateISO(this.onlineBookingDateRange.end),
            pricePerDay: this.ruleForm.price,
            description: this.ruleForm.description
          };

          if (this.pricingMode === 'single') {
            ruleObjects.push({ ...baseRule, vehicleCode: this.selectedCarId });
          } else {
            const group = this.vehicleGroupsForPricing.find(g => g.id === this.selectedGroupId);
            if (group && group.vehicleCodes.length > 0) {
              group.vehicleCodes.forEach(vehicleCode => {
                ruleObjects.push({ ...baseRule, vehicleCode: vehicleCode, groupId: group.id });
              });
            }
          }

          if (ruleObjects.length === 0) {
            this.showNotification('ไม่มีรถให้บันทึกกฎราคา', 'warning');
            return;
          }

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.priceRulesConfiguration.push(...result.savedRules);
                this.clearDateSelection();
                this.showNotification(result.message, 'success');
              } else {
                this.showNotification('เกิดข้อผิดพลาด: ' + result.message, 'error');
              }
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
            })
            .savePricingRulesConfiguration(sheetID, ruleObjects);
        },

        /**
         * ตั้งราคาวันหยุดอัตโนมัติสำหรับช่วงวันที่ที่เลือก
         */
        applyHolidayPricingToSelection() {
          if (!this.onlineBookingDateRange.start || !this.autoHolidayPricing) return;

          // หาราคาปกติของรถ/กลุ่มที่เลือก
          let basePrice = 0;
          if (this.pricingMode === 'single' && this.selectedCarId) {
            // ใช้ availableIndividualVehicles แทน availableVehiclesForPricing
            const vehicle = this.availableIndividualVehicles.find(v => v.รหัสรถ === this.selectedCarId);
            basePrice = vehicle ? vehicle.ราคาเริ่มต้น : 0;
          } else if (this.pricingMode === 'group' && this.selectedGroupId) {
            // ใช้ราคาเฉลี่ยของรถในกลุ่ม
            const group = this.vehicleGroupsForPricing.find(g => g.id === this.selectedGroupId);
            if (group && group.vehicleCodes.length > 0) {
              const vehicles = this.availableVehiclesForPricing.filter(v => group.vehicleCodes.includes(v.รหัสรถ));
              const totalPrice = vehicles.reduce((sum, v) => sum + (v.ราคาเริ่มต้น || 0), 0);
              basePrice = Math.round(totalPrice / vehicles.length);
            }
          }

          if (basePrice > 0) {
            const holidayPrice = this.getAutoHolidayPrice(this.onlineBookingDateRange.start, basePrice);
            this.ruleForm.price = holidayPrice;
            this.ruleForm.description = `ราคาวันหยุดอัตโนมัติ (${this.holidayPriceMultiplier}x)`;
            this.showNotification(`ตั้งราคาวันหยุดอัตโนมัติ: ${holidayPrice} บาท`, 'success');
          } else {
            this.showNotification('ไม่พบราคาปกติเพื่อคำนวณราคาวันหยุด', 'warning');
          }
        },

        /**
         * ตรวจสอบว่ารถคันนั้นอยู่ในกลุ่มหรือไม่ (ปรับปรุงใหม่)
         */
        isVehicleInGroup(vehicleCode) {
          return this.vehicleGroupsForPricing.some(group =>
            group.vehicleCodes.includes(vehicleCode)
          );
        },

        /**
         * ดึงชื่อกลุ่มที่รถอยู่ (ปรับปรุงใหม่)
         */
        getVehicleGroupName(vehicleCode) {
          const group = this.vehicleGroupsForPricing.find(group =>
            group.vehicleCodes.includes(vehicleCode)
          );
          return group ? group.name : '';
        },

        /**
         * ดึงข้อมูลสถิติการกรองรถ
         */
        getVehicleFilterStats() {
          const totalOnlineVehicles = this.availableVehiclesForPricing.length;
          const groupedVehicles = totalOnlineVehicles - this.availableIndividualVehicles.length;
          const availableIndividual = this.availableIndividualVehicles.length;

          return {
            total: totalOnlineVehicles,
            inGroups: groupedVehicles,
            individual: availableIndividual
          };
        },



        get calendarDays() {
          const days = [];
          const date = new Date(this.onlineBookingYear, this.onlineBookingMonth, 1);
          const firstDayIndex = date.getDay();
          const lastDay = new Date(this.onlineBookingYear, this.onlineBookingMonth + 1, 0).getDate();

          // วันที่เดือนก่อน
          for (let i = firstDayIndex; i > 0; i--) {
            const prevDate = new Date(date);
            prevDate.setDate(prevDate.getDate() - i);
            days.push({ id: `prev-${i}`, date: prevDate, isCurrentMonth: false });
          }

          // วันที่เดือนปัจจุบัน
          for (let i = 1; i <= lastDay; i++) {
            const thisDate = new Date(this.onlineBookingYear, this.onlineBookingMonth, i);
            const dateStr = this.formatDateISO(thisDate);
            let price = null;

            const rule = this.priceRulesConfiguration.find(r => this.isRuleApplicable(r, dateStr));
            if (rule) price = rule.pricePerDay;

            days.push({
              id: `current-${i}`,
              date: thisDate,
              isCurrentMonth: true,
              isHoliday: this.thaiHolidays.some(h => h.date === dateStr),
              price: price
            });
          }

          return days;
        },

        /**
         * รถที่ยังไม่อยู่ในกลุ่มใด (สำหรับเลือกแบบรายคัน)
         */
        get availableIndividualVehicles() {
          // รวบรวมรหัสรถที่อยู่ในกลุ่มแล้ว
          const groupedVehicleCodes = new Set();
          this.vehicleGroupsForPricing.forEach(group => {
            group.vehicleCodes.forEach(code => groupedVehicleCodes.add(code));
          });

          // กรองรถที่ยังไม่อยู่ในกลุ่มใด
          return this.availableVehiclesForPricing.filter(vehicle =>
            !groupedVehicleCodes.has(vehicle.รหัสรถ)
          );
        },

        /**
         * กฎราคาที่กรองแล้ว
         */
        get filteredRules() {
          if ((this.pricingMode === 'single' && !this.selectedCarId) ||
            (this.pricingMode === 'group' && !this.selectedGroupId)) {
            return [];
          }

          let relevantRules;
          if (this.pricingMode === 'single') {
            relevantRules = this.priceRulesConfiguration.filter(r => r.vehicleCode === this.selectedCarId);
          } else {
            const group = this.vehicleGroupsForPricing.find(g => g.id === this.selectedGroupId);
            if (!group) return [];
            relevantRules = this.priceRulesConfiguration.filter(r => group.vehicleCodes.includes(r.vehicleCode));
          }
          return relevantRules;
        },

        /**
         * ตรวจสอบว่าฟอร์มพร้อมใช้งานหรือไม่
         */
        get isFormEnabled() {
          return this.onlineBookingDateRange.start &&
            ((this.pricingMode === 'single' && this.selectedCarId) ||
              (this.pricingMode === 'group' && this.selectedGroupId));
        },



        getVehicleDisplayName(vehicleCode) {
          const vehicle = this.availableVehiclesForPricing.find(v => v.รหัสรถ === vehicleCode);

          if (vehicle) {
            return `${vehicle.รหัสรถ} - ${vehicle.ชื่อรถเต็ม} [${vehicle.ทะเบียน || ''}]`;
          }

          return vehicleCode; // fallback ถ้าไม่เจอ
        },




        /**
         * โหลดข้อมูลระบบจัดการวันปิดให้เช่า
         */
        loadVehicleBlockingData() {
          this.isLoadingVehicleBlocking = true;
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.availableVehiclesForBlocking = result.vehicles;
                this.blockedDatesConfiguration = result.blockingRules;
                this.blockingReasonsData = result.blockingReasons;

                // 🔽 ลบบรรทัดนี้ออก 🔽
                // this.generateVehicleBlockingCalendar(); 
                // 🔼 ไม่ต้องเรียกซ้ำตรงนี้ 🔼

                console.log('✅ Loaded vehicle blocking data');
              } else {
                this.showNotification('โหลดข้อมูลการปิดรถไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoadingVehicleBlocking = false;
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoadingVehicleBlocking = false;
            })
            .getVehicleBlockingManagementData(sheetID);
        },













        // ✅ ฟังก์ชันใหม่: ตรวจสอบและบังคับให้เป็นเวลาปัจจุบัน
        ensureCurrentDateTime() {
          const now = new Date();
          this.vehicleBlockingMonth = now.getMonth();
          this.vehicleBlockingYear = now.getFullYear();

          console.log(`🕒 Initialize Calendar: ${this.thaiMonthsForBlocking[this.vehicleBlockingMonth]} ${this.vehicleBlockingYear + 543}`);
        },

        syncDropdowns() {
          this.$nextTick(() => {
            const monthDropdown = document.querySelector('select[x-model="vehicleBlockingMonth"]');
            const yearDropdown = document.querySelector('select[x-model="vehicleBlockingYear"]');

            if (monthDropdown) monthDropdown.value = this.vehicleBlockingMonth;
            if (yearDropdown) yearDropdown.value = this.vehicleBlockingYear;
          });
        },

        previousVehicleBlockingMonth() {
          if (this.vehicleBlockingMonth === 0) {
            this.vehicleBlockingMonth = 11;
            this.vehicleBlockingYear--;
          } else {
            this.vehicleBlockingMonth--;
          }
          this.syncDropdowns(); // ← เพิ่มบรรทัดนี้
        },

        nextVehicleBlockingMonth() {
          if (this.vehicleBlockingMonth === 11) {
            this.vehicleBlockingMonth = 0;
            this.vehicleBlockingYear++;
          } else {
            this.vehicleBlockingMonth++;
          }
          this.syncDropdowns(); // ← เพิ่มบรรทัดนี้
        },

        // ✅ ฟังก์ชันแสดงปี (รองรับทั้ง ค.ศ. และ พ.ศ.)
        formatYearDisplay(year) {
          const buddhistYear = year + 543;
          return `${year} (${buddhistYear})`;
        },

        // ✅ ปุ่มกลับไปวันนี้
        goToCurrentMonth() {
          const now = new Date();
          this.vehicleBlockingMonth = now.getMonth();
          this.vehicleBlockingYear = now.getFullYear();
          console.log(`🏠 Go to Today: ${this.thaiMonthsForBlocking[this.vehicleBlockingMonth]} ${this.vehicleBlockingYear + 543}`);
        },

        // ========== คำนวณวันในปฏิทิน ==========
        get vehicleBlockingCalendarDays() {
          const days = [];
          const date = new Date(this.vehicleBlockingYear, this.vehicleBlockingMonth, 1);
          const firstDayIndex = date.getDay();
          const lastDay = new Date(this.vehicleBlockingYear, this.vehicleBlockingMonth + 1, 0).getDate();

          // วันที่เดือนก่อน
          for (let i = firstDayIndex; i > 0; i--) {
            const prevDate = new Date(date);
            prevDate.setDate(prevDate.getDate() - i);
            days.push({ id: `prev-${i}`, date: prevDate, isCurrentMonth: false });
          }

          // วันที่เดือนปัจจุบัน
          for (let i = 1; i <= lastDay; i++) {
            const thisDate = new Date(this.vehicleBlockingYear, this.vehicleBlockingMonth, i);
            days.push({ id: `current-${i}`, date: thisDate, isCurrentMonth: true });
          }

          // วันที่เดือนถัดไป (ให้ครบ 42 วัน = 6 สัปดาห์)
          const remainingDays = 42 - days.length;
          for (let i = 1; i <= remainingDays; i++) {
            const nextDate = new Date(this.vehicleBlockingYear, this.vehicleBlockingMonth + 1, i);
            days.push({ id: `next-${i}`, date: nextDate, isCurrentMonth: false });
          }

          return days;
        },







        /**
         * เลือกวันที่ในปฏิทิน
         */
        selectVehicleBlockingDate(date) {
          if (!this.selectedVehicleForBlocking) {
            this.showNotification('กรุณาเลือกรถก่อน', 'warning');
            return;
          }

          // เช็คว่าวันนี้ปิดอยู่แล้วหรือไม่
          const blockStatus = this.getVehicleBlockingStatusForDay(date);
          if (blockStatus.length > 0) {
            this.showNotification('วันนี้ปิดการให้เช่าอยู่แล้ว', 'error');
            return;
          }

          // Logic การเลือกวันที่
          if (this.vehicleBlockingDateRange.start && !this.vehicleBlockingDateRange.end) {
            // เลือกวันที่สอง
            if (date >= this.vehicleBlockingDateRange.start) {
              this.vehicleBlockingDateRange.end = date;
            } else {
              this.vehicleBlockingDateRange.end = this.vehicleBlockingDateRange.start;
              this.vehicleBlockingDateRange.start = date;
            }
          } else {
            // เลือกวันที่แรก
            this.clearVehicleBlockingSelection();
            this.vehicleBlockingDateRange.start = date;
          }

          this.updateVehicleBlockingFormStatus();
        },

        /**
         * ตรวจสอบว่าวันที่ถูกเลือกหรือไม่
         */
        isDateSelected(date) {
          const dateStr = this.formatDateISO(date);
          const startStr = this.formatDateISO(this.vehicleBlockingDateRange.start);
          const endStr = this.formatDateISO(this.vehicleBlockingDateRange.end);

          if (this.vehicleBlockingDateRange.start && !this.vehicleBlockingDateRange.end) {
            return dateStr === startStr;
          }

          if (this.vehicleBlockingDateRange.start && this.vehicleBlockingDateRange.end) {
            return dateStr === startStr || dateStr === endStr;
          }

          return false;
        },

        /**
         * ตรวจสอบว่าวันที่อยู่ในช่วงที่เลือกหรือไม่
         */
        isDateInRange(date) {
          if (!this.vehicleBlockingDateRange.start || !this.vehicleBlockingDateRange.end) {
            return false;
          }

          const dateStr = this.formatDateISO(date);
          const startStr = this.formatDateISO(this.vehicleBlockingDateRange.start);
          const endStr = this.formatDateISO(this.vehicleBlockingDateRange.end);

          return dateStr > startStr && dateStr < endStr;
        },

        /**
         * อัพเดทสถานะฟอร์ม
         */
        updateVehicleBlockingFormStatus() {
          this.isVehicleBlockingFormEnabled =
            this.selectedVehicleForBlocking && this.vehicleBlockingDateRange.start;
        },

        /**
         * ตรวจสอบความถูกต้องของฟอร์ม
         */
        get isVehicleBlockingFormValid() {
          return this.isVehicleBlockingFormEnabled &&
            this.vehicleBlockingForm.reasonCode;
        },

        /**
         * ล้างการเลือกวันที่
         */
        clearVehicleBlockingSelection() {
          this.vehicleBlockingDateRange = { start: null, end: null };
          this.vehicleBlockingForm = { reasonCode: '', description: '' };
          this.updateVehicleBlockingFormStatus();
        },

        /**
         * ดึง CSS classes สำหรับวันในปฏิทิน
         */
        getVehicleBlockingDayClasses(day) {
          let classes = 'transition-all duration-200 ';

          if (!day.isCurrentMonth) {
            classes += 'text-gray-300 hover:bg-gray-50';
          } else {
            classes += 'hover:bg-red-50 text-gray-700';
          }

          return classes;
        },

        /**
         * ดึงสถานะการปิดสำหรับวันที่
         */
        getVehicleBlockingStatusForDay(date) {
          if (!this.selectedVehicleForBlocking) return [];

          const dateStr = this.formatDateISO(date);
          return this.blockedDatesConfiguration.filter(block => {
            return block.vehicleCode === this.selectedVehicleForBlocking &&
              dateStr >= block.startDate &&
              dateStr <= block.endDate &&
              block.isActive;
          });
        },

        /**
         * ดึงรายการการปิดของรถที่เลือก
         */
        get selectedVehicleBlockingRules() {
          if (!this.selectedVehicleForBlocking) return [];

          return this.blockedDatesConfiguration.filter(block =>
            block.vehicleCode === this.selectedVehicleForBlocking && block.isActive
          ).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
        },

        /**
         * ดึงสีสำหรับเหตุผลการปิด
         */
        getBlockingReasonColor(reasonCode) {
          const reason = this.blockingReasonsData.find(r => r.reasonCode === reasonCode);
          const colorMap = {
            'orange': 'bg-orange-200',
            'red': 'bg-red-200',
            'purple': 'bg-purple-200',
            'gray': 'bg-gray-200'
          };
          return colorMap[reason?.reasonColor] || 'bg-gray-200';
        },

        /**
         * ดึงคลาส CSS สำหรับแถบสถานะ
         */
        getBlockingReasonStatusClass(reasonCode) {
          const reason = this.blockingReasonsData.find(r => r.reasonCode === reasonCode);
          if (!reason) return 'status-other';

          const classMap = {
            'orange': 'status-maintenance',
            'red': 'status-repair',
            'purple': 'status-personal',
            'gray': 'status-other'
          };
          return classMap[reason.reasonColor] || 'status-other';
        },

        /**
         * ดึงชื่อเหตุผลการปิด
         */
        getBlockingReasonName(reasonCode) {
          const reason = this.blockingReasonsData.find(r => r.reasonCode === reasonCode);
          return reason ? reason.reasonName : reasonCode;
        },

        /**
         * บันทึกกฎการปิดรถ
         */
        saveVehicleBlockingRules() {
          const sheetID = localStorage.getItem('sheetID') || '';

          if (!this.isVehicleBlockingFormValid) {
            this.showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
            return;
          }

          if (!this.vehicleBlockingDateRange.end) {
            this.vehicleBlockingDateRange.end = this.vehicleBlockingDateRange.start;
          }

          const blockingObjects = [{
            startDate: this.formatDateISO(this.vehicleBlockingDateRange.start),
            endDate: this.formatDateISO(this.vehicleBlockingDateRange.end),
            vehicleCode: this.selectedVehicleForBlocking,
            reasonCode: this.vehicleBlockingForm.reasonCode,
            reasonDescription: this.vehicleBlockingForm.description
          }];

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                const successCount = result.results.filter(r => r.success).length;
                const failCount = result.results.filter(r => !r.success).length;

                if (successCount > 0) {
                  this.blockedDatesConfiguration.push(...result.savedRules);
                  this.clearVehicleBlockingSelection();
                  this.showNotification(`บันทึกการปิดรถสำเร็จ ${successCount} รายการ`, 'success');
                }

                if (failCount > 0) {
                  this.vehicleBlockingConflicts = result.results.filter(r => !r.success);
                  this.vehicleBlockingConflictModal = true;
                }
              } else {
                this.showNotification('เกิดข้อผิดพลาด: ' + result.message, 'error');
              }
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
            })
            .saveVehicleBlockingConfiguration(sheetID, blockingObjects);
        },

        /**
         * แก้ไขกฎการปิดรถ
         */
        editVehicleBlockingRule(rule) {
          this.editingVehicleBlockingRule = { ...rule };
          this.editVehicleBlockingModal = true;
        },

        /**
         * อัพเดทกฎการปิดรถ
         */
        updateVehicleBlockingRule() {
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                const index = this.blockedDatesConfiguration.findIndex(
                  r => r.blockingId === this.editingVehicleBlockingRule.blockingId
                );
                if (index !== -1) {
                  this.blockedDatesConfiguration[index] = result.updatedRule;
                }

                this.editVehicleBlockingModal = false;
                this.showNotification(result.message, 'success');
              } else {
                this.showNotification('เกิดข้อผิดพลาด: ' + result.message, 'error');
              }
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
            })
            .updateVehicleBlockingRule(sheetID, this.editingVehicleBlockingRule.blockingId, {
              startDate: this.editingVehicleBlockingRule.startDate,
              endDate: this.editingVehicleBlockingRule.endDate,
              vehicleCode: this.editingVehicleBlockingRule.vehicleCode,
              reasonCode: this.editingVehicleBlockingRule.reasonCode,
              reasonDescription: this.editingVehicleBlockingRule.reasonDescription
            });
        },

        /**
         * เริ่มกระบวนการลบกฎการปิดรถ
         */
        deleteVehicleBlockingRule(blockingId) {
          this.deletingBlockingId = blockingId;
          this.deleteVehicleBlockingModal = true;
        },

        /**
         * ยืนยันการลบกฎการปิดรถ
         */
        confirmDeleteVehicleBlocking() {
          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                this.blockedDatesConfiguration = this.blockedDatesConfiguration.filter(
                  r => r.blockingId !== this.deletingBlockingId
                );

                this.deleteVehicleBlockingModal = false;
                this.showNotification(result.message, 'success');
              } else {
                this.showNotification('เกิดข้อผิดพลาด: ' + result.message, 'error');
              }
            })
            .withFailureHandler((error) => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
            })
            .deleteVehicleBlockingRule(sheetID, this.deletingBlockingId);
        },

        /**
         * แปลงวันที่เป็น ISO format
         */
        formatDateISO(date) {
          if (!date) return '';
          return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        },

        /**
         * แปลงวันที่สำหรับแสดงผล
         */
        formatDateForDisplay(date) {
          if (!date) return '';
          return new Date(date).toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        },




        // =================================================
        // ⭐ เพิ่มฟังก์ชันใหม่ทั้งหมดสำหรับหน้าจัดการลูกค้า
        // =================================================

        // วางทับฟังก์ชันเดิม
        loadCustomers() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              // ⭐ เพิ่มการตรวจสอบว่า result ไม่ใช่ null
              if (result && result.success) {
                this.allCustomers = result.data;
                this.filterCustomers();
              } else {
                // ถ้า result เป็น null หรือ success เป็น false
                const errorMessage = result ? result.message : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์';
                this.showNotification('โหลดข้อมูลลูกค้าไม่สำเร็จ: ' + errorMessage, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .getAllCustomers(sheetID);
        },


        filterCustomers() {
          if (!this.customerSearchQuery) {
            this.filteredCustomers = this.allCustomers;
            return;
          }
          const query = this.customerSearchQuery.toLowerCase();
          this.filteredCustomers = this.allCustomers.filter(customer => {
            return Object.values(customer).some(value =>
              String(value).toLowerCase().includes(query)
            );
          });
        },

        openCustomerModal(customer) {
          if (customer) {
            this.isEditingCustomer = true;
            this.currentCustomer = JSON.parse(JSON.stringify(customer));
            // ทำความสะอาดเบอร์โทรศัพท์ก่อนแสดง
            if (this.currentCustomer.เบอร์โทรศัพท์ && typeof this.currentCustomer.เบอร์โทรศัพท์ === 'string') {
              this.currentCustomer.เบอร์โทรศัพท์ = this.currentCustomer.เบอร์โทรศัพท์.replace(/'/g, "");
            }
          } else {
            this.isEditingCustomer = false;
            this.currentCustomer = { 'สถานะ': 'ปกติ' }; // ค่าเริ่มต้น
          }
          this.showCustomerModal = true;
        },

        closeCustomerModal() {
          this.showCustomerModal = false;
          this.currentCustomer = {};
        },

        saveCustomer() {
          const sheetID = localStorage.getItem('sheetID') || '';
          const idCard = this.currentCustomer.เลขบัตรประชาชน;
          const customerId = this.currentCustomer.รหัสลูกค้า || null;

          this.isLoading = true;

          // --- ขั้นตอนที่ 1: ตรวจสอบเลขบัตรประชาชนซ้ำก่อน ---
          google.script.run
            .withSuccessHandler(result => {
              if (result.success && result.isDuplicate) {
                // ถ้าซ้ำ ให้แจ้งเตือนและหยุดการทำงาน
                this.isLoading = false;
                Swal.fire({
                  icon: 'error',
                  title: 'ข้อมูลซ้ำซ้อน!',
                  html: `เลขบัตรประชาชนนี้มีอยู่แล้วในระบบของลูกค้า <b>${result.customerId}</b><br>กรุณาใช้ฟังก์ชัน "ปรับปรุงฐานข้อมูล" เพื่อรวมข้อมูล`,
                  confirmButtonText: 'รับทราบ'
                });
              } else if (result.success && !result.isDuplicate) {
                // --- ขั้นตอนที่ 2: ถ้าไม่ซ้ำ ให้บันทึกข้อมูล ---
                const action = this.isEditingCustomer ? 'updateCustomer' : 'addNewCustomer';
                const successMessage = this.isEditingCustomer ? 'แก้ไขข้อมูลลูกค้าสำเร็จ' : 'เพิ่มลูกค้าใหม่สำเร็จ';

                google.script.run
                  .withSuccessHandler(saveResult => {
                    if (saveResult.success) {
                      // ใช้ Toast แทน Swal
                      const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                      });
                      Toast.fire({
                        icon: 'success',
                        title: successMessage
                      });

                      this.closeCustomerModal();
                      this.loadCustomers(); // รีโหลดข้อมูลในตาราง
                    } else {
                      this.showNotification('บันทึกไม่สำเร็จ: ' + saveResult.message, 'error');
                    }
                    this.isLoading = false;
                  })
                  .withFailureHandler(error => {
                    this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                    this.isLoading = false;
                  })
                [action](this.currentCustomer, sheetID);
              } else {
                // กรณีเกิด Error ตอนเช็ค
                this.showNotification('ตรวจสอบข้อมูลซ้ำไม่สำเร็จ: ' + result.message, 'error');
                this.isLoading = false;
              }
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาดในการตรวจสอบข้อมูลซ้ำ: ' + error, 'error');
              this.isLoading = false;
            })
            .checkDuplicateIdCard(sheetID, idCard, customerId);
        },

        confirmDeleteCustomer(customerId) {
          Swal.fire({
            title: 'ยืนยันการลบ',
            text: "คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลลูกค้านี้?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ลบเลย!',
            cancelButtonText: 'ยกเลิก'
          }).then((result) => {
            if (result.isConfirmed) {
              this.deleteCustomer(customerId);
            }
          });
        },

        deleteCustomer(customerId) {
          const sheetID = localStorage.getItem('sheetID') || '';
          this.isLoading = true;
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('ลบข้อมูลลูกค้าสำเร็จ', 'success');
                this.loadCustomers();
              } else {
                this.showNotification('ลบข้อมูลไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .deleteCustomer(customerId, sheetID);
        },

        openCustomerDetails(customerId) {
          // (ฟังก์ชันนี้สามารถพัฒนาเพิ่มเติมเพื่อแสดงประวัติการเช่าได้)
          const customer = this.allCustomers.find(c => c.รหัสลูกค้า === customerId);
          if (customer) {
            Swal.fire({
              title: `<strong>ข้อมูลลูกค้า: ${customer['ชื่อ-นามสกุล']}</strong>`,
              html: `
                        <div class="text-left space-y-2">
                            <p><strong>รหัส:</strong> ${customer.รหัสลูกค้า}</p>
                            <p><strong>เบอร์โทร:</strong> ${customer.เบอร์โทรศัพท์.replace(/'/g, '')}</p>
                            <p><strong>เลขบัตรประชาชน:</strong> ${customer.เลขบัตรประชาชน || '-'}</p>
                            <p><strong>ใบขับขี่:</strong> ${customer.หมายเลขใบขับขี่ || '-'}</p>
                            <p><strong>ที่อยู่:</strong> ${customer.ที่อยู่ || '-'}</p>
                            <p><strong>หมายเหตุ:</strong> ${customer.หมายเหตุ || '-'}</p>
                            <p><strong>ประวัติการเช่า:</strong> ${customer['ประวัติการเช่า (หมายเลขการจอง)'] || '-'}</p>
                        </div>
                    `,
              icon: 'info'
            });
          }
        },


        calculateCustomerStats() {
          if (!this.customerDetails || !this.customerDetails.rentalHistory) {
            this.customerStats = {};
            return;
          }

          const history = this.customerDetails.rentalHistory;
          const totalSpent = history.reduce((sum, item) => sum + (item.ค่าเช่ารวมทั้งหมด || 0), 0);

          const carCounts = history.reduce((acc, item) => {
            acc[item.รถ] = (acc[item.รถ] || 0) + 1;
            return acc;
          }, {});

          const favoriteCar = Object.keys(carCounts).reduce((a, b) => carCounts[a] > carCounts[b] ? a : b, 'N/A');

          this.customerStats = {
            totalRentals: history.length,
            totalSpent: this.formatCurrency(totalSpent),
            favoriteCar: history.length > 0 ? favoriteCar : 'ไม่มีข้อมูล',
          };
        },

        // เพิ่มฟังก์ชันสำหรับสร้างกราฟ
        initCustomerCarChart() {
          if (this.customerCarChart) {
            this.customerCarChart.destroy(); // ทำลายกราฟเก่าทิ้งก่อน
          }

          const history = this.customerDetails.rentalHistory;
          if (!history || history.length === 0) return;

          const carCounts = history.reduce((acc, item) => {
            acc[item.รถ] = (acc[item.รถ] || 0) + 1;
            return acc;
          }, {});

          const sortedCars = Object.entries(carCounts).sort((a, b) => b[1] - a[1]);

          const options = {
            series: [{
              name: 'จำนวนครั้งที่เช่า',
              data: sortedCars.map(item => item[1])
            }],
            chart: {
              type: 'bar',
              height: 250,
              toolbar: { show: false }
            },
            plotOptions: {
              bar: {
                borderRadius: 4,
                horizontal: false,
                distributed: true, // ทำให้แต่ละแท่งมีสีต่างกัน
              }
            },
            dataLabels: { enabled: false },
            xaxis: {
              categories: sortedCars.map(item => item[0]),
            },
            legend: { show: false }
          };

          this.customerCarChart = new ApexCharts(document.querySelector("#customerCarChartContainer"), options);
          this.customerCarChart.render();
        },


        openCustomerDetails(customerId) {
          this.showCustomerDetailsModal = true;
          this.isLoading = true;
          this.customerDetails = { data: null, rentalHistory: [] }; // Reset ข้อมูล
          this.customerStats = {}; // Reset ข้อมูลสรุป

          // --- เพิ่มเข้ามา: ทำลายกราฟเก่าทิ้งก่อนเปิด Modal ใหม่ ---
          if (this.customerCarChart) {
            this.customerCarChart.destroy();
            this.customerCarChart = null;
          }
          // --------------------------------------------------------

          const sheetID = localStorage.getItem('sheetID') || '';

          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.customerDetails.data = result.data;
                // เรียงประวัติการเช่าตามวันที่ล่าสุดก่อน
                this.customerDetails.rentalHistory = result.data.rentalHistoryDetails.sort((a, b) => new Date(b.วันที่เช่า) - new Date(a.วันที่เช่า));

                // === เพิ่มส่วนนี้เข้ามา ===
                // ใช้ $nextTick เพื่อรอให้ AlpineJS แสดงผลข้อมูลใน HTML ก่อน
                this.$nextTick(() => {
                  this.calculateCustomerStats(); // 1. คำนวณข้อมูลสรุป
                  this.initCustomerCarChart();   // 2. สร้างและวาดกราฟ
                });
                // ========================

              } else {
                this.showNotification('ไม่สามารถโหลดรายละเอียดลูกค้าได้: ' + result.message, 'error');
                this.closeCustomerDetailsModal();
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
              this.closeCustomerDetailsModal();
            })
            .getCustomerDetailsWithHistory(customerId, sheetID);
        },



        openDbMaintenanceModal() { // ⬅️ เปลี่ยนชื่อฟังก์ชัน
          this.analysisResult = null; // Reset ทุกครั้งที่เปิด
          this.showDbMaintenanceModal = true;
        },

        closeDbMaintenanceModal() { // ⬅️ เปลี่ยนชื่อฟังก์ชัน
          this.showDbMaintenanceModal = false;
        },

        runDatabaseAnalysis() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.analysisResult = result.analysis;
                this.showNotification('วิเคราะห์ฐานข้อมูลสำเร็จ', 'success');
              } else {
                this.showNotification('วิเคราะห์ไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .analyzeCustomerDatabase(sheetID);
        },

        confirmMergeCustomers(customers) {
          const inputOptions = {};
          customers.forEach(c => {
            inputOptions[c.รหัสลูกค้า] = `${c.รหัสลูกค้า} - ${c['ชื่อ-นามสกุล']}`;
          });

          Swal.fire({
            title: 'เลือกลูกค้าที่จะเก็บไว้',
            text: 'ข้อมูลอื่นๆ จะถูกรวมเข้ากับลูกค้ารายนี้ และรายการที่เหลือจะถูกลบ',
            input: 'radio',
            inputOptions: inputOptions,
            inputValue: customers[0].รหัสลูกค้า,
            showCancelButton: true,
            confirmButtonText: 'ยืนยันการรวมข้อมูล',
            cancelButtonText: 'ยกเลิก',
            inputValidator: (value) => {
              if (!value) {
                return 'กรุณาเลือกรายการ!'
              }
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const primaryCustomerId = result.value;
              const customerIdsToDelete = customers.map(c => c.รหัสลูกค้า).filter(id => id !== primaryCustomerId);
              this.executeMerge(primaryCustomerId, customerIdsToDelete);
            }
          });
        },

        executeMerge(primaryCustomerId, customerIdsToDelete) {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification(result.message, 'success');
                this.runDatabaseAnalysis();
                this.loadCustomers();
              } else {
                this.showNotification('รวมข้อมูลไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .mergeDuplicateCustomers(sheetID, primaryCustomerId, customerIdsToDelete);
        },



        runCustomerOverviewAnalysis() {
          this.isLoading = true;
          this.customerOverviewData = null; // เคลียร์ข้อมูลเก่าก่อนเริ่มวิเคราะห์
          const sheetID = localStorage.getItem('sheetID') || '';

          // หน่วงเวลาเล็กน้อยเพื่อให้ UI อัปเดตสถานะ Loading
          setTimeout(() => {
            google.script.run
              .withSuccessHandler(result => {
                if (result.success) {
                  this.customerOverviewData = result.analysis;
                  this.showNotification('วิเคราะห์ข้อมูลสำเร็จ', 'success');
                } else {
                  this.showNotification('วิเคราะห์ไม่สำเร็จ: ' + result.message, 'error');
                }
                this.isLoading = false;
              })
              .withFailureHandler(error => {
                this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
                this.isLoading = false;
              })
              .getCustomerOverviewAnalysis(sheetID);
          }, 200);
        },




        addMissingCustomers() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification(result.message, 'success');
                this.runDatabaseAnalysis();
                this.loadCustomers();
              } else {
                this.showNotification('เพิ่มข้อมูลไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .addMissingCustomersToDatabase(sheetID, this.analysisResult.missing);
        },

        closeCustomerDetailsModal() {
          this.showCustomerDetailsModal = false;
          this.expandedHistoryItem = null; // ปิดรายการที่ขยายอยู่ทั้งหมด
        },



        // ค้นหา + สรุปคิวรถแบบใหม่
        searchAvailabilitySummary() {
          if (!this.pickupDate || !this.pickupTime || !this.returnDate || !this.returnTime) {
            this.showToastMessage('กรุณากรอกข้อมูลให้ครบถ้วน');
            return;
          }
          const pickupDT = new Date(this.pickupDate + 'T' + this.pickupTime + ':00');
          const returnDT = new Date(this.returnDate + 'T' + this.returnTime + ':00');
          if (returnDT <= pickupDT) {
            this.showToastMessage('วันที่คืนต้องมากกว่าวันที่รับ');
            return;
          }

          this.isLoading = true;
          this.searchPerformed = true;

          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler((res) => {
              this.isLoading = false;
              if (!res || !res.success) {
                this.showToastMessage(res && res.message ? res.message : 'ไม่สามารถสรุปคิวรถได้');
                return;
              }
              // เก็บสรุปไว้
              this.availabilitySummary = res;

              // รายการรถว่างรายคัน (ถ้าคุณยังใช้ตารางล่างเดิม)
              this.availableCars = res.freeCars || [];

              // รีเซ็ตตัวกรอง
              this.brandFilter = '';
              this.modelFilter = '';
            })
            .withFailureHandler((err) => {
              this.isLoading = false;
              this.showToastMessage('เกิดข้อผิดพลาด: ' + (err && err.message ? err.message : err));
            })
            .findAvailabilitySummary(
              this.pickupDate,
              this.pickupTime,
              this.returnDate,
              this.returnTime,
              parseInt(this.prepTime, 10),
              sheetID
            );
        },


        clearResults() {
          this.searchPerformed = false;
          this.availabilitySummary = null;
          this.availableCars = [];
          this.brandFilter = '';
          this.modelFilter = '';
          // modal
          this.showModelModal = false;
          this.modalType = '';
          this.selectedModel = '';
          this.modelCarsFree = [];
          this.modelCarsShort = [];
        },

        // สรุปข้อความสั้นใต้การ์ด “รถที่จอง 1–2 วัน”
        shortBookedSummaryLine() {
          const list = this.availabilitySummary?.shortBookedByModel || [];
          if (!Array.isArray(list) || !list.length) return '';
          return list.map(x => `${x.model} ${x.count} คัน`).join(' | ');
        },

        // (ถ้าต้องการ) สรุปข้อความสั้นใต้การ์ด “รถว่างตลอดช่วง”
        freeSummaryLine() {
          const list = this.availabilitySummary?.freeByModel || [];
          if (!Array.isArray(list) || !list.length) return '';
          return list.map(x => `${x.model} ${x.count} คัน`).join(' | ');
        },

        // เปิด modal ตามรุ่น
        openModelDetail(type, model) {
          this.modalType = type;
          this.selectedModel = model;

          const trimEq = (a, b) => String(a || '').trim() === String(b || '').trim();

          const freeSrc = (this.availabilitySummary?.freeCars || []).filter(c => trimEq(c.รุ่น, model));
          const shortSrc = (this.availabilitySummary?.shortBookedCars || []).filter(c => trimEq(c.รุ่น, model));

          this.modelCarsFree = freeSrc;
          this.modelCarsShort = shortSrc; // มี pickup/pickupTime/return/returnTime มาจาก GAS แล้ว

          this.showModelModal = true;
        },

        closeModelDetail() {
          this.showModelModal = false;
          this.modalType = '';
          this.selectedModel = '';
          this.modelCarsFree = [];
          this.modelCarsShort = [];
        },

        // ฟังก์ชันสำหรับเสนอราคาเช่ารถ
        openQuoteModal(car) {
          console.log('Opening quote modal for car:', car);

          // สร้างข้อความรถ (ยี่ห้อ + รุ่น + ทะเบียน)
          const carInfo = `${car.ยี่ห้อ || ''} ${car.รุ่น || ''} (${car.ทะเบียน || ''})`.trim();

          // คำนวณจำนวนวัน
          const pickupDateTime = new Date(`${this.pickupDate}T${this.pickupTime}`);
          const returnDateTime = new Date(`${this.returnDate}T${this.returnTime}`);
          const diffTime = Math.abs(returnDateTime - pickupDateTime);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          // คำนวณค่าเช่ารวมทั้งหมด (จำนวนวัน × ราคาต่อวัน)
          const dailyRate = parseFloat(car.ราคาเช่าต่อวัน) || 0;
          const totalRent = diffDays * dailyRate;

          // กำหนดข้อมูลลงใน quoteData
          this.quoteData = {
            รถ: carInfo,
            วันที่รับรถ: this.formatDate(this.pickupDate),
            เวลารับรถ: this.pickupTime,
            วันที่คืนรถ: this.formatDate(this.returnDate),
            เวลาคืนรถ: this.returnTime,
            จำนวนวัน: `${diffDays} วัน`,
            ราคาต่อวัน: this.formatCurrency(dailyRate),
            ค่าประกันความเสียหาย: this.formatCurrency(parseFloat(car.ค่าประกันความเสียหาย) || 0),
            ค่าเช่ารวมทั้งหมด: this.formatCurrency(totalRent)
          };

          // เก็บข้อมูลดิบสำหรับการสร้างข้อความ
          const depositAmount = parseFloat(car.ค่าประกันความเสียหาย) || 0;

          // ดึงค่ามัดจำคิวรถจากรถที่เลือก หรือใช้ค่าเริ่มต้นของระบบ
          const carBookingDeposit = parseFloat(car.ค่ามัดจำคิวรถ);
          const bookingDeposit = (carBookingDeposit && carBookingDeposit > 0)
            ? carBookingDeposit
            : (parseFloat(this.config.ค่ามัดจำคิวรถเริ่มต้น) || 0);

          const discount = 0;
          const totalPayOnPickup = totalRent + depositAmount - discount - bookingDeposit;

          this.rawQuoteData = {
            car: carInfo,
            pickupDate: this.formatDate(this.pickupDate),
            pickupTime: this.pickupTime,
            returnDate: this.formatDate(this.returnDate),
            returnTime: this.returnTime,
            rentalDays: diffDays,
            dailyRate: dailyRate,
            depositAmount: depositAmount,
            bookingDeposit: bookingDeposit,
            discount: discount,
            totalRent: totalRent,
            totalPayOnPickup: totalPayOnPickup
          };

          // รีเซ็ตสถานะ
          this.quoteMessageGenerated = false;
          this.generatedQuoteMessage = '';
          this.quoteCopied = false;

          // เปิด Modal
          this.showQuoteModal = true;
        },

        closeQuoteModal() {
          this.showQuoteModal = false;
        },

        recalculateQuote() {
          // คำนวณค่าเช่ารวมทั้งหมดจากจำนวนวัน × ราคาต่อวัน
          this.rawQuoteData.totalRent = this.rawQuoteData.rentalDays * this.rawQuoteData.dailyRate;

          // คำนวณรวมชำระวันรับรถ = ค่าเช่ารวม + ค่าประกัน - ส่วนลด - ค่ามัดจำคิวรถ
          this.rawQuoteData.totalPayOnPickup =
            this.rawQuoteData.totalRent +
            this.rawQuoteData.depositAmount -
            this.rawQuoteData.discount -
            this.rawQuoteData.bookingDeposit;
        },

        generateQuoteMessage() {
          console.log('Generating quote message...');

          // รีเซ็ตสถานะก่อนสร้างข้อความใหม่
          this.quoteMessageGenerated = false;
          this.quoteCopied = false;

          // ดึง template จากการตั้งค่า หรือใช้ค่าเริ่มต้น
          let template = this.config.quoteMessageTemplate || this.getDefaultQuoteTemplate();

          // แทนที่ placeholders ด้วยข้อมูลจริง
          let message = template
            .replace(/{{รถ}}/g, this.rawQuoteData.car)
            .replace(/{{วันที่รับรถ}}/g, this.rawQuoteData.pickupDate)
            .replace(/{{เวลารับรถ}}/g, this.rawQuoteData.pickupTime)
            .replace(/{{วันที่คืนรถ}}/g, this.rawQuoteData.returnDate)
            .replace(/{{เวลาคืนรถ}}/g, this.rawQuoteData.returnTime)
            .replace(/{{จำนวนวัน}}/g, this.rawQuoteData.rentalDays.toString())
            .replace(/{{ราคาต่อวัน}}/g, this.formatCurrency(this.rawQuoteData.dailyRate))
            .replace(/{{ค่าประกันความเสียหาย}}/g, this.formatCurrency(this.rawQuoteData.depositAmount))
            .replace(/{{ค่ามัดจำคิวรถ}}/g, this.formatCurrency(this.rawQuoteData.bookingDeposit))
            .replace(/{{ส่วนลด}}/g, this.formatCurrency(this.rawQuoteData.discount))
            .replace(/{{ค่าเช่ารวมทั้งหมด}}/g, this.formatCurrency(this.rawQuoteData.totalRent))
            .replace(/{{รวมชำระวันรับรถ}}/g, this.formatCurrency(this.rawQuoteData.totalPayOnPickup))
            .replace(/{{ชื่อบริษัท}}/g, this.config.ชื่อบริษัท || '')
            .replace(/{{เบอร์โทรศัพท์}}/g, this.config.เบอร์โทรศัพท์ || '')
            .replace(/{{อีเมล}}/g, this.config.อีเมล || '')
            .replace(/{{ที่อยู่}}/g, this.config.ที่อยู่ || '');

          // ลบบรรทัดที่มีค่า ฿0 บาท (สำหรับค่าที่ไม่ต้องการแสดงเมื่อเป็น 0)
          // แยกข้อความเป็นบรรทัด และกรองเฉพาะบรรทัดที่ไม่มี ฿0
          const lines = message.split('\n');
          const filteredLines = lines.filter(line => {
            // ตรวจสอบว่าบรรทัดมีคำว่า ส่วนลด, ค่ามัดจำคิวรถ, หรือ ค่าประกันความเสียหาย
            const isOptionalField =
              line.includes('ส่วนลด:') ||
              line.includes('ค่ามัดจำคิวรถ:') ||
              line.includes('ค่าประกันความเสียหาย:');

            // ถ้าเป็นฟิลด์ที่ต้องการตรวจสอบ และมีค่า ฿0 (ตรวจสอบทั้งแบบมีหรือไม่มีคำว่า "บาท" ต่อท้าย)
            if (isOptionalField && /฿0(\s+บาท)?/.test(line)) {
              return false;
            }

            return true;
          });

          message = filteredLines.join('\n');

          this.generatedQuoteMessage = message;
          this.quoteMessageGenerated = true;

          // แสดงข้อความแจ้งเตือนว่าสร้างข้อความสำเร็จ
          this.showToastMessage('สร้างข้อความเสนอราคาสำเร็จ');
        },

        getDefaultQuoteTemplate() {
          return `ใบเสนอราคาเช่ารถ

ข้อมูลรถ
รถ: {{รถ}}

ระยะเวลาเช่า
รับรถ: {{วันที่รับรถ}} เวลา {{เวลารับรถ}} น.
คืนรถ: {{วันที่คืนรถ}} เวลา {{เวลาคืนรถ}} น.
ระยะเวลา: {{จำนวนวัน}} วัน

รายละเอียดราคา
ราคาเช่าต่อวัน: {{ราคาต่อวัน}} บาท
ค่าเช่ารวมทั้งหมด: {{ค่าเช่ารวมทั้งหมด}} บาท
ค่าประกันความเสียหาย: {{ค่าประกันความเสียหาย}} บาท
ค่ามัดจำคิวรถ: {{ค่ามัดจำคิวรถ}} บาท
ส่วนลด: {{ส่วนลด}} บาท

รวมชำระวันรับรถ: {{รวมชำระวันรับรถ}} บาท

หมายเหตุ: ราคานี้เป็นราคาเบื้องต้น อาจมีการเปลี่ยนแปลงตามเงื่อนไขการเช่า

ติดต่อสอบถาม
{{ชื่อบริษัท}}
โทร: {{เบอร์โทรศัพท์}}`;
        },

        copyQuoteMessage() {
          if (!this.generatedQuoteMessage) {
            this.showToastMessage('กรุณาสร้างข้อความเสนอราคาก่อน');
            return;
          }

          // คัดลอกข้อความไปยัง clipboard
          navigator.clipboard.writeText(this.generatedQuoteMessage).then(() => {
            this.quoteCopied = true;
            this.showToastMessage('คัดลอกข้อความเรียบร้อยแล้ว');

            // รีเซ็ตสถานะหลัง 3 วินาที
            setTimeout(() => {
              this.quoteCopied = false;
            }, 3000);
          }).catch(err => {
            console.error('Failed to copy text: ', err);
            this.showToastMessage('เกิดข้อผิดพลาดในการคัดลอก');
          });
        },




        generateDocument(docType, formData) {
          let functionName = '';
          let docName = '';

          if (docType === 'quotation') {
            functionName = 'createQuotationPdf';
            docName = 'ใบเสนอราคา';
          } else if (docType === 'cashBill') {
            functionName = 'createCashBillPdf';
            docName = 'บิลเงินสด';
          } else if (docType === 'taxInvoice') {
            functionName = 'createTaxInvoicePdf';
            docName = 'ใบกำกับภาษี';
          } else {
            return;
          }

          if (!formData.customerName) {
            Swal.fire('ข้อมูลไม่ครบ', `กรุณากรอกชื่อลูกค้าสำหรับ${docName}`, 'warning');
            return;
          }

          Swal.fire({
            title: `กำลังสร้าง${docName}...`,
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
          });

          google.script.run
            .withSuccessHandler(response => {
              if (response.success) {
                Swal.fire({
                  icon: 'success',
                  title: `สร้าง${docName}สำเร็จ!`,
                  html: `<p>ไฟล์ถูกสร้างเรียบร้อยแล้ว</p><br><a href='${response.docUrl}' target='_blank' class='bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-700'>เปิดเอกสาร</a>`,
                  confirmButtonText: 'ปิด'
                });
                // ล้างฟอร์ม
                if (docType === 'quotation') this.quotationFormData = { customerName: '', carModel: '', pickupDate: '', returnDate: '', price: '' };
                if (docType === 'cashBill') this.cashBillFormData = { customerName: '', carModel: '', price: '' };
                if (docType === 'taxInvoice') this.taxInvoiceFormData = { customerName: '', carModel: '', price: '' };
              } else {
                Swal.fire('เกิดข้อผิดพลาด', response.message, 'error');
              }
            })
            .withFailureHandler(error => {
              Swal.fire('เกิดข้อผิดพลาดรุนแรง', error.message, 'error');
            })
          [functionName](formData);
        },



        // --- ฟังก์ชันสำหรับ "แปลข้อความสรุปสัญญาเช่า" ---

        // โหลดรายการคีย์ทั้งหมด
        loadSummaryTranslationKeys() {
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (Array.isArray(result)) {
                this.summaryTranslationKeys = result;
                // ถ้ามีคีย์ ให้เลือกคีย์แรกเป็นค่าเริ่มต้น
                if (result.length > 0) {
                  this.selectedSummaryKey = result[0];
                  this.loadSummaryTranslationByKey();
                }
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('โหลดรายการคีย์ไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .getSummaryTranslationKeys(sheetID);
        },

        // โหลดข้อมูลแปลของคีย์ที่เลือก
        loadSummaryTranslationByKey() {
          if (!this.selectedSummaryKey) return;
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result) {
                this.currentSummaryTranslation = result;
              } else {
                this.currentSummaryTranslation = {};
                this.showNotification('ไม่พบข้อมูลสำหรับคีย์นี้', 'warning');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('โหลดข้อมูลแปลไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
            })
            .getSummaryTranslationByKey(this.selectedSummaryKey, sheetID);
        },

        // แปลภาษาอัตโนมัติ
        translateAllSummary() {
          const sourceText = this.currentSummaryTranslation.th;
          if (!sourceText) {
            this.showNotification('กรุณากรอกข้อความภาษาไทยก่อน', 'error');
            return;
          }

          const targetLanguages = Object.keys(this.currentSummaryTranslation).filter(lang => lang !== 'th');
          this.isTranslatingSummary = true;
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result) {
                targetLanguages.forEach(lang => {
                  if (result[lang]) {
                    this.currentSummaryTranslation[lang] = result[lang];
                  }
                });
                this.showNotification('แปลภาษาอัตโนมัติสำเร็จ', 'success');
              }
              this.isLoading = false;
              this.isTranslatingSummary = false;
            })
            .withFailureHandler(error => {
              this.showNotification('แปลภาษาไม่สำเร็จ: ' + error, 'error');
              this.isLoading = false;
              this.isTranslatingSummary = false;
            })
            .translateText(sourceText, targetLanguages);
        },

        // บันทึกการแปล
        saveSummaryTranslation() {
          if (!this.selectedSummaryKey) {
            this.showNotification('กรุณาเลือกคีย์ที่ต้องการบันทึก', 'error');
            return;
          }
          this.isLoading = true;
          const sheetID = localStorage.getItem('sheetID') || '';
          google.script.run
            .withSuccessHandler(result => {
              if (result.success) {
                this.showNotification('บันทึกคำแปลสำเร็จ', 'success');
              } else {
                this.showNotification('บันทึกไม่สำเร็จ: ' + result.message, 'error');
              }
              this.isLoading = false;
            })
            .withFailureHandler(error => {
              this.showNotification('เกิดข้อผิดพลาด: ' + error, 'error');
              this.isLoading = false;
            })
            .updateSummaryTranslation(this.selectedSummaryKey, this.currentSummaryTranslation, sheetID);
        }



      }
    }

    // =============================================================================
    // 🤖 AI Chatbot Widget Functions
    // =============================================================================

    function aiChatbot() {
      return {
        // State
        isChatOpen: false,
        isMinimized: false,
        messages: [],
        userInput: '',
        currentStep: 'idle', // idle, waiting_input, confirming, selecting_contract, creating
        extractedData: null,
        showBackToTop: false,
        hasNotification: false,

        // Initialize
        initChatbot() {
          // Watch scroll for back to top button
          window.addEventListener('scroll', () => {
            this.showBackToTop = window.pageYOffset > 100;
          });
        },

        // Toggle chat window
        toggleChat() {
          if (this.isMinimized) {
            this.isMinimized = false;
          }
          this.isChatOpen = !this.isChatOpen;
          this.hasNotification = false;
          if (this.isChatOpen) {
            this.$nextTick(() => {
              this.scrollToBottom();
            });
          }
        },

        // Minimize chat
        minimizeChat() {
          this.isChatOpen = false;
          this.isMinimized = true;
        },

        // Close chat
        closeChat() {
          this.isChatOpen = false;
          this.isMinimized = false;
        },

        // Scroll to bottom of messages
        scrollToBottom() {
          this.$nextTick(() => {
            const container = this.$refs.messagesContainer;
            if (container) {
              // เลื่อนไปล่างสุดพร้อม smooth animation
              container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
              });
            }
          });

          // เพิ่มการ scroll อีกครั้งหลังจาก DOM อัพเดตเสร็จสมบูรณ์
          setTimeout(() => {
            const container = this.$refs.messagesContainer;
            if (container) {
              container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
              });
            }
          }, 100);
        },

        // Format timestamp
        formatTime(timestamp) {
          const date = new Date(timestamp);
          return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        },

        // Add message
        addMessage(sender, type, content, data = null) {
          this.messages.push({
            sender: sender,
            type: type,
            content: content,
            data: data,
            timestamp: Date.now()
          });
          this.scrollToBottom();

          // Show notification if chat is closed
          if (!this.isChatOpen && sender === 'bot' && type !== 'typing') {
            this.hasNotification = true;
          }
        },

        // Start new rental flow
        startNewRental() {
          this.addMessage('bot', 'text', `ได้เลยครับ! 📝\n\nกรุณาคัดลอกรายละเอียดการเช่ามาวางในช่องด้านล่างได้เลย\n\n<strong>ตัวอย่าง:</strong>\nคุณสมชาย 081-234-5678\nเช่า Toyota Vios\nรับรถ 15 ม.ค. 68 เวลา 9:00\nคืนรถ 20 ม.ค. 68 เวลา 18:00\nราคา 800/วัน (5 วัน = 4000 บาท)\nมัดจำ 3000\n\n<strong>⚠️ ข้อมูลที่ต้องมี:</strong>\n• รถที่เช่า\n• วันเวลารับรถ/คืนรถ\n• ราคาต่อวัน และราคารวม\n• ชื่อผู้เช่า`);
          this.currentStep = 'waiting_input';

          this.$nextTick(() => {
            if (this.$refs.messageInput) {
              this.$refs.messageInput.focus();
            }
          });
        },

        // Show help
        showHelp() {
          this.addMessage('bot', 'help', `📚 <strong>วิธีใช้งาน</strong>\n\n1. คลิกปุ่ม "สร้างรายการเช่าใหม่"\n2. คัดลอกรายละเอียดการเช่ามาวาง\n3. AI จะอ่านและสรุปข้อมูลให้\n4. ตรวจสอบความถูกต้อง\n5. เลือกว่าต้องการสัญญาหรือไม่\n6. รอระบบสร้างรายการ\n\n💡 <strong>เคล็ดลับ:</strong>\nระบบสามารถอ่านข้อความได้อย่างอิสระ ไม่จำเป็นต้องเรียงตามลำดับ`);
        },

        // Go back to main menu
        goBackToMain() {
          this.messages = [];
          this.currentStep = 'idle';
        },

        // Paste from clipboard
        async pasteFromClipboard() {
          try {
            const text = await navigator.clipboard.readText();
            if (text) {
              this.userInput = text;
              this.$refs.messageInput.focus();
            }
          } catch (error) {
            console.error('Clipboard error:', error);
            alert('ไม่สามารถวางข้อความจาก Clipboard ได้\nกรุณาวางด้วยตัวเอง (Ctrl+V)');
          }
        },

        // Send message
        async sendMessage() {
          const message = this.userInput.trim();
          if (!message) return;

          // Add user message
          this.addMessage('user', 'text', message);
          this.userInput = '';
          this.currentStep = 'processing';

          // Show typing indicator
          this.addMessage('bot', 'typing', '');
          this.scrollToBottom();

          // Call AI to extract data
          try {
            const sheetID = getActiveSheetID();

            // Remove typing indicator
            setTimeout(() => {
              this.messages = this.messages.filter(msg => msg.type !== 'typing');
              this.scrollToBottom();
            }, 500);

            // Add loading message
            const loadingMsg = {
              sender: 'bot',
              type: 'loading',
              content: 'AI กำลังวิเคราะห์ข้อมูล...',
              progress: 0,
              timestamp: Date.now()
            };
            this.messages.push(loadingMsg);
            this.scrollToBottom();

            // Simulate progress
            const progressInterval = setInterval(() => {
              const lastMsg = this.messages[this.messages.length - 1];
              if (lastMsg && lastMsg.type === 'loading') {
                lastMsg.progress = Math.min(lastMsg.progress + 10, 90);
              }
            }, 200);

            // Call backend to extract data with AI
            google.script.run
              .withSuccessHandler((result) => {
                clearInterval(progressInterval);

                // Remove loading message
                this.messages = this.messages.filter(msg => msg.type !== 'loading');
                this.scrollToBottom();

                if (result.error) {
                  this.addMessage('bot', 'text', `❌ ${result.message}\n\nกรุณาลองใหม่อีกครั้ง หรือปรับรูปแบบข้อความให้ชัดเจนขึ้น`);
                  this.currentStep = 'waiting_input';
                } else {
                  // Check if data is complete
                  if (result.missingFields && result.missingFields.length > 0) {
                    this.addMessage('bot', 'text', `⚠️ <strong>ข้อมูลยังไม่ครบถ้วน</strong>\n\nข้อมูลที่ขาด:\n${result.missingFields.map(f => '• ' + f).join('\n')}\n\nกรุณาส่งข้อมูลเพิ่มเติม`);
                    this.currentStep = 'waiting_input';
                  } else {
                    // Data complete - show confirmation
                    this.extractedData = result;
                    this.addMessage('bot', 'confirmation', '', result);
                    this.currentStep = 'confirming';
                  }
                }
              })
              .withFailureHandler((error) => {
                clearInterval(progressInterval);
                this.messages = this.messages.filter(msg => msg.type !== 'loading');
                this.scrollToBottom();
                this.addMessage('bot', 'text', `❌ เกิดข้อผิดพลาด: ${error.message}\n\nกรุณาลองใหม่อีกครั้ง`);
                this.currentStep = 'waiting_input';
              })
              .extractRentalDataWithAIForChat(message, sheetID);

          } catch (error) {
            this.messages = this.messages.filter(msg => msg.type !== 'typing' || msg.type !== 'loading');
            this.scrollToBottom();
            this.addMessage('bot', 'text', `❌ เกิดข้อผิดพลาด: ${error.message}`);
            this.currentStep = 'waiting_input';
          }
        },

        // Confirm data
        async confirmData() {
          if (!this.extractedData) return;

          // เช็คคิวรถว่างก่อนดำเนินการต่อ
          this.currentStep = 'checking_availability';

          // แสดงข้อความกำลังตรวจสอบและข้อมูลที่ได้รับ
          let dataReceivedText = '📋 <strong>ข้อมูลที่ได้รับ:</strong>\n';
          dataReceivedText += `• ชื่อลูกค้า: ${this.extractedData.ชื่อลูกค้า || '-'}\n`;
          dataReceivedText += `• เบอร์โทร: ${this.extractedData.เบอร์โทร || '-'}\n`;
          if (this.extractedData.เลขบัตรประชาชน) {
            dataReceivedText += `• เลขบัตรประชาชน: ${this.extractedData.เลขบัตรประชาชน}\n`;
          }
          dataReceivedText += `• รถ: ${this.extractedData.รถ || '-'}\n`;
          dataReceivedText += `• วันรับรถ: ${this.extractedData.วันเช่า || '-'} ${this.extractedData.เวลารับรถ || ''}\n`;
          dataReceivedText += `• วันคืนรถ: ${this.extractedData.วันคืน || '-'} ${this.extractedData.เวลาคืนรถ || ''}\n`;
          dataReceivedText += `• ราคา/วัน: ${this.formatCurrency(this.extractedData.ราคาต่อวัน || 0)}\n`;
          dataReceivedText += `• ค่าเช่ารวม: ${this.formatCurrency(this.extractedData.ค่าเช่ารวมทั้งหมด || 0)}\n`;

          if (this.extractedData.เงินมัดจำ) {
            dataReceivedText += `• เงินมัดจำ: ${this.formatCurrency(this.extractedData.เงินมัดจำ)}\n`;
          }
          if (this.extractedData.เงินประกัน) {
            dataReceivedText += `• เงินประกัน: ${this.formatCurrency(this.extractedData.เงินประกัน)}\n`;
          }
          if (this.extractedData.ที่อยู่) {
            dataReceivedText += `• ที่อยู่: ${this.extractedData.ที่อยู่}\n`;
          }
          if (this.extractedData.หมายเหตุ) {
            dataReceivedText += `• หมายเหตุ: ${this.extractedData.หมายเหตุ}\n`;
          }

          this.addMessage('bot', 'text', dataReceivedText);
          this.addMessage('bot', 'text', '🔍 กำลังตรวจสอบคิวรถว่าง และเตรียมข้อมูล...');

          try {
            const sheetID = getActiveSheetID();

            // เรียกฟังก์ชันเช็คคิวรถและเติมข้อมูล
            google.script.run
              .withSuccessHandler((validationResult) => {
                console.log('Validation Result:', validationResult);

                // อัพเดท extractedData ด้วยข้อมูลที่เติมเพิ่ม
                if (validationResult.enrichedData) {
                  this.extractedData = { ...this.extractedData, ...validationResult.enrichedData };
                }

                // ตรวจสอบจาก availability object ที่อยู่ใน validationResult
                const isAvailable = validationResult.availability && validationResult.availability.available;

                if (isAvailable) {
                  // รถว่าง - แสดงตัวเลือกสัญญา
                  this.addMessage('bot', 'text', '✅ รถว่างในช่วงเวลาที่เลือก');

                  // แสดงสรุปยอดชำระ (อัพเดทจากข้อมูลที่เติมเพิ่ม)
                  if (this.extractedData) {
                    let summaryText = '💰 <strong>สรุปยอดชำระ:</strong>\n';
                    summaryText += `• ค่าเช่ารวม: ${this.formatCurrency(this.extractedData.ค่าเช่ารวมทั้งหมด || 0)}\n`;

                    if (this.extractedData.เงินมัดจำ && this.extractedData.เงินมัดจำ > 0) {
                      summaryText += `• เงินมัดจำคิวรถ: ${this.formatCurrency(this.extractedData.เงินมัดจำ)}\n`;
                    }

                    if (this.extractedData.เงินประกัน && this.extractedData.เงินประกัน > 0) {
                      summaryText += `• เงินประกัน: ${this.formatCurrency(this.extractedData.เงินประกัน)}\n`;
                    }

                    // คำนวณยอดชำระวันรับรถ
                    const depositAmount = this.extractedData.เงินมัดจำ || 0;
                    const insuranceAmount = this.extractedData.เงินประกัน || 0;
                    const totalRental = this.extractedData.ค่าเช่ารวมทั้งหมด || 0;

                    // ยอดชำระวันรับรถ = ค่าเช่ารวม - มัดจำคิว + เงินประกัน
                    const pickupDayPayment = totalRental - depositAmount + insuranceAmount;

                    summaryText += `\n📅 <strong>ยอดชำระวันรับรถ:</strong> ${this.formatCurrency(pickupDayPayment)}`;
                    summaryText += `\n  (ค่าเช่า ${this.formatCurrency(totalRental)} - มัดจำ ${this.formatCurrency(depositAmount)} + ประกัน ${this.formatCurrency(insuranceAmount)})`;

                    this.addMessage('bot', 'text', summaryText);
                  }

                  // แสดงตัวเลือกสัญญา
                  this.addMessage('bot', 'contract', '');
                  this.currentStep = 'selecting_contract';

                } else {
                  // รถไม่ว่าง - แสดงข้อความเตือน
                  let conflictMessage = '❌ <strong>ไม่สามารถจองได้</strong>\n\n';
                  conflictMessage += '🚗 รถไม่ว่างในช่วงเวลาที่เลือก\n\n';

                  // ตรวจสอบ conflicts จาก validationResult.availability.conflicts
                  if (validationResult.availability && validationResult.availability.conflicts && validationResult.availability.conflicts.length > 0) {
                    conflictMessage += '<strong>รายการที่ทับซ้อน:</strong>\n';
                    validationResult.availability.conflicts.forEach(conflict => {
                      conflictMessage += `• หมายเลข: ${conflict.bookingNumber || conflict.หมายเลขการจอง || 'ไม่ระบุ'}\n`;
                      conflictMessage += `  ลูกค้า: ${conflict.customerName || conflict.ชื่อลูกค้า || 'ไม่ระบุ'}\n`;
                      conflictMessage += `  วันที่: ${conflict.pickupDate || conflict.วันเช่า || conflict.วันที่เช่า} - ${conflict.returnDate || conflict.วันคืน || conflict.วันที่คืน}\n`;
                      conflictMessage += `  เวลา: ${conflict.pickupTime || conflict.เวลารับรถ || ''} - ${conflict.returnTime || conflict.เวลาคืนรถ || ''}\n\n`;
                    });
                  }

                  conflictMessage += '\nกรุณาเลือกช่วงเวลาอื่น หรือเลือกรถคันอื่น';
                  this.addMessage('bot', 'text', conflictMessage);

                  // กลับไปให้แก้ไขข้อมูล
                  this.currentStep = 'waiting_input';
                }
              })
              .withFailureHandler((error) => {
                console.error('Error validating data:', error);
                this.addMessage('bot', 'text', `❌ เกิดข้อผิดพลาดในการตรวจสอบข้อมูล: ${error.message}`);
                // ถ้าเช็คไม่ได้ให้ดำเนินการต่อ
                this.addMessage('bot', 'contract', '');
                this.currentStep = 'selecting_contract';
              })
              // เรียกใช้ validateAndEnrichRentalData แทน checkCarAvailabilityForAI
              .validateAndEnrichRentalData(this.extractedData, sheetID);

          } catch (error) {
            console.error('Error checking availability:', error);
            // ถ้าเกิดข้อผิดพลาด ให้ดำเนินการต่อ
            this.addMessage('bot', 'contract', '');
            this.currentStep = 'selecting_contract';
          }
        },

        // Format currency helper function
        formatCurrency(amount) {
          if (!amount || isNaN(amount)) return '0 บาท';
          return new Intl.NumberFormat('th-TH').format(amount) + ' บาท';
        },

        // Select contract option
        async selectContract(contractOption) {
          if (!this.extractedData) return;

          const contractText = contractOption === 'thai' ? 'สัญญาภาษาไทย' :
            contractOption === 'english' ? 'สัญญาภาษาอังกฤษ' :
              'ไม่สร้างสัญญา';

          this.currentStep = 'creating';

          // Add loading message with progress
          const loadingMsg = {
            sender: 'bot',
            type: 'loading',
            content: `กำลังสร้างรายการเช่า... (${contractText})`,
            progress: 0,
            timestamp: Date.now()
          };
          this.messages.push(loadingMsg);
          this.scrollToBottom();

          // Simulate progress
          const steps = [
            { progress: 20, text: 'กำลังตรวจสอบรถว่าง...' },
            { progress: 40, text: 'กำลังบันทึกข้อมูล...' },
            { progress: 60, text: 'กำลังสร้างรายการ...' },
            { progress: 80, text: 'กำลังสร้างสัญญา...' }
          ];

          let currentStepIndex = 0;
          const progressInterval = setInterval(() => {
            const lastMsg = this.messages[this.messages.length - 1];
            if (lastMsg && lastMsg.type === 'loading' && currentStepIndex < steps.length) {
              lastMsg.progress = steps[currentStepIndex].progress;
              lastMsg.content = steps[currentStepIndex].text;
              currentStepIndex++;
            }
          }, 800);

          try {
            const sheetID = getActiveSheetID();

            // Call backend to create rental
            google.script.run
              .withSuccessHandler((result) => {
                clearInterval(progressInterval);

                // Remove loading message
                this.messages = this.messages.filter(msg => msg.type !== 'loading');
                this.scrollToBottom();

                if (result.success) {
                  // Success! แสดงข้อความสำเร็จพร้อมข้อมูล
                  let successMessage = `✅ <strong>สร้างรายการเช่าสำเร็จ!</strong>\n\n`;
                  successMessage += `📋 <strong>หมายเลขการจอง:</strong> ${result.bookingNumber || result.rentalId}\n\n`;

                  if (result.rentalData) {
                    successMessage += `<strong>📅 ข้อมูลการเช่า:</strong>\n`;
                    successMessage += `• รถ: ${result.rentalData.รถ || '-'}\n`;
                    successMessage += `• ทะเบียน: ${result.rentalData.ทะเบียน || '-'}\n`;
                    successMessage += `• ลูกค้า: ${result.rentalData.ชื่อลูกค้า || '-'}\n`;
                    successMessage += `• เบอร์โทร: ${result.rentalData.เบอร์โทรศัพท์ || '-'}\n`;
                    successMessage += `• รับรถ: ${result.rentalData.วันที่เช่า || '-'} ${result.rentalData.เวลารับรถ || ''}\n`;
                    successMessage += `• คืนรถ: ${result.rentalData.วันที่คืน || '-'} ${result.rentalData.เวลาคืนรถ || ''}\n`;
                    successMessage += `• จำนวนวัน: ${result.rentalData.จำนวนวันเช่า || '-'} วัน\n\n`;

                    successMessage += `<strong>💰 ยอดชำระ:</strong>\n`;
                    successMessage += `• ค่าเช่ารวม: ${this.formatCurrency(result.rentalData.ค่าเช่ารวมทั้งหมด || 0)}\n`;

                    if (result.rentalData.เงินมัดจำ && result.rentalData.เงินมัดจำ > 0) {
                      successMessage += `• เงินมัดจำ: ${this.formatCurrency(result.rentalData.เงินมัดจำ)}\n`;
                    }

                    if (result.rentalData.เงินประกัน && result.rentalData.เงินประกัน > 0) {
                      successMessage += `• เงินประกัน: ${this.formatCurrency(result.rentalData.เงินประกัน)}\n`;
                    }

                    const totalPickupDay = (result.rentalData.เงินมัดจำ || 0) + (result.rentalData.เงินประกัน || 0);
                    successMessage += `\n📌 <strong>รวมชำระวันรับรถ:</strong> ${this.formatCurrency(totalPickupDay)}`;

                    const balance = (result.rentalData.ค่าเช่ารวมทั้งหมด || 0) - (result.rentalData.เงินมัดจำ || 0);
                    if (balance > 0) {
                      successMessage += `\n💵 <strong>คงเหลือวันคืนรถ:</strong> ${this.formatCurrency(balance)}`;
                    }
                  }

                  this.addMessage('bot', 'text', successMessage);

                  // เพิ่มปุ่มแอคชัน
                  const actionButtons = {
                    contractUrl: result.contractUrl,
                    summaryText: result.summaryText,
                    bookingNumber: result.bookingNumber || result.rentalId
                  };

                  this.addMessage('bot', 'actions', '', actionButtons);

                  this.currentStep = 'idle';
                  this.extractedData = null;

                  // Show notification
                  this.hasNotification = true;

                  // ไม่ reload หน้าอัตโนมัติ - ให้ผู้ใช้เลือกเองว่าจะทำอะไรต่อ
                  // แค่รีเฟรชข้อมูลรายการเช่าล่าสุด (ถ้ามีฟังก์ชัน)
                  if (typeof this.loadRecentRentals === 'function') {
                    this.loadRecentRentals(true);
                  }
                } else {
                  this.addMessage('bot', 'text', `❌ ไม่สามารถสร้างรายการได้\n\n${result.message || 'กรุณาลองใหม่อีกครั้ง'}`);
                  this.currentStep = 'confirming';
                  this.hasNotification = true;
                }
              })
              .withFailureHandler((error) => {
                clearInterval(progressInterval);
                this.messages = this.messages.filter(msg => msg.type !== 'loading');
                this.scrollToBottom();
                this.addMessage('bot', 'text', `❌ เกิดข้อผิดพลาด: ${error.message}\n\nกรุณาลองใหม่อีกครั้ง`);
                this.currentStep = 'confirming';
                this.hasNotification = true;
              })
              .createRentalFromChatbot(this.extractedData, contractOption, sheetID);

          } catch (error) {
            clearInterval(progressInterval);
            this.messages = this.messages.filter(msg => msg.type !== 'loading');
            this.scrollToBottom();
            this.addMessage('bot', 'text', `❌ เกิดข้อผิดพลาด: ${error.message}`);
            this.currentStep = 'confirming';
            this.hasNotification = true;
          }
        },

        // Copy summary to clipboard
        async copySummary(summaryText, bookingNumber) {
          try {
            // ใช้ Clipboard API (modern browsers)
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(summaryText);
              this.showNotification(`✅ คัดลอกข้อความสรุปสำเร็จ!\n\nหมายเลขการจอง: ${bookingNumber}`, 'success');
            } else {
              // Fallback สำหรับ browser เก่า
              const textArea = document.createElement('textarea');
              textArea.value = summaryText;
              textArea.style.position = 'fixed';
              textArea.style.left = '-999999px';
              textArea.style.top = '-999999px';
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();

              const successful = document.execCommand('copy');
              document.body.removeChild(textArea);

              if (successful) {
                this.showNotification(`✅ คัดลอกข้อความสรุปสำเร็จ!\n\nหมายเลขการจอง: ${bookingNumber}`, 'success');
              } else {
                throw new Error('ไม่สามารถคัดลอกได้');
              }
            }
          } catch (error) {
            console.error('Copy error:', error);
            this.showNotification('❌ ไม่สามารถคัดลอกข้อความได้\n\nกรุณาลองอีกครั้ง', 'error');
          }
        },

        // Reset chat
        resetChat() {
          this.messages = [];
          this.userInput = '';
          this.currentStep = 'idle';
          this.extractedData = null;
        }
      };
    }

    // Helper function to get sheetID
    function getActiveSheetID() {
      return localStorage.getItem('sheetID') || '';
    }

    // Chatbot is now in navbar, no FAB fallback needed

  </script>
</body>

</html>